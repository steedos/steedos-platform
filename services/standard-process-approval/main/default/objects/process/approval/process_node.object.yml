name: process_node
label: Approval Steps
hidden: true
enable_inline_edit: false
icon: steps
version: 2
fields:
  name:
    type: text
    required: true
  label:
    type: text
    required: true
    is_name: true
  order: #TODO 必须为整数，最小为1， 最大值不能超过当前最大值+1。输入的值已存在则当前记录占用原来的序号，之后的记录序号后移，比如已有1，2，3。添加2后，原来的2，3变为3，4，新记录占用2
    is_wide: true
    type: number
    scale: 0
    min: 1
  description:
    label: Description
    type: textarea
    is_wide: true
  process_definition:
    type: master_detail
    is_wide: true
    reference_to: process_definition
    auto_fill_mapping:
      - from: object_name
        to: object_name
  object_name:
    label: Object
    type: lookup
    reference_to: objects
    reference_to_field: name
    required: true
    filterable: true
    visible_on: "${false}"
  filtrad:
    type: boolean
    label: All records should enter this step
    group: Specify Step Criteria
    defaultValue: false
    is_wide: true
  entry_criteria:
    type: textarea
    label: Entry criteria
    is_wide: true
    required: true
    visible_on: "{{ formData.filtrad != true }}"
    group: Specify Step Criteria
  if_criteria_not_met: # https://help.salesforce.com/articleView?err=1&id=approvals_step_entrycriteria.htm&type=5
    type: select
    firstOption: false
    options: approve,reject,skip
    visible_on: "{{ formData.filtrad != true }}"
    group: Specify Step Criteria
    is_wide: true #TODO 选项规则：第一个有(order=1)：拒绝记录；批准记录；如果有后续步骤，则会多一个 转到下一步的条件; 最后一个步骤且不是第一步时，不能设置不满足的情况; 只有第一步有拒绝记录
  approver:
    type: select
    is_wide: true
    label: Select Approver
    required: true
    firstOption: false
    group: Select Assigned Approver
    options:
      - label: 'Let the submitter choose the approver manually'
        value: 'submitter_choose'
      # - label: 'Automatically assign using the user field selected earlier'
      #   value: 'role'
      # - label: 'Automatically assign to queue'
      #   value: 'auto_queue'
      - label: 'Automatically assign to approver(s)'
        value: 'auto_assign'
  assigned_approver_users:
    type: lookup
    reference_to: users
    multiple: true
    group: Select Assigned Approver
    visible_on: "{{ formData.approver != 'submitter_choose' }}"
  assigned_approver_roles: 
    type: lookup
    reference_to: roles
    reference_to_field: api_name
    multiple: true
    group: Select Assigned Approver
    visible_on: "{{ formData.approver != 'submitter_choose' }}"
  assigned_approver_flow_roles: 
    type: lookup
    reference_to: flow_roles
    reference_to_field: api_name
    multiple: true
    group: Select Assigned Approver
    visible_on: "{{ formData.approver != 'submitter_choose' }}"
  assigned_approver_user_field: 
    type: lookup
    multiple: true
    group: Select Assigned Approver
    showIcon: false
    visible_on: "{{ formData.approver != 'submitter_choose' }}"
    depend_on:
      - process_definition
    reference_to: object_fields
    reference_to_field: name
    filtersFunction: !<tag:yaml.org,2002:js/function> |-
      function (filters, values) {
        var pid = values.process_definition;
        if(_.isObject(pid)){
          pid = pid._id;
        }
        var result = Steedos.authRequest("/api/v1/process_definition/" + pid + "?fields=[\"object_name\"]", {type: 'get', async: false});
        var pObjectName = result && result.data && result.data.object_name;
        if(pObjectName){
          return [['object', '=', pObjectName], [['type', '=', 'lookup'], 'or', ['type', '=', 'master_detail']], [['reference_to', '=', 'users'], 'or', [['reference_to', '=', 'space_users'],['reference_to_field', '=', 'user']]], ['omit', '!=', true]];
        }
        else{
          return ['object', '=', -1];
        }
      }
  when_multiple_approvers:
    type: select
    is_wide: true
    label: When multiple approvers are selected
    group: Select Assigned Approver
    firstOption: false
    options:
      - label: Approve or reject based on the FIRST response.
        value: first_response
      - label: Require UNANIMOUS approval from all selected approvers.
        value: unanimous
    visible_on: "{{ formData.approver != 'submitter_choose' }}"
  #TODO 批准代理也可以批准此请求
  reject_behavior:
    type: select
    label: Reject Behavior
    is_wide: true
    required: true
    group: Select Assigned Approver
    defaultValue: reject_request
    firstOption: false
    inlineHelpText: What should happen if the approver rejects this request? #TODO 只有步骤号不等于1时，才能设置拒绝行为， 等于1时始终为最终拒绝
    options:
      - label: 'Perform all rejection actions for this step AND all final rejection actions. (Final Rejection)'
        value: reject_request
      - label: 'Perform ONLY the rejection actions for this step and send the approval request back to the most recent approver. (Go Back 1 Step)'
        value: back_to_previous
  approval_updates_field_actions:
    type: lookup
    multiple: true
    label: Field Update
    reference_to: action_field_updates
    reference_to_field: name
    depend_on:
      - process_definition
    filtersFunction: !!js/function |
      function (filters, dependValues) {
        if(dependValues && dependValues.process_definition){
          var pid = dependValues.process_definition;
          if(_.isObject(pid)){
            pid = pid._id;
          }
          var result = Steedos.authRequest("/api/v1/process_definition/" + pid + "?fields=[\"object_name\"]", {type: 'get', async: false});
          var pObjectName = result && result.data && result.data.object_name;
          if(pObjectName){
            return ['object_name', '=', pObjectName];
          }
          else{
            return ['object_name', '=', -1];
          }
        }
      }
    group: Approval Actions
  approval_workflow_notifications_actions:
    type: lookup
    multiple: true
    label: Workflow Notification
    reference_to: workflow_notifications
    reference_to_field: name
    depend_on:
      - process_definition
    filtersFunction: !!js/function |
      function (filters, dependValues) {
        if(dependValues && dependValues.process_definition){
          var pid = dependValues.process_definition;
          if(_.isObject(pid)){
            pid = pid._id;
          }
          var result = Steedos.authRequest("/api/v1/process_definition/" + pid + "?fields=[\"object_name\"]", {type: 'get', async: false});
          var pObjectName = result && result.data && result.data.object_name;
          if(pObjectName){
            return ['object_name', '=', pObjectName];
          }
          else{
            return ['object_name', '=', -1];
          }
        }
      }
    group: Approval Actions
  rejection_updates_field_actions:
    type: lookup
    multiple: true
    label: Field Update
    reference_to: action_field_updates
    reference_to_field: name
    depend_on:
      - process_definition
    filtersFunction: !!js/function |
      function (filters, dependValues) {
        if(dependValues && dependValues.process_definition){
          var pid = dependValues.process_definition;
          if(_.isObject(pid)){
            pid = pid._id;
          }
          var result = Steedos.authRequest("/api/v1/process_definition/" + pid + "?fields=[\"object_name\"]", {type: 'get', async: false});
          var pObjectName = result && result.data && result.data.object_name;
          if(pObjectName){
            return ['object_name', '=', pObjectName];
          }
          else{
            return ['object_name', '=', -1];
          }
        }
      }
    group: Rejection Actions
  rejection_workflow_notifications_actions:
    type: lookup
    multiple: true
    label: Workflow Notification
    reference_to: workflow_notifications
    reference_to_field: name
    depend_on:
      - process_definition
    filtersFunction: !!js/function |
      function (filters, dependValues) {
        if(dependValues && dependValues.process_definition){
          var pid = dependValues.process_definition;
          if(_.isObject(pid)){
            pid = pid._id;
          }
          var result = Steedos.authRequest("/api/v1/process_definition/" + pid + "?fields=[\"object_name\"]", {type: 'get', async: false});
          var pObjectName = result && result.data && result.data.object_name;
          if(pObjectName){
            return ['object_name', '=', pObjectName];
          }
          else{
            return ['object_name', '=', -1];
          }
        }
      }
    group: Rejection Actions
list_views:
  all:
    label: All
    filter_scope: space
    sort: [["order", "asc"]]
    columns:
      - label
      - order
      - description
      - approver
      - reject_behavior
permission_set:
  user:
    allowCreate: false
    allowDelete: false
    allowEdit: false
    allowRead: true
    modifyAllRecords: false
    viewAllRecords: true
  admin:
    allowCreate: true
    allowDelete: true
    allowEdit: true
    allowRead: true
    modifyAllRecords: true
    viewAllRecords: true