function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=e("@codemirror/view"),o=e("@codemirror/state"),n;function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=s(e("crelt"));class a{constructor(e,t,i){this.from=e,this.to=t,this.diagnostic=i}}class l{constructor(e,t,i){this.diagnostics=e,this.panel=t,this.selected=i}static init(e,t,o){let n=e,s=o.facet(D).markerFilter;s&&(n=s(n));let r=i.Decoration.set(n.map(e=>e.from==e.to||e.from==e.to-1&&o.doc.lineAt(e.from).to==e.from?i.Decoration.widget({widget:new E(e),diagnostic:e}).range(e.from):i.Decoration.mark({attributes:{class:"cm-lintRange cm-lintRange-"+e.severity},diagnostic:e}).range(e.from,e.to)),!0);return new l(r,t,c(r))}}function c(e,t=null,i=0){let o=null;return e.between(i,1e9,(e,i,{spec:n})=>{if(!t||n.diagnostic==t)return o=new a(e,i,n.diagnostic),!1}),o}function d(e,t){return!(!e.effects.some(e=>e.is(u))&&!e.changes.touchesRange(t.pos))}function m(e,t){return e.field(p,!1)?t:t.concat(o.StateEffect.appendConfig.of([p,i.EditorView.decorations.compute([p],e=>{let{selected:t,panel:o}=e.field(p);return t&&o&&t.from!=t.to?i.Decoration.set([w.range(t.from,t.to)]):i.Decoration.none}),i.hoverTooltip(b,{hideOn:d}),O]))}function f(e,t){return{effects:m(e,[u.of(t)])}}const u=o.StateEffect.define(),h=o.StateEffect.define(),g=o.StateEffect.define(),p=o.StateField.define({create:()=>new l(i.Decoration.none,null,null),update(e,t){if(t.docChanged){let i=e.diagnostics.map(t.changes),o=null;if(e.selected){let n=t.changes.mapPos(e.selected.from,1);o=c(i,e.selected.diagnostic,n)||c(i,null,n)}e=new l(i,e.panel,o)}for(let i of t.effects)i.is(u)?e=l.init(i.value,e.panel,t.state):i.is(h)?e=new l(e.diagnostics,i.value?I.open:null,e.selected):i.is(g)&&(e=new l(e.diagnostics,e.panel,i.value));return e},provide:e=>[i.showPanel.from(e,e=>e.panel),i.EditorView.decorations.from(e,e=>e.diagnostics)]});function v(e){let t=e.field(p,!1);return t?t.diagnostics.size:0}const w=i.Decoration.mark({class:"cm-lintRange cm-lintRange-active"});function b(e,t,i){let{diagnostics:o}=e.state.field(p),n=[],s=2e8,r=0;o.between(t-(i<0?1:0),t+(i>0?1:0),(e,o,{spec:a})=>{t>=e&&t<=o&&(e==o||(t>e||i>0)&&(t<o||i<0))&&(n.push(a.diagnostic),s=Math.min(e,s),r=Math.max(o,r))});let a=e.state.facet(D).tooltipFilter;return a&&(n=a(n)),n.length?{pos:s,end:r,above:e.state.doc.lineAt(s).to<r,create:()=>({dom:k(e,n)})}:null}function k(e,t){return r.default("ul",{class:"cm-tooltip-lint"},t.map(t=>P(e,t,!1)))}const x=e=>{let t=e.state.field(p,!1);t&&t.panel||e.dispatch({effects:m(e.state,[h.of(!0)])});let o=i.getPanel(e,I.open);return o&&o.dom.querySelector(".cm-panel-lint ul").focus(),!0},y=e=>{let t=e.state.field(p,!1);return!(!t||!t.panel)&&(e.dispatch({effects:h.of(!1)}),!0)},C=e=>{let t=e.state.field(p,!1);if(!t)return!1;let i=e.state.selection.main,o=t.diagnostics.iter(i.to+1);return!(!o.value&&(!(o=t.diagnostics.iter(0)).value||o.from==i.from&&o.to==i.to))&&(e.dispatch({selection:{anchor:o.from,head:o.to},scrollIntoView:!0}),!0)},S=[{key:"Mod-Shift-m",run:x},{key:"F8",run:C}],T=i.ViewPlugin.fromClass(class{constructor(e){this.view=e,this.timeout=-1,this.set=!0;let{delay:t}=e.state.facet(D);this.lintTime=Date.now()+t,this.run=this.run.bind(this),this.timeout=setTimeout(this.run,t)}run(){let e=Date.now();if(e<this.lintTime-10)setTimeout(this.run,this.lintTime-e);else{this.set=!1;let{state:e}=this.view,{sources:t}=e.facet(D);Promise.all(t.map(e=>Promise.resolve(e(this.view)))).then(t=>{let i=t.reduce((e,t)=>e.concat(t));this.view.state.doc==e.doc&&this.view.dispatch(f(this.view.state,i))},e=>{i.logException(this.view.state,e)})}}update(e){let t=e.state.facet(D);(e.docChanged||t!=e.startState.facet(D))&&(this.lintTime=Date.now()+t.delay,this.set||(this.set=!0,this.timeout=setTimeout(this.run,t.delay)))}force(){this.set&&(this.lintTime=Date.now(),this.run())}destroy(){clearTimeout(this.timeout)}}),D=o.Facet.define({combine:e=>Object.assign({sources:e.map(e=>e.source)},o.combineConfig(e.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null})),enables:T});function R(e,t={}){return D.of({source:e,config:t})}function L(e){let t=e.plugin(T);t&&t.force()}function A(e){let t=[];if(e)e:for(let{name:i}of e){for(let e=0;e<i.length;e++){let o=i[e];if(/[a-zA-Z]/.test(o)&&!t.some(e=>e.toLowerCase()==o.toLowerCase())){t.push(o);continue e}}t.push("")}return t}function P(e,t,i){var o;let n=i?A(t.actions):[];return r.default("li",{class:"cm-diagnostic cm-diagnostic-"+t.severity},r.default("span",{class:"cm-diagnosticText"},t.renderMessage?t.renderMessage():t.message),null===(o=t.actions)||void 0===o?void 0:o.map((i,o)=>{let s=o=>{o.preventDefault();let n=c(e.state.field(p).diagnostics,t);n&&i.apply(e,n.from,n.to)},{name:a}=i,l=n[o]?a.indexOf(n[o]):-1,d=l<0?a:[a.slice(0,l),r.default("u",a.slice(l,l+1)),a.slice(l+1)];return r.default("button",{type:"button",class:"cm-diagnosticAction",onclick:s,onmousedown:s,"aria-label":` Action: ${a}${l<0?"":` (access key "${n[o]})"`}.`},d)}),t.source&&r.default("div",{class:"cm-diagnosticSource"},t.source))}class E extends i.WidgetType{constructor(e){super(),this.diagnostic=e}eq(e){return e.diagnostic==this.diagnostic}toDOM(){return r.default("span",{class:"cm-lintPoint cm-lintPoint-"+this.diagnostic.severity})}}class F{constructor(e,t){this.diagnostic=t,this.id="item_"+Math.floor(4294967295*Math.random()).toString(16),this.dom=P(e,t,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class I{constructor(e){this.view=e,this.items=[];let t=t=>{if(27==t.keyCode)y(this.view),this.view.focus();else if(38==t.keyCode||33==t.keyCode)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(40==t.keyCode||34==t.keyCode)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(36==t.keyCode)this.moveSelection(0);else if(35==t.keyCode)this.moveSelection(this.items.length-1);else if(13==t.keyCode)this.view.focus();else{if(!(t.keyCode>=65&&t.keyCode<=90&&this.selectedIndex>=0))return;{let{diagnostic:i}=this.items[this.selectedIndex],o=A(i.actions);for(let n=0;n<o.length;n++)if(o[n].toUpperCase().charCodeAt(0)==t.keyCode){let t=c(this.view.state.field(p).diagnostics,i);t&&i.actions[n].apply(e,t.from,t.to)}}}t.preventDefault()},i=e=>{for(let t=0;t<this.items.length;t++)this.items[t].dom.contains(e.target)&&this.moveSelection(t)};this.list=r.default("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:t,onclick:i}),this.dom=r.default("div",{class:"cm-panel-lint"},this.list,r.default("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>y(this.view)},"Ã—")),this.update()}get selectedIndex(){let e=this.view.state.field(p).selected;if(!e)return-1;for(let t=0;t<this.items.length;t++)if(this.items[t].diagnostic==e.diagnostic)return t;return-1}update(){let{diagnostics:e,selected:t}=this.view.state.field(p),i=0,o=!1,n=null;for(e.between(0,this.view.state.doc.length,(e,s,{spec:r})=>{let a=-1,l;for(let t=i;t<this.items.length;t++)if(this.items[t].diagnostic==r.diagnostic){a=t;break}a<0?(l=new F(this.view,r.diagnostic),this.items.splice(i,0,l),o=!0):(l=this.items[a],a>i&&(this.items.splice(i,a-i),o=!0)),t&&l.diagnostic==t.diagnostic?l.dom.hasAttribute("aria-selected")||(l.dom.setAttribute("aria-selected","true"),n=l):l.dom.hasAttribute("aria-selected")&&l.dom.removeAttribute("aria-selected"),i++});i<this.items.length&&!(1==this.items.length&&this.items[0].diagnostic.from<0);)o=!0,this.items.pop();0==this.items.length&&(this.items.push(new F(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),o=!0),n?(this.list.setAttribute("aria-activedescendant",n.id),this.view.requestMeasure({key:this,read:()=>({sel:n.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:e,panel:t})=>{e.top<t.top?this.list.scrollTop-=t.top-e.top:e.bottom>t.bottom&&(this.list.scrollTop+=e.bottom-t.bottom)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),o&&this.sync()}sync(){let e=this.list.firstChild;function t(){let t=e;e=t.nextSibling,t.remove()}for(let i of this.items)if(i.dom.parentNode==this.list){for(;e!=i.dom;)t();e=i.dom.nextSibling}else this.list.insertBefore(i.dom,e);for(;e;)t()}moveSelection(e){if(this.selectedIndex<0)return;let t,i=c(this.view.state.field(p).diagnostics,this.items[e].diagnostic);i&&this.view.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0,effects:g.of(i)})}static open(e){return new I(e)}}function M(e,t='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${t}>${encodeURIComponent(e)}</svg>')`}function B(e){return M(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${e}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const O=i.EditorView.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:B("#d11")},".cm-lintRange-warning":{backgroundImage:B("orange")},".cm-lintRange-info":{backgroundImage:B("#999")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});class j extends i.GutterMarker{constructor(e){super(),this.diagnostics=e,this.severity=e.reduce((e,t)=>{let i=t.severity;return"error"==i||"warning"==i&&"info"==e?i:e},"info")}toDOM(e){let t=document.createElement("div");t.className="cm-lint-marker cm-lint-marker-"+this.severity;let i=this.diagnostics,o=e.state.facet(Z).tooltipFilter;return o&&(i=o(i)),i.length&&(t.onmouseover=(()=>_(e,t,i))),t}}function V(e,t){let i=o=>{let n=t.getBoundingClientRect();if(!(o.clientX>n.left-10&&o.clientX<n.right+10&&o.clientY>n.top-10&&o.clientY<n.bottom+10)){for(let e=o.target;e;e=e.parentNode)if(1==e.nodeType&&e.classList.contains("cm-tooltip-lint"))return;window.removeEventListener("mousemove",i),e.state.field(z)&&e.dispatch({effects:q.of(null)})}};window.addEventListener("mousemove",i)}function _(e,t,i){function o(){let o=e.elementAtHeight(t.getBoundingClientRect().top+5-e.documentTop);const n=e.coordsAtPos(o.from);n&&e.dispatch({effects:q.of({pos:o.from,above:!1,create:()=>({dom:k(e,i),getCoords:()=>t.getBoundingClientRect()})})}),t.onmouseout=t.onmousemove=null,V(e,t)}let{hoverTime:n}=e.state.facet(Z),s=setTimeout(o,n);t.onmouseout=(()=>{clearTimeout(s),t.onmouseout=t.onmousemove=null}),t.onmousemove=(()=>{clearTimeout(s),s=setTimeout(o,n)})}function $(e,t){let i=Object.create(null);for(let o of t){let t=e.lineAt(o.from);(i[t.from]||(i[t.from]=[])).push(o)}let n=[];for(let o in i)n.push(new j(i[o]).range(+o));return o.RangeSet.of(n,!0)}const H=i.gutter({class:"cm-gutter-lint",markers:e=>e.state.field(N)}),N=o.StateField.define({create:()=>o.RangeSet.empty,update(e,t){e=e.map(t.changes);let i=t.state.facet(Z).markerFilter;for(let o of t.effects)if(o.is(u)){let n=o.value;i&&(n=i(n||[])),e=$(t.state.doc,n.slice(0))}return e}}),q=o.StateEffect.define(),z=o.StateField.define({create:()=>null,update:(e,t)=>(e&&t.docChanged&&(e=d(t,e)?null:Object.assign(Object.assign({},e),{pos:t.changes.mapPos(e.pos)})),t.effects.reduce((e,t)=>t.is(q)?t.value:e,e)),provide:e=>i.showTooltip.from(e)}),Y=i.EditorView.baseTheme({".cm-gutter-lint":{width:"1.4em","& .cm-gutterElement":{padding:".2em"}},".cm-lint-marker":{width:"1em",height:"1em"},".cm-lint-marker-info":{content:M('<path fill="#aaf" stroke="#77e" stroke-width="6" stroke-linejoin="round" d="M5 5L35 5L35 35L5 35Z"/>')},".cm-lint-marker-warning":{content:M('<path fill="#fe8" stroke="#fd7" stroke-width="6" stroke-linejoin="round" d="M20 6L37 35L3 35Z"/>')},".cm-lint-marker-error:before":{content:M('<circle cx="20" cy="20" r="15" fill="#f87" stroke="#f43" stroke-width="6"/>')}}),Z=o.Facet.define({combine:e=>o.combineConfig(e,{hoverTime:300,markerFilter:null,tooltipFilter:null})});function G(e={}){return[Z.of(e),N,H,Y,z]}t.closeLintPanel=y,t.diagnosticCount=v,t.forceLinting=L,t.lintGutter=G,t.lintKeymap=S,t.linter=R,t.nextDiagnostic=C,t.openLintPanel=x,t.setDiagnostics=f,t.setDiagnosticsEffect=u}

