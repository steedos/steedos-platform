{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos:workflow/checkNpm.js","meteor://ðŸ’»app/packages/steedos:workflow/lib/URI.js","meteor://ðŸ’»app/packages/steedos_workflow/lib/core.coffee","meteor://ðŸ’»app/lib/core.coffee","meteor://ðŸ’»app/packages/steedos_workflow/lib/models/auth_tokens.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/lib/instance_readonly_template.coffee","meteor://ðŸ’»app/client/lib/instance_readonly_template.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/lib/template_manager.coffee","meteor://ðŸ’»app/client/lib/template_manager.coffee","meteor://ðŸ’»app/packages/steedos:workflow/client/coreform/inputTypes/coreform-table/steedos-table.js","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_image_sign.coffee","meteor://ðŸ’»app/client/views/instance/_image_sign.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_traces_handler.coffee","meteor://ðŸ’»app/client/views/instance/_traces_handler.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_instance_form.coffee","meteor://ðŸ’»app/client/views/instance/_instance_form.coffee","meteor://ðŸ’»app/packages/steedos:workflow/client/views/instance/_instance_attachments.js","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_instance_sign_text.coffee","meteor://ðŸ’»app/client/views/instance/_instance_sign_text.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_traces_help.coffee","meteor://ðŸ’»app/client/views/instance/_traces_help.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_related_instances.coffee","meteor://ðŸ’»app/client/views/instance/_related_instances.coffee","meteor://ðŸ’»app/packages/steedos_workflow/client/views/instance/_related_records.coffee","meteor://ðŸ’»app/client/views/instance/_related_records.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/designer.coffee","meteor://ðŸ’»app/routes/designer.coffee","meteor://ðŸ’»app/packages/steedos:workflow/routes/nextStepUsers.js","meteor://ðŸ’»app/packages/steedos:workflow/routes/getSpaceUsers.js","meteor://ðŸ’»app/packages/steedos:workflow/routes/getFormulaUserObjects.js","meteor://ðŸ’»app/packages/steedos:workflow/routes/init_formula_values.js","meteor://ðŸ’»app/packages/steedos_workflow/routes/getNameForUser.coffee","meteor://ðŸ’»app/routes/getNameForUser.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_designer_startup.coffee","meteor://ðŸ’»app/routes/api_designer_startup.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_engine.coffee","meteor://ðŸ’»app/routes/api_workflow_engine.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_drafts.coffee","meteor://ðŸ’»app/routes/api_workflow_drafts.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_remove.coffee","meteor://ðŸ’»app/routes/api_workflow_remove.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_submit.coffee","meteor://ðŸ’»app/routes/api_workflow_submit.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_terminate.coffee","meteor://ðŸ’»app/routes/api_workflow_terminate.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_reassign.coffee","meteor://ðŸ’»app/routes/api_workflow_reassign.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_relocate.coffee","meteor://ðŸ’»app/routes/api_workflow_relocate.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_archive.coffee","meteor://ðŸ’»app/routes/api_workflow_archive.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_export.coffee","meteor://ðŸ’»app/routes/api_workflow_export.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_space_changeset.coffee","meteor://ðŸ’»app/routes/api_workflow_space_changeset.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_retrieve.coffee","meteor://ðŸ’»app/routes/api_workflow_retrieve.coffee","meteor://ðŸ’»app/packages/steedos:workflow/routes/api_workflow_forward.js","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_instance.coffee","meteor://ðŸ’»app/routes/api_workflow_instance.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_pending.coffee","meteor://ðŸ’»app/routes/api_workflow_open_pending.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/export_table_template.coffee","meteor://ðŸ’»app/routes/export_table_template.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_drafts.coffee","meteor://ðŸ’»app/routes/api_workflow_open_drafts.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_get.coffee","meteor://ðŸ’»app/routes/api_workflow_open_get.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_submit.coffee","meteor://ðŸ’»app/routes/api_workflow_open_submit.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_save.coffee","meteor://ðŸ’»app/routes/api_workflow_open_save.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_get_by_stepname.coffee","meteor://ðŸ’»app/routes/api_workflow_open_get_by_stepname.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_open_cfs.coffee","meteor://ðŸ’»app/routes/api_workflow_open_cfs.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_forward_refill.coffee","meteor://ðŸ’»app/routes/api_workflow_forward_refill.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_workflow_forward_table_refill.coffee","meteor://ðŸ’»app/routes/api_workflow_forward_table_refill.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_sub_table_sort.coffee","meteor://ðŸ’»app/routes/api_sub_table_sort.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/test_webhook.coffee","meteor://ðŸ’»app/routes/test_webhook.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_formula_users.coffee","meteor://ðŸ’»app/routes/api_formula_users.coffee","meteor://ðŸ’»app/packages/steedos_workflow/routes/api_formula_organizations.coffee","meteor://ðŸ’»app/routes/api_formula_organizations.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/set_instance_step_approve.coffee","meteor://ðŸ’»app/server/methods/set_instance_step_approve.coffee","meteor://ðŸ’»app/packages/steedos:workflow/server/methods/get_instance_data.js","meteor://ðŸ’»app/packages/steedos:workflow/server/methods/save_instance.js","meteor://ðŸ’»app/packages/steedos:workflow/server/methods/trace_approve_cc.js","meteor://ðŸ’»app/packages/steedos:workflow/server/methods/forward_instance.js","meteor://ðŸ’»app/packages/steedos:workflow/server/methods/cfs_instances.js","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_approve.coffee","meteor://ðŸ’»app/server/methods/instance_approve.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_return.coffee","meteor://ðŸ’»app/server/methods/instance_return.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_remind.coffee","meteor://ðŸ’»app/server/methods/instance_remind.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/next_step_users_not_found.coffee","meteor://ðŸ’»app/server/methods/next_step_users_not_found.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_number_rules.coffee","meteor://ðŸ’»app/server/methods/instance_number_rules.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/check_main_attach.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/related_instances.coffee","meteor://ðŸ’»app/server/methods/related_instances.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/edit_flow_positions.coffee","meteor://ðŸ’»app/server/methods/edit_flow_positions.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/start_flow.coffee","meteor://ðŸ’»app/server/methods/start_flow.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_traces.coffee","meteor://ðŸ’»app/server/methods/instance_traces.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_batch.coffee","meteor://ðŸ’»app/server/methods/instance_batch.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/flow.coffee","meteor://ðŸ’»app/server/methods/flow.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/hide_instance.coffee","meteor://ðŸ’»app/server/methods/hide_instance.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/methods/instance_value.coffee","meteor://ðŸ’»app/server/methods/instance_value.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/routes/instance.coffee","meteor://ðŸ’»app/server/routes/instance.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/routes/steedos_css.coffee","meteor://ðŸ’»app/server/routes/steedos_css.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/routes/instance_draft_view.coffee","meteor://ðŸ’»app/server/routes/instance_draft_view.coffee","meteor://ðŸ’»app/packages/steedos:workflow/server/lib/1_form_formula.js","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/get_handlers_manager.coffee","meteor://ðŸ’»app/server/lib/get_handlers_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/permission_manager.coffee","meteor://ðŸ’»app/server/lib/permission_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/approve_manager.coffee","meteor://ðŸ’»app/server/lib/approve_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/flow_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/form_manager.coffee","meteor://ðŸ’»app/server/lib/form_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/step_manager.coffee","meteor://ðŸ’»app/server/lib/step_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/lib/instance_manager.coffee","meteor://ðŸ’»app/server/lib/instance_manager.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/categories.coffee","meteor://ðŸ’»app/server/publications/categories.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/cfs_instances.coffee","meteor://ðŸ’»app/server/publications/cfs_instances.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/flow_positions.coffee","meteor://ðŸ’»app/server/publications/flow_positions.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/flow_positions_tabular.coffee","meteor://ðŸ’»app/server/publications/flow_positions_tabular.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/flow_roles.coffee","meteor://ðŸ’»app/server/publications/flow_roles.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/flows.coffee","meteor://ðŸ’»app/server/publications/flows.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/forms.coffee","meteor://ðŸ’»app/server/publications/forms.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/instance_data.coffee","meteor://ðŸ’»app/server/publications/instance_data.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/instance_list.coffee","meteor://ðŸ’»app/server/publications/instance_list.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/instance_tabular.coffee","meteor://ðŸ’»app/server/publications/instance_tabular.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/instance_draft.coffee","meteor://ðŸ’»app/server/publications/instance_draft.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/distributed_instances_state_by_ids.coffee","meteor://ðŸ’»app/server/publications/distributed_instances_state_by_ids.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/related_instaces.coffee","meteor://ðŸ’»app/server/publications/related_instaces.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/space_user_signs.coffee","meteor://ðŸ’»app/server/publications/space_user_signs.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/user_inbox_instance.coffee","meteor://ðŸ’»app/server/publications/user_inbox_instance.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/publications/flow_main_attach_template.coffee","meteor://ðŸ’»app/server/publications/flow_main_attach_template.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/flow-template/workflow_template.coffee","meteor://ðŸ’»app/server/flow-template/workflow_template.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/schedule/auto_finish_process_delegation.coffee","meteor://ðŸ’»app/server/schedule/auto_finish_process_delegation.coffee","meteor://ðŸ’»app/packages/steedos_workflow/server/schedule/timeout_auto_submit.coffee","meteor://ðŸ’»app/server/schedule/timeout_auto_submit.coffee","meteor://ðŸ’»app/packages/steedos_workflow/related_instances_tabular.coffee","meteor://ðŸ’»app/related_instances_tabular.coffee","meteor://ðŸ’»app/packages/steedos_workflow/tabular.coffee","meteor://ðŸ’»app/tabular.coffee"],"names":["checkNpmVersions","module","link","v","cookies","mkdirp","root","factory","define","amd","URI","punycode","IPv6","SecondLevelDomains","SLD","_URI","url","base","_urlSupplied","arguments","length","_baseSupplied","undefined","TypeError","location","href","absoluteTo","version","p","prototype","hasOwn","Object","hasOwnProperty","escapeRegEx","string","replace","getType","value","String","toString","call","slice","isArray","obj","filterArrayValues","data","lookup","i","_match","test","splice","arrayContains","list","_type","match","arraysEqual","one","two","sort","l","trimSlashes","text","trim_expression","_parts","protocol","username","password","hostname","urn","port","path","query","fragment","duplicateQueryParameters","escapeQuerySpace","protocol_expression","idn_expression","punycode_expression","ip4_expression","ip6_expression","find_uri_expression","findUri","start","end","trim","defaultPorts","http","https","ftp","gopher","ws","wss","invalid_hostname_characters","domAttributes","getDomAttribute","node","nodeName","toLowerCase","type","escapeForDumbFirefox36","escape","strictEncodeURIComponent","encodeURIComponent","encode","decode","decodeURIComponent","iso8859","unescape","unicode","characters","pathname","expression","map","reserved","urnpath","encodeQuery","escaped","decodeQuery","e","_part","generateAccessor","_group","c","generateSegmentedPathFunction","_sep","_codingFuncName","_innerCodingFuncName","actualCodingFunc","segments","split","join","decodePath","decodeUrnPath","recodePath","recodeUrnPath","encodeReserved","parse","parts","pos","indexOf","substring","parseAuthority","parseHost","bracketPos","t","charAt","firstColon","firstSlash","nextColon","parseUserinfo","lastIndexOf","shift","parseQuery","items","splits","name","push","build","buildAuthority","buildHost","buildUserinfo","buildQuery","unique","key","buildQueryParameter","addQuery","concat","removeQuery","hasQuery","withinArray","_booly","Boolean","op","commonPath","Math","min","withinString","callback","options","_start","_end","_trim","_attributeOpen","lastIndex","exec","index","ignoreHtml","attributeOpen","max","search","ignore","result","ensureValidHostname","toASCII","noConflict","removeAll","unconflicted","URITemplate","deferBuild","_deferred_build","_string","clone","valueOf","generateSimpleAccessor","generatePrefixAccessor","_key","hash","res","_object","attribute","src","is","what","ip","ip4","ip6","sld","idn","relative","has","_protocol","_port","_hostname","scheme","x","origin","authority","host","userinfo","resource","subdomain","domain","sub","RegExp","tld","get","ReferenceError","directory","filename","decodePathSegment","mutatedDirectory","normalizePath","suffix","s","segment","separator","absolute","Error","pop","unshift","segmentCoded","q","setQuery","setSearch","addSearch","removeSearch","hasSearch","normalize","normalizeProtocol","normalizeQuery","normalizeFragment","normalizeHostname","normalizePort","best","_path","_was_relative","_leadingParents","_parent","_pos","normalizePathname","normalizeSearch","normalizeHash","d","readable","uri","toUnicode","qp","kv","resolved","properties","basedir","relativeTo","relativeParts","baseParts","common","relativePath","basePath","parents","equals","one_map","two_map","checked","one_query","two_query","Workflow","ImageSign","TracesHandler","TracesTemplate","InstanceformTemplate","InstanceAttachmentTemplate","InstanceSignText","RelatedInstances","RelatedRecords","InstanceMacro","context","TracesManager","isOpinionField_from_string","field_formula","includesOpinionField","form","form_version","_form_version","field_formulas","fields","Array","Meteor","isServer","uuflowManager","getFormVersion","db","forms","findOne","_id","form_versions","forEach","f","ref","console","log","f1","formula","_","some","helpers","auth_tokens","Collection","_getLocale","_getRequiredFields","_getStartStepEditableFields","_getStartStepRequiredFields","_getTemplateData","_getViewHtml","getLinkText","InstanceReadOnlyTemplate","instance_attachment","afSelectUserRead","afFormGroupRead","afFormGroup","create","tempalteName","steedosData","template","templateCompiled","templateRenderFunction","SpacebarsCompiler","compile","isBody","eval","Template","Blaze","createInstanceSignText","instanceSignTextCompiled","instanceSignTextHtml","instanceSignTextRenderFunction","instanceSignText","createImageSign","imageSignCompiled","imageSignHtml","imageSignRenderFunction","imageSign","createTracesHanlder","tracesHanlderCompiled","tracesHanlderHtml","tracesHanlderRenderFunction","instance_traces_handler","init","item","label","detail_url","Steedos","absoluteUrl","getValue","field","locale","utcOffset","date","hours","month","seconds","t0","t1","year","encodeURI","error","is_multiselect","getProperty","fullname","TAPi18n","__","Date","formatDate","is_textarea","Spacebars","SafeString","Markdown","numberToString","digits","getLabel","code","findPropertyByPK","getInstanceFormVersion","instance","form_fields","current","where","historys","getFlowVersion","flow","flow_version","flows","viewHtml","Assets","getText","user","ref1","toLocaleLowerCase","rev","is_required","steps","editableCode","startStep","keys","permissions","requiredFields","intersection","space","WorkflowManager","isClient","WorkflowManager_format","getAutoformSchemaValues","insname","ins_state","state","ins_final_decision","ins_code","ins_is_archived","is_archived","ins_is_deleted","applicant_name","applicantContext","sessionUserId","editable","startStepEditableFields","passing","moment","format","getInstanceView","body","instanceCompiled","instanceRenderFunction","instanceTemplate","TemplateManager","getTemplate","templateName","instance_readonly_view","toHTMLWithData","getTracesView","traceCompiled","traceRenderFunction","tracesHtml","instance_style","trace_readonly_view","traces","getAttachmentView","attachmentCompiled","attachmentHtml","attachmentRenderFunction","attachments_readonly_view","getRelatedInstancesView","relatedInstancesCompiled","relatedInstancesHtml","relatedInstancesRenderFunction","related_instances_view","getRelatedRecordsView","relatedRecordsCompiled","relatedRecordsHtml","relatedRecordsRenderFunction","related_records_view","getOnLoadScript","form_script","getInstanceHtml","allCssLink","attachment","creatorService","cssHref","formDescription","formDescriptionHtml","html","ins_record_ids","instanceBoxStyle","onLoadScript","openFileScript","related_instances","related_records","showTracesBtn","showTracesScript","trace","traceCheck","width","settings","webservices","creator","record_ids","JSON","stringify","isMobile","showTrace","final_decision","showAttachments","isEmpty","tagger","styles","description","plugins","formId","instance_title","pageTitle","pageTitleTrClass","val","CoreForm","pageTitleFieldName","handleTableTemplate","_export","table_fields","table_field","field_permission","pureCode","required","title_permission","removeSpecialCharacter","isOpinionField","tr_start","td_colspan","tr_end","includes","permission","_template","table","_templateHelps","steedos_instance","getInstance","atts","id","style","disabled","instanceId","form_types","ApproveManager","isReadOnly","steedos_form","innersubformContext","doc_values","Session","a","b","SimpleSchema","getAutoformSchema","instance_box_style","box","ins","judge","print_template","instance_template","SteedosTable","checkItem","item_index","fieldObj","getField","fieldVal","getItemModalValue","sf_name","sfields","sf","InstanceManager","checkFormFieldValue","$","setTableItemValue","item_value","tableValue","getTableValue","getTableItemValue","removeTableItem","removed","setTableValue","getValidValue","validValue","handleData","values","instanceFields","getInstanceFields","getModalData","Form_formula","getFormulaFieldVariable","AutoForm","getFormValues","insertDoc","addItem","_item_value","getKeys","append","getTr","updateItem","tds","getRemoveTd","sfield","getTd","empty","runFormula","removeItem","hide","showModal","method","modalData","Modal","show","getCurrentDataForForm","ss","getFormSchema","schema","objectKeys","_makeGeneric","getThead","isObject","thead","trs","sf_length","wide_fields","filterProperty","is_wide","getTbody","sfieldsEditable","tbody","tr","td","td_value","getTDValue","view","CFDataManager","getFormulaSpaceUsers","u","getFormulaOrganizations","o","getFormulaOrganization","pluck","addInputType","valueOut","valueConverters","stringToStringArray","stringToNumber","stringToNumberArray","stringToBoolean","stringToBooleanArray","stringToDate","stringToDateArray","contextAdjust","maxlength","afTable","events","event","new_item_index","currentTarget","dataset","set","rendered","str","addItemTr","getCurrentStep","step_type","ccHasEditPermission","autorun","currentData","spaceUserSign","userId","space_user_signs","imageURL","sign","showSignImage","handler","is_finished","objectUrl","object_name","record_id","app_id","Creator","getObjectUrl","unempty","unequals","include","ref2","ref3","getInstanceFlowVersion","approves","ref4","step","approve","judge_name","handler_name","handler_organization_name","handler_organization_fullname","finish_date","opinion_fields_code","sign_field_code","is_read","sign_show","after_field","before_field","pre_fields","pre_wide_fields","sort_approve","order","p1","p2","_p1","_p2","getTime","_t","getCfClass","getTableThead","getTableBody","showLabel","templateData","getOpinionFieldStepsName","top_keywords","foo1","opinionFields","foo","json_formula","s1","error1","yijianlan","stepName","image_sign","only_cc_opinion","only_cc","default_description","only_handler","showCCOpinion","markDownToHtml","markDownString","renderer","Renderer","title","f_label","that","isSection","registerHelper","ins_attach_download_url","getPermissions","instanceformChangeEvent","preventDefault","openWindow","target","onCreated","compiled","instanceCustomTemplate","instanceView","renderFunction","View","instance_custom_template","onRendered","currentApprove","currentStep","formula_fields","instanceNumberFields","applicant","nextSteps","nextStepUsers","InstanceEvent","initEvents","getCurrentApprove","each","element","schemaKey","toastr","reason","getFieldValue","InstanceNumberRules","instanceNumberBuilder","trigger","run","showMainTitle","workflowMainAttachTitle","enabled_add_main_attachment","current_step","main_attach_count","cfs","instances","find","count","distribute_main_attach_count","distribute_from_instance","start_step","getStartStep","can_edit_main_attach","enabled_edit_normal_attachment","getFlow","upload_after_being_distributed","isCC","getCCStep","can_edit_normal_attach","main_attachment","main_attach","normal_attachments","selector","$ne","dfis","distribute_from_instances","$in","distribute_main","firstVersionMain","metadata","parent","attachmentUploadedAt","uploadedAt","firstVersion","sortBy","instanceIds","attachments_count","flow_files","files","isDraftAndFlowfilesExist","compact","attachments","$or","fetch","myApprove","myTrace","isInbox","defaultDescription","approve_sort","approvesGroup","approves_sorted","completed_date","hasNext","haveDescriptionApprove","is_completed","last","top_approves","union","filter","top_approve","groupBy","handlerApproves","descriptionApproves","_display","isMyApprove","myApproveDescription","approveId","now","isOpinionOfField","imageSignData","getLastSignApprove","getHandlerSignShowApproves","lastMyApproveDescription","showApprove","judge_description","is_approved","is_rejected","is_readed","addClass","setTimeout","dateFormat","getFullYear","getStepName","stepId","getInstanceStep","showDeleteButton","approved","from_user","isShowModificationButton","approve_admins","isShow","workflow","contains","isEditing","is_editing","isShowDescription","getApproveStatusIcon","approveJudge","autoSubmitted","approveStatusIcon","getApproveStatusText","approveStatusText","getApproveJudgeClass","isForward","showForwardDeleteButton","forward_instance","isDistribute","showDistributeDeleteButton","hasFeature","getSpaceId","hasFlowAdminPermission","finishDateSchema","isAndroidOrIOS","autoform","optional","readonly","dateTimePickerOptions","ignoreReadonly","widgetPositioning","horizontal","finishDateValues","showTracesView","show_modal_traces_list","space_settings","getInstanceStateText","instance_id","getInstanceStateColor","cla","firstTrace","last_distribute_from","dis_info","$exists","created","created_by","UUflow_api","getNameForUser","users","from_user_name","isCCOrDistributeOrForwardTerminated","judgeTerminated","instanceExists","agentDescription","userName","traceName","traceId","stopPropagation","calling","err","removeClass","success","closest","target_user_id","openSafeObjectUrl","forward_space","forwardspace","forwardinstance","Tracker","afterFlush","on","scrollTop","finish_input","opinion_input","allowMultiple","showRelatedInstaces","related_instaces","related_instace_url","isCordova","show_delete","showRelatedRecords","DesignerAPI","getAbsoluteUrl","rootUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","writeResponse","httpCode","statusCode","sendInvalidURLResponse","sendAuthTokenExpiredResponse","sendHtmlResponse","req","error_msg","JsonRoutes","add","next","deal_type","spaceId","sendResult","specifyUserIds","getUsers","applicantId","approveRoleIds","getUser","getRoleUsersByOrgsAndRoles","organizations","approveHrRoleIds","getHrRolesUsers","manager","userField","userFieldValue","orgs","orgChildrens","orgField","orgFieldValue","getOrganizations","getOrganizationsChildrens","getOrganization","getOrganizationChildrens","getOrganizationsUsers","orgFieldUsers","specifyOrgIds","specifyOrgs","specifyOrgChildrens","approverRoleIds","getRoleUsersByUsersAndRoles","su","user_accepted","uniqUsers","userIds","spaceUsers","getFormulaUserObject","autoFormDoc","approver","formula_values","init_formula_values","stack","errors","errorMessage","message","categories","companyId","current_user","current_user_info","org","positions","roles","spaceIds","spaces","spacesQuery","check_authorization","admins","company_id","space_users","is_deleted","is_valid","help_text","category","name_formula","code_formula","flowtype","current_no","perms","error_message","distribute_optional_users","flow_roles","flow_positions","SpaceUsers","Users","Forms","Flows","Organizations","Positions","Roles","Categories","Spaces","hashData","approve_from_client","workflow_engine","inserted_instances","instance_from_client","new_ins","new_ins_id","create_instance","inserts","cc_users","delete_obj","inbox_users","spaceUserOrganizations","space_id","space_user","user_ids","getSpace","getSpaceUser","submitter","canAdmin","deleted","deleted_by","deleted_instances","insert","remove","uniq","u_id","pushManager","send_message_to_specifyUser","send_instance_notification","current_approve","flow_id","r","submit_instance","alerts","triggerWebhook","distributedInstancesRemind","flow_ver_end_step","flow_vers","h","instance_flow_ver","instance_trace","newApprove","newTrace","old_cc_users","old_inbox_users","old_outbox_users","setObj","space_user_org_info","tempUsers","terminate_reason","isInstancePending","getSpaceUserOrgInfo","f_ver","f_step","permissionManager","getFlowPermissions","Mongo","ObjectID","_str","user_name","handler_organization","start_date","due_date","read_date","is_error","cost_time","previous_trace_ids","outbox_users","nft_approve","modified","modified_by","current_step_name","current_step_auto_submit","update","$set","user_id","send_message_current_user","_users","approve_users_handlers","assignee_appr","current_space_user","current_user_organization","inbox_users_from_client","last_trace","last_trace_from_client","new_inbox_users","not_in_inbox_users","reassign_reason","difference","organization","agent","handler_id","handler_info","new_appr","new_user","user_organization","getAgent","setRemindInfo","ah","approve_users","current_setp","current_setp_type","next_step","next_step_name","next_step_type","relocate_appr","relocate_comment","relocate_inbox_users","relocate_next_step","sameTraces","signShowApproveId","ta","ti","getStep","getUpdatedValues","getDueDate","timeout_hours","next_step_user_id","idx","next_step_space_user","next_step_user_org_info","user_info","getCurrentStepAutoSubmit","timeout_auto_submit","lines","$unset","isInstanceFinishedAndNotArchieved","isInstanceSubmitterOrApplicantOrSpaceAdmin","startup","WebApp","connectHandlers","use","ejs","ejsLint","end_date","error_obj","fileName","flow_ids","form_name","ins_to_xls","lang","last_month_date","ret","timezoneoffset","uid","parseInt","getMyAdminOrMonitorFlows","getMonth","submit_date","$gte","$lte","require","lint","formater","setHeader","auth_token","formids","is_admin","sync_token","enabled","get_SpaceChangeSet","last_trace_id","org_info","previous_step","previous_trace","previous_trace_approves","previous_trace_id","previous_trace_name","previous_trace_step_id","retrieve_approve","retrieve_comment","retrieve_type","the_trace","retrieve_appr","appr","current_user_id","hasSaveInstanceToAttachment","isForwardAttachments","selectedUsers","action_type","related","from_approve_id","check","Match","OneOf","old_space_id","forward_users","no_permission_user_ids","no_permission_users_name","new_ins_ids","current_trace","current_trace_id","forward_approves","set_obj","old_values","new_values","old_form","old_form_version","old_fields","common_fields","select_to_input_fields","exists_field","select_input_field","old_v","old_multiSelected","new_multiSelected","old_table_row_values","new_table_row_values","record_need","FONDSID","instance_name","name_forumla","iscript","category_name","getCategory","ins_obj","handler_space_user","handler_org_info","_makeNewID","submitter_name","applicant_organization","applicant_organization_name","applicant_organization_fullname","forward_from_instance","trace_obj","step_id","step_name","appr_obj","auto_remind","flow_name","collection","instanceHtml","instanceFile","FS","File","attachData","Buffer","from","size","owner","owner_name","fileObj","main","newFile","createReadStream","original","$addToSet","$each","update_read","flowId","insId","redirectTo","redirectToUrl","req_async","params","status","send","writeHead","attach","limit","no_limit_count","ref5","result_instances","space_names","special_user_id","userid","workflow_categories","APIAuthenticationCheck","headers","ref6","ref7","copies","Cookies","authToken","isSpaceAdmin","is_paid","applicantInfo","applicant_id","applicant_username","ins_id","perm_users","next_step_id","next_user_ids","require_but_empty_fields","isInstanceDraft","getForm","checkValueFieldsRequire","getNextSteps","getHandlersManager","getHandlers","stepname","$elemMatch","inbox_uers","approve_id","parseFiles","mimeType","is_private","locked_by","locked_by_name","attach_id","file","columns","forward_ins","forward_ins_values","original_ins","original_ins_fields","original_ins_form","original_ins_id","original_subtable_fields","ref8","ref9","row_data","subTable","table_data","column","original_ins_field","oh","a_table","a_table_values","column_list","d_ins","d_ins_fields","d_ins_form","d_ins_values","d_match_col","d_match_col_field","d_match_col_fields","d_subtable_fields","d_table","d_table_values","o_ins","o_ins_fields","o_ins_form","o_ins_id","o_match_col","o_match_col_field","o_match_col_fields","o_subtable_fields","o_table","ref10","ref11","ref12","ref13","ref14","ref15","ref16","ref17","ref18","ref19","ref20","ref21","ref22","oTable","dTable","oMatchCol","dMatchCol","refillCol","aTable","o_ins_field","d_ins_field","dh","a_row","results","m","col","cols","d_col","d_col_fields","o_col","o_col_fields","d_row","has_obj","o_row","new_table_values","sort_col","sub_table","sub_table_values","sum_col","sumCol","sortCol","singleCols","JsonSort","jsonArr","asc","j","jl","temp","Number","isDevelopment","action","to_users","getFormulaUserObjects","orgIds","getFormulaOrgObjects","methods","set_instance_step_approve","step_approve","stepsApprovesOptions","_keys1","_keys2","stepsApproves","stepApproves","stepsApproveOptions","set_instance_skip_steps","$pull","skip_steps","$push","get_instance_data","formCached","flowCached","draft_save_instance","trace_id","next_steps","form_id","key_str","isInstanceSubmitter","org_id","getInstanceName","inbox_save_instance","isTraceNotFinished","isApproveNotFinished","isHandlerOrAgent","permissions_values","getApproveValues","change_values","approveManager","getChangeValues","extend","values_history","form_v","cc_do","cc_user_ids","new_approves","fileds","cc_read","cc_submit","tidx","aidx","upobj","updated_values","cc_remove","remove_user_id","multi","cc_save","currentStepId","updateObj","pushObj","forward_remove","hasAdminPermission","forward_instance_id","deleted_forward_instance_id","cancelDistribute","approve_ids","exists","cfs_instances_remove","file_id","cfs_instances_set_current","cfs_instances_lock","cfs_instances_unlock","download_space_instance_attachments_to_disk","cfsRecordIds","is_cloudadmin","store","fs","__meteor_bootstrap__","serverDir","absolutePath","resolve","sync","time","downloadFailedRecordIds","filePath","wrapAsync","writer","createWriteStream","isFunction","reader","pipe","timeEnd","set_approve_have_read","self","change_approve_info","update_approve_sign","sign_type","lastSignApprove","currentApproveDescription","currentTrace","session_userId","trimDescription","upObj","keepLastSignApproveDescription","custom_sign_show","tIdx","aIdx","update_sign_show","objs","myApprove_id","instance_return","approve_values","pre_step","pre_trace","rest_counter_users","instance_remind","remind_users","remind_count","remind_deadline","action_types","last_remind_users","priority","ap","caculate_date","manual_deadline","caculatePlusHalfWorkingDay","remind_date","caculateWorkingTime","base_date","plus_halfday_date","sendRemindSMS","next_step_users_not_found","approver_roles","roles_name","role_name","_eval","_NUMBER","_YYYY","numberRules","rules","script","instance_number_rules","number","YYYY","MM","mm","DD","getDate","dd","first_number","NUMBER","newNo","_error","check_main_attach","checkMainAttach","remove_related","re_ins_id","update_instance_related","updateFlowPosition","role","updateFlowRole","start_flow","keyValue","start_flows","steedos_keyvalues","get_instance_traces","miniApproveFields","categoryId","flowIds","_batch_instances","getBatchInstances","myApproves","my_approve","getMyApprove","change_flow_state","_userId","_flows","_flows_state","form_current_fields_code","specifyStep","approver_step","_step","fields_modifiable","hide_instance","is_hidden","getInstanceValues","getInstanceReadOnly","_hasPermission","_locale","_parent_instances","dataBuf","hide_traces","spaceUserCount","getAPILoginUser","access_token","getUserIdFromAccessToken","hasInstancePermissions","_parent_id","_parent_ins","charset","ret_sync_token","spaceUser","canMonitor","$gt","$nin","skip","allCss","getRefreshableAssets","css","ROOT_URL","endsWith","g","k","getEach","mixin","dest","handerUserObject","hr","sort_no","mobile","work_phone","position","userRoles","handerOrgObject","__values","tableFields","tableValues","formulaTableValues","__tableValues","tablefield","getHandlersByUsersAndRoles","role_ids","getHandlersByUserAndRoles","role_id","getHandlersByUserAndRole","getHandlersByOrgAndRole","getHandlersByOrgsAndRoles","org_ids","getHandlersByOrgAndRoles","parent_id","_approve","_space_user","_trace","applicantSuperiors","approver_org_field","approver_org_ids","approver_user_field","approver_user_ids","current_flow","current_flow_version","current_form","current_steps","field_code","finished_traces","flow_rev","form_rev","handlers","max_startDate_trace","new_approver_user_ids","new_org_user_ids","newest_values","next_step_users","org_ids_names","org_user_ids","space_user_count","submitter_user_count","unfinished_trace","user_ids_names","valid_approver_org_ids","history","approver_role","role_count","approver_hr_roles","current_flow_history","form_history","form_field","check_org_count","check_orgs","org_children","org_users","check_org_user","org_user","check_user_count","approve_user","check_approve_user_count","approver_orgs","approver_org_id","valid_approver_org_id","child_orgs","valid_approver_org","child_org","org_user_id","space_user_info_count","approver_users","approver_user_id","_tr","_app","my_permissions","orgs_can_add","orgs_can_admin","orgs_can_monitor","users_can_add","users_can_admin","users_can_monitor","last_values","approve_values_keys","changeValues","last_values_keys","isEqual","flowManager","getCategoriesFlows","categorieId","categoriesForms","formManager","getCategoriesForms","getUnCategoriesFlows","unCategoriesForms","getUnCategoriesForms","_fields","stepManager","allowBatch","isExistStep","logger","Logger","handlerInstanceByFieldMap","field_map","currentApproves","currentTraces","getCurrentTrace","inbox_user","FIELDS","categoryFlows","inbox_instances","unCategoryFlows","approve_start_date","publish","ready","app","publishComposite","tableName","ids","Optional","unblock","children","createTemplateFormAndFlow","distribute_to_self","versionId","handle","latest","observeChanges","changed","added","onStop","stop","distribute_end_notification","allow_select_step","getMiniInstance","getMyapproveModified","instance_fields_0","needChange","triggerChangeFields","triggerChangeFieldsValues","myApproveModifieds","_instanceId","changeFields","_change","_rev","_my_approve_modifieds","getInstanceTraces","_insId","asyncLastFinishedApprove","lastFinishedApproveAggregate","instanceid","dataMap","operation","rawCollection","aggregate","toArray","doc","getMyLastFinishedApprove","getStepCurrentName","notFinishedTraces","stepCurrentName","$slice","myLastFinishedApprove","agent_user_name","my_finish_date","is_cc","cc_count","instance_ids","related_instance_ids","_async_get_flow_instances_aggregate","_get_flow_instances_aggregate","_items","$match","$group","$sum","_changeData","_flowsData","_init","dataItem","flow_instance","observe","getCollection","workflowTemplate","absolute_path_cn","absolute_path_us","filesList_cn","filesList_us","mime","path_cn","path_us","readFileList","pathDir","filesList","readdirSync","stat","statSync","isDirectory","workflowTemplates","existsSync","readFileSync","go_next","rule","schedule","cron","auto_finish_process_delegation","scheduleJob","bindEnvironment","process_delegation_rules","end_time","timeoutAutoSubmit","TabularTables","related_instances_tabular","Tabular","Table","orderable","render","input","step_current_name","dom","lengthChange","extraFields","pageLength","info","searching","responsive","details","autoWidth","changeSelector","curSpaceUser","$and","fl","GetBoxInstancesTabularOptions","_get_inbox_instances_tabular_options","_get_outbox_instances_tabular_options","_handleListFields","instancesListTableTabular","newInstancesListTabular","updateTabularTitle","subs","SubsManager","ins_fields","pub","onUnload","instance_list","_tableColumns","drawCallback","ellipsisLink","emptyTd","colSpan","isPad","perfectScrollbar","oInstance","attr","click","goPage","height","pages","ceil","fnRecordsDisplay","_iDisplayLength","DataTable","page","draw","blur","currentPage","keydown","keyCode","createdRow","row","dataIndex","FlowRouter","setAttribute","agent_view","cc_view","instanceNamePriorityClass","isFavoriteSelected","modifiedFromNow","modifiedString","priorityIcon","priorityIconClass","priorityValue","step_current_name_view","unread","momentReactiveFromNow","Favorites","isRecordSelected","visible","cc_tag","lengthMenu","pagingType","is_list_display","filteredRecordIds","old_filteredRecordIds","findOptions","ag_sort","aggregate_operation","async_aggregate","s1_0","s1_1","$project","$unwind","$first","$sort","$skip","$limit","cb","$last","outbox_instances","flowInstances","ReactiveVar","_changeOrder"],"mappings":"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","file":"/packages/steedos_workflow.js","sourcesContent":["import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\t\"node-schedule\": \"^1.3.1\",\r\n\tcookies: \"^0.6.2\",\r\n\t\"xml2js\": \"^0.4.19\",\r\n\tmkdirp: \"^0.3.5\",\r\n}, 'steedos:workflow');","/*!\r\n * URI.js - Mutating URLs\r\n *\r\n * Version: 1.17.0\r\n *\r\n * Author: Rodney Rehm\r\n * Web: http://medialize.github.io/URI.js/\r\n *\r\n * Licensed under\r\n *   MIT License http://www.opensource.org/licenses/mit-license\r\n *   GPL v3 http://opensource.org/licenses/GPL-3.0\r\n *\r\n */\r\n(function (root, factory) {\r\n\t'use strict';\r\n\t// https://github.com/umdjs/umd/blob/master/returnExports.js\r\n\t// if (typeof exports === 'object') {\r\n\t//   // Node\r\n\t//   module.exports = factory(require('./punycode'), require('./IPv6'), require('./SecondLevelDomains'));\r\n\t// } else\r\n\tif (typeof define === 'function' && define.amd) {\r\n\t\t// AMD. Register as an anonymous module.\r\n\t\tdefine(['./punycode', './IPv6', './SecondLevelDomains'], factory);\r\n\t} else {\r\n\t\t// Browser globals (root is window)\r\n\t\troot.URI = factory(root.punycode, root.IPv6, root.SecondLevelDomains, root);\r\n\t}\r\n}(this, function (punycode, IPv6, SLD, root) {\r\n\t'use strict';\r\n\t/*global location, escape, unescape */\r\n\t// FIXME: v2.0.0 renamce non-camelCase properties to uppercase\r\n\t/*jshint camelcase: false */\r\n\r\n\t// save current URI variable, if any\r\n\tvar _URI = root && root.URI;\r\n\r\n\tfunction URI(url, base) {\r\n\t\tvar _urlSupplied = arguments.length >= 1;\r\n\t\tvar _baseSupplied = arguments.length >= 2;\r\n\r\n\t\t// Allow instantiation without the 'new' keyword\r\n\t\tif (!(this instanceof URI)) {\r\n\t\t\tif (_urlSupplied) {\r\n\t\t\t\tif (_baseSupplied) {\r\n\t\t\t\t\treturn new URI(url, base);\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn new URI(url);\r\n\t\t\t}\r\n\r\n\t\t\treturn new URI();\r\n\t\t}\r\n\r\n\t\tif (url === undefined) {\r\n\t\t\tif (_urlSupplied) {\r\n\t\t\t\tthrow new TypeError('undefined is not a valid argument for URI');\r\n\t\t\t}\r\n\r\n\t\t\tif (typeof location !== 'undefined') {\r\n\t\t\t\turl = location.href + '';\r\n\t\t\t} else {\r\n\t\t\t\turl = '';\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.href(url);\r\n\r\n\t\t// resolve to base according to http://dvcs.w3.org/hg/url/raw-file/tip/Overview.html#constructor\r\n\t\tif (base !== undefined) {\r\n\t\t\treturn this.absoluteTo(base);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t}\r\n\r\n\tURI.version = '1.17.0';\r\n\r\n\tvar p = URI.prototype;\r\n\tvar hasOwn = Object.prototype.hasOwnProperty;\r\n\r\n\tfunction escapeRegEx(string) {\r\n\t\t// https://github.com/medialize/URI.js/commit/85ac21783c11f8ccab06106dba9735a31a86924d#commitcomment-821963\r\n\t\treturn string.replace(/([.*+?^=!:${}()|[\\]\\/\\\\])/g, '\\\\$1');\r\n\t}\r\n\r\n\tfunction getType(value) {\r\n\t\t// IE8 doesn't return [Object Undefined] but [Object Object] for undefined value\r\n\t\tif (value === undefined) {\r\n\t\t\treturn 'Undefined';\r\n\t\t}\r\n\r\n\t\treturn String(Object.prototype.toString.call(value)).slice(8, -1);\r\n\t}\r\n\r\n\tfunction isArray(obj) {\r\n\t\treturn getType(obj) === 'Array';\r\n\t}\r\n\r\n\tfunction filterArrayValues(data, value) {\r\n\t\tvar lookup = {};\r\n\t\tvar i, length;\r\n\r\n\t\tif (getType(value) === 'RegExp') {\r\n\t\t\tlookup = null;\r\n\t\t} else if (isArray(value)) {\r\n\t\t\tfor (i = 0, length = value.length; i < length; i++) {\r\n\t\t\t\tlookup[value[i]] = true;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tlookup[value] = true;\r\n\t\t}\r\n\r\n\t\tfor (i = 0, length = data.length; i < length; i++) {\r\n\t\t\t/*jshint laxbreak: true */\r\n\t\t\tvar _match = lookup && lookup[data[i]] !== undefined\r\n\t\t\t\t|| !lookup && value.test(data[i]);\r\n\t\t\t/*jshint laxbreak: false */\r\n\t\t\tif (_match) {\r\n\t\t\t\tdata.splice(i, 1);\r\n\t\t\t\tlength--;\r\n\t\t\t\ti--;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn data;\r\n\t}\r\n\r\n\tfunction arrayContains(list, value) {\r\n\t\tvar i, length;\r\n\r\n\t\t// value may be string, number, array, regexp\r\n\t\tif (isArray(value)) {\r\n\t\t\t// Note: this can be optimized to O(n) (instead of current O(m * n))\r\n\t\t\tfor (i = 0, length = value.length; i < length; i++) {\r\n\t\t\t\tif (!arrayContains(list, value[i])) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\tvar _type = getType(value);\r\n\t\tfor (i = 0, length = list.length; i < length; i++) {\r\n\t\t\tif (_type === 'RegExp') {\r\n\t\t\t\tif (typeof list[i] === 'string' && list[i].match(value)) {\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t} else if (list[i] === value) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction arraysEqual(one, two) {\r\n\t\tif (!isArray(one) || !isArray(two)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// arrays can't be equal if they have different amount of content\r\n\t\tif (one.length !== two.length) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tone.sort();\r\n\t\ttwo.sort();\r\n\r\n\t\tfor (var i = 0, l = one.length; i < l; i++) {\r\n\t\t\tif (one[i] !== two[i]) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\tfunction trimSlashes(text) {\r\n\t\tvar trim_expression = /^\\/+|\\/+$/g;\r\n\t\treturn text.replace(trim_expression, '');\r\n\t}\r\n\r\n\tURI._parts = function() {\r\n\t\treturn {\r\n\t\t\tprotocol: null,\r\n\t\t\tusername: null,\r\n\t\t\tpassword: null,\r\n\t\t\thostname: null,\r\n\t\t\turn: null,\r\n\t\t\tport: null,\r\n\t\t\tpath: null,\r\n\t\t\tquery: null,\r\n\t\t\tfragment: null,\r\n\t\t\t// state\r\n\t\t\tduplicateQueryParameters: URI.duplicateQueryParameters,\r\n\t\t\tescapeQuerySpace: URI.escapeQuerySpace\r\n\t\t};\r\n\t};\r\n\t// state: allow duplicate query parameters (a=1&a=1)\r\n\tURI.duplicateQueryParameters = false;\r\n\t// state: replaces + with %20 (space in query strings)\r\n\tURI.escapeQuerySpace = true;\r\n\t// static properties\r\n\tURI.protocol_expression = /^[a-z][a-z0-9.+-]*$/i;\r\n\tURI.idn_expression = /[^a-z0-9\\.-]/i;\r\n\tURI.punycode_expression = /(xn--)/i;\r\n\t// well, 333.444.555.666 matches, but it sure ain't no IPv4 - do we care?\r\n\tURI.ip4_expression = /^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\r\n\t// credits to Rich Brown\r\n\t// source: http://forums.intermapper.com/viewtopic.php?p=1096#1096\r\n\t// specification: http://www.ietf.org/rfc/rfc4291.txt\r\n\tURI.ip6_expression = /^\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*$/;\r\n\t// expression used is \"gruber revised\" (@gruber v2) determined to be the\r\n\t// best solution in a regex-golf we did a couple of ages ago at\r\n\t// * http://mathiasbynens.be/demo/url-regex\r\n\t// * http://rodneyrehm.de/t/url-regex.html\r\n\tURI.find_uri_expression = /\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?Â«Â»â€œâ€â€˜â€™]))/ig;\r\n\tURI.findUri = {\r\n\t\t// valid \"scheme://\" or \"www.\"\r\n\t\tstart: /\\b(?:([a-z][a-z0-9.+-]*:\\/\\/)|www\\.)/gi,\r\n\t\t// everything up to the next whitespace\r\n\t\tend: /[\\s\\r\\n]|$/,\r\n\t\t// trim trailing punctuation captured by end RegExp\r\n\t\ttrim: /[`!()\\[\\]{};:'\".,<>?Â«Â»â€œâ€â€žâ€˜â€™]+$/\r\n\t};\r\n\t// http://www.iana.org/assignments/uri-schemes.html\r\n\t// http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers#Well-known_ports\r\n\tURI.defaultPorts = {\r\n\t\thttp: '80',\r\n\t\thttps: '443',\r\n\t\tftp: '21',\r\n\t\tgopher: '70',\r\n\t\tws: '80',\r\n\t\twss: '443'\r\n\t};\r\n\t// allowed hostname characters according to RFC 3986\r\n\t// ALPHA DIGIT \"-\" \".\" \"_\" \"~\" \"!\" \"$\" \"&\" \"'\" \"(\" \")\" \"*\" \"+\" \",\" \";\" \"=\" %encoded\r\n\t// I've never seen a (non-IDN) hostname other than: ALPHA DIGIT . -\r\n\tURI.invalid_hostname_characters = /[^a-zA-Z0-9\\.-]/;\r\n\t// map DOM Elements to their URI attribute\r\n\tURI.domAttributes = {\r\n\t\t'a': 'href',\r\n\t\t'blockquote': 'cite',\r\n\t\t'link': 'href',\r\n\t\t'base': 'href',\r\n\t\t'script': 'src',\r\n\t\t'form': 'action',\r\n\t\t'img': 'src',\r\n\t\t'area': 'href',\r\n\t\t'iframe': 'src',\r\n\t\t'embed': 'src',\r\n\t\t'source': 'src',\r\n\t\t'track': 'src',\r\n\t\t'input': 'src', // but only if type=\"image\"\r\n\t\t'audio': 'src',\r\n\t\t'video': 'src'\r\n\t};\r\n\tURI.getDomAttribute = function(node) {\r\n\t\tif (!node || !node.nodeName) {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\r\n\t\tvar nodeName = node.nodeName.toLowerCase();\r\n\t\t// <input> should only expose src for type=\"image\"\r\n\t\tif (nodeName === 'input' && node.type !== 'image') {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\r\n\t\treturn URI.domAttributes[nodeName];\r\n\t};\r\n\r\n\tfunction escapeForDumbFirefox36(value) {\r\n\t\t// https://github.com/medialize/URI.js/issues/91\r\n\t\treturn escape(value);\r\n\t}\r\n\r\n\t// encoding / decoding according to RFC3986\r\n\tfunction strictEncodeURIComponent(string) {\r\n\t\t// see https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/encodeURIComponent\r\n\t\treturn encodeURIComponent(string)\r\n\t\t\t.replace(/[!'()*]/g, escapeForDumbFirefox36)\r\n\t\t\t.replace(/\\*/g, '%2A');\r\n\t}\r\n\tURI.encode = strictEncodeURIComponent;\r\n\tURI.decode = decodeURIComponent;\r\n\tURI.iso8859 = function() {\r\n\t\tURI.encode = escape;\r\n\t\tURI.decode = unescape;\r\n\t};\r\n\tURI.unicode = function() {\r\n\t\tURI.encode = strictEncodeURIComponent;\r\n\t\tURI.decode = decodeURIComponent;\r\n\t};\r\n\tURI.characters = {\r\n\t\tpathname: {\r\n\t\t\tencode: {\r\n\t\t\t\t// RFC3986 2.1: For consistency, URI producers and normalizers should\r\n\t\t\t\t// use uppercase hexadecimal digits for all percent-encodings.\r\n\t\t\t\texpression: /%(24|26|2B|2C|3B|3D|3A|40)/ig,\r\n\t\t\t\tmap: {\r\n\t\t\t\t\t// -._~!'()*\r\n\t\t\t\t\t'%24': '$',\r\n\t\t\t\t\t'%26': '&',\r\n\t\t\t\t\t'%2B': '+',\r\n\t\t\t\t\t'%2C': ',',\r\n\t\t\t\t\t'%3B': ';',\r\n\t\t\t\t\t'%3D': '=',\r\n\t\t\t\t\t'%3A': ':',\r\n\t\t\t\t\t'%40': '@'\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tdecode: {\r\n\t\t\t\texpression: /[\\/\\?#]/g,\r\n\t\t\t\tmap: {\r\n\t\t\t\t\t'/': '%2F',\r\n\t\t\t\t\t'?': '%3F',\r\n\t\t\t\t\t'#': '%23'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\treserved: {\r\n\t\t\tencode: {\r\n\t\t\t\t// RFC3986 2.1: For consistency, URI producers and normalizers should\r\n\t\t\t\t// use uppercase hexadecimal digits for all percent-encodings.\r\n\t\t\t\texpression: /%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/ig,\r\n\t\t\t\tmap: {\r\n\t\t\t\t\t// gen-delims\r\n\t\t\t\t\t'%3A': ':',\r\n\t\t\t\t\t'%2F': '/',\r\n\t\t\t\t\t'%3F': '?',\r\n\t\t\t\t\t'%23': '#',\r\n\t\t\t\t\t'%5B': '[',\r\n\t\t\t\t\t'%5D': ']',\r\n\t\t\t\t\t'%40': '@',\r\n\t\t\t\t\t// sub-delims\r\n\t\t\t\t\t'%21': '!',\r\n\t\t\t\t\t'%24': '$',\r\n\t\t\t\t\t'%26': '&',\r\n\t\t\t\t\t'%27': '\\'',\r\n\t\t\t\t\t'%28': '(',\r\n\t\t\t\t\t'%29': ')',\r\n\t\t\t\t\t'%2A': '*',\r\n\t\t\t\t\t'%2B': '+',\r\n\t\t\t\t\t'%2C': ',',\r\n\t\t\t\t\t'%3B': ';',\r\n\t\t\t\t\t'%3D': '='\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\turnpath: {\r\n\t\t\t// The characters under `encode` are the characters called out by RFC 2141 as being acceptable\r\n\t\t\t// for usage in a URN. RFC2141 also calls out \"-\", \".\", and \"_\" as acceptable characters, but\r\n\t\t\t// these aren't encoded by encodeURIComponent, so we don't have to call them out here. Also\r\n\t\t\t// note that the colon character is not featured in the encoding map; this is because URI.js\r\n\t\t\t// gives the colons in URNs semantic meaning as the delimiters of path segements, and so it\r\n\t\t\t// should not appear unencoded in a segment itself.\r\n\t\t\t// See also the note above about RFC3986 and capitalalized hex digits.\r\n\t\t\tencode: {\r\n\t\t\t\texpression: /%(21|24|27|28|29|2A|2B|2C|3B|3D|40)/ig,\r\n\t\t\t\tmap: {\r\n\t\t\t\t\t'%21': '!',\r\n\t\t\t\t\t'%24': '$',\r\n\t\t\t\t\t'%27': '\\'',\r\n\t\t\t\t\t'%28': '(',\r\n\t\t\t\t\t'%29': ')',\r\n\t\t\t\t\t'%2A': '*',\r\n\t\t\t\t\t'%2B': '+',\r\n\t\t\t\t\t'%2C': ',',\r\n\t\t\t\t\t'%3B': ';',\r\n\t\t\t\t\t'%3D': '=',\r\n\t\t\t\t\t'%40': '@'\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t// These characters are the characters called out by RFC2141 as \"reserved\" characters that\r\n\t\t\t// should never appear in a URN, plus the colon character (see note above).\r\n\t\t\tdecode: {\r\n\t\t\t\texpression: /[\\/\\?#:]/g,\r\n\t\t\t\tmap: {\r\n\t\t\t\t\t'/': '%2F',\r\n\t\t\t\t\t'?': '%3F',\r\n\t\t\t\t\t'#': '%23',\r\n\t\t\t\t\t':': '%3A'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\tURI.encodeQuery = function(string, escapeQuerySpace) {\r\n\t\tvar escaped = URI.encode(string + '');\r\n\t\tif (escapeQuerySpace === undefined) {\r\n\t\t\tescapeQuerySpace = URI.escapeQuerySpace;\r\n\t\t}\r\n\r\n\t\treturn escapeQuerySpace ? escaped.replace(/%20/g, '+') : escaped;\r\n\t};\r\n\tURI.decodeQuery = function(string, escapeQuerySpace) {\r\n\t\tstring += '';\r\n\t\tif (escapeQuerySpace === undefined) {\r\n\t\t\tescapeQuerySpace = URI.escapeQuerySpace;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\treturn URI.decode(escapeQuerySpace ? string.replace(/\\+/g, '%20') : string);\r\n\t\t} catch(e) {\r\n\t\t\t// we're not going to mess with weird encodings,\r\n\t\t\t// give up and return the undecoded original string\r\n\t\t\t// see https://github.com/medialize/URI.js/issues/87\r\n\t\t\t// see https://github.com/medialize/URI.js/issues/92\r\n\t\t\treturn string;\r\n\t\t}\r\n\t};\r\n\t// generate encode/decode path functions\r\n\tvar _parts = {'encode':'encode', 'decode':'decode'};\r\n\tvar _part;\r\n\tvar generateAccessor = function(_group, _part) {\r\n\t\treturn function(string) {\r\n\t\t\ttry {\r\n\t\t\t\treturn URI[_part](string + '').replace(URI.characters[_group][_part].expression, function(c) {\r\n\t\t\t\t\treturn URI.characters[_group][_part].map[c];\r\n\t\t\t\t});\r\n\t\t\t} catch (e) {\r\n\t\t\t\t// we're not going to mess with weird encodings,\r\n\t\t\t\t// give up and return the undecoded original string\r\n\t\t\t\t// see https://github.com/medialize/URI.js/issues/87\r\n\t\t\t\t// see https://github.com/medialize/URI.js/issues/92\r\n\t\t\t\treturn string;\r\n\t\t\t}\r\n\t\t};\r\n\t};\r\n\r\n\tfor (_part in _parts) {\r\n\t\tURI[_part + 'PathSegment'] = generateAccessor('pathname', _parts[_part]);\r\n\t\tURI[_part + 'UrnPathSegment'] = generateAccessor('urnpath', _parts[_part]);\r\n\t}\r\n\r\n\tvar generateSegmentedPathFunction = function(_sep, _codingFuncName, _innerCodingFuncName) {\r\n\t\treturn function(string) {\r\n\t\t\t// Why pass in names of functions, rather than the function objects themselves? The\r\n\t\t\t// definitions of some functions (but in particular, URI.decode) will occasionally change due\r\n\t\t\t// to URI.js having ISO8859 and Unicode modes. Passing in the name and getting it will ensure\r\n\t\t\t// that the functions we use here are \"fresh\".\r\n\t\t\tvar actualCodingFunc;\r\n\t\t\tif (!_innerCodingFuncName) {\r\n\t\t\t\tactualCodingFunc = URI[_codingFuncName];\r\n\t\t\t} else {\r\n\t\t\t\tactualCodingFunc = function(string) {\r\n\t\t\t\t\treturn URI[_codingFuncName](URI[_innerCodingFuncName](string));\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tvar segments = (string + '').split(_sep);\r\n\r\n\t\t\tfor (var i = 0, length = segments.length; i < length; i++) {\r\n\t\t\t\tsegments[i] = actualCodingFunc(segments[i]);\r\n\t\t\t}\r\n\r\n\t\t\treturn segments.join(_sep);\r\n\t\t};\r\n\t};\r\n\r\n\t// This takes place outside the above loop because we don't want, e.g., encodeUrnPath functions.\r\n\tURI.decodePath = generateSegmentedPathFunction('/', 'decodePathSegment');\r\n\tURI.decodeUrnPath = generateSegmentedPathFunction(':', 'decodeUrnPathSegment');\r\n\tURI.recodePath = generateSegmentedPathFunction('/', 'encodePathSegment', 'decode');\r\n\tURI.recodeUrnPath = generateSegmentedPathFunction(':', 'encodeUrnPathSegment', 'decode');\r\n\r\n\tURI.encodeReserved = generateAccessor('reserved', 'encode');\r\n\r\n\tURI.parse = function(string, parts) {\r\n\t\tvar pos;\r\n\t\tif (!parts) {\r\n\t\t\tparts = {};\r\n\t\t}\r\n\t\t// [protocol\"://\"[username[\":\"password]\"@\"]hostname[\":\"port]\"/\"?][path][\"?\"querystring][\"#\"fragment]\r\n\r\n\t\t// extract fragment\r\n\t\tpos = string.indexOf('#');\r\n\t\tif (pos > -1) {\r\n\t\t\t// escaping?\r\n\t\t\tparts.fragment = string.substring(pos + 1) || null;\r\n\t\t\tstring = string.substring(0, pos);\r\n\t\t}\r\n\r\n\t\t// extract query\r\n\t\tpos = string.indexOf('?');\r\n\t\tif (pos > -1) {\r\n\t\t\t// escaping?\r\n\t\t\tparts.query = string.substring(pos + 1) || null;\r\n\t\t\tstring = string.substring(0, pos);\r\n\t\t}\r\n\r\n\t\t// extract protocol\r\n\t\tif (string.substring(0, 2) === '//') {\r\n\t\t\t// relative-scheme\r\n\t\t\tparts.protocol = null;\r\n\t\t\tstring = string.substring(2);\r\n\t\t\t// extract \"user:pass@host:port\"\r\n\t\t\tstring = URI.parseAuthority(string, parts);\r\n\t\t} else {\r\n\t\t\tpos = string.indexOf(':');\r\n\t\t\tif (pos > -1) {\r\n\t\t\t\tparts.protocol = string.substring(0, pos) || null;\r\n\t\t\t\tif (parts.protocol && !parts.protocol.match(URI.protocol_expression)) {\r\n\t\t\t\t\t// : may be within the path\r\n\t\t\t\t\tparts.protocol = undefined;\r\n\t\t\t\t} else if (string.substring(pos + 1, pos + 3) === '//') {\r\n\t\t\t\t\tstring = string.substring(pos + 3);\r\n\r\n\t\t\t\t\t// extract \"user:pass@host:port\"\r\n\t\t\t\t\tstring = URI.parseAuthority(string, parts);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tstring = string.substring(pos + 1);\r\n\t\t\t\t\tparts.urn = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// what's left must be the path\r\n\t\tparts.path = string;\r\n\r\n\t\t// and we're done\r\n\t\treturn parts;\r\n\t};\r\n\tURI.parseHost = function(string, parts) {\r\n\t\t// Copy chrome, IE, opera backslash-handling behavior.\r\n\t\t// Back slashes before the query string get converted to forward slashes\r\n\t\t// See: https://github.com/joyent/node/blob/386fd24f49b0e9d1a8a076592a404168faeecc34/lib/url.js#L115-L124\r\n\t\t// See: https://code.google.com/p/chromium/issues/detail?id=25916\r\n\t\t// https://github.com/medialize/URI.js/pull/233\r\n\t\tstring = string.replace(/\\\\/g, '/');\r\n\r\n\t\t// extract host:port\r\n\t\tvar pos = string.indexOf('/');\r\n\t\tvar bracketPos;\r\n\t\tvar t;\r\n\r\n\t\tif (pos === -1) {\r\n\t\t\tpos = string.length;\r\n\t\t}\r\n\r\n\t\tif (string.charAt(0) === '[') {\r\n\t\t\t// IPv6 host - http://tools.ietf.org/html/draft-ietf-6man-text-addr-representation-04#section-6\r\n\t\t\t// I claim most client software breaks on IPv6 anyways. To simplify things, URI only accepts\r\n\t\t\t// IPv6+port in the format [2001:db8::1]:80 (for the time being)\r\n\t\t\tbracketPos = string.indexOf(']');\r\n\t\t\tparts.hostname = string.substring(1, bracketPos) || null;\r\n\t\t\tparts.port = string.substring(bracketPos + 2, pos) || null;\r\n\t\t\tif (parts.port === '/') {\r\n\t\t\t\tparts.port = null;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tvar firstColon = string.indexOf(':');\r\n\t\t\tvar firstSlash = string.indexOf('/');\r\n\t\t\tvar nextColon = string.indexOf(':', firstColon + 1);\r\n\t\t\tif (nextColon !== -1 && (firstSlash === -1 || nextColon < firstSlash)) {\r\n\t\t\t\t// IPv6 host contains multiple colons - but no port\r\n\t\t\t\t// this notation is actually not allowed by RFC 3986, but we're a liberal parser\r\n\t\t\t\tparts.hostname = string.substring(0, pos) || null;\r\n\t\t\t\tparts.port = null;\r\n\t\t\t} else {\r\n\t\t\t\tt = string.substring(0, pos).split(':');\r\n\t\t\t\tparts.hostname = t[0] || null;\r\n\t\t\t\tparts.port = t[1] || null;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (parts.hostname && string.substring(pos).charAt(0) !== '/') {\r\n\t\t\tpos++;\r\n\t\t\tstring = '/' + string;\r\n\t\t}\r\n\r\n\t\treturn string.substring(pos) || '/';\r\n\t};\r\n\tURI.parseAuthority = function(string, parts) {\r\n\t\tstring = URI.parseUserinfo(string, parts);\r\n\t\treturn URI.parseHost(string, parts);\r\n\t};\r\n\tURI.parseUserinfo = function(string, parts) {\r\n\t\t// extract username:password\r\n\t\tvar firstSlash = string.indexOf('/');\r\n\t\tvar pos = string.lastIndexOf('@', firstSlash > -1 ? firstSlash : string.length - 1);\r\n\t\tvar t;\r\n\r\n\t\t// authority@ must come before /path\r\n\t\tif (pos > -1 && (firstSlash === -1 || pos < firstSlash)) {\r\n\t\t\tt = string.substring(0, pos).split(':');\r\n\t\t\tparts.username = t[0] ? URI.decode(t[0]) : null;\r\n\t\t\tt.shift();\r\n\t\t\tparts.password = t[0] ? URI.decode(t.join(':')) : null;\r\n\t\t\tstring = string.substring(pos + 1);\r\n\t\t} else {\r\n\t\t\tparts.username = null;\r\n\t\t\tparts.password = null;\r\n\t\t}\r\n\r\n\t\treturn string;\r\n\t};\r\n\tURI.parseQuery = function(string, escapeQuerySpace) {\r\n\t\tif (!string) {\r\n\t\t\treturn {};\r\n\t\t}\r\n\r\n\t\t// throw out the funky business - \"?\"[name\"=\"value\"&\"]+\r\n\t\tstring = string.replace(/&+/g, '&').replace(/^\\?*&*|&+$/g, '');\r\n\r\n\t\tif (!string) {\r\n\t\t\treturn {};\r\n\t\t}\r\n\r\n\t\tvar items = {};\r\n\t\tvar splits = string.split('&');\r\n\t\tvar length = splits.length;\r\n\t\tvar v, name, value;\r\n\r\n\t\tfor (var i = 0; i < length; i++) {\r\n\t\t\tv = splits[i].split('=');\r\n\t\t\tname = URI.decodeQuery(v.shift(), escapeQuerySpace);\r\n\t\t\t// no \"=\" is null according to http://dvcs.w3.org/hg/url/raw-file/tip/Overview.html#collect-url-parameters\r\n\t\t\tvalue = v.length ? URI.decodeQuery(v.join('='), escapeQuerySpace) : null;\r\n\r\n\t\t\tif (hasOwn.call(items, name)) {\r\n\t\t\t\tif (typeof items[name] === 'string' || items[name] === null) {\r\n\t\t\t\t\titems[name] = [items[name]];\r\n\t\t\t\t}\r\n\r\n\t\t\t\titems[name].push(value);\r\n\t\t\t} else {\r\n\t\t\t\titems[name] = value;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn items;\r\n\t};\r\n\r\n\tURI.build = function(parts) {\r\n\t\tvar t = '';\r\n\r\n\t\tif (parts.protocol) {\r\n\t\t\tt += parts.protocol + ':';\r\n\t\t}\r\n\r\n\t\tif (!parts.urn && (t || parts.hostname)) {\r\n\t\t\tt += '//';\r\n\t\t}\r\n\r\n\t\tt += (URI.buildAuthority(parts) || '');\r\n\r\n\t\tif (typeof parts.path === 'string') {\r\n\t\t\tif (parts.path.charAt(0) !== '/' && typeof parts.hostname === 'string') {\r\n\t\t\t\tt += '/';\r\n\t\t\t}\r\n\r\n\t\t\tt += parts.path;\r\n\t\t}\r\n\r\n\t\tif (typeof parts.query === 'string' && parts.query) {\r\n\t\t\tt += '?' + parts.query;\r\n\t\t}\r\n\r\n\t\tif (typeof parts.fragment === 'string' && parts.fragment) {\r\n\t\t\tt += '#' + parts.fragment;\r\n\t\t}\r\n\t\treturn t;\r\n\t};\r\n\tURI.buildHost = function(parts) {\r\n\t\tvar t = '';\r\n\r\n\t\tif (!parts.hostname) {\r\n\t\t\treturn '';\r\n\t\t} else if (URI.ip6_expression.test(parts.hostname)) {\r\n\t\t\tt += '[' + parts.hostname + ']';\r\n\t\t} else {\r\n\t\t\tt += parts.hostname;\r\n\t\t}\r\n\r\n\t\tif (parts.port) {\r\n\t\t\tt += ':' + parts.port;\r\n\t\t}\r\n\r\n\t\treturn t;\r\n\t};\r\n\tURI.buildAuthority = function(parts) {\r\n\t\treturn URI.buildUserinfo(parts) + URI.buildHost(parts);\r\n\t};\r\n\tURI.buildUserinfo = function(parts) {\r\n\t\tvar t = '';\r\n\r\n\t\tif (parts.username) {\r\n\t\t\tt += URI.encode(parts.username);\r\n\r\n\t\t\tif (parts.password) {\r\n\t\t\t\tt += ':' + URI.encode(parts.password);\r\n\t\t\t}\r\n\r\n\t\t\tt += '@';\r\n\t\t}\r\n\r\n\t\treturn t;\r\n\t};\r\n\tURI.buildQuery = function(data, duplicateQueryParameters, escapeQuerySpace) {\r\n\t\t// according to http://tools.ietf.org/html/rfc3986 or http://labs.apache.org/webarch/uri/rfc/rfc3986.html\r\n\t\t// being Â»-._~!$&'()*+,;=:@/?Â« %HEX and alnum are allowed\r\n\t\t// the RFC explicitly states ?/foo being a valid use case, no mention of parameter syntax!\r\n\t\t// URI.js treats the query string as being application/x-www-form-urlencoded\r\n\t\t// see http://www.w3.org/TR/REC-html40/interact/forms.html#form-content-type\r\n\r\n\t\tvar t = '';\r\n\t\tvar unique, key, i, length;\r\n\t\tfor (key in data) {\r\n\t\t\tif (hasOwn.call(data, key) && key) {\r\n\t\t\t\tif (isArray(data[key])) {\r\n\t\t\t\t\tunique = {};\r\n\t\t\t\t\tfor (i = 0, length = data[key].length; i < length; i++) {\r\n\t\t\t\t\t\tif (data[key][i] !== undefined && unique[data[key][i] + ''] === undefined) {\r\n\t\t\t\t\t\t\tt += '&' + URI.buildQueryParameter(key, data[key][i], escapeQuerySpace);\r\n\t\t\t\t\t\t\tif (duplicateQueryParameters !== true) {\r\n\t\t\t\t\t\t\t\tunique[data[key][i] + ''] = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (data[key] !== undefined) {\r\n\t\t\t\t\tt += '&' + URI.buildQueryParameter(key, data[key], escapeQuerySpace);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn t.substring(1);\r\n\t};\r\n\tURI.buildQueryParameter = function(name, value, escapeQuerySpace) {\r\n\t\t// http://www.w3.org/TR/REC-html40/interact/forms.html#form-content-type -- application/x-www-form-urlencoded\r\n\t\t// don't append \"=\" for null values, according to http://dvcs.w3.org/hg/url/raw-file/tip/Overview.html#url-parameter-serialization\r\n\t\treturn URI.encodeQuery(name, escapeQuerySpace) + (value !== null ? '=' + URI.encodeQuery(value, escapeQuerySpace) : '');\r\n\t};\r\n\r\n\tURI.addQuery = function(data, name, value) {\r\n\t\tif (typeof name === 'object') {\r\n\t\t\tfor (var key in name) {\r\n\t\t\t\tif (hasOwn.call(name, key)) {\r\n\t\t\t\t\tURI.addQuery(data, key, name[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (typeof name === 'string') {\r\n\t\t\tif (data[name] === undefined) {\r\n\t\t\t\tdata[name] = value;\r\n\t\t\t\treturn;\r\n\t\t\t} else if (typeof data[name] === 'string') {\r\n\t\t\t\tdata[name] = [data[name]];\r\n\t\t\t}\r\n\r\n\t\t\tif (!isArray(value)) {\r\n\t\t\t\tvalue = [value];\r\n\t\t\t}\r\n\r\n\t\t\tdata[name] = (data[name] || []).concat(value);\r\n\t\t} else {\r\n\t\t\tthrow new TypeError('URI.addQuery() accepts an object, string as the name parameter');\r\n\t\t}\r\n\t};\r\n\tURI.removeQuery = function(data, name, value) {\r\n\t\tvar i, length, key;\r\n\r\n\t\tif (isArray(name)) {\r\n\t\t\tfor (i = 0, length = name.length; i < length; i++) {\r\n\t\t\t\tdata[name[i]] = undefined;\r\n\t\t\t}\r\n\t\t} else if (getType(name) === 'RegExp') {\r\n\t\t\tfor (key in data) {\r\n\t\t\t\tif (name.test(key)) {\r\n\t\t\t\t\tdata[key] = undefined;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (typeof name === 'object') {\r\n\t\t\tfor (key in name) {\r\n\t\t\t\tif (hasOwn.call(name, key)) {\r\n\t\t\t\t\tURI.removeQuery(data, key, name[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (typeof name === 'string') {\r\n\t\t\tif (value !== undefined) {\r\n\t\t\t\tif (getType(value) === 'RegExp') {\r\n\t\t\t\t\tif (!isArray(data[name]) && value.test(data[name])) {\r\n\t\t\t\t\t\tdata[name] = undefined;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdata[name] = filterArrayValues(data[name], value);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (data[name] === String(value) && (!isArray(value) || value.length === 1)) {\r\n\t\t\t\t\tdata[name] = undefined;\r\n\t\t\t\t} else if (isArray(data[name])) {\r\n\t\t\t\t\tdata[name] = filterArrayValues(data[name], value);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tdata[name] = undefined;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthrow new TypeError('URI.removeQuery() accepts an object, string, RegExp as the first parameter');\r\n\t\t}\r\n\t};\r\n\tURI.hasQuery = function(data, name, value, withinArray) {\r\n\t\tif (typeof name === 'object') {\r\n\t\t\tfor (var key in name) {\r\n\t\t\t\tif (hasOwn.call(name, key)) {\r\n\t\t\t\t\tif (!URI.hasQuery(data, key, name[key])) {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn true;\r\n\t\t} else if (typeof name !== 'string') {\r\n\t\t\tthrow new TypeError('URI.hasQuery() accepts an object, string as the name parameter');\r\n\t\t}\r\n\r\n\t\tswitch (getType(value)) {\r\n\t\t\tcase 'Undefined':\r\n\t\t\t\t// true if exists (but may be empty)\r\n\t\t\t\treturn name in data; // data[name] !== undefined;\r\n\r\n\t\t\tcase 'Boolean':\r\n\t\t\t\t// true if exists and non-empty\r\n\t\t\t\tvar _booly = Boolean(isArray(data[name]) ? data[name].length : data[name]);\r\n\t\t\t\treturn value === _booly;\r\n\r\n\t\t\tcase 'Function':\r\n\t\t\t\t// allow complex comparison\r\n\t\t\t\treturn !!value(data[name], name, data);\r\n\r\n\t\t\tcase 'Array':\r\n\t\t\t\tif (!isArray(data[name])) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar op = withinArray ? arrayContains : arraysEqual;\r\n\t\t\t\treturn op(data[name], value);\r\n\r\n\t\t\tcase 'RegExp':\r\n\t\t\t\tif (!isArray(data[name])) {\r\n\t\t\t\t\treturn Boolean(data[name] && data[name].match(value));\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!withinArray) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn arrayContains(data[name], value);\r\n\r\n\t\t\tcase 'Number':\r\n\t\t\t\tvalue = String(value);\r\n\t\t\t/* falls through */\r\n\t\t\tcase 'String':\r\n\t\t\t\tif (!isArray(data[name])) {\r\n\t\t\t\t\treturn data[name] === value;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!withinArray) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn arrayContains(data[name], value);\r\n\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new TypeError('URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter');\r\n\t\t}\r\n\t};\r\n\r\n\r\n\tURI.commonPath = function(one, two) {\r\n\t\tvar length = Math.min(one.length, two.length);\r\n\t\tvar pos;\r\n\r\n\t\t// find first non-matching character\r\n\t\tfor (pos = 0; pos < length; pos++) {\r\n\t\t\tif (one.charAt(pos) !== two.charAt(pos)) {\r\n\t\t\t\tpos--;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (pos < 1) {\r\n\t\t\treturn one.charAt(0) === two.charAt(0) && one.charAt(0) === '/' ? '/' : '';\r\n\t\t}\r\n\r\n\t\t// revert to last /\r\n\t\tif (one.charAt(pos) !== '/' || two.charAt(pos) !== '/') {\r\n\t\t\tpos = one.substring(0, pos).lastIndexOf('/');\r\n\t\t}\r\n\r\n\t\treturn one.substring(0, pos + 1);\r\n\t};\r\n\r\n\tURI.withinString = function(string, callback, options) {\r\n\t\toptions || (options = {});\r\n\t\tvar _start = options.start || URI.findUri.start;\r\n\t\tvar _end = options.end || URI.findUri.end;\r\n\t\tvar _trim = options.trim || URI.findUri.trim;\r\n\t\tvar _attributeOpen = /[a-z0-9-]=[\"']?$/i;\r\n\r\n\t\t_start.lastIndex = 0;\r\n\t\twhile (true) {\r\n\t\t\tvar match = _start.exec(string);\r\n\t\t\tif (!match) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\r\n\t\t\tvar start = match.index;\r\n\t\t\tif (options.ignoreHtml) {\r\n\t\t\t\t// attribut(e=[\"']?$)\r\n\t\t\t\tvar attributeOpen = string.slice(Math.max(start - 3, 0), start);\r\n\t\t\t\tif (attributeOpen && _attributeOpen.test(attributeOpen)) {\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tvar end = start + string.slice(start).search(_end);\r\n\t\t\tvar slice = string.slice(start, end).replace(_trim, '');\r\n\t\t\tif (options.ignore && options.ignore.test(slice)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tend = start + slice.length;\r\n\t\t\tvar result = callback(slice, start, end, string);\r\n\t\t\tstring = string.slice(0, start) + result + string.slice(end);\r\n\t\t\t_start.lastIndex = start + result.length;\r\n\t\t}\r\n\r\n\t\t_start.lastIndex = 0;\r\n\t\treturn string;\r\n\t};\r\n\r\n\tURI.ensureValidHostname = function(v) {\r\n\t\t// Theoretically URIs allow percent-encoding in Hostnames (according to RFC 3986)\r\n\t\t// they are not part of DNS and therefore ignored by URI.js\r\n\r\n\t\tif (v.match(URI.invalid_hostname_characters)) {\r\n\t\t\t// test punycode\r\n\t\t\tif (!punycode) {\r\n\t\t\t\tthrow new TypeError('Hostname \"' + v + '\" contains characters other than [A-Z0-9.-] and Punycode.js is not available');\r\n\t\t\t}\r\n\r\n\t\t\tif (punycode.toASCII(v).match(URI.invalid_hostname_characters)) {\r\n\t\t\t\tthrow new TypeError('Hostname \"' + v + '\" contains characters other than [A-Z0-9.-]');\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\t// noConflict\r\n\tURI.noConflict = function(removeAll) {\r\n\t\tif (removeAll) {\r\n\t\t\tvar unconflicted = {\r\n\t\t\t\tURI: this.noConflict()\r\n\t\t\t};\r\n\r\n\t\t\tif (root.URITemplate && typeof root.URITemplate.noConflict === 'function') {\r\n\t\t\t\tunconflicted.URITemplate = root.URITemplate.noConflict();\r\n\t\t\t}\r\n\r\n\t\t\tif (root.IPv6 && typeof root.IPv6.noConflict === 'function') {\r\n\t\t\t\tunconflicted.IPv6 = root.IPv6.noConflict();\r\n\t\t\t}\r\n\r\n\t\t\tif (root.SecondLevelDomains && typeof root.SecondLevelDomains.noConflict === 'function') {\r\n\t\t\t\tunconflicted.SecondLevelDomains = root.SecondLevelDomains.noConflict();\r\n\t\t\t}\r\n\r\n\t\t\treturn unconflicted;\r\n\t\t} else if (root.URI === this) {\r\n\t\t\troot.URI = _URI;\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\r\n\tp.build = function(deferBuild) {\r\n\t\tif (deferBuild === true) {\r\n\t\t\tthis._deferred_build = true;\r\n\t\t} else if (deferBuild === undefined || this._deferred_build) {\r\n\t\t\tthis._string = URI.build(this._parts);\r\n\t\t\tthis._deferred_build = false;\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\r\n\tp.clone = function() {\r\n\t\treturn new URI(this);\r\n\t};\r\n\r\n\tp.valueOf = p.toString = function() {\r\n\t\treturn this.build(false)._string;\r\n\t};\r\n\r\n\r\n\tfunction generateSimpleAccessor(_part){\r\n\t\treturn function(v, build) {\r\n\t\t\tif (v === undefined) {\r\n\t\t\t\treturn this._parts[_part] || '';\r\n\t\t\t} else {\r\n\t\t\t\tthis._parts[_part] = v || null;\r\n\t\t\t\tthis.build(!build);\r\n\t\t\t\treturn this;\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\tfunction generatePrefixAccessor(_part, _key){\r\n\t\treturn function(v, build) {\r\n\t\t\tif (v === undefined) {\r\n\t\t\t\treturn this._parts[_part] || '';\r\n\t\t\t} else {\r\n\t\t\t\tif (v !== null) {\r\n\t\t\t\t\tv = v + '';\r\n\t\t\t\t\tif (v.charAt(0) === _key) {\r\n\t\t\t\t\t\tv = v.substring(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._parts[_part] = v;\r\n\t\t\t\tthis.build(!build);\r\n\t\t\t\treturn this;\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\tp.protocol = generateSimpleAccessor('protocol');\r\n\tp.username = generateSimpleAccessor('username');\r\n\tp.password = generateSimpleAccessor('password');\r\n\tp.hostname = generateSimpleAccessor('hostname');\r\n\tp.port = generateSimpleAccessor('port');\r\n\tp.query = generatePrefixAccessor('query', '?');\r\n\tp.fragment = generatePrefixAccessor('fragment', '#');\r\n\r\n\tp.search = function(v, build) {\r\n\t\tvar t = this.query(v, build);\r\n\t\treturn typeof t === 'string' && t.length ? ('?' + t) : t;\r\n\t};\r\n\tp.hash = function(v, build) {\r\n\t\tvar t = this.fragment(v, build);\r\n\t\treturn typeof t === 'string' && t.length ? ('#' + t) : t;\r\n\t};\r\n\r\n\tp.pathname = function(v, build) {\r\n\t\tif (v === undefined || v === true) {\r\n\t\t\tvar res = this._parts.path || (this._parts.hostname ? '/' : '');\r\n\t\t\treturn v ? (this._parts.urn ? URI.decodeUrnPath : URI.decodePath)(res) : res;\r\n\t\t} else {\r\n\t\t\tif (this._parts.urn) {\r\n\t\t\t\tthis._parts.path = v ? URI.recodeUrnPath(v) : '';\r\n\t\t\t} else {\r\n\t\t\t\tthis._parts.path = v ? URI.recodePath(v) : '/';\r\n\t\t\t}\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.path = p.pathname;\r\n\tp.href = function(href, build) {\r\n\t\tvar key;\r\n\r\n\t\tif (href === undefined) {\r\n\t\t\treturn this.toString();\r\n\t\t}\r\n\r\n\t\tthis._string = '';\r\n\t\tthis._parts = URI._parts();\r\n\r\n\t\tvar _URI = href instanceof URI;\r\n\t\tvar _object = typeof href === 'object' && (href.hostname || href.path || href.pathname);\r\n\t\tif (href.nodeName) {\r\n\t\t\tvar attribute = URI.getDomAttribute(href);\r\n\t\t\thref = href[attribute] || '';\r\n\t\t\t_object = false;\r\n\t\t}\r\n\r\n\t\t// window.location is reported to be an object, but it's not the sort\r\n\t\t// of object we're looking for:\r\n\t\t// * location.protocol ends with a colon\r\n\t\t// * location.query != object.search\r\n\t\t// * location.hash != object.fragment\r\n\t\t// simply serializing the unknown object should do the trick\r\n\t\t// (for location, not for everything...)\r\n\t\tif (!_URI && _object && href.pathname !== undefined) {\r\n\t\t\thref = href.toString();\r\n\t\t}\r\n\r\n\t\tif (typeof href === 'string' || href instanceof String) {\r\n\t\t\tthis._parts = URI.parse(String(href), this._parts);\r\n\t\t} else if (_URI || _object) {\r\n\t\t\tvar src = _URI ? href._parts : href;\r\n\t\t\tfor (key in src) {\r\n\t\t\t\tif (hasOwn.call(this._parts, key)) {\r\n\t\t\t\t\tthis._parts[key] = src[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthrow new TypeError('invalid input');\r\n\t\t}\r\n\r\n\t\tthis.build(!build);\r\n\t\treturn this;\r\n\t};\r\n\r\n\t// identification accessors\r\n\tp.is = function(what) {\r\n\t\tvar ip = false;\r\n\t\tvar ip4 = false;\r\n\t\tvar ip6 = false;\r\n\t\tvar name = false;\r\n\t\tvar sld = false;\r\n\t\tvar idn = false;\r\n\t\tvar punycode = false;\r\n\t\tvar relative = !this._parts.urn;\r\n\r\n\t\tif (this._parts.hostname) {\r\n\t\t\trelative = false;\r\n\t\t\tip4 = URI.ip4_expression.test(this._parts.hostname);\r\n\t\t\tip6 = URI.ip6_expression.test(this._parts.hostname);\r\n\t\t\tip = ip4 || ip6;\r\n\t\t\tname = !ip;\r\n\t\t\tsld = name && SLD && SLD.has(this._parts.hostname);\r\n\t\t\tidn = name && URI.idn_expression.test(this._parts.hostname);\r\n\t\t\tpunycode = name && URI.punycode_expression.test(this._parts.hostname);\r\n\t\t}\r\n\r\n\t\tswitch (what.toLowerCase()) {\r\n\t\t\tcase 'relative':\r\n\t\t\t\treturn relative;\r\n\r\n\t\t\tcase 'absolute':\r\n\t\t\t\treturn !relative;\r\n\r\n\t\t\t// hostname identification\r\n\t\t\tcase 'domain':\r\n\t\t\tcase 'name':\r\n\t\t\t\treturn name;\r\n\r\n\t\t\tcase 'sld':\r\n\t\t\t\treturn sld;\r\n\r\n\t\t\tcase 'ip':\r\n\t\t\t\treturn ip;\r\n\r\n\t\t\tcase 'ip4':\r\n\t\t\tcase 'ipv4':\r\n\t\t\tcase 'inet4':\r\n\t\t\t\treturn ip4;\r\n\r\n\t\t\tcase 'ip6':\r\n\t\t\tcase 'ipv6':\r\n\t\t\tcase 'inet6':\r\n\t\t\t\treturn ip6;\r\n\r\n\t\t\tcase 'idn':\r\n\t\t\t\treturn idn;\r\n\r\n\t\t\tcase 'url':\r\n\t\t\t\treturn !this._parts.urn;\r\n\r\n\t\t\tcase 'urn':\r\n\t\t\t\treturn !!this._parts.urn;\r\n\r\n\t\t\tcase 'punycode':\r\n\t\t\t\treturn punycode;\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t};\r\n\r\n\t// component specific input validation\r\n\tvar _protocol = p.protocol;\r\n\tvar _port = p.port;\r\n\tvar _hostname = p.hostname;\r\n\r\n\tp.protocol = function(v, build) {\r\n\t\tif (v !== undefined) {\r\n\t\t\tif (v) {\r\n\t\t\t\t// accept trailing ://\r\n\t\t\t\tv = v.replace(/:(\\/\\/)?$/, '');\r\n\r\n\t\t\t\tif (!v.match(URI.protocol_expression)) {\r\n\t\t\t\t\tthrow new TypeError('Protocol \"' + v + '\" contains characters other than [A-Z0-9.+-] or doesn\\'t start with [A-Z]');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn _protocol.call(this, v, build);\r\n\t};\r\n\tp.scheme = p.protocol;\r\n\tp.port = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v !== undefined) {\r\n\t\t\tif (v === 0) {\r\n\t\t\t\tv = null;\r\n\t\t\t}\r\n\r\n\t\t\tif (v) {\r\n\t\t\t\tv += '';\r\n\t\t\t\tif (v.charAt(0) === ':') {\r\n\t\t\t\t\tv = v.substring(1);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (v.match(/[^0-9]/)) {\r\n\t\t\t\t\tthrow new TypeError('Port \"' + v + '\" contains characters other than [0-9]');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn _port.call(this, v, build);\r\n\t};\r\n\tp.hostname = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v !== undefined) {\r\n\t\t\tvar x = {};\r\n\t\t\tvar res = URI.parseHost(v, x);\r\n\t\t\tif (res !== '/') {\r\n\t\t\t\tthrow new TypeError('Hostname \"' + v + '\" contains characters other than [A-Z0-9.-]');\r\n\t\t\t}\r\n\r\n\t\t\tv = x.hostname;\r\n\t\t}\r\n\t\treturn _hostname.call(this, v, build);\r\n\t};\r\n\r\n\t// compound accessors\r\n\tp.origin = function(v, build) {\r\n\t\tvar parts;\r\n\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\tvar protocol = this.protocol();\r\n\t\t\tvar authority = this.authority();\r\n\t\t\tif (!authority) return '';\r\n\t\t\treturn (protocol ? protocol + '://' : '') + this.authority();\r\n\t\t} else {\r\n\t\t\tvar origin = URI(v);\r\n\t\t\tthis\r\n\t\t\t\t.protocol(origin.protocol())\r\n\t\t\t\t.authority(origin.authority())\r\n\t\t\t\t.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.host = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\treturn this._parts.hostname ? URI.buildHost(this._parts) : '';\r\n\t\t} else {\r\n\t\t\tvar res = URI.parseHost(v, this._parts);\r\n\t\t\tif (res !== '/') {\r\n\t\t\t\tthrow new TypeError('Hostname \"' + v + '\" contains characters other than [A-Z0-9.-]');\r\n\t\t\t}\r\n\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.authority = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\treturn this._parts.hostname ? URI.buildAuthority(this._parts) : '';\r\n\t\t} else {\r\n\t\t\tvar res = URI.parseAuthority(v, this._parts);\r\n\t\t\tif (res !== '/') {\r\n\t\t\t\tthrow new TypeError('Hostname \"' + v + '\" contains characters other than [A-Z0-9.-]');\r\n\t\t\t}\r\n\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.userinfo = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\tif (!this._parts.username) {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\tvar t = URI.buildUserinfo(this._parts);\r\n\t\t\treturn t.substring(0, t.length -1);\r\n\t\t} else {\r\n\t\t\tif (v[v.length-1] !== '@') {\r\n\t\t\t\tv += '@';\r\n\t\t\t}\r\n\r\n\t\t\tURI.parseUserinfo(v, this._parts);\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.resource = function(v, build) {\r\n\t\tvar parts;\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\treturn this.path() + this.search() + this.hash();\r\n\t\t}\r\n\r\n\t\tparts = URI.parse(v);\r\n\t\tthis._parts.path = parts.path;\r\n\t\tthis._parts.query = parts.query;\r\n\t\tthis._parts.fragment = parts.fragment;\r\n\t\tthis.build(!build);\r\n\t\treturn this;\r\n\t};\r\n\r\n\t// fraction accessors\r\n\tp.subdomain = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\t// convenience, return \"www\" from \"www.example.org\"\r\n\t\tif (v === undefined) {\r\n\t\t\tif (!this._parts.hostname || this.is('IP')) {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\t// grab domain and add another segment\r\n\t\t\tvar end = this._parts.hostname.length - this.domain().length - 1;\r\n\t\t\treturn this._parts.hostname.substring(0, end) || '';\r\n\t\t} else {\r\n\t\t\tvar e = this._parts.hostname.length - this.domain().length;\r\n\t\t\tvar sub = this._parts.hostname.substring(0, e);\r\n\t\t\tvar replace = new RegExp('^' + escapeRegEx(sub));\r\n\r\n\t\t\tif (v && v.charAt(v.length - 1) !== '.') {\r\n\t\t\t\tv += '.';\r\n\t\t\t}\r\n\r\n\t\t\tif (v) {\r\n\t\t\t\tURI.ensureValidHostname(v);\r\n\t\t\t}\r\n\r\n\t\t\tthis._parts.hostname = this._parts.hostname.replace(replace, v);\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.domain = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (typeof v === 'boolean') {\r\n\t\t\tbuild = v;\r\n\t\t\tv = undefined;\r\n\t\t}\r\n\r\n\t\t// convenience, return \"example.org\" from \"www.example.org\"\r\n\t\tif (v === undefined) {\r\n\t\t\tif (!this._parts.hostname || this.is('IP')) {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\t// if hostname consists of 1 or 2 segments, it must be the domain\r\n\t\t\tvar t = this._parts.hostname.match(/\\./g);\r\n\t\t\tif (t && t.length < 2) {\r\n\t\t\t\treturn this._parts.hostname;\r\n\t\t\t}\r\n\r\n\t\t\t// grab tld and add another segment\r\n\t\t\tvar end = this._parts.hostname.length - this.tld(build).length - 1;\r\n\t\t\tend = this._parts.hostname.lastIndexOf('.', end -1) + 1;\r\n\t\t\treturn this._parts.hostname.substring(end) || '';\r\n\t\t} else {\r\n\t\t\tif (!v) {\r\n\t\t\t\tthrow new TypeError('cannot set domain empty');\r\n\t\t\t}\r\n\r\n\t\t\tURI.ensureValidHostname(v);\r\n\r\n\t\t\tif (!this._parts.hostname || this.is('IP')) {\r\n\t\t\t\tthis._parts.hostname = v;\r\n\t\t\t} else {\r\n\t\t\t\tvar replace = new RegExp(escapeRegEx(this.domain()) + '$');\r\n\t\t\t\tthis._parts.hostname = this._parts.hostname.replace(replace, v);\r\n\t\t\t}\r\n\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.tld = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (typeof v === 'boolean') {\r\n\t\t\tbuild = v;\r\n\t\t\tv = undefined;\r\n\t\t}\r\n\r\n\t\t// return \"org\" from \"www.example.org\"\r\n\t\tif (v === undefined) {\r\n\t\t\tif (!this._parts.hostname || this.is('IP')) {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\tvar pos = this._parts.hostname.lastIndexOf('.');\r\n\t\t\tvar tld = this._parts.hostname.substring(pos + 1);\r\n\r\n\t\t\tif (build !== true && SLD && SLD.list[tld.toLowerCase()]) {\r\n\t\t\t\treturn SLD.get(this._parts.hostname) || tld;\r\n\t\t\t}\r\n\r\n\t\t\treturn tld;\r\n\t\t} else {\r\n\t\t\tvar replace;\r\n\r\n\t\t\tif (!v) {\r\n\t\t\t\tthrow new TypeError('cannot set TLD empty');\r\n\t\t\t} else if (v.match(/[^a-zA-Z0-9-]/)) {\r\n\t\t\t\tif (SLD && SLD.is(v)) {\r\n\t\t\t\t\treplace = new RegExp(escapeRegEx(this.tld()) + '$');\r\n\t\t\t\t\tthis._parts.hostname = this._parts.hostname.replace(replace, v);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new TypeError('TLD \"' + v + '\" contains characters other than [A-Z0-9]');\r\n\t\t\t\t}\r\n\t\t\t} else if (!this._parts.hostname || this.is('IP')) {\r\n\t\t\t\tthrow new ReferenceError('cannot set TLD on non-domain host');\r\n\t\t\t} else {\r\n\t\t\t\treplace = new RegExp(escapeRegEx(this.tld()) + '$');\r\n\t\t\t\tthis._parts.hostname = this._parts.hostname.replace(replace, v);\r\n\t\t\t}\r\n\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.directory = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined || v === true) {\r\n\t\t\tif (!this._parts.path && !this._parts.hostname) {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\tif (this._parts.path === '/') {\r\n\t\t\t\treturn '/';\r\n\t\t\t}\r\n\r\n\t\t\tvar end = this._parts.path.length - this.filename().length - 1;\r\n\t\t\tvar res = this._parts.path.substring(0, end) || (this._parts.hostname ? '/' : '');\r\n\r\n\t\t\treturn v ? URI.decodePath(res) : res;\r\n\r\n\t\t} else {\r\n\t\t\tvar e = this._parts.path.length - this.filename().length;\r\n\t\t\tvar directory = this._parts.path.substring(0, e);\r\n\t\t\tvar replace = new RegExp('^' + escapeRegEx(directory));\r\n\r\n\t\t\t// fully qualifier directories begin with a slash\r\n\t\t\tif (!this.is('relative')) {\r\n\t\t\t\tif (!v) {\r\n\t\t\t\t\tv = '/';\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (v.charAt(0) !== '/') {\r\n\t\t\t\t\tv = '/' + v;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// directories always end with a slash\r\n\t\t\tif (v && v.charAt(v.length - 1) !== '/') {\r\n\t\t\t\tv += '/';\r\n\t\t\t}\r\n\r\n\t\t\tv = URI.recodePath(v);\r\n\t\t\tthis._parts.path = this._parts.path.replace(replace, v);\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.filename = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined || v === true) {\r\n\t\t\tif (!this._parts.path || this._parts.path === '/') {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\tvar pos = this._parts.path.lastIndexOf('/');\r\n\t\t\tvar res = this._parts.path.substring(pos+1);\r\n\r\n\t\t\treturn v ? URI.decodePathSegment(res) : res;\r\n\t\t} else {\r\n\t\t\tvar mutatedDirectory = false;\r\n\r\n\t\t\tif (v.charAt(0) === '/') {\r\n\t\t\t\tv = v.substring(1);\r\n\t\t\t}\r\n\r\n\t\t\tif (v.match(/\\.?\\//)) {\r\n\t\t\t\tmutatedDirectory = true;\r\n\t\t\t}\r\n\r\n\t\t\tvar replace = new RegExp(escapeRegEx(this.filename()) + '$');\r\n\t\t\tv = URI.recodePath(v);\r\n\t\t\tthis._parts.path = this._parts.path.replace(replace, v);\r\n\r\n\t\t\tif (mutatedDirectory) {\r\n\t\t\t\tthis.normalizePath(build);\r\n\t\t\t} else {\r\n\t\t\t\tthis.build(!build);\r\n\t\t\t}\r\n\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.suffix = function(v, build) {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn v === undefined ? '' : this;\r\n\t\t}\r\n\r\n\t\tif (v === undefined || v === true) {\r\n\t\t\tif (!this._parts.path || this._parts.path === '/') {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\tvar filename = this.filename();\r\n\t\t\tvar pos = filename.lastIndexOf('.');\r\n\t\t\tvar s, res;\r\n\r\n\t\t\tif (pos === -1) {\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\t// suffix may only contain alnum characters (yup, I made this up.)\r\n\t\t\ts = filename.substring(pos+1);\r\n\t\t\tres = (/^[a-z0-9%]+$/i).test(s) ? s : '';\r\n\t\t\treturn v ? URI.decodePathSegment(res) : res;\r\n\t\t} else {\r\n\t\t\tif (v.charAt(0) === '.') {\r\n\t\t\t\tv = v.substring(1);\r\n\t\t\t}\r\n\r\n\t\t\tvar suffix = this.suffix();\r\n\t\t\tvar replace;\r\n\r\n\t\t\tif (!suffix) {\r\n\t\t\t\tif (!v) {\r\n\t\t\t\t\treturn this;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis._parts.path += '.' + URI.recodePath(v);\r\n\t\t\t} else if (!v) {\r\n\t\t\t\treplace = new RegExp(escapeRegEx('.' + suffix) + '$');\r\n\t\t\t} else {\r\n\t\t\t\treplace = new RegExp(escapeRegEx(suffix) + '$');\r\n\t\t\t}\r\n\r\n\t\t\tif (replace) {\r\n\t\t\t\tv = URI.recodePath(v);\r\n\t\t\t\tthis._parts.path = this._parts.path.replace(replace, v);\r\n\t\t\t}\r\n\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\t};\r\n\tp.segment = function(segment, v, build) {\r\n\t\tvar separator = this._parts.urn ? ':' : '/';\r\n\t\tvar path = this.path();\r\n\t\tvar absolute = path.substring(0, 1) === '/';\r\n\t\tvar segments = path.split(separator);\r\n\r\n\t\tif (segment !== undefined && typeof segment !== 'number') {\r\n\t\t\tbuild = v;\r\n\t\t\tv = segment;\r\n\t\t\tsegment = undefined;\r\n\t\t}\r\n\r\n\t\tif (segment !== undefined && typeof segment !== 'number') {\r\n\t\t\tthrow new Error('Bad segment \"' + segment + '\", must be 0-based integer');\r\n\t\t}\r\n\r\n\t\tif (absolute) {\r\n\t\t\tsegments.shift();\r\n\t\t}\r\n\r\n\t\tif (segment < 0) {\r\n\t\t\t// allow negative indexes to address from the end\r\n\t\t\tsegment = Math.max(segments.length + segment, 0);\r\n\t\t}\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\t/*jshint laxbreak: true */\r\n\t\t\treturn segment === undefined\r\n\t\t\t\t? segments\r\n\t\t\t\t: segments[segment];\r\n\t\t\t/*jshint laxbreak: false */\r\n\t\t} else if (segment === null || segments[segment] === undefined) {\r\n\t\t\tif (isArray(v)) {\r\n\t\t\t\tsegments = [];\r\n\t\t\t\t// collapse empty elements within array\r\n\t\t\t\tfor (var i=0, l=v.length; i < l; i++) {\r\n\t\t\t\t\tif (!v[i].length && (!segments.length || !segments[segments.length -1].length)) {\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (segments.length && !segments[segments.length -1].length) {\r\n\t\t\t\t\t\tsegments.pop();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tsegments.push(trimSlashes(v[i]));\r\n\t\t\t\t}\r\n\t\t\t} else if (v || typeof v === 'string') {\r\n\t\t\t\tv = trimSlashes(v);\r\n\t\t\t\tif (segments[segments.length -1] === '') {\r\n\t\t\t\t\t// empty trailing elements have to be overwritten\r\n\t\t\t\t\t// to prevent results such as /foo//bar\r\n\t\t\t\t\tsegments[segments.length -1] = v;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsegments.push(v);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (v) {\r\n\t\t\t\tsegments[segment] = trimSlashes(v);\r\n\t\t\t} else {\r\n\t\t\t\tsegments.splice(segment, 1);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (absolute) {\r\n\t\t\tsegments.unshift('');\r\n\t\t}\r\n\r\n\t\treturn this.path(segments.join(separator), build);\r\n\t};\r\n\tp.segmentCoded = function(segment, v, build) {\r\n\t\tvar segments, i, l;\r\n\r\n\t\tif (typeof segment !== 'number') {\r\n\t\t\tbuild = v;\r\n\t\t\tv = segment;\r\n\t\t\tsegment = undefined;\r\n\t\t}\r\n\r\n\t\tif (v === undefined) {\r\n\t\t\tsegments = this.segment(segment, v, build);\r\n\t\t\tif (!isArray(segments)) {\r\n\t\t\t\tsegments = segments !== undefined ? URI.decode(segments) : undefined;\r\n\t\t\t} else {\r\n\t\t\t\tfor (i = 0, l = segments.length; i < l; i++) {\r\n\t\t\t\t\tsegments[i] = URI.decode(segments[i]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn segments;\r\n\t\t}\r\n\r\n\t\tif (!isArray(v)) {\r\n\t\t\tv = (typeof v === 'string' || v instanceof String) ? URI.encode(v) : v;\r\n\t\t} else {\r\n\t\t\tfor (i = 0, l = v.length; i < l; i++) {\r\n\t\t\t\tv[i] = URI.encode(v[i]);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn this.segment(segment, v, build);\r\n\t};\r\n\r\n\t// mutating query string\r\n\tvar q = p.query;\r\n\tp.query = function(v, build) {\r\n\t\tif (v === true) {\r\n\t\t\treturn URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace);\r\n\t\t} else if (typeof v === 'function') {\r\n\t\t\tvar data = URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace);\r\n\t\t\tvar result = v.call(this, data);\r\n\t\t\tthis._parts.query = URI.buildQuery(result || data, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace);\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t} else if (v !== undefined && typeof v !== 'string') {\r\n\t\t\tthis._parts.query = URI.buildQuery(v, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace);\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t} else {\r\n\t\t\treturn q.call(this, v, build);\r\n\t\t}\r\n\t};\r\n\tp.setQuery = function(name, value, build) {\r\n\t\tvar data = URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace);\r\n\r\n\t\tif (typeof name === 'string' || name instanceof String) {\r\n\t\t\tdata[name] = value !== undefined ? value : null;\r\n\t\t} else if (typeof name === 'object') {\r\n\t\t\tfor (var key in name) {\r\n\t\t\t\tif (hasOwn.call(name, key)) {\r\n\t\t\t\t\tdata[key] = name[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthrow new TypeError('URI.addQuery() accepts an object, string as the name parameter');\r\n\t\t}\r\n\r\n\t\tthis._parts.query = URI.buildQuery(data, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace);\r\n\t\tif (typeof name !== 'string') {\r\n\t\t\tbuild = value;\r\n\t\t}\r\n\r\n\t\tthis.build(!build);\r\n\t\treturn this;\r\n\t};\r\n\tp.addQuery = function(name, value, build) {\r\n\t\tvar data = URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace);\r\n\t\tURI.addQuery(data, name, value === undefined ? null : value);\r\n\t\tthis._parts.query = URI.buildQuery(data, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace);\r\n\t\tif (typeof name !== 'string') {\r\n\t\t\tbuild = value;\r\n\t\t}\r\n\r\n\t\tthis.build(!build);\r\n\t\treturn this;\r\n\t};\r\n\tp.removeQuery = function(name, value, build) {\r\n\t\tvar data = URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace);\r\n\t\tURI.removeQuery(data, name, value);\r\n\t\tthis._parts.query = URI.buildQuery(data, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace);\r\n\t\tif (typeof name !== 'string') {\r\n\t\t\tbuild = value;\r\n\t\t}\r\n\r\n\t\tthis.build(!build);\r\n\t\treturn this;\r\n\t};\r\n\tp.hasQuery = function(name, value, withinArray) {\r\n\t\tvar data = URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace);\r\n\t\treturn URI.hasQuery(data, name, value, withinArray);\r\n\t};\r\n\tp.setSearch = p.setQuery;\r\n\tp.addSearch = p.addQuery;\r\n\tp.removeSearch = p.removeQuery;\r\n\tp.hasSearch = p.hasQuery;\r\n\r\n\t// sanitizing URLs\r\n\tp.normalize = function() {\r\n\t\tif (this._parts.urn) {\r\n\t\t\treturn this\r\n\t\t\t\t.normalizeProtocol(false)\r\n\t\t\t\t.normalizePath(false)\r\n\t\t\t\t.normalizeQuery(false)\r\n\t\t\t\t.normalizeFragment(false)\r\n\t\t\t\t.build();\r\n\t\t}\r\n\r\n\t\treturn this\r\n\t\t\t.normalizeProtocol(false)\r\n\t\t\t.normalizeHostname(false)\r\n\t\t\t.normalizePort(false)\r\n\t\t\t.normalizePath(false)\r\n\t\t\t.normalizeQuery(false)\r\n\t\t\t.normalizeFragment(false)\r\n\t\t\t.build();\r\n\t};\r\n\tp.normalizeProtocol = function(build) {\r\n\t\tif (typeof this._parts.protocol === 'string') {\r\n\t\t\tthis._parts.protocol = this._parts.protocol.toLowerCase();\r\n\t\t\tthis.build(!build);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\tp.normalizeHostname = function(build) {\r\n\t\tif (this._parts.hostname) {\r\n\t\t\tif (this.is('IDN') && punycode) {\r\n\t\t\t\tthis._parts.hostname = punycode.toASCII(this._parts.hostname);\r\n\t\t\t} else if (this.is('IPv6') && IPv6) {\r\n\t\t\t\tthis._parts.hostname = IPv6.best(this._parts.hostname);\r\n\t\t\t}\r\n\r\n\t\t\tthis._parts.hostname = this._parts.hostname.toLowerCase();\r\n\t\t\tthis.build(!build);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\tp.normalizePort = function(build) {\r\n\t\t// remove port of it's the protocol's default\r\n\t\tif (typeof this._parts.protocol === 'string' && this._parts.port === URI.defaultPorts[this._parts.protocol]) {\r\n\t\t\tthis._parts.port = null;\r\n\t\t\tthis.build(!build);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\tp.normalizePath = function(build) {\r\n\t\tvar _path = this._parts.path;\r\n\t\tif (!_path) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif (this._parts.urn) {\r\n\t\t\tthis._parts.path = URI.recodeUrnPath(this._parts.path);\r\n\t\t\tthis.build(!build);\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tif (this._parts.path === '/') {\r\n\t\t\treturn this;\r\n\t\t}\r\n\r\n\t\tvar _was_relative;\r\n\t\tvar _leadingParents = '';\r\n\t\tvar _parent, _pos;\r\n\r\n\t\t// handle relative paths\r\n\t\tif (_path.charAt(0) !== '/') {\r\n\t\t\t_was_relative = true;\r\n\t\t\t_path = '/' + _path;\r\n\t\t}\r\n\r\n\t\t// handle relative files (as opposed to directories)\r\n\t\tif (_path.slice(-3) === '/..' || _path.slice(-2) === '/.') {\r\n\t\t\t_path += '/';\r\n\t\t}\r\n\r\n\t\t// resolve simples\r\n\t\t_path = _path\r\n\t\t\t.replace(/(\\/(\\.\\/)+)|(\\/\\.$)/g, '/')\r\n\t\t\t.replace(/\\/{2,}/g, '/');\r\n\r\n\t\t// remember leading parents\r\n\t\tif (_was_relative) {\r\n\t\t\t_leadingParents = _path.substring(1).match(/^(\\.\\.\\/)+/) || '';\r\n\t\t\tif (_leadingParents) {\r\n\t\t\t\t_leadingParents = _leadingParents[0];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// resolve parents\r\n\t\twhile (true) {\r\n\t\t\t_parent = _path.indexOf('/..');\r\n\t\t\tif (_parent === -1) {\r\n\t\t\t\t// no more ../ to resolve\r\n\t\t\t\tbreak;\r\n\t\t\t} else if (_parent === 0) {\r\n\t\t\t\t// top level cannot be relative, skip it\r\n\t\t\t\t_path = _path.substring(3);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t_pos = _path.substring(0, _parent).lastIndexOf('/');\r\n\t\t\tif (_pos === -1) {\r\n\t\t\t\t_pos = _parent;\r\n\t\t\t}\r\n\t\t\t_path = _path.substring(0, _pos) + _path.substring(_parent + 3);\r\n\t\t}\r\n\r\n\t\t// revert to relative\r\n\t\tif (_was_relative && this.is('relative')) {\r\n\t\t\t_path = _leadingParents + _path.substring(1);\r\n\t\t}\r\n\r\n\t\t_path = URI.recodePath(_path);\r\n\t\tthis._parts.path = _path;\r\n\t\tthis.build(!build);\r\n\t\treturn this;\r\n\t};\r\n\tp.normalizePathname = p.normalizePath;\r\n\tp.normalizeQuery = function(build) {\r\n\t\tif (typeof this._parts.query === 'string') {\r\n\t\t\tif (!this._parts.query.length) {\r\n\t\t\t\tthis._parts.query = null;\r\n\t\t\t} else {\r\n\t\t\t\tthis.query(URI.parseQuery(this._parts.query, this._parts.escapeQuerySpace));\r\n\t\t\t}\r\n\r\n\t\t\tthis.build(!build);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\tp.normalizeFragment = function(build) {\r\n\t\tif (!this._parts.fragment) {\r\n\t\t\tthis._parts.fragment = null;\r\n\t\t\tthis.build(!build);\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t};\r\n\tp.normalizeSearch = p.normalizeQuery;\r\n\tp.normalizeHash = p.normalizeFragment;\r\n\r\n\tp.iso8859 = function() {\r\n\t\t// expect unicode input, iso8859 output\r\n\t\tvar e = URI.encode;\r\n\t\tvar d = URI.decode;\r\n\r\n\t\tURI.encode = escape;\r\n\t\tURI.decode = decodeURIComponent;\r\n\t\ttry {\r\n\t\t\tthis.normalize();\r\n\t\t} finally {\r\n\t\t\tURI.encode = e;\r\n\t\t\tURI.decode = d;\r\n\t\t}\r\n\t\treturn this;\r\n\t};\r\n\r\n\tp.unicode = function() {\r\n\t\t// expect iso8859 input, unicode output\r\n\t\tvar e = URI.encode;\r\n\t\tvar d = URI.decode;\r\n\r\n\t\tURI.encode = strictEncodeURIComponent;\r\n\t\tURI.decode = unescape;\r\n\t\ttry {\r\n\t\t\tthis.normalize();\r\n\t\t} finally {\r\n\t\t\tURI.encode = e;\r\n\t\t\tURI.decode = d;\r\n\t\t}\r\n\t\treturn this;\r\n\t};\r\n\r\n\tp.readable = function() {\r\n\t\tvar uri = this.clone();\r\n\t\t// removing username, password, because they shouldn't be displayed according to RFC 3986\r\n\t\turi.username('').password('').normalize();\r\n\t\tvar t = '';\r\n\t\tif (uri._parts.protocol) {\r\n\t\t\tt += uri._parts.protocol + '://';\r\n\t\t}\r\n\r\n\t\tif (uri._parts.hostname) {\r\n\t\t\tif (uri.is('punycode') && punycode) {\r\n\t\t\t\tt += punycode.toUnicode(uri._parts.hostname);\r\n\t\t\t\tif (uri._parts.port) {\r\n\t\t\t\t\tt += ':' + uri._parts.port;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tt += uri.host();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (uri._parts.hostname && uri._parts.path && uri._parts.path.charAt(0) !== '/') {\r\n\t\t\tt += '/';\r\n\t\t}\r\n\r\n\t\tt += uri.path(true);\r\n\t\tif (uri._parts.query) {\r\n\t\t\tvar q = '';\r\n\t\t\tfor (var i = 0, qp = uri._parts.query.split('&'), l = qp.length; i < l; i++) {\r\n\t\t\t\tvar kv = (qp[i] || '').split('=');\r\n\t\t\t\tq += '&' + URI.decodeQuery(kv[0], this._parts.escapeQuerySpace)\r\n\t\t\t\t\t.replace(/&/g, '%26');\r\n\r\n\t\t\t\tif (kv[1] !== undefined) {\r\n\t\t\t\t\tq += '=' + URI.decodeQuery(kv[1], this._parts.escapeQuerySpace)\r\n\t\t\t\t\t\t.replace(/&/g, '%26');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tt += '?' + q.substring(1);\r\n\t\t}\r\n\r\n\t\tt += URI.decodeQuery(uri.hash(), true);\r\n\t\treturn t;\r\n\t};\r\n\r\n\t// resolving relative and absolute URLs\r\n\tp.absoluteTo = function(base) {\r\n\t\tvar resolved = this.clone();\r\n\t\tvar properties = ['protocol', 'username', 'password', 'hostname', 'port'];\r\n\t\tvar basedir, i, p;\r\n\r\n\t\tif (this._parts.urn) {\r\n\t\t\tthrow new Error('URNs do not have any generally defined hierarchical components');\r\n\t\t}\r\n\r\n\t\tif (!(base instanceof URI)) {\r\n\t\t\tbase = new URI(base);\r\n\t\t}\r\n\r\n\t\tif (!resolved._parts.protocol) {\r\n\t\t\tresolved._parts.protocol = base._parts.protocol;\r\n\t\t}\r\n\r\n\t\tif (this._parts.hostname) {\r\n\t\t\treturn resolved;\r\n\t\t}\r\n\r\n\t\tfor (i = 0; (p = properties[i]); i++) {\r\n\t\t\tresolved._parts[p] = base._parts[p];\r\n\t\t}\r\n\r\n\t\tif (!resolved._parts.path) {\r\n\t\t\tresolved._parts.path = base._parts.path;\r\n\t\t\tif (!resolved._parts.query) {\r\n\t\t\t\tresolved._parts.query = base._parts.query;\r\n\t\t\t}\r\n\t\t} else if (resolved._parts.path.substring(-2) === '..') {\r\n\t\t\tresolved._parts.path += '/';\r\n\t\t}\r\n\r\n\t\tif (resolved.path().charAt(0) !== '/') {\r\n\t\t\tbasedir = base.directory();\r\n\t\t\tbasedir = basedir ? basedir : base.path().indexOf('/') === 0 ? '/' : '';\r\n\t\t\tresolved._parts.path = (basedir ? (basedir + '/') : '') + resolved._parts.path;\r\n\t\t\tresolved.normalizePath();\r\n\t\t}\r\n\r\n\t\tresolved.build();\r\n\t\treturn resolved;\r\n\t};\r\n\tp.relativeTo = function(base) {\r\n\t\tvar relative = this.clone().normalize();\r\n\t\tvar relativeParts, baseParts, common, relativePath, basePath;\r\n\r\n\t\tif (relative._parts.urn) {\r\n\t\t\tthrow new Error('URNs do not have any generally defined hierarchical components');\r\n\t\t}\r\n\r\n\t\tbase = new URI(base).normalize();\r\n\t\trelativeParts = relative._parts;\r\n\t\tbaseParts = base._parts;\r\n\t\trelativePath = relative.path();\r\n\t\tbasePath = base.path();\r\n\r\n\t\tif (relativePath.charAt(0) !== '/') {\r\n\t\t\tthrow new Error('URI is already relative');\r\n\t\t}\r\n\r\n\t\tif (basePath.charAt(0) !== '/') {\r\n\t\t\tthrow new Error('Cannot calculate a URI relative to another relative URI');\r\n\t\t}\r\n\r\n\t\tif (relativeParts.protocol === baseParts.protocol) {\r\n\t\t\trelativeParts.protocol = null;\r\n\t\t}\r\n\r\n\t\tif (relativeParts.username !== baseParts.username || relativeParts.password !== baseParts.password) {\r\n\t\t\treturn relative.build();\r\n\t\t}\r\n\r\n\t\tif (relativeParts.protocol !== null || relativeParts.username !== null || relativeParts.password !== null) {\r\n\t\t\treturn relative.build();\r\n\t\t}\r\n\r\n\t\tif (relativeParts.hostname === baseParts.hostname && relativeParts.port === baseParts.port) {\r\n\t\t\trelativeParts.hostname = null;\r\n\t\t\trelativeParts.port = null;\r\n\t\t} else {\r\n\t\t\treturn relative.build();\r\n\t\t}\r\n\r\n\t\tif (relativePath === basePath) {\r\n\t\t\trelativeParts.path = '';\r\n\t\t\treturn relative.build();\r\n\t\t}\r\n\r\n\t\t// determine common sub path\r\n\t\tcommon = URI.commonPath(relativePath, basePath);\r\n\r\n\t\t// If the paths have nothing in common, return a relative URL with the absolute path.\r\n\t\tif (!common) {\r\n\t\t\treturn relative.build();\r\n\t\t}\r\n\r\n\t\tvar parents = baseParts.path\r\n\t\t\t.substring(common.length)\r\n\t\t\t.replace(/[^\\/]*$/, '')\r\n\t\t\t.replace(/.*?\\//g, '../');\r\n\r\n\t\trelativeParts.path = (parents + relativeParts.path.substring(common.length)) || './';\r\n\r\n\t\treturn relative.build();\r\n\t};\r\n\r\n\t// comparing URIs\r\n\tp.equals = function(uri) {\r\n\t\tvar one = this.clone();\r\n\t\tvar two = new URI(uri);\r\n\t\tvar one_map = {};\r\n\t\tvar two_map = {};\r\n\t\tvar checked = {};\r\n\t\tvar one_query, two_query, key;\r\n\r\n\t\tone.normalize();\r\n\t\ttwo.normalize();\r\n\r\n\t\t// exact match\r\n\t\tif (one.toString() === two.toString()) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\t// extract query string\r\n\t\tone_query = one.query();\r\n\t\ttwo_query = two.query();\r\n\t\tone.query('');\r\n\t\ttwo.query('');\r\n\r\n\t\t// definitely not equal if not even non-query parts match\r\n\t\tif (one.toString() !== two.toString()) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// query parameters have the same length, even if they're permuted\r\n\t\tif (one_query.length !== two_query.length) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tone_map = URI.parseQuery(one_query, this._parts.escapeQuerySpace);\r\n\t\ttwo_map = URI.parseQuery(two_query, this._parts.escapeQuerySpace);\r\n\r\n\t\tfor (key in one_map) {\r\n\t\t\tif (hasOwn.call(one_map, key)) {\r\n\t\t\t\tif (!isArray(one_map[key])) {\r\n\t\t\t\t\tif (one_map[key] !== two_map[key]) {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (!arraysEqual(one_map[key], two_map[key])) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tchecked[key] = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (key in two_map) {\r\n\t\t\tif (hasOwn.call(two_map, key)) {\r\n\t\t\t\tif (!checked[key]) {\r\n\t\t\t\t\t// two contains a parameter not present in one\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t};\r\n\r\n\t// state\r\n\tp.duplicateQueryParameters = function(v) {\r\n\t\tthis._parts.duplicateQueryParameters = !!v;\r\n\t\treturn this;\r\n\t};\r\n\r\n\tp.escapeQuerySpace = function(v) {\r\n\t\tthis._parts.escapeQuerySpace = !!v;\r\n\t\treturn this;\r\n\t};\r\n\r\n\treturn URI;\r\n}));","Workflow = {}\r\n\r\n@ImageSign = {};\r\n\r\n@TracesHandler = {};\r\n\r\n@TracesTemplate = {};\r\n\r\n@InstanceformTemplate = {};\r\n\r\n@InstanceAttachmentTemplate = {};\r\n\r\n@InstanceSignText = {}\r\n\r\n@RelatedInstances = {}\r\n\r\n@RelatedRecords = {}\r\n\r\n@InstanceMacro = {context: {}}\r\n\r\n@TracesManager = {};\r\n\r\nInstanceSignText.isOpinionField_from_string = (field_formula)->\r\n\treturn (field_formula?.indexOf(\"{traces.\") > -1 || field_formula?.indexOf(\"{signature.traces.\") > -1 || field_formula?.indexOf(\"{yijianlan:\") > -1 || field_formula?.indexOf(\"{\\\"yijianlan\\\":\") > -1 || field_formula?.indexOf(\"{'yijianlan':\") > -1)\r\n\r\nInstanceSignText.includesOpinionField = (form, form_version)->\r\n\tfield_formulas = new Array();\r\n\r\n\t_form_version = {}\r\n\r\n\tif Meteor.isServer\r\n\t\t_form_version = uuflowManager.getFormVersion(db.forms.findOne({_id: form}), form_version)\r\n\telse\r\n\t\t_form_version = db.form_versions.findOne({_id: form_version, form: form})\r\n\r\n\tfields = _form_version?.fields || []\r\n\r\n\tfields.forEach (f)->\r\n\t\tif f.type == 'table'\r\n\t\t\tconsole.log 'ignore opinion field in table'\r\n\t\telse if f.type == 'section'\r\n\t\t\tf?.fields?.forEach (f1)->\r\n\t\t\t\tfield_formulas.push f1.formula\r\n\t\telse\r\n\t\t\tfield_formulas.push f.formula\r\n\r\n\t_.some field_formulas, (field_formula)->\r\n\t\treturn InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)\r\n\r\n","             \n\nWorkflow = {};\n\nthis.ImageSign = {};\n\nthis.TracesHandler = {};\n\nthis.TracesTemplate = {};\n\nthis.InstanceformTemplate = {};\n\nthis.InstanceAttachmentTemplate = {};\n\nthis.InstanceSignText = {};\n\nthis.RelatedInstances = {};\n\nthis.RelatedRecords = {};\n\nthis.InstanceMacro = {\n  context: {}\n};\n\nthis.TracesManager = {};\n\nInstanceSignText.isOpinionField_from_string = function(field_formula) {\n  return (field_formula != null ? field_formula.indexOf(\"{traces.\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{signature.traces.\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{yijianlan:\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{\\\"yijianlan\\\":\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{'yijianlan':\") : void 0) > -1;\n};\n\nInstanceSignText.includesOpinionField = function(form, form_version) {\n  var _form_version, field_formulas, fields;\n  field_formulas = new Array();\n  _form_version = {};\n  if (Meteor.isServer) {\n    _form_version = uuflowManager.getFormVersion(db.forms.findOne({\n      _id: form\n    }), form_version);\n  } else {\n    _form_version = db.form_versions.findOne({\n      _id: form_version,\n      form: form\n    });\n  }\n  fields = (_form_version != null ? _form_version.fields : void 0) || [];\n  fields.forEach(function(f) {\n    var ref;\n    if (f.type === 'table') {\n      return console.log('ignore opinion field in table');\n    } else if (f.type === 'section') {\n      return f != null ? (ref = f.fields) != null ? ref.forEach(function(f1) {\n        return field_formulas.push(f1.formula);\n      }) : void 0 : void 0;\n    } else {\n      return field_formulas.push(f.formula);\n    }\n  });\n  return _.some(field_formulas, function(field_formula) {\n    return InstanceformTemplate.helpers.isOpinionField_from_string(field_formula);\n  });\n};\n","db.auth_tokens = new Meteor.Collection('auth_tokens')","InstanceReadOnlyTemplate = {};\r\n\r\n\r\nInstanceReadOnlyTemplate.instance_attachment = \"\"\"\r\n\t<tr>\r\n\t\t<td class=\"ins-attach-view\">\r\n\t\t\t<a href=\"{{ins_attach_download_url _id absolute}}\" class=\"ins_attach_href\" target=\"_parent\" data-name=\"{{this.name}}\" data-type=\"{{this.original.type}}\" data-id=\"{{_id}}\">{{this.name}}</a>\r\n\t\t</td>\r\n\t</tr>\r\n\"\"\"\r\n\r\nInstanceReadOnlyTemplate.afSelectUserRead = \"\"\"\r\n\t<div class='selectUser form-control ins_applicant'>{{value}}</div>\r\n\"\"\"\r\n\r\n\r\nInstanceReadOnlyTemplate.afFormGroupRead = \"\"\"\r\n\t<div class='form-group'>\r\n\t\t{{#with getField this.name}}\r\n\t\t\t{{#if equals type 'section'}}\r\n\t\t\t\t\t<div class='section callout callout-default'>\r\n\t\t\t\t\t\t<label class=\"control-label\">{{f_label this}}</label>\r\n\t\t\t\t\t\t<p>{{{description}}}</p>\r\n\t\t\t\t\t</div>\r\n\t\t\t{{else}}\r\n\t\t\t\t{{#if equals type 'table'}}\r\n\t\t\t\t\t<div class=\"panel panel-default steedos-table\">\r\n\t\t\t\t\t\t<div class=\"panel-body\" style=\"padding:0px;\">\r\n\t\t\t\t\t\t\t<div class=\"panel-heading\" >\r\n\t\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t<span class=\"description\">{{{description}}}</span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div class=\"readonly-table\" style=\"padding:0px;overflow-x:auto;\">\r\n\t\t\t\t\t\t\t\t\t<table type='table' class=\"table table-bordered table-condensed autoform-table\" style='margin-bottom:0px;' {{this.atts}} id=\"{{this.code}}Table\" name=\"{{this.code}}\" data-schema-key=\"{{this.name}}\">\r\n\t\t\t\t\t\t\t\t\t\t<thead id=\"{{this.name}}Thead\" name=\"{{this.name}}Thead\">\r\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\r\n\t\t\t\t\t\t\t\t\t\t</thead>\r\n\t\t\t\t\t\t\t\t\t\t<tbody id=\"{{this.name}}Tbody\" name=\"{{this.name}}Tbody\">\r\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\r\n\t\t\t\t\t\t\t\t\t\t</tbody>\r\n\t\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t{{else}}\r\n\t\t\t\t\t{{#if showLabel}}\r\n\t\t\t\t\t\t<label>{{getLabel code}}</label>\r\n\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\r\n\t\t\t\t{{/if}}\r\n\t\t\t{{/if}}\r\n\t\t{{/with}}\r\n\t</div>\r\n\"\"\"\r\n\r\nInstanceReadOnlyTemplate.afFormGroup = \"\"\"\r\n\r\n\t{{#with getField this.name}}\r\n\t\t\t{{#if equals type 'section'}}\r\n\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t<div class='section callout callout-default'>\r\n\t\t\t\t\t\t<label class=\"control-label\">{{f_label this}}</label>\r\n\t\t\t\t\t\t<p>{{{description}}}</p>\r\n\t\t\t\t\t</div>\r\n  \t\t\t\t</div>\r\n\t\t\t{{else}}\r\n\t\t\t\t{{#if equals type 'table'}}\r\n\t\t\t\t\t<div class=\"panel panel-default steedos-table\">\r\n\t\t\t\t\t\t<div class=\"panel-body\" style=\"padding:0px;\">\r\n\t\t\t\t\t\t\t<div class=\"panel-heading\" >\r\n\t\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t<span class=\"description\">{{{description}}}</span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div class=\"readonly-table\" style=\"padding:0px;overflow-x:auto;\">\r\n\t\t\t\t\t\t\t\t\t<table type='table' class=\"table table-bordered table-condensed autoform-table\" style='margin-bottom:0px;' {{this.atts}} id=\"{{this.code}}Table\" name=\"{{this.code}}\" data-schema-key=\"{{this.name}}\">\r\n\t\t\t\t\t\t\t\t\t\t<thead id=\"{{this.name}}Thead\" name=\"{{this.name}}Thead\">\r\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\r\n\t\t\t\t\t\t\t\t\t\t</thead>\r\n\t\t\t\t\t\t\t\t\t\t<tbody id=\"{{this.name}}Tbody\" name=\"{{this.name}}Tbody\">\r\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\r\n\t\t\t\t\t\t\t\t\t\t</tbody>\r\n\t\t\t\t\t\t\t\t\t</table>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t{{else}}\r\n\t\t\t\t\t{{#if equals type 'input'}}\r\n\t\t\t\t\t\t<div class=\"form-group\" data-required=\"{{#if is_required}}true{{/if}}\">\r\n\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t{{#if is_textarea}}\r\n\t\t\t\t\t\t\t\t<textarea title=\"{{getLabel code}}\" name=\"{{code}}\" {{getPermissions code}} data-schema-key=\"{{getLabel code}}\" class=\"form-control\"></textarea>\r\n\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t{{#unless is_textarea}}\r\n\t\t\t\t\t\t\t\t<input type=\"text\" title=\"{{getLabel code}}\" name=\"{{code}}\" {{getPermissions code}} data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t{{/unless}}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t{{#if equals type 'number'}}\r\n\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t<input type=\"number\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t{{#if equals type 'date'}}\r\n\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t<input type=\"text\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-type=\"date\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t{{#if equals type 'dateTime'}}\r\n\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t<input type=\"text\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-type='datetime' data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t{{#if equals type 'password'}}\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t<input type=\"password\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t{{#if equals type 'select'}}\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<select name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<option value=\"{{value}}\">{{label}}</option>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'radio'}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"af-radio-group\" data-schema-key=\"{{getLabel code}}\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\r\n        \t\t\t\t\t\t\t\t\t\t\t\t<label class=\"radio-inline fix-indent\"><input type=\"radio\" value=\"{{value}}\" name=\"{{../code}}\" class=\"radio-inline fix-indent\"> {{label}}</label>\r\n    \t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\r\n    \t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'multiSelect'}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"af-checkbox-group\" data-schema-key=\"{{getLabel code}}\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label class=\"checkbox-inline fix-indent\"><input type=\"checkbox\" value=\"{{value}}\" name=\"{{../code}}\" class=\"checkbox-inline fix-indent\"> {{label}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'url'}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"url\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'email'}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"email\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'checkbox'}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"checkbox\" data-schema-key=\"{{getLabel code}}\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label style=\"width: 100%;\"><input type=\"checkbox\" value=\"true\" name=\"{{code}}\" class=\"checkbox-inline fix-indent\"></label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t\t{{/if}}\r\n\t\t\t\t\t{{/if}}\r\n\t\t\t\t{{/if}}\r\n\t\t\t{{/if}}\r\n\t\t{{/with}}\r\n\"\"\"\r\n\r\nInstanceReadOnlyTemplate.create = (tempalteName, steedosData) ->\r\n\ttemplate = InstanceReadOnlyTemplate[tempalteName]\r\n\r\n\ttemplateCompiled = SpacebarsCompiler.compile(template, {isBody: true});\r\n\r\n\ttemplateRenderFunction = eval(templateCompiled);\r\n\r\n\tTemplate[tempalteName] = new Blaze.Template(tempalteName, templateRenderFunction);\r\n\tTemplate[tempalteName].steedosData = steedosData\r\n\tTemplate[tempalteName].helpers InstanceformTemplate.helpers\r\n\r\nInstanceReadOnlyTemplate.createInstanceSignText = (steedosData)->\r\n\tinstanceSignTextHtml = _getViewHtml('client/views/instance/instance_sign_text.html')\r\n\r\n\tinstanceSignTextCompiled = SpacebarsCompiler.compile(instanceSignTextHtml, {isBody: true});\r\n\r\n\tinstanceSignTextRenderFunction = eval(instanceSignTextCompiled);\r\n\r\n\tTemplate.instanceSignText = new Blaze.Template(\"instanceSignText\", instanceSignTextRenderFunction);\r\n\tTemplate.instanceSignText.steedosData = steedosData\r\n\tTemplate.instanceSignText.helpers InstanceSignText.helpers\r\n\r\nInstanceReadOnlyTemplate.createImageSign = (steedosData) ->\r\n\timageSignHtml = _getViewHtml('client/views/instance/image_sign.html')\r\n\timageSignCompiled = SpacebarsCompiler.compile(imageSignHtml, {isBody: true});\r\n\timageSignRenderFunction = eval(imageSignCompiled);\r\n\tTemplate.imageSign = new Blaze.Template(\"imageSign\", imageSignRenderFunction);\r\n\tTemplate.imageSign.steedosData = steedosData\r\n\tTemplate.imageSign.helpers ImageSign.helpers\r\n\r\nInstanceReadOnlyTemplate.createTracesHanlder = (steedosData) ->\r\n\ttracesHanlderHtml = _getViewHtml('client/views/instance/traces_handler.html')\r\n\ttracesHanlderCompiled = SpacebarsCompiler.compile(tracesHanlderHtml, {isBody: true});\r\n\ttracesHanlderRenderFunction = eval(tracesHanlderCompiled);\r\n\tTemplate.instance_traces_handler = new Blaze.Template(\"instance_traces_handler\", tracesHanlderRenderFunction);\r\n\tTemplate.instance_traces_handler.steedosData = steedosData\r\n\tTemplate.instance_traces_handler.helpers TracesHandler.helpers\r\n\r\n\r\nInstanceReadOnlyTemplate.init = (steedosData) ->\r\n\tInstanceReadOnlyTemplate.create(\"afSelectUserRead\", steedosData);\r\n\r\n\tif Meteor.isServer\r\n\t\tInstanceReadOnlyTemplate.create(\"afFormGroup\", steedosData);\r\n\r\n\tInstanceReadOnlyTemplate.create(\"afFormGroupRead\", steedosData);\r\n\tif Meteor.isServer\r\n\t\tInstanceReadOnlyTemplate.create(\"instance_attachment\", {absolute: steedosData.absolute});\r\n\t\tInstanceReadOnlyTemplate.createImageSign(steedosData)\r\n\t\tInstanceReadOnlyTemplate.createTracesHanlder(steedosData);\r\n\t\tInstanceReadOnlyTemplate.createInstanceSignText(steedosData)\r\n\r\ngetLinkText = (item, label, detail_url)->\r\n\tif detail_url\r\n\t\tdetail_url = detail_url.replace(\"{_id}\", item._id)\r\n\t\tif !/^http(s?):\\/\\//.test(detail_url)\r\n\t\t\tdetail_url = Steedos.absoluteUrl(detail_url)\r\n\t\treturn '<a href=\"'+detail_url+'\" target=\"_blank\">'+label+'</a>';\r\n\telse\r\n\t\treturn label\r\n\r\nInstanceReadOnlyTemplate.getValue = (value, field, locale, utcOffset) ->\r\n\tif !value && value != false\r\n\t\treturn ''\r\n\tswitch field.type\r\n\t\twhen 'email'\r\n\t\t\tvalue = if value then '<a href=\\'mailto:' + value + '\\'>' + value + '</a>' else ''\r\n\t\twhen 'url'\r\n\t\t\tif value\r\n\t\t\t\tif value.indexOf(\"http\") == 0\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t\tvalue = \"<a href='\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\r\n\t\t\t\t\tcatch e\r\n\t\t\t\t\t\tvalue = \"<a href='' target='_blank'>\" + value + \"</a>\";\r\n\r\n\t\t\t\telse\r\n\t\t\t\t\tvalue = \"<a href='http://\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\r\n\t\t\telse\r\n\t\t\t\tvalue = ''\r\n\t\twhen 'group'\r\n\t\t\tif field.is_multiselect\r\n\t\t\t\tvalue = value?.getProperty(\"fullname\").toString()\r\n\t\t\telse\r\n\t\t\t\tvalue = value?.fullname\r\n\t\twhen 'user'\r\n\t\t\tif field.is_multiselect\r\n\t\t\t\tvalue = value?.getProperty(\"name\").toString()\r\n\t\t\telse\r\n\t\t\t\tvalue = value?.name\r\n\t\twhen 'password'\r\n\t\t\tvalue = '******'\r\n\t\twhen 'checkbox'\r\n\t\t\tif value && value != 'false'\r\n\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_yes\", {}, locale)\r\n\t\t\telse\r\n\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_no\", {}, locale)\r\n\t\twhen 'dateTime'\r\n\t\t\tif value && value.length == 16\r\n\t\t\t\tt = value.split(\"T\")\r\n\t\t\t\tt0 = t[0].split(\"-\");\r\n\t\t\t\tt1 = t[1].split(\":\");\r\n\r\n\t\t\t\tyear = t0[0];\r\n\t\t\t\tmonth = t0[1];\r\n\t\t\t\tdate = t0[2];\r\n\t\t\t\thours = t1[0];\r\n\t\t\t\tseconds = t1[1];\r\n\r\n\t\t\t\tvalue = new Date(year, month - 1, date, hours, seconds)\r\n\t\t\telse\r\n\t\t\t\tvalue = new Date(value)\r\n\r\n\t\t\tvalue = InstanceReadOnlyTemplate.formatDate(value, utcOffset);\r\n\t\twhen 'input'\r\n\t\t\tif field.is_textarea\r\n\t\t\t\tvalue = Spacebars.SafeString(Markdown(value))\r\n\t\twhen 'number'\r\n\t\t\tif value or value == 0\r\n\t\t\t\tvalue = Steedos.numberToString value, field.digits\r\n\t\twhen 'odata'\r\n\t\t\tdetail_url = field.detail_url\r\n\t\t\tif field.is_multiselect\r\n\t\t\t\tvalue = _.map value, (item)->\r\n\t\t\t\t\treturn getLinkText(item, item['@label'], detail_url)\r\n\t\t\telse\r\n\t\t\t\tvalue = getLinkText(value, value['@label'], detail_url)\r\n\t\twhen 'html'\r\n\t\t\tvalue = if value then \"<div class=\\\"steedos-html\\\">#{value}</div>\" else ''\r\n\r\n\treturn value;\r\n\r\nInstanceReadOnlyTemplate.getLabel = (fields, code) ->\r\n\tfield = fields.findPropertyByPK(\"code\", code)\r\n\tif field\r\n\t\tif field.name\r\n\t\t\treturn field.name\r\n\t\telse\r\n\t\t\treturn field.code\r\n\r\n\r\nInstanceReadOnlyTemplate.getInstanceFormVersion = (instance)->\r\n\tform = db.forms.findOne(instance.form);\r\n\r\n\tform_version = {}\r\n\r\n\tform_fields = [];\r\n\r\n\tif form.current._id == instance.form_version\r\n\t\tform_version = form.current\r\n\telse\r\n\t\tform_version = _.where(form.historys, {_id: instance.form_version})[0]\r\n\r\n\tform_version.fields.forEach (field)->\r\n\t\tif field.type == 'section'\r\n\t\t\tform_fields.push(field);\r\n\t\t\tif field.fields\r\n\t\t\t\tfield.fields.forEach (f) ->\r\n\t\t\t\t\tform_fields.push(f);\r\n\t\telse if field.type == 'table'\r\n\t\t\tfield['sfields'] = field['fields']\r\n\t\t\tdelete field['fields']\r\n\t\t\tform_fields.push(field);\r\n\t\telse\r\n\t\t\tform_fields.push(field);\r\n\r\n\tform_version.fields = form_fields;\r\n\r\n\treturn form_version;\r\n\r\nInstanceReadOnlyTemplate.getFlowVersion = (instance)->\r\n\tflow = db.flows.findOne(instance.flow);\r\n\tflow_version = {}\r\n\tif flow.current._id == instance.flow_version\r\n\t\tflow_version = flow.current\r\n\telse\r\n\t\tflow_version = _.where(flow.historys, {_id: instance.flow_version})[0]\r\n\r\n\treturn flow_version;\r\n\r\n\r\n_getViewHtml = (path) ->\r\n\tviewHtml = Assets.getText(path)\r\n\r\n\tif viewHtml\r\n\t\tviewHtml = viewHtml.replace(/<template[\\w\\s\\\"\\=']+>/i,\"\").replace(/<\\/template>/i,\"\")\r\n\r\n\treturn viewHtml;\r\n\r\n_getLocale = (user)->\r\n\tif user?.locale?.toLocaleLowerCase() == 'zh-cn'\r\n\t\tlocale = \"zh-CN\"\r\n\telse if user?.locale?.toLocaleLowerCase() == 'en-us'\r\n\t\tlocale = \"en\"\r\n\telse\r\n\t\tlocale = \"zh-CN\"\r\n\treturn locale\r\n\r\n\r\n_getRequiredFields = (fields, rev)->\r\n\tif !rev\r\n\t\trev = [];\r\n\r\n\tfields.forEach (field)->\r\n\t\tif field.type == 'section'\r\n\t\t\t_getRequiredFields(field.fields, rev)\r\n\t\telse if field.type == 'table'\r\n\r\n\t\telse\r\n\t\t\tif field.is_required\r\n\t\t\t\trev.push field.code\r\n\treturn rev;\r\n\r\n_getStartStepEditableFields = (fields, steps)->\r\n\tstartStep = steps.findPropertyByPK(\"step_type\",\"start\")\r\n\r\n\teditableCode = []\r\n\r\n\t_.keys(startStep.permissions).forEach (key)->\r\n\t\tif startStep.permissions[key] == 'editable'\r\n\t\t\teditableCode.push key\r\n\r\n\treturn editableCode\r\n\r\n_getStartStepRequiredFields = (fields, steps)->\r\n\trequiredFields = _getRequiredFields(fields)\r\n\r\n\teditableCode = _getStartStepEditableFields(fields, steps)\r\n\r\n\treturn _.intersection(requiredFields, editableCode)\r\n\r\n_getTemplateData = (user, space, instance, options)->\r\n\tif Meteor.isServer\r\n\t\tform_version = InstanceReadOnlyTemplate.getInstanceFormVersion(instance)\r\n\telse\r\n\t\tform_version = WorkflowManager.getInstanceFormVersion(instance)\r\n\r\n\tlocale = _getLocale(user)\r\n\r\n\tsteedosData = {}\r\n\r\n\tif Meteor.isClient\r\n\t\tsteedosData = _.clone(WorkflowManager_format.getAutoformSchemaValues())\r\n\t\tsteedosData.insname = instance.name\r\n\t\tsteedosData.ins_state = instance.state\r\n\t\tsteedosData.ins_final_decision = instance.ins_final_decision\r\n\t\tsteedosData.ins_code = instance.code\r\n\t\tsteedosData.ins_is_archived = instance.is_archived\r\n\t\tsteedosData.ins_is_deleted = instance.ins_is_deleted\r\n\t\tsteedosData.applicant_name = instance.applicant_name\r\n\t\tsteedosData.applicantContext = instance.applicant_name\r\n\r\n\tsteedosData.instance = instance\r\n\tsteedosData.form_version = form_version\r\n\tsteedosData.locale = locale\r\n\tsteedosData.utcOffset = user.utcOffset\r\n\tsteedosData.space = instance.space\r\n\tsteedosData.sessionUserId = user._id\r\n\r\n\tif Meteor.isServer\r\n\t\tif options?.editable\r\n\t\t\tform = db.forms.findOne({_id: instance.form})\r\n\r\n\t\t\tflow = db.flows.findOne({_id: instance.flow})\r\n\r\n\t\t\tsteedosData.startStepEditableFields = _getStartStepEditableFields(form.current.fields, flow.current.steps);\r\n\r\n\treturn steedosData;\r\n\r\nInstanceReadOnlyTemplate.formatDate = (date, utcOffset)->\r\n\tif Meteor.isServer\r\n\t\tpassing = false;\r\n\telse\r\n\t\tpassing = true;\r\n\r\n\tif !utcOffset && utcOffset !=0\r\n\t\tutcOffset = 8\r\n\r\n\treturn moment(date).utcOffset(utcOffset, passing).format(\"YYYY-MM-DD HH:mm\");\r\n\r\nInstanceReadOnlyTemplate.getInstanceView = (user, space, instance, options)->\r\n\r\n\tsteedosData = _getTemplateData(user, space, instance, options)\r\n\r\n\tsteedosData.absolute = false;\r\n\r\n\tif options?.absolute\r\n\t\tsteedosData.absolute = true;\r\n\r\n\tinstanceTemplate = TemplateManager.getTemplate(instance, options?.templateName);\r\n\r\n\tinstanceTemplate = instanceTemplate.replace(/afSelectUser/g,\"afSelectUserRead\")\r\n\r\n\tif !options?.editable\r\n\t\tinstanceTemplate = instanceTemplate.replace(/afFormGroup/g,\"afFormGroupRead\")\r\n\r\n\tinstanceCompiled = SpacebarsCompiler.compile(instanceTemplate, {isBody: true});\r\n\r\n\tinstanceRenderFunction = eval(instanceCompiled);\r\n\r\n\tTemplate.instance_readonly_view = new Blaze.Template(\"instance_readonly_view\", instanceRenderFunction);\r\n\r\n\tTemplate.instance_readonly_view.steedosData = steedosData\r\n\r\n\tTemplate.instance_readonly_view.helpers InstanceformTemplate.helpers\r\n\r\n\tInstanceReadOnlyTemplate.init(steedosData);\r\n\r\n\tbody = Blaze.toHTMLWithData(Template.instance_readonly_view, steedosData)\r\n\r\n\treturn \"\"\"\r\n\t\t<div id='instanceform' >\r\n\t\t\t#{body}\r\n\t\t</div>\r\n\t\"\"\"\r\n\r\nInstanceReadOnlyTemplate.getTracesView = (user, space, instance, options)->\r\n\r\n\tsteedosData = _getTemplateData(user, space, instance)\r\n\r\n\tform = db.forms.findOne(instance.form);\r\n\tif form.instance_style == \"table\" || options?.templateName == \"table\"\r\n\t\ttracesHtml = _getViewHtml('client/views/instance/traces_table.html')\r\n\telse\r\n\t\ttracesHtml = _getViewHtml('client/views/instance/traces.html')\r\n\r\n\ttraceCompiled = SpacebarsCompiler.compile(tracesHtml, {isBody: true});\r\n\r\n\ttraceRenderFunction = eval(traceCompiled);\r\n\r\n\tTemplate.trace_readonly_view = new Blaze.Template(\"trace_readonly_view\", traceRenderFunction);\r\n\r\n\tTemplate.trace_readonly_view.steedosData = steedosData\r\n\r\n\tTemplate.trace_readonly_view.helpers TracesTemplate.helpers\r\n\r\n\tbody = Blaze.toHTMLWithData(Template.trace_readonly_view, instance.traces)\r\n\r\n\treturn body;\r\n\r\nInstanceReadOnlyTemplate.getAttachmentView = (user, space, instance)->\r\n\r\n\tsteedosData = _getTemplateData(user, space, instance)\r\n\r\n\tattachmentHtml = _getViewHtml('client/views/instance/instance_attachments.html')\r\n\r\n\tattachmentCompiled = SpacebarsCompiler.compile(attachmentHtml, {isBody: true});\r\n\r\n\tattachmentRenderFunction = eval(attachmentCompiled);\r\n\r\n\tTemplate.attachments_readonly_view = new Blaze.Template(\"attachments_readonly_view\", attachmentRenderFunction);\r\n\r\n\tTemplate.attachments_readonly_view.steedosData = steedosData\r\n\r\n\tTemplate.attachments_readonly_view.helpers InstanceAttachmentTemplate.helpers\r\n\r\n\tbody = Blaze.toHTMLWithData(Template.attachments_readonly_view)\r\n\r\n\treturn body;\r\n\r\nInstanceReadOnlyTemplate.getRelatedInstancesView = (user, space, instance, options)->\r\n\tsteedosData = _getTemplateData(user, space, instance)\r\n\r\n\tsteedosData.absolute = false;\r\n\r\n\tif options?.absolute\r\n\t\tsteedosData.absolute = true;\r\n\r\n\trelatedInstancesHtml = _getViewHtml('client/views/instance/related_instances.html')\r\n\r\n\trelatedInstancesCompiled = SpacebarsCompiler.compile(relatedInstancesHtml, {isBody: true});\r\n\r\n\trelatedInstancesRenderFunction = eval(relatedInstancesCompiled);\r\n\r\n\tTemplate.related_instances_view = new Blaze.Template(\"related_instances_view\", relatedInstancesRenderFunction);\r\n\r\n\tTemplate.related_instances_view.steedosData = steedosData\r\n\r\n\tTemplate.related_instances_view.helpers RelatedInstances.helpers\r\n\r\n\tbody = Blaze.toHTMLWithData(Template.related_instances_view, steedosData)\r\n\r\n\treturn body;\r\n\r\nInstanceReadOnlyTemplate.getRelatedRecordsView = (user, space, instance, options)->\r\n\tsteedosData = _getTemplateData(user, space, instance)\r\n\r\n\tsteedosData.absolute = false;\r\n\r\n\tif options?.absolute\r\n\t\tsteedosData.absolute = true;\r\n\r\n\trelatedRecordsHtml = _getViewHtml('client/views/instance/related_records.html')\r\n\r\n\trelatedRecordsCompiled = SpacebarsCompiler.compile(relatedRecordsHtml, {isBody: true});\r\n\r\n\trelatedRecordsRenderFunction = eval(relatedRecordsCompiled);\r\n\r\n\tTemplate.related_records_view = new Blaze.Template(\"related_records_view\", relatedRecordsRenderFunction);\r\n\r\n\tTemplate.related_records_view.steedosData = steedosData\r\n\r\n\tTemplate.related_records_view.helpers RelatedRecords.helpers\r\n\r\n\tbody = Blaze.toHTMLWithData(Template.related_records_view, steedosData)\r\n\r\n\treturn body;\r\n\r\nInstanceReadOnlyTemplate.getOnLoadScript = (instance)->\r\n\tform_version = WorkflowManager.getFormVersion(instance.form, instance.form_version)\r\n\r\n\tform_script = form_version.form_script;\r\n\r\n\tif form_script && form_script.replace(/\\n/g,\"\").replace(/\\s/g,\"\").length > 0\r\n\t\tform_script = \"CoreForm = {};CoreForm.instanceform = {};\" + form_script\r\n\t\tform_script += \";if(CoreForm.form_OnLoad){window.onload = CoreForm.form_OnLoad();}\"\r\n\telse\r\n\t\tform_script = \"\"\r\n\r\n\r\n\r\nInstanceReadOnlyTemplate.getInstanceHtml = (user, space, instance, options)->\r\n\r\n\tbody = InstanceReadOnlyTemplate.getInstanceView(user, space, instance, options);\r\n\r\n\tonLoadScript = InstanceReadOnlyTemplate.getOnLoadScript(instance);\r\n\r\n\tcreatorService = Meteor.settings.public.webservices?.creator?.url\r\n\tins_record_ids = instance.record_ids\r\n\tlocale = _getLocale(user);\r\n\topenFileScript = \"\"\"\r\n\t\t\tif(window.isNode && isNode()){\r\n\t\t\t\tattachs = document.getElementsByClassName(\"ins_attach_href\");\r\n\t\t\t\tfor(var i = 0; i < attachs.length; i++){\r\n\t\t\t\t\tattach = attachs[i];\r\n\t\t\t\t\tattach.addEventListener(\"click\", function(e){\r\n\t\t\t\t\t\tif(isImage(this.dataset.type) || isHtml(this.dataset.type)){\r\n\t\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\t\topenWindow(\"/api/files/instances/\" + this.dataset.id);\r\n\t\t\t\t\t\t}else if(nw_core.canOpenFile(this.dataset.name)){\r\n\t\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\t\tnw_core.openFile(this.href, this.dataset.name)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tvar flow = \"#{instance.flow}\";\r\n\t\t\tvar space = \"#{instance.space}\";\r\n\r\n\t\t\tfunction getCookie(name){\r\n\t\t\t\tlet pattern = RegExp(name + \"=.[^;]*\")\r\n\t\t\t\tlet matched = document.cookie.match(pattern)\r\n\t\t\t\tif(matched){\r\n\t\t\t\t\tlet cookie = matched[0].split('=')\r\n\t\t\t\t\treturn cookie[1]\r\n\t\t\t\t}\r\n\t\t\t\treturn ''\r\n\t\t\t}\r\n\r\n\t\t\tvar records = document.getElementsByClassName(\"ins-related-records\");\r\n\t\t\tfor(var i = 0; i < records.length; i++){\r\n\t\t\t\t\tvar record = records[i];\r\n\t\t\t\t\trecord.addEventListener(\"click\", function(e){\r\n\t\t\t\t\t\tvar creatorService = \"#{creatorService}\"\r\n\t\t\t\t\t\tvar ins_record_ids = #{JSON.stringify(ins_record_ids)}\r\n\t\t\t\t\t\tif(creatorService && ins_record_ids && ins_record_ids.length > 0){\r\n\t\t\t\t\t\t\tvar objcetName = ins_record_ids[0].o\r\n\t\t\t\t\t\t\tvar id = ins_record_ids[0].ids[0]\r\n\t\t\t\t\t\t\tvar uobj = {};\r\n\t\t\t\t\t\t\tuobj[\"X-User-Id\"] = getCookie(\"X-User-Id\");\r\n\t\t\t\t\t\t\tuobj[\"X-Auth-Token\"] = getCookie(\"X-Auth-Token\");\r\n\t\t\t\t\t\t\tredirectUrl = creatorService + \"app/-/\" + objcetName + \"/view/\" + id + \"?\" + $.param(uobj);\r\n\t\t\t\t\t\t\topenWindow(redirectUrl);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\"\"\";\r\n\r\n\r\n\tif !Steedos.isMobile()\r\n\t\tform = db.forms.findOne(instance.form);\r\n\t\tif form?.instance_style == 'table'\r\n\t\t\tinstance_style = \"instance-table\"\r\n\r\n\tif options?.templateName == 'table'\r\n\t\tinstance_style = \"instance-table\"\r\n\r\n\tif options?.instance_style\r\n\t\tinstance_style = options.instance_style\r\n\r\n\tif !options || options.showTrace == true\r\n\t\ttrace = InstanceReadOnlyTemplate.getTracesView(user, space, instance)\r\n\telse\r\n\t\ttrace = \"\"\r\n\r\n\tinstanceBoxStyle = \"\";\r\n\r\n\tif instance && instance.final_decision\r\n\t\tif instance.final_decision == \"approved\"\r\n\t\t\tinstanceBoxStyle = \"box-success\"\r\n\t\telse if (instance.final_decision == \"rejected\")\r\n\t\t\tinstanceBoxStyle = \"box-danger\"\r\n\tif !options || options.showAttachments == true\r\n\t\tattachment = InstanceReadOnlyTemplate.getAttachmentView(user, space, instance)\r\n\t\trelated_instances = InstanceReadOnlyTemplate.getRelatedInstancesView(user, space, instance, options)\r\n\t\trelated_records = InstanceReadOnlyTemplate.getRelatedRecordsView(user, space, instance, options)\r\n\telse\r\n\t\tattachment = \"\"\r\n\t\trelated_instances = \"\"\r\n\t\trelated_records = \"\"\r\n\r\n\r\n\twidth = \"960px\"\r\n\t#\tå¦‚æžœç»™tableçš„parentè®¾ç½®widthï¼Œåˆ™ä¼šå¯¼è‡´é˜¿é‡Œäº‘é‚®ç®±æ˜¾ç¤ºtable å¼‚å¸¸\r\n\tif options?.width\r\n\t\twidth = \"\"\r\n\r\n\tcssHref = Meteor.absoluteUrl(\"steedos-css\")\r\n\r\n\tallCssLink = \"\"\"<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"#{cssHref}\">\"\"\"\r\n\r\n\ttraceCheck = \"\"\r\n\tif !_.isEmpty(trace)\r\n\t\ttraceCheck = \"checked\"\r\n\tif options?.tagger == 'email' || options?.editable\r\n\t\tshowTracesBtn = \"\"\r\n\telse\r\n\t\tshowTracesBtn = \"\"\"\r\n\t\t\t<div class=\"navigation-bar btn-group no-print\" style=\"min-width: 600px; z-index: 999\">\r\n\t\t\t\t<div class=\"print-tool\">\r\n\t\t\t\t\t<label class=\"cbx-label\"><input type=\"checkbox\" class=\"cbx-print cbx-print-attachments\" id=\"cbx-print-attachments\" checked=\"checked\"><span>#{TAPi18n.__('instance_attachment', {}, locale)}</span></label>\r\n\t\t\t\t\t<label class=\"cbx-label\"><input type=\"checkbox\" class=\"cbx-print cbx-print-traces\" id=\"cbx-print-traces\" checked=\"#{traceCheck}\"><span>#{TAPi18n.__('instance_approval_history', {}, locale)}</span></label>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t\"\"\"\r\n\r\n\tshowTracesScript = \"\"\"\r\n\t\t$( document ).ready(function(){\r\n\t\t\tvar b = document.getElementById('cbx-print-traces');\r\n\t\t\tvar t = document.getElementsByClassName('instance-traces')[0];\r\n\t\t\tif (b && b.checked && t){\r\n\t\t\t\tt.style = 'display: block;'\r\n\t\t\t} else if(t){\r\n\t\t\t\tt.style = 'display: none;'\r\n\t\t\t}\r\n\t\t\tif(b){\r\n\t\t\t\tb.addEventListener('change', function(e){\r\n\t\t\t\t\tif (e.target.checked){\r\n\t\t\t\t\t\tt.style = 'display: block;'\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tt.style = 'display: none;'\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\r\n\t\t\tvar attachmentsCheckbox = document.getElementById('cbx-print-attachments');\r\n\t\t\tvar attachmentsView = document.getElementsByClassName('attachments-section')[0];\r\n\t\t\tif (attachmentsCheckbox && attachmentsCheckbox.checked && attachmentsView){\r\n\t\t\t\tattachmentsView.style = 'display: block;'\r\n\t\t\t} else if(attachmentsView){\r\n\t\t\t\tattachmentsView.style = 'display: none;'\r\n\t\t\t}\r\n\t\t\tif(attachmentsCheckbox){\r\n\t\t\t\tattachmentsCheckbox.addEventListener('change', function(e){\r\n\t\t\t\t\tif (e.target.checked){\r\n\t\t\t\t\t\tattachmentsView.style = 'display: block;'\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tattachmentsView.style = 'display: none;'\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\"\"\"\r\n\r\n\tif options?.styles\r\n\t\tallCssLink = \"\"\r\n\r\n\tform = db.forms.findOne({_id: instance.form});\r\n\tformDescriptionHtml = \"\"\r\n\tif form\r\n\t\tformDescription = form.description\r\n\t\tif formDescription\r\n\t\t\tformDescription = formDescription.replace(/\\n/g,\"<br/>\")\r\n\t\t\tformDescriptionHtml = \"\"\"\r\n\t\t\t\t<div class=\"box-header  with-border instance-header\">\r\n\t\t\t\t\t<div>\r\n\t\t\t\t\t\t#{formDescription}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t\"\"\"\r\n\r\n\thtml = \"\"\"\r\n\t\t<!DOCTYPE html>\r\n\t\t<html>\r\n\t\t\t<head>\r\n\t\t\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\r\n\t\t\t\t#{allCssLink}\r\n\t\t\t\t<script src=\"https://www.steedos.com/website/libs/jquery.min.js\" type=\"text/javascript\"></script>\r\n\t\t\t\t<script src=\"/js/nw_core.js\" type=\"text/javascript\"></script>\r\n\t\t\t\t#{options.plugins || \"\"}\r\n\r\n\t\t\t\t<style>\r\n\t\t\t\t\t.steedos{\r\n\t\t\t\t\t\twidth: #{width};\r\n\t\t\t\t\t\tmargin-left: auto;\r\n\t\t\t\t\t\tmargin-right: auto;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.instance-view .instance-name{\r\n\t\t\t\t\t\tdisplay: inline !important\r\n\t\t\t\t\t}\r\n\t\t\t\t\t.box-tools{\r\n\t\t\t\t\t\tdisplay: none;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t.box.collapsed-box .box-body,.box.collapsed-box .box-footer {\r\n\t\t\t\t\t  display: block;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tbody{\r\n\t\t\t\t\t\tbackground: azure !important;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.instance-view .instance-traces{\r\n\t\t\t\t\t\tpadding-left: 15px;\r\n\t\t\t\t\t\tpadding-right: 15px;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t#{options?.styles || \"\"}\r\n\t\t\t\t</style>\r\n\t\t\t</head>\r\n\t\t\t<body>\r\n\t\t\t\t<div class=\"steedos workflow instance-print\">\r\n\t\t\t\t\t<div class=\"skin-green skin-admin-lte\">\r\n\t\t\t\t\t\t<div class=\"wrapper\">\r\n\t\t\t\t\t\t\t<div class=\"content-wrapper\">\r\n\t\t\t\t\t\t\t\t#{showTracesBtn}\r\n\t\t\t\t\t\t\t\t<div class=\"instance-print\">\r\n\t\t\t\t\t\t\t\t\t<div class=\"instance #{instance_style}\">\r\n\t\t\t\t\t\t\t\t\t\t<form name=\"instanceForm\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"instance-form box #{instanceBoxStyle}\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t#{formDescriptionHtml}\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"box-body\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"col-md-12\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class='attachments-section'>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#{attachment}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#{related_instances}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#{related_records}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t#{body}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</form>\r\n\t\t\t\t\t\t\t\t\t\t#{trace}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</body>\r\n\t\t\t<script>#{openFileScript};#{onLoadScript};#{showTracesScript}</script>\r\n\t\t</html>\r\n\t\"\"\"\r\n\r\n\treturn html","var _getLocale, _getRequiredFields, _getStartStepEditableFields, _getStartStepRequiredFields, _getTemplateData, _getViewHtml, getLinkText;                          \n\nInstanceReadOnlyTemplate = {};\n\nInstanceReadOnlyTemplate.instance_attachment = \"<tr>\\n\t<td class=\\\"ins-attach-view\\\">\\n\t\t<a href=\\\"{{ins_attach_download_url _id absolute}}\\\" class=\\\"ins_attach_href\\\" target=\\\"_parent\\\" data-name=\\\"{{this.name}}\\\" data-type=\\\"{{this.original.type}}\\\" data-id=\\\"{{_id}}\\\">{{this.name}}</a>\\n\t</td>\\n</tr>\";\n\nInstanceReadOnlyTemplate.afSelectUserRead = \"<div class='selectUser form-control ins_applicant'>{{value}}</div>\";\n\nInstanceReadOnlyTemplate.afFormGroupRead = \"<div class='form-group'>\\n\t{{#with getField this.name}}\\n\t\t{{#if equals type 'section'}}\\n\t\t\t\t<div class='section callout callout-default'>\\n\t\t\t\t\t<label class=\\\"control-label\\\">{{f_label this}}</label>\\n\t\t\t\t\t<p>{{{description}}}</p>\\n\t\t\t\t</div>\\n\t\t{{else}}\\n\t\t\t{{#if equals type 'table'}}\\n\t\t\t\t<div class=\\\"panel panel-default steedos-table\\\">\\n\t\t\t\t\t<div class=\\\"panel-body\\\" style=\\\"padding:0px;\\\">\\n\t\t\t\t\t\t<div class=\\\"panel-heading\\\" >\\n\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\\n\t\t\t\t\t\t\t<span class=\\\"description\\\">{{{description}}}</span>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t<div class=\\\"readonly-table\\\" style=\\\"padding:0px;overflow-x:auto;\\\">\\n\t\t\t\t\t\t\t\t<table type='table' class=\\\"table table-bordered table-condensed autoform-table\\\" style='margin-bottom:0px;' {{this.atts}} id=\\\"{{this.code}}Table\\\" name=\\\"{{this.code}}\\\" data-schema-key=\\\"{{this.name}}\\\">\\n\t\t\t\t\t\t\t\t\t<thead id=\\\"{{this.name}}Thead\\\" name=\\\"{{this.name}}Thead\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\\n\t\t\t\t\t\t\t\t\t</thead>\\n\t\t\t\t\t\t\t\t\t<tbody id=\\\"{{this.name}}Tbody\\\" name=\\\"{{this.name}}Tbody\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\\n\t\t\t\t\t\t\t\t\t</tbody>\\n\t\t\t\t\t\t\t\t</table>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t{{else}}\\n\t\t\t\t{{#if showLabel}}\\n\t\t\t\t\t<label>{{getLabel code}}</label>\\n\t\t\t\t{{/if}}\\n\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\\n\t\t\t{{/if}}\\n\t\t{{/if}}\\n\t{{/with}}\\n</div>\";\n\nInstanceReadOnlyTemplate.afFormGroup = \"\\n{{#with getField this.name}}\\n\t\t{{#if equals type 'section'}}\\n\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t<div class='section callout callout-default'>\\n\t\t\t\t\t<label class=\\\"control-label\\\">{{f_label this}}</label>\\n\t\t\t\t\t<p>{{{description}}}</p>\\n\t\t\t\t</div>\\n  \t\t\t\t</div>\\n\t\t{{else}}\\n\t\t\t{{#if equals type 'table'}}\\n\t\t\t\t<div class=\\\"panel panel-default steedos-table\\\">\\n\t\t\t\t\t<div class=\\\"panel-body\\\" style=\\\"padding:0px;\\\">\\n\t\t\t\t\t\t<div class=\\\"panel-heading\\\" >\\n\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\\n\t\t\t\t\t\t\t<span class=\\\"description\\\">{{{description}}}</span>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t<div class=\\\"readonly-table\\\" style=\\\"padding:0px;overflow-x:auto;\\\">\\n\t\t\t\t\t\t\t\t<table type='table' class=\\\"table table-bordered table-condensed autoform-table\\\" style='margin-bottom:0px;' {{this.atts}} id=\\\"{{this.code}}Table\\\" name=\\\"{{this.code}}\\\" data-schema-key=\\\"{{this.name}}\\\">\\n\t\t\t\t\t\t\t\t\t<thead id=\\\"{{this.name}}Thead\\\" name=\\\"{{this.name}}Thead\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\\n\t\t\t\t\t\t\t\t\t</thead>\\n\t\t\t\t\t\t\t\t\t<tbody id=\\\"{{this.name}}Tbody\\\" name=\\\"{{this.name}}Tbody\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\\n\t\t\t\t\t\t\t\t\t</tbody>\\n\t\t\t\t\t\t\t\t</table>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t{{else}}\\n\t\t\t\t{{#if equals type 'input'}}\\n\t\t\t\t\t<div class=\\\"form-group\\\" data-required=\\\"{{#if is_required}}true{{/if}}\\\">\\n\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t{{#if is_textarea}}\\n\t\t\t\t\t\t\t<textarea title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" {{getPermissions code}} data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\"></textarea>\\n\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t{{#unless is_textarea}}\\n\t\t\t\t\t\t\t<input type=\\\"text\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" {{getPermissions code}} data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t{{/unless}}\\n\t\t\t\t\t</div>\\n\t\t\t\t{{else}}\\n\t\t\t\t\t{{#if equals type 'number'}}\\n\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t<input type=\\\"number\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t{{#if equals type 'date'}}\\n\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t<input type=\\\"text\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-type=\\\"date\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t{{#if equals type 'dateTime'}}\\n\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t<input type=\\\"text\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-type='datetime' data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t{{#if equals type 'password'}}\\n\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t<input type=\\\"password\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t{{#if equals type 'select'}}\\n\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t<select name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<option value=\\\"{{value}}\\\">{{label}}</option>\\n\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\\n\t\t\t\t\t\t\t\t\t\t\t</select>\\n\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t{{#if equals type 'radio'}}\\n\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"af-radio-group\\\" data-schema-key=\\\"{{getLabel code}}\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\\n        \t\t\t\t\t\t\t\t\t\t\t\t<label class=\\\"radio-inline fix-indent\\\"><input type=\\\"radio\\\" value=\\\"{{value}}\\\" name=\\\"{{../code}}\\\" class=\\\"radio-inline fix-indent\\\"> {{label}}</label>\\n    \t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\\n    \t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'multiSelect'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"af-checkbox-group\\\" data-schema-key=\\\"{{getLabel code}}\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label class=\\\"checkbox-inline fix-indent\\\"><input type=\\\"checkbox\\\" value=\\\"{{value}}\\\" name=\\\"{{../code}}\\\" class=\\\"checkbox-inline fix-indent\\\"> {{label}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'url'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\\\"url\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'email'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\\\"email\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'checkbox'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"checkbox\\\" data-schema-key=\\\"{{getLabel code}}\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label style=\\\"width: 100%;\\\"><input type=\\\"checkbox\\\" value=\\\"true\\\" name=\\\"{{code}}\\\" class=\\\"checkbox-inline fix-indent\\\"></label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t{{/if}}\\n\t\t\t\t{{/if}}\\n\t\t\t{{/if}}\\n\t\t{{/if}}\\n\t{{/with}}\";\n\nInstanceReadOnlyTemplate.create = function(tempalteName, steedosData) {\n  var template, templateCompiled, templateRenderFunction;\n  template = InstanceReadOnlyTemplate[tempalteName];\n  templateCompiled = SpacebarsCompiler.compile(template, {\n    isBody: true\n  });\n  templateRenderFunction = eval(templateCompiled);\n  Template[tempalteName] = new Blaze.Template(tempalteName, templateRenderFunction);\n  Template[tempalteName].steedosData = steedosData;\n  return Template[tempalteName].helpers(InstanceformTemplate.helpers);\n};\n\nInstanceReadOnlyTemplate.createInstanceSignText = function(steedosData) {\n  var instanceSignTextCompiled, instanceSignTextHtml, instanceSignTextRenderFunction;\n  instanceSignTextHtml = _getViewHtml('client/views/instance/instance_sign_text.html');\n  instanceSignTextCompiled = SpacebarsCompiler.compile(instanceSignTextHtml, {\n    isBody: true\n  });\n  instanceSignTextRenderFunction = eval(instanceSignTextCompiled);\n  Template.instanceSignText = new Blaze.Template(\"instanceSignText\", instanceSignTextRenderFunction);\n  Template.instanceSignText.steedosData = steedosData;\n  return Template.instanceSignText.helpers(InstanceSignText.helpers);\n};\n\nInstanceReadOnlyTemplate.createImageSign = function(steedosData) {\n  var imageSignCompiled, imageSignHtml, imageSignRenderFunction;\n  imageSignHtml = _getViewHtml('client/views/instance/image_sign.html');\n  imageSignCompiled = SpacebarsCompiler.compile(imageSignHtml, {\n    isBody: true\n  });\n  imageSignRenderFunction = eval(imageSignCompiled);\n  Template.imageSign = new Blaze.Template(\"imageSign\", imageSignRenderFunction);\n  Template.imageSign.steedosData = steedosData;\n  return Template.imageSign.helpers(ImageSign.helpers);\n};\n\nInstanceReadOnlyTemplate.createTracesHanlder = function(steedosData) {\n  var tracesHanlderCompiled, tracesHanlderHtml, tracesHanlderRenderFunction;\n  tracesHanlderHtml = _getViewHtml('client/views/instance/traces_handler.html');\n  tracesHanlderCompiled = SpacebarsCompiler.compile(tracesHanlderHtml, {\n    isBody: true\n  });\n  tracesHanlderRenderFunction = eval(tracesHanlderCompiled);\n  Template.instance_traces_handler = new Blaze.Template(\"instance_traces_handler\", tracesHanlderRenderFunction);\n  Template.instance_traces_handler.steedosData = steedosData;\n  return Template.instance_traces_handler.helpers(TracesHandler.helpers);\n};\n\nInstanceReadOnlyTemplate.init = function(steedosData) {\n  InstanceReadOnlyTemplate.create(\"afSelectUserRead\", steedosData);\n  if (Meteor.isServer) {\n    InstanceReadOnlyTemplate.create(\"afFormGroup\", steedosData);\n  }\n  InstanceReadOnlyTemplate.create(\"afFormGroupRead\", steedosData);\n  if (Meteor.isServer) {\n    InstanceReadOnlyTemplate.create(\"instance_attachment\", {\n      absolute: steedosData.absolute\n    });\n    InstanceReadOnlyTemplate.createImageSign(steedosData);\n    InstanceReadOnlyTemplate.createTracesHanlder(steedosData);\n    return InstanceReadOnlyTemplate.createInstanceSignText(steedosData);\n  }\n};\n\ngetLinkText = function(item, label, detail_url) {\n  if (detail_url) {\n    detail_url = detail_url.replace(\"{_id}\", item._id);\n    if (!/^http(s?):\\/\\//.test(detail_url)) {\n      detail_url = Steedos.absoluteUrl(detail_url);\n    }\n    return '<a href=\"' + detail_url + '\" target=\"_blank\">' + label + '</a>';\n  } else {\n    return label;\n  }\n};\n\nInstanceReadOnlyTemplate.getValue = function(value, field, locale, utcOffset) {\n  var date, detail_url, e, hours, month, seconds, t, t0, t1, year;\n  if (!value && value !== false) {\n    return '';\n  }\n  switch (field.type) {\n    case 'email':\n      value = value ? '<a href=\\'mailto:' + value + '\\'>' + value + '</a>' : '';\n      break;\n    case 'url':\n      if (value) {\n        if (value.indexOf(\"http\") === 0) {\n          try {\n            value = \"<a href='\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n          } catch (error) {\n            e = error;\n            value = \"<a href='' target='_blank'>\" + value + \"</a>\";\n          }\n        } else {\n          value = \"<a href='http://\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n        }\n      } else {\n        value = '';\n      }\n      break;\n    case 'group':\n      if (field.is_multiselect) {\n        value = value != null ? value.getProperty(\"fullname\").toString() : void 0;\n      } else {\n        value = value != null ? value.fullname : void 0;\n      }\n      break;\n    case 'user':\n      if (field.is_multiselect) {\n        value = value != null ? value.getProperty(\"name\").toString() : void 0;\n      } else {\n        value = value != null ? value.name : void 0;\n      }\n      break;\n    case 'password':\n      value = '******';\n      break;\n    case 'checkbox':\n      if (value && value !== 'false') {\n        value = TAPi18n.__(\"form_field_checkbox_yes\", {}, locale);\n      } else {\n        value = TAPi18n.__(\"form_field_checkbox_no\", {}, locale);\n      }\n      break;\n    case 'dateTime':\n      if (value && value.length === 16) {\n        t = value.split(\"T\");\n        t0 = t[0].split(\"-\");\n        t1 = t[1].split(\":\");\n        year = t0[0];\n        month = t0[1];\n        date = t0[2];\n        hours = t1[0];\n        seconds = t1[1];\n        value = new Date(year, month - 1, date, hours, seconds);\n      } else {\n        value = new Date(value);\n      }\n      value = InstanceReadOnlyTemplate.formatDate(value, utcOffset);\n      break;\n    case 'input':\n      if (field.is_textarea) {\n        value = Spacebars.SafeString(Markdown(value));\n      }\n      break;\n    case 'number':\n      if (value || value === 0) {\n        value = Steedos.numberToString(value, field.digits);\n      }\n      break;\n    case 'odata':\n      detail_url = field.detail_url;\n      if (field.is_multiselect) {\n        value = _.map(value, function(item) {\n          return getLinkText(item, item['@label'], detail_url);\n        });\n      } else {\n        value = getLinkText(value, value['@label'], detail_url);\n      }\n      break;\n    case 'html':\n      value = value ? \"<div class=\\\"steedos-html\\\">\" + value + \"</div>\" : '';\n  }\n  return value;\n};\n\nInstanceReadOnlyTemplate.getLabel = function(fields, code) {\n  var field;\n  field = fields.findPropertyByPK(\"code\", code);\n  if (field) {\n    if (field.name) {\n      return field.name;\n    } else {\n      return field.code;\n    }\n  }\n};\n\nInstanceReadOnlyTemplate.getInstanceFormVersion = function(instance) {\n  var form, form_fields, form_version;\n  form = db.forms.findOne(instance.form);\n  form_version = {};\n  form_fields = [];\n  if (form.current._id === instance.form_version) {\n    form_version = form.current;\n  } else {\n    form_version = _.where(form.historys, {\n      _id: instance.form_version\n    })[0];\n  }\n  form_version.fields.forEach(function(field) {\n    if (field.type === 'section') {\n      form_fields.push(field);\n      if (field.fields) {\n        return field.fields.forEach(function(f) {\n          return form_fields.push(f);\n        });\n      }\n    } else if (field.type === 'table') {\n      field['sfields'] = field['fields'];\n      delete field['fields'];\n      return form_fields.push(field);\n    } else {\n      return form_fields.push(field);\n    }\n  });\n  form_version.fields = form_fields;\n  return form_version;\n};\n\nInstanceReadOnlyTemplate.getFlowVersion = function(instance) {\n  var flow, flow_version;\n  flow = db.flows.findOne(instance.flow);\n  flow_version = {};\n  if (flow.current._id === instance.flow_version) {\n    flow_version = flow.current;\n  } else {\n    flow_version = _.where(flow.historys, {\n      _id: instance.flow_version\n    })[0];\n  }\n  return flow_version;\n};\n\n_getViewHtml = function(path) {\n  var viewHtml;\n  viewHtml = Assets.getText(path);\n  if (viewHtml) {\n    viewHtml = viewHtml.replace(/<template[\\w\\s\\\"\\=']+>/i, \"\").replace(/<\\/template>/i, \"\");\n  }\n  return viewHtml;\n};\n\n_getLocale = function(user) {\n  var locale, ref, ref1;\n  if ((user != null ? (ref = user.locale) != null ? ref.toLocaleLowerCase() : void 0 : void 0) === 'zh-cn') {\n    locale = \"zh-CN\";\n  } else if ((user != null ? (ref1 = user.locale) != null ? ref1.toLocaleLowerCase() : void 0 : void 0) === 'en-us') {\n    locale = \"en\";\n  } else {\n    locale = \"zh-CN\";\n  }\n  return locale;\n};\n\n_getRequiredFields = function(fields, rev) {\n  if (!rev) {\n    rev = [];\n  }\n  fields.forEach(function(field) {\n    if (field.type === 'section') {\n      return _getRequiredFields(field.fields, rev);\n    } else if (field.type === 'table') {\n\n    } else {\n      if (field.is_required) {\n        return rev.push(field.code);\n      }\n    }\n  });\n  return rev;\n};\n\n_getStartStepEditableFields = function(fields, steps) {\n  var editableCode, startStep;\n  startStep = steps.findPropertyByPK(\"step_type\", \"start\");\n  editableCode = [];\n  _.keys(startStep.permissions).forEach(function(key) {\n    if (startStep.permissions[key] === 'editable') {\n      return editableCode.push(key);\n    }\n  });\n  return editableCode;\n};\n\n_getStartStepRequiredFields = function(fields, steps) {\n  var editableCode, requiredFields;\n  requiredFields = _getRequiredFields(fields);\n  editableCode = _getStartStepEditableFields(fields, steps);\n  return _.intersection(requiredFields, editableCode);\n};\n\n_getTemplateData = function(user, space, instance, options) {\n  var flow, form, form_version, locale, steedosData;\n  if (Meteor.isServer) {\n    form_version = InstanceReadOnlyTemplate.getInstanceFormVersion(instance);\n  } else {\n    form_version = WorkflowManager.getInstanceFormVersion(instance);\n  }\n  locale = _getLocale(user);\n  steedosData = {};\n  if (Meteor.isClient) {\n    steedosData = _.clone(WorkflowManager_format.getAutoformSchemaValues());\n    steedosData.insname = instance.name;\n    steedosData.ins_state = instance.state;\n    steedosData.ins_final_decision = instance.ins_final_decision;\n    steedosData.ins_code = instance.code;\n    steedosData.ins_is_archived = instance.is_archived;\n    steedosData.ins_is_deleted = instance.ins_is_deleted;\n    steedosData.applicant_name = instance.applicant_name;\n    steedosData.applicantContext = instance.applicant_name;\n  }\n  steedosData.instance = instance;\n  steedosData.form_version = form_version;\n  steedosData.locale = locale;\n  steedosData.utcOffset = user.utcOffset;\n  steedosData.space = instance.space;\n  steedosData.sessionUserId = user._id;\n  if (Meteor.isServer) {\n    if (options != null ? options.editable : void 0) {\n      form = db.forms.findOne({\n        _id: instance.form\n      });\n      flow = db.flows.findOne({\n        _id: instance.flow\n      });\n      steedosData.startStepEditableFields = _getStartStepEditableFields(form.current.fields, flow.current.steps);\n    }\n  }\n  return steedosData;\n};\n\nInstanceReadOnlyTemplate.formatDate = function(date, utcOffset) {\n  var passing;\n  if (Meteor.isServer) {\n    passing = false;\n  } else {\n    passing = true;\n  }\n  if (!utcOffset && utcOffset !== 0) {\n    utcOffset = 8;\n  }\n  return moment(date).utcOffset(utcOffset, passing).format(\"YYYY-MM-DD HH:mm\");\n};\n\nInstanceReadOnlyTemplate.getInstanceView = function(user, space, instance, options) {\n  var body, instanceCompiled, instanceRenderFunction, instanceTemplate, steedosData;\n  steedosData = _getTemplateData(user, space, instance, options);\n  steedosData.absolute = false;\n  if (options != null ? options.absolute : void 0) {\n    steedosData.absolute = true;\n  }\n  instanceTemplate = TemplateManager.getTemplate(instance, options != null ? options.templateName : void 0);\n  instanceTemplate = instanceTemplate.replace(/afSelectUser/g, \"afSelectUserRead\");\n  if (!(options != null ? options.editable : void 0)) {\n    instanceTemplate = instanceTemplate.replace(/afFormGroup/g, \"afFormGroupRead\");\n  }\n  instanceCompiled = SpacebarsCompiler.compile(instanceTemplate, {\n    isBody: true\n  });\n  instanceRenderFunction = eval(instanceCompiled);\n  Template.instance_readonly_view = new Blaze.Template(\"instance_readonly_view\", instanceRenderFunction);\n  Template.instance_readonly_view.steedosData = steedosData;\n  Template.instance_readonly_view.helpers(InstanceformTemplate.helpers);\n  InstanceReadOnlyTemplate.init(steedosData);\n  body = Blaze.toHTMLWithData(Template.instance_readonly_view, steedosData);\n  return \"<div id='instanceform' >\\n\t\" + body + \"\\n</div>\";\n};\n\nInstanceReadOnlyTemplate.getTracesView = function(user, space, instance, options) {\n  var body, form, steedosData, traceCompiled, traceRenderFunction, tracesHtml;\n  steedosData = _getTemplateData(user, space, instance);\n  form = db.forms.findOne(instance.form);\n  if (form.instance_style === \"table\" || (options != null ? options.templateName : void 0) === \"table\") {\n    tracesHtml = _getViewHtml('client/views/instance/traces_table.html');\n  } else {\n    tracesHtml = _getViewHtml('client/views/instance/traces.html');\n  }\n  traceCompiled = SpacebarsCompiler.compile(tracesHtml, {\n    isBody: true\n  });\n  traceRenderFunction = eval(traceCompiled);\n  Template.trace_readonly_view = new Blaze.Template(\"trace_readonly_view\", traceRenderFunction);\n  Template.trace_readonly_view.steedosData = steedosData;\n  Template.trace_readonly_view.helpers(TracesTemplate.helpers);\n  body = Blaze.toHTMLWithData(Template.trace_readonly_view, instance.traces);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getAttachmentView = function(user, space, instance) {\n  var attachmentCompiled, attachmentHtml, attachmentRenderFunction, body, steedosData;\n  steedosData = _getTemplateData(user, space, instance);\n  attachmentHtml = _getViewHtml('client/views/instance/instance_attachments.html');\n  attachmentCompiled = SpacebarsCompiler.compile(attachmentHtml, {\n    isBody: true\n  });\n  attachmentRenderFunction = eval(attachmentCompiled);\n  Template.attachments_readonly_view = new Blaze.Template(\"attachments_readonly_view\", attachmentRenderFunction);\n  Template.attachments_readonly_view.steedosData = steedosData;\n  Template.attachments_readonly_view.helpers(InstanceAttachmentTemplate.helpers);\n  body = Blaze.toHTMLWithData(Template.attachments_readonly_view);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getRelatedInstancesView = function(user, space, instance, options) {\n  var body, relatedInstancesCompiled, relatedInstancesHtml, relatedInstancesRenderFunction, steedosData;\n  steedosData = _getTemplateData(user, space, instance);\n  steedosData.absolute = false;\n  if (options != null ? options.absolute : void 0) {\n    steedosData.absolute = true;\n  }\n  relatedInstancesHtml = _getViewHtml('client/views/instance/related_instances.html');\n  relatedInstancesCompiled = SpacebarsCompiler.compile(relatedInstancesHtml, {\n    isBody: true\n  });\n  relatedInstancesRenderFunction = eval(relatedInstancesCompiled);\n  Template.related_instances_view = new Blaze.Template(\"related_instances_view\", relatedInstancesRenderFunction);\n  Template.related_instances_view.steedosData = steedosData;\n  Template.related_instances_view.helpers(RelatedInstances.helpers);\n  body = Blaze.toHTMLWithData(Template.related_instances_view, steedosData);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getRelatedRecordsView = function(user, space, instance, options) {\n  var body, relatedRecordsCompiled, relatedRecordsHtml, relatedRecordsRenderFunction, steedosData;\n  steedosData = _getTemplateData(user, space, instance);\n  steedosData.absolute = false;\n  if (options != null ? options.absolute : void 0) {\n    steedosData.absolute = true;\n  }\n  relatedRecordsHtml = _getViewHtml('client/views/instance/related_records.html');\n  relatedRecordsCompiled = SpacebarsCompiler.compile(relatedRecordsHtml, {\n    isBody: true\n  });\n  relatedRecordsRenderFunction = eval(relatedRecordsCompiled);\n  Template.related_records_view = new Blaze.Template(\"related_records_view\", relatedRecordsRenderFunction);\n  Template.related_records_view.steedosData = steedosData;\n  Template.related_records_view.helpers(RelatedRecords.helpers);\n  body = Blaze.toHTMLWithData(Template.related_records_view, steedosData);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getOnLoadScript = function(instance) {\n  var form_script, form_version;\n  form_version = WorkflowManager.getFormVersion(instance.form, instance.form_version);\n  form_script = form_version.form_script;\n  if (form_script && form_script.replace(/\\n/g, \"\").replace(/\\s/g, \"\").length > 0) {\n    form_script = \"CoreForm = {};CoreForm.instanceform = {};\" + form_script;\n    return form_script += \";if(CoreForm.form_OnLoad){window.onload = CoreForm.form_OnLoad();}\";\n  } else {\n    return form_script = \"\";\n  }\n};\n\nInstanceReadOnlyTemplate.getInstanceHtml = function(user, space, instance, options) {\n  var allCssLink, attachment, body, creatorService, cssHref, form, formDescription, formDescriptionHtml, html, ins_record_ids, instanceBoxStyle, instance_style, locale, onLoadScript, openFileScript, ref, ref1, related_instances, related_records, showTracesBtn, showTracesScript, trace, traceCheck, width;\n  body = InstanceReadOnlyTemplate.getInstanceView(user, space, instance, options);\n  onLoadScript = InstanceReadOnlyTemplate.getOnLoadScript(instance);\n  creatorService = (ref = Meteor.settings[\"public\"].webservices) != null ? (ref1 = ref.creator) != null ? ref1.url : void 0 : void 0;\n  ins_record_ids = instance.record_ids;\n  locale = _getLocale(user);\n  openFileScript = \"if(window.isNode && isNode()){\\n\tattachs = document.getElementsByClassName(\\\"ins_attach_href\\\");\\n\tfor(var i = 0; i < attachs.length; i++){\\n\t\tattach = attachs[i];\\n\t\tattach.addEventListener(\\\"click\\\", function(e){\\n\t\t\tif(isImage(this.dataset.type) || isHtml(this.dataset.type)){\\n\t\t\t\te.preventDefault();\\n\t\t\t\topenWindow(\\\"/api/files/instances/\\\" + this.dataset.id);\\n\t\t\t}else if(nw_core.canOpenFile(this.dataset.name)){\\n\t\t\t\te.preventDefault();\\n\t\t\t\tnw_core.openFile(this.href, this.dataset.name)\\n\t\t\t}\\n\t\t});\\n\t}\\n}\\n\\nvar flow = \\\"\" + instance.flow + \"\\\";\\nvar space = \\\"\" + instance.space + \"\\\";\\n\\nfunction getCookie(name){\\n\tlet pattern = RegExp(name + \\\"=.[^;]*\\\")\\n\tlet matched = document.cookie.match(pattern)\\n\tif(matched){\\n\t\tlet cookie = matched[0].split('=')\\n\t\treturn cookie[1]\\n\t}\\n\treturn ''\\n}\\n\\nvar records = document.getElementsByClassName(\\\"ins-related-records\\\");\\nfor(var i = 0; i < records.length; i++){\\n\t\tvar record = records[i];\\n\t\trecord.addEventListener(\\\"click\\\", function(e){\\n\t\t\tvar creatorService = \\\"\" + creatorService + \"\\\"\\n\t\t\tvar ins_record_ids = \" + (JSON.stringify(ins_record_ids)) + \"\\n\t\t\tif(creatorService && ins_record_ids && ins_record_ids.length > 0){\\n\t\t\t\tvar objcetName = ins_record_ids[0].o\\n\t\t\t\tvar id = ins_record_ids[0].ids[0]\\n\t\t\t\tvar uobj = {};\\n\t\t\t\tuobj[\\\"X-User-Id\\\"] = getCookie(\\\"X-User-Id\\\");\\n\t\t\t\tuobj[\\\"X-Auth-Token\\\"] = getCookie(\\\"X-Auth-Token\\\");\\n\t\t\t\tredirectUrl = creatorService + \\\"app/-/\\\" + objcetName + \\\"/view/\\\" + id + \\\"?\\\" + $.param(uobj);\\n\t\t\t\topenWindow(redirectUrl);\\n\t\t\t}\\n\t\t});\\n\t}\\n\";\n  if (!Steedos.isMobile()) {\n    form = db.forms.findOne(instance.form);\n    if ((form != null ? form.instance_style : void 0) === 'table') {\n      instance_style = \"instance-table\";\n    }\n  }\n  if ((options != null ? options.templateName : void 0) === 'table') {\n    instance_style = \"instance-table\";\n  }\n  if (options != null ? options.instance_style : void 0) {\n    instance_style = options.instance_style;\n  }\n  if (!options || options.showTrace === true) {\n    trace = InstanceReadOnlyTemplate.getTracesView(user, space, instance);\n  } else {\n    trace = \"\";\n  }\n  instanceBoxStyle = \"\";\n  if (instance && instance.final_decision) {\n    if (instance.final_decision === \"approved\") {\n      instanceBoxStyle = \"box-success\";\n    } else if (instance.final_decision === \"rejected\") {\n      instanceBoxStyle = \"box-danger\";\n    }\n  }\n  if (!options || options.showAttachments === true) {\n    attachment = InstanceReadOnlyTemplate.getAttachmentView(user, space, instance);\n    related_instances = InstanceReadOnlyTemplate.getRelatedInstancesView(user, space, instance, options);\n    related_records = InstanceReadOnlyTemplate.getRelatedRecordsView(user, space, instance, options);\n  } else {\n    attachment = \"\";\n    related_instances = \"\";\n    related_records = \"\";\n  }\n  width = \"960px\";\n  if (options != null ? options.width : void 0) {\n    width = \"\";\n  }\n  cssHref = Meteor.absoluteUrl(\"steedos-css\");\n  allCssLink = \"<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" class=\\\"__meteor-css__\\\" href=\\\"\" + cssHref + \"\\\">\";\n  traceCheck = \"\";\n  if (!_.isEmpty(trace)) {\n    traceCheck = \"checked\";\n  }\n  if ((options != null ? options.tagger : void 0) === 'email' || (options != null ? options.editable : void 0)) {\n    showTracesBtn = \"\";\n  } else {\n    showTracesBtn = \"<div class=\\\"navigation-bar btn-group no-print\\\" style=\\\"min-width: 600px; z-index: 999\\\">\\n\t<div class=\\\"print-tool\\\">\\n\t\t<label class=\\\"cbx-label\\\"><input type=\\\"checkbox\\\" class=\\\"cbx-print cbx-print-attachments\\\" id=\\\"cbx-print-attachments\\\" checked=\\\"checked\\\"><span>\" + (TAPi18n.__('instance_attachment', {}, locale)) + \"</span></label>\\n\t\t<label class=\\\"cbx-label\\\"><input type=\\\"checkbox\\\" class=\\\"cbx-print cbx-print-traces\\\" id=\\\"cbx-print-traces\\\" checked=\\\"\" + traceCheck + \"\\\"><span>\" + (TAPi18n.__('instance_approval_history', {}, locale)) + \"</span></label>\\n\t</div>\\n</div>\";\n  }\n  showTracesScript = \"$( document ).ready(function(){\\n\tvar b = document.getElementById('cbx-print-traces');\\n\tvar t = document.getElementsByClassName('instance-traces')[0];\\n\tif (b && b.checked && t){\\n\t\tt.style = 'display: block;'\\n\t} else if(t){\\n\t\tt.style = 'display: none;'\\n\t}\\n\tif(b){\\n\t\tb.addEventListener('change', function(e){\\n\t\t\tif (e.target.checked){\\n\t\t\t\tt.style = 'display: block;'\\n\t\t\t} else {\\n\t\t\t\tt.style = 'display: none;'\\n\t\t\t}\\n\t\t});\\n\t}\\n\\n\\n\tvar attachmentsCheckbox = document.getElementById('cbx-print-attachments');\\n\tvar attachmentsView = document.getElementsByClassName('attachments-section')[0];\\n\tif (attachmentsCheckbox && attachmentsCheckbox.checked && attachmentsView){\\n\t\tattachmentsView.style = 'display: block;'\\n\t} else if(attachmentsView){\\n\t\tattachmentsView.style = 'display: none;'\\n\t}\\n\tif(attachmentsCheckbox){\\n\t\tattachmentsCheckbox.addEventListener('change', function(e){\\n\t\t\tif (e.target.checked){\\n\t\t\t\tattachmentsView.style = 'display: block;'\\n\t\t\t} else {\\n\t\t\t\tattachmentsView.style = 'display: none;'\\n\t\t\t}\\n\t\t});\\n\t}\\n});\\n\";\n  if (options != null ? options.styles : void 0) {\n    allCssLink = \"\";\n  }\n  form = db.forms.findOne({\n    _id: instance.form\n  });\n  formDescriptionHtml = \"\";\n  if (form) {\n    formDescription = form.description;\n    if (formDescription) {\n      formDescription = formDescription.replace(/\\n/g, \"<br/>\");\n      formDescriptionHtml = \"<div class=\\\"box-header  with-border instance-header\\\">\\n\t<div>\\n\t\t\" + formDescription + \"\\n\t</div>\\n</div>\";\n    }\n  }\n  html = \"<!DOCTYPE html>\\n<html>\\n\t<head>\\n\t\t<meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=UTF-8\\\"/>\\n\t\t\" + allCssLink + \"\\n\t\t<script src=\\\"https://www.steedos.com/website/libs/jquery.min.js\\\" type=\\\"text/javascript\\\"></script>\\n\t\t<script src=\\\"/js/nw_core.js\\\" type=\\\"text/javascript\\\"></script>\\n\t\t\" + (options.plugins || \"\") + \"\\n\\n\t\t<style>\\n\t\t\t.steedos{\\n\t\t\t\twidth: \" + width + \";\\n\t\t\t\tmargin-left: auto;\\n\t\t\t\tmargin-right: auto;\\n\t\t\t}\\n\\n\t\t\t.instance-view .instance-name{\\n\t\t\t\tdisplay: inline !important\\n\t\t\t}\\n\t\t\t.box-tools{\\n\t\t\t\tdisplay: none;\\n\t\t\t}\\n\t\t\t.box.collapsed-box .box-body,.box.collapsed-box .box-footer {\\n\t\t\t  display: block;\\n\t\t\t}\\n\\n\t\t\tbody{\\n\t\t\t\tbackground: azure !important;\\n\t\t\t}\\n\\n\t\t\t.instance-view .instance-traces{\\n\t\t\t\tpadding-left: 15px;\\n\t\t\t\tpadding-right: 15px;\\n\t\t\t}\\n\\n\t\t\t\" + ((options != null ? options.styles : void 0) || \"\") + \"\\n\t\t</style>\\n\t</head>\\n\t<body>\\n\t\t<div class=\\\"steedos workflow instance-print\\\">\\n\t\t\t<div class=\\\"skin-green skin-admin-lte\\\">\\n\t\t\t\t<div class=\\\"wrapper\\\">\\n\t\t\t\t\t<div class=\\\"content-wrapper\\\">\\n\t\t\t\t\t\t\" + showTracesBtn + \"\\n\t\t\t\t\t\t<div class=\\\"instance-print\\\">\\n\t\t\t\t\t\t\t<div class=\\\"instance \" + instance_style + \"\\\">\\n\t\t\t\t\t\t\t\t<form name=\\\"instanceForm\\\">\\n\t\t\t\t\t\t\t\t\t<div class=\\\"instance-form box \" + instanceBoxStyle + \"\\\">\\n\t\t\t\t\t\t\t\t\t\t\" + formDescriptionHtml + \"\\n\t\t\t\t\t\t\t\t\t\t<div class=\\\"box-body\\\">\\n\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"col-md-12\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t<div class='attachments-section'>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\" + attachment + \"\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\" + related_instances + \"\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\" + related_records + \"\\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\" + body + \"\\n\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t</form>\\n\t\t\t\t\t\t\t\t\" + trace + \"\\n\t\t\t\t\t\t\t</div>\\n\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t</div>\\n\t\t</div>\\n\t</body>\\n\t<script>\" + openFileScript + \";\" + onLoadScript + \";\" + showTracesScript + \"</script>\\n</html>\";\n  return html;\n};\n","TemplateManager = {};\r\n\r\nformId = 'instanceform';\r\n\r\n\r\nTemplateManager.instance_title = ()->\r\n\tpageTitle = \"\"\"\r\n\t\t{{instance.name}}\r\n\t\"\"\"\r\n\r\n\tpageTitleTrClass = \"instance-name\"\r\n\r\n\tif CoreForm?.pageTitleFieldName\r\n\t\tpageTitle = \"\"\"\r\n\t\t\t\t{{> afFormGroup name=\"#{CoreForm.pageTitleFieldName}\" label=false}}\r\n\t\t\"\"\"\r\n\t\tpageTitleTrClass = \"\"\r\n\r\n\tif CoreForm?.pageTitle\r\n\t\tpageTitle = \"\"\"\r\n\t\t\t#{CoreForm.pageTitle}\r\n\t\t\"\"\"\r\n\t\tpageTitleTrClass = \"\"\r\n\r\n\tval =\r\n\t\tpageTitle: pageTitle\r\n\t\tpageTitleTrClass: pageTitleTrClass\r\n\r\n\treturn val\r\n\r\nTemplateManager.handleTableTemplate = (instance, _export) ->\r\n\r\n\ttemplate = \"\"\"\r\n\t<div class='instance-template'>\r\n\t\t<table class=\"table-page-title form-table no-border text-align-center\" style=\"width: 100%;display: inline-table;\">\r\n\t\t\t<tr class=\"#{this.instance_title().pageTitleTrClass}\">\r\n\t\t\t\t<td class=\"instance-table-name-td page-title\">\r\n\t\t\t\t\t#{this.instance_title().pageTitle}\r\n\t\t\t\t</td>\r\n\t\t\t</tr>\r\n\r\n\t\t</table>\r\n\t\t<table class=\"table-page-body form-table\">\r\n\t\t\t\t<tr style=\"height:0px\">\r\n\t\t\t\t\t<th style='width: 16%'></th>\r\n\t\t\t\t\t<th></th>\r\n\t\t\t\t\t<th style='width: 16%'></th>\r\n\t\t\t\t\t<th></th>\r\n\t\t\t\t</tr>\r\n\t\"\"\";\r\n\r\n\ttable_fields = InstanceformTemplate.helpers.table_fields(instance)\r\n\r\n\ttable_fields.forEach (table_field)->\r\n\r\n\t\trequired = \"\"\r\n\t\tif !CoreForm?.pageTitleFieldName || CoreForm?.pageTitleFieldName != table_field.code\r\n\t\t\tif table_field.is_required\r\n\t\t\t\trequired = \"is-required\"\r\n\r\n\t\t\tif _export\r\n\t\t\t\trequired = \"\";\r\n\r\n\t\t\tpureCode = Steedos.removeSpecialCharacter(table_field.code);\r\n\r\n\t\t\tif InstanceformTemplate.helpers.isOpinionField(table_field)\r\n\t\t\t\ttemplate += table_field.tr_start\r\n\t\t\t\ttemplate += \"\"\"\r\n\t\t\t\t\t<td class=\"td-title #{required}\">\r\n\t\t\t\t\t\t{{afFieldLabelText name=\"#{table_field.code}\"}}\r\n\t\t\t\t\t</td>\r\n\t\t\t\t\t<td class=\"td-field opinion-field opinion-field-#{pureCode} automatic\" colspan = \"#{table_field.td_colspan}\">\r\n\t\t\t\t\t\t{{> instanceSignText name=\"#{table_field.code}\"}}\r\n\t\t\t\t\t</td>\r\n\t\t\t\t\"\"\"\r\n\t\t\t\ttemplate += table_field.tr_end\r\n\t\t\telse\r\n\t\t\t\tif InstanceformTemplate.helpers.includes(table_field.type, 'section,table')\r\n\t\t\t\t\ttemplate += table_field.tr_start\r\n\t\t\t\t\ttemplate += \"\"\"\r\n\t\t\t\t\t\t<td class=\"td-childfield td-childfield-#{pureCode}\" colspan = \"#{table_field.td_colspan}\">\r\n\t\t\t\t\t\t   {{> afFormGroup name=\"#{table_field.code}\" label=false}}\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\"\"\"\r\n\t\t\t\t\ttemplate += table_field.tr_end\r\n\t\t\t\telse\r\n\t\t\t\t\ttemplate += table_field.tr_start\r\n\r\n\t\t\t\t\tif _export\r\n\t\t\t\t\t\ttitle_permission = \"\"\r\n\t\t\t\t\t\tfield_permission = \"\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\ttitle_permission = \"title-\" + table_field.permission\r\n\t\t\t\t\t\tfield_permission = \"field-\" + table_field.permission\r\n\r\n\t\t\t\t\ttemplate += \"\"\"\r\n\t\t\t\t\t\t<td class=\"td-title td-title-#{pureCode} #{title_permission} #{required}\">\r\n\t\t\t\t\t\t\t{{afFieldLabelText name=\"#{table_field.code}\"}}\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"td-field td-field-#{pureCode} #{field_permission}\" colspan = \"#{table_field.td_colspan}\">\r\n\t\t\t\t\t\t\t{{> afFormGroup name=\"#{table_field.code}\" label=false}}\r\n\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\"\"\"\r\n\t\t\t\t\ttemplate += table_field.tr_end\r\n\r\n\ttemplate += \"\"\"\r\n\t\t</table>\r\n\r\n\t\t<table class=\"table-page-footer form-table no-border\">\r\n\t\t\t<tr class=\"applicant-wrapper\">\r\n\t\t\t\t<td class=\"nowrap\">\r\n\t\t\t\t\t<div class='inline-left'>\r\n\t\t\t\t\t\t<label class=\"control-label\">{{_t \"instance_initiator\"}}ï¼š</label>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class='instance-table-wrapper-td inline-left'>\r\n\t\t\t\t\t\t{{>Template.dynamic  template=\"afSelectUser\" data=applicantContext}}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</td>\r\n\t\t\t\t<td class=\"nowrap\">\r\n\t\t\t\t\t<div class='pull-left'>\r\n\t\t\t\t\t\t<div class='inline-left'>\r\n\t\t\t\t\t\t\t<label>{{_t \"instance_submit_date\"}}ï¼š</label>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class='inline-right'>\r\n\t\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t\t{{formatDate instance.submit_date '{\"format\":\"YYYY-MM-DD\"}'}}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</td>\r\n\t\t\t</tr>\r\n\t\t</table>\r\n\t</div>\r\n\t\"\"\"\r\n\treturn template\r\n\r\n#æ­¤å¤„æ¨¡æ¿å…¬ç”¨ä¸Žï¼šinstance ç¼–è¾‘ã€æŸ¥çœ‹ã€æ‰“å°ã€è½¬å‘æ—¶ç”Ÿæˆé™„ä»¶ã€å‘é€é‚®ä»¶bodyéƒ¨åˆ†(table æ¨¡æ¿)\r\n#å¦‚æžœæœ‰ä¿®æ”¹ï¼Œè¯·æµ‹è¯•ç¡®è®¤å…¶ä»–åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚\r\nTemplateManager._template =\r\n\tdefault: (instance)->\r\n\r\n\t\ttemplate = \"\"\"\r\n\t\t\t<div class=\"with-border col-md-12\">\r\n\t\t\t\t<div class=\"instance-name\">\r\n\t\t\t\t\t<h3 class=\"box-title\">#{TemplateManager.instance_title().pageTitle}</h3>\r\n\t\t\t\t\t<span class=\"help-block\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<span class=\"help-block\"></span>\r\n\t\t\t</div>\r\n\t\t\t{{#each steedos_form.fields}}\r\n\t\t\t\t{{#if isOpinionField this}}\r\n\t\t\t\t\t<div class=\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\">\r\n\t\t\t\t\t\t<div class=\"form-group automatic opinion-field-{{this.code}}\">\r\n\t\t\t\t\t\t\t<label class=\"control-label\">{{afFieldLabelText name=this.code}}</label>\r\n\r\n\t\t\t\t\t\t\t{{> instanceSignText name=this.code}}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t{{else}}\r\n\t\t\t\t\t{{#if includes this.type 'section,table'}}\r\n\t\t\t\t\t\t<div class=\"col-md-12 field-{{this.code}}\">\r\n\t\t\t\t\t\t\t{{> afFormGroup name=this.code label=false}}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t{{else}}\r\n\t\t\t\t\t\t<div class=\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\">\r\n\t\t\t\t\t\t{{> afFormGroup name=this.code}}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t{{/if}}\r\n\t\t\t\t{{/if}}\r\n\t\t\t{{/each}}\r\n\t\t\t<div class=\"col-md-12\">\r\n\t\t\t\t<div class=\"applicant-wrapper form-group form-horizontal\">\r\n\t\t\t\t<div class=\"input-group\">\r\n\t\t\t\t\t<div class=\"input-group-addon\">\r\n\t\t\t\t\t  {{_t \"instance_initiator\"}}&nbsp;:\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t{{>Template.dynamic  template=\"afSelectUser\" data=applicantContext}}\r\n\t\t\t\t  </div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\"\"\"\r\n\t\treturn template\r\n\r\n\ttable: (instance)->\r\n\t\treturn TemplateManager.handleTableTemplate(instance)\r\n#\ttable: '''\r\n#\t\t<table class=\"box-header  with-border\" style=\"width: 100%;display: inline-table;\">\r\n#\t\t\t<tr class=\"instance-name\">\r\n#\t\t\t\t<td class=\"instance-table-name-td\">\r\n#\t\t\t\t\t<h3 class=\"box-title\">{{instance.name}}</h3>\r\n#\t\t\t\t\t<span class=\"help-block\"></span>\r\n#\t\t\t\t</td>\r\n#\t\t\t</tr>\r\n#            <tr class=\"applicant-wrapper\">\r\n#\t\t\t\t<td class=\"instance-table-wrapper-td\">\r\n#\t\t\t\t\t<label class=\"control-label\">{{_t \"instance_initiator\"}}&nbsp;:</label>\r\n#\t\t\t\t\t{{>Template.dynamic  template=\"afSelectUser\" data=applicantContext}}\r\n#\t\t\t\t</td>\r\n#\t\t\t</tr>\r\n#        </table>\r\n#\t\t<table class=\"form-table\">\r\n#\t\t    {{#each table_fields}}\r\n#\t\t\t\t{{#if isOpinionField this}}\r\n#\t\t\t\t\t{{{tr_start}}}\r\n#\t\t\t\t\t\t<td class=\"td-title {{#if is_required}}is-required{{/if}}\">\r\n#\t\t\t\t\t\t\t{{afFieldLabelText name=this.code}}\r\n#\t\t\t\t\t\t</td>\r\n#\t\t\t\t\t\t<td class=\"td-field opinion-field\" colspan = '{{td_colspan}}'>\r\n#\t\t\t\t\t\t\t{{> instanceSignText step=(getOpinionFieldStepName this) default=''}}\r\n#\t\t\t\t\t\t</td>\r\n#\t\t\t\t\t{{{tr_end}}}\r\n#\t\t\t\t{{else}}\r\n#\t\t\t\t\t{{#if includes this.type 'section,table'}}\r\n#\t\t\t\t\t\t{{{tr_start}}}\r\n#\t\t\t\t\t\t\t<td class=\"td-childfield\" colspan = '{{td_colspan}}'>\r\n#\t\t\t\t\t\t\t   {{> afFormGroup name=this.code label=false}}\r\n#\t\t\t\t\t\t\t</td>\r\n#\t\t\t\t\t\t{{{tr_end}}}\r\n#\t\t\t\t\t{{else}}\r\n#\t\t\t\t\t\t{{{tr_start}}}\r\n#\t\t\t\t\t\t\t<td class=\"td-title {{#if is_required}}is-required{{/if}}\">\r\n#\t\t\t\t\t\t\t\t{{afFieldLabelText name=this.code}}\r\n#\t\t\t\t\t\t\t</td>\r\n#\t\t\t\t\t\t\t<td class=\"td-field {{permission}}\" colspan = '{{td_colspan}}'>\r\n#\t\t\t\t\t\t\t\t{{> afFormGroup name=this.code label=false}}\r\n#\t\t\t\t\t\t\t</td>\r\n#\t\t\t\t\t\t{{{tr_end}}}\r\n#\t\t\t\t\t{{/if}}\r\n#\t\t\t\t{{/if}}\r\n#\r\n#\t\t    {{/each}}\r\n#\t\t</table>\r\n#\t'''\r\n\r\nTemplateManager._templateHelps =\r\n\tapplicantContext: ->\r\n\t\tsteedos_instance = WorkflowManager.getInstance();\r\n\t\tdata = {\r\n\t\t\tname: 'ins_applicant',\r\n\t\t\tatts: {\r\n\t\t\t\tname: 'ins_applicant',\r\n\t\t\t\tid: 'ins_applicant',\r\n\t\t\t\tclass: 'selectUser form-control',\r\n\t\t\t\tstyle: 'padding:6px 12px;width:140px;display:inline'\r\n\t\t\t}\r\n\t\t}\r\n#\t\tif not steedos_instance || steedos_instance.state != \"draft\"\r\n\t\tdata.atts.disabled = true\r\n\t\treturn data;\r\n\r\ninstanceId: ->\r\n\treturn 'instanceform';#\"instance_\" + Session.get(\"instanceId\");\r\n\r\nform_types: ->\r\n\tif ApproveManager.isReadOnly()\r\n\t\treturn 'disabled';\r\n\telse\r\n\t\treturn 'method';\r\n\r\nsteedos_form: ->\r\n\tform_version = WorkflowManager.getInstanceFormVersion();\r\n\tif form_version\r\n\t\treturn form_version\r\n\r\ninnersubformContext: (obj)->\r\n\tdoc_values = WorkflowManager_format.getAutoformSchemaValues();\r\n\tobj[\"tableValues\"] = if doc_values then doc_values[obj.code] else []\r\n\tobj[\"formId\"] = formId;\r\n\treturn obj;\r\n\r\ninstance: ->\r\n\tSession.get(\"change_date\")\r\n\tif (Session.get(\"instanceId\"))\r\n\t\tsteedos_instance = WorkflowManager.getInstance();\r\n\t\treturn steedos_instance;\r\n\r\nequals: (a, b) ->\r\n\treturn (a == b)\r\n\r\nincludes: (a, b) ->\r\n\treturn b.split(',').includes(a);\r\n\r\nfields: ->\r\n\tform_version = WorkflowManager.getInstanceFormVersion();\r\n\tif form_version\r\n\t\treturn new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\r\n\r\ndoc_values: ->\r\n\tWorkflowManager_format.getAutoformSchemaValues();\r\n\r\ninstance_box_style: ->\r\n\tbox = Session.get(\"box\")\r\n\tif box == \"inbox\" || box == \"draft\"\r\n\t\tjudge = Session.get(\"judge\")\r\n\t\tif judge\r\n\t\t\tif (judge == \"approved\")\r\n\t\t\t\treturn \"box-success\"\r\n\t\t\telse if (judge == \"rejected\")\r\n\t\t\t\treturn \"box-danger\"\r\n\tins = WorkflowManager.getInstance();\r\n\tif ins && ins.final_decision\r\n\t\tif ins.final_decision == \"approved\"\r\n\t\t\treturn \"box-success\"\r\n\t\telse if (ins.final_decision == \"rejected\")\r\n\t\t\treturn \"box-danger\"\r\n\r\n\r\nTemplateManager.getTemplate = (instance, templateName) ->\r\n\tflow = db.flows.findOne(instance.flow);\r\n\tform = db.forms.findOne(instance.form);\r\n\r\n\tif templateName\r\n\t\tif templateName == 'table'\r\n\t\t\treturn TemplateManager._template.table(instance)\r\n\t\treturn TemplateManager._template.default(instance)\r\n\r\n\tif Session?.get(\"instancePrint\")\r\n\t\tif flow?.print_template\r\n\t\t\treturn \"<div class='instance-template'>\" + flow.print_template + \"</div>\"\r\n\t\telse\r\n\t\t\tif flow?.instance_template\r\n\t\t\t\treturn \"<div class='instance-template'>\" + flow.instance_template + \"</div>\"\r\n\t\t\telse\r\n\t\t\t\treturn TemplateManager._template.table(instance)\r\n\telse\r\n\t\tif Steedos.isMobile()\r\n\t\t\treturn TemplateManager._template.default(instance)\r\n\r\n\t\tif flow?.instance_template\r\n\t\t\treturn \"<div class='instance-template'>\" + flow.instance_template + \"</div>\"\r\n\r\n\t\tif form?.instance_style\r\n\t\t\tif form.instance_style == 'table'\r\n\t\t\t\treturn TemplateManager._template.table(instance)\r\n\t\t\treturn TemplateManager._template.default(instance)\r\n\t\telse\r\n\t\t\treturn TemplateManager._template.default(instance)\r\n\r\n#TemplateManager.exportTemplate = (flowId) ->\r\n#\ttemplate = TemplateManager.getTemplate(flowId);\r\n#\r\n#\tflow = WorkflowManager.getFlow(flowId);\r\n#\r\n#\tif flow?.instance_template\r\n#\t\treturn template;\r\n#\r\n#\treturn template;\r\n\r\n","var formId;                 \n\nTemplateManager = {};\n\nformId = 'instanceform';\n\nTemplateManager.instance_title = function() {\n  var pageTitle, pageTitleTrClass, val;\n  pageTitle = \"{{instance.name}}\";\n  pageTitleTrClass = \"instance-name\";\n  if (typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) {\n    pageTitle = \"{{> afFormGroup name=\\\"\" + CoreForm.pageTitleFieldName + \"\\\" label=false}}\";\n    pageTitleTrClass = \"\";\n  }\n  if (typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitle : void 0) {\n    pageTitle = \"\" + CoreForm.pageTitle;\n    pageTitleTrClass = \"\";\n  }\n  val = {\n    pageTitle: pageTitle,\n    pageTitleTrClass: pageTitleTrClass\n  };\n  return val;\n};\n\nTemplateManager.handleTableTemplate = function(instance, _export) {\n  var table_fields, template;\n  template = \"<div class='instance-template'>\\n\t<table class=\\\"table-page-title form-table no-border text-align-center\\\" style=\\\"width: 100%;display: inline-table;\\\">\\n\t\t<tr class=\\\"\" + (this.instance_title().pageTitleTrClass) + \"\\\">\\n\t\t\t<td class=\\\"instance-table-name-td page-title\\\">\\n\t\t\t\t\" + (this.instance_title().pageTitle) + \"\\n\t\t\t</td>\\n\t\t</tr>\\n\\n\t</table>\\n\t<table class=\\\"table-page-body form-table\\\">\\n\t\t\t<tr style=\\\"height:0px\\\">\\n\t\t\t\t<th style='width: 16%'></th>\\n\t\t\t\t<th></th>\\n\t\t\t\t<th style='width: 16%'></th>\\n\t\t\t\t<th></th>\\n\t\t\t</tr>\";\n  table_fields = InstanceformTemplate.helpers.table_fields(instance);\n  table_fields.forEach(function(table_field) {\n    var field_permission, pureCode, required, title_permission;\n    required = \"\";\n    if (!(typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) || (typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) !== table_field.code) {\n      if (table_field.is_required) {\n        required = \"is-required\";\n      }\n      if (_export) {\n        required = \"\";\n      }\n      pureCode = Steedos.removeSpecialCharacter(table_field.code);\n      if (InstanceformTemplate.helpers.isOpinionField(table_field)) {\n        template += table_field.tr_start;\n        template += \"<td class=\\\"td-title \" + required + \"\\\">\\n\t{{afFieldLabelText name=\\\"\" + table_field.code + \"\\\"}}\\n</td>\\n<td class=\\\"td-field opinion-field opinion-field-\" + pureCode + \" automatic\\\" colspan = \\\"\" + table_field.td_colspan + \"\\\">\\n\t{{> instanceSignText name=\\\"\" + table_field.code + \"\\\"}}\\n</td>\";\n        return template += table_field.tr_end;\n      } else {\n        if (InstanceformTemplate.helpers.includes(table_field.type, 'section,table')) {\n          template += table_field.tr_start;\n          template += \"<td class=\\\"td-childfield td-childfield-\" + pureCode + \"\\\" colspan = \\\"\" + table_field.td_colspan + \"\\\">\\n   {{> afFormGroup name=\\\"\" + table_field.code + \"\\\" label=false}}\\n</td>\";\n          return template += table_field.tr_end;\n        } else {\n          template += table_field.tr_start;\n          if (_export) {\n            title_permission = \"\";\n            field_permission = \"\";\n          } else {\n            title_permission = \"title-\" + table_field.permission;\n            field_permission = \"field-\" + table_field.permission;\n          }\n          template += \"<td class=\\\"td-title td-title-\" + pureCode + \" \" + title_permission + \" \" + required + \"\\\">\\n\t{{afFieldLabelText name=\\\"\" + table_field.code + \"\\\"}}\\n</td>\\n<td class=\\\"td-field td-field-\" + pureCode + \" \" + field_permission + \"\\\" colspan = \\\"\" + table_field.td_colspan + \"\\\">\\n\t{{> afFormGroup name=\\\"\" + table_field.code + \"\\\" label=false}}\\n</td>\";\n          return template += table_field.tr_end;\n        }\n      }\n    }\n  });\n  template += \"\t</table>\\n\\n\t<table class=\\\"table-page-footer form-table no-border\\\">\\n\t\t<tr class=\\\"applicant-wrapper\\\">\\n\t\t\t<td class=\\\"nowrap\\\">\\n\t\t\t\t<div class='inline-left'>\\n\t\t\t\t\t<label class=\\\"control-label\\\">{{_t \\\"instance_initiator\\\"}}ï¼š</label>\\n\t\t\t\t</div>\\n\t\t\t\t<div class='instance-table-wrapper-td inline-left'>\\n\t\t\t\t\t{{>Template.dynamic  template=\\\"afSelectUser\\\" data=applicantContext}}\\n\t\t\t\t</div>\\n\t\t\t</td>\\n\t\t\t<td class=\\\"nowrap\\\">\\n\t\t\t\t<div class='pull-left'>\\n\t\t\t\t\t<div class='inline-left'>\\n\t\t\t\t\t\t<label>{{_t \\\"instance_submit_date\\\"}}ï¼š</label>\\n\t\t\t\t\t</div>\\n\t\t\t\t\t<div class='inline-right'>\\n\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t{{formatDate instance.submit_date '{\\\"format\\\":\\\"YYYY-MM-DD\\\"}'}}\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t</td>\\n\t\t</tr>\\n\t</table>\\n</div>\";\n  return template;\n};\n\nTemplateManager._template = {\n  \"default\": function(instance) {\n    var template;\n    template = \"<div class=\\\"with-border col-md-12\\\">\\n\t<div class=\\\"instance-name\\\">\\n\t\t<h3 class=\\\"box-title\\\">\" + (TemplateManager.instance_title().pageTitle) + \"</h3>\\n\t\t<span class=\\\"help-block\\\"></span>\\n\t</div>\\n\t<span class=\\\"help-block\\\"></span>\\n</div>\\n{{#each steedos_form.fields}}\\n\t{{#if isOpinionField this}}\\n\t\t<div class=\\\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\\\">\\n\t\t\t<div class=\\\"form-group automatic opinion-field-{{this.code}}\\\">\\n\t\t\t\t<label class=\\\"control-label\\\">{{afFieldLabelText name=this.code}}</label>\\n\\n\t\t\t\t{{> instanceSignText name=this.code}}\\n\t\t\t</div>\\n\t\t</div>\\n\t{{else}}\\n\t\t{{#if includes this.type 'section,table'}}\\n\t\t\t<div class=\\\"col-md-12 field-{{this.code}}\\\">\\n\t\t\t\t{{> afFormGroup name=this.code label=false}}\\n\t\t\t</div>\\n\t\t{{else}}\\n\t\t\t<div class=\\\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\\\">\\n\t\t\t{{> afFormGroup name=this.code}}\\n\t\t\t</div>\\n\t\t{{/if}}\\n\t{{/if}}\\n{{/each}}\\n<div class=\\\"col-md-12\\\">\\n\t<div class=\\\"applicant-wrapper form-group form-horizontal\\\">\\n\t<div class=\\\"input-group\\\">\\n\t\t<div class=\\\"input-group-addon\\\">\\n\t\t  {{_t \\\"instance_initiator\\\"}}&nbsp;:\\n\t\t</div>\\n\t\t{{>Template.dynamic  template=\\\"afSelectUser\\\" data=applicantContext}}\\n\t  </div>\\n\t</div>\\n</div>\";\n    return template;\n  },\n  table: function(instance) {\n    return TemplateManager.handleTableTemplate(instance);\n  }\n};\n\nTemplateManager._templateHelps = {\n  applicantContext: function() {\n    var data, steedos_instance;\n    steedos_instance = WorkflowManager.getInstance();\n    data = {\n      name: 'ins_applicant',\n      atts: {\n        name: 'ins_applicant',\n        id: 'ins_applicant',\n        \"class\": 'selectUser form-control',\n        style: 'padding:6px 12px;width:140px;display:inline'\n      }\n    };\n    data.atts.disabled = true;\n    return data;\n  }\n};\n\n({\n  instanceId: function() {\n    return 'instanceform';\n  },\n  form_types: function() {\n    if (ApproveManager.isReadOnly()) {\n      return 'disabled';\n    } else {\n      return 'method';\n    }\n  },\n  steedos_form: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return form_version;\n    }\n  },\n  innersubformContext: function(obj) {\n    var doc_values;\n    doc_values = WorkflowManager_format.getAutoformSchemaValues();\n    obj[\"tableValues\"] = doc_values ? doc_values[obj.code] : [];\n    obj[\"formId\"] = formId;\n    return obj;\n  },\n  instance: function() {\n    var steedos_instance;\n    Session.get(\"change_date\");\n    if (Session.get(\"instanceId\")) {\n      steedos_instance = WorkflowManager.getInstance();\n      return steedos_instance;\n    }\n  },\n  equals: function(a, b) {\n    return a === b;\n  },\n  includes: function(a, b) {\n    return b.split(',').includes(a);\n  },\n  fields: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n    }\n  },\n  doc_values: function() {\n    return WorkflowManager_format.getAutoformSchemaValues();\n  },\n  instance_box_style: function() {\n    var box, ins, judge;\n    box = Session.get(\"box\");\n    if (box === \"inbox\" || box === \"draft\") {\n      judge = Session.get(\"judge\");\n      if (judge) {\n        if (judge === \"approved\") {\n          return \"box-success\";\n        } else if (judge === \"rejected\") {\n          return \"box-danger\";\n        }\n      }\n    }\n    ins = WorkflowManager.getInstance();\n    if (ins && ins.final_decision) {\n      if (ins.final_decision === \"approved\") {\n        return \"box-success\";\n      } else if (ins.final_decision === \"rejected\") {\n        return \"box-danger\";\n      }\n    }\n  }\n});\n\nTemplateManager.getTemplate = function(instance, templateName) {\n  var flow, form;\n  flow = db.flows.findOne(instance.flow);\n  form = db.forms.findOne(instance.form);\n  if (templateName) {\n    if (templateName === 'table') {\n      return TemplateManager._template.table(instance);\n    }\n    return TemplateManager._template[\"default\"](instance);\n  }\n  if (typeof Session !== \"undefined\" && Session !== null ? Session.get(\"instancePrint\") : void 0) {\n    if (flow != null ? flow.print_template : void 0) {\n      return \"<div class='instance-template'>\" + flow.print_template + \"</div>\";\n    } else {\n      if (flow != null ? flow.instance_template : void 0) {\n        return \"<div class='instance-template'>\" + flow.instance_template + \"</div>\";\n      } else {\n        return TemplateManager._template.table(instance);\n      }\n    }\n  } else {\n    if (Steedos.isMobile()) {\n      return TemplateManager._template[\"default\"](instance);\n    }\n    if (flow != null ? flow.instance_template : void 0) {\n      return \"<div class='instance-template'>\" + flow.instance_template + \"</div>\";\n    }\n    if (form != null ? form.instance_style : void 0) {\n      if (form.instance_style === 'table') {\n        return TemplateManager._template.table(instance);\n      }\n      return TemplateManager._template[\"default\"](instance);\n    } else {\n      return TemplateManager._template[\"default\"](instance);\n    }\n  }\n};\n","SteedosTable = {};\r\n\r\nSteedosTable.formId = \"instanceform\";\r\n\r\nSteedosTable.checkItem = function (field, item_index) {\r\n    var fieldObj = SteedosTable.getField(field);\r\n\r\n    var fieldVal = SteedosTable.getItemModalValue(field, item_index);\r\n\r\n    var sf_name = '';\r\n    var rev = true;\r\n    fieldObj.sfields.forEach(function (sf) {\r\n        if (sf.permission == 'editable') {\r\n            sf_name = fieldObj.code + \".\" + sf.code;\r\n            if (!InstanceManager.checkFormFieldValue($(\"[name='\" + sf_name + \"']\")[0], sf_name, fieldVal[sf.code])) {\r\n                rev = false;\r\n            }\r\n        }\r\n    });\r\n\r\n    return rev;\r\n}\r\n\r\nSteedosTable.setTableItemValue = function (field, item_index, item_value) {\r\n\r\n    var tableValue = SteedosTable.getTableValue(field);\r\n    tableValue[item_index] = item_value;\r\n}\r\n\r\nSteedosTable.getTableItemValue = function (field, item_index) {\r\n    return SteedosTable.getTableValue(field)[item_index];\r\n}\r\n\r\nSteedosTable.removeTableItem = function (field, item_index) {\r\n    var item_value = SteedosTable.getTableItemValue(field, item_index);\r\n    item_value.removed = true;\r\n}\r\n\r\nSteedosTable.setTableValue = function (field, value) {\r\n    $(\"table[name='\" + field + \"']\").val({\r\n        val: value\r\n    });\r\n}\r\n\r\nSteedosTable.getTableValue = function (field) {\r\n    return $(\"table[name='\" + field + \"']\").val().val;\r\n}\r\n\r\nSteedosTable.getValidValue = function (field) {\r\n    var value = SteedosTable.getTableValue(field);\r\n\r\n    if (!value) {\r\n        return\r\n    }\r\n\r\n    var validValue = [];\r\n\r\n    value.forEach(function (v) {\r\n        if (!v.removed) {\r\n            validValue.push(v);\r\n        }\r\n    });\r\n    return validValue;\r\n}\r\n\r\n\r\nSteedosTable.handleData = function (field, values) {\r\n\r\n    if (!values || !(values instanceof Array)) {\r\n        return values;\r\n    }\r\n\r\n    var fieldObj = SteedosTable.getField(field);\r\n\r\n    values.forEach(function (v) {\r\n        fieldObj.sfields.forEach(function (f) {\r\n            if (f.type == 'user' || f.type == 'group') {\r\n                var value = v[f.code]\r\n                if (f.is_multiselect) {\r\n                    if (value && value.length > 0 && typeof (value[0]) == 'object') {\r\n                        v[f.code] = v[f.code].getProperty(\"id\");\r\n                    }\r\n                } else {\r\n                    if (value && typeof (value) == 'object') {\r\n                        v[f.code] = v[f.code].id;\r\n                    }\r\n                }\r\n            } else if (f.type == 'dateTime') {\r\n                var value = v[f.code]\r\n                if (value) {\r\n                    if (value.length == 16) {\r\n                        var t = value.split(\"T\");\r\n                        var t0 = t[0].split(\"-\");\r\n                        var t1 = t[1].split(\":\");\r\n\r\n                        year = t0[0];\r\n                        month = t0[1];\r\n                        date = t0[2];\r\n                        hours = t1[0];\r\n                        seconds = t1[1];\r\n                        value = new Date(year, month - 1, date, hours, seconds);\r\n                        v[f.code] = value;\r\n                    }\r\n\r\n                }\r\n            }\r\n        });\r\n    });\r\n    return values;\r\n}\r\n\r\nSteedosTable.getField = function (field) {\r\n    var instanceFields = WorkflowManager.getInstanceFields();\r\n    if (!instanceFields)\r\n        return;\r\n\r\n    var fieldObj = instanceFields.findPropertyByPK(\"code\", field);\r\n\r\n    return fieldObj;\r\n}\r\n\r\n\r\nSteedosTable.getModalData = function (field, index) {\r\n\r\n    var data = {};\r\n\r\n    var fieldObj = SteedosTable.getField(field);\r\n\r\n    if (!fieldObj) {\r\n        return;\r\n    }\r\n\r\n    data.field = fieldObj;\r\n\r\n    data.field.formula = Form_formula.getFormulaFieldVariable(\"Form_formula.field_values\", fieldObj.sfields);\r\n\r\n    data.value = {};\r\n\r\n    data.value[field] = SteedosTable.getTableItemValue(field, index);\r\n\r\n    data.index = index;\r\n\r\n    return data;\r\n}\r\n\r\n\r\n\r\nSteedosTable.getItemModalValue = function (field, item_index) {\r\n\r\n    if (!AutoForm.getFormValues(\"steedos_table_modal_\" + field + \"_\" + item_index)) {\r\n        return {}\r\n    }\r\n\r\n    var item_value = AutoForm.getFormValues(\"steedos_table_modal_\" + field + \"_\" + item_index).insertDoc[field];\r\n    return item_value;\r\n}\r\n\r\n\r\nSteedosTable.addItem = function (field, index, _item_value) {\r\n    var keys = SteedosTable.getKeys(field);\r\n    var item_value = _item_value || SteedosTable.getItemModalValue(field, index);\r\n    $(\"tbody[name='\" + field + \"Tbody']\").append(SteedosTable.getTr(keys, item_value, index, field, true))\r\n\r\n}\r\n\r\nSteedosTable.updateItem = function (field, index, _item_value) {\r\n\r\n    var item = $(\"tr[name='\" + field + \"_item_\" + index + \"']\");\r\n\r\n    var item_value = _item_value || SteedosTable.getItemModalValue(field, index);\r\n\r\n    if (item && item.length > 0) {\r\n        var keys = SteedosTable.getKeys(field);\r\n        var tds = SteedosTable.getRemoveTd(field, index);\r\n\r\n        var sfields = SteedosTable.getField(field).sfields;\r\n\r\n        keys.forEach(function (key) {\r\n            var sfield = sfields.findPropertyByPK(\"code\", key);\r\n\r\n            var value = item_value[key];\r\n\r\n            tds = tds + SteedosTable.getTd(sfield, index, value);\r\n\r\n        });\r\n\r\n        item.empty();\r\n\r\n        item.append(tds);\r\n\r\n    } else {\r\n\r\n        SteedosTable.addItem(field, index);\r\n    }\r\n\r\n    if (SteedosTable.getTableValue(field)) {\r\n\r\n        SteedosTable.setTableItemValue(field, index, item_value);\r\n\r\n        //SteedosTable.valueHash[field][index] = item_value;\r\n\r\n    } else {\r\n        //SteedosTable.valueHash[field] = [item_value];\r\n\r\n        SteedosTable.setTableValue(field, [item_value])\r\n\r\n    }\r\n\r\n    //æ‰§è¡Œä¸»è¡¨å…¬å¼è®¡ç®—\r\n    InstanceManager.runFormula(field);\r\n\r\n}\r\n\r\nSteedosTable.removeItem = function (field, index) {\r\n\r\n    $(\"tr[name='\" + field + \"_item_\" + index + \"']\").hide();\r\n\r\n    SteedosTable.removeTableItem(field, index);\r\n\r\n    InstanceManager.runFormula(field);\r\n}\r\n\r\nSteedosTable.showModal = function (field, index, method) {\r\n\r\n\r\n    var modalData = SteedosTable.getModalData(field, index);\r\n\r\n    modalData.method = method;\r\n\r\n    Modal.show(\"steedosTableModal\", modalData);\r\n\r\n}\r\n\r\nSteedosTable.getKeys = function (field) {\r\n    if (!AutoForm.getCurrentDataForForm(SteedosTable.formId)) {\r\n        return [];\r\n    }\r\n\r\n    var ss = AutoForm.getFormSchema(SteedosTable.formId);\r\n\r\n    var keys = [];\r\n\r\n    if (ss.schema(field + \".$\").type === Object) {\r\n        keys = ss.objectKeys(SimpleSchema._makeGeneric(field) + '.$')\r\n    }\r\n\r\n    return keys;\r\n\r\n}\r\n\r\nSteedosTable.getThead = function (field, editable) {\r\n\r\n    var fieldObj = field;\r\n    if (!_.isObject(field))\r\n        fieldObj = SteedosTable.getField(field);\r\n\r\n    if (!fieldObj) {\r\n        return '';\r\n    }\r\n\r\n    var thead = '',\r\n        trs = '',\r\n        label = '',\r\n        width = 100;\r\n\r\n    if (editable) {\r\n        // trs = \"<th class='removed'></th>\"\r\n        trs = \"\"\r\n    }\r\n\r\n    var sfields = fieldObj.sfields;\r\n\r\n    if (!sfields) {\r\n        return thead;\r\n    }\r\n\r\n    var sf_length = sfields.length;\r\n\r\n    if (sf_length > 0) {\r\n        var wide_fields = sfields.filterProperty(\"is_wide\", true);\r\n\r\n        width = 100 / (sf_length + wide_fields.length);\r\n    }\r\n\r\n    sfields.forEach(function (sf, index) {\r\n\r\n        label = (sf.name != null && sf.name.length > 0) ? sf.name : sf.code;\r\n\r\n        trs = trs + \"<td \"; // nowrap='nowrap'\r\n\r\n        trs = trs + \" class='title \" + sf.type + \"'\";\r\n\r\n        if (index != (sf_length - 1)) {\r\n            if (sf.is_wide) {\r\n                trs = trs + \"style='width:\" + width * 2 + \"%'\"\r\n            } else {\r\n                trs = trs + \"style='width:\" + width + \"%'\"\r\n            }\r\n        }\r\n\r\n        trs = trs + \">\" + label + \"</td>\"\r\n    });\r\n\r\n    thead = '<tr>' + trs + '</tr>';\r\n\r\n    return thead;\r\n}\r\n\r\nSteedosTable.getTbody = function (keys, field, values, editable, sfieldsEditable) {\r\n    var tbody = \"\";\r\n\r\n    if (values instanceof Array) {\r\n        values.forEach(function (value, index) {\r\n            tbody = tbody + SteedosTable.getTr(keys, value, index, field, editable, sfieldsEditable);\r\n        });\r\n    }\r\n\r\n    return tbody;\r\n}\r\n\r\nSteedosTable.getTr = function (keys, item_value, index, field, editable, sfieldsEditable) {\r\n\r\n    var fieldObj = field;\r\n    if (!_.isObject(field))\r\n        fieldObj = SteedosTable.getField(field);\r\n\r\n    var tr = \"<tr id='\" + fieldObj.code + \"_item_\" + index + \"' name='\" + fieldObj.code + \"_item_\" + index + \"' data-index='\" + index + \"'\"\r\n\r\n    if (editable || sfieldsEditable) {\r\n        tr = tr + \"' class='item edit'\"\r\n    } else {\r\n        if (Steedos.isMobile()) {\r\n            tr = tr + \" class='item item-readonly'\"\r\n        } else {\r\n            tr = tr + \" class='item '\"\r\n        }\r\n    }\r\n\r\n    if (item_value.removed) {\r\n        tr = tr + \" style='display:none' \";\r\n    }\r\n\r\n    tr = tr + \"'>\";\r\n\r\n    var tds = \"\";\r\n\r\n    if (editable) {\r\n        tds = SteedosTable.getRemoveTd(fieldObj.code, index);\r\n    }\r\n\r\n    var sfields = fieldObj.sfields;\r\n\r\n    keys.forEach(function (key) {\r\n        var sfield = sfields.findPropertyByPK(\"code\", key);\r\n\r\n        var value = item_value[key];\r\n\r\n        tds = tds + SteedosTable.getTd(sfield, index, value);\r\n\r\n    });\r\n\r\n    tr = tr + tds + \"</tr>\";\r\n    return tr;\r\n}\r\n\r\nSteedosTable.getRemoveTd = function (field, index) {\r\n    // return \"<td class='steedosTable-item-remove removed' data-index='\" + index + \"'><i class='fa fa-times' aria-hidden='true'></td>\";\r\n    return \"\"\r\n}\r\n\r\nSteedosTable.getTd = function (field, index, value) {\r\n    var td = \"<td \";\r\n\r\n    td = td + \" class='steedosTable-item-field \" + field.type + \"' \";\r\n\r\n    var td_value = \"\";\r\n\r\n    if (Meteor.isClient) {\r\n        td_value = SteedosTable.getTDValue(field, value)\r\n    } else {\r\n        locale = Template.instance().view.template.steedosData.locale\r\n\r\n        utcOffset = Template.instance().view.template.steedosData.utcOffset\r\n\r\n        td_value = InstanceReadOnlyTemplate.getValue(value, field, locale, utcOffset)\r\n    }\r\n\r\n    td = td + \" data-index='\" + index + \"'>\" + td_value + \"</td>\"\r\n\r\n    return td;\r\n}\r\n\r\n\r\nSteedosTable.getTDValue = function (field, value) {\r\n    var td_value = \"\";\r\n    if (!field) {\r\n        return td_value\r\n    }\r\n    try {\r\n\r\n        switch (field.type) {\r\n            case 'user':\r\n                if (value) {\r\n                    if (field.is_multiselect) {\r\n                        if (value.length > 0) {\r\n                            if (\"string\" == typeof (value[0])) {\r\n                                td_value = CFDataManager.getFormulaSpaceUsers(value).getProperty(\"name\").toString();\r\n                            } else {\r\n                                td_value = value.getProperty(\"name\").toString();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        if (\"string\" == typeof (value)) {\r\n                            var u = CFDataManager.getFormulaSpaceUsers(value);\r\n                            td_value = u ? u.name : '';\r\n                        } else {\r\n                            td_value = value.name;\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case 'group':\r\n                if (value) {\r\n                    if (field.is_multiselect) {\r\n                        if (value.length > 0) {\r\n                            if (\"string\" == typeof (value[0])) {\r\n                                td_value = CFDataManager.getFormulaOrganizations(value).getProperty(\"name\").toString();\r\n                            } else {\r\n                                td_value = value.getProperty(\"name\").toString();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        if (\"string\" == typeof (value)) {\r\n                            var o = CFDataManager.getFormulaOrganization(value);\r\n                            td_value = o ? o.name : '';\r\n                        } else {\r\n                            td_value = value.name;\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            case 'checkbox':\r\n                if (value === true || value == 'true') {\r\n                    td_value = TAPi18n.__(\"form_field_checkbox_yes\");\r\n                } else {\r\n                    td_value = TAPi18n.__(\"form_field_checkbox_no\");\r\n                }\r\n                break;\r\n            case 'email':\r\n                td_value = value ? \"<a href='mailto:\" + value + \"'>\" + value + \"</a>\" : \"\";\r\n                break;\r\n            case 'url':\r\n                if (value) {\r\n                    if (value.indexOf(\"http\") == 0) {\r\n                        try {\r\n                            td_value = \"<a href='\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\r\n                        } catch (e) {\r\n                            td_value = \"<a href='' target='_blank'>\" + value + \"</a>\";\r\n                        }\r\n\r\n                    } else {\r\n                        td_value = \"<a href='http://\" + encodeURI(value) + \"' target='_blank'>http://\" + value + \"</a>\";\r\n                    }\r\n                } else {\r\n                    td_value = \"\";\r\n                }\r\n                break;\r\n            case 'password':\r\n                td_value = '******';\r\n                break;\r\n            case 'date':\r\n                if (value) {\r\n                    if (value.length == 10) {\r\n                        var t = value.split(\"-\");\r\n                        year = t[0];\r\n                        month = t[1];\r\n                        date = t[2];\r\n                        value = new Date(year, month - 1, date);\r\n                    } else {\r\n                        value = new Date(value)\r\n                    }\r\n                    td_value = $.format.date(value, 'yyyy-MM-dd');\r\n                }\r\n                break;\r\n            case 'dateTime':\r\n                if (value) {\r\n                    if (value.length == 16) {\r\n                        var t = value.split(\"T\");\r\n                        var t0 = t[0].split(\"-\");\r\n                        var t1 = t[1].split(\":\");\r\n\r\n                        year = t0[0];\r\n                        month = t0[1];\r\n                        date = t0[2];\r\n                        hours = t1[0];\r\n                        seconds = t1[1];\r\n\r\n                        value = new Date(year, month - 1, date, hours, seconds);\r\n\r\n                    } else {\r\n\r\n                        value = new Date(value)\r\n                    }\r\n                    td_value = $.format.date(value, 'yyyy-MM-dd HH:mm');\r\n                }\r\n                break;\r\n            case 'number':\r\n                if (value || value == 0) {\r\n                    td_value = Steedos.numberToString(value, field.digits);\r\n                }\r\n                break;\r\n            case 'odata':\r\n                if (value) {\r\n                    if (field.is_multiselect) {\r\n                        td_value = _.pluck(value, '@label').toString()\r\n                    } else {\r\n                        td_value = value['@label']\r\n                    }\r\n                }\r\n                break;\r\n            default:\r\n                td_value = value ? value : '';\r\n                break;\r\n        }\r\n    } catch (e) {\r\n        e;\r\n\r\n        return '';\r\n    }\r\n    return td_value;\r\n};\r\n\r\nif (Meteor.isClient) {\r\n    AutoForm.addInputType(\"table\", {\r\n        template: \"afTable\",\r\n        valueOut: function () {\r\n            var name = this.data(\"schemaKey\");\r\n            return SteedosTable.getValidValue(name);\r\n        },\r\n        valueConverters: {\r\n            \"stringArray\": AutoForm.valueConverters.stringToStringArray,\r\n            \"number\": AutoForm.valueConverters.stringToNumber,\r\n            \"numerArray\": AutoForm.valueConverters.stringToNumberArray,\r\n            \"boolean\": AutoForm.valueConverters.stringToBoolean,\r\n            \"booleanArray\": AutoForm.valueConverters.stringToBooleanArray,\r\n            \"date\": AutoForm.valueConverters.stringToDate,\r\n            \"dateArray\": AutoForm.valueConverters.stringToDateArray\r\n        },\r\n        contextAdjust: function (context) {\r\n            if (typeof context.atts.maxlength === 'undefined' && typeof context.max === 'number') {\r\n                context.atts.maxlength = context.max;\r\n            }\r\n            return context;\r\n        }\r\n    });\r\n\r\n    Template.afTable.events({\r\n        'tap .steedos-table .steedosTable-item-add,.add-item-tr': function (event, template) {\r\n            var name = template.data.name;\r\n\r\n            var tableValue = SteedosTable.getTableValue(name);\r\n\r\n            var new_item_index = tableValue ? tableValue.length : 0;\r\n\r\n            SteedosTable.showModal(name, new_item_index, \"add\");\r\n        },\r\n\r\n        'tap .steedos-table .steedosTable-item-field': function (event, template) {\r\n            if (template.data.atts.editable || template.data.atts.sfieldsEditable) {\r\n                var field = template.data.name;\r\n                var index = event.currentTarget.dataset.index;\r\n                SteedosTable.showModal(field, index, \"edit\");\r\n            }\r\n        },\r\n\r\n        'tap .steedos-table .steedosTable-item-remove': function (event, template) {\r\n            var field = template.data.name;\r\n            var item_index = event.currentTarget.dataset.index;\r\n            Session.set(\"instance_change\", true);\r\n            SteedosTable.removeItem(field, item_index);\r\n        },\r\n\r\n        'tap .steedos-table .item-readonly': function (event, template) {\r\n            if (!template.data.atts.editable) {\r\n                var field = template.data.name;\r\n                var index = event.currentTarget.dataset.index;\r\n                SteedosTable.showModal(field, index, \"read\");\r\n            }\r\n        }\r\n    });\r\n\r\n\r\n\r\n    Template.afTable.rendered = function () {\r\n\r\n        var field = this.data.name;\r\n\r\n        var sfieldsEditable = this.data.atts.sfieldsEditable;\r\n\r\n        var keys = SteedosTable.getKeys(field);\r\n        var validValue = SteedosTable.handleData(field, this.data.value);\r\n        SteedosTable.setTableValue(field, validValue);\r\n\r\n        $(\"thead[name='\" + field + \"Thead']\").html(SteedosTable.getThead(field, this.data.atts.editable));\r\n\r\n        $(\"tbody[name='\" + field + \"Tbody']\").html(SteedosTable.getTbody(keys, field, SteedosTable.getTableValue(field), this.data.atts.editable, sfieldsEditable));\r\n\r\n        str = t(\"steedos_table_add_item\");\r\n        addItemTr = \"<tr class='add-item-tr'><td colspan='\" + keys.length + \"'><i class='ion ion-plus-round'></i>\" + str + \"</td></tr>\";\r\n\r\n        if (this.data.atts.editable) {\r\n            $(\"tfoot[name='\" + field + \"Tfoot']\").append(addItemTr);\r\n        }\r\n\r\n        var c = InstanceManager.getCurrentStep();\r\n        if (c.step_type == 'counterSign' || InstanceManager.ccHasEditPermission()) {\r\n            this.autorun(function () {\r\n                var data = Template.currentData();\r\n                var field = data.name;\r\n                var keys = SteedosTable.getKeys(field);\r\n                var validValue = SteedosTable.handleData(field, data.value);\r\n                SteedosTable.setTableValue(field, validValue);\r\n                $(\"tbody[name='\" + field + \"Tbody']\").html(SteedosTable.getTbody(keys, field, SteedosTable.getTableValue(field), data.atts.editable, sfieldsEditable));\r\n            })\r\n        }\r\n\r\n    };\r\n}","ImageSign.helpers =\r\n\tspaceUserSign: (userId)->\r\n\t\tspace = \"\"\r\n\r\n\t\tif Meteor.isServer\r\n\t\t\tspace = Template.instance().view.template.steedosData.space\r\n\t\telse\r\n\t\t\tspace = Session.get(\"spaceId\")\r\n\r\n\t\tspaceUserSign = db.space_user_signs.findOne({space: space, user: userId});\r\n\t\treturn spaceUserSign\r\n\r\n\timageURL: (userId)->\r\n\r\n\t\tspaceUserSign = ImageSign.helpers.spaceUserSign(userId);\r\n\r\n\t\tabsolute = false\r\n\r\n\t\tif Meteor.isServer\r\n\t\t\tabsolute = Template.instance().view.template.steedosData.absolute\r\n\r\n\t\tif spaceUserSign?.sign\r\n\t\t\tif absolute\r\n\t\t\t\treturn Meteor.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\r\n\t\t\telse\r\n\t\t\t\treturn Steedos.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\r\n","ImageSign.helpers = {\n  spaceUserSign: function(userId) {\n    var space, spaceUserSign;\n    space = \"\";\n    if (Meteor.isServer) {\n      space = Template.instance().view.template.steedosData.space;\n    } else {\n      space = Session.get(\"spaceId\");\n    }\n    spaceUserSign = db.space_user_signs.findOne({\n      space: space,\n      user: userId\n    });\n    return spaceUserSign;\n  },\n  imageURL: function(userId) {\n    var absolute, spaceUserSign;\n    spaceUserSign = ImageSign.helpers.spaceUserSign(userId);\n    absolute = false;\n    if (Meteor.isServer) {\n      absolute = Template.instance().view.template.steedosData.absolute;\n    }\n    if (spaceUserSign != null ? spaceUserSign.sign : void 0) {\n      if (absolute) {\n        return Meteor.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\n      } else {\n        return Steedos.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\n      }\n    }\n  }\n};\n","TracesHandler.helpers =\r\n\tshowSignImage: (handler, is_finished, judge) ->\r\n\t\tif !is_finished\r\n\t\t\treturn false\r\n\t\tif ['returned', 'terminated', 'retrieved'].includes(judge)\r\n\t\t\treturn false\r\n\t\tspaceUserSign = ImageSign.helpers.spaceUserSign(handler)\r\n\r\n\t\tif spaceUserSign?.sign\r\n\t\t\treturn true\r\n\t\telse\r\n\t\t\treturn false\r\n\r\n\tobjectUrl: (object_name, record_id, app_id)->\r\n\t\treturn Creator.getObjectUrl(object_name, record_id, app_id)","TracesHandler.helpers = {\n  showSignImage: function(handler, is_finished, judge) {\n    var spaceUserSign;\n    if (!is_finished) {\n      return false;\n    }\n    if (['returned', 'terminated', 'retrieved'].includes(judge)) {\n      return false;\n    }\n    spaceUserSign = ImageSign.helpers.spaceUserSign(handler);\n    if (spaceUserSign != null ? spaceUserSign.sign : void 0) {\n      return true;\n    } else {\n      return false;\n    }\n  },\n  objectUrl: function(object_name, record_id, app_id) {\n    return Creator.getObjectUrl(object_name, record_id, app_id);\n  }\n};\n","InstanceformTemplate.helpers =\r\n\tapplicantContext: ->\r\n\t\tsteedos_instance = WorkflowManager.getInstance();\r\n\t\tdata = {\r\n\t\t\tname: 'ins_applicant',\r\n\t\t\tatts: {name: 'ins_applicant', id: 'ins_applicant', class: 'selectUser form-control ins_applicant'},\r\n\t\t\tvalue: steedos_instance.applicant_name\r\n\t\t}\r\n\t\tif not steedos_instance || steedos_instance.state != \"draft\"\r\n\t\t\tdata.atts.disabled = true\r\n\t\treturn data;\r\n\r\n\tinstanceId: ->\r\n\t\treturn 'instanceform';#\"instance_\" + Session.get(\"instanceId\");\r\n\r\n\tform_types: ->\r\n\t\tif ApproveManager.isReadOnly()\r\n\t\t\treturn 'disabled';\r\n\t\telse\r\n\t\t\treturn 'method';\r\n\r\n\tsteedos_form: ->\r\n\t\tform_version = WorkflowManager.getInstanceFormVersion();\r\n\t\tif form_version\r\n\t\t\treturn form_version\r\n\r\n\tinnersubformContext: (obj)->\r\n\t\tdoc_values = WorkflowManager_format.getAutoformSchemaValues();\r\n\t\tobj[\"tableValues\"] = if doc_values then doc_values[obj.code] else []\r\n\t\tobj[\"formId\"] = \"instanceform\";\r\n\t\treturn obj;\r\n\r\n\tinstance: ->\r\n\t\tSession.get(\"change_date\")\r\n\t\tif (Session.get(\"instanceId\"))\r\n\t\t\tsteedos_instance = WorkflowManager.getInstance();\r\n\t\t\treturn steedos_instance;\r\n\r\n\tempty: (val) ->\r\n\t\tif val\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn true;\r\n\r\n\tunempty: (val) ->\r\n\t\tif val\r\n\t\t\treturn true;\r\n\t\telse\r\n\t\t\treturn false;\r\n\r\n\tequals: (a, b) ->\r\n\t\treturn (a == b)\r\n\r\n\tunequals: (a, b) ->\r\n\t\treturn !(a == b)\r\n\r\n\tincludes: (a, b) ->\r\n\t\treturn b.split(',').includes(a);\r\n\r\n\tinclude: (a, b) ->\r\n\t\treturn b.split(',').includes(a);\r\n\r\n\tfields: ->\r\n\t\tform_version = WorkflowManager.getInstanceFormVersion();\r\n\t\tif form_version\r\n\t\t\treturn new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\r\n\r\n\tformatDate: (date, options)->\r\n\t\tif !date\r\n\t\t\treturn \"\";\r\n\t\tif options && typeof(options) == 'string'\r\n\t\t\toptions = JSON.parse(options);\r\n\r\n\t\tif !options.format\r\n\t\t\toptions = {format: \"YYYY-MM-DD HH:mm\"}\r\n\r\n\t\treturn moment(date).format(options.format);\r\n\r\n\ttraces: ->\r\n\t\tif Meteor.isServer\r\n\t\t\tsteedosData = Template.instance()?.view?.template?.steedosData\r\n\t\t\tinstance = steedosData?.instance\r\n\t\t\tflow = InstanceReadOnlyTemplate.getFlowVersion(instance);\r\n\t\t\tlocale = steedosData?.locale\r\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\r\n\t\t\t\tlocale = \"zh-CN\"\r\n\t\telse\r\n\t\t\tinstance = WorkflowManager.getInstance();\r\n\r\n\t\t\tflow = WorkflowManager.getInstanceFlowVersion()\r\n\r\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\r\n\r\n\t\tif !instance || !flow\r\n\t\t\treturn {};\r\n\r\n\t\tsteps = flow.steps;\r\n\r\n\t\ttraces = {};\r\n\r\n\t\tinstance.traces?.forEach (trace)->\r\n\t\t\tstep = steps.findPropertyByPK(\"_id\", trace.step)\r\n\r\n\t\t\tapproves = []\r\n\r\n\t\t\ttrace.approves?.forEach (approve) ->\r\n\t\t\t\tif trace.is_finished == true\r\n# å·²ç»“æŸçš„æ˜¾ç¤ºä¸ºæ ¸å‡†/é©³å›ž/å–æ¶ˆç”³è¯·\r\n\t\t\t\t\tif approve.judge == 'approved'\r\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State approved\", {}, locale)\r\n\t\t\t\t\telse if approve.judge == 'rejected'\r\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State rejected\", {}, locale)\r\n\t\t\t\t\telse if approve.judge == 'terminated'\r\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State terminated\", {}, locale)\r\n\t\t\t\t\telse if approve.judge == 'reassigned'\r\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State reassigned\", {}, locale)\r\n\t\t\t\t\telse if approve.judge == 'relocated'\r\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State relocated\", {}, locale)\r\n\t\t\t\t\telse if approve.judge == ''\r\n\t\t\t\t\t\tjudge_name = \"\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tjudge_name = \"\"\r\n\r\n\t\t\t\telse\r\n\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State pending\", {}, locale)\r\n\r\n\t\t\t\tapproves.push\r\n\t\t\t\t\t_id: approve._id\r\n\t\t\t\t\thandler: approve.user\r\n\t\t\t\t\thandler_name: approve.handler_name\r\n\t\t\t\t\thandler_organization_name: approve.handler_organization_name\r\n\t\t\t\t\thandler_organization_fullname: approve.handler_organization_fullname\r\n\t\t\t\t\tfinish_date: approve.finish_date\r\n\t\t\t\t\tjudge: approve.judge\r\n\t\t\t\t\tjudge_name: judge_name\r\n\t\t\t\t\tdescription: approve.description\r\n\t\t\t\t\tis_finished: approve.is_finished\r\n\t\t\t\t\ttype: approve.type\r\n\t\t\t\t\topinion_fields_code: approve.opinion_fields_code\r\n\t\t\t\t\tsign_field_code: approve.sign_field_code\r\n\t\t\t\t\tis_read: approve.is_read\r\n\t\t\t\t\tsign_show: approve.sign_show\r\n\r\n\r\n\t\t\tif step\r\n\t\t\t\tif step.name of traces\r\n\t\t\t\t\ttraces[step.name] = traces[step.name].concat(approves)\r\n\t\t\t\telse\r\n\t\t\t\t\ttraces[step.name] = approves\r\n\r\n\t\treturn traces;\r\n\r\n\r\n\r\n\tdoc_values: ->\r\n\t\tWorkflowManager_format.getAutoformSchemaValues();\r\n\r\n\tinstance_box_style: ->\r\n\t\tbox = Session.get(\"box\")\r\n\t\tif box == \"inbox\" || box == \"draft\"\r\n\t\t\tjudge = Session.get(\"judge\")\r\n\t\t\tif judge\r\n\t\t\t\tif (judge == \"approved\")\r\n\t\t\t\t\treturn \"box-success\"\r\n\t\t\t\telse if (judge == \"rejected\")\r\n\t\t\t\t\treturn \"box-danger\"\r\n\t\tins = WorkflowManager.getInstance();\r\n\t\tif ins && ins.final_decision\r\n\t\t\tif ins.final_decision == \"approved\"\r\n\t\t\t\treturn \"box-success\"\r\n\t\t\telse if (ins.final_decision == \"rejected\")\r\n\t\t\t\treturn \"box-danger\"\r\n\r\n#is_disabled: ->\r\n#    ins = WorkflowManager.getInstance();\r\n#    if !ins\r\n#        return;\r\n#    if ins.state!=\"draft\"\r\n#        return \"disabled\";\r\n#    return;\r\n\r\n\ttable_fields: (instance)->\r\n\t\tif Meteor.isClient\r\n\t\t\tform_version = WorkflowManager.getInstanceFormVersion();\r\n\t\telse\r\n\t\t\tform_version = WorkflowManager.getFormVersion(instance.form, instance.form_version)\r\n\t\tif form_version\r\n\t\t\tfields = _.clone(form_version.fields);\r\n\r\n\t\t\tfields.forEach (field, index) ->\r\n\t\t\t\tfield.tr_start = \"\";\r\n\t\t\t\tfield.tr_end = \"\";\r\n\t\t\t\ttd_colspan = 1;\r\n#\t\t\t\tå¼ºåˆ¶è®¾ç½®æ ‡å¤´å­—æ®µä¸ºå®½å­—æ®µ\r\n\t\t\t\tif CoreForm?.pageTitleFieldName == field.code\r\n\t\t\t\t\tfield.is_wide = true\r\n\r\n\t\t\t\tif field.formula && field.type != 'odata'\r\n\t\t\t\t\tfield.permission = \"readonly\";\r\n\r\n\t\t\t\tif Steedos.isMobile()\r\n# å¦‚æžœå½“å‰å­—æ®µæ˜¯åˆ†ç»„ã€è¡¨æ ¼ã€å®½å­—æ®µ\r\n\t\t\t\t\tif field.type == 'section' || field.type == 'table'\r\n\t\t\t\t\t\tfield.td_colspan = 4;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tfield.td_colspan = 3;\r\n\r\n\t\t\t\t\tif index != 0\r\n\t\t\t\t\t\tfield.tr_start = \"<tr>\";\r\n\t\t\t\t\t\tfield.tr_end = \"</tr>\";\r\n\t\t\t\telse\r\n\t\t\t\t\tpre_fields = fields.slice(0, index);\r\n\r\n\t\t\t\t\tpre_wide_fields = pre_fields.filterProperty(\"is_wide\", true);\r\n\r\n\t\t\t\t\ttr_start = \"\";\r\n\r\n\t\t\t\t\ttr_end = \"\";\r\n\r\n\t\t\t\t\t# å…ˆè®¡ç®—å½“å‰å­—æ®µæ˜¯å¦ä¸ºå®½å­—æ®µ\r\n\t\t\t\t\tbefore_field = null;\r\n\t\t\t\t\tafter_field = null;\r\n\r\n\t\t\t\t\tif index > 0\r\n\t\t\t\t\t\tbefore_field = fields[index - 1]\r\n\r\n\t\t\t\t\tif index < fields.length - 1\r\n\t\t\t\t\t\tafter_field = fields[index + 1]\r\n\r\n\t\t\t\t\t# å¦‚æžœå½“å‰å­—æ®µæ˜¯åˆ†ç»„ã€è¡¨æ ¼ã€å®½å­—æ®µ\r\n\t\t\t\t\tif field.type == 'section' || field.type == 'table'\r\n\t\t\t\t\t\ttd_colspan = 4;\r\n\t\t\t\t\telse if field.is_wide\r\n\t\t\t\t\t\ttd_colspan = 3;\r\n\t\t\t\t\telse\r\n# å‰åŽéƒ½æ˜¯å®½å­—æ®µ\r\n\t\t\t\t\t\tif before_field && after_field && before_field.is_wide && after_field.is_wide\r\n\t\t\t\t\t\t\tfield.is_wide = true;\r\n\t\t\t\t\t\t\ttd_colspan = 3;\r\n\r\n\t\t\t\t\t\t# å½“å‰æ˜¯tr ä¸‹çš„ ç¬¬ä¸€ä¸ªtd & åŽè¾¹çš„å­—æ®µæ˜¯å®½å­—æ®µ\r\n\t\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 == 0 && after_field && after_field.is_wide\r\n\t\t\t\t\t\t\tfield.is_wide = true;\r\n\t\t\t\t\t\t\ttd_colspan = 3;\r\n\r\n\t\t\t\t\t\t# å½“å‰æ˜¯tr ä¸‹çš„ ç¬¬ä¸€ä¸ªtd & å½“å‰å­—æ®µæ˜¯æœ€åŽä¸€ä¸ªå­—æ®µ\r\n\t\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 == 0 && after_field == null\r\n\t\t\t\t\t\t\tfield.is_wide = true;\r\n\t\t\t\t\t\t\ttd_colspan = 3;\r\n\r\n\t\t\t\t\tfield.td_colspan = td_colspan;\r\n\r\n\r\n\t\t\t\t\tif index == 0\r\n# tr_start = \"<tr>\"; ç”±äºŽTemplateçš„ç¼–è¯‘bugï¼Œå¯¼è‡´æ¯æ¬¡ç»™ä¸€ä¸ªtrå¼€å§‹æ—¶ï¼Œä¼šè‡ªåŠ¨è¡¥å¤´æˆ–è¡¥å°¾ã€‚å› æ­¤åœ¨ç¬¬ä¸€è¡Œè¿”å›žä¸€ä¸ªç©ºå­—ç¬¦ä¸².\r\n\t\t\t\t\t\ttr_start = \"<tr>\";\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 == 0 || field.is_wide\r\n\t\t\t\t\t\t\tif field.type == 'table'\r\n\t\t\t\t\t\t\t\ttr_start = \"<tr class = \\\"tr-child-table\\\">\";\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\ttr_start = \"<tr>\";\r\n\r\n\t\t\t\t\tfield.tr_start = tr_start;\r\n\r\n\r\n\t\t\t\t\tif index + 1 == fields.length || field.type == 'section' || field.type == 'table' || field.is_wide\r\n\t\t\t\t\t\ttr_end = \"</tr>\";\r\n\r\n\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 != 0\r\n\t\t\t\t\t\ttr_end = \"</tr>\";\r\n\r\n\t\t\t\t\tfield.tr_end = tr_end;\r\n\r\n\t\t\treturn fields;\r\n\r\n\tsort_approve: (approves, order)->\r\n\t\tif !approves\r\n\t\t\treturn []\r\n\r\n\t\tif !approves instanceof Array\r\n\t\t\treturn []\r\n\t\telse\r\n\t\t\tif order == 'desc'\r\n\t\t\t\tapproves.sort (p1, p2) ->\r\n\t\t\t\t\t_p1 = 0\r\n\t\t\t\t\t_p2 = 0\r\n\r\n\t\t\t\t\tif p1.finish_date\r\n\t\t\t\t\t\t_p1 = p1.finish_date.getTime()\r\n\r\n\t\t\t\t\tif p2.finish_date\r\n\t\t\t\t\t\t_p2 = p2.finish_date.getTime();\r\n\r\n\t\t\t\t\treturn _p2 - _p1\r\n\t\t\telse\r\n\t\t\t\tapproves.sort (p1, p2) ->\r\n\t\t\t\t\t_p1 = 0\r\n\t\t\t\t\t_p2 = 0\r\n\r\n\t\t\t\t\tif p1.finish_date\r\n\t\t\t\t\t\t_p1 = p1.finish_date.getTime()\r\n\r\n\t\t\t\t\tif p2.finish_date\r\n\t\t\t\t\t\t_p2 = p2.finish_date.getTime();\r\n\r\n\t\t\t\t\treturn _p1 - _p2\r\n\t\treturn approves\r\n\r\n\t_t: (key)->\r\n\t\treturn TAPi18n.__(key)\r\n\tgetField: (code)->\r\n\t\tform_version = Template.instance().view.template.steedosData.form_version\r\n\t\tif form_version\r\n\t\t\treturn form_version.fields.findPropertyByPK(\"code\", code)\r\n\r\n\tgetValue: (code)->\r\n\t\tinstance = Template.instance().view.template.steedosData.instance\r\n\r\n\t\tform_version = Template.instance().view.template.steedosData.form_version\r\n\r\n\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\r\n\t\tutcOffset = Template.instance().view.template.steedosData.utcOffset\r\n\r\n\t\tvalues = instance.values || {}\r\n\r\n\t\tif Meteor.isClient\r\n\t\t\tvalues = WorkflowManager_format.getAutoformSchemaValues()\r\n\r\n\t\treturn InstanceReadOnlyTemplate.getValue values[code], form_version.fields.findPropertyByPK(\"code\", code), locale, utcOffset\r\n\r\n\tgetLabel: (code)->\r\n\t\tform_version = Template.instance().view.template.steedosData.form_version\r\n\t\tInstanceReadOnlyTemplate.getLabel form_version.fields, code\r\n\r\n\tgetCfClass: (field)->\r\n\t\tif field?.type == \"input\" && field?.is_textarea\r\n\t\t\treturn \"cfTextarea\"\r\n\r\n\tgetTableThead: (field)->\r\n\t\treturn SteedosTable.getThead(field, false)\r\n\r\n\tgetTableBody: (field)->\r\n\r\n\t\tif Meteor.isServer\r\n\t\t\tinstance = Template.instance().view.template.steedosData.instance\r\n\t\t\tvalues = instance.values || {}\r\n\t\telse\r\n\t\t\tvalues = WorkflowManager_format.getAutoformSchemaValues()\r\n\r\n\t\ttableValue = values[field.code];\r\n\t\treturn SteedosTable.getTbody(field.sfields.getProperty(\"code\"), field, tableValue, false)\r\n\r\n\tshowLabel: (field)->\r\n\t\ttemplateData = Template.instance().data\r\n\t\tif templateData.label == false\r\n\t\t\treturn false\r\n\t\treturn true\r\n\r\n#\tafFieldLabelText: (op)->\r\n#\t\tif !Template.instance().view.template.steedosData\r\n#\t\t\treturn AutoForm.getLabelForField(op.name)\r\n#\t\telse\r\n#\t\t\tform_version = Template.instance().view.template.steedosData.form_version\r\n#\t\t\tInstanceReadOnlyTemplate.getLabel form_version.fields, op?.hash?.name\r\n\r\n\tisOpinionField: (field)->\r\n\t\treturn InstanceformTemplate.helpers.isOpinionField_from_string(field.formula)\r\n\r\n\tisOpinionField_from_string: (field_formula)->\r\n\t\treturn InstanceSignText.isOpinionField_from_string(field_formula)\r\n\r\n\tincludesOpinionField: (form, form_version)->\r\n\r\n\t\tfield_formulas = new Array();\r\n\r\n\t\tfields = db.form_versions.findOne({_id: form_version, form: form})?.fields || []\r\n\r\n\t\tfields.forEach (f)->\r\n\t\t\tif f.type == 'table'\r\n\t\t\t\tconsole.log 'ignore opinion field in table'\r\n\t\t\telse if f.type == 'section'\r\n\t\t\t\tf?.fields?.forEach (f1)->\r\n\t\t\t\t\tfield_formulas.push f1.formula\r\n\t\t\telse\r\n\t\t\t\tfield_formulas.push f.formula\r\n\r\n\t\t_.some field_formulas, (field_formula)->\r\n\t\t\treturn InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)\r\n\r\n\tgetOpinionFieldStepsName: (field_formula, top_keywords)->\r\n\r\n\t\topinionFields = new Array();\r\n#\t\tconsole.log(\"field_formula\", field_formula)\r\n\t\tif InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)\r\n\t\t\tif field_formula\r\n\r\n#\t\t\t\tfoo1 = field_formula.split(\",\")\r\n\t\t\t\tfoo1 = field_formula.split(\";\")\r\n\r\n#\t\t\t\tif top_keywords\r\n#\t\t\t\t\tfoo1 = field_formula.split(\";\")\r\n\r\n\t\t\t\tfoo1.forEach (foo)->\r\n\t\t\t\t\tjson_formula = {}\r\n\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t\tjson_formula = eval(\"(\" + foo + \")\")\r\n\t\t\t\t\tcatch\r\n\t\t\t\t\t\tjson_formula = {}\r\n\r\n\t\t\t\t\tif json_formula?.yijianlan\r\n\t\t\t\t\t\tsf = {}\r\n\r\n\t\t\t\t\t\tsf.stepName = json_formula.yijianlan.step\r\n\r\n\t\t\t\t\t\tsf.image_sign = json_formula.yijianlan.image_sign || false\r\n\r\n\t\t\t\t\t\tsf.only_cc_opinion = json_formula.yijianlan.only_cc || false\r\n\r\n\t\t\t\t\t\tsf.default_description = json_formula.yijianlan.default\r\n\r\n\t\t\t\t\t\tsf.only_handler = json_formula.yijianlan.only_handler\r\n\r\n\t\t\t\t\t\tsf.top_keywords = json_formula.yijianlan.top_keywords || top_keywords\r\n\r\n\t\t\t\t\t\topinionFields.push(sf);\r\n\r\n\t\t\t\t\telse if(field_formula?.indexOf(\"{traces.\") > -1 || field_formula?.indexOf(\"{signature.traces.\") > -1)\r\n\r\n\t\t\t\t\t\tsf = {only_cc_opinion: false, image_sign: false, top_keywords: top_keywords}\r\n\r\n\t\t\t\t\t\tif foo.indexOf(\"{signature.\") > -1\r\n\t\t\t\t\t\t\tsf.image_sign = true\r\n\t\t\t\t\t\t\tfoo = foo.replace(\"{signature.\",\"\");\r\n\r\n\t\t\t\t\t\ts1 = foo.replace(\"{\",\"\").replace(\"}\",\"\")\r\n\t\t\t\t\t\tif s1.split(\".\").length > 1\r\n\t\t\t\t\t\t\tsf.stepName = s1.split(\".\")[1]\r\n\t\t\t\t\t\t\tif opinionFields.filterProperty(\"stepName\",sf.stepName).length > 0\r\n\t\t\t\t\t\t\t\topinionFields.findPropertyByPK(\"stepName\", sf.stepName)?.only_cc_opinion = true\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tif s1.split(\".\").length > 2\r\n\t\t\t\t\t\t\t\t\tif s1.split(\".\")[2]?.toLocaleLowerCase() == 'cc'\r\n\t\t\t\t\t\t\t\t\t\tsf.only_cc_opinion = true\r\n\t\t\t\t\t\topinionFields.push(sf);\r\n\r\n\t\treturn opinionFields\r\n\r\n\tshowCCOpinion: (field)->\r\n\t\tif field.formula?.indexOf(\"{traces.\") > -1 || field.formula?.indexOf(\"{signature.traces.\") > -1\r\n\t\t\ts1 = field.formula.replace(\"{signature.\",\"\").replace(\"{\",\"\").replace(\"}\",\"\")\r\n\t\t\tif s1.split(\".\").length > 2\r\n\t\t\t\tif s1.split(\".\")[2]?.toLocaleLowerCase() == 'cc'\r\n\t\t\t\t\treturn true\r\n\t\treturn false\r\n\r\n\tmarkDownToHtml: (markDownString)->\r\n\t\tif markDownString\r\n\t\t\trenderer = new Markdown.Renderer();\r\n\t\t\trenderer.link = ( href, title, text ) ->\r\n\t\t\t\treturn \"<a target='_blank' href='#{href}' title='#{title}'>#{text}</a>\"\r\n\t\t\treturn Spacebars.SafeString(Markdown(markDownString, {renderer:renderer}))\r\n\r\n\tf_label: (that)->\r\n\t\treturn that.name || that.code\r\n\r\nif Meteor.isServer\r\n\tInstanceformTemplate.helpers.steedos_form = ->\r\n\t\treturn this.form_version\r\n\r\n\tInstanceformTemplate.helpers.isSection = (code)->\r\n\t\tform_version = this.form_version\r\n\t\treturn form_version.fields.findPropertyByPK(\"code\", code).type == 'section'\r\n\r\n\tInstanceformTemplate.helpers.doc_values = ->\r\n\t\tinstance = this.instance;\r\n\t\treturn instance.values;\r\n\r\n\tInstanceformTemplate.helpers.applicantContext = ->\r\n\t\tinstance = this.instance;\r\n\t\tdata = {\r\n\t\t\tname: 'ins_applicant',\r\n\t\t\tatts: {name: 'ins_applicant', id: 'ins_applicant', class: 'selectUser form-control ins_applicant'},\r\n\t\t\tvalue: instance.applicant_name\r\n\t\t}\r\n\r\n\tInstanceformTemplate.helpers.instance = ->\r\n\t\treturn this.instance\r\n\r\n\tInstanceformTemplate.helpers.fields = ->\r\n\t\tform_version = this.form_version\r\n\t\tif form_version\r\n\t\t\treturn new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\r\n\r\n\tInstanceformTemplate.helpers.form_types = ->\r\n\t\treturn \"disabled\"\r\n\r\n\tTemplate.registerHelper \"afFieldLabelText\", (op)->\r\n\t\tform_version = Template.instance().view.template.steedosData.form_version\r\n\t\tInstanceReadOnlyTemplate.getLabel form_version.fields, op?.hash?.name\r\n\r\n\tInstanceformTemplate.helpers._t = (key)->\r\n\t\tlocale = this.locale\r\n\r\n\t\treturn TAPi18n.__(key, {}, locale)\r\n\r\n\tInstanceformTemplate.helpers.ins_attach_download_url = (_id, absolute)->\r\n\t\tif absolute\r\n\t\t\treturn Meteor.absoluteUrl(\"/api/files/instances/#{_id}?download=true\");\r\n\t\telse\r\n\t\t\treturn \"/api/files/instances/#{_id}?download=true\";\r\n\r\n\tInstanceformTemplate.helpers.options = (field)->\r\n\t\toptions = field?.options?.split(\"\\n\")\r\n\t\trev = []\r\n\t\toptions?.forEach (item)->\r\n\t\t\trev.push({label: item, value: item})\r\n\r\n\t\treturn rev\r\n\r\n\tInstanceformTemplate.helpers.getPermissions = (code)->\r\n\t\tif !Template.instance().view.template.steedosData.startStepEditableFields?.includes(code)\r\n\t\t\treturn \"readonly disabled\"\r\n\t\treturn \"\"\r\n\r\nInstanceformTemplate.events =\r\n\t'change .form-control,.checkbox input,.af-radio-group input,.af-checkbox-group input': (event)->\r\n\t\tInstanceManager.instanceformChangeEvent(event)\r\n\r\n\t'typeahead:change .form-control': (event) ->\r\n\t\tInstanceManager.instanceformChangeEvent(event)\r\n\r\n\t'click .cfTextarea a': (event)->\r\n\t\tevent.preventDefault();\r\n\t\tSteedos.openWindow(event.target.href);\r\n\r\n\r\nInstanceformTemplate.onCreated = ()->\r\n\tinstance = WorkflowManager.getInstance();\r\n\tif !instance\r\n\t\treturn;\r\n\r\n\ttemplate = TemplateManager.getTemplate(instance);\r\n\r\n\ttry\r\n\t\tcompiled = SpacebarsCompiler.compile(template, {isBody: true});\r\n\tcatch e\r\n\t\tconsole.log \"Instance Template Error\", e\r\n\t\tcompiled = SpacebarsCompiler.compile(\"\", {isBody: true});\r\n\r\n\r\n\trenderFunction = eval(compiled);\r\n\r\n\tinstanceView = new Blaze.View(\"custom_instance_template\", renderFunction);\r\n\r\n\tinstanceCustomTemplate = new Blaze.Template(instanceView.name, renderFunction);\r\n\r\n\tTemplate.instance_custom_template = instanceCustomTemplate\r\n\r\n\tTemplate.instance_custom_template.helpers InstanceformTemplate.helpers\r\n\r\n\r\n\r\n\r\nInstanceformTemplate.onRendered = ()->\r\n\t# t = this;\r\n\r\n\t#t.subscribe \"instance_data\", Session.get(\"instanceId\"), ->\r\n\t#    Tracker.afterFlush ->\r\n\tinstance = WorkflowManager.getInstance();\r\n\tif !instance\r\n\t\treturn;\r\n\r\n\t#$(\"#ins_applicant\").select2().val(instance.applicant).trigger('change');\r\n\t#$(\"#ins_applicant\").val(instance.applicant);\r\n\t$(\"input[name='ins_applicant']\")[0]?.dataset.values = instance.applicant;\r\n\t$(\"input[name='ins_applicant']\").val(instance.applicant_name)\r\n\r\n\r\n\tApproveManager.error = {nextSteps: '', nextStepUsers: ''};\r\n\r\n\t# instance fromç»‘å®šäº‹ä»¶\r\n\tif Session.get(\"box\") == 'inbox' || Session.get(\"box\") == 'draft'\r\n\t\tInstanceEvent.initEvents(instance.flow);\r\n\r\n\tif !ApproveManager.isReadOnly()\r\n\r\n\t\tcurrentApprove = InstanceManager.getCurrentApprove();\r\n\r\n\r\n\t\tinstanceNumberFields = $(\"[data-formula]\", $(\"#instanceform\"))\r\n\r\n\t\tinstanceNumberFields.each ()->\r\n\t\t\tschemaKey = this.dataset.schemaKey\r\n\t\t\telement = $(this)\r\n\t\t\tif !$(this).val() && schemaKey && Session.get(\"instanceId\")\r\n\t\t\t\tMeteor.call 'getInstanceValues', Session.get(\"instanceId\"), (error, result)->\r\n\t\t\t\t\tif error\r\n\t\t\t\t\t\ttoastr.error(error.reason)\r\n\r\n\t\t\t\t\tif !result[schemaKey]\r\n\t\t\t\t\t\tkey = element.data(\"formula\")?.replace(\"auto_number(\", \"\").replace(\")\", \"\")\r\n\r\n\t\t\t\t\t\tkey = key.replace(/\\\"/g, \"\").replace(/\\'/g, \"\")\r\n\r\n\t\t\t\t\t\tif key.indexOf(\"{\") > -1\r\n\t\t\t\t\t\t\tkey = key.replace(\"{\",\"\").replace(\"}\",\"\")\r\n\t\t\t\t\t\t\tkey = key.trim()\r\n\t\t\t\t\t\t\tkey = AutoForm.getFieldValue(key, 'instanceform')\r\n\t\t\t\t\t\tInstanceNumberRules.instanceNumberBuilder element, key\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\telement?.val(result[schemaKey]).trigger(\"change\")\r\n\r\n\t\tjudge = currentApprove.judge\r\n\t\tcurrentStep = InstanceManager.getCurrentStep();\r\n\t\tform_version = WorkflowManager.getInstanceFormVersion();\r\n\r\n\t\tformula_fields = Form_formula.getFormulaFieldVariable(\"Form_formula.field_values\", form_version.fields);\r\n\t\tForm_formula.run(\"\", \"\", formula_fields, AutoForm.getFormValues(\"instanceform\").insertDoc, form_version.fields);\r\n\t\t#åœ¨æ­¤å¤„åˆå§‹åŒ–session ä¸­çš„ form_values å˜é‡ï¼Œç”¨äºŽè§¦å‘ä¸‹ä¸€æ­¥æ­¥éª¤è®¡ç®—\r\n\t\tSession.set(\"instance_form_values\", {instanceId: instance._id, values: AutoForm.getFormValues(\"instanceform\").insertDoc});\r\n\r\n\r\n\r\n","InstanceformTemplate.helpers = {\n  applicantContext: function() {\n    var data, steedos_instance;\n    steedos_instance = WorkflowManager.getInstance();\n    data = {\n      name: 'ins_applicant',\n      atts: {\n        name: 'ins_applicant',\n        id: 'ins_applicant',\n        \"class\": 'selectUser form-control ins_applicant'\n      },\n      value: steedos_instance.applicant_name\n    };\n    if (!steedos_instance || steedos_instance.state !== \"draft\") {\n      data.atts.disabled = true;\n    }\n    return data;\n  },\n  instanceId: function() {\n    return 'instanceform';\n  },\n  form_types: function() {\n    if (ApproveManager.isReadOnly()) {\n      return 'disabled';\n    } else {\n      return 'method';\n    }\n  },\n  steedos_form: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return form_version;\n    }\n  },\n  innersubformContext: function(obj) {\n    var doc_values;\n    doc_values = WorkflowManager_format.getAutoformSchemaValues();\n    obj[\"tableValues\"] = doc_values ? doc_values[obj.code] : [];\n    obj[\"formId\"] = \"instanceform\";\n    return obj;\n  },\n  instance: function() {\n    var steedos_instance;\n    Session.get(\"change_date\");\n    if (Session.get(\"instanceId\")) {\n      steedos_instance = WorkflowManager.getInstance();\n      return steedos_instance;\n    }\n  },\n  empty: function(val) {\n    if (val) {\n      return false;\n    } else {\n      return true;\n    }\n  },\n  unempty: function(val) {\n    if (val) {\n      return true;\n    } else {\n      return false;\n    }\n  },\n  equals: function(a, b) {\n    return a === b;\n  },\n  unequals: function(a, b) {\n    return !(a === b);\n  },\n  includes: function(a, b) {\n    return b.split(',').includes(a);\n  },\n  include: function(a, b) {\n    return b.split(',').includes(a);\n  },\n  fields: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n    }\n  },\n  formatDate: function(date, options) {\n    if (!date) {\n      return \"\";\n    }\n    if (options && typeof options === 'string') {\n      options = JSON.parse(options);\n    }\n    if (!options.format) {\n      options = {\n        format: \"YYYY-MM-DD HH:mm\"\n      };\n    }\n    return moment(date).format(options.format);\n  },\n  traces: function() {\n    var flow, instance, locale, ref, ref1, ref2, ref3, steedosData, steps, traces;\n    if (Meteor.isServer) {\n      steedosData = (ref = Template.instance()) != null ? (ref1 = ref.view) != null ? (ref2 = ref1.template) != null ? ref2.steedosData : void 0 : void 0 : void 0;\n      instance = steedosData != null ? steedosData.instance : void 0;\n      flow = InstanceReadOnlyTemplate.getFlowVersion(instance);\n      locale = steedosData != null ? steedosData.locale : void 0;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      instance = WorkflowManager.getInstance();\n      flow = WorkflowManager.getInstanceFlowVersion();\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    if (!instance || !flow) {\n      return {};\n    }\n    steps = flow.steps;\n    traces = {};\n    if ((ref3 = instance.traces) != null) {\n      ref3.forEach(function(trace) {\n        var approves, ref4, step;\n        step = steps.findPropertyByPK(\"_id\", trace.step);\n        approves = [];\n        if ((ref4 = trace.approves) != null) {\n          ref4.forEach(function(approve) {\n            var judge_name;\n            if (trace.is_finished === true) {\n              if (approve.judge === 'approved') {\n                judge_name = TAPi18n.__(\"Instance State approved\", {}, locale);\n              } else if (approve.judge === 'rejected') {\n                judge_name = TAPi18n.__(\"Instance State rejected\", {}, locale);\n              } else if (approve.judge === 'terminated') {\n                judge_name = TAPi18n.__(\"Instance State terminated\", {}, locale);\n              } else if (approve.judge === 'reassigned') {\n                judge_name = TAPi18n.__(\"Instance State reassigned\", {}, locale);\n              } else if (approve.judge === 'relocated') {\n                judge_name = TAPi18n.__(\"Instance State relocated\", {}, locale);\n              } else if (approve.judge === '') {\n                judge_name = \"\";\n              } else {\n                judge_name = \"\";\n              }\n            } else {\n              judge_name = TAPi18n.__(\"Instance State pending\", {}, locale);\n            }\n            return approves.push({\n              _id: approve._id,\n              handler: approve.user,\n              handler_name: approve.handler_name,\n              handler_organization_name: approve.handler_organization_name,\n              handler_organization_fullname: approve.handler_organization_fullname,\n              finish_date: approve.finish_date,\n              judge: approve.judge,\n              judge_name: judge_name,\n              description: approve.description,\n              is_finished: approve.is_finished,\n              type: approve.type,\n              opinion_fields_code: approve.opinion_fields_code,\n              sign_field_code: approve.sign_field_code,\n              is_read: approve.is_read,\n              sign_show: approve.sign_show\n            });\n          });\n        }\n        if (step) {\n          if (step.name in traces) {\n            return traces[step.name] = traces[step.name].concat(approves);\n          } else {\n            return traces[step.name] = approves;\n          }\n        }\n      });\n    }\n    return traces;\n  },\n  doc_values: function() {\n    return WorkflowManager_format.getAutoformSchemaValues();\n  },\n  instance_box_style: function() {\n    var box, ins, judge;\n    box = Session.get(\"box\");\n    if (box === \"inbox\" || box === \"draft\") {\n      judge = Session.get(\"judge\");\n      if (judge) {\n        if (judge === \"approved\") {\n          return \"box-success\";\n        } else if (judge === \"rejected\") {\n          return \"box-danger\";\n        }\n      }\n    }\n    ins = WorkflowManager.getInstance();\n    if (ins && ins.final_decision) {\n      if (ins.final_decision === \"approved\") {\n        return \"box-success\";\n      } else if (ins.final_decision === \"rejected\") {\n        return \"box-danger\";\n      }\n    }\n  },\n  table_fields: function(instance) {\n    var fields, form_version;\n    if (Meteor.isClient) {\n      form_version = WorkflowManager.getInstanceFormVersion();\n    } else {\n      form_version = WorkflowManager.getFormVersion(instance.form, instance.form_version);\n    }\n    if (form_version) {\n      fields = _.clone(form_version.fields);\n      fields.forEach(function(field, index) {\n        var after_field, before_field, pre_fields, pre_wide_fields, td_colspan, tr_end, tr_start;\n        field.tr_start = \"\";\n        field.tr_end = \"\";\n        td_colspan = 1;\n        if ((typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) === field.code) {\n          field.is_wide = true;\n        }\n        if (field.formula && field.type !== 'odata') {\n          field.permission = \"readonly\";\n        }\n        if (Steedos.isMobile()) {\n          if (field.type === 'section' || field.type === 'table') {\n            field.td_colspan = 4;\n          } else {\n            field.td_colspan = 3;\n          }\n          if (index !== 0) {\n            field.tr_start = \"<tr>\";\n            return field.tr_end = \"</tr>\";\n          }\n        } else {\n          pre_fields = fields.slice(0, index);\n          pre_wide_fields = pre_fields.filterProperty(\"is_wide\", true);\n          tr_start = \"\";\n          tr_end = \"\";\n          before_field = null;\n          after_field = null;\n          if (index > 0) {\n            before_field = fields[index - 1];\n          }\n          if (index < fields.length - 1) {\n            after_field = fields[index + 1];\n          }\n          if (field.type === 'section' || field.type === 'table') {\n            td_colspan = 4;\n          } else if (field.is_wide) {\n            td_colspan = 3;\n          } else {\n            if (before_field && after_field && before_field.is_wide && after_field.is_wide) {\n              field.is_wide = true;\n              td_colspan = 3;\n            }\n            if ((pre_fields.length + pre_wide_fields.length) % 2 === 0 && after_field && after_field.is_wide) {\n              field.is_wide = true;\n              td_colspan = 3;\n            }\n            if ((pre_fields.length + pre_wide_fields.length) % 2 === 0 && after_field === null) {\n              field.is_wide = true;\n              td_colspan = 3;\n            }\n          }\n          field.td_colspan = td_colspan;\n          if (index === 0) {\n            tr_start = \"<tr>\";\n          } else {\n            if ((pre_fields.length + pre_wide_fields.length) % 2 === 0 || field.is_wide) {\n              if (field.type === 'table') {\n                tr_start = \"<tr class = \\\"tr-child-table\\\">\";\n              } else {\n                tr_start = \"<tr>\";\n              }\n            }\n          }\n          field.tr_start = tr_start;\n          if (index + 1 === fields.length || field.type === 'section' || field.type === 'table' || field.is_wide) {\n            tr_end = \"</tr>\";\n          }\n          if ((pre_fields.length + pre_wide_fields.length) % 2 !== 0) {\n            tr_end = \"</tr>\";\n          }\n          return field.tr_end = tr_end;\n        }\n      });\n      return fields;\n    }\n  },\n  sort_approve: function(approves, order) {\n    if (!approves) {\n      return [];\n    }\n    if (!approves instanceof Array) {\n      return [];\n    } else {\n      if (order === 'desc') {\n        approves.sort(function(p1, p2) {\n          var _p1, _p2;\n          _p1 = 0;\n          _p2 = 0;\n          if (p1.finish_date) {\n            _p1 = p1.finish_date.getTime();\n          }\n          if (p2.finish_date) {\n            _p2 = p2.finish_date.getTime();\n          }\n          return _p2 - _p1;\n        });\n      } else {\n        approves.sort(function(p1, p2) {\n          var _p1, _p2;\n          _p1 = 0;\n          _p2 = 0;\n          if (p1.finish_date) {\n            _p1 = p1.finish_date.getTime();\n          }\n          if (p2.finish_date) {\n            _p2 = p2.finish_date.getTime();\n          }\n          return _p1 - _p2;\n        });\n      }\n    }\n    return approves;\n  },\n  _t: function(key) {\n    return TAPi18n.__(key);\n  },\n  getField: function(code) {\n    var form_version;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    if (form_version) {\n      return form_version.fields.findPropertyByPK(\"code\", code);\n    }\n  },\n  getValue: function(code) {\n    var form_version, instance, locale, utcOffset, values;\n    instance = Template.instance().view.template.steedosData.instance;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    locale = Template.instance().view.template.steedosData.locale;\n    utcOffset = Template.instance().view.template.steedosData.utcOffset;\n    values = instance.values || {};\n    if (Meteor.isClient) {\n      values = WorkflowManager_format.getAutoformSchemaValues();\n    }\n    return InstanceReadOnlyTemplate.getValue(values[code], form_version.fields.findPropertyByPK(\"code\", code), locale, utcOffset);\n  },\n  getLabel: function(code) {\n    var form_version;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    return InstanceReadOnlyTemplate.getLabel(form_version.fields, code);\n  },\n  getCfClass: function(field) {\n    if ((field != null ? field.type : void 0) === \"input\" && (field != null ? field.is_textarea : void 0)) {\n      return \"cfTextarea\";\n    }\n  },\n  getTableThead: function(field) {\n    return SteedosTable.getThead(field, false);\n  },\n  getTableBody: function(field) {\n    var instance, tableValue, values;\n    if (Meteor.isServer) {\n      instance = Template.instance().view.template.steedosData.instance;\n      values = instance.values || {};\n    } else {\n      values = WorkflowManager_format.getAutoformSchemaValues();\n    }\n    tableValue = values[field.code];\n    return SteedosTable.getTbody(field.sfields.getProperty(\"code\"), field, tableValue, false);\n  },\n  showLabel: function(field) {\n    var templateData;\n    templateData = Template.instance().data;\n    if (templateData.label === false) {\n      return false;\n    }\n    return true;\n  },\n  isOpinionField: function(field) {\n    return InstanceformTemplate.helpers.isOpinionField_from_string(field.formula);\n  },\n  isOpinionField_from_string: function(field_formula) {\n    return InstanceSignText.isOpinionField_from_string(field_formula);\n  },\n  includesOpinionField: function(form, form_version) {\n    var field_formulas, fields, ref;\n    field_formulas = new Array();\n    fields = ((ref = db.form_versions.findOne({\n      _id: form_version,\n      form: form\n    })) != null ? ref.fields : void 0) || [];\n    fields.forEach(function(f) {\n      var ref1;\n      if (f.type === 'table') {\n        return console.log('ignore opinion field in table');\n      } else if (f.type === 'section') {\n        return f != null ? (ref1 = f.fields) != null ? ref1.forEach(function(f1) {\n          return field_formulas.push(f1.formula);\n        }) : void 0 : void 0;\n      } else {\n        return field_formulas.push(f.formula);\n      }\n    });\n    return _.some(field_formulas, function(field_formula) {\n      return InstanceformTemplate.helpers.isOpinionField_from_string(field_formula);\n    });\n  },\n  getOpinionFieldStepsName: function(field_formula, top_keywords) {\n    var foo1, opinionFields;\n    opinionFields = new Array();\n    if (InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)) {\n      if (field_formula) {\n        foo1 = field_formula.split(\";\");\n        foo1.forEach(function(foo) {\n          var json_formula, ref, ref1, s1, sf;\n          json_formula = {};\n          try {\n            json_formula = eval(\"(\" + foo + \")\");\n          } catch (error1) {\n            json_formula = {};\n          }\n          if (json_formula != null ? json_formula.yijianlan : void 0) {\n            sf = {};\n            sf.stepName = json_formula.yijianlan.step;\n            sf.image_sign = json_formula.yijianlan.image_sign || false;\n            sf.only_cc_opinion = json_formula.yijianlan.only_cc || false;\n            sf.default_description = json_formula.yijianlan[\"default\"];\n            sf.only_handler = json_formula.yijianlan.only_handler;\n            sf.top_keywords = json_formula.yijianlan.top_keywords || top_keywords;\n            return opinionFields.push(sf);\n          } else if ((field_formula != null ? field_formula.indexOf(\"{traces.\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{signature.traces.\") : void 0) > -1) {\n            sf = {\n              only_cc_opinion: false,\n              image_sign: false,\n              top_keywords: top_keywords\n            };\n            if (foo.indexOf(\"{signature.\") > -1) {\n              sf.image_sign = true;\n              foo = foo.replace(\"{signature.\", \"\");\n            }\n            s1 = foo.replace(\"{\", \"\").replace(\"}\", \"\");\n            if (s1.split(\".\").length > 1) {\n              sf.stepName = s1.split(\".\")[1];\n              if (opinionFields.filterProperty(\"stepName\", sf.stepName).length > 0) {\n                if ((ref = opinionFields.findPropertyByPK(\"stepName\", sf.stepName)) != null) {\n                  ref.only_cc_opinion = true;\n                }\n              } else {\n                if (s1.split(\".\").length > 2) {\n                  if (((ref1 = s1.split(\".\")[2]) != null ? ref1.toLocaleLowerCase() : void 0) === 'cc') {\n                    sf.only_cc_opinion = true;\n                  }\n                }\n              }\n            }\n            return opinionFields.push(sf);\n          }\n        });\n      }\n    }\n    return opinionFields;\n  },\n  showCCOpinion: function(field) {\n    var ref, ref1, ref2, s1;\n    if (((ref = field.formula) != null ? ref.indexOf(\"{traces.\") : void 0) > -1 || ((ref1 = field.formula) != null ? ref1.indexOf(\"{signature.traces.\") : void 0) > -1) {\n      s1 = field.formula.replace(\"{signature.\", \"\").replace(\"{\", \"\").replace(\"}\", \"\");\n      if (s1.split(\".\").length > 2) {\n        if (((ref2 = s1.split(\".\")[2]) != null ? ref2.toLocaleLowerCase() : void 0) === 'cc') {\n          return true;\n        }\n      }\n    }\n    return false;\n  },\n  markDownToHtml: function(markDownString) {\n    var renderer;\n    if (markDownString) {\n      renderer = new Markdown.Renderer();\n      renderer.link = function(href, title, text) {\n        return \"<a target='_blank' href='\" + href + \"' title='\" + title + \"'>\" + text + \"</a>\";\n      };\n      return Spacebars.SafeString(Markdown(markDownString, {\n        renderer: renderer\n      }));\n    }\n  },\n  f_label: function(that) {\n    return that.name || that.code;\n  }\n};\n\nif (Meteor.isServer) {\n  InstanceformTemplate.helpers.steedos_form = function() {\n    return this.form_version;\n  };\n  InstanceformTemplate.helpers.isSection = function(code) {\n    var form_version;\n    form_version = this.form_version;\n    return form_version.fields.findPropertyByPK(\"code\", code).type === 'section';\n  };\n  InstanceformTemplate.helpers.doc_values = function() {\n    var instance;\n    instance = this.instance;\n    return instance.values;\n  };\n  InstanceformTemplate.helpers.applicantContext = function() {\n    var data, instance;\n    instance = this.instance;\n    return data = {\n      name: 'ins_applicant',\n      atts: {\n        name: 'ins_applicant',\n        id: 'ins_applicant',\n        \"class\": 'selectUser form-control ins_applicant'\n      },\n      value: instance.applicant_name\n    };\n  };\n  InstanceformTemplate.helpers.instance = function() {\n    return this.instance;\n  };\n  InstanceformTemplate.helpers.fields = function() {\n    var form_version;\n    form_version = this.form_version;\n    if (form_version) {\n      return new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n    }\n  };\n  InstanceformTemplate.helpers.form_types = function() {\n    return \"disabled\";\n  };\n  Template.registerHelper(\"afFieldLabelText\", function(op) {\n    var form_version, ref;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    return InstanceReadOnlyTemplate.getLabel(form_version.fields, op != null ? (ref = op.hash) != null ? ref.name : void 0 : void 0);\n  });\n  InstanceformTemplate.helpers._t = function(key) {\n    var locale;\n    locale = this.locale;\n    return TAPi18n.__(key, {}, locale);\n  };\n  InstanceformTemplate.helpers.ins_attach_download_url = function(_id, absolute) {\n    if (absolute) {\n      return Meteor.absoluteUrl(\"/api/files/instances/\" + _id + \"?download=true\");\n    } else {\n      return \"/api/files/instances/\" + _id + \"?download=true\";\n    }\n  };\n  InstanceformTemplate.helpers.options = function(field) {\n    var options, ref, rev;\n    options = field != null ? (ref = field.options) != null ? ref.split(\"\\n\") : void 0 : void 0;\n    rev = [];\n    if (options != null) {\n      options.forEach(function(item) {\n        return rev.push({\n          label: item,\n          value: item\n        });\n      });\n    }\n    return rev;\n  };\n  InstanceformTemplate.helpers.getPermissions = function(code) {\n    var ref;\n    if (!((ref = Template.instance().view.template.steedosData.startStepEditableFields) != null ? ref.includes(code) : void 0)) {\n      return \"readonly disabled\";\n    }\n    return \"\";\n  };\n}\n\nInstanceformTemplate.events = {\n  'change .form-control,.checkbox input,.af-radio-group input,.af-checkbox-group input': function(event) {\n    return InstanceManager.instanceformChangeEvent(event);\n  },\n  'typeahead:change .form-control': function(event) {\n    return InstanceManager.instanceformChangeEvent(event);\n  },\n  'click .cfTextarea a': function(event) {\n    event.preventDefault();\n    return Steedos.openWindow(event.target.href);\n  }\n};\n\nInstanceformTemplate.onCreated = function() {\n  var compiled, e, instance, instanceCustomTemplate, instanceView, renderFunction, template;\n  instance = WorkflowManager.getInstance();\n  if (!instance) {\n    return;\n  }\n  template = TemplateManager.getTemplate(instance);\n  try {\n    compiled = SpacebarsCompiler.compile(template, {\n      isBody: true\n    });\n  } catch (error1) {\n    e = error1;\n    console.log(\"Instance Template Error\", e);\n    compiled = SpacebarsCompiler.compile(\"\", {\n      isBody: true\n    });\n  }\n  renderFunction = eval(compiled);\n  instanceView = new Blaze.View(\"custom_instance_template\", renderFunction);\n  instanceCustomTemplate = new Blaze.Template(instanceView.name, renderFunction);\n  Template.instance_custom_template = instanceCustomTemplate;\n  return Template.instance_custom_template.helpers(InstanceformTemplate.helpers);\n};\n\nInstanceformTemplate.onRendered = function() {\n  var currentApprove, currentStep, form_version, formula_fields, instance, instanceNumberFields, judge, ref;\n  instance = WorkflowManager.getInstance();\n  if (!instance) {\n    return;\n  }\n  if ((ref = $(\"input[name='ins_applicant']\")[0]) != null) {\n    ref.dataset.values = instance.applicant;\n  }\n  $(\"input[name='ins_applicant']\").val(instance.applicant_name);\n  ApproveManager.error = {\n    nextSteps: '',\n    nextStepUsers: ''\n  };\n  if (Session.get(\"box\") === 'inbox' || Session.get(\"box\") === 'draft') {\n    InstanceEvent.initEvents(instance.flow);\n  }\n  if (!ApproveManager.isReadOnly()) {\n    currentApprove = InstanceManager.getCurrentApprove();\n    instanceNumberFields = $(\"[data-formula]\", $(\"#instanceform\"));\n    instanceNumberFields.each(function() {\n      var element, schemaKey;\n      schemaKey = this.dataset.schemaKey;\n      element = $(this);\n      if (!$(this).val() && schemaKey && Session.get(\"instanceId\")) {\n        return Meteor.call('getInstanceValues', Session.get(\"instanceId\"), function(error, result) {\n          var key, ref1;\n          if (error) {\n            toastr.error(error.reason);\n          }\n          if (!result[schemaKey]) {\n            key = (ref1 = element.data(\"formula\")) != null ? ref1.replace(\"auto_number(\", \"\").replace(\")\", \"\") : void 0;\n            key = key.replace(/\\\"/g, \"\").replace(/\\'/g, \"\");\n            if (key.indexOf(\"{\") > -1) {\n              key = key.replace(\"{\", \"\").replace(\"}\", \"\");\n              key = key.trim();\n              key = AutoForm.getFieldValue(key, 'instanceform');\n            }\n            return InstanceNumberRules.instanceNumberBuilder(element, key);\n          } else {\n            return element != null ? element.val(result[schemaKey]).trigger(\"change\") : void 0;\n          }\n        });\n      }\n    });\n    judge = currentApprove.judge;\n    currentStep = InstanceManager.getCurrentStep();\n    form_version = WorkflowManager.getInstanceFormVersion();\n    formula_fields = Form_formula.getFormulaFieldVariable(\"Form_formula.field_values\", form_version.fields);\n    Form_formula.run(\"\", \"\", formula_fields, AutoForm.getFormValues(\"instanceform\").insertDoc, form_version.fields);\n    return Session.set(\"instance_form_values\", {\n      instanceId: instance._id,\n      values: AutoForm.getFormValues(\"instanceform\").insertDoc\n    });\n  }\n};\n","InstanceAttachmentTemplate.helpers = {\r\n\r\n\tshowMainTitle: function() {\r\n\t\treturn Template.instance().workflowMainAttachTitle.get();\r\n\t},\r\n\tenabled_add_main_attachment: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false\r\n\r\n\t\tif (Session && Session.get(\"instancePrint\"))\r\n\t\t\treturn false\r\n\r\n\t\tif (Session.get(\"box\") != \"draft\" && Session.get(\"box\") != \"inbox\") {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\t// å·²ç»ç»“æŸçš„å•å­ä¸èƒ½æ”¹é™„ä»¶\r\n\t\tif (ins.state == \"completed\") {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\tvar current_step = InstanceManager.getCurrentStep();\r\n\r\n\t\tif (!current_step)\r\n\t\t\treturn false;\r\n\r\n\t\t// åˆ†å‘çš„æ­£æ–‡æˆ–è€…é™„ä»¶ä¸æ˜¾ç¤ºè½¬ä¸ºpdfæŒ‰é’®\r\n\t\t// å¦‚æžœæœ‰æ­£æ–‡æƒé™åˆ™ä¸ºæ­£æ–‡ï¼Œå¦åˆ™åˆ†å‘ä¸ºé™„ä»¶\r\n\t\t// åˆ†å‘çš„é™„ä»¶ä¸å…è®¸ä¿®æ”¹ åˆ é™¤ æ–°å¢žç‰ˆæœ¬\r\n\t\tvar main_attach_count = cfs.instances.find({\r\n\t\t\t'metadata.instance': ins._id,\r\n\t\t\t'metadata.current': true,\r\n\t\t\t'metadata.main': true\r\n\t\t}).count();\r\n\r\n\t\tvar distribute_main_attach_count = 0;\r\n\r\n\t\tif (ins.distribute_from_instance) {\r\n\t\t\tvar start_step = InstanceManager.getStartStep();\r\n\t\t\tif (start_step.can_edit_main_attach) {\r\n\t\t\t\tvar distribute_main_attach_count = cfs.instances.find({\r\n\t\t\t\t\t'metadata.instance': ins.distribute_from_instance,\r\n\t\t\t\t\t'metadata.current': true,\r\n\t\t\t\t\t'metadata.main': true\r\n\t\t\t\t}).count();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (current_step.can_edit_main_attach == true && main_attach_count < 1 && distribute_main_attach_count < 1) {\r\n\t\t\treturn true\r\n\t\t}\r\n\r\n\t\t// æ­£æ–‡æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª\r\n\t\tif (main_attach_count >= 1 || distribute_main_attach_count >= 1) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// å¼€å§‹èŠ‚ç‚¹å¹¶ä¸”è®¾ç½®äº†å¯ä»¥ä¸Šä¼ æ­£æ–‡æ‰æ˜¾ç¤ºä¸Šä¼ æ­£æ–‡çš„æŒ‰é’®\r\n\t\tvar current_step = InstanceManager.getCurrentStep();\r\n\t\tif (current_step && current_step.step_type == \"start\" && current_step.can_edit_main_attach == true)\r\n\t\t\treturn true\r\n\r\n\t\treturn false\r\n\t},\r\n\r\n\tenabled_edit_normal_attachment: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false\r\n\r\n\t\tif (Session && Session.get(\"instancePrint\"))\r\n\t\t\treturn false\r\n\r\n\t\tvar flow = WorkflowManager.getFlow(ins.flow);\r\n\t\tif (!flow)\r\n\t\t\treturn false\r\n\r\n\r\n\t\t// åˆ†å‘åŽçš„ é™„ä»¶ï¼Œä¸å¯ä»¥ç¼–è¾‘/åˆ é™¤ï¼Œä¹Ÿä¸è®©ä¸Šä¼ æ–°çš„é™„ä»¶, æµç¨‹åˆ—è¡¨ï¼šæ·»åŠ å±žæ€§ â€˜è¢«åˆ†å‘åŽæ˜¯å¦å…è®¸ä¸Šä¼ é™„ä»¶â€™ #1837\r\n\t\tif (ins.distribute_from_instance && !flow.upload_after_being_distributed)\r\n\t\t\treturn false\r\n\r\n\t\tif (Session.get(\"box\") != \"draft\" && Session.get(\"box\") != \"inbox\") {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\t// å·²ç»ç»“æŸçš„å•å­ä¸èƒ½æ”¹é™„ä»¶\r\n\t\tif (ins.state == \"completed\") {\r\n\t\t\treturn false\r\n\t\t}\r\n\r\n\t\tif (InstanceManager.isCC(ins)) {\r\n\t\t\tvar step = InstanceManager.getCCStep();\r\n\t\t\tif (step && (step.can_edit_normal_attach == true || step.can_edit_normal_attach == undefined))\r\n\t\t\t\treturn true\r\n\t\t} else {\r\n\t\t\tvar current_step = InstanceManager.getCurrentStep();\r\n\t\t\tif (current_step && (current_step.can_edit_normal_attach == true || current_step.can_edit_normal_attach == undefined))\r\n\t\t\t\treturn true\r\n\t\t}\r\n\r\n\t\treturn false\r\n\t},\r\n\r\n\tmain_attachment: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false\r\n\r\n\t\tvar start_step = InstanceManager.getStartStep();\r\n\r\n\t\t// å¦‚æžœæ˜¯è¢«åˆ†å‘çš„ç”³è¯·å•å¹¶ä¸”æœ‰ä¿®æ”¹æ­£æ–‡çš„æƒé™ï¼Œåˆ™ä¼˜å…ˆæ˜¾ç¤ºåŽŸç”³è¯·å•æ–‡ä»¶\r\n\t\tvar main_attach = null;\r\n\t\tif (ins.distribute_from_instance && start_step.can_edit_main_attach == true) {\r\n\t\t\tmain_attach = cfs.instances.findOne({\r\n\t\t\t\t'metadata.instance': ins.distribute_from_instance,\r\n\t\t\t\t'metadata.current': true,\r\n\t\t\t\t'metadata.main': true\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (!main_attach) {\r\n\t\t\tmain_attach = cfs.instances.findOne({\r\n\t\t\t\t'metadata.instance': ins._id,\r\n\t\t\t\t'metadata.current': true,\r\n\t\t\t\t'metadata.main': true\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\treturn main_attach;\r\n\t},\r\n\r\n\tnormal_attachments: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false\r\n\r\n\t\tvar selector = {\r\n\t\t\t'metadata.current': true,\r\n\t\t\t'metadata.main': {\r\n\t\t\t\t$ne: true\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tvar atts = new Array();\r\n\r\n\t\tif (ins.distribute_from_instance) {\r\n\t\t\t// å¦‚æžœæ˜¯è¢«åˆ†å‘çš„ç”³è¯·å•ï¼Œåˆ™æ˜¾ç¤ºåŽŸç”³è¯·å•æ–‡ä»¶, å¦‚æžœé€‰æ‹©äº†å°†åŽŸè¡¨å•å­˜å‚¨ä¸ºé™„ä»¶ä¹Ÿè¦æ˜¾ç¤º, åŒæ—¶ä¹Ÿè¦æ˜¾ç¤ºæ–°ä¸Šä¼ çš„é™„ä»¶\r\n\t\t\tvar dfis = _.clone(ins.distribute_from_instances) || [];\r\n\t\t\tdfis.push(ins._id);\r\n\t\t\tselector['metadata.instance'] = {\r\n\t\t\t\t$in: dfis\r\n\t\t\t};\r\n\r\n\r\n\t\t\tselector[\"$or\"] = [{\r\n\t\t\t\t\"metadata.instance\": ins._id\r\n\t\t\t}, {\r\n\t\t\t\t\"metadata.instance\": {\r\n\t\t\t\t\t$in: ins.distribute_from_instances\r\n\t\t\t\t},\r\n\t\t\t\t\"metadata.is_private\": {\r\n\t\t\t\t\t$ne: true\r\n\t\t\t\t}\r\n\t\t\t}]\r\n\r\n\t\t\t// å¦‚æžœåŽŸç”³è¯·å•æœ‰æ­£æ–‡ä½†æ˜¯åˆ†å‘åŽæ²¡æœ‰æ­£æ–‡æƒé™ï¼Œåˆ™åŽŸç”³è¯·å•æ­£æ–‡æ˜¾ç¤ºåœ¨é™„ä»¶æ \r\n\t\t\tvar start_step = InstanceManager.getStartStep();\r\n\t\t\tif (start_step && start_step.can_edit_main_attach != true) {\r\n\t\t\t\tvar distribute_main = cfs.instances.findOne({\r\n\t\t\t\t\t'metadata.instance': {\r\n\t\t\t\t\t\t$in: ins.distribute_from_instances\r\n\t\t\t\t\t},\r\n\t\t\t\t\t'metadata.current': true,\r\n\t\t\t\t\t'metadata.main': true,\r\n\t\t\t\t});\r\n\t\t\t\tif (distribute_main) {\r\n\t\t\t\t\tvar firstVersionMain = cfs.instances.findOne(distribute_main.metadata.parent);\r\n\t\t\t\t\tdistribute_main.attachmentUploadedAt = firstVersionMain ? firstVersionMain.uploadedAt : distribute_main.uploadedAt;\r\n\t\t\t\t\tatts.push(distribute_main);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tselector['metadata.instance'] = ins._id;\r\n\t\t}\r\n\r\n\t\tcfs.instances.find(selector).forEach(function(c) {\r\n\t\t\tvar firstVersion = cfs.instances.findOne(c.metadata.parent);\r\n\t\t\tc.attachmentUploadedAt = firstVersion ? firstVersion.uploadedAt : c.uploadedAt;\r\n\t\t\tatts.push(c);\r\n\t\t})\r\n\r\n\t\treturn _.sortBy(atts, 'attachmentUploadedAt');\r\n\t},\r\n\r\n\tshowAttachments: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false;\r\n\r\n\t\t// å¦‚æžœæ˜¯è¢«åˆ†å‘çš„ç”³è¯·å•ï¼Œåˆ™æ˜¾ç¤ºåŽŸç”³è¯·å•æ–‡ä»¶ å’Œåˆ†å‘åŽç”³è¯·å•æ–‡ä»¶\r\n\t\tvar instanceIds = _.clone(ins.distribute_from_instances) || [];\r\n\t\tinstanceIds.push(ins._id);\r\n\t\tvar attachments_count = cfs.instances.find({\r\n\t\t\t'metadata.instance': {\r\n\t\t\t\t$in: instanceIds\r\n\t\t\t},\r\n\t\t\t'metadata.current': true\r\n\t\t}).count();\r\n\r\n\t\tif (Session && Session.get(\"instancePrint\") && attachments_count < 1)\r\n\t\t\treturn false\r\n\r\n\t\tif (Session.get(\"box\") == \"draft\" || Session.get(\"box\") == \"inbox\" || attachments_count > 0)\r\n\t\t\treturn true;\r\n\t\telse\r\n\t\t\treturn false;\r\n\t},\r\n\r\n\t_t: function(key) {\r\n\t\treturn TAPi18n.__(key)\r\n\t},\r\n\r\n\t_: function(key) {\r\n\t\tvar locale;\r\n\t\tif (Meteor.isClient) {\r\n\t\t\treturn TAPi18n.__(key);\r\n\t\t} else {\r\n\t\t\tlocale = Template.instance().view.template.steedosData.locale;\r\n\t\t\treturn TAPi18n.__(key, {}, locale);\r\n\t\t}\r\n\t},\r\n\r\n\tflow_files: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false;\r\n\t\treturn cfs.files.find({ 'metadata.space': ins.space, 'metadata.object_name': 'flows', 'metadata.record_id': ins.flow });\r\n\t},\r\n\r\n\tisDraftAndFlowfilesExist: function() {\r\n\t\tvar ins = WorkflowManager.getInstance();\r\n\t\tif (!ins)\r\n\t\t\treturn false;\r\n\t\treturn (Session.get('box') == 'draft') && !!cfs.files.find({ 'metadata.space': ins.space, 'metadata.object_name': 'flows', 'metadata.record_id': ins.flow }).count();\r\n\t}\r\n\r\n\r\n}\r\n\r\nif (Meteor.isServer) {\r\n\tInstanceAttachmentTemplate.helpers._t = function(key) {\r\n\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\treturn TAPi18n.__(key, {}, locale)\r\n\t}\r\n\tInstanceAttachmentTemplate.helpers.enabled_add_main_attachment = function() {\r\n\t\treturn false\r\n\t};\r\n\tInstanceAttachmentTemplate.helpers.enabled_edit_normal_attachment = function() {\r\n\t\treturn false\r\n\t};\r\n\r\n\tInstanceAttachmentTemplate.helpers.main_attachment = function() {\r\n\t\tvar instance = Template.instance().view.template.steedosData.instance;\r\n\t\tvar instanceIds = _.compact([instance.distribute_from_instance, instance._id]);\r\n\t\tvar attachment = cfs.instances.findOne({\r\n\t\t\t'metadata.instance': {\r\n\t\t\t\t$in: instanceIds\r\n\t\t\t},\r\n\t\t\t'metadata.current': true,\r\n\t\t\t'metadata.main': true\r\n\t\t});\r\n\r\n\t\treturn attachment;\r\n\t};\r\n\r\n\tInstanceAttachmentTemplate.helpers.normal_attachments = function() {\r\n\t\tvar steedosData = Template.instance().view.template.steedosData\r\n\t\tvar instance = steedosData.instance;\r\n\t\tvar instanceIds = _.clone(instance.distribute_from_instances) || [];\r\n\t\tinstanceIds.push(instance._id);\r\n\t\tvar attachments = cfs.instances.find({\r\n\t\t\t'metadata.instance': {\r\n\t\t\t\t$in: instanceIds\r\n\t\t\t},\r\n\t\t\t'metadata.current': true,\r\n\t\t\t'metadata.main': {\r\n\t\t\t\t$ne: true\r\n\t\t\t},\r\n\t\t\t$or: [{\r\n\t\t\t\t'metadata.is_private': {\r\n\t\t\t\t\t$ne: true\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t'metadata.is_private': true,\r\n\t\t\t\t\"metadata.owner\": steedosData.userId\r\n\t\t\t}]\r\n\t\t}).fetch();\r\n\r\n\t\treturn attachments;\r\n\t};\r\n\r\n\tInstanceAttachmentTemplate.helpers.showAttachments = function() {\r\n\t\tvar instance = Template.instance().view.template.steedosData.instance;\r\n\t\tvar instanceIds = _.clone(instance.distribute_from_instances) || [];\r\n\t\tinstanceIds.push(instance._id);\r\n\r\n\t\tvar attachments = cfs.instances.find({\r\n\t\t\t'metadata.instance': {\r\n\t\t\t\t$in: instanceIds\r\n\t\t\t},\r\n\t\t\t'metadata.current': true\r\n\t\t}).fetch();\r\n\r\n\t\tif (attachments && attachments.length > 0) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tInstanceAttachmentTemplate.helpers.showMainTitle = function() {\r\n\t\tvar instance = Template.instance().view.template.steedosData.instance;\r\n\t\tvar instanceIds = _.compact([instance.distribute_from_instance, instance._id]);\r\n\t\tvar main_attach_count = cfs.instances.find({\r\n\t\t\t'metadata.instance': {\r\n\t\t\t\t$in: instanceIds\r\n\t\t\t},\r\n\t\t\t'metadata.current': true,\r\n\t\t\t'metadata.main': true\r\n\t\t}).count();\r\n\r\n\t\treturn main_attach_count > 0\r\n\t}\r\n}\r\n","InstanceSignText.helpers =\r\n\tshow: (stepName)->\r\n\t\tif Meteor.isClient\r\n\t\t\tif Session.get('instancePrint')\r\n\t\t\t\treturn false\r\n\t\t\tif InstanceManager.isInbox()\r\n\t\t\t\tmyApprove = InstanceManager.getCurrentApprove()\r\n\t\t\t\tif myApprove\r\n\t\t\t\t\tinstance = WorkflowManager.getInstance();\r\n\t\t\t\t\tmyTrace = instance?.traces?.findPropertyByPK(\"_id\", myApprove.trace)\r\n\t\t\t\t\treturn myTrace?.name == stepName\r\n\t\treturn false\r\n\r\n\tdefaultDescription: ()->\r\n#\t\treturn Template.instance().data.default_description || TAPi18n.__(\"instance_default_opinion\")\r\n\t\treturn Template.instance().data.default_description\r\n\r\n\ttraces: ()->\r\n\t\tInstanceformTemplate.helpers.traces()\r\n\r\n\ttrace: (stepName, only_cc_opinion, image_sign, top_keywords)->\r\n\t\tinstance = InstanceformTemplate.helpers.instance()\r\n\r\n\t\tis_completed = instance?.state == \"completed\"\r\n\r\n\t\tcompleted_date = if is_completed then _.last(instance.traces)?.finish_date?.getTime() else 0\r\n\r\n\t\tif is_completed && instance.finish_date\r\n\t\t\tcompleted_date = instance.finish_date?.getTime()\r\n\r\n\t\ttraces = InstanceformTemplate.helpers.traces()\r\n\r\n\t\tapproves = _.clone(traces[stepName])\r\n\r\n\t\tapprove_sort = (approves, top_keywords)->\r\n\r\n#å¯¹ApprovesæŽ’åºï¼Œ æŒ‰ç…§æäº¤æ—¶é—´æŽ’å€’åºï¼Œå¦‚æžœæ²¡æœ‰æäº¤åˆ™æ˜¾ç¤ºåœ¨æœ€ä¸Šè¾¹\r\n\t\t\tapproves_sorted = _.sortBy approves, (approve)->\r\n\t\t\t\treturn -(approve.finish_date || new Date()).getTime()\r\n\r\n\t\t\t#é€šè¿‡å…³é”®å­—æŽ’åº\r\n\t\t\tif top_keywords\r\n\t\t\t\ttop_approves = new Array()\r\n\r\n\t\t\t\ttop_keywords.split(\",\").forEach (key) ->\r\n\t\t\t\t\ttop_approves = _.union top_approves, _.filter(approves_sorted, (approve)->\r\n\t\t\t\t\t\treturn approve?.handler_name?.indexOf(key) > -1\r\n\t\t\t\t\t)\r\n\t\t\t\t# å¯¹ç½®é¡¶æ„è§æŒ‰ç…§å¤„ç†äº‹ä»¶æŽ’å€’åº\r\n\t\t\t\ttop_approves = _.sortBy top_approves, (top_approve)->\r\n\t\t\t\t\treturn -(top_approve.finish_date || new Date()).getTime()\r\n\r\n\t\t\t\tapproves_sorted = _.union top_approves, approves_sorted\r\n\t\t\treturn approves_sorted || []\r\n\r\n\t\tapproves = _.filter approves, (a)->\r\n\t\t\treturn a.type isnt \"forward\" and a.type isnt \"distribute\" and a.type isnt \"terminated\"\r\n\r\n\t\tif only_cc_opinion\r\n\t\t\tapproves = approves?.filterProperty(\"type\", \"cc\")\r\n\r\n\t\tapproves_sorted = approve_sort(approves, top_keywords)\r\n\r\n\t\tapprovesGroup = _.groupBy(approves, \"handler\");\r\n\r\n\t\thasNext = (approve, approvesGroup) ->\r\n\t\t\thandlerApproves = approvesGroup[approve.handler]\r\n\t\t\treturn _.indexOf(handlerApproves, approve) + 1 < handlerApproves.length\r\n\r\n\t\thaveDescriptionApprove = (approve, approvesGroup) ->\r\n\t\t\thandlerApproves = approvesGroup[approve.handler]\r\n\r\n\t\t\tdescriptionApproves = _.filter handlerApproves, (a)->\r\n\t\t\t\tif a.description\r\n\t\t\t\t\treturn true\r\n\t\t\t\treturn false\r\n\r\n\t\t\tif descriptionApproves.length == 0\r\n\t\t\t\treturn false\r\n\r\n\t\t\treturn true\r\n\r\n\r\n\t\tapproves_sorted.forEach (approve) ->\r\n#\t\t\tæœ‰è¾“å…¥æ„è§ æˆ– æœ€æ–°ä¸€æ¡å¹¶ä¸”ç”¨æˆ·æ²¡æœ‰è¾“å…¥è¿‡æ„è§\r\n#\t\t\tif !approve.is_finished || approve.description || (!hasNext(approve, approvesGroup) && !haveDescriptionApprove(approve, approvesGroup))\r\n#\t\t\tif !hasNext(approve, approvesGroup)\r\n\t\t\tif approve.sign_show != false && (approve.description || (!approve.description && !hasNext(approve, approvesGroup) && !approve.is_finished) )\r\n\t\t\t\tif approve.judge isnt 'terminated'\r\n\t\t\t\t\tapprove._display = true\r\n\r\n\t\tapproves_sorted = _.filter approves_sorted, (a) ->\r\n\t\t\tif is_completed\r\n\t\t\t\treturn a._display == true && a.is_finished && a.finish_date?.getTime() <= completed_date\r\n\t\t\telse\r\n\t\t\t\treturn a._display == true\r\n\r\n\t\treturn approves_sorted\r\n\r\n\tinclude: (a, b) ->\r\n\t\treturn InstanceformTemplate.helpers.include(a, b)\r\n\r\n\tunempty: (val)->\r\n\t\treturn InstanceformTemplate.helpers.unempty(val)\r\n\r\n\tformatDate: (date, options)->\r\n\t\tif !options\r\n\t\t\toptions = {\"format\": \"YYYY-MM-DD\"}\r\n\r\n\t\treturn InstanceformTemplate.helpers.formatDate(date, options)\r\n\r\n\tisMyApprove: (approve, only_cc_opinion) ->\r\n\t\tif Meteor.isClient\r\n\t\t\tins = WorkflowManager.getInstance();\r\n\r\n\t\t\tcurrentApprove = InstanceManager.getCurrentApprove()\r\n\r\n\t\t\tif !approve?._id\r\n\t\t\t\tapprove = currentApprove\r\n\r\n\t\t\tif approve._id == currentApprove?._id && currentApprove?.type == 'cc' && Template.instance().data.name\r\n\t\t\t\tif _.indexOf(currentApprove?.opinion_fields_code, Template.instance().data.name) > -1\r\n\t\t\t\t\treturn true\r\n\t\t\t\telse\r\n\t\t\t\t\treturn false\r\n\r\n\t\t\tif !(currentApprove?.type == 'cc') && only_cc_opinion\r\n\t\t\t\treturn false\r\n\r\n\t\t\tif currentApprove && approve._id == currentApprove._id\r\n\t\t\t\treturn true\r\n\t\treturn false\r\n\r\n\tmyApproveDescription: (approveId)->\r\n\t\tif Meteor.isClient\r\n\t\t\tif Session.get(\"box\") == 'inbox'\r\n\t\t\t\tmyApprove = Template.instance()?.myApprove?.get()\r\n\t\t\t\tif myApprove && myApprove.id == approveId\r\n\t\t\t\t\tif !myApprove.sign_field_code || myApprove.sign_field_code == Template.instance()?.data?.name\r\n\t\t\t\t\t\tif !Session.get(\"instance_my_approve_description\")\r\n\t\t\t\t\t\t\treturn myApprove?.description || \"\"\r\n\t\t\t\t\t\treturn Session.get(\"instance_my_approve_description\")\r\n\r\n\tnow: ()->\r\n\t\treturn new Date();\r\n\r\n\tisReadOnly: ()->\r\n\t\tif Meteor.isClient\r\n\t\t\treturn ApproveManager.isReadOnly()\r\n\t\treturn false\r\n\r\n\tisOpinionOfField: (approve)->\r\n\t\tif approve.type == \"cc\" && Template.instance().data.name\r\n\t\t\tif Template.instance().data.name == approve.sign_field_code\r\n\t\t\t\treturn true\r\n\t\t\telse\r\n\t\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn true;\r\n\r\n\tmarkDownToHtml: (markDownString)->\r\n\t\tif markDownString\r\n\t\t\trenderer = new Markdown.Renderer();\r\n\t\t\trenderer.link = (href, title, text) ->\r\n\t\t\t\treturn \"<a target='_blank' href='#{href}' title='#{title}'>#{text}</a>\"\r\n\t\t\treturn Spacebars.SafeString(Markdown(markDownString, {renderer: renderer}))\r\n\r\n\tsteps: (field_formula, step, only_cc_opinion, image_sign)->\r\n\t\tsteps = []\r\n\t\tif !step\r\n\t\t\tif !field_formula\r\n\t\t\t\tfield_formula = WorkflowManager.getInstanceFormVersion()?.fields?.findPropertyByPK(\"code\", this.name).formula\r\n\t\t\tsteps = InstanceformTemplate.helpers.getOpinionFieldStepsName(field_formula, Template.instance()?.data.top_keywords)\r\n\t\telse\r\n\t\t\tsteps = [{stepName: step, only_cc_opinion: only_cc_opinion, image_sign: image_sign}]\r\n\t\treturn steps\r\n\r\n\timageSignData: (handler) ->\r\n\t\treturn {user: handler}\r\n\r\n\tshowSignImage: (handler, image_sign) ->\r\n\t\tspaceUserSign = ImageSign.helpers.spaceUserSign(handler);\r\n\r\n\t\tif spaceUserSign?.sign && image_sign\r\n\t\t\treturn true\r\n\t\telse\r\n\t\t\treturn false\r\n\r\n\tgetLastSignApprove: ()->\r\n\t\tins = WorkflowManager.getInstance();\r\n\r\n\t\treturn _.last(TracesManager.getHandlerSignShowApproves ins, Meteor.userId())\r\n\r\n\r\n\tlastMyApproveDescription: ()->\r\n\t\ttraces = InstanceformTemplate.helpers.traces()\r\n\t\tcurrentStep = InstanceManager.getCurrentStep();\r\n\t\tapproves = _.clone(traces[currentStep.name])\r\n\r\n\t\tapproves = approves.filterProperty(\"handler\", Meteor.userId())\r\n\r\n\t\tif approves.length > 1\r\n\t\t\treturn approves[approves.length - 2]?.description\r\n\r\n\t\treturn \"\";\r\n\r\n\tshowApprove: (approve)->\r\n\t\tif !approve.sign_field_code || approve.sign_field_code == Template.instance()?.data?.name\r\n\t\t\tif approve?.is_read\r\n\t\t\t\tif approve.is_finished\r\n\t\t\t\t\treturn [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(approve.judge)\r\n\t\t\t\telse\r\n\t\t\t\t\treturn true;\r\n\t\treturn false;\r\n\r\n\tjudge_description: (judge)->\r\n\t\treturn t(judge + \"_description\")\r\n\r\n\tis_approved: (judge)->\r\n\t\treturn \"approved\" == judge\r\n\r\n\tis_rejected: (judge)->\r\n\t\treturn \"rejected\" == judge\r\n\r\n\tis_readed: (judge)->\r\n\t\treturn [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(judge)\r\n\r\n\taddClass: ()->\r\n\t\tname = Template.instance()?.data?.name\r\n\t\tsetTimeout () ->\r\n\t\t\ttry\r\n\t\t\t\telement = $(\".automatic.opinion-field-\" + name)\r\n\t\t\t\tif element.length > 0\r\n\t\t\t\t\tif element?.is(\"td\")\r\n\t\t\t\t\t\telement.addClass('field-editable')\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\t$(\".instance-sign\", element).addClass('field-editable')\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.log e\r\n\t\t, 1\r\n\t\treturn ''\r\n\r\nif Meteor.isServer\r\n\tInstanceSignText.helpers.defaultDescription = ->\r\n\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\treturn Template.instance().data.default_description || TAPi18n.__(\"instance_default_opinion\", {}, locale)","InstanceSignText.helpers = {\n  show: function(stepName) {\n    var instance, myApprove, myTrace, ref;\n    if (Meteor.isClient) {\n      if (Session.get('instancePrint')) {\n        return false;\n      }\n      if (InstanceManager.isInbox()) {\n        myApprove = InstanceManager.getCurrentApprove();\n        if (myApprove) {\n          instance = WorkflowManager.getInstance();\n          myTrace = instance != null ? (ref = instance.traces) != null ? ref.findPropertyByPK(\"_id\", myApprove.trace) : void 0 : void 0;\n          return (myTrace != null ? myTrace.name : void 0) === stepName;\n        }\n      }\n    }\n    return false;\n  },\n  defaultDescription: function() {\n    return Template.instance().data.default_description;\n  },\n  traces: function() {\n    return InstanceformTemplate.helpers.traces();\n  },\n  trace: function(stepName, only_cc_opinion, image_sign, top_keywords) {\n    var approve_sort, approves, approvesGroup, approves_sorted, completed_date, hasNext, haveDescriptionApprove, instance, is_completed, ref, ref1, ref2, traces;\n    instance = InstanceformTemplate.helpers.instance();\n    is_completed = (instance != null ? instance.state : void 0) === \"completed\";\n    completed_date = is_completed ? (ref = _.last(instance.traces)) != null ? (ref1 = ref.finish_date) != null ? ref1.getTime() : void 0 : void 0 : 0;\n    if (is_completed && instance.finish_date) {\n      completed_date = (ref2 = instance.finish_date) != null ? ref2.getTime() : void 0;\n    }\n    traces = InstanceformTemplate.helpers.traces();\n    approves = _.clone(traces[stepName]);\n    approve_sort = function(approves, top_keywords) {\n      var approves_sorted, top_approves;\n      approves_sorted = _.sortBy(approves, function(approve) {\n        return -(approve.finish_date || new Date()).getTime();\n      });\n      if (top_keywords) {\n        top_approves = new Array();\n        top_keywords.split(\",\").forEach(function(key) {\n          return top_approves = _.union(top_approves, _.filter(approves_sorted, function(approve) {\n            var ref3;\n            return (approve != null ? (ref3 = approve.handler_name) != null ? ref3.indexOf(key) : void 0 : void 0) > -1;\n          }));\n        });\n        top_approves = _.sortBy(top_approves, function(top_approve) {\n          return -(top_approve.finish_date || new Date()).getTime();\n        });\n        approves_sorted = _.union(top_approves, approves_sorted);\n      }\n      return approves_sorted || [];\n    };\n    approves = _.filter(approves, function(a) {\n      return a.type !== \"forward\" && a.type !== \"distribute\" && a.type !== \"terminated\";\n    });\n    if (only_cc_opinion) {\n      approves = approves != null ? approves.filterProperty(\"type\", \"cc\") : void 0;\n    }\n    approves_sorted = approve_sort(approves, top_keywords);\n    approvesGroup = _.groupBy(approves, \"handler\");\n    hasNext = function(approve, approvesGroup) {\n      var handlerApproves;\n      handlerApproves = approvesGroup[approve.handler];\n      return _.indexOf(handlerApproves, approve) + 1 < handlerApproves.length;\n    };\n    haveDescriptionApprove = function(approve, approvesGroup) {\n      var descriptionApproves, handlerApproves;\n      handlerApproves = approvesGroup[approve.handler];\n      descriptionApproves = _.filter(handlerApproves, function(a) {\n        if (a.description) {\n          return true;\n        }\n        return false;\n      });\n      if (descriptionApproves.length === 0) {\n        return false;\n      }\n      return true;\n    };\n    approves_sorted.forEach(function(approve) {\n      if (approve.sign_show !== false && (approve.description || (!approve.description && !hasNext(approve, approvesGroup) && !approve.is_finished))) {\n        if (approve.judge !== 'terminated') {\n          return approve._display = true;\n        }\n      }\n    });\n    approves_sorted = _.filter(approves_sorted, function(a) {\n      var ref3;\n      if (is_completed) {\n        return a._display === true && a.is_finished && ((ref3 = a.finish_date) != null ? ref3.getTime() : void 0) <= completed_date;\n      } else {\n        return a._display === true;\n      }\n    });\n    return approves_sorted;\n  },\n  include: function(a, b) {\n    return InstanceformTemplate.helpers.include(a, b);\n  },\n  unempty: function(val) {\n    return InstanceformTemplate.helpers.unempty(val);\n  },\n  formatDate: function(date, options) {\n    if (!options) {\n      options = {\n        \"format\": \"YYYY-MM-DD\"\n      };\n    }\n    return InstanceformTemplate.helpers.formatDate(date, options);\n  },\n  isMyApprove: function(approve, only_cc_opinion) {\n    var currentApprove, ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n      currentApprove = InstanceManager.getCurrentApprove();\n      if (!(approve != null ? approve._id : void 0)) {\n        approve = currentApprove;\n      }\n      if (approve._id === (currentApprove != null ? currentApprove._id : void 0) && (currentApprove != null ? currentApprove.type : void 0) === 'cc' && Template.instance().data.name) {\n        if (_.indexOf(currentApprove != null ? currentApprove.opinion_fields_code : void 0, Template.instance().data.name) > -1) {\n          return true;\n        } else {\n          return false;\n        }\n      }\n      if (!((currentApprove != null ? currentApprove.type : void 0) === 'cc') && only_cc_opinion) {\n        return false;\n      }\n      if (currentApprove && approve._id === currentApprove._id) {\n        return true;\n      }\n    }\n    return false;\n  },\n  myApproveDescription: function(approveId) {\n    var myApprove, ref, ref1, ref2, ref3;\n    if (Meteor.isClient) {\n      if (Session.get(\"box\") === 'inbox') {\n        myApprove = (ref = Template.instance()) != null ? (ref1 = ref.myApprove) != null ? ref1.get() : void 0 : void 0;\n        if (myApprove && myApprove.id === approveId) {\n          if (!myApprove.sign_field_code || myApprove.sign_field_code === ((ref2 = Template.instance()) != null ? (ref3 = ref2.data) != null ? ref3.name : void 0 : void 0)) {\n            if (!Session.get(\"instance_my_approve_description\")) {\n              return (myApprove != null ? myApprove.description : void 0) || \"\";\n            }\n            return Session.get(\"instance_my_approve_description\");\n          }\n        }\n      }\n    }\n  },\n  now: function() {\n    return new Date();\n  },\n  isReadOnly: function() {\n    if (Meteor.isClient) {\n      return ApproveManager.isReadOnly();\n    }\n    return false;\n  },\n  isOpinionOfField: function(approve) {\n    if (approve.type === \"cc\" && Template.instance().data.name) {\n      if (Template.instance().data.name === approve.sign_field_code) {\n        return true;\n      } else {\n        return false;\n      }\n    } else {\n      return true;\n    }\n  },\n  markDownToHtml: function(markDownString) {\n    var renderer;\n    if (markDownString) {\n      renderer = new Markdown.Renderer();\n      renderer.link = function(href, title, text) {\n        return \"<a target='_blank' href='\" + href + \"' title='\" + title + \"'>\" + text + \"</a>\";\n      };\n      return Spacebars.SafeString(Markdown(markDownString, {\n        renderer: renderer\n      }));\n    }\n  },\n  steps: function(field_formula, step, only_cc_opinion, image_sign) {\n    var ref, ref1, ref2, steps;\n    steps = [];\n    if (!step) {\n      if (!field_formula) {\n        field_formula = (ref = WorkflowManager.getInstanceFormVersion()) != null ? (ref1 = ref.fields) != null ? ref1.findPropertyByPK(\"code\", this.name).formula : void 0 : void 0;\n      }\n      steps = InstanceformTemplate.helpers.getOpinionFieldStepsName(field_formula, (ref2 = Template.instance()) != null ? ref2.data.top_keywords : void 0);\n    } else {\n      steps = [\n        {\n          stepName: step,\n          only_cc_opinion: only_cc_opinion,\n          image_sign: image_sign\n        }\n      ];\n    }\n    return steps;\n  },\n  imageSignData: function(handler) {\n    return {\n      user: handler\n    };\n  },\n  showSignImage: function(handler, image_sign) {\n    var spaceUserSign;\n    spaceUserSign = ImageSign.helpers.spaceUserSign(handler);\n    if ((spaceUserSign != null ? spaceUserSign.sign : void 0) && image_sign) {\n      return true;\n    } else {\n      return false;\n    }\n  },\n  getLastSignApprove: function() {\n    var ins;\n    ins = WorkflowManager.getInstance();\n    return _.last(TracesManager.getHandlerSignShowApproves(ins, Meteor.userId()));\n  },\n  lastMyApproveDescription: function() {\n    var approves, currentStep, ref, traces;\n    traces = InstanceformTemplate.helpers.traces();\n    currentStep = InstanceManager.getCurrentStep();\n    approves = _.clone(traces[currentStep.name]);\n    approves = approves.filterProperty(\"handler\", Meteor.userId());\n    if (approves.length > 1) {\n      return (ref = approves[approves.length - 2]) != null ? ref.description : void 0;\n    }\n    return \"\";\n  },\n  showApprove: function(approve) {\n    var ref, ref1;\n    if (!approve.sign_field_code || approve.sign_field_code === ((ref = Template.instance()) != null ? (ref1 = ref.data) != null ? ref1.name : void 0 : void 0)) {\n      if (approve != null ? approve.is_read : void 0) {\n        if (approve.is_finished) {\n          return [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(approve.judge);\n        } else {\n          return true;\n        }\n      }\n    }\n    return false;\n  },\n  judge_description: function(judge) {\n    return t(judge + \"_description\");\n  },\n  is_approved: function(judge) {\n    return \"approved\" === judge;\n  },\n  is_rejected: function(judge) {\n    return \"rejected\" === judge;\n  },\n  is_readed: function(judge) {\n    return [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(judge);\n  },\n  addClass: function() {\n    var name, ref, ref1;\n    name = (ref = Template.instance()) != null ? (ref1 = ref.data) != null ? ref1.name : void 0 : void 0;\n    setTimeout(function() {\n      var e, element;\n      try {\n        element = $(\".automatic.opinion-field-\" + name);\n        if (element.length > 0) {\n          if (element != null ? element.is(\"td\") : void 0) {\n            return element.addClass('field-editable');\n          } else {\n            return $(\".instance-sign\", element).addClass('field-editable');\n          }\n        }\n      } catch (error) {\n        e = error;\n        return console.log(e);\n      }\n    }, 1);\n    return '';\n  }\n};\n\nif (Meteor.isServer) {\n  InstanceSignText.helpers.defaultDescription = function() {\n    var locale;\n    locale = Template.instance().view.template.steedosData.locale;\n    return Template.instance().data.default_description || TAPi18n.__(\"instance_default_opinion\", {}, locale);\n  };\n}\n","TracesTemplate.helpers =\r\n\tequals: (a, b) ->\r\n\t\ta == b\r\n\tempty: (a) ->\r\n\t\tif a\r\n\t\t\ta.toString().trim().length < 1\r\n\t\telse\r\n\t\t\ttrue\r\n\tunempty: (a) ->\r\n\t\tif a\r\n\t\t\ta.toString().trim().length > 0\r\n\t\telse\r\n\t\t\tfalse\r\n\r\n\tappend: (a, b) ->\r\n\t\ta + b\r\n\r\n\tdateFormat: (date) ->\r\n\t\t\tif Steedos.isMobile() && date?.getFullYear() == (new Date).getFullYear()\r\n\t\t\t\treturn $.format.date new Date(date), \"MM-dd HH:mm\"\r\n\t\t\telse\r\n\t\t\t\treturn $.format.date new Date(date), \"yyyy-MM-dd HH:mm\"\r\n\r\n\tgetStepName: (stepId) ->\r\n\t\tstep = WorkflowManager.getInstanceStep(stepId)\r\n\t\tif step\r\n\t\t\treturn step.name\r\n\t\tnull\r\n\tshowDeleteButton: (approved) ->\r\n\t\tif approved and approved.type == 'cc' and approved.from_user == Meteor.userId() and approved.is_finished != true and !Session.get(\"instancePrint\")\r\n\t\t\treturn true\r\n\t\tfalse\r\n\tisShowModificationButton: (approved) ->\r\n\t\tapprove_admins = Meteor.settings?.public?.workflow?.approve_admins\r\n\t\tif approve_admins?.length\r\n\t\t\tisShow = approve_admins?.contains Meteor.userId()\r\n\t\tunless isShow\r\n\t\t\treturn false\r\n\t\treturn approved.handler == Meteor.userId()\r\n\tisEditing: () ->\r\n\t\t return Template.instance().is_editing?.get()\r\n\tisShowDescription: (approved)->\r\n\t\t# debugger\r\n\t\tif TracesTemplate.helpers.isShowModificationButton approved\r\n\t\t\treturn true\r\n\t\treturn approved.description?.toString().trim().length > 0\r\n\tisCC: (approved) ->\r\n\t\tif approved and approved.type == 'cc'\r\n\t\t\treturn true\r\n\t\tfalse\r\n\tgetApproveStatusIcon: (approveJudge, autoSubmitted) ->\r\n\t\tif autoSubmitted == true\r\n\t\t\treturn 'ion ion-android-alarm-clock'\r\n\t\t#å·²ç»“æŸçš„æ˜¾ç¤ºä¸ºæ ¸å‡†/é©³å›ž/å–æ¶ˆç”³è¯·ï¼Œå¹¶æ˜¾ç¤ºå¤„ç†çŠ¶æ€å›¾æ ‡\r\n\t\tapproveStatusIcon = undefined\r\n\t\tswitch approveJudge\r\n\t\t\twhen 'approved'\r\n\t\t\t\t# å·²æ ¸å‡†\r\n\t\t\t\tapproveStatusIcon = 'ion ion-checkmark-round'\r\n\t\t\twhen 'rejected'\r\n\t\t\t\t# å·²é©³å›ž\r\n\t\t\t\tapproveStatusIcon = 'ion ion-close-round'\r\n\t\t\twhen 'terminated'\r\n\t\t\t\t# å·²å–æ¶ˆ\r\n\t\t\t\tapproveStatusIcon = 'fa fa-ban'\r\n\t\t\twhen 'reassigned'\r\n\t\t\t\t# è½¬ç­¾æ ¸\r\n\t\t\t\tapproveStatusIcon = 'ion ion-android-contact'\r\n\t\t\twhen 'relocated'\r\n\t\t\t\t# é‡å®šä½\r\n\t\t\t\tapproveStatusIcon = 'ion ion-arrow-shrink'\r\n\t\t\twhen 'retrieved'\r\n\t\t\t\t# å·²å–å›ž\r\n\t\t\t\tapproveStatusIcon = 'fa fa-undo'\r\n\t\t\telse\r\n\t\t\t\tapproveStatusIcon = ''\r\n\t\t\t\tbreak\r\n\t\tapproveStatusIcon\r\n\tgetApproveStatusText: (approveJudge, autoSubmitted) ->\r\n\t\tif Meteor.isServer\r\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\r\n\t\t\t\tlocale = \"zh-CN\"\r\n\t\telse\r\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\r\n\t\t#å·²ç»“æŸçš„æ˜¾ç¤ºä¸ºæ ¸å‡†/é©³å›ž/å–æ¶ˆç”³è¯·ï¼Œå¹¶æ˜¾ç¤ºå¤„ç†çŠ¶æ€å›¾æ ‡\r\n\t\tif autoSubmitted == true\r\n\t\t\treturn TAPi18n.__('instance_approve_timeout_auto_submitted', {}, locale)\r\n\t\tapproveStatusText = undefined\r\n\t\tswitch approveJudge\r\n\t\t\twhen 'approved'\r\n\t\t\t\t# å·²æ ¸å‡†\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State approved', {}, locale)\r\n\t\t\twhen 'rejected'\r\n\t\t\t\t# å·²é©³å›ž\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State rejected', {}, locale)\r\n\t\t\twhen 'terminated'\r\n\t\t\t\t# å·²å–æ¶ˆ\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State terminated', {}, locale)\r\n\t\t\twhen 'reassigned'\r\n\t\t\t\t# è½¬ç­¾æ ¸\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State reassigned', {}, locale)\r\n\t\t\twhen 'relocated'\r\n\t\t\t\t# é‡å®šä½\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State relocated', {}, locale)\r\n\t\t\twhen 'retrieved'\r\n\t\t\t\t# å·²å–å›ž\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State retrieved', {}, locale)\r\n\t\t\twhen 'returned'\r\n\t\t\t\t# å·²é€€å›ž\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State returned', {}, locale)\r\n\t\t\twhen 'readed'\r\n\t\t\t\t# å·²é˜…\r\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State readed', {}, locale)\r\n\t\t\telse\r\n\t\t\t\tapproveStatusText = ''\r\n\t\t\t\tbreak\r\n\t\tapproveStatusText\r\n\t\r\n\tgetApproveJudgeClass: (approveJudge, autoSubmitted) ->\r\n\t\tif autoSubmitted == true\r\n\t\t\treturn 'autoSubmitted'\r\n\t\treturn approveJudge\r\n\r\n\t_t: (key)->\r\n\t\treturn TAPi18n.__(key)\r\n\r\n\tmyApproveDescription: (approveId)->\r\n\t\tif Meteor.isClient\r\n\t\t\tif Session.get(\"box\") == 'inbox'\r\n\t\t\t\tmyApprove = Template.instance()?.myApprove?.get()\r\n\t\t\t\tif myApprove && myApprove.id == approveId\r\n\t\t\t\t\tif !Session.get(\"instance_my_approve_description\")\r\n\t\t\t\t\t\treturn myApprove?.description || \"\"\r\n\t\t\t\t\treturn Session.get(\"instance_my_approve_description\")\r\n\tisForward: (approved) ->\r\n\t\tif approved and approved.type == 'forward'\r\n\t\t\treturn true\r\n\t\tfalse\r\n\tshowForwardDeleteButton: (approve) ->\r\n\t\tif db.instances.find(approve.forward_instance).count() is 0\r\n\t\t\treturn false\r\n\t\tif approve and approve.type == 'forward' and approve.from_user == Meteor.userId() and !Session.get(\"instancePrint\") and approve.judge isnt 'terminated'\r\n\t\t\treturn true\r\n\t\tfalse\r\n\tmarkDownToHtml: (markDownString)->\r\n\t\tif markDownString\r\n\t\t\trenderer = new Markdown.Renderer();\r\n\t\t\trenderer.link = ( href, title, text ) ->\r\n\t\t\t\treturn \"<a target='_blank' href='#{href}' title='#{title}'>#{text}</a>\"\r\n\t\t\treturn Spacebars.SafeString(Markdown(markDownString, {renderer:renderer}))\r\n\tisDistribute: (approve) ->\r\n\t\tif approve and approve.type == 'distribute'\r\n\t\t\treturn true\r\n\t\tfalse\r\n\tshowDistributeDeleteButton: (approve) ->\r\n\t\tif db.instances.find(approve.forward_instance).count() is 0\r\n\t\t\treturn false\r\n\r\n\t\tif approve and approve.type == 'distribute' and !Session.get(\"instancePrint\") and approve.judge isnt 'terminated' and Steedos.hasFeature('file_distribution', Steedos.getSpaceId())\r\n\t\t\t# æµç¨‹ç®¡ç†å‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜ï¼Œå¯ä»¥æ‰§è¡Œä»»ä½•æƒ…å†µä¸‹çš„æ–‡ä»¶å–æ¶ˆåˆ†å‘\r\n\t\t\tins = db.instances.findOne({_id: approve.instance}, {fields: {flow: 1, space: 1}})\r\n\t\t\tif ins and ins.flow and ins.space\r\n\t\t\t\tif WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, Meteor.userId())\r\n\t\t\t\t\treturn true\r\n\r\n\t\t\tif approve.from_user == Meteor.userId()\r\n\t\t\t\treturn true\r\n\r\n\t\tfalse\r\n\r\n\tfinishDateSchema: () ->\r\n\t\tif Steedos.isAndroidOrIOS()\r\n\t\t\treturn new SimpleSchema({\r\n\t\t\t\tfinish_date: {\r\n\t\t\t\t\tautoform: {\r\n\t\t\t\t\t\ttype: \"datetime-local\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\toptional: false,\r\n\t\t\t\t\ttype: Date\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\telse\r\n\t\t\treturn new SimpleSchema({\r\n\t\t\t\tfinish_date: {\r\n\t\t\t\t\tautoform: {\r\n\t\t\t\t\t\ttype: \"bootstrap-datetimepicker\"\r\n\t\t\t\t\t\treadonly: true\r\n\t\t\t\t\t\tdateTimePickerOptions:{\r\n\t\t\t\t\t\t\tformat: \"YYYY-MM-DD HH:mm\",\r\n\t\t\t\t\t\t\tignoreReadonly:true,\r\n\t\t\t\t\t\t\tlocale: Session.get(\"TAPi18n::loaded_lang\"),\r\n\t\t\t\t\t\t\twidgetPositioning:{\r\n\t\t\t\t\t\t\t\thorizontal: 'right'\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\toptional: false,\r\n\t\t\t\t\ttype: Date\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\tfinishDateValues: () ->\r\n\t\treturn {\r\n\t\t\tfinish_date:this.finish_date\r\n\t\t};\r\n\r\n\t###\r\n    \tæ­¤å‡½æ•°ç”¨äºŽæŽ§åˆ¶æ˜¯å¦æ˜¾ç¤ºtraces view\r\n    \ttrue: æ˜¾ç¤ºtraces view,ç­¾æ ¸åŽ†ç¨‹æŒ‰é’®ç‚¹å‡»åŽæ˜¯ç›´æŽ¥å®šä½åˆ°traces view\r\n    \tfalse: ä¸æ˜¾ç¤ºtraces viewï¼Œç­¾æ ¸åŽ†ç¨‹æŒ‰é’®ç‚¹å‡»åŽ,ä»¥Modal æ–¹å¼æ˜¾ç¤ºtraces view\r\n\t###\r\n\tshowTracesView: (form, form_version)->\r\n#\t\treturn !(InstanceManager.isTableStyle(form) && InstanceformTemplate.helpers.includesOpinionField(form, form_version))\r\n\r\n\t\tshow_modal_traces_list = db.space_settings.findOne({space: Session.get(\"spaceId\"), key: \"show_modal_traces_list\"})?.values || false\r\n\r\n\t\treturn !show_modal_traces_list\r\n\r\n\tgetInstanceStateText: (instance_id)->\r\n\t\tif Meteor.isServer\r\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\r\n\t\t\t\tlocale = \"zh-CN\"\r\n\t\telse\r\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\r\n\r\n\t\tins = db.instances.findOne({_id: instance_id}, {fields: {state: 1, is_read: 1}})\r\n\t\tif not ins\r\n\t\t\treturn TAPi18n.__('instance_deleted', {}, locale)\r\n\r\n\t\ttext = ''\r\n\t\tif ins.state is 'completed'\r\n\t\t\ttext = TAPi18n.__('completed', {}, locale)\r\n\t\telse if ins.state is 'pending'\r\n\t\t\ttext = TAPi18n.__('pending', {}, locale)\r\n\t\telse if ins.state is 'draft'\r\n\t\t\tif ins.is_read\r\n\t\t\t\ttext = TAPi18n.__('instance_approve_read', {}, locale)\r\n\t\t\telse\r\n\t\t\t\ttext = TAPi18n.__('instance_approve_not_yet_handled', {}, locale)\r\n\r\n\t\treturn text\r\n\r\n\tgetInstanceStateColor: (instance_id)->\r\n\t\tins = db.instances.findOne({_id: instance_id}, {fields: {state: 1, is_read: 1}})\r\n\t\tif not ins\r\n\t\t\treturn \"\"\r\n\r\n\t\tcla = ''\r\n\t\tif ins.state is 'draft'\r\n\t\t\tif ins.is_read\r\n\t\t\t\tcla = 'blue'\r\n\t\t\telse\r\n\t\t\t\tcla = 'red'\r\n\t\treturn cla\r\n\r\n\tfirstTrace: (index)->\r\n\t\treturn index is 0\r\n\r\n\tlast_distribute_from: (instance_id)->\r\n\t\tins = db.instances.findOne({_id: instance_id, distribute_from_instance: {$exists: true}},{fields:{created: 1, created_by: 1}})\r\n\t\tif ins\r\n\t\t\tdis_info = {}\r\n\t\t\tuser = {}\r\n\t\t\tif Meteor.isClient\r\n\t\t\t\tuser = UUflow_api.getNameForUser(ins.created_by)\r\n\t\t\telse if Meteor.isServer\r\n\t\t\t\tuser = db.users.findOne({_id: ins.created_by}, {fields: {name: 1}})\r\n\r\n\t\t\tif user.name\r\n\t\t\t\tdis_info.from_user = user._id\r\n\t\t\t\tdis_info.from_user_name = user.name\r\n\t\t\t\tdis_info.created = ins.created\r\n\r\n\t\t\tif not _.isEmpty(dis_info)\r\n\t\t\t\treturn dis_info\r\n\t\treturn\r\n\r\n\tisCCOrDistributeOrForwardTerminated: (approve)->\r\n\t\tif (approve.type is 'cc' or approve.type is 'distribute' or approve.type is 'forward') and approve.judge is 'terminated'\r\n\t\t\treturn true\r\n\t\treturn false\r\n\r\n\tjudgeTerminated: (judge)->\r\n\t\treturn judge is 'terminated'\r\n\r\n\tinstanceExists: (instance_id)->\r\n\t\treturn !!db.instances.find(instance_id).count()\r\n\r\n\tagentDescription: (userName)->\r\n\t\tif Meteor.isServer\r\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\r\n\t\t\t\tlocale = \"zh-CN\"\r\n\t\telse\r\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\r\n\r\n\t\treturn TAPi18n.__('process_delegation_rules_description', {userName: userName}, locale)\r\n\t\r\n\ttraceName: (instance_id, traceId)->\r\n\t\treturn _.find(db.instances.findOne(instance_id, {fields: {traces: 1}})?.traces, (trace)->\r\n\t\t\t\t\treturn trace._id ==  traceId\r\n\t\t)?.name\r\n\r\n\tobjectUrl: (object_name, record_id, app_id)->\r\n\t\treturn Creator.getObjectUrl(object_name, record_id, app_id)\r\n\r\nif Meteor.isServer\r\n\tTracesTemplate.helpers.dateFormat = (date)->\r\n\t\tif date\r\n\t\t\tutcOffset = Template.instance().view.template.steedosData.utcOffset\r\n\t\t\treturn InstanceReadOnlyTemplate.formatDate(date, utcOffset);\r\n\r\n\tTracesTemplate.helpers._t = (key)->\r\n\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\treturn TAPi18n.__(key, {}, locale)\r\n\r\n\tTracesTemplate.helpers.showDeleteButton = (approved) ->\r\n\t\treturn false;\r\n\r\nTracesTemplate.events =\r\n\t'click .cc-approve-remove': (event, template) ->\r\n\t\tevent.stopPropagation()\r\n\t\tif event.currentTarget.dataset.calling * 1 != 1\r\n\t\t\tevent.currentTarget.dataset.calling = 1\r\n\t\t\t$(\"i\",event.currentTarget).addClass(\"fa-spin\")\r\n\t\t\tinstanceId = Session.get('instanceId')\r\n\t\t\tapproveId = event.target.dataset.approve\r\n\t\t\t# CALL åˆ é™¤approveå‡½æ•°ã€‚\r\n\t\t\t$(\"body\").addClass(\"loading\")\r\n\t\t\tMeteor.call 'cc_remove', instanceId, approveId, (err, result) ->\r\n\t\t\t\t$(\"body\").removeClass(\"loading\")\r\n\t\t\t\tif err\r\n\t\t\t\t\ttoastr.error err\r\n\t\t\t\t\tevent.currentTarget.dataset.calling = 0\r\n\t\t\t\t\t$(\"i\",event.currentTarget).removeClass(\"fa-spin\")\r\n\t\t\t\tif result == true\r\n\t\t\t\t\ttoastr.success(TAPi18n.__(\"remove_cc_approve\"));\r\n\t\t\t\t\tif $(\".instance-trace-detail-modal\").length\r\n\t\t\t\t\t\tModal.hide \"instance_trace_detail_modal\"\r\n\t\t\t\treturn\r\n\t\t\treturn\r\n\r\n\t'click .instance-trace-detail-modal .btn-cc-approve-remove': (event, template) ->\r\n\t\tinstanceId = Session.get('instanceId')\r\n\t\tapproveId = event.target.dataset.approve\r\n\t\t# CALL åˆ é™¤approveå‡½æ•°ã€‚\r\n\t\t$(\"body\").addClass(\"loading\")\r\n\t\tMeteor.call 'cc_remove', instanceId, approveId, (err, result) ->\r\n\t\t\t$(\"body\").removeClass(\"loading\")\r\n\t\t\tif err\r\n\t\t\t\ttoastr.error err\r\n\t\t\tif result == true\r\n\t\t\t\ttoastr.success(TAPi18n.__(\"remove_cc_approve\"));\r\n\t\t\t\tModal.hide \"instance_trace_detail_modal\"\r\n\t\t\treturn\r\n\t\treturn\r\n\r\n\t'click .approve-item,.approve-description': (event, template) ->\r\n\t\t# PCä¸Šé“¾æŽ¥å…è®¸ç›´æŽ¥ç‚¹å¼€ï¼Œä¸å†æ‰“å¼€ç­¾æ‰¹åŽ†ç¨‹è¯¦ç»†\r\n\t\tunless $(event.target).closest(\"a.btn-link\").length\r\n\t\t\tModal.show \"instance_trace_detail_modal\", this\r\n\r\n\t'taphold .approve-item,.approve-description': (event, template) ->\r\n\t\t# æ‰‹æœºä¸Šé•¿æŒ‰æ‰“å¼€ç­¾æ‰¹åŽ†ç¨‹è¯¦ç»†ï¼Œå¦‚æžœæ˜¯é“¾æŽ¥é•¿æŒ‰æ‰“å¼€åŽä¸€æ”¾æ‰‹çª—å£å°±åˆå…³æŽ‰äº†ï¼Œæ‰€ä»¥ä¸è®©é“¾æŽ¥æ‰“å¼€ç­¾æ‰¹åŽ†ç¨‹è¯¦ç»†\r\n\t\tunless $(event.target).closest(\"a.btn-link\").length\r\n\t\t\tModal.show \"instance_trace_detail_modal\", this\r\n\r\n\t'click .approve-item a.btn-link,.approve-description a.btn-link,.approve-item-distribute a.btn-link': (event, template) ->\r\n\t\t# æ‰‹æœºä¸Šç‚¹å‡»é“¾æŽ¥ï¼Œå¼¹å‡ºæ–°çª—å£ï¼Œä¸æ”¯æŒï¼Œå› ä¸ºandroidä¸Šä¼šå¼¹å‡ºç™»å½•ç•Œé¢\r\n\t\tif Steedos.isMobile()\r\n\t\t\tuserId = event.target.dataset?.target_user_id\r\n\t\t\tCreator.openSafeObjectUrl('users', userId)\r\n\r\n\t'tapend .approve-item,.approve-description': (event, template) ->\r\n\t\t# ä¸Šè¿°é•¿æŒ‰æ‰“å¼€approveè¯¦ç»†çª—å£çš„äº‹ä»¶tapholdä¼šè§¦å‘æ‰“å¼€çª—å£åŽçš„touchendäº‹ä»¶ï¼Œé€ æˆé•¿æŒ‰æ‰“å¼€çª—å£åŽä¸€æ”¾æ‰‹çª—å£å°±åˆå…³æŽ‰äº†\r\n\t\t# è¿™é‡Œåªèƒ½é€šè¿‡é˜»æ­¢tapendäº‹ä»¶(ä¸å¯ä»¥ç”¨touchendäº‹ä»¶ï¼Œå› ä¸ºä¼šå½±å“tapholdåŠŸèƒ½ï¼Œé€ æˆæ²¡æœ‰é•¿æŒ‰æ•ˆæžœæ—¶ä¹Ÿä¼šè§¦å‘tapholdäº‹ä»¶)å†’æ³¡æ¥é¿å…é—®é¢˜ã€‚\r\n\t\t# é“¾æŽ¥å…è®¸ç›´æŽ¥ç‚¹å¼€\r\n\t\tunless $(event.target).closest(\"a.btn-link\").length\r\n\t\t\tevent.stopPropagation()\r\n\t\t\tevent.preventDefault()\r\n\t\t\treturn false\r\n\r\n\t'click .instance-trace-detail-modal .btn-forward-approve-remove': (event, template) ->\r\n\t\tinstanceId = Session.get('instanceId')\r\n\t\tapproveId = event.target.dataset.approve\r\n\t\ttraceId = event.target.dataset.trace\r\n\t\t# CALL åˆ é™¤approveå‡½æ•°ã€‚\r\n\t\t$(\"body\").addClass(\"loading\")\r\n\t\tMeteor.call 'forward_remove', instanceId, traceId, approveId, (err, result) ->\r\n\t\t\t$(\"body\").removeClass(\"loading\")\r\n\t\t\tif err\r\n\t\t\t\ttoastr.error TAPi18n.__(err.reason)\r\n\t\t\tif result == true\r\n\t\t\t\ttoastr.success(TAPi18n.__(\"instance_approve_forward_remove_success\"));\r\n\t\t\t\tModal.hide \"instance_trace_detail_modal\"\r\n\t\t\treturn\r\n\t\treturn\r\n\r\n\t'click .instance-trace-detail-modal .btn-forward-instance-look': (event, template) ->\r\n\t\tforward_space = event.target.dataset.forwardspace\r\n\t\tforward_instance = event.target.dataset.forwardinstance\r\n\t\tSteedos.openWindow(Steedos.absoluteUrl(\"workflow/space/\" + forward_space + \"/view/readonly/\" + forward_instance))\r\n\r\n\t'click .btn-modification'\t: (event, template) ->\r\n\t\ttemplate.is_editing.set(!template.is_editing.get());\r\n\t\tunless Steedos.isAndroidOrIOS()\r\n\t\t\tTracker.afterFlush ->\r\n\t\t\t\t# æ˜¾ç¤ºæ—¥å¿—çš„æ—¶å€™æŠŠæ»šåŠ¨æ¡å¾€ä¸‹ç§»ç‚¹ï¼Œè®©æ—¥æœŸæŽ§ä»¶æ˜¾ç¤ºå‡ºä¸€éƒ¨åˆ†ï¼Œä»¥é¿å…ç”¨æˆ·çœ‹ä¸åˆ°æ—¥æœŸæŽ§ä»¶\r\n\t\t\t\t$(\"#instance_trace_detail_modal #finish_input\").on \"dp.show\", () ->\r\n\t\t\t\t\t$(\".modal-body\").scrollTop(100)\r\n\r\n\t'click .btn-cancelBut' : (event, template) ->\r\n\r\n\t\ttemplate.is_editing.set(!template.is_editing.get());\r\n\r\n\t'click .btn-saveBut' : (event, template) ->\r\n\t\t# template.is_editing.set(!template.is_editing.get())\r\n\r\n\t\tinstanceId = Session.get('instanceId')\r\n\t\tapproveId = event.target.dataset.approve\r\n\t\ttraceId = event.target.dataset.trace\r\n\t\topinion_input = $('#opinion_input').val()\r\n\t\tfinish_input = AutoForm.getFieldValue(\"finish_date\", \"finishDateAutoForm\")\r\n\r\n\t\t$(\"body\").addClass(\"loading\")\r\n\t\tMeteor.call 'change_approve_info', instanceId, traceId, approveId, opinion_input, finish_input, (err, result)->\r\n\t\t\t$(\"body\").removeClass(\"loading\")\r\n\t\t\tif err\r\n\t\t\t\ttoastr.error TAPi18n.__(err.reason)\r\n\t\t\tif result == true\r\n\t\t\t\ttoastr.success(t(\"instance_approve_modal_modificationsave\"))\r\n\t\t\t\tModal.hide \"instance_trace_detail_modal\"\r\n\t\t\treturn\r\n\r\n\t'click .instance-trace-detail-modal .btn-distribute-approve-remove': (event, template) ->\r\n\t\tModal.allowMultiple = true\r\n\t\tModal.show 'cancel_distribute_modal'\r\n","TracesTemplate.helpers = {\n  equals: function(a, b) {\n    return a === b;\n  },\n  empty: function(a) {\n    if (a) {\n      return a.toString().trim().length < 1;\n    } else {\n      return true;\n    }\n  },\n  unempty: function(a) {\n    if (a) {\n      return a.toString().trim().length > 0;\n    } else {\n      return false;\n    }\n  },\n  append: function(a, b) {\n    return a + b;\n  },\n  dateFormat: function(date) {\n    if (Steedos.isMobile() && (date != null ? date.getFullYear() : void 0) === (new Date).getFullYear()) {\n      return $.format.date(new Date(date), \"MM-dd HH:mm\");\n    } else {\n      return $.format.date(new Date(date), \"yyyy-MM-dd HH:mm\");\n    }\n  },\n  getStepName: function(stepId) {\n    var step;\n    step = WorkflowManager.getInstanceStep(stepId);\n    if (step) {\n      return step.name;\n    }\n    return null;\n  },\n  showDeleteButton: function(approved) {\n    if (approved && approved.type === 'cc' && approved.from_user === Meteor.userId() && approved.is_finished !== true && !Session.get(\"instancePrint\")) {\n      return true;\n    }\n    return false;\n  },\n  isShowModificationButton: function(approved) {\n    var approve_admins, isShow, ref, ref1, ref2;\n    approve_admins = (ref = Meteor.settings) != null ? (ref1 = ref[\"public\"]) != null ? (ref2 = ref1.workflow) != null ? ref2.approve_admins : void 0 : void 0 : void 0;\n    if (approve_admins != null ? approve_admins.length : void 0) {\n      isShow = approve_admins != null ? approve_admins.contains(Meteor.userId()) : void 0;\n    }\n    if (!isShow) {\n      return false;\n    }\n    return approved.handler === Meteor.userId();\n  },\n  isEditing: function() {\n    var ref;\n    return (ref = Template.instance().is_editing) != null ? ref.get() : void 0;\n  },\n  isShowDescription: function(approved) {\n    var ref;\n    if (TracesTemplate.helpers.isShowModificationButton(approved)) {\n      return true;\n    }\n    return ((ref = approved.description) != null ? ref.toString().trim().length : void 0) > 0;\n  },\n  isCC: function(approved) {\n    if (approved && approved.type === 'cc') {\n      return true;\n    }\n    return false;\n  },\n  getApproveStatusIcon: function(approveJudge, autoSubmitted) {\n    var approveStatusIcon;\n    if (autoSubmitted === true) {\n      return 'ion ion-android-alarm-clock';\n    }\n    approveStatusIcon = void 0;\n    switch (approveJudge) {\n      case 'approved':\n        approveStatusIcon = 'ion ion-checkmark-round';\n        break;\n      case 'rejected':\n        approveStatusIcon = 'ion ion-close-round';\n        break;\n      case 'terminated':\n        approveStatusIcon = 'fa fa-ban';\n        break;\n      case 'reassigned':\n        approveStatusIcon = 'ion ion-android-contact';\n        break;\n      case 'relocated':\n        approveStatusIcon = 'ion ion-arrow-shrink';\n        break;\n      case 'retrieved':\n        approveStatusIcon = 'fa fa-undo';\n        break;\n      default:\n        approveStatusIcon = '';\n        break;\n    }\n    return approveStatusIcon;\n  },\n  getApproveStatusText: function(approveJudge, autoSubmitted) {\n    var approveStatusText, locale;\n    if (Meteor.isServer) {\n      locale = Template.instance().view.template.steedosData.locale;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    if (autoSubmitted === true) {\n      return TAPi18n.__('instance_approve_timeout_auto_submitted', {}, locale);\n    }\n    approveStatusText = void 0;\n    switch (approveJudge) {\n      case 'approved':\n        approveStatusText = TAPi18n.__('Instance State approved', {}, locale);\n        break;\n      case 'rejected':\n        approveStatusText = TAPi18n.__('Instance State rejected', {}, locale);\n        break;\n      case 'terminated':\n        approveStatusText = TAPi18n.__('Instance State terminated', {}, locale);\n        break;\n      case 'reassigned':\n        approveStatusText = TAPi18n.__('Instance State reassigned', {}, locale);\n        break;\n      case 'relocated':\n        approveStatusText = TAPi18n.__('Instance State relocated', {}, locale);\n        break;\n      case 'retrieved':\n        approveStatusText = TAPi18n.__('Instance State retrieved', {}, locale);\n        break;\n      case 'returned':\n        approveStatusText = TAPi18n.__('Instance State returned', {}, locale);\n        break;\n      case 'readed':\n        approveStatusText = TAPi18n.__('Instance State readed', {}, locale);\n        break;\n      default:\n        approveStatusText = '';\n        break;\n    }\n    return approveStatusText;\n  },\n  getApproveJudgeClass: function(approveJudge, autoSubmitted) {\n    if (autoSubmitted === true) {\n      return 'autoSubmitted';\n    }\n    return approveJudge;\n  },\n  _t: function(key) {\n    return TAPi18n.__(key);\n  },\n  myApproveDescription: function(approveId) {\n    var myApprove, ref, ref1;\n    if (Meteor.isClient) {\n      if (Session.get(\"box\") === 'inbox') {\n        myApprove = (ref = Template.instance()) != null ? (ref1 = ref.myApprove) != null ? ref1.get() : void 0 : void 0;\n        if (myApprove && myApprove.id === approveId) {\n          if (!Session.get(\"instance_my_approve_description\")) {\n            return (myApprove != null ? myApprove.description : void 0) || \"\";\n          }\n          return Session.get(\"instance_my_approve_description\");\n        }\n      }\n    }\n  },\n  isForward: function(approved) {\n    if (approved && approved.type === 'forward') {\n      return true;\n    }\n    return false;\n  },\n  showForwardDeleteButton: function(approve) {\n    if (db.instances.find(approve.forward_instance).count() === 0) {\n      return false;\n    }\n    if (approve && approve.type === 'forward' && approve.from_user === Meteor.userId() && !Session.get(\"instancePrint\") && approve.judge !== 'terminated') {\n      return true;\n    }\n    return false;\n  },\n  markDownToHtml: function(markDownString) {\n    var renderer;\n    if (markDownString) {\n      renderer = new Markdown.Renderer();\n      renderer.link = function(href, title, text) {\n        return \"<a target='_blank' href='\" + href + \"' title='\" + title + \"'>\" + text + \"</a>\";\n      };\n      return Spacebars.SafeString(Markdown(markDownString, {\n        renderer: renderer\n      }));\n    }\n  },\n  isDistribute: function(approve) {\n    if (approve && approve.type === 'distribute') {\n      return true;\n    }\n    return false;\n  },\n  showDistributeDeleteButton: function(approve) {\n    var ins;\n    if (db.instances.find(approve.forward_instance).count() === 0) {\n      return false;\n    }\n    if (approve && approve.type === 'distribute' && !Session.get(\"instancePrint\") && approve.judge !== 'terminated' && Steedos.hasFeature('file_distribution', Steedos.getSpaceId())) {\n      ins = db.instances.findOne({\n        _id: approve.instance\n      }, {\n        fields: {\n          flow: 1,\n          space: 1\n        }\n      });\n      if (ins && ins.flow && ins.space) {\n        if (WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, Meteor.userId())) {\n          return true;\n        }\n      }\n      if (approve.from_user === Meteor.userId()) {\n        return true;\n      }\n    }\n    return false;\n  },\n  finishDateSchema: function() {\n    if (Steedos.isAndroidOrIOS()) {\n      return new SimpleSchema({\n        finish_date: {\n          autoform: {\n            type: \"datetime-local\"\n          },\n          optional: false,\n          type: Date\n        }\n      });\n    } else {\n      return new SimpleSchema({\n        finish_date: {\n          autoform: {\n            type: \"bootstrap-datetimepicker\",\n            readonly: true,\n            dateTimePickerOptions: {\n              format: \"YYYY-MM-DD HH:mm\",\n              ignoreReadonly: true,\n              locale: Session.get(\"TAPi18n::loaded_lang\"),\n              widgetPositioning: {\n                horizontal: 'right'\n              }\n            }\n          },\n          optional: false,\n          type: Date\n        }\n      });\n    }\n  },\n  finishDateValues: function() {\n    return {\n      finish_date: this.finish_date\n    };\n  },\n\n  /*\n     \tæ­¤å‡½æ•°ç”¨äºŽæŽ§åˆ¶æ˜¯å¦æ˜¾ç¤ºtraces view\n     \ttrue: æ˜¾ç¤ºtraces view,ç­¾æ ¸åŽ†ç¨‹æŒ‰é’®ç‚¹å‡»åŽæ˜¯ç›´æŽ¥å®šä½åˆ°traces view\n     \tfalse: ä¸æ˜¾ç¤ºtraces viewï¼Œç­¾æ ¸åŽ†ç¨‹æŒ‰é’®ç‚¹å‡»åŽ,ä»¥Modal æ–¹å¼æ˜¾ç¤ºtraces view\n   */\n  showTracesView: function(form, form_version) {\n    var ref, show_modal_traces_list;\n    show_modal_traces_list = ((ref = db.space_settings.findOne({\n      space: Session.get(\"spaceId\"),\n      key: \"show_modal_traces_list\"\n    })) != null ? ref.values : void 0) || false;\n    return !show_modal_traces_list;\n  },\n  getInstanceStateText: function(instance_id) {\n    var ins, locale, text;\n    if (Meteor.isServer) {\n      locale = Template.instance().view.template.steedosData.locale;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        state: 1,\n        is_read: 1\n      }\n    });\n    if (!ins) {\n      return TAPi18n.__('instance_deleted', {}, locale);\n    }\n    text = '';\n    if (ins.state === 'completed') {\n      text = TAPi18n.__('completed', {}, locale);\n    } else if (ins.state === 'pending') {\n      text = TAPi18n.__('pending', {}, locale);\n    } else if (ins.state === 'draft') {\n      if (ins.is_read) {\n        text = TAPi18n.__('instance_approve_read', {}, locale);\n      } else {\n        text = TAPi18n.__('instance_approve_not_yet_handled', {}, locale);\n      }\n    }\n    return text;\n  },\n  getInstanceStateColor: function(instance_id) {\n    var cla, ins;\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        state: 1,\n        is_read: 1\n      }\n    });\n    if (!ins) {\n      return \"\";\n    }\n    cla = '';\n    if (ins.state === 'draft') {\n      if (ins.is_read) {\n        cla = 'blue';\n      } else {\n        cla = 'red';\n      }\n    }\n    return cla;\n  },\n  firstTrace: function(index) {\n    return index === 0;\n  },\n  last_distribute_from: function(instance_id) {\n    var dis_info, ins, user;\n    ins = db.instances.findOne({\n      _id: instance_id,\n      distribute_from_instance: {\n        $exists: true\n      }\n    }, {\n      fields: {\n        created: 1,\n        created_by: 1\n      }\n    });\n    if (ins) {\n      dis_info = {};\n      user = {};\n      if (Meteor.isClient) {\n        user = UUflow_api.getNameForUser(ins.created_by);\n      } else if (Meteor.isServer) {\n        user = db.users.findOne({\n          _id: ins.created_by\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n      }\n      if (user.name) {\n        dis_info.from_user = user._id;\n        dis_info.from_user_name = user.name;\n        dis_info.created = ins.created;\n      }\n      if (!_.isEmpty(dis_info)) {\n        return dis_info;\n      }\n    }\n  },\n  isCCOrDistributeOrForwardTerminated: function(approve) {\n    if ((approve.type === 'cc' || approve.type === 'distribute' || approve.type === 'forward') && approve.judge === 'terminated') {\n      return true;\n    }\n    return false;\n  },\n  judgeTerminated: function(judge) {\n    return judge === 'terminated';\n  },\n  instanceExists: function(instance_id) {\n    return !!db.instances.find(instance_id).count();\n  },\n  agentDescription: function(userName) {\n    var locale;\n    if (Meteor.isServer) {\n      locale = Template.instance().view.template.steedosData.locale;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    return TAPi18n.__('process_delegation_rules_description', {\n      userName: userName\n    }, locale);\n  },\n  traceName: function(instance_id, traceId) {\n    var ref, ref1;\n    return (ref = _.find((ref1 = db.instances.findOne(instance_id, {\n      fields: {\n        traces: 1\n      }\n    })) != null ? ref1.traces : void 0, function(trace) {\n      return trace._id === traceId;\n    })) != null ? ref.name : void 0;\n  },\n  objectUrl: function(object_name, record_id, app_id) {\n    return Creator.getObjectUrl(object_name, record_id, app_id);\n  }\n};\n\nif (Meteor.isServer) {\n  TracesTemplate.helpers.dateFormat = function(date) {\n    var utcOffset;\n    if (date) {\n      utcOffset = Template.instance().view.template.steedosData.utcOffset;\n      return InstanceReadOnlyTemplate.formatDate(date, utcOffset);\n    }\n  };\n  TracesTemplate.helpers._t = function(key) {\n    var locale;\n    locale = Template.instance().view.template.steedosData.locale;\n    return TAPi18n.__(key, {}, locale);\n  };\n  TracesTemplate.helpers.showDeleteButton = function(approved) {\n    return false;\n  };\n}\n\nTracesTemplate.events = {\n  'click .cc-approve-remove': function(event, template) {\n    var approveId, instanceId;\n    event.stopPropagation();\n    if (event.currentTarget.dataset.calling * 1 !== 1) {\n      event.currentTarget.dataset.calling = 1;\n      $(\"i\", event.currentTarget).addClass(\"fa-spin\");\n      instanceId = Session.get('instanceId');\n      approveId = event.target.dataset.approve;\n      $(\"body\").addClass(\"loading\");\n      Meteor.call('cc_remove', instanceId, approveId, function(err, result) {\n        $(\"body\").removeClass(\"loading\");\n        if (err) {\n          toastr.error(err);\n          event.currentTarget.dataset.calling = 0;\n          $(\"i\", event.currentTarget).removeClass(\"fa-spin\");\n        }\n        if (result === true) {\n          toastr.success(TAPi18n.__(\"remove_cc_approve\"));\n          if ($(\".instance-trace-detail-modal\").length) {\n            Modal.hide(\"instance_trace_detail_modal\");\n          }\n        }\n      });\n    }\n  },\n  'click .instance-trace-detail-modal .btn-cc-approve-remove': function(event, template) {\n    var approveId, instanceId;\n    instanceId = Session.get('instanceId');\n    approveId = event.target.dataset.approve;\n    $(\"body\").addClass(\"loading\");\n    Meteor.call('cc_remove', instanceId, approveId, function(err, result) {\n      $(\"body\").removeClass(\"loading\");\n      if (err) {\n        toastr.error(err);\n      }\n      if (result === true) {\n        toastr.success(TAPi18n.__(\"remove_cc_approve\"));\n        Modal.hide(\"instance_trace_detail_modal\");\n      }\n    });\n  },\n  'click .approve-item,.approve-description': function(event, template) {\n    if (!$(event.target).closest(\"a.btn-link\").length) {\n      return Modal.show(\"instance_trace_detail_modal\", this);\n    }\n  },\n  'taphold .approve-item,.approve-description': function(event, template) {\n    if (!$(event.target).closest(\"a.btn-link\").length) {\n      return Modal.show(\"instance_trace_detail_modal\", this);\n    }\n  },\n  'click .approve-item a.btn-link,.approve-description a.btn-link,.approve-item-distribute a.btn-link': function(event, template) {\n    var ref, userId;\n    if (Steedos.isMobile()) {\n      userId = (ref = event.target.dataset) != null ? ref.target_user_id : void 0;\n      return Creator.openSafeObjectUrl('users', userId);\n    }\n  },\n  'tapend .approve-item,.approve-description': function(event, template) {\n    if (!$(event.target).closest(\"a.btn-link\").length) {\n      event.stopPropagation();\n      event.preventDefault();\n      return false;\n    }\n  },\n  'click .instance-trace-detail-modal .btn-forward-approve-remove': function(event, template) {\n    var approveId, instanceId, traceId;\n    instanceId = Session.get('instanceId');\n    approveId = event.target.dataset.approve;\n    traceId = event.target.dataset.trace;\n    $(\"body\").addClass(\"loading\");\n    Meteor.call('forward_remove', instanceId, traceId, approveId, function(err, result) {\n      $(\"body\").removeClass(\"loading\");\n      if (err) {\n        toastr.error(TAPi18n.__(err.reason));\n      }\n      if (result === true) {\n        toastr.success(TAPi18n.__(\"instance_approve_forward_remove_success\"));\n        Modal.hide(\"instance_trace_detail_modal\");\n      }\n    });\n  },\n  'click .instance-trace-detail-modal .btn-forward-instance-look': function(event, template) {\n    var forward_instance, forward_space;\n    forward_space = event.target.dataset.forwardspace;\n    forward_instance = event.target.dataset.forwardinstance;\n    return Steedos.openWindow(Steedos.absoluteUrl(\"workflow/space/\" + forward_space + \"/view/readonly/\" + forward_instance));\n  },\n  'click .btn-modification': function(event, template) {\n    template.is_editing.set(!template.is_editing.get());\n    if (!Steedos.isAndroidOrIOS()) {\n      return Tracker.afterFlush(function() {\n        return $(\"#instance_trace_detail_modal #finish_input\").on(\"dp.show\", function() {\n          return $(\".modal-body\").scrollTop(100);\n        });\n      });\n    }\n  },\n  'click .btn-cancelBut': function(event, template) {\n    return template.is_editing.set(!template.is_editing.get());\n  },\n  'click .btn-saveBut': function(event, template) {\n    var approveId, finish_input, instanceId, opinion_input, traceId;\n    instanceId = Session.get('instanceId');\n    approveId = event.target.dataset.approve;\n    traceId = event.target.dataset.trace;\n    opinion_input = $('#opinion_input').val();\n    finish_input = AutoForm.getFieldValue(\"finish_date\", \"finishDateAutoForm\");\n    $(\"body\").addClass(\"loading\");\n    return Meteor.call('change_approve_info', instanceId, traceId, approveId, opinion_input, finish_input, function(err, result) {\n      $(\"body\").removeClass(\"loading\");\n      if (err) {\n        toastr.error(TAPi18n.__(err.reason));\n      }\n      if (result === true) {\n        toastr.success(t(\"instance_approve_modal_modificationsave\"));\n        Modal.hide(\"instance_trace_detail_modal\");\n      }\n    });\n  },\n  'click .instance-trace-detail-modal .btn-distribute-approve-remove': function(event, template) {\n    Modal.allowMultiple = true;\n    return Modal.show('cancel_distribute_modal');\n  }\n};\n","RelatedInstances.helpers =\r\n\tshowRelatedInstaces: ->\r\n\t\tif Meteor.isClient\r\n\t\t\tins = WorkflowManager.getInstance();\r\n\t\telse\r\n\t\t\tins = this.instance\r\n\t\tif ins?.related_instances && _.isArray(ins?.related_instances)\r\n\t\t\tif db.instances.find({_id: {$in: ins.related_instances}}, {fields: {space: 1, name: 1}}).count() > 0\r\n\t\t\t\treturn true\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn false\r\n\r\n\trelated_instaces: ->\r\n\t\tif Meteor.isClient\r\n\t\t\tins = WorkflowManager.getInstance();\r\n\t\telse\r\n\t\t\tins = this.instance\r\n\t\tif ins?.related_instances && _.isArray(ins?.related_instances)\r\n\t\t\treturn db.instances.find({_id: {$in: ins.related_instances}}, {fields: {space: 1, name: 1}}).fetch()\r\n\r\n\trelated_instace_url: (ins) ->\r\n\r\n\t\tif Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())\r\n\t\t\treturn ''\r\n\r\n\t\tabsolute = false\r\n\r\n\t\tif Meteor.isServer\r\n\t\t\tabsolute = this.absolute\r\n\t\tif absolute\r\n\t\t\treturn Meteor.absoluteUrl(\"workflow/space/\"+ins.space+\"/view/readonly/\" + ins._id + '?hide_traces=0')\r\n\t\telse\r\n\t\t\treturn Steedos.absoluteUrl(\"workflow/space/\"+ins.space+\"/view/readonly/\" + ins._id + '?hide_traces=0')\r\n\r\n\t_t: (key)->\r\n\t\tif Meteor.isClient\r\n\t\t\treturn TAPi18n.__(key)\r\n\t\telse\r\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\r\n\t\t\treturn TAPi18n.__(key, {}, locale)\r\n\r\n\tshow_delete: ()->\r\n\t\tif !Meteor.isClient\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\tif Session.get(\"box\") == \"draft\" || Session.get(\"box\") == 'inbox'\r\n\t\t\t\tcurrent_step = InstanceManager.getCurrentStep()\r\n\t\t\t\tif current_step\r\n\t\t\t\t\tif (current_step.can_edit_main_attach || current_step.can_edit_normal_attach == true || current_step.can_edit_normal_attach == undefined)\r\n\t\t\t\t\t\treturn true","RelatedInstances.helpers = {\n  showRelatedInstaces: function() {\n    var ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n    } else {\n      ins = this.instance;\n    }\n    if ((ins != null ? ins.related_instances : void 0) && _.isArray(ins != null ? ins.related_instances : void 0)) {\n      if (db.instances.find({\n        _id: {\n          $in: ins.related_instances\n        }\n      }, {\n        fields: {\n          space: 1,\n          name: 1\n        }\n      }).count() > 0) {\n        return true;\n      }\n      return false;\n    } else {\n      return false;\n    }\n  },\n  related_instaces: function() {\n    var ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n    } else {\n      ins = this.instance;\n    }\n    if ((ins != null ? ins.related_instances : void 0) && _.isArray(ins != null ? ins.related_instances : void 0)) {\n      return db.instances.find({\n        _id: {\n          $in: ins.related_instances\n        }\n      }, {\n        fields: {\n          space: 1,\n          name: 1\n        }\n      }).fetch();\n    }\n  },\n  related_instace_url: function(ins) {\n    var absolute;\n    if (Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())) {\n      return '';\n    }\n    absolute = false;\n    if (Meteor.isServer) {\n      absolute = this.absolute;\n    }\n    if (absolute) {\n      return Meteor.absoluteUrl(\"workflow/space/\" + ins.space + \"/view/readonly/\" + ins._id + '?hide_traces=0');\n    } else {\n      return Steedos.absoluteUrl(\"workflow/space/\" + ins.space + \"/view/readonly/\" + ins._id + '?hide_traces=0');\n    }\n  },\n  _t: function(key) {\n    var locale;\n    if (Meteor.isClient) {\n      return TAPi18n.__(key);\n    } else {\n      locale = Template.instance().view.template.steedosData.locale;\n      return TAPi18n.__(key, {}, locale);\n    }\n  },\n  show_delete: function() {\n    var current_step;\n    if (!Meteor.isClient) {\n      return false;\n    } else {\n      if (Session.get(\"box\") === \"draft\" || Session.get(\"box\") === 'inbox') {\n        current_step = InstanceManager.getCurrentStep();\n        if (current_step) {\n          if (current_step.can_edit_main_attach || current_step.can_edit_normal_attach === true || current_step.can_edit_normal_attach === void 0) {\n            return true;\n          }\n        }\n      }\n    }\n  }\n};\n","RelatedRecords.helpers =\r\n\tshowRelatedRecords: ()->\r\n\t\tif Meteor.isClient\r\n\t\t\tins = WorkflowManager.getInstance();\r\n\t\telse\r\n\t\t\tins = this.instance\r\n\t\tif !ins\r\n\t\t\treturn false\r\n\t\treturn !_.isEmpty(ins.record_ids)","RelatedRecords.helpers = {\n  showRelatedRecords: function() {\n    var ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n    } else {\n      ins = this.instance;\n    }\n    if (!ins) {\n      return false;\n    }\n    return !_.isEmpty(ins.record_ids);\n  }\n};\n","DesignerAPI =\r\n\r\n\tgetAbsoluteUrl: (url)->\r\n\t\trootUrl = if __meteor_runtime_config__ then __meteor_runtime_config__.ROOT_URL_PATH_PREFIX else \"\"\r\n\t\tif rootUrl\r\n\t\t\turl = rootUrl + url\r\n\t\treturn url;\r\n\r\n\twriteResponse: (res, httpCode, body)->\r\n\t\tres.statusCode = httpCode;\r\n\t\tres.end(body);\r\n\t\t\r\n\tsendInvalidURLResponse: (res)->\r\n\t\treturn @writeResponse(res, 404, \"the param 'url' is required as querys.\");\r\n\t\t\r\n\tsendAuthTokenExpiredResponse: (res)->\r\n\t\treturn @writeResponse(res, 401, \"the auth_token has expired.\");\r\n\r\n\tsendHtmlResponse: (req, res, type)->\r\n\t\tquery = req.query\r\n\t\turl = query.url\r\n\r\n\t\tif url\r\n\t\t\turl = decodeURIComponent(url)\r\n\t\telse\r\n\t\t\tDesignerAPI.sendInvalidURLResponse res\r\n\t\t\r\n\t\ttitle = query.title\r\n\t\tif title\r\n\t\t\ttitle = decodeURIComponent(title)\r\n\t\telse\r\n\t\t\ttitle = \"Steedos Designer\"\r\n\t\t\r\n\t\terror_msg = \"\"\r\n\r\n\t\treturn @writeResponse res, 200, \"\"\"\r\n\t\t\t<html>\r\n\t\t\t\t<head>\r\n\t\t\t\t\t<style>\r\n\t\t\t\t\t\thtml,body{\r\n\t\t\t\t\t\t\tmargin: 0;\r\n\t\t\t\t\t\t\tpadding: 0;\r\n\t\t\t\t\t\t\theight: 100%;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbody { \r\n\t\t\t\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\r\n\t\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\t\tbackground-color: #fff;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.loading{\r\n\t\t\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\t\t\tleft: 0px;\r\n\t\t\t\t\t\t\tright: 0px;\r\n\t\t\t\t\t\t\ttop: 50%;\r\n\t\t\t\t\t\t\tz-index: -1;/*è®¾ç½®ä¸º-1ï¼Œå¯ä»¥åœ¨iframeåŠ è½½å‡ºæ¥åŽè‡ªåŠ¨æ¶ˆå¤±*/\r\n\t\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\t\tmargin-top: -30px;\r\n\t\t\t\t\t\t\tfont-size: 36px;\r\n\t\t\t\t\t\t\tcolor: #dfdfdf;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.error-msg{\r\n\t\t\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\t\t\tleft: 0px;\r\n\t\t\t\t\t\t\tright: 0px;\r\n\t\t\t\t\t\t\tbottom: 20px;\r\n\t\t\t\t\t\t\tz-index: 1100;\r\n\t\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\t\tfont-size: 20px;\r\n\t\t\t\t\t\t\tcolor: #a94442;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t</style>\r\n\t\t\t\t\t<meta charset=\"utf-8\">\r\n\t\t\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\">\r\n\t\t\t\t\t<title>#{title}</title>\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"192x192\" href=\"#{@getAbsoluteUrl(\"/favicons/android-chrome-192x192.png\")}\">\r\n\t\t\t\t\t<link rel=\"manifest\" href=\"#{@getAbsoluteUrl(\"/favicons/manifest.json\")}\">\r\n\t\t\t\t\t<meta name=\"mobile-web-app-capable\" content=\"yes\">\r\n\t\t\t\t\t<meta name=\"theme-color\" content=\"#000\">\r\n\t\t\t\t\t<meta name=\"application-name\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"57x57\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-57x57.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"60x60\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-60x60.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"72x72\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-72x72.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"76x76\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-76x76.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"114x114\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-114x114.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"120x120\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-120x120.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"144x144\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-144x144.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"152x152\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-152x152.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-180x180.png\")}\">\r\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\r\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\r\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-title\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"228x228\" href=\"#{@getAbsoluteUrl(\"/favicons/coast-228x228.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"16x16\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-16x16.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-32x32.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"96x96\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-96x96.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"230x230\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-230x230.png\")}\">\r\n\t\t\t\t\t<link rel=\"shortcut icon\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon.ico\")}\">\r\n\t\t\t\t\t<link rel=\"yandex-tableau-widget\" href=\"#{@getAbsoluteUrl(\"/favicons/yandex-browser-manifest.json\")}\">\r\n\t\t\t\t\t<meta name=\"msapplication-TileColor\" content=\"#fff\">\r\n\t\t\t\t\t<meta name=\"msapplication-TileImage\" content=\"#{@getAbsoluteUrl(\"/favicons/mstile-144x144.png\")}\">\r\n\t\t\t\t\t<meta name=\"msapplication-config\" content=\"#{@getAbsoluteUrl(\"/favicons/browserconfig.xml\")}\">\r\n\t\t\t\t\t<meta property=\"twitter:image\" content=\"#{@getAbsoluteUrl(\"/favicons/twitter.png\")}\">\r\n\t\t\t\t\t<meta property=\"og:image\" content=\"#{@getAbsoluteUrl(\"/favicons/open-graph.png\")}\">\r\n\t\t\t\t</head>\r\n\t\t\t\t<body>\r\n\t\t\t\t\t<div class = \"loading\">Loading...</div>\r\n\t\t\t\t\t<div class = \"error-msg\">#{error_msg}</div>\r\n\t\t\t\t\t<iframe id=\"ifrDesigner\" src=\"\" width=\"100%\" height=\"100%\" nwdisable=\"true\" frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\" allowtransparency=\"yes\"></iframe>\r\n\t\t\t\t\t<script type=\"text/javascript\" src=\"#{@getAbsoluteUrl(\"/lib/jquery/jquery-1.11.2.min.js\")}\"></script>\r\n\t\t\t\t\t<script type=\"text/javascript\">\r\n\t\t\t\t\t\tvar designer = {\r\n\t\t\t\t\t\t\turlQuery:function(name){\r\n\t\t\t\t\t\t\t\tvar reg = new RegExp(\"(^|&)\" + name + \"=([^&]*)(&|$)\");\r\n\t\t\t\t\t\t\t\tvar r = window.location.search.substr(1).match(reg);\r\n\t\t\t\t\t\t\t\tif (r != null) return unescape(r[2]);\r\n\t\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\trun:function(){\r\n\t\t\t\t\t\t\t\tvar url = this.urlQuery(\"url\");\r\n\t\t\t\t\t\t\t\turl = decodeURIComponent(url);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif(url){\r\n\t\t\t\t\t\t\t\t\t$(\"#ifrDesigner\").attr(\"src\",url);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar Steedos = window.opener.Steedos || null;\r\n\t\t\t\t\t\t\t\tif (Steedos) {\r\n\t\t\t\t\t\t\t\t\tSteedos.forbidNodeContextmenu(window);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\t$(function(){\r\n\t\t\t\t\t\t\tdesigner.run();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t</script>\r\n\t\t\t\t<body>\r\n\t\t\t</html>\r\n\t\t\"\"\"\r\n\r\nJsonRoutes.add 'get', '/api/workflow/designer?url=:url', (req, res, next) ->\r\n\tDesignerAPI.sendHtmlResponse req, res\r\n\r\n","var DesignerAPI;\n\nDesignerAPI = {\n  getAbsoluteUrl: function(url) {\n    var rootUrl;\n    rootUrl = __meteor_runtime_config__ ? __meteor_runtime_config__.ROOT_URL_PATH_PREFIX : \"\";\n    if (rootUrl) {\n      url = rootUrl + url;\n    }\n    return url;\n  },\n  writeResponse: function(res, httpCode, body) {\n    res.statusCode = httpCode;\n    return res.end(body);\n  },\n  sendInvalidURLResponse: function(res) {\n    return this.writeResponse(res, 404, \"the param 'url' is required as querys.\");\n  },\n  sendAuthTokenExpiredResponse: function(res) {\n    return this.writeResponse(res, 401, \"the auth_token has expired.\");\n  },\n  sendHtmlResponse: function(req, res, type) {\n    var error_msg, query, title, url;\n    query = req.query;\n    url = query.url;\n    if (url) {\n      url = decodeURIComponent(url);\n    } else {\n      DesignerAPI.sendInvalidURLResponse(res);\n    }\n    title = query.title;\n    if (title) {\n      title = decodeURIComponent(title);\n    } else {\n      title = \"Steedos Designer\";\n    }\n    error_msg = \"\";\n    return this.writeResponse(res, 200, \"<html>\\n\t<head>\\n\t\t<style>\\n\t\t\thtml,body{\\n\t\t\t\tmargin: 0;\\n\t\t\t\tpadding: 0;\\n\t\t\t\theight: 100%;\\n\t\t\t}\\n\t\t\tbody { \\n\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tbackground-color: #fff;\\n\t\t\t}\\n\t\t\t.loading{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\ttop: 50%;\\n\t\t\t\tz-index: -1;/*è®¾ç½®ä¸º-1ï¼Œå¯ä»¥åœ¨iframeåŠ è½½å‡ºæ¥åŽè‡ªåŠ¨æ¶ˆå¤±*/\\n\t\t\t\ttext-align: center;\\n\t\t\t\tmargin-top: -30px;\\n\t\t\t\tfont-size: 36px;\\n\t\t\t\tcolor: #dfdfdf;\\n\t\t\t}\\n\t\t\t.error-msg{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\tbottom: 20px;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tfont-size: 20px;\\n\t\t\t\tcolor: #a94442;\\n\t\t\t}\\n\t\t</style>\\n\t\t<meta charset=\\\"utf-8\\\">\\n\t\t<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\\\">\\n\t\t<title>\" + title + \"</title>\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"192x192\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/android-chrome-192x192.png\")) + \"\\\">\\n\t\t<link rel=\\\"manifest\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/manifest.json\")) + \"\\\">\\n\t\t<meta name=\\\"mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"theme-color\\\" content=\\\"#000\\\">\\n\t\t<meta name=\\\"application-name\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"57x57\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-57x57.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"60x60\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-60x60.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"72x72\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-72x72.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"76x76\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-76x76.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"114x114\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-114x114.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"120x120\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-120x120.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"144x144\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-144x144.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"152x152\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-152x152.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"180x180\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-180x180.png\")) + \"\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-status-bar-style\\\" content=\\\"black-translucent\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-title\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"228x228\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/coast-228x228.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"16x16\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-16x16.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"32x32\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-32x32.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"96x96\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-96x96.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"230x230\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-230x230.png\")) + \"\\\">\\n\t\t<link rel=\\\"shortcut icon\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon.ico\")) + \"\\\">\\n\t\t<link rel=\\\"yandex-tableau-widget\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/yandex-browser-manifest.json\")) + \"\\\">\\n\t\t<meta name=\\\"msapplication-TileColor\\\" content=\\\"#fff\\\">\\n\t\t<meta name=\\\"msapplication-TileImage\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/mstile-144x144.png\")) + \"\\\">\\n\t\t<meta name=\\\"msapplication-config\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/browserconfig.xml\")) + \"\\\">\\n\t\t<meta property=\\\"twitter:image\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/twitter.png\")) + \"\\\">\\n\t\t<meta property=\\\"og:image\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/open-graph.png\")) + \"\\\">\\n\t</head>\\n\t<body>\\n\t\t<div class = \\\"loading\\\">Loading...</div>\\n\t\t<div class = \\\"error-msg\\\">\" + error_msg + \"</div>\\n\t\t<iframe id=\\\"ifrDesigner\\\" src=\\\"\\\" width=\\\"100%\\\" height=\\\"100%\\\" nwdisable=\\\"true\\\" frameborder=\\\"no\\\" border=\\\"0\\\" marginwidth=\\\"0\\\" marginheight=\\\"0\\\" scrolling=\\\"no\\\" allowtransparency=\\\"yes\\\"></iframe>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"\" + (this.getAbsoluteUrl(\"/lib/jquery/jquery-1.11.2.min.js\")) + \"\\\"></script>\\n\t\t<script type=\\\"text/javascript\\\">\\n\t\t\tvar designer = {\\n\t\t\t\turlQuery:function(name){\\n\t\t\t\t\tvar reg = new RegExp(\\\"(^|&)\\\" + name + \\\"=([^&]*)(&|$)\\\");\\n\t\t\t\t\tvar r = window.location.search.substr(1).match(reg);\\n\t\t\t\t\tif (r != null) return unescape(r[2]);\\n\t\t\t\t\treturn null;\\n\t\t\t\t},\\n\t\t\t\trun:function(){\\n\t\t\t\t\tvar url = this.urlQuery(\\\"url\\\");\\n\t\t\t\t\turl = decodeURIComponent(url);\\n\t\t\t\t\t\\n\t\t\t\t\tif(url){\\n\t\t\t\t\t\t$(\\\"#ifrDesigner\\\").attr(\\\"src\\\",url);\\n\t\t\t\t\t}\\n\t\t\t\t\tvar Steedos = window.opener.Steedos || null;\\n\t\t\t\t\tif (Steedos) {\\n\t\t\t\t\t\tSteedos.forbidNodeContextmenu(window);\\n\t\t\t\t\t}\\n\t\t\t\t}\\n\t\t\t};\\n\t\t\t$(function(){\\n\t\t\t\tdesigner.run();\\n\t\t\t});\\n\t\t</script>\\n\t<body>\\n</html>\");\n  }\n};\n\nJsonRoutes.add('get', '/api/workflow/designer?url=:url', function(req, res, next) {\n  return DesignerAPI.sendHtmlResponse(req, res);\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/nextStepUsers\", function(req, res, next) {\r\n\tvar\r\n\t\tdeal_type = req.query.deal_type,\r\n\t\tspaceId = req.query.spaceId,\r\n\t\terror = \"\";\r\n\r\n\tif (!deal_type || !spaceId) {\r\n\t\tJsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'errors': 'ç¼ºå°‘å‚æ•°'\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tvar\r\n\t\tbody = req.body,\r\n\t\tnextStepUsers = [];\r\n\r\n\r\n\tswitch (deal_type) {\r\n\t\tcase 'specifyUser':\r\n\t\t\tvar specifyUserIds = body.specifyUserIds;\r\n\r\n\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, specifyUserIds);\r\n\t\t\tbreak;\r\n\t\tcase 'applicantRole':\r\n\t\t\tvar\r\n\t\t\t\tapplicantId = body.applicantId,\r\n\t\t\t\tapproveRoleIds = body.approveRoleIds;\r\n\t\t\tvar applicant = WorkflowManager.getUser(spaceId, applicantId);\r\n\r\n\t\t\tif (applicant)\r\n\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, applicant.organizations, approveRoleIds);\r\n\t\t\tbreak;\r\n\t\tcase 'hrRole':\r\n\t\t\tvar approveHrRoleIds = body.approveHrRoleIds;\r\n\t\t\tif (approveHrRoleIds)\r\n\t\t\t\tnextStepUsers = WorkflowManager.getHrRolesUsers(spaceId, approveHrRoleIds);\r\n\t\t\tbreak;\r\n\t\tcase 'applicantSuperior':\r\n\t\t\tvar applicantId = body.applicantId;\r\n\t\t\tvar applicant = WorkflowManager.getUser(spaceId, applicantId);\r\n\t\t\tif (applicant.manager) {\r\n\t\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, applicant.manager);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'applicant':\r\n\t\t\tvar applicantId = body.applicantId;\r\n\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, applicantId);\r\n\t\t\tbreak;\r\n\t\tcase 'userField':\r\n\t\t\tvar\r\n\t\t\t\tuserField = body.userField,\r\n\t\t\t\tuserFieldValue = body.userFieldValue;\r\n\t\t\tif (userField.is_multiselect) { //å¦‚æžœå¤šé€‰ï¼Œä»¥userFieldValueå€¼ä¸ºArray\r\n\t\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, userFieldValue);\r\n\t\t\t} else {\r\n\t\t\t\tnextStepUsers.push(WorkflowManager.getUser(spaceId, userFieldValue));\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'orgField':\r\n\t\t\tvar\r\n\t\t\t\torgs,\r\n\t\t\t\torgChildrens,\r\n\t\t\t\torgField = body.orgField,\r\n\t\t\t\torgFieldValue = body.orgFieldValue;\r\n\t\t\tif (orgFieldValue) {\r\n\t\t\t\tif (orgField.is_multiselect) { //å¦‚æžœå¤šé€‰ï¼Œä»¥orgFieldValueå€¼ä¸ºArray\r\n\t\t\t\t\torgs = WorkflowManager.getOrganizations(orgFieldValue);\r\n\t\t\t\t\torgChildrens = WorkflowManager.getOrganizationsChildrens(spaceId, orgFieldValue);\r\n\t\t\t\t} else {\r\n\t\t\t\t\torgs = [WorkflowManager.getOrganization(orgFieldValue)];\r\n\t\t\t\t\torgChildrens = WorkflowManager.getOrganizationChildrens(spaceId, orgFieldValue);\r\n\t\t\t\t}\r\n\t\t\t\tnextStepUsers = WorkflowManager.getOrganizationsUsers(spaceId, orgChildrens);\r\n\r\n\t\t\t\torgFieldUsers = WorkflowManager.getOrganizationsUsers(spaceId, orgs);\r\n\r\n\t\t\t\tnextStepUsers = nextStepUsers.concat(orgFieldUsers);\r\n\r\n\t\t\t\tif (!nextStepUsers || nextStepUsers.length < 1) {\r\n\t\t\t\t\terror = \"ORG_NO_MEMBERS\";\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\terror = \"FIELD_VALUE_EMPTY\";\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\t\tcase 'specifyOrg':\r\n\t\t\tvar specifyOrgIds = body.specifyOrgIds;\r\n\t\t\tvar specifyOrgs = WorkflowManager.getOrganizations(specifyOrgIds);\r\n\t\t\tvar specifyOrgChildrens = WorkflowManager.getOrganizationsChildrens(spaceId, specifyOrgIds);\r\n\r\n\t\t\tnextStepUsers = WorkflowManager.getOrganizationsUsers(spaceId, specifyOrgs);\r\n\t\t\tnextStepUsers = nextStepUsers.concat(WorkflowManager.getOrganizationsUsers(spaceId, specifyOrgChildrens));\r\n\t\t\tbreak;\r\n\t\tcase 'userFieldRole':\r\n\t\t\tvar\r\n\t\t\t\tuserField = body.userField,\r\n\t\t\t\tuserFieldValue = body.userFieldValue,\r\n\t\t\t\tapproverRoleIds = body.approverRoleIds;\r\n\t\t\tif (userFieldValue) {\r\n\t\t\t\tif (userField.is_multiselect) { //å¦‚æžœå¤šé€‰ï¼Œä»¥userFieldValueå€¼ä¸ºArray\r\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByUsersAndRoles(spaceId, userFieldValue, approverRoleIds);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByUsersAndRoles(spaceId, [userFieldValue], approverRoleIds);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!nextStepUsers || nextStepUsers.length < 1) {\r\n\t\t\t\t\terror = \"ROLE_NO_MEMBERS\";\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\terror = \"FIELD_VALUE_EMPTY\";\r\n\t\t\t}\r\n\r\n\r\n\t\t\tbreak;\r\n\t\tcase 'orgFieldRole':\r\n\t\t\tvar\r\n\t\t\t\torgField = body.orgField,\r\n\t\t\t\torgFieldValue = body.orgFieldValue,\r\n\t\t\t\tapproverRoleIds = body.approverRoleIds;\r\n\r\n\t\t\tif (orgFieldValue) {\r\n\t\t\t\tif (orgField.is_multiselect) { //å¦‚æžœå¤šé€‰ï¼Œä»¥orgFieldValueå€¼ä¸ºArray\r\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, orgFieldValue, approverRoleIds);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, [orgFieldValue], approverRoleIds);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!nextStepUsers || nextStepUsers.length < 1) {\r\n\t\t\t\t\terror = \"ROLE_NO_MEMBERS\";\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\terror = \"FIELD_VALUE_EMPTY\";\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tbreak;\r\n\t}\r\n\r\n\tvar result = [];\r\n\r\n\tnextStepUsers.forEach(function(su) {\r\n\t\tif(su.user_accepted){\r\n\t\t\tvar o = {\r\n\t\t\t\tid: su.id,\r\n\t\t\t\tname: su.name\r\n\t\t\t};\r\n\t\t\tresult.push(o);\r\n\t\t}\r\n\t});\r\n\r\n\tJsonRoutes.sendResult(res, {\r\n\t\tcode: 200,\r\n\t\tdata: {\r\n\t\t\t'nextStepUsers': WorkflowManager.uniqUsers(result),\r\n\t\t\t'error': error\r\n\t\t}\r\n\t});\r\n})","JsonRoutes.add(\"post\", \"/api/workflow/getSpaceUsers\", function (req, res, next) {\r\n  var\r\n    userIds = req.body.userIds,\r\n    spaceId = req.query.spaceId,\r\n    spaceUsers = []\r\n  ;\r\n\r\n  if (!userIds || !spaceId) {\r\n    JsonRoutes.sendResult(res, {\r\n      code: 200,\r\n      data: {\r\n        'errors': 'ç¼ºå°‘å‚æ•°'\r\n      }\r\n    });\r\n  }\r\n\r\n  spaceUsers = WorkflowManager.getUsers(spaceId, userIds);\r\n\r\n  JsonRoutes.sendResult(res, {\r\n    code: 200,\r\n    data: {\r\n      'spaceUsers': spaceUsers\r\n    }\r\n  });\r\n})\r\n\r\n\r\n  \r\n  ","JsonRoutes.add(\"post\", \"/api/workflow/getFormulaUserObjects\", function (req, res, next) {\r\n  var\r\n    userIds = req.body.userIds,\r\n    spaceId = req.query.spaceId,\r\n    spaceUsers = []\r\n  ;\r\n\r\n  if (!userIds || !spaceId) {\r\n    JsonRoutes.sendResult(res, {\r\n      code: 200,\r\n      data: {\r\n        'errors': 'ç¼ºå°‘å‚æ•°'\r\n      }\r\n    });\r\n  }\r\n\r\n  var users = WorkflowManager.getFormulaUserObject(spaceId, userIds);\r\n\r\n  JsonRoutes.sendResult(res, {\r\n    code: 200,\r\n    data: {\r\n      'spaceUsers': users\r\n    }\r\n  });\r\n})\r\n\r\n\r\n  \r\n  ","JsonRoutes.add(\"post\", \"/api/workflow/init_formula_values\", function(req, res, next) {\r\n\tvar\r\n\t\tfields = req.body.fields,\r\n\t\tautoFormDoc = req.body.autoFormDoc,\r\n\t\tapprover = req.body.approver,\r\n\t\tapplicant = req.body.applicant,\r\n\r\n\t\tspaceId = req.query.spaceId,\r\n\r\n\t\tspaceUsers = [];\r\n\r\n\tif (!fields || !spaceId || !autoFormDoc || !approver || !applicant) {\r\n\t\tJsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'errors': 'ç¼ºå°‘å‚æ•°'\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tformula_values = Form_formula.init_formula_values(fields, autoFormDoc, approver, applicant, spaceId);\r\n\r\n\tJsonRoutes.sendResult(res, {\r\n\t\tcode: 200,\r\n\t\tdata: {\r\n\t\t\t'formula_values': formula_values\r\n\t\t}\r\n\t});\r\n})\r\n","JsonRoutes.add \"post\", \"/api/workflow/getNameForUser\",  (req, res, next) ->\r\n\ttry\r\n\t\tuserId = req.body.userId\r\n\r\n\t\tif not userId \r\n\t\t\tJsonRoutes.sendResult res, \r\n\t\t\t\tcode: 200,\r\n\t\t\t\tdata: {\r\n\t\t\t\t\t'errors': 'ç¼ºå°‘å‚æ•°'\r\n\t\t\t\t}\r\n\r\n\t\tuser = WorkflowManager.getNameForUser(userId)\r\n\r\n\t\tJsonRoutes.sendResult res, \r\n\t\t\tcode: 200,\r\n\t\t\tdata: {user: user}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\r\n\t\r\n\t\t\r\n","JsonRoutes.add(\"post\", \"/api/workflow/getNameForUser\", function(req, res, next) {\n  var e, user, userId;\n  try {\n    userId = req.body.userId;\n    if (!userId) {\n      JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          'errors': 'ç¼ºå°‘å‚æ•°'\n        }\n      });\n    }\n    user = WorkflowManager.getNameForUser(userId);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        user: user\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'get', '/api/designer/startup', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\tcompanyId = req.query?.companyId || ''\r\n\r\n\t\tspacesQuery = { admins: current_user }\r\n\r\n\t\tif companyId\r\n\t\t\torg = db.organizations.findOne(companyId, { fields: { space:1 } })\r\n\t\t\tif not org\r\n\t\t\t\tthrow new Meteor.Error('error', 'companyId is invalid')\r\n\r\n\t\t\tspacesQuery = { _id: org.space }\r\n\r\n\t\tspaces = db.spaces.find(spacesQuery).fetch()\r\n\r\n\t\tspaceIds = _.pluck spaces, '_id'\r\n\r\n\t\tquery = { space: { $in: spaceIds } }\r\n\t\tif companyId\r\n\t\t\tquery.company_id = companyId\r\n\r\n\t\tspaceUsers = db.space_users.find(query).fetch()\r\n\r\n\t\tforms = db.forms.find(query, { fields: { name:1, state:1, is_deleted:1, is_valid:1, space:1, description:1, help_text:1,\r\n\t\tcreated:1, created_by:1, current:1, category:1, instance_style:1, company_id:1 } }).fetch()\r\n\r\n\t\tflows = db.flows.find(query, { fields: { name:1, name_formula:1, code_formula:1, space:1, description:1, is_valid:1, form:1,\r\n\t\tflowtype:1, state:1, is_deleted:1, created:1, created_by:1, help_text:1, current_no:1, current:1, perms:1, error_message:1, distribute_optional_users:1, company_id:1 } }).fetch()\r\n\r\n\t\troles = db.flow_roles.find(query).fetch()\r\n\r\n\t\torganizations = db.organizations.find(query).fetch()\r\n\r\n\t\tpositions = db.flow_positions.find(query).fetch()\r\n\r\n\t\tcategories = db.categories.find({ space: { $in: spaceIds } }).fetch()\r\n\r\n\t\tuserIds = _.pluck spaceUsers, 'user'\r\n\t\tusers = db.users.find({ _id: { $in: userIds } }, { fields: { name: 1 } }).fetch()\r\n\r\n\t\tresult = {}\r\n\t\tresult.SpaceUsers = spaceUsers\r\n\t\tresult.Users = users\r\n\t\tresult.Forms = forms\r\n\t\tresult.Flows = flows\r\n\t\tresult.Organizations = organizations\r\n\t\tresult.Positions = positions\r\n\t\tresult.Roles = roles\r\n\t\tresult.Categories = categories\r\n\t\tresult.Spaces = spaces\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 200\r\n\t\t\t\tdata: result\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\r\n\r\n","JsonRoutes.add('get', '/api/designer/startup', function(req, res, next) {\n  var categories, companyId, current_user, current_user_info, e, flows, forms, org, organizations, positions, query, ref, result, roles, spaceIds, spaceUsers, spaces, spacesQuery, userIds, users;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    companyId = ((ref = req.query) != null ? ref.companyId : void 0) || '';\n    spacesQuery = {\n      admins: current_user\n    };\n    if (companyId) {\n      org = db.organizations.findOne(companyId, {\n        fields: {\n          space: 1\n        }\n      });\n      if (!org) {\n        throw new Meteor.Error('error', 'companyId is invalid');\n      }\n      spacesQuery = {\n        _id: org.space\n      };\n    }\n    spaces = db.spaces.find(spacesQuery).fetch();\n    spaceIds = _.pluck(spaces, '_id');\n    query = {\n      space: {\n        $in: spaceIds\n      }\n    };\n    if (companyId) {\n      query.company_id = companyId;\n    }\n    spaceUsers = db.space_users.find(query).fetch();\n    forms = db.forms.find(query, {\n      fields: {\n        name: 1,\n        state: 1,\n        is_deleted: 1,\n        is_valid: 1,\n        space: 1,\n        description: 1,\n        help_text: 1,\n        created: 1,\n        created_by: 1,\n        current: 1,\n        category: 1,\n        instance_style: 1,\n        company_id: 1\n      }\n    }).fetch();\n    flows = db.flows.find(query, {\n      fields: {\n        name: 1,\n        name_formula: 1,\n        code_formula: 1,\n        space: 1,\n        description: 1,\n        is_valid: 1,\n        form: 1,\n        flowtype: 1,\n        state: 1,\n        is_deleted: 1,\n        created: 1,\n        created_by: 1,\n        help_text: 1,\n        current_no: 1,\n        current: 1,\n        perms: 1,\n        error_message: 1,\n        distribute_optional_users: 1,\n        company_id: 1\n      }\n    }).fetch();\n    roles = db.flow_roles.find(query).fetch();\n    organizations = db.organizations.find(query).fetch();\n    positions = db.flow_positions.find(query).fetch();\n    categories = db.categories.find({\n      space: {\n        $in: spaceIds\n      }\n    }).fetch();\n    userIds = _.pluck(spaceUsers, 'user');\n    users = db.users.find({\n      _id: {\n        $in: userIds\n      }\n    }, {\n      fields: {\n        name: 1\n      }\n    }).fetch();\n    result = {};\n    result.SpaceUsers = spaceUsers;\n    result.Users = users;\n    result.Forms = forms;\n    result.Flows = flows;\n    result.Organizations = organizations;\n    result.Positions = positions;\n    result.Roles = roles;\n    result.Categories = categories;\n    result.Spaces = spaces;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: result\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/engine', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\r\n\t\t_.each hashData['Approvals'], (approve_from_client) ->\r\n\t\t\tuuflowManager.workflow_engine(approve_from_client, current_user_info, current_user)\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: {}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n","JsonRoutes.add('post', '/api/workflow/engine', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Approvals'], function(approve_from_client) {\n      return uuflowManager.workflow_engine(approve_from_client, current_user_info, current_user);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/drafts', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\r\n\t\tinserted_instances = new Array\r\n\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tnew_ins_id = uuflowManager.create_instance(instance_from_client, current_user_info)\r\n\r\n\t\t\tnew_ins = db.instances.findOne({ _id: new_ins_id }, { fields: { space: 1, flow: 1, flow_version: 1, form: 1, form_version: 1 } })\r\n\r\n\t\t\tinserted_instances.push(new_ins)\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { inserts: inserted_instances }\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\r\n\t\t}\r\n\r\n","JsonRoutes.add('post', '/api/workflow/drafts', function(req, res, next) {\n  var current_user, current_user_info, e, hashData, inserted_instances;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    inserted_instances = new Array;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var new_ins, new_ins_id;\n      new_ins_id = uuflowManager.create_instance(instance_from_client, current_user_info);\n      new_ins = db.instances.findOne({\n        _id: new_ins_id\n      }, {\n        fields: {\n          space: 1,\n          flow: 1,\n          flow_version: 1,\n          form: 1,\n          form_version: 1\n        }\n      });\n      return inserted_instances.push(new_ins);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        inserts: inserted_instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/remove', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\r\n\t\tinserted_instances = new Array\r\n\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\t# èŽ·å–ä¸€ä¸ªinstance\r\n\t\t\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\r\n\t\t\tspace_id = instance.space\r\n\t\t\t# èŽ·å–ä¸€ä¸ªspace\r\n\t\t\tspace = uuflowManager.getSpace(space_id)\r\n\t\t\t# èŽ·å–ä¸€ä¸ªspaceä¸‹çš„ä¸€ä¸ªuser\r\n\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\r\n\t\t\tflow = db.flows.findOne({_id: instance.flow})\r\n\r\n\t\t\tspaceUserOrganizations = db.organizations.find({\r\n\t\t\t\t_id: {\r\n\t\t\t\t\t$in: space_user.organizations\r\n\t\t\t\t}\r\n\t\t\t}).fetch();\r\n\r\n\t\t\t# åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªinstanceçš„æäº¤è€…æˆ–è€…ç”³è¯·äºº æˆ–SpaceAdmin\r\n\t\t\tif (instance.submitter isnt current_user) and (not space.admins.includes current_user) and !WorkflowManager.canAdmin(flow, space_user, spaceUserOrganizations)\r\n\t\t\t\tthrow new  Meteor.Error('error!', \"æ‚¨ä¸èƒ½åˆ é™¤æ­¤ç”³è¯·å•ã€‚\")\r\n\r\n\t\t\tdelete_obj = db.instances.findOne(instance_from_client[\"_id\"])\r\n\t\t\tdelete_obj.deleted = new Date\r\n\t\t\tdelete_obj.deleted_by = current_user\r\n\r\n\t\t\tdb.deleted_instances.insert(delete_obj)\r\n\r\n\t\t\t# åˆ é™¤instance\r\n\t\t\tdb.instances.remove(instance_from_client[\"_id\"])\r\n\r\n\t\t\tif delete_obj.state isnt \"draft\"\r\n\t\t\t\t#å‘é€ç»™å¾…å¤„ç†äºº, #å‘é€ç»™è¢«ä¼ é˜…äºº\r\n\t\t\t\tinbox_users = if delete_obj.inbox_users then delete_obj.inbox_users else []\r\n\t\t\t\tcc_users = if delete_obj.cc_users then delete_obj.cc_users else []\r\n\t\t\t\tuser_ids = _.uniq(inbox_users.concat(cc_users))\r\n\t\t\t\t_.each user_ids, (u_id)->\r\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"terminate_approval\", u_id)\r\n\r\n\t\t\t\t# å‘é€åˆ é™¤é€šçŸ¥é‚®ä»¶ç»™é€šè¿‡æ ¡éªŒçš„ç”³è¯·äºº/å¡«å•äººï¼Œå¯¹ç”³è¯·äºº/å¡«å•äººå„ç”Ÿæˆä¸€æ¡smtp message\r\n\t\t\t\tpushManager.send_instance_notification(\"monitor_delete_applicant\", delete_obj, \"\", current_user_info)\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { inserts: inserted_instances}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n\t\r\n\t\t","JsonRoutes.add('post', '/api/workflow/remove', function(req, res, next) {\n  var current_user, current_user_info, e, hashData, inserted_instances;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    inserted_instances = new Array;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var cc_users, delete_obj, flow, inbox_users, instance, space, spaceUserOrganizations, space_id, space_user, user_ids;\n      instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n      space_id = instance.space;\n      space = uuflowManager.getSpace(space_id);\n      space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      flow = db.flows.findOne({\n        _id: instance.flow\n      });\n      spaceUserOrganizations = db.organizations.find({\n        _id: {\n          $in: space_user.organizations\n        }\n      }).fetch();\n      if ((instance.submitter !== current_user) && (!space.admins.includes(current_user)) && !WorkflowManager.canAdmin(flow, space_user, spaceUserOrganizations)) {\n        throw new Meteor.Error('error!', \"æ‚¨ä¸èƒ½åˆ é™¤æ­¤ç”³è¯·å•ã€‚\");\n      }\n      delete_obj = db.instances.findOne(instance_from_client[\"_id\"]);\n      delete_obj.deleted = new Date;\n      delete_obj.deleted_by = current_user;\n      db.deleted_instances.insert(delete_obj);\n      db.instances.remove(instance_from_client[\"_id\"]);\n      if (delete_obj.state !== \"draft\") {\n        inbox_users = delete_obj.inbox_users ? delete_obj.inbox_users : [];\n        cc_users = delete_obj.cc_users ? delete_obj.cc_users : [];\n        user_ids = _.uniq(inbox_users.concat(cc_users));\n        _.each(user_ids, function(u_id) {\n          return pushManager.send_message_to_specifyUser(\"terminate_approval\", u_id);\n        });\n        return pushManager.send_instance_notification(\"monitor_delete_applicant\", delete_obj, \"\", current_user_info);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        inserts: inserted_instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/submit', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\t\tresult = []\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tr = uuflowManager.submit_instance(instance_from_client, current_user_info)\r\n\t\t\tif r.alerts\r\n\t\t\t\tresult.push(r)\r\n\t\t\tif not _.isEmpty(instance_from_client['inbox_users'])\r\n\t\t\t\t# å¦‚æžœæ˜¯è½¬å‘å°±éœ€è¦ç»™å½“å‰ç”¨æˆ·å‘é€push é‡æ–°è®¡ç®—badge\r\n\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", current_user);\r\n\r\n\t\t\tif _.isEmpty(r.alerts)\r\n\t\t\t\tinstance = db.instances.findOne(instance_from_client._id)\r\n\t\t\t\tflow_id = instance.flow\r\n\t\t\t\tcurrent_approve = instance_from_client.traces[0].approves[0]\r\n\t\t\t\t# å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\t\tpushManager.triggerWebhook(flow_id, instance, current_approve, 'draft_submit', current_user, instance.inbox_users)\r\n\r\n\t\t\t# åˆ¤æ–­ç”³è¯·å•æ˜¯å¦åˆ†å‘ï¼Œåˆ†å‘æ–‡ä»¶ç»“æŸæé†’å‘èµ·äºº\r\n\t\t\tuuflowManager.distributedInstancesRemind(instance_from_client)\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 200\r\n\t\t\t\tdata: { result: result }\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\r\n","JsonRoutes.add('post', '/api/workflow/submit', function(req, res, next) {\n  var current_user, current_user_info, e, hashData, result;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    result = [];\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var current_approve, flow_id, instance, r;\n      r = uuflowManager.submit_instance(instance_from_client, current_user_info);\n      if (r.alerts) {\n        result.push(r);\n      }\n      if (!_.isEmpty(instance_from_client['inbox_users'])) {\n        pushManager.send_message_to_specifyUser(\"current_user\", current_user);\n      }\n      if (_.isEmpty(r.alerts)) {\n        instance = db.instances.findOne(instance_from_client._id);\n        flow_id = instance.flow;\n        current_approve = instance_from_client.traces[0].approves[0];\n        pushManager.triggerWebhook(flow_id, instance, current_approve, 'draft_submit', current_user, instance.inbox_users);\n      }\n      return uuflowManager.distributedInstancesRemind(instance_from_client);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        result: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/terminate', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tterminate_reason = instance_from_client[\"terminate_reason\"]\r\n\t\t\tinstance_id = instance_from_client[\"_id\"]\r\n\t\t\t# èŽ·å–ä¸€ä¸ªinstance\r\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\r\n\t\t\tspace_id = instance.space\r\n\t\t\tflow_id = instance.flow\r\n\t\t\t# èŽ·å–ä¸€ä¸ªspace\r\n\t\t\tspace = uuflowManager.getSpace(space_id)\r\n\t\t\t# èŽ·å–ä¸€ä¸ªflow\r\n\t\t\tflow = uuflowManager.getFlow(flow_id)\r\n\t\t\t# åˆ¤æ–­ä¸€ä¸ªinstanceæ˜¯å¦ä¸ºå®¡æ ¸ä¸­çŠ¶æ€\r\n\t\t\tuuflowManager.isInstancePending(instance)\r\n\t\t\t# èŽ·å–ä¸€ä¸ªspaceä¸‹çš„ä¸€ä¸ªuser\r\n\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t\t\t# èŽ·å–space_useræ‰€åœ¨çš„éƒ¨é—¨ä¿¡æ¯\r\n\t\t\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t\t\t# èŽ·å–ç»“æŸèŠ‚ç‚¹\r\n\t\t\tinstance_flow_ver = null\r\n\t\t\tflow_ver_end_step = null\r\n\t\t\tflow_vers = new Array\r\n\t\t\tflow_vers.push(flow.current)\r\n\t\t\tflow_vers = flow_vers.concat(flow.historys)\r\n\t\t\tinstance_flow_ver = _.find(flow_vers, (f_ver)->\r\n\t\t\t\treturn f_ver._id is instance.flow_version\r\n\t\t\t)\r\n\t\t\tif not instance_flow_ver\r\n\t\t\t\tthrow new Meteor.Error('error!', \"æœªæ‰¾åˆ°ç”³è¯·å•å¯¹åº”æµç¨‹ç‰ˆæœ¬\")\r\n\t\t\tflow_ver_end_step = _.find(instance_flow_ver.steps, (f_step)->\r\n\t\t\t\treturn f_step.step_type is \"end\"\r\n\t\t\t)\r\n\t\t\t# è°ƒç”¨getFlowPermissionsæ–¹æ³•ï¼Œçœ‹è¿”å›žçš„ç»“æžœä¸­æ˜¯å¦æœ‰admin\r\n\t\t\tpermissions = permissionManager.getFlowPermissions(flow_id, current_user)\r\n\t\t\tnow = new Date\r\n\t\t\tsetObj = new Object\r\n\t\t\t# spaceçš„admin, å¡«å•äºº ç”³è¯·äºº æœ‰æƒé™ å–æ¶ˆç”³è¯·\r\n\t\t\tif permissions.includes(\"admin\") or space.admins.includes(current_user) or instance.submitter is current_user or instance.applicant is current_user\r\n\t\t\t\tif not terminate_reason\r\n\t\t\t\t\tthrow new Meteor.Error('error!',\"è¿˜æœªå¡«å†™å¼ºåˆ¶ç»“æŸç”³è¯·å•çš„ç†ç”±ï¼Œæ“ä½œå¤±è´¥\")\r\n\r\n\t\t\t\tinstance_trace = _.find(instance.traces, (trace)->\r\n\t\t\t\t\treturn trace.is_finished is false\r\n\t\t\t\t)\r\n\r\n\t\t\t\ttraces = instance.traces\r\n\t\t\t\ti = 0\r\n\t\t\t\twhile i < traces.length\r\n\t\t\t\t\tif traces[i].is_finished is false\r\n\t\t\t\t\t\t# æ›´æ–°å½“å‰traceè®°å½•\r\n\t\t\t\t\t\ttraces[i].is_finished = true\r\n\t\t\t\t\t\ttraces[i].finish_date = now\r\n\t\t\t\t\t\th = 0\r\n\t\t\t\t\t\twhile h < traces[i].approves.length\r\n\t\t\t\t\t\t\tif traces[i].approves[h].is_finished is false\r\n\t\t\t\t\t\t\t\t# æ›´æ–°å½“å‰trace.approveè®°å½•\r\n\t\t\t\t\t\t\t\ttraces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\t\ttraces[i].approves[h].finish_date = now\r\n\t\t\t\t\t\t\t\ttraces[i].approves[h].judge = null\r\n\t\t\t\t\t\t\t\ttraces[i].approves[h].description = null\r\n\t\t\t\t\t\t\th++\r\n\t\t\t\t\t\t# æ’å…¥å½“å‰Trace trace.approveè®°å½•ï¼šå½“trace.typeä¸ºå–å›žã€å¼ºåˆ¶ç»“æŸæ—¶ï¼Œis_read=trueä¸”read_dateä¸ºå½“å‰æ—¶é—´ã€‚\r\n\t\t\t\t\t\tnewApprove = new Object\r\n\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\t\t\tnewApprove.trace = instance_trace._id\r\n\t\t\t\t\t\tnewApprove.is_finished = true\r\n\t\t\t\t\t\tnewApprove.user = current_user\r\n\t\t\t\t\t\tnewApprove.user_name = current_user_info.name\r\n\t\t\t\t\t\tnewApprove.handler = current_user\r\n\t\t\t\t\t\tnewApprove.handler_name = current_user_info.name\r\n\t\t\t\t\t\tnewApprove.handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\tnewApprove.handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\tnewApprove.handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\tnewApprove.start_date = now\r\n\t\t\t\t\t\tnewApprove.finish_date = now\r\n\t\t\t\t\t\tnewApprove.due_date = instance_trace.due_date\r\n\t\t\t\t\t\tnewApprove.read_date = now\r\n\t\t\t\t\t\tnewApprove.judge = \"terminated\"\r\n\t\t\t\t\t\tnewApprove.is_read = true\r\n\t\t\t\t\t\tnewApprove.description = terminate_reason\r\n\t\t\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\t\t\tnewApprove.values = new Object\r\n\t\t\t\t\t\tnewApprove.cost_time = newApprove.finish_date - newApprove.start_date\r\n\t\t\t\t\t\ttraces[i].approves.push(newApprove)\r\n\t\t\t\t\ti++\r\n\r\n\t\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥traceè®°å½•\r\n\t\t\t\tnewTrace = new Object\r\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\tnewTrace.previous_trace_ids = [instance_trace._id]\r\n\t\t\t\t# type---åœç”¨\r\n\t\t\t\t# newTrace.type = \"terminated\"\r\n\t\t\t\tnewTrace.is_finished = true\r\n\t\t\t\tnewTrace.step = flow_ver_end_step._id\r\n\t\t\t\tnewTrace.name = flow_ver_end_step.name\r\n\t\t\t\tnewTrace.start_date = now\r\n\t\t\t\tnewTrace.finish_date = now\r\n\t\t\t\tnewTrace.judge = \"terminated\"\r\n\r\n\t\t\t\tsetObj.state = \"completed\"\r\n\t\t\t\tsetObj.final_decision = \"terminated\"\r\n\t\t\t\told_inbox_users = instance.inbox_users\r\n\t\t\t\told_cc_users = instance.cc_users || []\r\n\t\t\t\told_outbox_users = instance.outbox_users\r\n\t\t\t\ttempUsers = new Array\r\n\t\t\t\t_.each(instance_trace.approves, (nft_approve)->\r\n\t\t\t\t\ttempUsers.push(nft_approve.user)\r\n\t\t\t\t\ttempUsers.push(nft_approve.handler)\r\n\t\t\t\t)\r\n\t\t\t\tsetObj.outbox_users = _.uniq(instance.outbox_users.concat(tempUsers))\r\n\t\t\t\tsetObj.inbox_users = new Array\r\n\t\t\t\tsetObj.cc_users = new Array\r\n\t\t\t\tsetObj.modified = now\r\n\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\ttraces.push(newTrace)\r\n\t\t\t\tsetObj.traces = traces\r\n\r\n\t\t\t\tsetObj.current_step_name = flow_ver_end_step.name\r\n\t\t\t\tsetObj.current_step_auto_submit = false\r\n\r\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\r\n\t\t\t\tif r\r\n\t\t\t\t\tins = uuflowManager.getInstance(instance_id)\r\n\t\t\t\t\t#é€šçŸ¥å¡«å•äººã€ç”³è¯·äºº\r\n\t\t\t\t\tpushManager.send_instance_notification(\"submit_terminate_applicant\", ins, terminate_reason, current_user_info)\r\n\r\n\t\t\t\t\t#å‘é€ç»™å¾…å¤„ç†äºº è¢«ä¼ é˜…äºº\r\n\t\t\t\t\tif old_inbox_users\r\n\t\t\t\t\t\t_.each(_.uniq(old_inbox_users.concat(old_cc_users)), (user_id)->\r\n\t\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"terminate_approval\", user_id)\r\n\t\t\t\t\t\t)\r\n\r\n\t\t\t\t\t# å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'terminate', current_user, [])\r\n\r\n\t\t#å‘é€æ¶ˆæ¯ç»™å½“å‰ç”¨æˆ·\r\n\t\tpushManager.send_message_current_user(current_user_info)\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 200\r\n\t\t\t\tdata: {}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\r\n","JsonRoutes.add('post', '/api/workflow/terminate', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var flow, flow_id, flow_ver_end_step, flow_vers, h, i, ins, instance, instance_flow_ver, instance_id, instance_trace, newApprove, newTrace, now, old_cc_users, old_inbox_users, old_outbox_users, permissions, r, setObj, space, space_id, space_user, space_user_org_info, tempUsers, terminate_reason, traces;\n      terminate_reason = instance_from_client[\"terminate_reason\"];\n      instance_id = instance_from_client[\"_id\"];\n      instance = uuflowManager.getInstance(instance_id);\n      space_id = instance.space;\n      flow_id = instance.flow;\n      space = uuflowManager.getSpace(space_id);\n      flow = uuflowManager.getFlow(flow_id);\n      uuflowManager.isInstancePending(instance);\n      space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n      instance_flow_ver = null;\n      flow_ver_end_step = null;\n      flow_vers = new Array;\n      flow_vers.push(flow.current);\n      flow_vers = flow_vers.concat(flow.historys);\n      instance_flow_ver = _.find(flow_vers, function(f_ver) {\n        return f_ver._id === instance.flow_version;\n      });\n      if (!instance_flow_ver) {\n        throw new Meteor.Error('error!', \"æœªæ‰¾åˆ°ç”³è¯·å•å¯¹åº”æµç¨‹ç‰ˆæœ¬\");\n      }\n      flow_ver_end_step = _.find(instance_flow_ver.steps, function(f_step) {\n        return f_step.step_type === \"end\";\n      });\n      permissions = permissionManager.getFlowPermissions(flow_id, current_user);\n      now = new Date;\n      setObj = new Object;\n      if (permissions.includes(\"admin\") || space.admins.includes(current_user) || instance.submitter === current_user || instance.applicant === current_user) {\n        if (!terminate_reason) {\n          throw new Meteor.Error('error!', \"è¿˜æœªå¡«å†™å¼ºåˆ¶ç»“æŸç”³è¯·å•çš„ç†ç”±ï¼Œæ“ä½œå¤±è´¥\");\n        }\n        instance_trace = _.find(instance.traces, function(trace) {\n          return trace.is_finished === false;\n        });\n        traces = instance.traces;\n        i = 0;\n        while (i < traces.length) {\n          if (traces[i].is_finished === false) {\n            traces[i].is_finished = true;\n            traces[i].finish_date = now;\n            h = 0;\n            while (h < traces[i].approves.length) {\n              if (traces[i].approves[h].is_finished === false) {\n                traces[i].approves[h].is_finished = true;\n                traces[i].approves[h].finish_date = now;\n                traces[i].approves[h].judge = null;\n                traces[i].approves[h].description = null;\n              }\n              h++;\n            }\n            newApprove = new Object;\n            newApprove._id = new Mongo.ObjectID()._str;\n            newApprove.instance = instance_id;\n            newApprove.trace = instance_trace._id;\n            newApprove.is_finished = true;\n            newApprove.user = current_user;\n            newApprove.user_name = current_user_info.name;\n            newApprove.handler = current_user;\n            newApprove.handler_name = current_user_info.name;\n            newApprove.handler_organization = space_user_org_info[\"organization\"];\n            newApprove.handler_organization_name = space_user_org_info[\"organization_name\"];\n            newApprove.handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n            newApprove.start_date = now;\n            newApprove.finish_date = now;\n            newApprove.due_date = instance_trace.due_date;\n            newApprove.read_date = now;\n            newApprove.judge = \"terminated\";\n            newApprove.is_read = true;\n            newApprove.description = terminate_reason;\n            newApprove.is_error = false;\n            newApprove.values = new Object;\n            newApprove.cost_time = newApprove.finish_date - newApprove.start_date;\n            traces[i].approves.push(newApprove);\n          }\n          i++;\n        }\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [instance_trace._id];\n        newTrace.is_finished = true;\n        newTrace.step = flow_ver_end_step._id;\n        newTrace.name = flow_ver_end_step.name;\n        newTrace.start_date = now;\n        newTrace.finish_date = now;\n        newTrace.judge = \"terminated\";\n        setObj.state = \"completed\";\n        setObj.final_decision = \"terminated\";\n        old_inbox_users = instance.inbox_users;\n        old_cc_users = instance.cc_users || [];\n        old_outbox_users = instance.outbox_users;\n        tempUsers = new Array;\n        _.each(instance_trace.approves, function(nft_approve) {\n          tempUsers.push(nft_approve.user);\n          return tempUsers.push(nft_approve.handler);\n        });\n        setObj.outbox_users = _.uniq(instance.outbox_users.concat(tempUsers));\n        setObj.inbox_users = new Array;\n        setObj.cc_users = new Array;\n        setObj.modified = now;\n        setObj.modified_by = current_user;\n        traces.push(newTrace);\n        setObj.traces = traces;\n        setObj.current_step_name = flow_ver_end_step.name;\n        setObj.current_step_auto_submit = false;\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj\n        });\n        if (r) {\n          ins = uuflowManager.getInstance(instance_id);\n          pushManager.send_instance_notification(\"submit_terminate_applicant\", ins, terminate_reason, current_user_info);\n          if (old_inbox_users) {\n            _.each(_.uniq(old_inbox_users.concat(old_cc_users)), function(user_id) {\n              return pushManager.send_message_to_specifyUser(\"terminate_approval\", user_id);\n            });\n          }\n          return pushManager.triggerWebhook(ins.flow, ins, {}, 'terminate', current_user, []);\n        }\n      }\n    });\n    pushManager.send_message_current_user(current_user_info);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/reassign', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tinstance_id = instance_from_client['_id']\r\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\r\n\t\t\tspace_id = instance.space\r\n\t\t\t# éªŒè¯instanceä¸ºå®¡æ ¸ä¸­çŠ¶æ€\r\n\t\t\tuuflowManager.isInstancePending(instance)\r\n\t\t\t# éªŒè¯å½“å‰æ‰§è¡Œè½¬ç­¾æ ¸çš„traceæœªç»“æŸ\r\n\t\t\tlast_trace_from_client = _.last(instance_from_client[\"traces\"])\r\n\t\t\tlast_trace = _.find(instance.traces, (t) ->\r\n\t\t\t\treturn t._id is last_trace_from_client[\"_id\"]\r\n\t\t\t)\r\n\t\t\tif last_trace.is_finished is true\r\n\t\t\t\treturn\r\n\r\n\t\t\t# éªŒè¯login user_idå¯¹è¯¥æµç¨‹æœ‰ç®¡ç†ç”³è¯·å•çš„æƒé™\r\n\t\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\r\n\t\t\tspace = db.spaces.findOne({ _id: space_id }, { fields: { admins: 1 } })\r\n\t\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user))\r\n\t\t\t\tthrow new Meteor.Error('error!', \"ç”¨æˆ·æ²¡æœ‰å¯¹å½“å‰æµç¨‹çš„ç®¡ç†æƒé™\")\r\n\r\n\t\t\tinbox_users = instance.inbox_users\r\n\t\t\tinbox_users_from_client = instance_from_client[\"inbox_users\"]\r\n\t\t\treassign_reason = instance_from_client[\"reassign_reason\"]\r\n\t\t\tnot_in_inbox_users = _.difference(inbox_users, inbox_users_from_client)\r\n\t\t\tnew_inbox_users = _.difference(inbox_users_from_client, inbox_users)\r\n\t\t\t# è‹¥assignee=åŽŸinbox_usersï¼Œè¯´æ˜Žä¸éœ€è¦æ‰§è¡Œè½¬ç­¾æ ¸ï¼Œç³»ç»Ÿä»€ä¹ˆéƒ½ä¸åš\r\n\t\t\treturn if not_in_inbox_users.length is 0 and new_inbox_users.length is 0\r\n\t\t\tsetObj = new Object\r\n\t\t\tnow = new Date\r\n\t\t\ti = 0\r\n\t\t\tapprove_users_handlers = []\r\n\t\t\twhile i < last_trace.approves.length\r\n\t\t\t\tif not_in_inbox_users.includes(last_trace.approves[i].handler)\r\n\t\t\t\t\tif last_trace.approves[i].is_finished is false and last_trace.approves[i].type isnt \"cc\" and last_trace.approves[i].type isnt \"distribute\"\r\n\t\t\t\t\t\tlast_trace.approves[i].is_finished = true\r\n\t\t\t\t\t\tlast_trace.approves[i].finish_date = now\r\n\t\t\t\t\t\tlast_trace.approves[i].judge = \"terminated\"\r\n\t\t\t\t\t\tlast_trace.approves[i].description = \"\"\r\n\t\t\t\t\t\tlast_trace.approves[i].cost_time = last_trace.approves[i].finish_date - last_trace.approves[i].start_date\r\n\t\t\t\t\t\tapprove_users_handlers.push(last_trace.approves[i].user)\r\n\t\t\t\t\t\tapprove_users_handlers.push(last_trace.approves[i].handler)\r\n\t\t\t\ti++\r\n\t\t\t# åœ¨åŒä¸€traceä¸‹æ’å…¥è½¬ç­¾æ ¸æ“ä½œè€…çš„approveè®°å½•\r\n\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t\t\tcurrent_user_organization = db.organizations.findOne({ _id: current_space_user.organization }, { fields: { name: 1, fullname: 1 } })\r\n\t\t\tassignee_appr = new Object\r\n\t\t\tassignee_appr._id = new Mongo.ObjectID()._str\r\n\t\t\tassignee_appr.instance = last_trace.instance\r\n\t\t\tassignee_appr.trace = last_trace._id\r\n\t\t\tassignee_appr.is_finished = true\r\n\t\t\tassignee_appr.user = current_user\r\n\t\t\tassignee_appr.user_name = current_user_info.name\r\n\t\t\tassignee_appr.handler = current_user\r\n\t\t\tassignee_appr.handler_name = current_user_info.name\r\n\t\t\tassignee_appr.handler_organization = current_space_user.organization\r\n\t\t\tassignee_appr.handler_organization_name = current_user_organization.name\r\n\t\t\tassignee_appr.handler_organization_fullname = current_user_organization.fullname\r\n\t\t\tassignee_appr.start_date = now\r\n\t\t\tassignee_appr.finish_date = now\r\n\t\t\tassignee_appr.due_date = last_trace.due_date\r\n\t\t\tassignee_appr.read_date = now\r\n\t\t\tassignee_appr.judge = \"reassigned\"\r\n\t\t\tassignee_appr.is_read = true\r\n\t\t\tassignee_appr.description = reassign_reason\r\n\t\t\tassignee_appr.is_error = false\r\n\t\t\tassignee_appr.values = new Object\r\n\t\t\tassignee_appr.cost_time = assignee_appr.finish_date - assignee_appr.start_date\r\n\t\t\tlast_trace.approves.push(assignee_appr)\r\n\t\t\t# å¯¹æ–°å¢žçš„æ¯ä½å¾…å®¡æ ¸äººï¼Œå„å¢žåŠ ä¸€æ¡æ–°çš„approve\r\n\t\t\t_.each(new_inbox_users, (user_id) ->\r\n\t\t\t\tnew_user = db.users.findOne(user_id, { fields: { name: 1 } })\r\n\t\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, user_id)\r\n\t\t\t\tuser_organization = db.organizations.findOne(space_user.organization, { fields: { name: 1, fullname: 1 } })\r\n\t\t\t\tnew_appr = new Object\r\n\t\t\t\tnew_appr._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnew_appr.instance = last_trace.instance\r\n\t\t\t\tnew_appr.trace = last_trace._id\r\n\t\t\t\tnew_appr.is_finished = false\r\n\t\t\t\tnew_appr.user = user_id\r\n\t\t\t\tnew_appr.user_name = new_user.name\r\n\r\n\t\t\t\thandler_id = user_id\r\n\t\t\t\thandler_info = new_user\r\n\t\t\t\tagent = uuflowManager.getAgent(space_id, user_id)\r\n\t\t\t\tif agent\r\n\t\t\t\t\tinbox_users_from_client[inbox_users_from_client.indexOf(user_id)] = agent\r\n\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\t\tnew_appr.agent = agent\r\n\r\n\t\t\t\tnew_appr.handler = handler_id\r\n\t\t\t\tnew_appr.handler_name = handler_info.name\r\n\t\t\t\tnew_appr.handler_organization = space_user.organization\r\n\t\t\t\tnew_appr.handler_organization_name = user_organization.name\r\n\t\t\t\tnew_appr.handler_organization_fullname = user_organization.fullname\r\n\t\t\t\tnew_appr.from_user = current_user\r\n\t\t\t\tnew_appr.from_user_name = current_user_info.name\r\n\t\t\t\tnew_appr.type = \"reassign\"\r\n\t\t\t\tnew_appr.start_date = now\r\n\t\t\t\tnew_appr.due_date = last_trace.due_date\r\n\t\t\t\tnew_appr.is_read = false\r\n\t\t\t\tnew_appr.is_error = false\r\n\t\t\t\tnew_appr.values = new Object\r\n\t\t\t\tuuflowManager.setRemindInfo(instance.values, new_appr)\r\n\t\t\t\tlast_trace.approves.push(new_appr)\r\n\t\t\t)\r\n\r\n\t\t\tinstance.outbox_users.push(current_user)\r\n\t\t\tinstance.outbox_users = instance.outbox_users.concat(approve_users_handlers)\r\n\t\t\tsetObj.outbox_users = _.uniq(instance.outbox_users)\r\n\t\t\tsetObj.inbox_users = inbox_users_from_client\r\n\t\t\tsetObj.modified = now\r\n\t\t\tsetObj.modified_by = current_user\r\n\t\t\tsetObj[\"traces.$.approves\"] = last_trace.approves\r\n\t\t\tr = db.instances.update({ _id: instance_id, \"traces._id\": last_trace._id }, { $set: setObj })\r\n\t\t\tif r\r\n\t\t\t\tins = uuflowManager.getInstance(instance_id)\r\n\t\t\t\t# ç»™è¢«åˆ é™¤çš„inbox_users å’Œ å½“å‰ç”¨æˆ· å‘é€push\r\n\t\t\t\tpushManager.send_message_current_user(current_user_info)\r\n\t\t\t\t_.each(not_in_inbox_users, (user_id) ->\r\n\t\t\t\t\tif user_id isnt current_user\r\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\r\n\t\t\t\t)\r\n\t\t\t\t# æå–instances.outbox_usersæ•°ç»„å’Œå¡«å•äººã€ç”³è¯·äºº\r\n\t\t\t\t_users = new Array\r\n\t\t\t\t_users.push(ins.applicant)\r\n\t\t\t\t_users.push(ins.submitter)\r\n\t\t\t\t_users = _.uniq(_users.concat(ins.outbox_users))\r\n\t\t\t\t_.each(_users, (user_id) ->\r\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\r\n\t\t\t\t)\r\n\r\n\t\t\t\t# ç»™æ–°åŠ å…¥çš„inbox_userså‘é€push message\r\n\t\t\t\tpushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, reassign_reason, current_user_info)\r\n\r\n\t\t\t\t# å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'reassign', current_user, ins.inbox_users)\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: {}\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\r\n\t\t}\r\n","JsonRoutes.add('post', '/api/workflow/reassign', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var _users, approve_users_handlers, assignee_appr, current_space_user, current_user_organization, i, inbox_users, inbox_users_from_client, ins, instance, instance_id, last_trace, last_trace_from_client, new_inbox_users, not_in_inbox_users, now, permissions, r, reassign_reason, setObj, space, space_id;\n      instance_id = instance_from_client['_id'];\n      instance = uuflowManager.getInstance(instance_id);\n      space_id = instance.space;\n      uuflowManager.isInstancePending(instance);\n      last_trace_from_client = _.last(instance_from_client[\"traces\"]);\n      last_trace = _.find(instance.traces, function(t) {\n        return t._id === last_trace_from_client[\"_id\"];\n      });\n      if (last_trace.is_finished === true) {\n        return;\n      }\n      permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n      space = db.spaces.findOne({\n        _id: space_id\n      }, {\n        fields: {\n          admins: 1\n        }\n      });\n      if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user))) {\n        throw new Meteor.Error('error!', \"ç”¨æˆ·æ²¡æœ‰å¯¹å½“å‰æµç¨‹çš„ç®¡ç†æƒé™\");\n      }\n      inbox_users = instance.inbox_users;\n      inbox_users_from_client = instance_from_client[\"inbox_users\"];\n      reassign_reason = instance_from_client[\"reassign_reason\"];\n      not_in_inbox_users = _.difference(inbox_users, inbox_users_from_client);\n      new_inbox_users = _.difference(inbox_users_from_client, inbox_users);\n      if (not_in_inbox_users.length === 0 && new_inbox_users.length === 0) {\n        return;\n      }\n      setObj = new Object;\n      now = new Date;\n      i = 0;\n      approve_users_handlers = [];\n      while (i < last_trace.approves.length) {\n        if (not_in_inbox_users.includes(last_trace.approves[i].handler)) {\n          if (last_trace.approves[i].is_finished === false && last_trace.approves[i].type !== \"cc\" && last_trace.approves[i].type !== \"distribute\") {\n            last_trace.approves[i].is_finished = true;\n            last_trace.approves[i].finish_date = now;\n            last_trace.approves[i].judge = \"terminated\";\n            last_trace.approves[i].description = \"\";\n            last_trace.approves[i].cost_time = last_trace.approves[i].finish_date - last_trace.approves[i].start_date;\n            approve_users_handlers.push(last_trace.approves[i].user);\n            approve_users_handlers.push(last_trace.approves[i].handler);\n          }\n        }\n        i++;\n      }\n      current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      current_user_organization = db.organizations.findOne({\n        _id: current_space_user.organization\n      }, {\n        fields: {\n          name: 1,\n          fullname: 1\n        }\n      });\n      assignee_appr = new Object;\n      assignee_appr._id = new Mongo.ObjectID()._str;\n      assignee_appr.instance = last_trace.instance;\n      assignee_appr.trace = last_trace._id;\n      assignee_appr.is_finished = true;\n      assignee_appr.user = current_user;\n      assignee_appr.user_name = current_user_info.name;\n      assignee_appr.handler = current_user;\n      assignee_appr.handler_name = current_user_info.name;\n      assignee_appr.handler_organization = current_space_user.organization;\n      assignee_appr.handler_organization_name = current_user_organization.name;\n      assignee_appr.handler_organization_fullname = current_user_organization.fullname;\n      assignee_appr.start_date = now;\n      assignee_appr.finish_date = now;\n      assignee_appr.due_date = last_trace.due_date;\n      assignee_appr.read_date = now;\n      assignee_appr.judge = \"reassigned\";\n      assignee_appr.is_read = true;\n      assignee_appr.description = reassign_reason;\n      assignee_appr.is_error = false;\n      assignee_appr.values = new Object;\n      assignee_appr.cost_time = assignee_appr.finish_date - assignee_appr.start_date;\n      last_trace.approves.push(assignee_appr);\n      _.each(new_inbox_users, function(user_id) {\n        var agent, handler_id, handler_info, new_appr, new_user, space_user, user_organization;\n        new_user = db.users.findOne(user_id, {\n          fields: {\n            name: 1\n          }\n        });\n        space_user = uuflowManager.getSpaceUser(space_id, user_id);\n        user_organization = db.organizations.findOne(space_user.organization, {\n          fields: {\n            name: 1,\n            fullname: 1\n          }\n        });\n        new_appr = new Object;\n        new_appr._id = new Mongo.ObjectID()._str;\n        new_appr.instance = last_trace.instance;\n        new_appr.trace = last_trace._id;\n        new_appr.is_finished = false;\n        new_appr.user = user_id;\n        new_appr.user_name = new_user.name;\n        handler_id = user_id;\n        handler_info = new_user;\n        agent = uuflowManager.getAgent(space_id, user_id);\n        if (agent) {\n          inbox_users_from_client[inbox_users_from_client.indexOf(user_id)] = agent;\n          handler_id = agent;\n          handler_info = db.users.findOne({\n            _id: agent\n          }, {\n            fields: {\n              name: 1\n            }\n          });\n          new_appr.agent = agent;\n        }\n        new_appr.handler = handler_id;\n        new_appr.handler_name = handler_info.name;\n        new_appr.handler_organization = space_user.organization;\n        new_appr.handler_organization_name = user_organization.name;\n        new_appr.handler_organization_fullname = user_organization.fullname;\n        new_appr.from_user = current_user;\n        new_appr.from_user_name = current_user_info.name;\n        new_appr.type = \"reassign\";\n        new_appr.start_date = now;\n        new_appr.due_date = last_trace.due_date;\n        new_appr.is_read = false;\n        new_appr.is_error = false;\n        new_appr.values = new Object;\n        uuflowManager.setRemindInfo(instance.values, new_appr);\n        return last_trace.approves.push(new_appr);\n      });\n      instance.outbox_users.push(current_user);\n      instance.outbox_users = instance.outbox_users.concat(approve_users_handlers);\n      setObj.outbox_users = _.uniq(instance.outbox_users);\n      setObj.inbox_users = inbox_users_from_client;\n      setObj.modified = now;\n      setObj.modified_by = current_user;\n      setObj[\"traces.$.approves\"] = last_trace.approves;\n      r = db.instances.update({\n        _id: instance_id,\n        \"traces._id\": last_trace._id\n      }, {\n        $set: setObj\n      });\n      if (r) {\n        ins = uuflowManager.getInstance(instance_id);\n        pushManager.send_message_current_user(current_user_info);\n        _.each(not_in_inbox_users, function(user_id) {\n          if (user_id !== current_user) {\n            return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n          }\n        });\n        _users = new Array;\n        _users.push(ins.applicant);\n        _users.push(ins.submitter);\n        _users = _.uniq(_users.concat(ins.outbox_users));\n        _.each(_users, function(user_id) {\n          return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n        });\n        pushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, reassign_reason, current_user_info);\n        return pushManager.triggerWebhook(ins.flow, ins, {}, 'reassign', current_user, ins.inbox_users);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/relocate', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\r\n\r\n\t\t\tlast_trace = _.last(instance.traces)\r\n\r\n\t\t\t# éªŒè¯login user_idå¯¹è¯¥æµç¨‹æœ‰ç®¡ç†ç”³è¯·å•çš„æƒé™\r\n\t\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\r\n\t\t\tspace = db.spaces.findOne(instance.space, { fields: { admins: 1 } })\r\n\t\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user))\r\n\t\t\t\tthrow new Meteor.Error('error!', \"ç”¨æˆ·æ²¡æœ‰å¯¹å½“å‰æµç¨‹çš„ç®¡ç†æƒé™\")\r\n\r\n\t\t\tspace_id = instance.space\r\n\t\t\tinstance_id = last_trace.instance\r\n\t\t\tinbox_users = instance.inbox_users\r\n\t\t\trelocate_inbox_users = instance_from_client[\"relocate_inbox_users\"]\r\n\t\t\trelocate_comment = instance_from_client[\"relocate_comment\"]\r\n\t\t\trelocate_next_step = instance_from_client[\"relocate_next_step\"]\r\n\t\t\tnot_in_inbox_users = _.difference(inbox_users, relocate_inbox_users)\r\n\t\t\tnew_inbox_users = _.difference(relocate_inbox_users, inbox_users)\r\n\r\n\t\t\tapprove_users = []\r\n\r\n\t\t\t# èŽ·å–ä¸€ä¸ªflow\r\n\t\t\tflow = uuflowManager.getFlow(instance.flow)\r\n\t\t\tnext_step = uuflowManager.getStep(instance, flow, relocate_next_step)\r\n\t\t\tnext_step_type = next_step.step_type\r\n\t\t\tnext_step_name = next_step.name\r\n\t\t\tcurrent_setp = uuflowManager.getStep(instance, flow, last_trace.step)\r\n\t\t\tcurrent_setp_type = current_setp.step_type\r\n\r\n\t\t\ttraces = instance.traces\r\n\t\t\tsetObj = new Object\r\n\t\t\t# é‡å®šä½çš„æ—¶å€™ä½¿ç”¨approve.valuesåˆå¹¶ instance.valuesç”Ÿæˆæ–°çš„instance.values #1328\r\n\t\t\tsetObj.values = uuflowManager.getUpdatedValues(instance)\r\n\t\t\tnow = new Date\r\n\t\t\ti = 0\r\n\t\t\twhile i < traces.length\r\n\t\t\t\tif traces[i]._id is last_trace._id\r\n\t\t\t\t\tif not traces[i].approves\r\n\t\t\t\t\t\ttraces[i].approves = new Array\r\n\t\t\t\t\t# æ›´æ–°å½“å‰trace.approveè®°å½•\r\n\t\t\t\t\th = 0\r\n\t\t\t\t\twhile h < traces[i].approves.length\r\n\t\t\t\t\t\tif traces[i].approves[h].is_finished is false and traces[i].approves[h].type isnt \"cc\" and traces[i].approves[h].type isnt \"distribute\"\r\n\t\t\t\t\t\t\ttraces[i].approves[h].start_date = now\r\n\t\t\t\t\t\t\ttraces[i].approves[h].finish_date = now\r\n\t\t\t\t\t\t\ttraces[i].approves[h].read_date = now\r\n\t\t\t\t\t\t\ttraces[i].approves[h].is_error = false\r\n\t\t\t\t\t\t\ttraces[i].approves[h].is_read = true\r\n\t\t\t\t\t\t\ttraces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\ttraces[i].approves[h].judge = \"terminated\"\r\n\t\t\t\t\t\t\ttraces[i].approves[h].cost_time = traces[i].approves[h].finish_date - traces[i].approves[h].start_date\r\n\t\t\t\t\t\t\tapprove_users.push(traces[i].approves[h].user)\r\n\r\n\t\t\t\t\t\t\t# begin è¢«é‡å®šä½ç»™Aï¼Œå†è¢«é‡å®šä½èµ°ï¼Œä¹‹å‰Açš„æ„è§åœ¨æ„è§æ ä¸­æ˜¾ç¤ºä¸å‡ºæ¥äº†ã€‚ #1921\r\n\t\t\t\t\t\t\tif traces[i].approves[h].sign_show == true\r\n\t\t\t\t\t\t\t\tta = traces[i].approves[h]\r\n\t\t\t\t\t\t\t\tsameTraces = _.filter traces, (t)->\r\n\t\t\t\t\t\t\t\t\treturn t.step == traces[i].step\r\n\r\n\t\t\t\t\t\t\t\tl = sameTraces.length - 1\r\n\t\t\t\t\t\t\t\tsignShowApproveId = null\r\n\r\n\t\t\t\t\t\t\t\twhile l > -1\r\n\t\t\t\t\t\t\t\t\t_.each sameTraces[l].approves, (a)->\r\n\t\t\t\t\t\t\t\t\t\tif a.user == ta.user && a.judge != \"terminated\" && a.description && !signShowApproveId\r\n\t\t\t\t\t\t\t\t\t\t\tsignShowApproveId = a._id\r\n\t\t\t\t\t\t\t\t\tl--\r\n\r\n\t\t\t\t\t\t\t\tif signShowApproveId\r\n\t\t\t\t\t\t\t\t\tti = 0\r\n\t\t\t\t\t\t\t\t\twhile ti < traces.length\r\n\t\t\t\t\t\t\t\t\t\tah = 0\r\n\t\t\t\t\t\t\t\t\t\twhile ah < traces[ti].approves.length\r\n\t\t\t\t\t\t\t\t\t\t\tif traces[ti].approves[ah]._id == signShowApproveId\r\n\t\t\t\t\t\t\t\t\t\t\t\ttraces[ti].approves[ah].sign_show = true\r\n\t\t\t\t\t\t\t\t\t\t\t\ttraces[i].approves[h].sign_show = false\r\n\t\t\t\t\t\t\t\t\t\t\tah++\r\n\t\t\t\t\t\t\t\t\t\tti++\r\n\t\t\t\t\t\t\t# end è¢«é‡å®šä½ç»™Aï¼Œå†è¢«é‡å®šä½èµ°ï¼Œä¹‹å‰Açš„æ„è§åœ¨æ„è§æ ä¸­æ˜¾ç¤ºä¸å‡ºæ¥äº†ã€‚ #1921\r\n\r\n\t\t\t\t\t\th++\r\n\r\n\t\t\t\t\t# åœ¨åŒä¸€traceä¸‹æ’å…¥é‡å®šä½æ“ä½œè€…çš„approveè®°å½•\r\n\t\t\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t\t\t\t\tcurrent_user_organization = db.organizations.findOne(current_space_user.organization, { fields: { name: 1 , fullname: 1 } })\r\n\t\t\t\t\trelocate_appr = new Object\r\n\t\t\t\t\trelocate_appr._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\trelocate_appr.instance = instance_id\r\n\t\t\t\t\trelocate_appr.trace = traces[i]._id\r\n\t\t\t\t\trelocate_appr.is_finished = true\r\n\t\t\t\t\trelocate_appr.user = current_user\r\n\t\t\t\t\trelocate_appr.user_name = current_user_info.name\r\n\t\t\t\t\trelocate_appr.handler = current_user\r\n\t\t\t\t\trelocate_appr.handler_name = current_user_info.name\r\n\t\t\t\t\trelocate_appr.handler_organization = current_space_user.organization\r\n\t\t\t\t\trelocate_appr.handler_organization_name = current_user_organization.name\r\n\t\t\t\t\trelocate_appr.handler_organization_fullname = current_user_organization.fullname\r\n\t\t\t\t\trelocate_appr.start_date = now\r\n\t\t\t\t\trelocate_appr.finish_date = now\r\n\t\t\t\t\trelocate_appr.due_date = traces[i].due_date\r\n\t\t\t\t\trelocate_appr.read_date = now\r\n\t\t\t\t\trelocate_appr.judge = \"relocated\"\r\n\t\t\t\t\trelocate_appr.is_read = true\r\n\t\t\t\t\trelocate_appr.description = relocate_comment\r\n\t\t\t\t\trelocate_appr.is_error = false\r\n\t\t\t\t\trelocate_appr.values = new Object\r\n\t\t\t\t\trelocate_appr.cost_time = relocate_appr.finish_date - relocate_appr.start_date\r\n\t\t\t\t\ttraces[i].approves.push(relocate_appr)\r\n\r\n\t\t\t\t\t# æ›´æ–°å½“å‰traceè®°å½•\r\n\t\t\t\t\ttraces[i].is_finished = true\r\n\t\t\t\t\ttraces[i].finish_date = now\r\n\t\t\t\t\ttraces[i].judge = \"relocated\"\r\n\r\n\t\t\t\ti++\r\n\r\n\t\t\tif next_step_type is \"end\"\r\n\t\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥traceè®°å½•\r\n\t\t\t\tnewTrace = new Object\r\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\tnewTrace.previous_trace_ids = [last_trace._id]\r\n\t\t\t\tnewTrace.is_finished = true\r\n\t\t\t\tnewTrace.step = relocate_next_step\r\n\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\tnewTrace.start_date = now\r\n\t\t\t\tnewTrace.finish_date = now\r\n\t\t\t\tnewTrace.approves = []\r\n\t\t\t\t# æ›´æ–°instanceè®°å½•\r\n\t\t\t\tsetObj.state = \"completed\"\r\n\t\t\t\tsetObj.inbox_users = []\r\n\t\t\t\tsetObj.final_decision = \"terminated\"\r\n\t\t\t\tsetObj.finish_date = new Date\r\n\t\t\t\tsetObj.current_step_name = next_step_name\r\n\t\t\t\tsetObj.current_step_auto_submit = false\r\n\t\t\telse\r\n\t\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥traceè®°å½•\r\n\t\t\t\tnewTrace = new Object\r\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\tnewTrace.previous_trace_ids = [last_trace._id]\r\n\t\t\t\tnewTrace.is_finished = false\r\n\t\t\t\tnewTrace.step = relocate_next_step\r\n\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\tnewTrace.start_date = now\r\n\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\r\n\t\t\t\tnewTrace.approves = []\r\n\t\t\t\t_.each(relocate_inbox_users, (next_step_user_id, idx)->\r\n\t\t\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥trace.approveè®°å½•\r\n\t\t\t\t\tnewApprove = new Object\r\n\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\t\t\tnewApprove.is_finished = false\r\n\t\t\t\t\tnewApprove.user = next_step_user_id\r\n\r\n\t\t\t\t\tuser_info = db.users.findOne(next_step_user_id, { fields: { name: 1 } })\r\n\t\t\t\t\tnewApprove.user_name = user_info.name\r\n\r\n\t\t\t\t\thandler_id = next_step_user_id\r\n\t\t\t\t\thandler_info = user_info\r\n\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\t\t\tif agent\r\n\t\t\t\t\t\trelocate_inbox_users[idx] = agent\r\n\t\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\t\t\tnewApprove.agent = agent\r\n\r\n\t\t\t\t\tnewApprove.handler = handler_id\r\n\t\t\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\r\n\t\t\t\t\t# èŽ·å–next_step_useræ‰€åœ¨çš„éƒ¨é—¨ä¿¡æ¯\r\n\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\r\n\t\t\t\t\tnewApprove.start_date = now\r\n\t\t\t\t\tnewApprove.due_date = newTrace.due_date\r\n\t\t\t\t\tnewApprove.is_read = false\r\n\t\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\t\tnewApprove.values = new Object\r\n\t\t\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\r\n\t\t\t\t\tnewTrace.approves.push(newApprove)\r\n\t\t\t\t)\r\n\t\t\t\tsetObj.inbox_users = relocate_inbox_users\r\n\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\tsetObj.current_step_name = next_step_name\r\n\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\r\n\r\n\t\t\tinstance.outbox_users.push(current_user)\r\n\t\t\tinstance.outbox_users = instance.outbox_users.concat(inbox_users).concat(approve_users)\r\n\t\t\tsetObj.outbox_users = _.uniq(instance.outbox_users)\r\n\t\t\tsetObj.modified = now\r\n\t\t\tsetObj.modified_by = current_user\r\n\t\t\tsetObj.is_archived = false\r\n\t\t\ttraces.push(newTrace)\r\n\t\t\tsetObj.traces = traces\r\n\r\n\t\t\tif setObj.state == 'completed'\r\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\r\n\t\t\telse\r\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj, $unset: {finish_date: 1}})\r\n\r\n\t\t\tif r\r\n\t\t\t\tins = uuflowManager.getInstance(instance_id)\r\n\t\t\t\t# ç»™è¢«åˆ é™¤çš„inbox_users å’Œ å½“å‰ç”¨æˆ· å‘é€push\r\n\t\t\t\tpushManager.send_message_current_user(current_user_info)\r\n\t\t\t\t_.each(not_in_inbox_users, (user_id)->\r\n\t\t\t\t\tif user_id isnt current_user\r\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\r\n\t\t\t\t)\r\n\t\t\t\t# æå–instances.outbox_usersæ•°ç»„å’Œå¡«å•äººã€ç”³è¯·äºº\r\n\t\t\t\t_users = new Array\r\n\t\t\t\t_users.push(ins.applicant)\r\n\t\t\t\t_users.push(ins.submitter)\r\n\t\t\t\t_users = _.uniq(_users.concat(ins.outbox_users))\r\n\t\t\t\t_.each(_users, (user_id)->\r\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\r\n\t\t\t\t)\r\n\r\n\t\t\t\t# ç»™æ–°åŠ å…¥çš„inbox_userså‘é€push message\r\n\t\t\t\tpushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, relocate_comment, current_user_info)\r\n\r\n\t\t\t\t# å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'relocate', current_user, ins.inbox_users)\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: {}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: {errors: [{errorMessage: e.message}]}\r\n","JsonRoutes.add('post', '/api/workflow/relocate', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var _users, ah, approve_users, current_setp, current_setp_type, current_space_user, current_user_organization, flow, h, i, inbox_users, ins, instance, instance_id, l, last_trace, newTrace, new_inbox_users, next_step, next_step_name, next_step_type, not_in_inbox_users, now, permissions, r, relocate_appr, relocate_comment, relocate_inbox_users, relocate_next_step, sameTraces, setObj, signShowApproveId, space, space_id, ta, ti, traces;\n      instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n      last_trace = _.last(instance.traces);\n      permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n      space = db.spaces.findOne(instance.space, {\n        fields: {\n          admins: 1\n        }\n      });\n      if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user))) {\n        throw new Meteor.Error('error!', \"ç”¨æˆ·æ²¡æœ‰å¯¹å½“å‰æµç¨‹çš„ç®¡ç†æƒé™\");\n      }\n      space_id = instance.space;\n      instance_id = last_trace.instance;\n      inbox_users = instance.inbox_users;\n      relocate_inbox_users = instance_from_client[\"relocate_inbox_users\"];\n      relocate_comment = instance_from_client[\"relocate_comment\"];\n      relocate_next_step = instance_from_client[\"relocate_next_step\"];\n      not_in_inbox_users = _.difference(inbox_users, relocate_inbox_users);\n      new_inbox_users = _.difference(relocate_inbox_users, inbox_users);\n      approve_users = [];\n      flow = uuflowManager.getFlow(instance.flow);\n      next_step = uuflowManager.getStep(instance, flow, relocate_next_step);\n      next_step_type = next_step.step_type;\n      next_step_name = next_step.name;\n      current_setp = uuflowManager.getStep(instance, flow, last_trace.step);\n      current_setp_type = current_setp.step_type;\n      traces = instance.traces;\n      setObj = new Object;\n      setObj.values = uuflowManager.getUpdatedValues(instance);\n      now = new Date;\n      i = 0;\n      while (i < traces.length) {\n        if (traces[i]._id === last_trace._id) {\n          if (!traces[i].approves) {\n            traces[i].approves = new Array;\n          }\n          h = 0;\n          while (h < traces[i].approves.length) {\n            if (traces[i].approves[h].is_finished === false && traces[i].approves[h].type !== \"cc\" && traces[i].approves[h].type !== \"distribute\") {\n              traces[i].approves[h].start_date = now;\n              traces[i].approves[h].finish_date = now;\n              traces[i].approves[h].read_date = now;\n              traces[i].approves[h].is_error = false;\n              traces[i].approves[h].is_read = true;\n              traces[i].approves[h].is_finished = true;\n              traces[i].approves[h].judge = \"terminated\";\n              traces[i].approves[h].cost_time = traces[i].approves[h].finish_date - traces[i].approves[h].start_date;\n              approve_users.push(traces[i].approves[h].user);\n              if (traces[i].approves[h].sign_show === true) {\n                ta = traces[i].approves[h];\n                sameTraces = _.filter(traces, function(t) {\n                  return t.step === traces[i].step;\n                });\n                l = sameTraces.length - 1;\n                signShowApproveId = null;\n                while (l > -1) {\n                  _.each(sameTraces[l].approves, function(a) {\n                    if (a.user === ta.user && a.judge !== \"terminated\" && a.description && !signShowApproveId) {\n                      return signShowApproveId = a._id;\n                    }\n                  });\n                  l--;\n                }\n                if (signShowApproveId) {\n                  ti = 0;\n                  while (ti < traces.length) {\n                    ah = 0;\n                    while (ah < traces[ti].approves.length) {\n                      if (traces[ti].approves[ah]._id === signShowApproveId) {\n                        traces[ti].approves[ah].sign_show = true;\n                        traces[i].approves[h].sign_show = false;\n                      }\n                      ah++;\n                    }\n                    ti++;\n                  }\n                }\n              }\n            }\n            h++;\n          }\n          current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n          current_user_organization = db.organizations.findOne(current_space_user.organization, {\n            fields: {\n              name: 1,\n              fullname: 1\n            }\n          });\n          relocate_appr = new Object;\n          relocate_appr._id = new Mongo.ObjectID()._str;\n          relocate_appr.instance = instance_id;\n          relocate_appr.trace = traces[i]._id;\n          relocate_appr.is_finished = true;\n          relocate_appr.user = current_user;\n          relocate_appr.user_name = current_user_info.name;\n          relocate_appr.handler = current_user;\n          relocate_appr.handler_name = current_user_info.name;\n          relocate_appr.handler_organization = current_space_user.organization;\n          relocate_appr.handler_organization_name = current_user_organization.name;\n          relocate_appr.handler_organization_fullname = current_user_organization.fullname;\n          relocate_appr.start_date = now;\n          relocate_appr.finish_date = now;\n          relocate_appr.due_date = traces[i].due_date;\n          relocate_appr.read_date = now;\n          relocate_appr.judge = \"relocated\";\n          relocate_appr.is_read = true;\n          relocate_appr.description = relocate_comment;\n          relocate_appr.is_error = false;\n          relocate_appr.values = new Object;\n          relocate_appr.cost_time = relocate_appr.finish_date - relocate_appr.start_date;\n          traces[i].approves.push(relocate_appr);\n          traces[i].is_finished = true;\n          traces[i].finish_date = now;\n          traces[i].judge = \"relocated\";\n        }\n        i++;\n      }\n      if (next_step_type === \"end\") {\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [last_trace._id];\n        newTrace.is_finished = true;\n        newTrace.step = relocate_next_step;\n        newTrace.name = next_step_name;\n        newTrace.start_date = now;\n        newTrace.finish_date = now;\n        newTrace.approves = [];\n        setObj.state = \"completed\";\n        setObj.inbox_users = [];\n        setObj.final_decision = \"terminated\";\n        setObj.finish_date = new Date;\n        setObj.current_step_name = next_step_name;\n        setObj.current_step_auto_submit = false;\n      } else {\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [last_trace._id];\n        newTrace.is_finished = false;\n        newTrace.step = relocate_next_step;\n        newTrace.name = next_step_name;\n        newTrace.start_date = now;\n        newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n        newTrace.approves = [];\n        _.each(relocate_inbox_users, function(next_step_user_id, idx) {\n          var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n          newApprove = new Object;\n          newApprove._id = new Mongo.ObjectID()._str;\n          newApprove.instance = instance_id;\n          newApprove.trace = newTrace._id;\n          newApprove.is_finished = false;\n          newApprove.user = next_step_user_id;\n          user_info = db.users.findOne(next_step_user_id, {\n            fields: {\n              name: 1\n            }\n          });\n          newApprove.user_name = user_info.name;\n          handler_id = next_step_user_id;\n          handler_info = user_info;\n          agent = uuflowManager.getAgent(space_id, next_step_user_id);\n          if (agent) {\n            relocate_inbox_users[idx] = agent;\n            handler_id = agent;\n            handler_info = db.users.findOne({\n              _id: agent\n            }, {\n              fields: {\n                name: 1\n              }\n            });\n            newApprove.agent = agent;\n          }\n          newApprove.handler = handler_id;\n          newApprove.handler_name = handler_info.name;\n          next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n          next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n          newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n          newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n          newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n          newApprove.start_date = now;\n          newApprove.due_date = newTrace.due_date;\n          newApprove.is_read = false;\n          newApprove.is_error = false;\n          newApprove.values = new Object;\n          uuflowManager.setRemindInfo(instance.values, newApprove);\n          return newTrace.approves.push(newApprove);\n        });\n        setObj.inbox_users = relocate_inbox_users;\n        setObj.state = \"pending\";\n        setObj.current_step_name = next_step_name;\n        setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n      }\n      instance.outbox_users.push(current_user);\n      instance.outbox_users = instance.outbox_users.concat(inbox_users).concat(approve_users);\n      setObj.outbox_users = _.uniq(instance.outbox_users);\n      setObj.modified = now;\n      setObj.modified_by = current_user;\n      setObj.is_archived = false;\n      traces.push(newTrace);\n      setObj.traces = traces;\n      if (setObj.state === 'completed') {\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj\n        });\n      } else {\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj,\n          $unset: {\n            finish_date: 1\n          }\n        });\n      }\n      if (r) {\n        ins = uuflowManager.getInstance(instance_id);\n        pushManager.send_message_current_user(current_user_info);\n        _.each(not_in_inbox_users, function(user_id) {\n          if (user_id !== current_user) {\n            return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n          }\n        });\n        _users = new Array;\n        _users.push(ins.applicant);\n        _users.push(ins.submitter);\n        _users = _.uniq(_users.concat(ins.outbox_users));\n        _.each(_users, function(user_id) {\n          return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n        });\n        pushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, relocate_comment, current_user_info);\n        return pushManager.triggerWebhook(ins.flow, ins, {}, 'relocate', current_user, ins.inbox_users);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/archive', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tinstance_id = instance_from_client[\"_id\"]\r\n\t\t\t# èŽ·å–ä¸€ä¸ªinstance\r\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\r\n\t\t\tspace_id = instance.space\r\n\t\t\t# èŽ·å–ä¸€ä¸ªspace\r\n\t\t\tspace = uuflowManager.getSpace(space_id)\r\n\t\t\t# åˆ¤æ–­ä¸€ä¸ªinstanceæ˜¯å¦ä¸ºå®Œæˆå¹¶ä¸”æœªå½’æ¡£çŠ¶æ€\r\n\t\t\tuuflowManager.isInstanceFinishedAndNotArchieved(instance)\r\n\t\t\t# èŽ·å–ä¸€ä¸ªspaceä¸‹çš„ä¸€ä¸ªuser\r\n\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t\t\t# åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªinstanceçš„æäº¤è€… æˆ–è€…spaceçš„ç®¡ç†å‘˜\r\n\t\t\tuuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin(instance, current_user, space)\r\n\t\t\t\r\n\t\t\tsetObj = new Object\r\n\t\t\tsetObj.is_archived = true\r\n\t\t\tsetObj.modified = new Date\r\n\t\t\tsetObj.modified_by = current_user\r\n\r\n\t\t\tdb.instances.update({_id: instance_id}, {$set: setObj})\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 200\r\n\t\t\t\tdata: {}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\r\n\t\r\n\t\t","JsonRoutes.add('post', '/api/workflow/archive', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var instance, instance_id, setObj, space, space_id, space_user;\n      instance_id = instance_from_client[\"_id\"];\n      instance = uuflowManager.getInstance(instance_id);\n      space_id = instance.space;\n      space = uuflowManager.getSpace(space_id);\n      uuflowManager.isInstanceFinishedAndNotArchieved(instance);\n      space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      uuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin(instance, current_user, space);\n      setObj = new Object;\n      setObj.is_archived = true;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      return db.instances.update({\n        _id: instance_id\n      }, {\n        $set: setObj\n      });\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","Meteor.startup ->\r\n\tWebApp.connectHandlers.use \"/api/workflow/export/instances\", (req, res, next) ->\r\n\t\ttry\r\n\t\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\r\n\t\t\tquery = req.query\r\n\t\t\tspace_id = query.space_id\r\n\t\t\tflow_id = query.flow_id\r\n\t\t\ttype = parseInt(query.type)\r\n\t\t\ttimezoneoffset = parseInt(query.timezoneoffset)\r\n\r\n\t\t\tflow = db.flows.findOne({ _id: flow_id }, { fields: { form: 1 } })\r\n\t\t\tform = db.forms.findOne({ _id: flow.form }, { fields: { name: 1, 'current.fields': 1 } })\r\n\r\n\t\t\tform_name = form.name\r\n\t\t\tfields = form.current.fields\r\n\t\t\ttable_fields = new Array\r\n\t\t\t_.each form.current.fields, (field) ->\r\n\t\t\t\tif field.type is \"table\"\r\n\t\t\t\t\ttable_fields.push(field)\r\n\r\n\t\t\tins_to_xls = new Array\r\n\t\t\tstart_date = null\r\n\t\t\tend_date = null\r\n\t\t\tnow = new Date\r\n\t\t\tselector = { space: space_id, flow: flow_id }\r\n\t\t\tselector.state = {$in: [\"pending\", \"completed\"]}\r\n\t\t\tuid = current_user_info._id\r\n\t\t\tspace = db.spaces.findOne(space_id)\r\n\t\t\tif !space\r\n\t\t\t\tselector.state = \"none\"\r\n\r\n\t\t\tif !space.admins.includes(uid)\r\n\t\t\t\tflow_ids = WorkflowManager.getMyAdminOrMonitorFlows(space_id, uid)\r\n\t\t\t\tif !flow_ids.includes(selector.flow)\r\n\t\t\t\t\tselector.$or = [{submitter: uid}, {applicant: uid}, {inbox_users: uid}, {outbox_users: uid}]\r\n\r\n\t\t\t# 0-æœ¬æœˆ\r\n\t\t\tif type is 0\r\n\t\t\t\tstart_date = new Date(now.getFullYear(), now.getMonth(), 1)\r\n\t\t\t\tselector.submit_date = { $gte: start_date }\r\n\t\t\t\tins_to_xls = db.instances.find(selector, {\r\n\t\t\t\t\tsort: { submit_date: 1 }\r\n\t\t\t\t}).fetch()\r\n\t\t\t# 1-ä¸Šæœˆ\r\n\t\t\telse if type is 1\r\n\t\t\t\tlast_month_date = new Date(new Date(now.getFullYear(), now.getMonth(), 1) - 1000 * 60 * 60 * 24)\r\n\t\t\t\tstart_date = new Date(last_month_date.getFullYear(), last_month_date.getMonth(), 1)\r\n\t\t\t\tend_date = new Date(now.getFullYear(), now.getMonth(), 1)\r\n\t\t\t\tselector.submit_date = { $gte: start_date, $lte: end_date }\r\n\t\t\t\tins_to_xls = db.instances.find(selector, {\r\n\t\t\t\t\tsort: { submit_date: 1 }\r\n\t\t\t\t}).fetch()\r\n\t\t\t# 2-æ•´ä¸ªå¹´åº¦\r\n\t\t\telse if type is 2\r\n\t\t\t\tstart_date = new Date(now.getFullYear(), 0, 1)\r\n\t\t\t\tselector.submit_date = { $gte: start_date }\r\n\t\t\t\tins_to_xls = db.instances.find(selector, {\r\n\t\t\t\t\tsort: { submit_date: 1 }\r\n\t\t\t\t}).fetch()\r\n\t\t\t# 3-æ‰€æœ‰\r\n\t\t\telse if type is 3\r\n\t\t\t\tins_to_xls = db.instances.find(selector, {\r\n\t\t\t\t\tsort: { submit_date: 1 }\r\n\t\t\t\t}).fetch()\r\n\r\n\t\t\tejs = require('ejs')\r\n\t\t\tstr = Assets.getText('server/ejs/export_instances.ejs')\r\n\r\n\t\t\t# æ£€æµ‹æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯\r\n\t\t\tejsLint = require('ejs-lint')\r\n\t\t\terror_obj = ejsLint.lint(str, {})\r\n\t\t\tif error_obj\r\n\t\t\t\tconsole.error \"===/api/workflow/export:\"\r\n\t\t\t\tconsole.error error_obj\r\n\r\n\t\t\ttemplate = ejs.compile(str)\r\n\r\n\t\t\tlang = 'en'\r\n\t\t\tif current_user_info.locale is 'zh-cn'\r\n\t\t\t\tlang = 'zh-CN'\r\n\t\t\t\r\n\t\t\tutcOffset = timezoneoffset / -60\r\n\t\t\t\r\n\t\t\tformatDate = (date, formater) ->\r\n\t\t\t\treturn moment(date).utcOffset(utcOffset).format(formater)\r\n\r\n\t\t\tret = template({\r\n\t\t\t\tlang: lang,\r\n\t\t\t\tformatDate: formatDate,\r\n\t\t\t\tform_name: form_name,\r\n\t\t\t\tfields: fields,\r\n\t\t\t\ttable_fields: table_fields,\r\n\t\t\t\tins_to_xls: ins_to_xls\r\n\t\t\t})\r\n\r\n\t\t\tfileName = \"SteedOSWorkflow_\" + moment().format('YYYYMMDDHHmm') + \".xls\"\r\n\t\t\tres.setHeader(\"Content-type\", \"application/octet-stream\")\r\n\t\t\tres.setHeader(\"Content-Disposition\", \"attachment;filename=\" + encodeURI(fileName))\r\n\t\t\tres.end(ret)\r\n\t\tcatch e\r\n\t\t\tconsole.error e.stack\r\n\t\t\tres.end(e.message)","Meteor.startup(function() {\n  return WebApp.connectHandlers.use(\"/api/workflow/export/instances\", function(req, res, next) {\n    var current_user_info, e, ejs, ejsLint, end_date, error_obj, fields, fileName, flow, flow_id, flow_ids, form, form_name, formatDate, ins_to_xls, lang, last_month_date, now, query, ret, selector, space, space_id, start_date, str, table_fields, template, timezoneoffset, type, uid, utcOffset;\n    try {\n      current_user_info = uuflowManager.check_authorization(req);\n      query = req.query;\n      space_id = query.space_id;\n      flow_id = query.flow_id;\n      type = parseInt(query.type);\n      timezoneoffset = parseInt(query.timezoneoffset);\n      flow = db.flows.findOne({\n        _id: flow_id\n      }, {\n        fields: {\n          form: 1\n        }\n      });\n      form = db.forms.findOne({\n        _id: flow.form\n      }, {\n        fields: {\n          name: 1,\n          'current.fields': 1\n        }\n      });\n      form_name = form.name;\n      fields = form.current.fields;\n      table_fields = new Array;\n      _.each(form.current.fields, function(field) {\n        if (field.type === \"table\") {\n          return table_fields.push(field);\n        }\n      });\n      ins_to_xls = new Array;\n      start_date = null;\n      end_date = null;\n      now = new Date;\n      selector = {\n        space: space_id,\n        flow: flow_id\n      };\n      selector.state = {\n        $in: [\"pending\", \"completed\"]\n      };\n      uid = current_user_info._id;\n      space = db.spaces.findOne(space_id);\n      if (!space) {\n        selector.state = \"none\";\n      }\n      if (!space.admins.includes(uid)) {\n        flow_ids = WorkflowManager.getMyAdminOrMonitorFlows(space_id, uid);\n        if (!flow_ids.includes(selector.flow)) {\n          selector.$or = [\n            {\n              submitter: uid\n            }, {\n              applicant: uid\n            }, {\n              inbox_users: uid\n            }, {\n              outbox_users: uid\n            }\n          ];\n        }\n      }\n      if (type === 0) {\n        start_date = new Date(now.getFullYear(), now.getMonth(), 1);\n        selector.submit_date = {\n          $gte: start_date\n        };\n        ins_to_xls = db.instances.find(selector, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      } else if (type === 1) {\n        last_month_date = new Date(new Date(now.getFullYear(), now.getMonth(), 1) - 1000 * 60 * 60 * 24);\n        start_date = new Date(last_month_date.getFullYear(), last_month_date.getMonth(), 1);\n        end_date = new Date(now.getFullYear(), now.getMonth(), 1);\n        selector.submit_date = {\n          $gte: start_date,\n          $lte: end_date\n        };\n        ins_to_xls = db.instances.find(selector, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      } else if (type === 2) {\n        start_date = new Date(now.getFullYear(), 0, 1);\n        selector.submit_date = {\n          $gte: start_date\n        };\n        ins_to_xls = db.instances.find(selector, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      } else if (type === 3) {\n        ins_to_xls = db.instances.find(selector, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      }\n      ejs = require('ejs');\n      str = Assets.getText('server/ejs/export_instances.ejs');\n      ejsLint = require('ejs-lint');\n      error_obj = ejsLint.lint(str, {});\n      if (error_obj) {\n        console.error(\"===/api/workflow/export:\");\n        console.error(error_obj);\n      }\n      template = ejs.compile(str);\n      lang = 'en';\n      if (current_user_info.locale === 'zh-cn') {\n        lang = 'zh-CN';\n      }\n      utcOffset = timezoneoffset / -60;\n      formatDate = function(date, formater) {\n        return moment(date).utcOffset(utcOffset).format(formater);\n      };\n      ret = template({\n        lang: lang,\n        formatDate: formatDate,\n        form_name: form_name,\n        fields: fields,\n        table_fields: table_fields,\n        ins_to_xls: ins_to_xls\n      });\n      fileName = \"SteedOSWorkflow_\" + moment().format('YYYYMMDDHHmm') + \".xls\";\n      res.setHeader(\"Content-type\", \"application/octet-stream\");\n      res.setHeader(\"Content-Disposition\", \"attachment;filename=\" + encodeURI(fileName));\n      return res.end(ret);\n    } catch (error) {\n      e = error;\n      console.error(e.stack);\n      return res.end(e.message);\n    }\n  });\n});\n","JsonRoutes.add 'get', '/uf/space/changeset', (req, res, next) ->\r\n\ttry\r\n\t\tquery = req.query\r\n\t\tauth_token = db.auth_tokens.findOne({auth_token: query.auth_token})\r\n\r\n\t\tif (not auth_token) or (not auth_token.enabled)\r\n\t\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\t\tsync_token = query[\"sync_token\"]\r\n\t\tformids = query[\"formids\"] # é€—å·éš”å¼€å­—ç¬¦ä¸²\r\n\t\tis_admin = query[\"is_admin\"]\r\n\r\n\t\tdata = uuflowManager.get_SpaceChangeSet(formids, is_admin, sync_token)\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 200\r\n\t\t\t\tdata: data\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }","JsonRoutes.add('get', '/uf/space/changeset', function(req, res, next) {\n  var auth_token, data, e, formids, is_admin, query, sync_token;\n  try {\n    query = req.query;\n    auth_token = db.auth_tokens.findOne({\n      auth_token: query.auth_token\n    });\n    if ((!auth_token) || (!auth_token.enabled)) {\n      throw new Meteor.Error(401, 'Unauthorized');\n    }\n    sync_token = query[\"sync_token\"];\n    formids = query[\"formids\"];\n    is_admin = query[\"is_admin\"];\n    data = uuflowManager.get_SpaceChangeSet(formids, is_admin, sync_token);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: data\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/retrieve', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\r\n\t\t\tretrieve_comment = instance_from_client['retrieve_comment']\r\n\r\n\t\t\t# éªŒè¯instanceä¸ºå®¡æ ¸ä¸­çŠ¶æ€\r\n\t\t\t# uuflowManager.isInstancePending(instance)\r\n\t\t\t# æ ¡éªŒç”³è¯·å•æ˜¯å½“å‰ç”¨æˆ·å·²å®¡æ ¸è¿‡çš„å•å­æˆ–è€…å½“å‰ç”¨æˆ·æ˜¯æäº¤äººæˆ–ç”³è¯·äºº\r\n\t\t\tif (not instance.outbox_users.includes(current_user)) and (instance.submitter isnt current_user and instance.applicant isnt current_user)\r\n\t\t\t\tthrow new Meteor.Error('error', 'å½“å‰ç”¨æˆ·ä¸ç¬¦åˆå–å›žæ¡ä»¶')\r\n\r\n\t\t\tretrieve_type = \"\"\r\n\r\n\t\t\ttraces = instance.traces\r\n\r\n\t\t\t#èŽ·å–æœ€æ–°çš„traceï¼Œ å³å–å›žæ­¥éª¤\r\n\t\t\tlast_trace = _.last(traces)\r\n\t\t\tlast_trace_id = last_trace._id\r\n\t\t\tprevious_trace_id = last_trace.previous_trace_ids[0];\r\n\t\t\tprevious_trace = _.find(traces, (t)->\r\n\t\t\t\treturn t._id is previous_trace_id\r\n\t\t\t)\r\n\t\t\tprevious_trace_step_id = previous_trace.step\r\n\t\t\tprevious_trace_name = previous_trace.name\r\n\t\t\tflow = uuflowManager.getFlow(instance.flow)\r\n\t\t\tprevious_step = uuflowManager.getStep(instance, flow, previous_trace_step_id)\r\n\t\t\tif previous_step.step_type is \"counterSign\"\r\n\t\t\t\tthrow new Meteor.Error('error', 'ä¼šç­¾ä¸èƒ½å–å›ž')\r\n\r\n\t\t\t# å–å›žæ­¥éª¤çš„å‰ä¸€ä¸ªæ­¥éª¤å¤„ç†äººå”¯ä¸€ï¼ˆå³æŽ’é™¤æŽ‰ä¼ é˜…å’Œè½¬å‘çš„approveåŽï¼Œå‰©ä½™çš„approveåªæœ‰ä¸€ä¸ªï¼‰å¹¶ä¸”æ˜¯å½“å‰ç”¨æˆ·\r\n\t\t\tprevious_trace_approves = _.filter previous_trace.approves, (a)->\r\n\t\t\t\treturn a.type isnt 'cc' and a.type isnt 'distribute' and a.type isnt 'forward' and ['approved','submitted','rejected'].includes(a.judge)\r\n\r\n\t\t\tif previous_trace_approves.length is 1 and (previous_trace_approves[0].user is current_user or previous_trace_approves[0].handler is current_user)\r\n\t\t\t\tretrieve_type = 'normal' # ç”³è¯·å•æ­£å¸¸æµè½¬çš„å–å›žï¼Œå³éžä¼ é˜…å–å›ž\r\n\r\n\t\t\ti = traces.length\r\n\t\t\tretrieve_approve = {}\r\n\t\t\twhile i > 0\r\n\t\t\t\t_.each traces[i-1].approves, (a)->\r\n\t\t\t\t\tif a.type is 'cc' and a.is_finished is true and a.user is current_user\r\n\t\t\t\t\t\tretrieve_type = 'cc'\r\n\t\t\t\t\t\tretrieve_approve = a\r\n\r\n\t\t\t\tif retrieve_type is 'cc'\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\ti--\r\n\r\n\r\n\t\t\tif retrieve_type is 'normal'\r\n\t\t\t\t# èŽ·å–ä¸€ä¸ªflow\r\n\t\t\t\tflow = uuflowManager.getFlow(instance.flow)\r\n\t\t\t\tprevious_step = uuflowManager.getStep(instance, flow, previous_trace_step_id)\r\n\t\t\t\tspace_id = instance.space\r\n\t\t\t\tinstance_id = instance._id\r\n\t\t\t\told_inbox_users = instance.inbox_users\r\n\t\t\t\tsetObj = new Object\r\n\t\t\t\tnow = new Date\r\n\t\t\t\t_.each traces, (t)->\r\n\t\t\t\t\tif t._id is last_trace_id\r\n\t\t\t\t\t\tif not t.approves\r\n\t\t\t\t\t\t\tt.approves = new Array\r\n\t\t\t\t\t\t# æ›´æ–°å½“å‰trace.approveè®°å½•\r\n\t\t\t\t\t\t_.each t.approves, (appr)->\r\n\t\t\t\t\t\t\tif appr.is_finished == false and appr.type isnt \"cc\"\r\n\t\t\t\t\t\t\t\tappr.start_date = now\r\n\t\t\t\t\t\t\t\tappr.finish_date = now\r\n\t\t\t\t\t\t\t\tappr.read_date = now\r\n\t\t\t\t\t\t\t\tappr.is_error = false\r\n\t\t\t\t\t\t\t\tappr.is_read = true\r\n\t\t\t\t\t\t\t\tappr.is_finished = true\r\n\t\t\t\t\t\t\t\tappr.judge = \"terminated\"\r\n\t\t\t\t\t\t\t\tappr.cost_time = appr.finish_date - appr.start_date\r\n\t\t\t\t\t\t# åœ¨åŒä¸€traceä¸‹æ’å…¥å–å›žæ“ä½œè€…çš„approveè®°å½•\r\n\t\t\t\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t\t\t\t\t\tcurrent_user_organization = db.organizations.findOne(current_space_user.organization, { fields: { name: 1, fullname: 1 } })\r\n\t\t\t\t\t\tretrieve_appr = new Object\r\n\t\t\t\t\t\tretrieve_appr._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\tretrieve_appr.instance = instance_id\r\n\t\t\t\t\t\tretrieve_appr.trace = t._id\r\n\t\t\t\t\t\tretrieve_appr.is_finished = true\r\n\t\t\t\t\t\tretrieve_appr.user = current_user\r\n\t\t\t\t\t\tretrieve_appr.user_name = current_user_info.name\r\n\t\t\t\t\t\tretrieve_appr.handler = current_user\r\n\t\t\t\t\t\tretrieve_appr.handler_name = current_user_info.name\r\n\t\t\t\t\t\tretrieve_appr.handler_organization = current_space_user.organization\r\n\t\t\t\t\t\tretrieve_appr.handler_organization_name = current_user_organization.name\r\n\t\t\t\t\t\tretrieve_appr.handler_organization_fullname = current_user_organization.fullname\r\n\t\t\t\t\t\tretrieve_appr.start_date = now\r\n\t\t\t\t\t\tretrieve_appr.finish_date = now\r\n\t\t\t\t\t\tretrieve_appr.due_date = t.due_date\r\n\t\t\t\t\t\tretrieve_appr.read_date = now\r\n\t\t\t\t\t\tretrieve_appr.judge = \"retrieved\"\r\n\t\t\t\t\t\tretrieve_appr.is_read = true\r\n\t\t\t\t\t\tretrieve_appr.description = retrieve_comment\r\n\t\t\t\t\t\tretrieve_appr.is_error = false\r\n\t\t\t\t\t\tretrieve_appr.values = new Object\r\n\t\t\t\t\t\tretrieve_appr.cost_time = retrieve_appr.finish_date - retrieve_appr.start_date\r\n\t\t\t\t\t\tt.approves.push(retrieve_appr)\r\n\r\n\t\t\t\t\t\t# æ›´æ–°å½“å‰traceè®°å½•\r\n\t\t\t\t\t\tt.is_finished = true\r\n\t\t\t\t\t\tt.finish_date = now\r\n\t\t\t\t\t\tt.judge = \"retrieved\"\r\n\r\n\t\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥traceè®°å½•\r\n\t\t\t\tnewTrace = new Object\r\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\tnewTrace.previous_trace_ids = [last_trace_id]\r\n\t\t\t\tnewTrace.is_finished = false\r\n\t\t\t\tnewTrace.step = previous_trace_step_id\r\n\t\t\t\tnewTrace.name = previous_trace_name\r\n\t\t\t\tnewTrace.start_date = now\r\n\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(previous_step.timeout_hours, space_id)\r\n\t\t\t\tnewTrace.approves = []\r\n\t\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥trace.approveè®°å½•\r\n\t\t\t\tnewApprove = new Object\r\n\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\t\tnewApprove.is_finished = false\r\n\t\t\t\tnewApprove.user = current_user\r\n\r\n\t\t\t\thandler_info = db.users.findOne(current_user, { fields: { name: 1 } })\r\n\t\t\t\tnewApprove.user_name = handler_info.name\r\n\t\t\t\tnewApprove.handler = current_user\r\n\t\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t\t\t\t# èŽ·å–next_step_useræ‰€åœ¨çš„éƒ¨é—¨ä¿¡æ¯\r\n\t\t\t\torg_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t\t\t\tnewApprove.handler_organization = org_info[\"organization\"]\r\n\t\t\t\tnewApprove.handler_organization_name = org_info[\"organization_name\"]\r\n\t\t\t\tnewApprove.handler_organization_fullname = org_info[\"organization_fullname\"]\r\n\r\n\t\t\t\tnewApprove.start_date = now\r\n\t\t\t\tnewApprove.due_date = newTrace.due_date\r\n\t\t\t\tnewApprove.is_read = false\r\n\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\tnewApprove.values = new Object\r\n\r\n\t\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\r\n\r\n\t\t\t\tnewTrace.approves.push(newApprove)\r\n\t\t\t\tsetObj.inbox_users = [current_user]\r\n\r\n\t\t\t\tsetObj.modified = now\r\n\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\ttraces.push(newTrace)\r\n\t\t\t\tsetObj.traces = traces\r\n\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\tsetObj.is_archived = false\r\n\r\n\t\t\t\tsetObj.current_step_name = previous_trace_name\r\n\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, previous_step.lines)\r\n\r\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\r\n\t\t\t\tif r\r\n\t\t\t\t\t# ç»™è¢«åˆ é™¤çš„inbox_users å’Œ å½“å‰ç”¨æˆ· å‘é€push\r\n\t\t\t\t\tpushManager.send_message_current_user(current_user_info)\r\n\t\t\t\t\t_.each(old_inbox_users, (user_id)->\r\n\t\t\t\t\t\tif user_id isnt current_user\r\n\t\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\r\n\t\t\t\t\t)\r\n\r\n\t\t\t\t\tins = uuflowManager.getInstance(instance_id)\r\n\t\t\t\t\t# å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, ins.inbox_users)\r\n\r\n\t\t\telse if retrieve_type is 'cc'\r\n\t\t\t\tsetObj = new Object\r\n\t\t\t\tnow = new Date\r\n\t\t\t\tinstance_id = instance._id\r\n\t\t\t\tthe_trace = _.find traces, (t)->\r\n\t\t\t\t\treturn t._id is retrieve_approve.trace\r\n\r\n\t\t\t\t_.each the_trace.approves, (a)->\r\n\t\t\t\t\tif a._id is retrieve_approve._id\r\n\t\t\t\t\t\ta.is_finished = false\r\n\t\t\t\t\t\ta.finish_date = undefined\r\n\t\t\t\t\t\ta.judge = undefined\r\n\t\t\t\t\t\ta.cost_time = undefined\r\n\r\n\t\t\t\tcc_users = instance.cc_users\r\n\t\t\t\tcc_users.push(current_user)\r\n\r\n\t\t\t\tsetObj.modified = now\r\n\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\tsetObj.is_archived = false\r\n\t\t\t\tsetObj.cc_users = cc_users\r\n\t\t\t\tsetObj['traces.$.approves'] = the_trace.approves\r\n\r\n\t\t\t\tr = db.instances.update({_id: instance_id, 'traces._id': retrieve_approve.trace}, {$set: setObj})\r\n\t\t\t\tif r\r\n\t\t\t\t\tpushManager.send_message_current_user(current_user_info)\r\n\r\n\t\t\t\tins = uuflowManager.getInstance(instance_id)\r\n\t\t\t\t# å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, [current_user])\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: {}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: {errors: [{errorMessage: e.message}]}\r\n","JsonRoutes.add('post', '/api/workflow/retrieve', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var cc_users, flow, handler_info, i, ins, instance, instance_id, last_trace, last_trace_id, newApprove, newTrace, now, old_inbox_users, org_info, previous_step, previous_trace, previous_trace_approves, previous_trace_id, previous_trace_name, previous_trace_step_id, r, retrieve_approve, retrieve_comment, retrieve_type, setObj, space_id, space_user, the_trace, traces;\n      instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n      retrieve_comment = instance_from_client['retrieve_comment'];\n      if ((!instance.outbox_users.includes(current_user)) && (instance.submitter !== current_user && instance.applicant !== current_user)) {\n        throw new Meteor.Error('error', 'å½“å‰ç”¨æˆ·ä¸ç¬¦åˆå–å›žæ¡ä»¶');\n      }\n      retrieve_type = \"\";\n      traces = instance.traces;\n      last_trace = _.last(traces);\n      last_trace_id = last_trace._id;\n      previous_trace_id = last_trace.previous_trace_ids[0];\n      previous_trace = _.find(traces, function(t) {\n        return t._id === previous_trace_id;\n      });\n      previous_trace_step_id = previous_trace.step;\n      previous_trace_name = previous_trace.name;\n      flow = uuflowManager.getFlow(instance.flow);\n      previous_step = uuflowManager.getStep(instance, flow, previous_trace_step_id);\n      if (previous_step.step_type === \"counterSign\") {\n        throw new Meteor.Error('error', 'ä¼šç­¾ä¸èƒ½å–å›ž');\n      }\n      previous_trace_approves = _.filter(previous_trace.approves, function(a) {\n        return a.type !== 'cc' && a.type !== 'distribute' && a.type !== 'forward' && ['approved', 'submitted', 'rejected'].includes(a.judge);\n      });\n      if (previous_trace_approves.length === 1 && (previous_trace_approves[0].user === current_user || previous_trace_approves[0].handler === current_user)) {\n        retrieve_type = 'normal';\n      }\n      i = traces.length;\n      retrieve_approve = {};\n      while (i > 0) {\n        _.each(traces[i - 1].approves, function(a) {\n          if (a.type === 'cc' && a.is_finished === true && a.user === current_user) {\n            retrieve_type = 'cc';\n            return retrieve_approve = a;\n          }\n        });\n        if (retrieve_type === 'cc') {\n          break;\n        }\n        i--;\n      }\n      if (retrieve_type === 'normal') {\n        flow = uuflowManager.getFlow(instance.flow);\n        previous_step = uuflowManager.getStep(instance, flow, previous_trace_step_id);\n        space_id = instance.space;\n        instance_id = instance._id;\n        old_inbox_users = instance.inbox_users;\n        setObj = new Object;\n        now = new Date;\n        _.each(traces, function(t) {\n          var current_space_user, current_user_organization, retrieve_appr;\n          if (t._id === last_trace_id) {\n            if (!t.approves) {\n              t.approves = new Array;\n            }\n            _.each(t.approves, function(appr) {\n              if (appr.is_finished === false && appr.type !== \"cc\") {\n                appr.start_date = now;\n                appr.finish_date = now;\n                appr.read_date = now;\n                appr.is_error = false;\n                appr.is_read = true;\n                appr.is_finished = true;\n                appr.judge = \"terminated\";\n                return appr.cost_time = appr.finish_date - appr.start_date;\n              }\n            });\n            current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n            current_user_organization = db.organizations.findOne(current_space_user.organization, {\n              fields: {\n                name: 1,\n                fullname: 1\n              }\n            });\n            retrieve_appr = new Object;\n            retrieve_appr._id = new Mongo.ObjectID()._str;\n            retrieve_appr.instance = instance_id;\n            retrieve_appr.trace = t._id;\n            retrieve_appr.is_finished = true;\n            retrieve_appr.user = current_user;\n            retrieve_appr.user_name = current_user_info.name;\n            retrieve_appr.handler = current_user;\n            retrieve_appr.handler_name = current_user_info.name;\n            retrieve_appr.handler_organization = current_space_user.organization;\n            retrieve_appr.handler_organization_name = current_user_organization.name;\n            retrieve_appr.handler_organization_fullname = current_user_organization.fullname;\n            retrieve_appr.start_date = now;\n            retrieve_appr.finish_date = now;\n            retrieve_appr.due_date = t.due_date;\n            retrieve_appr.read_date = now;\n            retrieve_appr.judge = \"retrieved\";\n            retrieve_appr.is_read = true;\n            retrieve_appr.description = retrieve_comment;\n            retrieve_appr.is_error = false;\n            retrieve_appr.values = new Object;\n            retrieve_appr.cost_time = retrieve_appr.finish_date - retrieve_appr.start_date;\n            t.approves.push(retrieve_appr);\n            t.is_finished = true;\n            t.finish_date = now;\n            return t.judge = \"retrieved\";\n          }\n        });\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [last_trace_id];\n        newTrace.is_finished = false;\n        newTrace.step = previous_trace_step_id;\n        newTrace.name = previous_trace_name;\n        newTrace.start_date = now;\n        newTrace.due_date = uuflowManager.getDueDate(previous_step.timeout_hours, space_id);\n        newTrace.approves = [];\n        newApprove = new Object;\n        newApprove._id = new Mongo.ObjectID()._str;\n        newApprove.instance = instance_id;\n        newApprove.trace = newTrace._id;\n        newApprove.is_finished = false;\n        newApprove.user = current_user;\n        handler_info = db.users.findOne(current_user, {\n          fields: {\n            name: 1\n          }\n        });\n        newApprove.user_name = handler_info.name;\n        newApprove.handler = current_user;\n        newApprove.handler_name = handler_info.name;\n        space_user = uuflowManager.getSpaceUser(space_id, current_user);\n        org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n        newApprove.handler_organization = org_info[\"organization\"];\n        newApprove.handler_organization_name = org_info[\"organization_name\"];\n        newApprove.handler_organization_fullname = org_info[\"organization_fullname\"];\n        newApprove.start_date = now;\n        newApprove.due_date = newTrace.due_date;\n        newApprove.is_read = false;\n        newApprove.is_error = false;\n        newApprove.values = new Object;\n        uuflowManager.setRemindInfo(instance.values, newApprove);\n        newTrace.approves.push(newApprove);\n        setObj.inbox_users = [current_user];\n        setObj.modified = now;\n        setObj.modified_by = current_user;\n        traces.push(newTrace);\n        setObj.traces = traces;\n        setObj.state = \"pending\";\n        setObj.is_archived = false;\n        setObj.current_step_name = previous_trace_name;\n        setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, previous_step.lines);\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj\n        });\n        if (r) {\n          pushManager.send_message_current_user(current_user_info);\n          _.each(old_inbox_users, function(user_id) {\n            if (user_id !== current_user) {\n              return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n            }\n          });\n          ins = uuflowManager.getInstance(instance_id);\n          return pushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, ins.inbox_users);\n        }\n      } else if (retrieve_type === 'cc') {\n        setObj = new Object;\n        now = new Date;\n        instance_id = instance._id;\n        the_trace = _.find(traces, function(t) {\n          return t._id === retrieve_approve.trace;\n        });\n        _.each(the_trace.approves, function(a) {\n          if (a._id === retrieve_approve._id) {\n            a.is_finished = false;\n            a.finish_date = void 0;\n            a.judge = void 0;\n            return a.cost_time = void 0;\n          }\n        });\n        cc_users = instance.cc_users;\n        cc_users.push(current_user);\n        setObj.modified = now;\n        setObj.modified_by = current_user;\n        setObj.state = \"pending\";\n        setObj.is_archived = false;\n        setObj.cc_users = cc_users;\n        setObj['traces.$.approves'] = the_trace.approves;\n        r = db.instances.update({\n          _id: instance_id,\n          'traces._id': retrieve_approve.trace\n        }, {\n          $set: setObj\n        });\n        if (r) {\n          pushManager.send_message_current_user(current_user_info);\n        }\n        ins = uuflowManager.getInstance(instance_id);\n        return pushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, [current_user]);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add('post', '/api/workflow/forward', function (req, res, next) {\r\n\ttry {\r\n\t\tvar current_user_info = uuflowManager.check_authorization(req);\r\n\t\tvar current_user_id = current_user_info._id;\r\n\r\n\t\tvar hashData = req.body;\r\n\t\tvar instance_id = hashData.instance_id;\r\n\t\tvar space_id = hashData.space_id;\r\n\t\tvar flow_id = hashData.flow_id;\r\n\t\tvar hasSaveInstanceToAttachment = hashData.hasSaveInstanceToAttachment;\r\n\t\tvar description = hashData.description;\r\n\t\tvar isForwardAttachments = hashData.isForwardAttachments;\r\n\t\tvar selectedUsers = hashData.selectedUsers;\r\n\t\tvar action_type = hashData.action_type;\r\n\t\tvar related = hashData.related;\r\n\t\tvar from_approve_id = hashData.from_approve_id;\r\n\r\n\t\tcheck(instance_id, String);\r\n\t\tcheck(space_id, String);\r\n\t\tcheck(flow_id, String);\r\n\t\tcheck(hasSaveInstanceToAttachment, Boolean);\r\n\t\tcheck(description, String);\r\n\t\tcheck(isForwardAttachments, Boolean);\r\n\t\tcheck(selectedUsers, Array);\r\n\t\tcheck(action_type, Match.OneOf('forward', 'distribute'));\r\n\r\n\t\tif (action_type == \"distribute\")\r\n\t\t\tcheck(from_approve_id, String);\r\n\r\n\t\tvar ins = db.instances.findOne(instance_id);\r\n\t\tvar old_space_id = ins.space;\r\n\r\n\t\tvar flow = db.flows.findOne(flow_id);\r\n\r\n\t\tvar space = db.spaces.findOne(space_id);\r\n\r\n\t\tif (!ins || !flow || !space) {\r\n\t\t\tthrow new Meteor.Error('params error!', 'record not exists!');\r\n\t\t}\r\n\r\n\t\tvar forward_users = new Array;\r\n\t\tif (_.isEmpty(selectedUsers)) {\r\n\t\t\tforward_users = [current_user_id];\r\n\t\t} else {\r\n\t\t\tforward_users = selectedUsers;\r\n\t\t}\r\n\r\n\t\t// æ ¡éªŒåˆ†å‘å¯¹è±¡æ˜¯å¦æœ‰åˆ†å‘æµç¨‹çš„æäº¤æƒé™\r\n\t\tvar no_permission_user_ids = new Array();\r\n\t\t_.each(forward_users, function (uid) {\r\n\t\t\tvar permissions = permissionManager.getFlowPermissions(flow_id, uid);\r\n\t\t\tif (!permissions.includes(\"add\")) {\r\n\t\t\t\t// throw new Meteor.Error('error!', \"è¯¥ç”³è¯·äººæ²¡æœ‰æäº¤æ­¤ç”³è¯·å•çš„æƒé™ã€‚\")\r\n\t\t\t\tno_permission_user_ids.push(uid);\r\n\t\t\t}\r\n\t\t})\r\n\t\tif (!_.isEmpty(no_permission_user_ids)) {\r\n\t\t\tvar no_permission_users_name = new Array();\r\n\t\t\tdb.users.find({\r\n\t\t\t\t_id: {\r\n\t\t\t\t\t$in: no_permission_user_ids\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\tname: 1\r\n\t\t\t\t}\r\n\t\t\t}).forEach(function (u) {\r\n\t\t\t\tno_permission_users_name.push(u.name);\r\n\t\t\t});\r\n\t\t\tthrow new Meteor.Error('no_permission', \"è¯¥æäº¤äººæ²¡æœ‰æäº¤æ­¤ç”³è¯·å•çš„æƒé™ã€‚\", no_permission_users_name.join(','))\r\n\t\t}\r\n\r\n\t\tvar new_ins_ids = new Array;\r\n\r\n\t\tvar current_trace = null;\r\n\t\tif (action_type == \"distribute\") {\r\n\t\t\t_.each(ins.traces, function (t) {\r\n\t\t\t\tif (!current_trace) {\r\n\t\t\t\t\t_.each(t.approves, function (a) {\r\n\t\t\t\t\t\tif (!current_trace) {\r\n\t\t\t\t\t\t\tif (a._id == from_approve_id)\r\n\t\t\t\t\t\t\t\tcurrent_trace = t;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t} else {\r\n\t\t\tcurrent_trace = _.last(ins.traces);\r\n\t\t}\r\n\t\tvar current_trace_id = current_trace._id;\r\n\t\tvar forward_approves = [];\r\n\t\tvar from_user_name = db.users.findOne(current_user_id, {\r\n\t\t\tfields: {\r\n\t\t\t\tname: 1\r\n\t\t\t}\r\n\t\t}).name\r\n\t\tvar set_obj = new Object;\r\n\r\n\t\t// è®¡ç®—values\r\n\t\tvar old_values = ins.values,\r\n\t\t\tnew_values = {};\r\n\t\tvar form = db.forms.findOne(flow.form);\r\n\t\tvar fields = form.current.fields || [];\r\n\r\n\t\tvar old_form = db.forms.findOne(ins.form);\r\n\t\tvar old_form_version = ins.form_version,\r\n\t\t\told_fields = [],\r\n\t\t\tcommon_fields = [];\r\n\r\n\t\tvar select_to_input_fields = [];\r\n\r\n\t\tif (old_form.current._id == old_form_version) {\r\n\t\t\told_fields = old_form.current.fields;\r\n\t\t} else {\r\n\t\t\tif (old_form.historys) {\r\n\t\t\t\told_form.historys.forEach(function (h) {\r\n\t\t\t\t\tif (h._id == old_form_version)\r\n\t\t\t\t\t\told_fields = h.fields;\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfields.forEach(function (field) {\r\n\t\t\tvar exists_field = _.find(old_fields, function (f) {\r\n\t\t\t\treturn f.type == field.type && f.code == field.code;\r\n\t\t\t})\r\n\t\t\tif (exists_field)\r\n\t\t\t\tcommon_fields.push(field);\r\n\t\t\tvar select_input_field = _.find(old_fields, function (f) {\r\n\t\t\t\treturn f.type == 'select' && field.type == 'input' && f.code == field.code;\r\n\t\t\t})\r\n\t\t\tif (select_input_field)\r\n\t\t\t\tselect_to_input_fields.push(select_input_field);\r\n\t\t})\r\n\r\n\t\tselect_to_input_fields.forEach(function (field) {\r\n\t\t\tif (old_values[field.code]) {\r\n\t\t\t\tnew_values[field.code] = old_values[field.code];\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tcommon_fields.forEach(function (field) {\r\n\t\t\tif (field.type == 'section') {\r\n\t\t\t\tif (field.fields) {\r\n\t\t\t\t\tfield.fields.forEach(function (f) {\r\n\t\t\t\t\t\t// è·¨å·¥ä½œåŒºè½¬å‘ä¸å¤åˆ¶é€‰äººé€‰ç»„\r\n\t\t\t\t\t\tif (['group', 'user'].includes(f.type) && old_space_id != space_id) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar key = f.code;\r\n\t\t\t\t\t\tvar old_v = old_values[key];\r\n\t\t\t\t\t\tif (old_v) {\r\n\t\t\t\t\t\t\t// æ ¡éªŒ å•é€‰ï¼Œå¤šé€‰ï¼Œä¸‹æ‹‰æ¡† å­—æ®µå€¼æ˜¯å¦åœ¨æ–°è¡¨å•å¯¹åº”å­—æ®µçš„å¯é€‰å€¼èŒƒå›´å†…\r\n\t\t\t\t\t\t\tif (f.type == 'select' || f.type == 'radio') {\r\n\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\r\n\t\t\t\t\t\t\t\tif (!options.includes(old_v))\r\n\t\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tif (f.type == 'multiSelect') {\r\n\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\r\n\t\t\t\t\t\t\t\tvar old_multiSelected = old_v.split(',');\r\n\t\t\t\t\t\t\t\tvar new_multiSelected = _.intersection(options, old_multiSelected);\r\n\t\t\t\t\t\t\t\told_v = new_multiSelected.join(',');\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tnew_values[key] = old_v;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t} else if (field.type == 'table') {\r\n\t\t\t\tif (!_.isEmpty(old_values[field.code])) {\r\n\t\t\t\t\tnew_values[field.code] = new Array;\r\n\t\t\t\t\told_values[field.code].forEach(function (old_table_row_values) {\r\n\t\t\t\t\t\tvar new_table_row_values = {};\r\n\r\n\t\t\t\t\t\tif (!_.isEmpty(field.fields)) {\r\n\t\t\t\t\t\t\tfield.fields.forEach(function (f) {\r\n\t\t\t\t\t\t\t\t// è·¨å·¥ä½œåŒºè½¬å‘ä¸å¤åˆ¶é€‰äººé€‰ç»„\r\n\t\t\t\t\t\t\t\tif (['group', 'user'].includes(f.type) && old_space_id != space_id) {\r\n\t\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar key = f.code;\r\n\t\t\t\t\t\t\t\tvar old_v = old_table_row_values[key];\r\n\t\t\t\t\t\t\t\tif (old_v) {\r\n\t\t\t\t\t\t\t\t\t// æ ¡éªŒ å•é€‰ï¼Œå¤šé€‰ï¼Œä¸‹æ‹‰æ¡† å­—æ®µå€¼æ˜¯å¦åœ¨æ–°è¡¨å•å¯¹åº”å­—æ®µçš„å¯é€‰å€¼èŒƒå›´å†…\r\n\t\t\t\t\t\t\t\t\tif (f.type == 'select' || f.type == 'radio') {\r\n\t\t\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\r\n\t\t\t\t\t\t\t\t\t\tif (!options.includes(old_v))\r\n\t\t\t\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\tif (f.type == 'multiSelect') {\r\n\t\t\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\r\n\t\t\t\t\t\t\t\t\t\tvar old_multiSelected = old_v.split(',');\r\n\t\t\t\t\t\t\t\t\t\tvar new_multiSelected = _.intersection(options, old_multiSelected);\r\n\t\t\t\t\t\t\t\t\t\told_v = new_multiSelected.join(',');\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\tnew_table_row_values[key] = old_v;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (old_table_row_values._id) {\r\n\t\t\t\t\t\t\tnew_table_row_values._id = new Mongo.ObjectID()._str;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (!_.isEmpty(new_table_row_values)) {\r\n\t\t\t\t\t\t\tnew_values[field.code].push(new_table_row_values);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// è·¨å·¥ä½œåŒºè½¬å‘ä¸å¤åˆ¶é€‰äººé€‰ç»„\r\n\t\t\t\tif (['group', 'user'].includes(field.type) && old_space_id != space_id) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tvar key = field.code;\r\n\t\t\t\tvar old_v = old_values[key];\r\n\t\t\t\tif (old_v) {\r\n\t\t\t\t\t// æ ¡éªŒ å•é€‰ï¼Œå¤šé€‰ï¼Œä¸‹æ‹‰æ¡† å­—æ®µå€¼æ˜¯å¦åœ¨æ–°è¡¨å•å¯¹åº”å­—æ®µçš„å¯é€‰å€¼èŒƒå›´å†…\r\n\t\t\t\t\tif (field.type == 'select' || field.type == 'radio') {\r\n\t\t\t\t\t\tvar options = field.options.split('\\n');\r\n\t\t\t\t\t\tif (!options.includes(old_v))\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (field.type == 'multiSelect') {\r\n\t\t\t\t\t\tvar options = field.options.split('\\n');\r\n\t\t\t\t\t\tvar old_multiSelected = old_v.split(',');\r\n\t\t\t\t\t\tvar new_multiSelected = _.intersection(options, old_multiSelected);\r\n\t\t\t\t\t\told_v = new_multiSelected.join(',');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tnew_values[key] = old_v;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t})\r\n\r\n\t\t//å¦‚æžœæ˜¯åˆ†å‘ï¼Œåˆ™valueä¸­çš„record_needã€FONDSIDä¸éœ€è¦åˆ†å‘åˆ°æ–°ç”³è¯·å•ä¸­\r\n\t\tif (action_type === 'distribute') {\r\n\t\t\tdelete new_values.record_need;\r\n\t\t\tdelete new_values.FONDSID;\r\n\t\t}\r\n\r\n\t\t// è®¡ç®—ç”³è¯·å•æ ‡é¢˜\r\n\t\tvar instance_name = \"\";\r\n\t\tvar name_forumla = form.current.name_forumla;\r\n\t\tif (name_forumla) {\r\n\t\t\ttry {\r\n\t\t\t\tvar iscript = name_forumla.replace(/\\{/g, \"(new_values['\").replace(/\\}/g, \"'] || '')\");\r\n\t\t\t\tvar rev = eval(iscript);\r\n\t\t\t\tinstance_name = rev || flow.name;\r\n\t\t\t} catch (error) {\r\n\t\t\t\tthrow new Meteor.Error('caculate_instance_name', \"è®¡ç®—ç”³è¯·å•æ ‡é¢˜å‡ºé”™è¯·æ£€æŸ¥è¡¨å•æ ‡é¢˜è„šæœ¬ã€‚\");\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tinstance_name = flow.name;\r\n\t\t}\r\n\r\n\t\t// instanceä¸­è®°å½•å½“å‰æ­¥éª¤åç§° #1314\r\n\t\tvar start_step = _.find(flow.current.steps, function (step) {\r\n\t\t\treturn step.step_type == 'start';\r\n\t\t})\r\n\r\n\t\t// æ–°å»ºç”³è¯·å•æ—¶ï¼Œinstancesè®°å½•æµç¨‹åç§°ã€æµç¨‹åˆ†ç±»åç§° #1313\r\n\t\tvar category_name = \"\";\r\n\t\tif (form.category) {\r\n\t\t\tvar category = uuflowManager.getCategory(form.category);\r\n\t\t\tif (category)\r\n\t\t\t\tcategory_name = category.name;\r\n\t\t}\r\n\r\n\t\t_.each(forward_users, function (user_id) {\r\n\r\n\t\t\tvar user_info = db.users.findOne(user_id);\r\n\r\n\t\t\tvar space_user = db.space_users.findOne({\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\tuser: user_id\r\n\t\t\t}, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\torganization: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar space_user_org_info = db.organizations.findOne({\r\n\t\t\t\t_id: space_user.organization\r\n\t\t\t}, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\tname: 1,\r\n\t\t\t\t\tfullname: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tvar now = new Date();\r\n\t\t\tvar ins_obj = {};\r\n\r\n\t\t\tvar agent = uuflowManager.getAgent(space_id, user_id);\r\n\t\t\tvar handler_id = user_id;\r\n\t\t\tvar handler_info = user_info;\r\n\t\t\tvar handler_space_user = space_user;\r\n\t\t\tvar handler_org_info = space_user_org_info;\r\n\t\t\tif (agent) {\r\n\t\t\t\thandler_id = agent;\r\n\t\t\t\thandler_info = db.users.findOne(agent);\r\n\t\t\t\thandler_space_user = uuflowManager.getSpaceUser(space_id, agent);\r\n\t\t\t\thandler_org_info = uuflowManager.getSpaceUserOrgInfo(handler_space_user);\r\n\t\t\t}\r\n\t\t\tins_obj._id = db.instances._makeNewID();\r\n\t\t\tins_obj.space = space_id;\r\n\t\t\tins_obj.flow = flow_id;\r\n\t\t\tins_obj.flow_version = flow.current._id;\r\n\t\t\tins_obj.form = flow.form;\r\n\t\t\tins_obj.form_version = flow.current.form_version;\r\n\t\t\tins_obj.name = instance_name;\r\n\t\t\tins_obj.submitter = handler_id;\r\n\t\t\tins_obj.submitter_name = handler_info.name;\r\n\t\t\tins_obj.applicant = user_id;\r\n\t\t\tins_obj.applicant_name = user_info.name;\r\n\t\t\tins_obj.applicant_organization = space_user.organization;\r\n\t\t\tins_obj.applicant_organization_name = space_user_org_info.name;\r\n\t\t\tins_obj.applicant_organization_fullname = space_user_org_info.fullname;\r\n\t\t\tins_obj.state = \"draft\";\r\n\t\t\tins_obj.code = \"\";\r\n\t\t\tins_obj.is_archived = false;\r\n\t\t\tins_obj.is_deleted = false;\r\n\t\t\tins_obj.created = now;\r\n\t\t\tins_obj.created_by = current_user_id;\r\n\t\t\tins_obj.modified = now;\r\n\t\t\tins_obj.modified_by = current_user_id;\r\n\t\t\tins_obj.inbox_users = [handler_id];\r\n\t\t\tins_obj.values = new_values;\r\n\t\t\tif (action_type == 'distribute') {\r\n\t\t\t\t// è§£å†³å¤šæ¬¡åˆ†å‘çœ‹ä¸åˆ°æ­£æ–‡ã€é™„ä»¶é—®é¢˜\r\n\t\t\t\tif (ins.distribute_from_instance) {\r\n\t\t\t\t\tins_obj.distribute_from_instance = ins.distribute_from_instance;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tins_obj.distribute_from_instance = instance_id;\r\n\t\t\t\t}\r\n\t\t\t\tins_obj.distribute_from_instances = _.clone(ins.distribute_from_instances) || [];\r\n\t\t\t\tins_obj.distribute_from_instances.push(instance_id);\r\n\r\n\t\t\t\tif (related) {\r\n\t\t\t\t\tins_obj.related_instances = [instance_id]\r\n\t\t\t\t}\r\n\r\n\t\t\t} else if (action_type == 'forward') {\r\n\t\t\t\tins_obj.forward_from_instance = instance_id\r\n\t\t\t}\r\n\r\n\t\t\t// æ–°å»ºTrace\r\n\t\t\tvar trace_obj = {};\r\n\t\t\ttrace_obj._id = new Mongo.ObjectID()._str;\r\n\t\t\ttrace_obj.instance = ins_obj._id;\r\n\t\t\ttrace_obj.is_finished = false;\r\n\r\n\t\t\t// å½“å‰æœ€æ–°ç‰ˆflowä¸­å¼€å§‹èŠ‚ç‚¹çš„step_id\r\n\t\t\tvar step_id, step_name, can_edit_main_attach, can_edit_normal_attach;\r\n\t\t\tflow.current.steps.forEach(function (step) {\r\n\t\t\t\tif (step.step_type == \"start\") {\r\n\t\t\t\t\tstep_id = step._id;\r\n\t\t\t\t\tstep_name = step.name;\r\n\t\t\t\t\tcan_edit_main_attach = step.can_edit_main_attach;\r\n\t\t\t\t\tcan_edit_normal_attach = step.can_edit_normal_attach;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\ttrace_obj.step = step_id;\r\n\t\t\ttrace_obj.start_date = now;\r\n\t\t\ttrace_obj.name = step_name;\r\n\r\n\t\t\t// æ–°å»ºApprove\r\n\t\t\tvar appr_obj = {};\r\n\t\t\tappr_obj._id = new Mongo.ObjectID()._str;\r\n\t\t\tappr_obj.instance = ins_obj._id;\r\n\t\t\tappr_obj.trace = trace_obj._id;\r\n\t\t\tappr_obj.is_finished = false;\r\n\t\t\tappr_obj.user = user_id;\r\n\t\t\tappr_obj.user_name = user_info.name;\r\n\t\t\tappr_obj.handler = handler_id;\r\n\t\t\tappr_obj.handler_name = handler_info.name;\r\n\t\t\tappr_obj.handler_organization = handler_space_user.organization;\r\n\t\t\tappr_obj.handler_organization_name = handler_org_info.name;\r\n\t\t\tappr_obj.handler_organization_fullname = handler_org_info.fullname;\r\n\t\t\tappr_obj.type = \"draft\";\r\n\t\t\tappr_obj.start_date = now;\r\n\t\t\tappr_obj.read_date = now;\r\n\t\t\tappr_obj.is_read = false;\r\n\t\t\tappr_obj.is_error = false;\r\n\r\n\t\t\tappr_obj.values = new_values;\r\n\r\n\t\t\tif (agent) {\r\n\t\t\t\tappr_obj.agent = agent;\r\n\t\t\t}\r\n\r\n\t\t\ttrace_obj.approves = [appr_obj];\r\n\t\t\tins_obj.traces = [trace_obj];\r\n\r\n\t\t\tif (flow.auto_remind == true)\r\n\t\t\t\tins_obj.auto_remind = true;\r\n\r\n\t\t\tins_obj.current_step_name = start_step.name;\r\n\r\n\t\t\tins_obj.flow_name = flow.name;\r\n\t\t\tif (category_name) {\r\n\t\t\t\tins_obj.category_name = category.name;\r\n\t\t\t\tins_obj.category = category._id;\r\n\t\t\t}\r\n\r\n\t\t\tnew_ins_id = db.instances.insert(ins_obj);\r\n\r\n\t\t\t// å¤åˆ¶é™„ä»¶\r\n\t\t\tvar collection = cfs.instances;\r\n\r\n\t\t\t//å°†åŽŸè¡¨å•å†…å®¹å­˜å‚¨ä¸ºç¬¬ä¸€ä¸ªé™„ä»¶\r\n\t\t\tif (hasSaveInstanceToAttachment) {\r\n\t\t\t\t// try {\r\n\r\n\t\t\t\tinstanceHtml = InstanceReadOnlyTemplate.getInstanceHtml(user_info, space_id, ins, {\r\n\t\t\t\t\tabsolute: true,\r\n\t\t\t\t\tshowTrace: true\r\n\t\t\t\t})\r\n\t\t\t\tvar instanceFile = new FS.File();\r\n\t\t\t\tinstanceFile.attachData(Buffer.from(instanceHtml, \"utf-8\"), {\r\n\t\t\t\t\ttype: \"text/html\"\r\n\t\t\t\t}, function (error) {\r\n\t\t\t\t\tif (error) {\r\n\t\t\t\t\t\tthrow new Meteor.Error(error.error, error.reason);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tinstanceFile.name(ins.name + \".html\");\r\n\t\t\t\t\tinstanceFile.size(instanceHtml.length);\r\n\r\n\t\t\t\t\tvar metadata = {\r\n\t\t\t\t\t\towner: user_id,\r\n\t\t\t\t\t\towner_name: user_info.name,\r\n\t\t\t\t\t\tspace: space_id,\r\n\t\t\t\t\t\tinstance: new_ins_id,\r\n\t\t\t\t\t\tapprove: appr_obj._id,\r\n\t\t\t\t\t\tcurrent: true\r\n\t\t\t\t\t};\r\n\t\t\t\t\tinstanceFile.metadata = metadata;\r\n\t\t\t\t\tvar fileObj = collection.insert(instanceFile);\r\n\t\t\t\t\tfileObj.update({\r\n\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\t'metadata.parent': fileObj._id\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\r\n\t\t\t\t// } catch (e) {\r\n\t\t\t\t//     console.error(e);\r\n\t\t\t\t// }\r\n\t\t\t}\r\n\r\n\t\t\tif (isForwardAttachments && action_type == 'forward') {\r\n\t\t\t\tvar files = collection.find({\r\n\t\t\t\t\t'metadata.instance': instance_id,\r\n\t\t\t\t\t'metadata.current': true\r\n\t\t\t\t});\r\n\t\t\t\tfiles.forEach(function (f) {\r\n\t\t\t\t\t// åˆ¤æ–­æ–°çš„æµç¨‹å¼€å§‹èŠ‚ç‚¹æ˜¯å¦æœ‰ç¼–è¾‘æ­£æ–‡å’Œç¼–è¾‘é™„ä»¶æƒé™\r\n\t\t\t\t\tif (f.metadata.main == true) {\r\n\t\t\t\t\t\tif (can_edit_main_attach != true && can_edit_normal_attach != true)\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (can_edit_normal_attach != true)\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar newFile = new FS.File();\r\n\t\t\t\t\tnewFile.attachData(f.createReadStream('instances'), {\r\n\t\t\t\t\t\ttype: f.original.type\r\n\t\t\t\t\t}, function (err) {\r\n\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnewFile.name(f.name());\r\n\t\t\t\t\t\tnewFile.size(f.size());\r\n\t\t\t\t\t\tvar metadata = {\r\n\t\t\t\t\t\t\towner: user_id,\r\n\t\t\t\t\t\t\towner_name: user_info.name,\r\n\t\t\t\t\t\t\tspace: space_id,\r\n\t\t\t\t\t\t\tinstance: new_ins_id,\r\n\t\t\t\t\t\t\tapprove: appr_obj._id,\r\n\t\t\t\t\t\t\tcurrent: true\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tif (f.metadata.main == true && can_edit_main_attach == true) {\r\n\t\t\t\t\t\t\tmetadata.main = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnewFile.metadata = metadata;\r\n\t\t\t\t\t\tvar fileObj = collection.insert(newFile);\r\n\t\t\t\t\t\tfileObj.update({\r\n\t\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\t\t'metadata.parent': fileObj._id\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t})\r\n\t\t\t}\r\n\r\n\t\t\tif (action_type === 'distribute') {\r\n\t\t\t\t// ç»™å½“å‰çš„ç”³è¯·å•å¢žåŠ åˆ†å‘è®°å½•\r\n\t\t\t\tvar appr = {\r\n\t\t\t\t\t'_id': new Mongo.ObjectID()._str,\r\n\t\t\t\t\t'instance': instance_id,\r\n\t\t\t\t\t'trace': current_trace_id,\r\n\t\t\t\t\t'is_finished': true,\r\n\t\t\t\t\t'user': user_id,\r\n\t\t\t\t\t'user_name': user_info.name,\r\n\t\t\t\t\t'handler': user_id,\r\n\t\t\t\t\t'handler_name': user_info.name,\r\n\t\t\t\t\t'handler_organization': space_user.organization,\r\n\t\t\t\t\t'handler_organization_name': space_user_org_info.name,\r\n\t\t\t\t\t'handler_organization_fullname': space_user_org_info.fullname,\r\n\t\t\t\t\t'type': action_type,\r\n\t\t\t\t\t'start_date': new Date(),\r\n\t\t\t\t\t'finish_date': new Date(),\r\n\t\t\t\t\t'is_read': false,\r\n\t\t\t\t\t'judge': 'submitted',\r\n\t\t\t\t\t'from_user': current_user_id,\r\n\t\t\t\t\t'from_user_name': from_user_name,\r\n\t\t\t\t\t'forward_space': space_id,\r\n\t\t\t\t\t'forward_instance': new_ins_id,\r\n\t\t\t\t\t'description': description,\r\n\t\t\t\t\t'from_approve_id': from_approve_id\r\n\t\t\t\t};\r\n\r\n\t\t\t\tforward_approves.push(appr);\r\n\t\t\t}\r\n\r\n\t\t\tnew_ins_ids.push(new_ins_id);\r\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id);\r\n\t\t})\r\n\r\n\t\tif (!_.isEmpty(forward_approves)) {\r\n\t\t\tset_obj.modified = new Date();\r\n\t\t\tset_obj.modified_by = current_user_id;\r\n\t\t\tvar r = db.instances.update({\r\n\t\t\t\t_id: instance_id,\r\n\t\t\t\t\"traces._id\": current_trace_id\r\n\t\t\t}, {\r\n\t\t\t\t$set: set_obj,\r\n\t\t\t\t$addToSet: {\r\n\t\t\t\t\t'traces.$.approves': {\r\n\t\t\t\t\t\t$each: forward_approves\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\r\n\t\tif (r) {\r\n\t\t\t_.each(current_trace.approves, function (a, idx) {\r\n\t\t\t\tif (a._id == from_approve_id) {\r\n\t\t\t\t\tvar update_read = {};\r\n\t\t\t\t\tupdate_read[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\r\n\t\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t\t_id: instance_id,\r\n\t\t\t\t\t\t\"traces._id\": current_trace_id\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t$set: update_read\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t}\r\n\r\n\t\tJsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: { new_ins_ids: new_ins_ids }\r\n\t\t})\r\n\t} catch (e) {\r\n\t\tconsole.error(e.stack)\r\n\t\tJsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\terrors: [e]\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n})","JsonRoutes.add 'get', '/api/workflow/instance/:instanceId', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req, res)\r\n\t\tcurrent_user_id = current_user_info._id\r\n\t\treq_async = _.has(req.query, 'async');\r\n\t\tinsId = req.params.instanceId\r\n\r\n\t\tins = db.instances.findOne(insId, { fields: { space: 1, flow: 1, state: 1, inbox_users: 1, cc_users: 1, outbox_users: 1, submitter: 1, applicant: 1 } })\r\n\r\n\t\tif not ins\r\n\t\t\tthrow new Meteor.Error('error', 'instanceId is wrong or instance not exists.')\r\n\r\n\t\tspaceId = ins.space\r\n\t\tflowId = ins.flow\r\n\r\n\t\tif db.space_users.find({ space: spaceId, user: current_user_id }).count() is 0\r\n\t\t\tthrow new Meteor.Error('error', 'user is not belong to this space.')\r\n\r\n\t\tbox = ''\r\n\r\n\t\tif (ins.inbox_users?.includes current_user_id) or (ins.cc_users?.includes current_user_id)\r\n\t\t\tbox = 'inbox'\r\n\t\telse if ins.outbox_users?.includes current_user_id\r\n\t\t\tbox = 'outbox'\r\n\t\telse if ins.state is 'draft' and ins.submitter is current_user_id\r\n\t\t\tbox = 'draft'\r\n\t\telse if ins.state is 'pending' and (ins.submitter is current_user_id or ins.applicant is current_user_id)\r\n\t\t\tbox = 'pending'\r\n\t\telse if ins.state is 'completed' and ins.submitter is current_user_id\r\n\t\t\tbox = 'completed'\r\n\t\telse\r\n\t\t\t# éªŒè¯login user_idå¯¹è¯¥æµç¨‹æœ‰ç®¡ç†ç”³è¯·å•çš„æƒé™\r\n\t\t\tpermissions = permissionManager.getFlowPermissions(flowId, current_user_id)\r\n\t\t\tspace = db.spaces.findOne(spaceId, { fields: { admins: 1 } })\r\n\t\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user_id))\r\n\t\t\t\tthrow new Meteor.Error('error', \"no permission.\")\r\n\t\t\tbox = 'monitor'\r\n\r\n\t\tredirectTo = \"workflow/space/#{spaceId}/#{box}/#{insId}\"\r\n\t\tredirectToUrl = Meteor.absoluteUrl(redirectTo)\r\n\t\tif req_async # || req.get(\"X-Requested-With\") === 'XMLHttpRequest'\r\n\t\t\treturn res.status(200).send({\r\n\t\t\t\t\"status\": 302,\r\n\t\t\t\t\"redirect\": redirectTo\r\n\t\t\t});\r\n\t\telse\r\n\t\t\tres.setHeader \"Location\", redirectToUrl\r\n\t\t\tres.writeHead 302\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\r\n","JsonRoutes.add('get', '/api/workflow/instance/:instanceId', function(req, res, next) {\n  var box, current_user_id, current_user_info, e, flowId, ins, insId, permissions, redirectTo, redirectToUrl, ref, ref1, ref2, req_async, space, spaceId;\n  try {\n    current_user_info = uuflowManager.check_authorization(req, res);\n    current_user_id = current_user_info._id;\n    req_async = _.has(req.query, 'async');\n    insId = req.params.instanceId;\n    ins = db.instances.findOne(insId, {\n      fields: {\n        space: 1,\n        flow: 1,\n        state: 1,\n        inbox_users: 1,\n        cc_users: 1,\n        outbox_users: 1,\n        submitter: 1,\n        applicant: 1\n      }\n    });\n    if (!ins) {\n      throw new Meteor.Error('error', 'instanceId is wrong or instance not exists.');\n    }\n    spaceId = ins.space;\n    flowId = ins.flow;\n    if (db.space_users.find({\n      space: spaceId,\n      user: current_user_id\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'user is not belong to this space.');\n    }\n    box = '';\n    if (((ref = ins.inbox_users) != null ? ref.includes(current_user_id) : void 0) || ((ref1 = ins.cc_users) != null ? ref1.includes(current_user_id) : void 0)) {\n      box = 'inbox';\n    } else if ((ref2 = ins.outbox_users) != null ? ref2.includes(current_user_id) : void 0) {\n      box = 'outbox';\n    } else if (ins.state === 'draft' && ins.submitter === current_user_id) {\n      box = 'draft';\n    } else if (ins.state === 'pending' && (ins.submitter === current_user_id || ins.applicant === current_user_id)) {\n      box = 'pending';\n    } else if (ins.state === 'completed' && ins.submitter === current_user_id) {\n      box = 'completed';\n    } else {\n      permissions = permissionManager.getFlowPermissions(flowId, current_user_id);\n      space = db.spaces.findOne(spaceId, {\n        fields: {\n          admins: 1\n        }\n      });\n      if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user_id))) {\n        throw new Meteor.Error('error', \"no permission.\");\n      }\n      box = 'monitor';\n    }\n    redirectTo = \"workflow/space/\" + spaceId + \"/\" + box + \"/\" + insId;\n    redirectToUrl = Meteor.absoluteUrl(redirectTo);\n    if (req_async) {\n      return res.status(200).send({\n        \"status\": 302,\n        \"redirect\": redirectTo\n      });\n    } else {\n      res.setHeader(\"Location\", redirectToUrl);\n      res.writeHead(302);\n      res.end();\n    }\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\r\n@api {get} /api/workflow/open/pending èŽ·å–å¾…åŠžæ–‡ä»¶\r\n\r\n@apiDescription èŽ·å–å½“å‰ç”¨æˆ·çš„å¾…åŠžäº‹é¡¹åˆ—è¡¨\r\n\r\n@apiName getInbox\r\n\r\n@apiGroup Workflow\r\n\r\n@apiParam {String} access_token User API Token\r\n\r\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\r\n\r\n@apiHeaderExample {json} Header-Example:\r\n\t{\r\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\r\n\t}\r\n\r\n@apiSuccessExample {json} Success-Response:\r\n\t{\r\n\t\t\"status\": \"success\",\r\n\t\t\"data\": [\r\n\t\t\t{\r\n\t\t\t\t\"id\": \"g7wokXNkR9yxHvA4D\",\r\n\t\t\t\t\"start_date\": \"2017-11-23T02:28:53.164Z\",\r\n\t\t\t\t\"flow_name\": \"æ­£æ–‡æµç¨‹\",\r\n\t\t\t\t\"space_name\": \"å®¡æ‰¹çŽ‹\",\r\n\t\t\t\t\"name\": \"æ­£æ–‡æµç¨‹ 1\",\r\n\t\t\t\t\"applicant_name\": null,\r\n\t\t\t\t\"applicant_organization_name\": \"å®¡æ‰¹çŽ‹\",\r\n\t\t\t\t\"submit_date\": \"2017-07-25T06:36:48.492Z\",\r\n\t\t\t\t\"step_name\": \"å¼€å§‹\",\r\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\r\n\t\t\t\t\"modified\": \"2017-11-23T02:28:53.164Z\",\r\n\t\t\t\t\"is_read\": false,\r\n\t\t\t\t\"values\": {}\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"id\": \"WqKSrWQoywgJaMp9k\",\r\n\t\t\t\t\"start_date\": \"2017-08-17T07:38:35.420Z\",\r\n\t\t\t\t\"flow_name\": \"æ­£æ–‡\\n\",\r\n\t\t\t\t\"space_name\": \"å®¡æ‰¹çŽ‹\",\r\n\t\t\t\t\"name\": \"æ­£æ–‡\\n 1\",\r\n\t\t\t\t\"applicant_name\": \"æ®·äº®è¾‰\",\r\n\t\t\t\t\"applicant_organization_name\": \"å®¡æ‰¹çŽ‹\",\r\n\t\t\t\t\"submit_date\": \"2017-06-27T10:26:19.468Z\",\r\n\t\t\t\t\"step_name\": \"å¼€å§‹\",\r\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\r\n\t\t\t\t\"modified\": \"2017-08-17T07:38:35.421Z\",\r\n\t\t\t\t\"is_read\": true,\r\n\t\t\t\t\"values\": {}\r\n\t\t\t}\r\n\t\t]\r\n\t}\r\n###\r\nJsonRoutes.add 'get', '/api/workflow/open/pending', (req, res, next) ->\r\n\ttry\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn\r\n\r\n\t\tspace_id = req.headers['x-space-id'] || req.query?.spaceId\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need space_id')\r\n\r\n\t\tuser_id = req.userId\r\n\r\n\t\tif !user_id\r\n\t\t\tthrow new Meteor.Error('error', 'Not logged in')\r\n\r\n\t\tif db.users.find({ _id: user_id }).count() is 0\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\tlimit = req.query?.limit || 500\r\n\r\n\t\tlimit = parseInt(limit)\r\n\r\n\t\tusername = req.query?.username\r\n\r\n\t\tuserid = req.query?.userid\r\n\r\n\t\tattach = req.query?.attach\r\n\r\n\t\tworkflow_categories = req.query?.workflow_categories\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tspace = uuflowManager.getSpace(space_id)\r\n\r\n\t\t# å¦‚æžœå½“å‰ç”¨æˆ·æ˜¯å·¥ä½œåŒºç®¡ç†å‘˜ï¼Œåˆ™é€šè¿‡æŸ¥çœ‹urlä¸Šæ˜¯å¦æœ‰username\\userid ï¼Œ\r\n\t\t# å¦‚æžœæœ‰ï¼Œåˆ™è¿”å›žusername\\useridå¯¹åº”çš„ç”¨æˆ·ï¼Œå¦åˆ™è¿”å›žå½“å‰ç”¨æˆ·å¾…åŠžã€‚\r\n\t\t# username\\useridéƒ½å­˜åœ¨æ—¶ï¼Œuseridä¼˜å…ˆ\r\n\t\tspecial_user_id\r\n\t\tif space.admins.includes(user_id)\r\n\t\t\tif userid\r\n\t\t\t\tif db.users.find({ _id: userid }).count() < 1\r\n\t\t\t\t\tthrow new Meteor.Error('error', \"can not find user by userid: #{userid}\")\r\n\r\n\t\t\t\tspecial_user_id = userid\r\n\t\t\telse if username\r\n\t\t\t\tu = db.users.findOne({ username: username }, { fields: { _id: 1 } })\r\n\t\t\t\tif _.isEmpty(u)\r\n\t\t\t\t\tthrow new Meteor.Error('error', \"can not find user by username: #{username}\")\r\n\r\n\t\t\t\tspecial_user_id = u._id\r\n\r\n\t\tresult_instances = new Array\r\n\r\n\t\tis_read = false\r\n\t\tstart_date = ''\r\n\t\tuid = user_id\r\n\t\tquery = {\r\n\t\t\t$or: [{ inbox_users: user_id }, { cc_users: user_id }]\r\n\t\t}\r\n\r\n\t\tif special_user_id\r\n\t\t\tuid = special_user_id\r\n\t\t\tquery = {\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\t$or: [{ inbox_users: special_user_id }, { cc_users: special_user_id }]\r\n\t\t\t}\r\n\r\n\t\tif workflow_categories\r\n\t\t\tquery.category = { $in: workflow_categories.split(',') }\r\n\r\n\t\tspace_names = {}\r\n\t\tspace_names[space._id] = space.name\r\n\r\n\t\tif limit > 0\r\n\t\t\tdb.instances.find(query, { sort: { modified: -1 }, limit: limit }).forEach (i) ->\r\n\r\n\t\t\t\tif i.inbox_users?.includes(uid)\r\n\t\t\t\t\t_.each i.traces, (t) ->\r\n\t\t\t\t\t\tif t.is_finished is false\r\n\t\t\t\t\t\t\t_.each t.approves, (a) ->\r\n\t\t\t\t\t\t\t\tif a.user is uid and a.type isnt 'cc' and not a.is_finished\r\n\t\t\t\t\t\t\t\t\tis_read = a.is_read\r\n\t\t\t\t\t\t\t\t\tstart_date = a.start_date\r\n\t\t\t\telse\r\n\t\t\t\t\t_.each i.traces, (t) ->\r\n\t\t\t\t\t\tif not start_date and t.approves\r\n\t\t\t\t\t\t\t_.each t.approves, (a) ->\r\n\t\t\t\t\t\t\t\tif not start_date and a.user is uid and a.type is 'cc' and not a.is_finished\r\n\t\t\t\t\t\t\t\t\tis_read = a.is_read\r\n\t\t\t\t\t\t\t\t\tstart_date = a.start_date\r\n\r\n\t\t\t\tif not space_names[i.space]\r\n\t\t\t\t\tspace_names[i.space] = db.spaces.findOne(i.space, { fields: { name: 1 } })?.name\r\n\r\n\t\t\t\th = new Object\r\n\t\t\t\th[\"id\"] = i[\"_id\"]\r\n\t\t\t\th[\"start_date\"] = start_date\r\n\t\t\t\th[\"flow_name\"] = i.flow_name\r\n\t\t\t\th[\"space_name\"] = space_names[i.space]\r\n\t\t\t\th[\"name\"] = i[\"name\"]\r\n\t\t\t\th[\"applicant_name\"] = i[\"applicant_name\"]\r\n\t\t\t\th[\"applicant_organization_name\"] = i[\"applicant_organization_name\"]\r\n\t\t\t\th[\"submit_date\"] = i[\"submit_date\"]\r\n\t\t\t\th[\"step_name\"] = i.current_step_name\r\n\t\t\t\th[\"space_id\"] = i.space\r\n\t\t\t\th[\"modified\"] = i[\"modified\"]\r\n\t\t\t\th[\"is_read\"] = is_read\r\n\t\t\t\th[\"values\"] = i[\"values\"]\r\n\r\n\t\t\t\tif attach is 'true'\r\n\t\t\t\t\th.attachments = cfs.instances.find({ 'metadata.instance': i._id, 'metadata.current': true, \"metadata.is_private\": { $ne: true } }, { fields: { copies: 0 } }).fetch()\r\n\r\n\t\t\t\tresult_instances.push(h)\r\n\r\n\t\tno_limit_count = db.instances.find(query).count()\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: result_instances, count: no_limit_count }\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.reason }] }\r\n\t\t}\r\n\r\n","\n/*\n@api {get} /api/workflow/open/pending èŽ·å–å¾…åŠžæ–‡ä»¶\n\n@apiDescription èŽ·å–å½“å‰ç”¨æˆ·çš„å¾…åŠžäº‹é¡¹åˆ—è¡¨\n\n@apiName getInbox\n\n@apiGroup Workflow\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\n\n@apiHeaderExample {json} Header-Example:\n\t{\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n\t{\n\t\t\"status\": \"success\",\n\t\t\"data\": [\n\t\t\t{\n\t\t\t\t\"id\": \"g7wokXNkR9yxHvA4D\",\n\t\t\t\t\"start_date\": \"2017-11-23T02:28:53.164Z\",\n\t\t\t\t\"flow_name\": \"æ­£æ–‡æµç¨‹\",\n\t\t\t\t\"space_name\": \"å®¡æ‰¹çŽ‹\",\n\t\t\t\t\"name\": \"æ­£æ–‡æµç¨‹ 1\",\n\t\t\t\t\"applicant_name\": null,\n\t\t\t\t\"applicant_organization_name\": \"å®¡æ‰¹çŽ‹\",\n\t\t\t\t\"submit_date\": \"2017-07-25T06:36:48.492Z\",\n\t\t\t\t\"step_name\": \"å¼€å§‹\",\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\n\t\t\t\t\"modified\": \"2017-11-23T02:28:53.164Z\",\n\t\t\t\t\"is_read\": false,\n\t\t\t\t\"values\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"id\": \"WqKSrWQoywgJaMp9k\",\n\t\t\t\t\"start_date\": \"2017-08-17T07:38:35.420Z\",\n\t\t\t\t\"flow_name\": \"æ­£æ–‡\\n\",\n\t\t\t\t\"space_name\": \"å®¡æ‰¹çŽ‹\",\n\t\t\t\t\"name\": \"æ­£æ–‡\\n 1\",\n\t\t\t\t\"applicant_name\": \"æ®·äº®è¾‰\",\n\t\t\t\t\"applicant_organization_name\": \"å®¡æ‰¹çŽ‹\",\n\t\t\t\t\"submit_date\": \"2017-06-27T10:26:19.468Z\",\n\t\t\t\t\"step_name\": \"å¼€å§‹\",\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\n\t\t\t\t\"modified\": \"2017-08-17T07:38:35.421Z\",\n\t\t\t\t\"is_read\": true,\n\t\t\t\t\"values\": {}\n\t\t\t}\n\t\t]\n\t}\n */\nJsonRoutes.add('get', '/api/workflow/open/pending', function(req, res, next) {\n  var attach, e, is_read, limit, no_limit_count, query, ref, ref1, ref2, ref3, ref4, ref5, result_instances, space, space_id, space_names, special_user_id, start_date, u, uid, user_id, userid, username, workflow_categories;\n  try {\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    space_id = req.headers['x-space-id'] || ((ref = req.query) != null ? ref.spaceId : void 0);\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need space_id');\n    }\n    user_id = req.userId;\n    if (!user_id) {\n      throw new Meteor.Error('error', 'Not logged in');\n    }\n    if (db.users.find({\n      _id: user_id\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    limit = ((ref1 = req.query) != null ? ref1.limit : void 0) || 500;\n    limit = parseInt(limit);\n    username = (ref2 = req.query) != null ? ref2.username : void 0;\n    userid = (ref3 = req.query) != null ? ref3.userid : void 0;\n    attach = (ref4 = req.query) != null ? ref4.attach : void 0;\n    workflow_categories = (ref5 = req.query) != null ? ref5.workflow_categories : void 0;\n    space = uuflowManager.getSpace(space_id);\n    special_user_id;\n    if (space.admins.includes(user_id)) {\n      if (userid) {\n        if (db.users.find({\n          _id: userid\n        }).count() < 1) {\n          throw new Meteor.Error('error', \"can not find user by userid: \" + userid);\n        }\n        special_user_id = userid;\n      } else if (username) {\n        u = db.users.findOne({\n          username: username\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        if (_.isEmpty(u)) {\n          throw new Meteor.Error('error', \"can not find user by username: \" + username);\n        }\n        special_user_id = u._id;\n      }\n    }\n    result_instances = new Array;\n    is_read = false;\n    start_date = '';\n    uid = user_id;\n    query = {\n      $or: [\n        {\n          inbox_users: user_id\n        }, {\n          cc_users: user_id\n        }\n      ]\n    };\n    if (special_user_id) {\n      uid = special_user_id;\n      query = {\n        space: space_id,\n        $or: [\n          {\n            inbox_users: special_user_id\n          }, {\n            cc_users: special_user_id\n          }\n        ]\n      };\n    }\n    if (workflow_categories) {\n      query.category = {\n        $in: workflow_categories.split(',')\n      };\n    }\n    space_names = {};\n    space_names[space._id] = space.name;\n    if (limit > 0) {\n      db.instances.find(query, {\n        sort: {\n          modified: -1\n        },\n        limit: limit\n      }).forEach(function(i) {\n        var h, ref6, ref7;\n        if ((ref6 = i.inbox_users) != null ? ref6.includes(uid) : void 0) {\n          _.each(i.traces, function(t) {\n            if (t.is_finished === false) {\n              return _.each(t.approves, function(a) {\n                if (a.user === uid && a.type !== 'cc' && !a.is_finished) {\n                  is_read = a.is_read;\n                  return start_date = a.start_date;\n                }\n              });\n            }\n          });\n        } else {\n          _.each(i.traces, function(t) {\n            if (!start_date && t.approves) {\n              return _.each(t.approves, function(a) {\n                if (!start_date && a.user === uid && a.type === 'cc' && !a.is_finished) {\n                  is_read = a.is_read;\n                  return start_date = a.start_date;\n                }\n              });\n            }\n          });\n        }\n        if (!space_names[i.space]) {\n          space_names[i.space] = (ref7 = db.spaces.findOne(i.space, {\n            fields: {\n              name: 1\n            }\n          })) != null ? ref7.name : void 0;\n        }\n        h = new Object;\n        h[\"id\"] = i[\"_id\"];\n        h[\"start_date\"] = start_date;\n        h[\"flow_name\"] = i.flow_name;\n        h[\"space_name\"] = space_names[i.space];\n        h[\"name\"] = i[\"name\"];\n        h[\"applicant_name\"] = i[\"applicant_name\"];\n        h[\"applicant_organization_name\"] = i[\"applicant_organization_name\"];\n        h[\"submit_date\"] = i[\"submit_date\"];\n        h[\"step_name\"] = i.current_step_name;\n        h[\"space_id\"] = i.space;\n        h[\"modified\"] = i[\"modified\"];\n        h[\"is_read\"] = is_read;\n        h[\"values\"] = i[\"values\"];\n        if (attach === 'true') {\n          h.attachments = cfs.instances.find({\n            'metadata.instance': i._id,\n            'metadata.current': true,\n            \"metadata.is_private\": {\n              $ne: true\n            }\n          }, {\n            fields: {\n              copies: 0\n            }\n          }).fetch();\n        }\n        return result_instances.push(h);\n      });\n    }\n    no_limit_count = db.instances.find(query).count();\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result_instances,\n        count: no_limit_count\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.reason\n          }\n        ]\n      }\n    });\n  }\n});\n","Cookies = require(\"cookies\")\r\n\r\nMeteor.startup ->\r\n\tWebApp.connectHandlers.use \"/api/workflow/export/talbe_template\", (req, res, next)->\r\n\t\tcookies = new Cookies( req, res );\r\n\t\t# first check request body\r\n\t\tif req.body\r\n\t\t\tuserId = req.body[\"X-User-Id\"]\r\n\t\t\tauthToken = req.body[\"X-Auth-Token\"]\r\n\r\n\t\t# then check cookie\r\n\t\tif !userId or !authToken\r\n\t\t\tuserId = cookies.get(\"X-User-Id\")\r\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\t\tif !(userId and authToken)\r\n\t\t\tres.writeHead(401);\r\n\t\t\tres.end JSON.stringify({\r\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token\",\r\n\t\t\t\t\"success\": false\r\n\t\t\t})\r\n\t\t\treturn ;\r\n\r\n\t\tflowId = req.query?.flow;\r\n\r\n\t\tflow = db.flows.findOne({_id: flowId}, {fields: {space: 1, form: 1, name: 1}})\r\n\r\n\t\tform = db.forms.findOne({_id: flow.form}, {fields: {space: 1, \"current._id\": 1}})\r\n\r\n\t\tif _.isEmpty(flow)\r\n\t\t\tres.writeHead(401);\r\n\t\t\tres.end JSON.stringify({\r\n\t\t\t\t\"error\": \"Validate Request -- Invalid formId\",\r\n\t\t\t\t\"success\": false\r\n\t\t\t})\r\n\t\t\treturn ;\r\n\t\telse\r\n\t\t\tif !Steedos.isSpaceAdmin(flow.space, userId)\r\n\t\t\t\tres.writeHead(401);\r\n\t\t\t\tres.end JSON.stringify({\r\n\t\t\t\t\t\"error\": \"Validate Request -- No permission\",\r\n\t\t\t\t\t\"success\": false\r\n\t\t\t\t})\r\n\t\t\t\treturn;\r\n\r\n\t\t\tspace = db.spaces.findOne(flow.space, { fields: { is_paid: 1 } })\r\n\t\t\tif !space?.is_paid\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 404,\r\n\t\t\t\t\tdata:\r\n\t\t\t\t\t\t\"error\": \"Validate Request -- Non-paid space.\",\r\n\t\t\t\t\t\t\"success\": false\r\n\t\t\t\treturn;\r\n\r\n\t\tdata = TemplateManager.handleTableTemplate({form: flow.form, form_version: form?.current?._id}, true);\r\n\r\n\t\tfileName = flow.name\r\n\r\n\t\tres.setHeader('Content-type', 'application/x-msdownload');\r\n\t\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(fileName)+'.html');\r\n\t\tres.end(data)","var Cookies;\n\nCookies = require(\"cookies\");\n\nMeteor.startup(function() {\n  return WebApp.connectHandlers.use(\"/api/workflow/export/talbe_template\", function(req, res, next) {\n    var authToken, cookies, data, fileName, flow, flowId, form, ref, ref1, space, userId;\n    cookies = new Cookies(req, res);\n    if (req.body) {\n      userId = req.body[\"X-User-Id\"];\n      authToken = req.body[\"X-Auth-Token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!(userId && authToken)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Missing X-Auth-Token\",\n        \"success\": false\n      }));\n      return;\n    }\n    flowId = (ref = req.query) != null ? ref.flow : void 0;\n    flow = db.flows.findOne({\n      _id: flowId\n    }, {\n      fields: {\n        space: 1,\n        form: 1,\n        name: 1\n      }\n    });\n    form = db.forms.findOne({\n      _id: flow.form\n    }, {\n      fields: {\n        space: 1,\n        \"current._id\": 1\n      }\n    });\n    if (_.isEmpty(flow)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Invalid formId\",\n        \"success\": false\n      }));\n      return;\n    } else {\n      if (!Steedos.isSpaceAdmin(flow.space, userId)) {\n        res.writeHead(401);\n        res.end(JSON.stringify({\n          \"error\": \"Validate Request -- No permission\",\n          \"success\": false\n        }));\n        return;\n      }\n      space = db.spaces.findOne(flow.space, {\n        fields: {\n          is_paid: 1\n        }\n      });\n      if (!(space != null ? space.is_paid : void 0)) {\n        JsonRoutes.sendResult(res, {\n          code: 404,\n          data: {\n            \"error\": \"Validate Request -- Non-paid space.\",\n            \"success\": false\n          }\n        });\n        return;\n      }\n    }\n    data = TemplateManager.handleTableTemplate({\n      form: flow.form,\n      form_version: form != null ? (ref1 = form.current) != null ? ref1._id : void 0 : void 0\n    }, true);\n    fileName = flow.name;\n    res.setHeader('Content-type', 'application/x-msdownload');\n    res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(fileName) + '.html');\n    return res.end(data);\n  });\n});\n","###\r\n@api {post} /api/workflow/open/drafts æ–°å»ºç”³è¯·å•\r\n\r\n@apiName createInstance\r\n\r\n@apiGroup Workflow\r\n\r\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\r\n\r\n@apiParam {String} access_token User API Token\r\n\r\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\r\n\r\n@apiHeaderExample {json} Header-Example:\r\n{\r\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\r\n}\r\n\r\n@apiParamExample {json} Request Payload:\r\n{\r\n    \"flow\": æµç¨‹Id,\r\n    \"applicant\": ç”³è¯·äººId,\r\n    \"values\": {\r\n        \"fields1\" : å­—æ®µå€¼,\r\n        \"fields2\" : å­—æ®µå€¼,\r\n        ...\r\n    }\r\n}\r\n\r\n@apiSuccessExample {json} Success-Response:\r\n{\r\n    \"status\": \"success\",\r\n    \"data\": {instance}\r\n}\r\n\r\n@apiErrorExample {json} error-Response:\r\n{\r\n    \"status\": \"error\",\r\n    \"data\": {...}\r\n}\r\n###\r\nJsonRoutes.add 'post', '/api/workflow/open/drafts', (req, res, next) ->\r\n\ttry\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn\r\n\r\n\t\tuser_id = req.userId\r\n\r\n\t\tcurrent_user_info = db.users.findOne({ _id: user_id })\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header x_space_id')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user_info._id)\r\n\r\n\t\thashData = req.body\r\n\r\n\t\tif not hashData[\"flow\"]\r\n\t\t\tthrow new Meteor.Error('error', 'flow is null')\r\n\r\n\t\tflow_id      = hashData[\"flow\"]\r\n\t\tapplicant_id = hashData[\"applicant\"]\r\n\t\tapplicant_username = hashData[\"applicant_username\"]\r\n\r\n\t\tinstance_from_client = new Object\r\n\r\n\t\tflow = db.flows.findOne({ _id: flow_id }, { fields: { space: 1, 'current._id': 1 } })\r\n\t\tif not flow\r\n\t\t\tthrow new Meteor.Error('error', 'flow is not exists')\r\n\r\n\t\tif space_id isnt flow.space\r\n\t\t\tthrow new Meteor.Error('error', 'flow is not belong to this space')\r\n\r\n\t\tif db.space_users.find({ space: space_id, user: current_user_info._id }).count() is 0\r\n\t\t\tthrow new Meteor.Error('error', 'auth_token is not a member of this space')\r\n\r\n\t\tinstance_from_client[\"space\"] = space_id\r\n\t\tinstance_from_client[\"flow\"] = flow_id\r\n\t\tinstance_from_client[\"flow_version\"] = flow.current._id\r\n\r\n\t\tapplicant = null\r\n\t\tif applicant_id or applicant_username\r\n\r\n\t\t\tif applicant_id\r\n\t\t\t\tapplicant = db.users.findOne({ _id: applicant_id }, { fields: { name: 1 } })\r\n\t\t\t\tif not applicant\r\n\t\t\t\t\tthrow new Meteor.Error('error', 'applicant is wrong')\r\n\r\n\t\t\telse if applicant_username\r\n\t\t\t\tapplicant = db.users.findOne({ username: applicant_username }, { fields: { name: 1 } })\r\n\t\t\t\tif not applicant\r\n\t\t\t\t\tthrow new Meteor.Error('error', 'applicant_username is wrong')\r\n\r\n\t\t\tspace_user = db.space_users.findOne({ space: space_id, user: applicant._id })\r\n\t\t\tif not space_user\r\n\t\t\t\tthrow new Meteor.Error('error', 'applicant is not a member of this space')\r\n\r\n\t\t\tif space_user.user_accepted isnt true\r\n\t\t\t\tthrow new Meteor.Error('error', 'applicant is disabled in this space')\r\n\r\n\t\t\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t\t\tinstance_from_client[\"applicant\"] = applicant._id\r\n\t\t\tinstance_from_client[\"applicant_name\"] = applicant.name\r\n\t\t\tinstance_from_client[\"applicant_organization\"] =  space_user_org_info[\"organization\"]\r\n\t\t\tinstance_from_client[\"applicant_organization_fullname\"] = space_user_org_info[\"organization_fullname\"]\r\n\t\t\tinstance_from_client[\"applicant_organization_name\"] = space_user_org_info[\"organization_name\"]\r\n\r\n\t\tapplicantInfo = applicant || current_user_info\r\n\r\n\t\ttraces = []\r\n\t\ttrace = new Object\r\n\t\tapproves = []\r\n\t\tapprove = new Object\r\n\t\tapprove[\"values\"] = hashData[\"values\"]\r\n\t\tapproves.push(approve)\r\n\t\ttrace[\"approves\"] = approves\r\n\t\ttraces.push(trace)\r\n\t\tinstance_from_client[\"traces\"] = traces\r\n\r\n\t\tinstance_from_client[\"inbox_users\"] = [applicantInfo._id]\r\n\r\n\t\tnew_ins_id = uuflowManager.create_instance(instance_from_client, applicantInfo)\r\n\r\n\t\tnew_ins = db.instances.findOne(new_ins_id)\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: new_ins }\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\r\n\t\t}\r\n","\n/*\n@api {post} /api/workflow/open/drafts æ–°å»ºç”³è¯·å•\n\n@apiName createInstance\n\n@apiGroup Workflow\n\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiParamExample {json} Request Payload:\n{\n    \"flow\": æµç¨‹Id,\n    \"applicant\": ç”³è¯·äººId,\n    \"values\": {\n        \"fields1\" : å­—æ®µå€¼,\n        \"fields2\" : å­—æ®µå€¼,\n        ...\n    }\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n    \"status\": \"success\",\n    \"data\": {instance}\n}\n\n@apiErrorExample {json} error-Response:\n{\n    \"status\": \"error\",\n    \"data\": {...}\n}\n */\nJsonRoutes.add('post', '/api/workflow/open/drafts', function(req, res, next) {\n  var applicant, applicantInfo, applicant_id, applicant_username, approve, approves, current_user_info, e, flow, flow_id, hashData, instance_from_client, new_ins, new_ins_id, space_id, space_user, space_user_org_info, trace, traces, user_id;\n  try {\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    user_id = req.userId;\n    current_user_info = db.users.findOne({\n      _id: user_id\n    });\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header x_space_id');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user_info._id);\n    hashData = req.body;\n    if (!hashData[\"flow\"]) {\n      throw new Meteor.Error('error', 'flow is null');\n    }\n    flow_id = hashData[\"flow\"];\n    applicant_id = hashData[\"applicant\"];\n    applicant_username = hashData[\"applicant_username\"];\n    instance_from_client = new Object;\n    flow = db.flows.findOne({\n      _id: flow_id\n    }, {\n      fields: {\n        space: 1,\n        'current._id': 1\n      }\n    });\n    if (!flow) {\n      throw new Meteor.Error('error', 'flow is not exists');\n    }\n    if (space_id !== flow.space) {\n      throw new Meteor.Error('error', 'flow is not belong to this space');\n    }\n    if (db.space_users.find({\n      space: space_id,\n      user: current_user_info._id\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'auth_token is not a member of this space');\n    }\n    instance_from_client[\"space\"] = space_id;\n    instance_from_client[\"flow\"] = flow_id;\n    instance_from_client[\"flow_version\"] = flow.current._id;\n    applicant = null;\n    if (applicant_id || applicant_username) {\n      if (applicant_id) {\n        applicant = db.users.findOne({\n          _id: applicant_id\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        if (!applicant) {\n          throw new Meteor.Error('error', 'applicant is wrong');\n        }\n      } else if (applicant_username) {\n        applicant = db.users.findOne({\n          username: applicant_username\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        if (!applicant) {\n          throw new Meteor.Error('error', 'applicant_username is wrong');\n        }\n      }\n      space_user = db.space_users.findOne({\n        space: space_id,\n        user: applicant._id\n      });\n      if (!space_user) {\n        throw new Meteor.Error('error', 'applicant is not a member of this space');\n      }\n      if (space_user.user_accepted !== true) {\n        throw new Meteor.Error('error', 'applicant is disabled in this space');\n      }\n      space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n      instance_from_client[\"applicant\"] = applicant._id;\n      instance_from_client[\"applicant_name\"] = applicant.name;\n      instance_from_client[\"applicant_organization\"] = space_user_org_info[\"organization\"];\n      instance_from_client[\"applicant_organization_fullname\"] = space_user_org_info[\"organization_fullname\"];\n      instance_from_client[\"applicant_organization_name\"] = space_user_org_info[\"organization_name\"];\n    }\n    applicantInfo = applicant || current_user_info;\n    traces = [];\n    trace = new Object;\n    approves = [];\n    approve = new Object;\n    approve[\"values\"] = hashData[\"values\"];\n    approves.push(approve);\n    trace[\"approves\"] = approves;\n    traces.push(trace);\n    instance_from_client[\"traces\"] = traces;\n    instance_from_client[\"inbox_users\"] = [applicantInfo._id];\n    new_ins_id = uuflowManager.create_instance(instance_from_client, applicantInfo);\n    new_ins = db.instances.findOne(new_ins_id);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: new_ins\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\r\n@api {get} /api/workflow/open/get/:ins_id æŸ¥çœ‹ç”³è¯·å•è¯¦æƒ…\r\n\r\n@apiName getInstance\r\n\r\n@apiGroup Workflow\r\n\r\n@apiPermission å·¥ä½œåŒºçš„ç®¡ç†å‘˜\r\n\r\n@apiParam {String} ins_id ç”³è¯·å•Id\r\n@apiParam {String} access_token User API Token\r\n\r\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\r\n\r\n@apiHeaderExample {json} Header-Example:\r\n{\r\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\r\n}\r\n\r\n@apiSuccessExample {json} Success-Response:\r\n{\r\n    \"status\": \"success\",\r\n    \"data\": {instance}\r\n}\r\n###\r\nJsonRoutes.add 'get', '/api/workflow/open/get/:ins_id', (req, res, next) ->\r\n\ttry\r\n\t\tins_id = req.params.ins_id\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\tinstance = db.instances.findOne(ins_id)\r\n\t\tif not instance\r\n\t\t\tthrow new Meteor.Error('error', 'can not find instance')\r\n\r\n\t\tif db.space_users.find({ space: instance.space, user: current_user }).count() is 0\r\n\t\t\tthrow new Meteor.Error('error', 'auth_token is wrong')\r\n\r\n\t\t# æƒé™ï¼šä»…ä»¥ä¸‹äººå‘˜å¯ä»¥æŸ¥çœ‹ç”³è¯·å•è¯¦æƒ…ï¼šæäº¤è€…ã€ç”³è¯·è€…ã€ç»æ‰‹è€…ã€æœ¬æµç¨‹çš„ç®¡ç†å‘˜ã€æœ¬æµç¨‹çš„è§‚å¯Ÿå‘˜ã€æœ¬å·¥ä½œåŒºçš„ç®¡ç†å‘˜ã€æœ¬å·¥ä½œåŒºçš„æ‰€æœ‰è€…ã€‚\r\n\t\tperm_users = new Array\r\n\t\tperm_users.push(instance.submitter)\r\n\t\tperm_users.push(instance.applicant)\r\n\t\tif instance.outbox_users\r\n\t\t\tperm_users = perm_users.concat(instance.outbox_users)\r\n\t\tif instance.inbox_users\r\n\t\t\tperm_users = perm_users.concat(instance.inbox_users)\r\n\t\tspace = db.spaces.findOne({ _id: instance.space }, { fields: { admins: 1 } })\r\n\t\tperm_users = perm_users.concat(space.admins)\r\n\r\n\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\r\n\r\n\t\tif (not perm_users.includes(current_user)) and (not permissions.includes(\"monitor\")) and (not permissions.includes(\"admin\"))\r\n\t\t\tthrow new Meteor.Error('error', 'no permission')\r\n\r\n\t\tinstance.attachments = cfs.instances.find({'metadata.instance': instance._id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: instance }\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\r\n\t\t}\r\n\r\n","\n/*\n@api {get} /api/workflow/open/get/:ins_id æŸ¥çœ‹ç”³è¯·å•è¯¦æƒ…\n\n@apiName getInstance\n\n@apiGroup Workflow\n\n@apiPermission å·¥ä½œåŒºçš„ç®¡ç†å‘˜\n\n@apiParam {String} ins_id ç”³è¯·å•Id\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n    \"status\": \"success\",\n    \"data\": {instance}\n}\n */\nJsonRoutes.add('get', '/api/workflow/open/get/:ins_id', function(req, res, next) {\n  var current_user, e, ins_id, instance, perm_users, permissions, space, space_id;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    instance = db.instances.findOne(ins_id);\n    if (!instance) {\n      throw new Meteor.Error('error', 'can not find instance');\n    }\n    if (db.space_users.find({\n      space: instance.space,\n      user: current_user\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'auth_token is wrong');\n    }\n    perm_users = new Array;\n    perm_users.push(instance.submitter);\n    perm_users.push(instance.applicant);\n    if (instance.outbox_users) {\n      perm_users = perm_users.concat(instance.outbox_users);\n    }\n    if (instance.inbox_users) {\n      perm_users = perm_users.concat(instance.inbox_users);\n    }\n    space = db.spaces.findOne({\n      _id: instance.space\n    }, {\n      fields: {\n        admins: 1\n      }\n    });\n    perm_users = perm_users.concat(space.admins);\n    permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n    if ((!perm_users.includes(current_user)) && (!permissions.includes(\"monitor\")) && (!permissions.includes(\"admin\"))) {\n      throw new Meteor.Error('error', 'no permission');\n    }\n    instance.attachments = cfs.instances.find({\n      'metadata.instance': instance._id,\n      'metadata.current': true,\n      \"metadata.is_private\": {\n        $ne: true\n      }\n    }, {\n      fields: {\n        copies: 0\n      }\n    }).fetch();\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: instance\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\r\n@api {put} /api/workflow/open/submit/:ins_id æäº¤ç”³è¯·å•\r\n\r\n@apiDescription æš‚ä¸æ”¯æŒå¼€å§‹èŠ‚ç‚¹ä¸‹ä¸€èŠ‚ç‚¹ä¸ºæ¡ä»¶çš„æƒ…å†µ\r\n\r\n@apiName submitInstance\r\n\r\n@apiGroup Workflow\r\n\r\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\r\n\r\n@apiParam {String} access_token User API Token\r\n\r\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\r\n\r\n@apiHeaderExample {json} Header-Example:\r\n    {\r\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\r\n\t}\r\n\r\n@apiSuccessExample {json} Success-Response:\r\n    {\r\n\t\t\"status\": \"success\",\r\n\t\t\"data\": {instance}\r\n\t}\r\n###\r\n\r\nJsonRoutes.add 'put', '/api/workflow/open/submit/:ins_id', (req, res, next) ->\r\n\ttry\r\n\t\tins_id = req.params.ins_id\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn ;\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\r\n\t\tif not current_user_info\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\tinstance = uuflowManager.getInstance(ins_id)\r\n\r\n\t\t# æ ¡éªŒç”³è¯·å•çŠ¶æ€ä¸ºè‰ç¨¿\r\n\t\tuuflowManager.isInstanceDraft(instance)\r\n\r\n\t\tif space_id isnt instance[\"space\"]\r\n\t\t\tthrow new Meteor.Error('error', 'instance is not belong to this space')\r\n\r\n\t\t# æ ¡éªŒç”³è¯·å•å¿…å¡«å­—æ®µæ˜¯å¦æœ‰å€¼\r\n\t\tvalues = instance[\"traces\"][0][\"approves\"][0].values\r\n\r\n\t\tform = uuflowManager.getForm(instance.form)\r\n\r\n\t\trequire_but_empty_fields = uuflowManager.checkValueFieldsRequire(values, form, instance.form_version)\r\n\r\n\t\tif require_but_empty_fields.length > 0\r\n\t\t\tif require_but_empty_fields.length > 1\r\n\t\t\t\tthrow new Meteor.Error('error', 'fields <' + require_but_empty_fields.join(\",\") + '> are required')\r\n\t\t\telse if require_but_empty_fields.length = 1\r\n\t\t\t\tthrow new Meteor.Error('error', 'field <' + require_but_empty_fields.join(\",\") + '> is required')\r\n\r\n\t\tflow = uuflowManager.getFlow(instance.flow)\r\n\r\n\t\tstep = uuflowManager.getStep(instance, flow, instance[\"traces\"][0].step)\r\n\r\n\t\t# è®¡ç®—ä¸‹ä¸€æ­¥éª¤é€‰é¡¹\r\n\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"submitted\")\r\n\r\n\t\tif nextSteps.length < 1\r\n\t\t\tthrow new Meteor.Error('error', 'can not find next steps')\r\n\r\n\t\tif nextSteps.length > 1\r\n\t\t\tthrow new Meteor.Error('error', 'next step not uniq')\r\n\r\n\t\tnext_step_id = nextSteps[0]\r\n\r\n\t\t# è®¡ç®—ä¸‹ä¸€æ­¥å¤„ç†äººé€‰é¡¹\r\n\t\tnext_user_ids = getHandlersManager.getHandlers(ins_id, next_step_id) || []\r\n\r\n\t\tif next_user_ids.length > 1\r\n\t\t\tthrow new Meteor.Error('error', 'next step handler not uniq')\r\n\r\n\t\tinstance[\"traces\"][0][\"approves\"][0][\"next_steps\"] = [{'step': next_step_id, 'users': next_user_ids}]\r\n\r\n\t\tresult = new Object\r\n\r\n\t\tsubmitter = db.users.findOne(instance.submitter)\r\n\r\n\t\tif not submitter\r\n\t\t\tthrow new Meteor.Error('error', 'can not find submitter')\r\n\r\n\t\tr = uuflowManager.submit_instance(instance, submitter)\r\n\r\n\t\tif r.alerts\r\n\t\t\tresult = r\r\n\t\telse\r\n\t\t\tresult = db.instances.findOne(ins_id)\r\n\t\t\tif result\r\n\t\t\t\tresult.attachments = cfs.instances.find({'metadata.instance': ins_id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: result}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n","\n/*\n@api {put} /api/workflow/open/submit/:ins_id æäº¤ç”³è¯·å•\n\n@apiDescription æš‚ä¸æ”¯æŒå¼€å§‹èŠ‚ç‚¹ä¸‹ä¸€èŠ‚ç‚¹ä¸ºæ¡ä»¶çš„æƒ…å†µ\n\n@apiName submitInstance\n\n@apiGroup Workflow\n\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\n\n@apiHeaderExample {json} Header-Example:\n    {\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n    {\n\t\t\"status\": \"success\",\n\t\t\"data\": {instance}\n\t}\n */\nJsonRoutes.add('put', '/api/workflow/open/submit/:ins_id', function(req, res, next) {\n  var current_user, current_user_info, e, flow, form, ins_id, instance, nextSteps, next_step_id, next_user_ids, r, require_but_empty_fields, result, space_id, step, submitter, values;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    instance = uuflowManager.getInstance(ins_id);\n    uuflowManager.isInstanceDraft(instance);\n    if (space_id !== instance[\"space\"]) {\n      throw new Meteor.Error('error', 'instance is not belong to this space');\n    }\n    values = instance[\"traces\"][0][\"approves\"][0].values;\n    form = uuflowManager.getForm(instance.form);\n    require_but_empty_fields = uuflowManager.checkValueFieldsRequire(values, form, instance.form_version);\n    if (require_but_empty_fields.length > 0) {\n      if (require_but_empty_fields.length > 1) {\n        throw new Meteor.Error('error', 'fields <' + require_but_empty_fields.join(\",\") + '> are required');\n      } else if (require_but_empty_fields.length = 1) {\n        throw new Meteor.Error('error', 'field <' + require_but_empty_fields.join(\",\") + '> is required');\n      }\n    }\n    flow = uuflowManager.getFlow(instance.flow);\n    step = uuflowManager.getStep(instance, flow, instance[\"traces\"][0].step);\n    nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"submitted\");\n    if (nextSteps.length < 1) {\n      throw new Meteor.Error('error', 'can not find next steps');\n    }\n    if (nextSteps.length > 1) {\n      throw new Meteor.Error('error', 'next step not uniq');\n    }\n    next_step_id = nextSteps[0];\n    next_user_ids = getHandlersManager.getHandlers(ins_id, next_step_id) || [];\n    if (next_user_ids.length > 1) {\n      throw new Meteor.Error('error', 'next step handler not uniq');\n    }\n    instance[\"traces\"][0][\"approves\"][0][\"next_steps\"] = [\n      {\n        'step': next_step_id,\n        'users': next_user_ids\n      }\n    ];\n    result = new Object;\n    submitter = db.users.findOne(instance.submitter);\n    if (!submitter) {\n      throw new Meteor.Error('error', 'can not find submitter');\n    }\n    r = uuflowManager.submit_instance(instance, submitter);\n    if (r.alerts) {\n      result = r;\n    } else {\n      result = db.instances.findOne(ins_id);\n      if (result) {\n        result.attachments = cfs.instances.find({\n          'metadata.instance': ins_id,\n          'metadata.current': true,\n          \"metadata.is_private\": {\n            $ne: true\n          }\n        }, {\n          fields: {\n            copies: 0\n          }\n        }).fetch();\n      }\n    }\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\r\n@api {put} /api/workflow/open/save/:ins_id æš‚å­˜ç”³è¯·å•\r\n\r\n@apiName saveInstances\r\n\r\n@apiGroup Workflow\r\n\r\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\r\n\r\n@apiParam {String} access_token User API Token\r\n\r\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\r\n\r\n@apiHeaderExample {json} Header-Example:\r\n    {\r\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\r\n\t}\r\n\r\n@apiSuccessExample {json} Success-Response:\r\n    {\r\n\t\t\"status\": \"success\",\r\n\t\t\"data\": {instance}\r\n\t}\r\n###\r\nJsonRoutes.add 'put', '/api/workflow/open/save/:ins_id', (req, res, next) ->\r\n\ttry\r\n\t\tins_id = req.params.ins_id\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn ;\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\r\n\t\tif not current_user_info\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\tvalues = req.body\r\n\r\n\t\tif not values\r\n\t\t\tthrow new Meteor.Error('error', 'need values')\r\n\r\n\t\tcurrent_trace = null\r\n\t\tsetObj = new Object\r\n\t\tinstance = uuflowManager.getInstance(ins_id)\r\n\t\tflow = uuflowManager.getFlow(instance.flow)\r\n\r\n\t\t_.each instance.traces, (t)->\r\n\t\t\tif t.is_finished isnt true\r\n\t\t\t\tcurrent_trace = t\r\n\r\n\t\tcurrent_step = uuflowManager.getStep(instance, flow, current_trace.step)\r\n\r\n\t\tif current_step.step_type is \"counterSign\"\r\n\t\t\tthrow new Meteor.Error('error', 'ä¼šç­¾æ­¥éª¤ä¸èƒ½ä¿®æ”¹è¡¨å•å€¼')\r\n\r\n\t\t_.each current_trace.approves, (a)->\r\n\t\t\tif a.is_finished isnt true and a.type isnt \"cc\"\r\n\t\t\t\ta.values = values\r\n\r\n\t\tsetObj.modified = new Date\r\n\t\tsetObj[\"traces.$.approves\"] = current_trace.approves\r\n\r\n\t\tdb.instances.update {\r\n\t\t\t_id: ins_id\r\n\t\t\t'traces._id': current_trace._id\r\n\t\t}, $set: setObj\r\n\r\n\t\tresult = new Object\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: result}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n","\n/*\n@api {put} /api/workflow/open/save/:ins_id æš‚å­˜ç”³è¯·å•\n\n@apiName saveInstances\n\n@apiGroup Workflow\n\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\n\n@apiHeaderExample {json} Header-Example:\n    {\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n    {\n\t\t\"status\": \"success\",\n\t\t\"data\": {instance}\n\t}\n */\nJsonRoutes.add('put', '/api/workflow/open/save/:ins_id', function(req, res, next) {\n  var current_step, current_trace, current_user, current_user_info, e, flow, ins_id, instance, result, setObj, space_id, values;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    values = req.body;\n    if (!values) {\n      throw new Meteor.Error('error', 'need values');\n    }\n    current_trace = null;\n    setObj = new Object;\n    instance = uuflowManager.getInstance(ins_id);\n    flow = uuflowManager.getFlow(instance.flow);\n    _.each(instance.traces, function(t) {\n      if (t.is_finished !== true) {\n        return current_trace = t;\n      }\n    });\n    current_step = uuflowManager.getStep(instance, flow, current_trace.step);\n    if (current_step.step_type === \"counterSign\") {\n      throw new Meteor.Error('error', 'ä¼šç­¾æ­¥éª¤ä¸èƒ½ä¿®æ”¹è¡¨å•å€¼');\n    }\n    _.each(current_trace.approves, function(a) {\n      if (a.is_finished !== true && a.type !== \"cc\") {\n        return a.values = values;\n      }\n    });\n    setObj.modified = new Date;\n    setObj[\"traces.$.approves\"] = current_trace.approves;\n    db.instances.update({\n      _id: ins_id,\n      'traces._id': current_trace._id\n    }, {\n      $set: setObj\n    });\n    result = new Object;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\r\n@api {post} /api/workflow/open/getbystepname æ ¹æ®æ­¥éª¤åç§°èŽ·å–ç”³è¯·å•\r\n\r\n@apiName getInstanceByStepName\r\n\r\n@apiGroup Workflow\r\n\r\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\r\n\r\n@apiParam {String} access_token User API Token\r\n\r\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\r\n\r\n@apiHeaderExample {json} Header-Example:\r\n{\r\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\r\n}\r\n\r\n@apiParamExample {json} Request Payload:\r\n{\r\n    \"flow\": æµç¨‹Id,\r\n    \"stepname\": æ­¥éª¤åç§°\r\n}\r\n\r\n@apiSuccessExample {json} Success-Response:\r\n{\r\n\t\"status\": \"success\",\r\n\t\"data\": [\r\n\t\t{\r\n\t\t\tinstance\r\n\t\t},\r\n\t\t{\r\n\t\t\tinstance\r\n\t\t}\r\n\t]\r\n}\r\n###\r\nJsonRoutes.add 'post', '/api/workflow/open/getbystepname', (req, res, next) ->\r\n\ttry\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn ;\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\r\n\t\tif not current_user_info\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\thashData = req.body\r\n\t\tstepname = hashData[\"stepname\"]\r\n\t\tflow = hashData[\"flow\"]\r\n\r\n\t\tif not stepname\r\n\t\t\tthrow new Meteor.Error('error', 'need stepname')\r\n\r\n\t\tif not flow\r\n\t\t\tthrow new Meteor.Error('error', 'need flow')\r\n\r\n\t\t# åŽ»æŽ‰{fields: {inbox_uers: 0, cc_users: 0, outbox_users: 0, traces: 0, attachments: 0}\r\n\t\tinstances = db.instances.find({space: space_id, flow: flow, state:'pending', traces:{$elemMatch: {is_finished: false, name: stepname}}}, {fields: {inbox_uers: 0, cc_users: 0, outbox_users: 0, attachments: 0, traces: 0}}).fetch()\r\n\r\n\t\tinstances.forEach (instance)->\r\n\t\t\tinstance.attachments = cfs.instances.find({'metadata.instance': instance._id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: instances}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n","\n/*\n@api {post} /api/workflow/open/getbystepname æ ¹æ®æ­¥éª¤åç§°èŽ·å–ç”³è¯·å•\n\n@apiName getInstanceByStepName\n\n@apiGroup Workflow\n\n@apiPermission å·¥ä½œåŒºç®¡ç†å‘˜\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\tå·¥ä½œåŒºId\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiParamExample {json} Request Payload:\n{\n    \"flow\": æµç¨‹Id,\n    \"stepname\": æ­¥éª¤åç§°\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n\t\"status\": \"success\",\n\t\"data\": [\n\t\t{\n\t\t\tinstance\n\t\t},\n\t\t{\n\t\t\tinstance\n\t\t}\n\t]\n}\n */\nJsonRoutes.add('post', '/api/workflow/open/getbystepname', function(req, res, next) {\n  var current_user, current_user_info, e, flow, hashData, instances, space_id, stepname;\n  try {\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    hashData = req.body;\n    stepname = hashData[\"stepname\"];\n    flow = hashData[\"flow\"];\n    if (!stepname) {\n      throw new Meteor.Error('error', 'need stepname');\n    }\n    if (!flow) {\n      throw new Meteor.Error('error', 'need flow');\n    }\n    instances = db.instances.find({\n      space: space_id,\n      flow: flow,\n      state: 'pending',\n      traces: {\n        $elemMatch: {\n          is_finished: false,\n          name: stepname\n        }\n      }\n    }, {\n      fields: {\n        inbox_uers: 0,\n        cc_users: 0,\n        outbox_users: 0,\n        attachments: 0,\n        traces: 0\n      }\n    }).fetch();\n    instances.forEach(function(instance) {\n      return instance.attachments = cfs.instances.find({\n        'metadata.instance': instance._id,\n        'metadata.current': true,\n        \"metadata.is_private\": {\n          $ne: true\n        }\n      }, {\n        fields: {\n          copies: 0\n        }\n      }).fetch();\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\r\nContent-Typeï¼šapplication/json\r\nform-data æ ¼å¼:\r\nfd = new FormData;\r\nfd.append(\"file\", file);\r\n\r\nfd.append(\"is_private\", false);\r\n\r\nif (isAddVersion) {\r\n\tfd.append(\"isAddVersion\", isAddVersion);\r\n\tfd.append(\"parent\", attach_parent_id);\r\n}\r\n\r\nif (isMainAttach) {\r\n\tfd.append(\"main\", true);\r\n}\r\n###\r\n\r\nJsonRoutes.add 'post', '/api/workflow/open/cfs/:ins_id', (req, res, next) ->\r\n\ttry\r\n\t\tins_id = req.params.ins_id\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn ;\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\r\n\t\tif not current_user_info\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\tinstance = uuflowManager.getInstance(ins_id)\r\n\r\n\t\tif instance.state isnt \"draft\"\r\n\t\t\tthrow new Meteor.Error('error', 'ç”³è¯·å•è‰ç¨¿çŠ¶æ€æ—¶æ‰èƒ½ä¸Šä¼ ')\r\n\r\n\t\tapprove_id = instance.traces[0].approves[0]._id\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\tJsonRoutes.parseFiles req, res, ()->\r\n\t\t\tcollection = cfs.instances\r\n\r\n\t\t\tif req.files and req.files[0]\r\n\t\t\t\t# é™„ä»¶ä¸Šä¼ æŽ¥å£ï¼Œé™åˆ¶é™„ä»¶å¤§å°ï¼Œæœ€å¤§ä¸º100M\r\n\t\t\t\tif req.files[0].data.length > (100*1024*1024)\r\n\t\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\t\tcode: 200\r\n\t\t\t\t\t\tdata: { errors: [{errorMessage: \"è¶…è¿‡ä¸Šä¼ é™„ä»¶å¤§å°é™åˆ¶(100M)\"}]}\r\n\t\t\t\t\treturn\r\n\r\n\t\t\t\tnewFile = new FS.File();\r\n\t\t\t\tnewFile.attachData req.files[0].data, {type: req.files[0].mimeType}, (err) ->\r\n\t\t\t\t\tfilename = req.files[0].filename\r\n\r\n\t\t\t\t\tif [\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())\r\n\t\t\t\t\t\tfilename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + filename.split('.').pop()\r\n\r\n\t\t\t\t\tbody = req.body\r\n\r\n\t\t\t\t\tbody['owner'] = instance.submitter\r\n\t\t\t\t\tbody['owner_name'] = instance.submitter_name\r\n\t\t\t\t\tbody['space'] = space_id\r\n\t\t\t\t\tbody['instance'] = ins_id\r\n\t\t\t\t\tbody['approve'] = approve_id\r\n\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t\tif body && (body['upload_from'] is \"IE\" or body['upload_from'] is \"node\")\r\n\t\t\t\t\t\t\tfilename = decodeURIComponent(filename)\r\n\t\t\t\t\tcatch e\r\n\t\t\t\t\t\tconsole.error(filename)\r\n\t\t\t\t\t\tconsole.error e\r\n\t\t\t\t\t\tfilename = filename.replace(/%/g, \"-\")\r\n\r\n\t\t\t\t\tnewFile.name(filename)\r\n\t\t\t\t\t\r\n\t\t\t\t\tif body && body['owner'] && body['owner_name'] && body['space'] && body['instance']  && body['approve']\r\n\t\t\t\t\t\tparent = ''\r\n\t\t\t\t\t\tmetadata = {owner:body['owner'], owner_name:body['owner_name'], space:body['space'], instance:body['instance'], approve: body['approve'], current: true}\r\n\r\n\t\t\t\t\t\tif body[\"is_private\"] && body[\"is_private\"].toLocaleLowerCase() == \"true\"\r\n\t\t\t\t\t\t\tmetadata.is_private = true\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tmetadata.is_private = false\r\n\r\n\t\t\t\t\t\tif body['main'] == \"true\"\r\n\t\t\t\t\t\t\tmetadata.main = true\r\n\r\n\t\t\t\t\t\tif body['isAddVersion'] && body['parent']\r\n\t\t\t\t\t\t\tparent = body['parent']\r\n\t\t\t\t\t\t# else\r\n\t\t\t\t\t\t#   collection.find({'metadata.instance': body['instance'], 'metadata.current' : true}).forEach (c) ->\r\n\t\t\t\t\t\t#     if c.name() == filename\r\n\t\t\t\t\t\t#       parent = c.metadata.parent\r\n\r\n\t\t\t\t\t\tif parent\r\n\t\t\t\t\t\t\tr = collection.update({'metadata.parent': parent, 'metadata.current' : true}, {$unset : {'metadata.current' : ''}})\r\n\t\t\t\t\t\t\tif r\r\n\t\t\t\t\t\t\t\tmetadata.parent = parent\r\n\t\t\t\t\t\t\t\tif body['locked_by'] && body['locked_by_name']\r\n\t\t\t\t\t\t\t\t\tmetadata.locked_by = body['locked_by']\r\n\t\t\t\t\t\t\t\t\tmetadata.locked_by_name = body['locked_by_name']\r\n\r\n\t\t\t\t\t\t\t\tnewFile.metadata = metadata\r\n\t\t\t\t\t\t\t\tfileObj = collection.insert newFile\r\n\r\n\t\t\t\t\t\t\t\t# åˆ é™¤åŒä¸€ä¸ªç”³è¯·å•åŒä¸€ä¸ªæ­¥éª¤åŒä¸€ä¸ªäººä¸Šä¼ çš„é‡å¤çš„æ–‡ä»¶\r\n\t\t\t\t\t\t\t\tif body[\"overwrite\"] && body[\"overwrite\"].toLocaleLowerCase() == \"true\"\r\n\t\t\t\t\t\t\t\t\tcollection.remove({'metadata.instance': body['instance'], 'metadata.parent': parent, 'metadata.owner': body['owner'], 'metadata.approve': body['approve'], 'metadata.current': {$ne: true}})\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tnewFile.metadata = metadata\r\n\t\t\t\t\t\t\tfileObj = collection.insert newFile\r\n\t\t\t\t\t\t\tfileObj.update({$set: {'metadata.parent' : fileObj._id}})\r\n\r\n\t\t\t\t\t# å…¼å®¹è€ç‰ˆæœ¬\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tfileObj = collection.insert newFile\r\n\r\n\t\t\t\t\tsize = fileObj.original.size\r\n\t\t\t\t\tif !size\r\n\t\t\t\t\t\tsize = 1024\r\n\r\n\t\t\t\t\tresult = new Object\r\n\t\t\t\t\tresult =\r\n\t\t\t\t\t\tattach_id: fileObj._id,\r\n\t\t\t\t\t\tsize: size\r\n\r\n\t\t\t\t\tres.setHeader(\"x-amz-version-id\",fileObj._id);\r\n\r\n\t\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\t\tcode: 200\r\n\t\t\t\t\t\tdata: { status: \"success\", data: result}\r\n\t\t\telse\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 200\r\n\t\t\t\t\tdata: { errors: [{errorMessage: \"need file\"}]}\r\n\t\t\t\treturn\r\n\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n\r\nJsonRoutes.add \"delete\", \"/api/workflow/open/cfs/:ins_id\",  (req, res, next) ->\r\n\ttry\r\n\t\tins_id = req.params.ins_id\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn ;\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\r\n\t\tif not current_user_info\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\tinstance = uuflowManager.getInstance(ins_id)\r\n\r\n\t\tif instance.state isnt \"draft\"\r\n\t\t\tthrow new Meteor.Error('error', 'ç”³è¯·å•è‰ç¨¿çŠ¶æ€æ—¶æ‰èƒ½åˆ é™¤é™„ä»¶')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\thashData = req.body || {}\r\n\t\tattach_id = hashData[\"attach_id\"]\r\n\r\n\t\tif not attach_id\r\n\t\t\tthrow new Meteor.Error('error', 'can not find attach_id')\r\n\r\n\t\tcollection = cfs.instances\r\n\r\n\t\tfile = collection.findOne({ _id: attach_id, 'metadata.instance': ins_id})\r\n\t\tif file\r\n\t\t\tfile.remove()\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error', 'æ­¤é™„ä»¶ä¸å±žäºŽæ­¤ç”³è¯·å•ï¼Œæˆ–å·²è¢«åˆ é™¤')\r\n\r\n\t\tresult = new Object\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: result}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n\r\nJsonRoutes.add \"get\", \"/api/workflow/open/cfs/:attach_id\",  (req, res, next) ->\r\n\ttry\r\n\t\tattach_id = req.params.attach_id\r\n\r\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\t\treturn ;\r\n\r\n\t\tcurrent_user = req.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id']\r\n\r\n\t\tif not space_id\r\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\r\n\r\n\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\r\n\t\tif not current_user_info\r\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\r\n\r\n\t\t# æ ¡éªŒspaceæ˜¯å¦å­˜åœ¨\r\n\t\tuuflowManager.getSpace(space_id)\r\n\t\t# æ ¡éªŒå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯spaceçš„ç®¡ç†å‘˜\r\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\r\n\r\n\t\tres.statusCode = 302\r\n\t\tres.setHeader \"Location\", Steedos.absoluteUrl(\"api/files/instances/\") + attach_id + \"?download=true\"\r\n\t\tres.end()\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n","\n/*\nContent-Typeï¼šapplication/json\nform-data æ ¼å¼:\nfd = new FormData;\nfd.append(\"file\", file);\n\nfd.append(\"is_private\", false);\n\nif (isAddVersion) {\n\tfd.append(\"isAddVersion\", isAddVersion);\n\tfd.append(\"parent\", attach_parent_id);\n}\n\nif (isMainAttach) {\n\tfd.append(\"main\", true);\n}\n */\nJsonRoutes.add('post', '/api/workflow/open/cfs/:ins_id', function(req, res, next) {\n  var approve_id, current_user, current_user_info, e, ins_id, instance, space_id;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    instance = uuflowManager.getInstance(ins_id);\n    if (instance.state !== \"draft\") {\n      throw new Meteor.Error('error', 'ç”³è¯·å•è‰ç¨¿çŠ¶æ€æ—¶æ‰èƒ½ä¸Šä¼ ');\n    }\n    approve_id = instance.traces[0].approves[0]._id;\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    return JsonRoutes.parseFiles(req, res, function() {\n      var collection, newFile;\n      collection = cfs.instances;\n      if (req.files && req.files[0]) {\n        if (req.files[0].data.length > (100 * 1024 * 1024)) {\n          JsonRoutes.sendResult(res, {\n            code: 200,\n            data: {\n              errors: [\n                {\n                  errorMessage: \"è¶…è¿‡ä¸Šä¼ é™„ä»¶å¤§å°é™åˆ¶(100M)\"\n                }\n              ]\n            }\n          });\n          return;\n        }\n        newFile = new FS.File();\n        return newFile.attachData(req.files[0].data, {\n          type: req.files[0].mimeType\n        }, function(err) {\n          var body, e, fileObj, filename, metadata, parent, r, result, size;\n          filename = req.files[0].filename;\n          if ([\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())) {\n            filename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + filename.split('.').pop();\n          }\n          body = req.body;\n          body['owner'] = instance.submitter;\n          body['owner_name'] = instance.submitter_name;\n          body['space'] = space_id;\n          body['instance'] = ins_id;\n          body['approve'] = approve_id;\n          try {\n            if (body && (body['upload_from'] === \"IE\" || body['upload_from'] === \"node\")) {\n              filename = decodeURIComponent(filename);\n            }\n          } catch (error) {\n            e = error;\n            console.error(filename);\n            console.error(e);\n            filename = filename.replace(/%/g, \"-\");\n          }\n          newFile.name(filename);\n          if (body && body['owner'] && body['owner_name'] && body['space'] && body['instance'] && body['approve']) {\n            parent = '';\n            metadata = {\n              owner: body['owner'],\n              owner_name: body['owner_name'],\n              space: body['space'],\n              instance: body['instance'],\n              approve: body['approve'],\n              current: true\n            };\n            if (body[\"is_private\"] && body[\"is_private\"].toLocaleLowerCase() === \"true\") {\n              metadata.is_private = true;\n            } else {\n              metadata.is_private = false;\n            }\n            if (body['main'] === \"true\") {\n              metadata.main = true;\n            }\n            if (body['isAddVersion'] && body['parent']) {\n              parent = body['parent'];\n            }\n            if (parent) {\n              r = collection.update({\n                'metadata.parent': parent,\n                'metadata.current': true\n              }, {\n                $unset: {\n                  'metadata.current': ''\n                }\n              });\n              if (r) {\n                metadata.parent = parent;\n                if (body['locked_by'] && body['locked_by_name']) {\n                  metadata.locked_by = body['locked_by'];\n                  metadata.locked_by_name = body['locked_by_name'];\n                }\n                newFile.metadata = metadata;\n                fileObj = collection.insert(newFile);\n                if (body[\"overwrite\"] && body[\"overwrite\"].toLocaleLowerCase() === \"true\") {\n                  collection.remove({\n                    'metadata.instance': body['instance'],\n                    'metadata.parent': parent,\n                    'metadata.owner': body['owner'],\n                    'metadata.approve': body['approve'],\n                    'metadata.current': {\n                      $ne: true\n                    }\n                  });\n                }\n              }\n            } else {\n              newFile.metadata = metadata;\n              fileObj = collection.insert(newFile);\n              fileObj.update({\n                $set: {\n                  'metadata.parent': fileObj._id\n                }\n              });\n            }\n          } else {\n            fileObj = collection.insert(newFile);\n          }\n          size = fileObj.original.size;\n          if (!size) {\n            size = 1024;\n          }\n          result = new Object;\n          result = {\n            attach_id: fileObj._id,\n            size: size\n          };\n          res.setHeader(\"x-amz-version-id\", fileObj._id);\n          return JsonRoutes.sendResult(res, {\n            code: 200,\n            data: {\n              status: \"success\",\n              data: result\n            }\n          });\n        });\n      } else {\n        JsonRoutes.sendResult(res, {\n          code: 200,\n          data: {\n            errors: [\n              {\n                errorMessage: \"need file\"\n              }\n            ]\n          }\n        });\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n\nJsonRoutes.add(\"delete\", \"/api/workflow/open/cfs/:ins_id\", function(req, res, next) {\n  var attach_id, collection, current_user, current_user_info, e, file, hashData, ins_id, instance, result, space_id;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    instance = uuflowManager.getInstance(ins_id);\n    if (instance.state !== \"draft\") {\n      throw new Meteor.Error('error', 'ç”³è¯·å•è‰ç¨¿çŠ¶æ€æ—¶æ‰èƒ½åˆ é™¤é™„ä»¶');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    hashData = req.body || {};\n    attach_id = hashData[\"attach_id\"];\n    if (!attach_id) {\n      throw new Meteor.Error('error', 'can not find attach_id');\n    }\n    collection = cfs.instances;\n    file = collection.findOne({\n      _id: attach_id,\n      'metadata.instance': ins_id\n    });\n    if (file) {\n      file.remove();\n    } else {\n      throw new Meteor.Error('error', 'æ­¤é™„ä»¶ä¸å±žäºŽæ­¤ç”³è¯·å•ï¼Œæˆ–å·²è¢«åˆ é™¤');\n    }\n    result = new Object;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n\nJsonRoutes.add(\"get\", \"/api/workflow/open/cfs/:attach_id\", function(req, res, next) {\n  var attach_id, current_user, current_user_info, e, space_id;\n  try {\n    attach_id = req.params.attach_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    res.statusCode = 302;\n    res.setHeader(\"Location\", Steedos.absoluteUrl(\"api/files/instances/\") + attach_id + \"?download=true\");\n    return res.end();\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/forward_refill\", (req, res, next) ->\r\n\tconsole.log \"=========å›žå¡«å­è¡¨==========\"\r\n\tconsole.log \"req?.query?.subTable\",req?.query?.subTable\r\n\tconsole.log \"=========åˆ†å‘å›žå¡«çš„åˆ—==========\"\r\n\tconsole.log \"req?.query?.column\",req?.query?.column\r\n\r\n\tcolumns = req?.query?.column.split(';')\r\n\tconsole.log \"columns\",columns\r\n\r\n\r\n\t# åˆ†å‘çš„ç”³è¯·å•\r\n\tforward_ins = req?.body?.instance\r\n\r\n\tsubTable = req?.query?.subTable\r\n\r\n\tif forward_ins?.state == \"completed\" && forward_ins?.distribute_from_instances?.length>0 && subTable && columns\r\n\t\t\r\n\t\t# åˆ†å‘å›žæ¥çš„å€¼\r\n\t\tforward_ins_values = forward_ins?.values\r\n\r\n\t\t# # åŽŸç”³è¯·å•å­—æ®µ\r\n\t\toriginal_ins_id = _.last forward_ins?.distribute_from_instances\r\n\t\toriginal_ins = db.instances.findOne(original_ins_id)\r\n\t\toriginal_ins_form = db.forms.findOne(original_ins?.form)\r\n\r\n\t\toriginal_ins_fields = []\r\n\t\toriginal_subtable_fields = []\r\n\r\n\t\tconsole.log \"original_ins_form?.current?._id\",original_ins_form?.current?._id\r\n\t\tconsole.log \"original_ins?.form_version\",original_ins?.form_version\r\n\r\n\t\t# æŸ¥çœ‹åŽŸç”³è¯·å•æ˜¯å¦æœ‰å¯¹åº”çš„å­è¡¨\r\n\t\tif original_ins?.form_version == original_ins_form?.current?._id\r\n\t\t\toriginal_ins_fields = original_ins_form.current?.fields\r\n\t\t\toriginal_ins_fields.forEach (original_ins_field)->\r\n\t\t\t\tconsole.log \"original_ins_field\",original_ins_field?.code\r\n\t\t\t\tif original_ins_field?.code == subTable && original_ins_field?.type == 'table'\r\n\t\t\t\t\toriginal_subtable_fields = original_ins_field?.fields\r\n\t\telse\r\n\t\t\tif original_ins_form?.historys?.length > 0\r\n\t\t\t\toriginal_ins_form.historys.forEach (oh)->\r\n\t\t\t\t\tif original_ins?.form_version == oh._id\r\n\t\t\t\t\t\toriginal_ins_fields = oh?.fields\r\n\t\t\t\t\t\toriginal_ins_fields.forEach (original_ins_field)->\r\n\t\t\t\t\t\t\tif original_ins_field?.code == subTable && original_ins_field?.type == 'table'\r\n\t\t\t\t\t\t\t\toriginal_subtable_fields = original_ins_field?.fields\r\n\r\n\t\tconsole.log \"original_subtable_fields\",original_subtable_fields?.length\r\n\r\n\t\tif original_subtable_fields\r\n\t\t\t# # æ›´æ–°æ­¥éª¤çš„å€¼\r\n\t\t\t# 1.æ‰¾åˆ°å½“å‰çš„æ­¥éª¤\r\n\t\t\t# 2.å½“å‰æ­¥éª¤ä¸­approvesä¸­çš„values\r\n\t\t\t# 3.åœ¨valuesä¸­æ‰¾åˆ°è¡¨æ ¼\r\n\t\t\t# 4.æ ¹æ®è¡¨æ ¼çš„fieldså±žæ€§ï¼Œä¸€ä¸ªä¸ªçš„èµ‹å€¼\r\n\t\t\t# 5.æŠŠå¤åˆ¶çš„pushåˆ°è¡¨æ ¼æ•°ç»„çš„åŽé¢\r\n\t\t\ttraces = original_ins?.traces\r\n\r\n\t\t\ttrace = traces[traces.length-1]\r\n\r\n\t\t\tapprove = trace?.approves[0]\r\n\r\n\t\t\ttable_data = approve?.values[subTable] || []\r\n\r\n\t\t\trow_data = {}\r\n\r\n\t\t\tcolumns.forEach (column)->\r\n\t\t\t\trow_data[column] = forward_ins_values[column] || \"\"\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif row_data && row_data != {}\r\n\t\t\t\ttable_data.push row_data\r\n\t\t\t\ttraces[traces.length-1].approves[0].values[subTable] = table_data\r\n\r\n\t\t\t\tconsole.log traces[traces.length-1].approves[0].values[subTable]\r\n\r\n\t\t\t\tdb.instances.update(original_ins_id,{\r\n\t\t\t\t\t$set:{\r\n\t\t\t\t\t\t'traces':traces\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\tJsonRoutes.sendResult res, {\r\n\t\t\t\t\tcode: 200,\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t'success': 'å›žå¡«æˆåŠŸ'\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\telse\r\n\t\t\t\tJsonRoutes.sendResult res, {\r\n\t\t\t\t\tcode: 200,\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t'info': 'å›žå¡«æ•°æ®ä¸ºç©º'\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\telse\r\n\t\t\tJsonRoutes.sendResult res, {\r\n\t\t\t\tcode: 200,\r\n\t\t\t\tdata: {\r\n\t\t\t\t\t'error': 'åŽŸç”³è¯·å•æ— ç›¸å…³å­è¡¨'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\telse\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'success': 'ç”³è¯·å•æœªç»“æŸ'\r\n\t\t\t}\r\n\t\t}\r\n)","JsonRoutes.add(\"post\", \"/api/workflow/forward_refill\", function(req, res, next) {\n  var approve, columns, forward_ins, forward_ins_values, original_ins, original_ins_fields, original_ins_form, original_ins_id, original_subtable_fields, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, row_data, subTable, table_data, trace, traces;\n  console.log(\"=========å›žå¡«å­è¡¨==========\");\n  console.log(\"req?.query?.subTable\", req != null ? (ref = req.query) != null ? ref.subTable : void 0 : void 0);\n  console.log(\"=========åˆ†å‘å›žå¡«çš„åˆ—==========\");\n  console.log(\"req?.query?.column\", req != null ? (ref1 = req.query) != null ? ref1.column : void 0 : void 0);\n  columns = req != null ? (ref2 = req.query) != null ? ref2.column.split(';') : void 0 : void 0;\n  console.log(\"columns\", columns);\n  forward_ins = req != null ? (ref3 = req.body) != null ? ref3.instance : void 0 : void 0;\n  subTable = req != null ? (ref4 = req.query) != null ? ref4.subTable : void 0 : void 0;\n  if ((forward_ins != null ? forward_ins.state : void 0) === \"completed\" && (forward_ins != null ? (ref5 = forward_ins.distribute_from_instances) != null ? ref5.length : void 0 : void 0) > 0 && subTable && columns) {\n    forward_ins_values = forward_ins != null ? forward_ins.values : void 0;\n    original_ins_id = _.last(forward_ins != null ? forward_ins.distribute_from_instances : void 0);\n    original_ins = db.instances.findOne(original_ins_id);\n    original_ins_form = db.forms.findOne(original_ins != null ? original_ins.form : void 0);\n    original_ins_fields = [];\n    original_subtable_fields = [];\n    console.log(\"original_ins_form?.current?._id\", original_ins_form != null ? (ref6 = original_ins_form.current) != null ? ref6._id : void 0 : void 0);\n    console.log(\"original_ins?.form_version\", original_ins != null ? original_ins.form_version : void 0);\n    if ((original_ins != null ? original_ins.form_version : void 0) === (original_ins_form != null ? (ref7 = original_ins_form.current) != null ? ref7._id : void 0 : void 0)) {\n      original_ins_fields = (ref8 = original_ins_form.current) != null ? ref8.fields : void 0;\n      original_ins_fields.forEach(function(original_ins_field) {\n        console.log(\"original_ins_field\", original_ins_field != null ? original_ins_field.code : void 0);\n        if ((original_ins_field != null ? original_ins_field.code : void 0) === subTable && (original_ins_field != null ? original_ins_field.type : void 0) === 'table') {\n          return original_subtable_fields = original_ins_field != null ? original_ins_field.fields : void 0;\n        }\n      });\n    } else {\n      if ((original_ins_form != null ? (ref9 = original_ins_form.historys) != null ? ref9.length : void 0 : void 0) > 0) {\n        original_ins_form.historys.forEach(function(oh) {\n          if ((original_ins != null ? original_ins.form_version : void 0) === oh._id) {\n            original_ins_fields = oh != null ? oh.fields : void 0;\n            return original_ins_fields.forEach(function(original_ins_field) {\n              if ((original_ins_field != null ? original_ins_field.code : void 0) === subTable && (original_ins_field != null ? original_ins_field.type : void 0) === 'table') {\n                return original_subtable_fields = original_ins_field != null ? original_ins_field.fields : void 0;\n              }\n            });\n          }\n        });\n      }\n    }\n    console.log(\"original_subtable_fields\", original_subtable_fields != null ? original_subtable_fields.length : void 0);\n    if (original_subtable_fields) {\n      traces = original_ins != null ? original_ins.traces : void 0;\n      trace = traces[traces.length - 1];\n      approve = trace != null ? trace.approves[0] : void 0;\n      table_data = (approve != null ? approve.values[subTable] : void 0) || [];\n      row_data = {};\n      columns.forEach(function(column) {\n        return row_data[column] = forward_ins_values[column] || \"\";\n      });\n      if (row_data && row_data !== {}) {\n        table_data.push(row_data);\n        traces[traces.length - 1].approves[0].values[subTable] = table_data;\n        console.log(traces[traces.length - 1].approves[0].values[subTable]);\n        db.instances.update(original_ins_id, {\n          $set: {\n            'traces': traces\n          }\n        });\n        return JsonRoutes.sendResult(res, {\n          code: 200,\n          data: {\n            'success': 'å›žå¡«æˆåŠŸ'\n          }\n        });\n      } else {\n        return JsonRoutes.sendResult(res, {\n          code: 200,\n          data: {\n            'info': 'å›žå¡«æ•°æ®ä¸ºç©º'\n          }\n        });\n      }\n    } else {\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          'error': 'åŽŸç”³è¯·å•æ— ç›¸å…³å­è¡¨'\n        }\n      });\n    }\n  } else {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'success': 'ç”³è¯·å•æœªç»“æŸ'\n      }\n    });\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/forward_table_refill\", (req, res, next) ->\r\n\ttry\r\n\t\tconsole.log \"=========åŽŸè¡¨å­è¡¨==========\"\r\n\t\tconsole.log \"req?.query?.oTable\",req?.query?.oTable\r\n\t\tconsole.log \"=========çŽ°è¡¨å­è¡¨==========\"\r\n\t\tconsole.log \"req?.query?.dTable\",req?.query?.dTable\r\n\t\tconsole.log \"=========åŽŸè¡¨å•çš„å­è¡¨åŒ¹é…åˆ—==========\"\r\n\t\tconsole.log \"req?.query?.oMatchCol\",req?.query?.oMatchCol\r\n\t\tconsole.log \"=========çŽ°è¡¨å•çš„å­è¡¨åŒ¹é…åˆ—==========\"\r\n\t\tconsole.log \"req?.query?.dMatchCol\",req?.query?.dMatchCol\r\n\t\tconsole.log \"=========éœ€è¦å›žå¡«çš„åˆ—==========\"\t\r\n\t\tconsole.log \"req?.query?.refillCol\",req?.query?.refillCol\r\n\r\n\t\t# åˆ†å‘çš„ç”³è¯·å•\r\n\t\td_ins = req?.body?.instance\r\n\r\n\t\t\r\n\t\tif d_ins?.state == \"completed\"\r\n\t\t\tif req?.query?.oTable\r\n\t\t\t\to_table = req?.query?.oTable\r\n\t\t\t\tif req?.query?.dTable\r\n\t\t\t\t\td_table = req?.query?.dTable\r\n\t\t\t\telse\r\n\t\t\t\t\td_table = o_table\r\n\t\t\t\tif req?.query?.aTable\r\n\t\t\t\t\ta_table = req?.query?.aTable\r\n\t\t\t\tif req?.query?.oMatchCol\r\n\t\t\t\t\to_match_col = req?.query?.oMatchCol\r\n\t\t\t\t\tif req?.query?.dMatchCol\r\n\t\t\t\t\t\td_match_col = req?.query?.dMatchCol\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\td_match_col = o_match_col\r\n\t\t\t\t\tcolumns = req?.query?.refillCol.split(';') || []\r\n\t\t\t\t\tconsole.log \"columns\",columns\t\t\t\t\t\r\n\r\n\t\t\t\t\tif columns || columns.length<1\r\n\t\t\t\t\t\tconsole.log \"======================\"\r\n\t\t\t\t\t\tconsole.log d_table, o_match_col, columns\r\n\r\n\t\t\t\t\t\t# åˆ†å‘å›žæ¥çš„å€¼\r\n\t\t\t\t\t\td_ins_values = d_ins?.values\r\n\r\n\t\t\t\t\t\t# åŽŸç”³è¯·å• form è¡¨å­—æ®µ\r\n\t\t\t\t\t\to_ins_id = _.last d_ins?.distribute_from_instances\r\n\t\t\t\t\t\to_ins = db.instances.findOne(o_ins_id)\r\n\t\t\t\t\t\to_ins_form = db.forms.findOne(o_ins?.form)\r\n\r\n\t\t\t\t\t\td_ins_form = db.forms.findOne(d_ins?.form)\r\n\r\n\t\t\t\t\t\t# åŽŸç”³è¯·å•çš„ fields\r\n\t\t\t\t\t\to_ins_fields = []\r\n\r\n\t\t\t\t\t\t# åŽŸå­è¡¨å­—æ®µ\r\n\t\t\t\t\t\to_subtable_fields = []\r\n\r\n\t\t\t\t\t\t# åˆ†å‘ç”³è¯·å•çš„ fields\r\n\t\t\t\t\t\td_ins_fields = []\r\n\t\t\t\t\t\t# çŽ°ç”³è¯·å•å­—è¡¨å­—æ®µ\r\n\t\t\t\t\t\td_subtable_fields = []\r\n\r\n\t\t\t\t\t\t# èµ‹å€¼å¯¹åº”çš„å­—æ®µ\r\n\t\t\t\t\t\tcolumn_list = []\r\n\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t# åˆ†å‘åŽç”³è¯·å•çš„ å­è¡¨å€¼\r\n\t\t\t\t\t\td_table_values = []\r\n\r\n\t\t\t\t\t\t# æŸ¥çœ‹åŽŸç”³è¯·å•æ˜¯å¦æœ‰å¯¹åº”çš„å­è¡¨\r\n\t\t\t\t\t\tif o_ins?.form_version == o_ins_form?.current?._id\r\n\t\t\t\t\t\t\to_ins_fields = o_ins_form?.current?.fields\r\n\t\t\t\t\t\t\to_ins_fields.forEach (o_ins_field)->\r\n\t\t\t\t\t\t\t\tif o_ins_field?.type == 'table' && o_ins_field?.code == o_table\r\n\t\t\t\t\t\t\t\t\to_subtable_fields = o_ins_field?.fields\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tif o_ins_form?.historys?.length > 0\r\n\t\t\t\t\t\t\t\to_ins_form.historys.forEach (oh)->\r\n\t\t\t\t\t\t\t\t\tif o_ins?.form_version == oh._id\r\n\t\t\t\t\t\t\t\t\t\to_ins_fields = oh?.fields\r\n\t\t\t\t\t\t\t\t\t\to_ins_fields.forEach (o_ins_field)->\r\n\t\t\t\t\t\t\t\t\t\t\tif o_ins_field?.type == 'table' && o_ins_field?.code == o_table\r\n\t\t\t\t\t\t\t\t\t\t\t\to_subtable_fields = o_ins_field?.fields\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t# æŸ¥çœ‹åˆ†å‘çš„ç”³è¯·å•æ˜¯å¦æœ‰å¯¹åº”çš„å­—è¡¨\r\n\t\t\t\t\t\tif d_ins?.form_version == d_ins_form?.current?._id\r\n\t\t\t\t\t\t\td_ins_fields = d_ins_form?.current?.fields\r\n\t\t\t\t\t\t\td_ins_fields.forEach (d_ins_field)->\r\n\t\t\t\t\t\t\t\tif((d_ins_field?.type == 'table' && d_ins_field?.code == d_table)||(a_table && d_ins_field?.type == 'table' && d_ins_field?.code == a_table))\r\n\t\t\t\t\t\t\t\t\td_subtable_fields = d_subtable_fields.concat d_ins_field?.fields\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tif d_ins_form?.historys?.length > 0\r\n\t\t\t\t\t\t\t\td_ins_form.historys.forEach (dh)->\r\n\t\t\t\t\t\t\t\t\tif d_ins?.form_version == dh._id\r\n\t\t\t\t\t\t\t\t\t\td_ins_fields = dh?.fields\r\n\t\t\t\t\t\t\t\t\t\td_ins_fields.forEach (d_ins_field)->\r\n\t\t\t\t\t\t\t\t\t\t\tif((d_ins_field?.type == 'table' && d_ins_field?.code == d_table)||(a_table && d_ins_field?.type == 'table' && d_ins_field?.code == a_table))\r\n\t\t\t\t\t\t\t\t\t\t\t\td_subtable_fields = d_subtable_fields.concat d_ins_field?.fields\r\n\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\tif o_subtable_fields.length == 0\r\n\t\t\t\t\t\t\tconsole.log \"o_subtable_fields\",o_subtable_fields\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åŽŸç”³è¯·å•æ— å¯¹åº”å­è¡¨');\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif d_subtable_fields.length == 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•æ— å¯¹åº”å­è¡¨');\r\n\r\n\t\t\t\t\t\td_table_values = d_ins?.values[d_table] || []\r\n\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif a_table\r\n\t\t\t\t\t\t\ta_table_values =  d_ins?.values[a_table] || []\r\n\t\t\t\t\t\t\tif a_table_values && a_table_values?.length==d_table_values?.length\r\n\t\t\t\t\t\t\t\ta_table_values.forEach (a_row,index)->\r\n\t\t\t\t\t\t\t\t\td_table_values[index][key] = value for key,value of a_row\r\n\r\n\t\t\t\t\t\tif d_table_values.length == 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å­è¡¨æ•°æ®ä¸ºç©º');\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\to_match_col_fields = o_subtable_fields.filter((m)->return m.code==o_match_col)\r\n\t\t\t\t\t\td_match_col_fields = d_subtable_fields.filter((m)->return m.code==d_match_col)\r\n\r\n\t\t\t\t\t\t# åŒ¹é…åˆ—åˆ¤æ–­\r\n\t\t\t\t\t\tif o_match_col_fields.length == 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åŽŸç”³è¯·å•å­è¡¨æ— å¯¹åº”åŒ¹é…åˆ—');\r\n\r\n\t\t\t\t\t\tif d_match_col_fields.length == 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å­è¡¨æ— å¯¹åº”åŒ¹é…åˆ—');\r\n\r\n\t\t\t\t\t\t# åˆ¤æ–­åŒ¹é…åˆ—å­—æ®µçš„å€¼ç±»åž‹æ˜¯å¦ä¸€è‡´\r\n\t\t\t\t\t\to_match_col_field = o_match_col_fields[0]\r\n\t\t\t\t\t\td_match_col_field = d_match_col_fields[0]\r\n\r\n\t\t\t\t\t\tif o_match_col_field?.type != d_match_col_field?.type\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å’ŒåŽŸç”³è¯·å•å­è¡¨çš„åŒ¹é…åˆ—å­—æ®µä¸ä¸€è‡´');\r\n\r\n\t\t\t\t\t\t# å›žå¡«åˆ—åˆ¤æ–­\r\n\t\t\t\t\t\tcolumns.forEach (column)->\r\n\t\t\t\t\t\t\tcols = column.split('-') || []\r\n\t\t\t\t\t\t\tif cols.length == 2\r\n\t\t\t\t\t\t\t\to_col = cols[0]\r\n\t\t\t\t\t\t\t\td_col = cols[1]\r\n\t\t\t\t\t\t\t\to_col_fields = o_subtable_fields.filter((m)->return m.code==o_col)\r\n\t\t\t\t\t\t\t\td_col_fields = d_subtable_fields.filter((m)->return m.code==d_col)\r\n\r\n\t\t\t\t\t\t\t\t# åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„å›žå¡«åˆ—\r\n\t\t\t\t\t\t\t\tif o_col_fields.length == 0\r\n\t\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åŽŸç”³è¯·å•å­è¡¨æ— å¯¹åº”å›žå¡«åˆ—');\r\n\r\n\t\t\t\t\t\t\t\tif d_col_fields.length == 0\r\n\t\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å­è¡¨æ— å¯¹åº”å›žå¡«åˆ—');\r\n\r\n\t\t\t\t\t\t\t\t# åˆ¤æ–­åŒ¹é…åˆ—å­—æ®µçš„å€¼ç±»åž‹æ˜¯å¦ä¸€è‡´\r\n\t\t\t\t\t\t\t\tif o_col_fields?.type != d_col_fields?.type\r\n\t\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'å›žå¡«åˆ—å­—æ®µç±»åž‹ä¸ä¸€è‡´');\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tcol = {\r\n\t\t\t\t\t\t\t\t\to_col: o_col,\r\n\t\t\t\t\t\t\t\t\td_col: d_col\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tcolumn_list.push col\r\n\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'å›žå¡«åˆ—ä¸åŒ¹é…');\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t# èµ‹å€¼\r\n\t\t\t\t\t\t# console.log  '======column_list=======',column_list\r\n\r\n\t\t\t\t\t\ttraces = o_ins?.traces\r\n\r\n\t\t\t\t\t\t# åŽŸç”³è¯·å•çš„ step \r\n\t\t\t\t\t\ttrace = traces[traces.length-1]\r\n\r\n\t\t\t\t\t\t# åŽŸç”³è¯·å•çš„å½“å‰æ­¥éª¤\r\n\t\t\t\t\t\tapprove = trace?.approves[0]\r\n\r\n\t\t\t\t\t\t# å…ƒç”³è¯·å•çš„å½“å‰ value çš„ å­è¡¨\r\n\t\t\t\t\t\ttable_data = approve?.values[o_table] || []\r\n\r\n\r\n\t\t\t\t\t\t# æ ¹æ® column_list èµ‹å€¼å¯¹åº”å­—æ®µè¿›è¡Œèµ‹å€¼\r\n\t\t\t\t\t\t# å¾ªçŽ¯åˆ†å‘ç”³è¯·å•çš„æ¯è¡Œ\r\n\t\t\t\t\t\td_table_values.forEach (d_row)->\r\n\t\t\t\t\t\t\t# console.log \"d_row\",d_row\r\n\t\t\t\t\t\t\t# æŸ¥æ‰¾åŒ¹é…çš„åˆ—æ˜¯å¦ä¸Žå½“å‰çš„åŒ¹é…åˆ—ä¸€è‡´\r\n\t\t\t\t\t\t\thas_obj = false\r\n\t\t\t\t\t\t\tcount = -1\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t# çœ‹åŽŸå­è¡¨æ˜¯å¦æœ‰è¯¥åŒ¹é…åˆ—\r\n\t\t\t\t\t\t\ttable_data.forEach (o_row, index)->\r\n\t\t\t\t\t\t\t\t# console.log \"o_row\", o_row\r\n\t\t\t\t\t\t\t\t# console.log \"index\",index\r\n\t\t\t\t\t\t\t\t# console.log \"o_row[o_match_col]\",o_row[o_match_col]\r\n\t\t\t\t\t\t\t\t# console.log \"d_row[d_match_col]\",d_row[d_match_col]\r\n\t\t\t\t\t\t\t\t# console.log \"o_row[o_match_col] == d_row[d_match_col]\",o_row[o_match_col] == d_row[d_match_col]\r\n\r\n\t\t\t\t\t\t\t\tif o_row[o_match_col] == d_row[d_match_col]\r\n\t\t\t\t\t\t\t\t\thas_obj = true\r\n\t\t\t\t\t\t\t\t\tcount = index\r\n\r\n\t\t\t\t\t\t\t# åŽŸç”³è¯·å•çš„åŒ¹é…å­—æ®µæœ‰å€¼\r\n\t\t\t\t\t\t\t# console.log \"has_obj\",has_obj\r\n\t\t\t\t\t\t\tif has_obj==true\r\n\t\t\t\t\t\t\t\tcolumn_list.forEach (col)->\r\n\t\t\t\t\t\t\t\t\ttable_data[count][col?.o_col] = d_row[col?.d_col]\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\trow_data = {}\r\n\t\t\t\t\t\t\t\trow_data[o_match_col] = d_row[d_match_col]\r\n\t\t\t\t\t\t\t\tcolumn_list.forEach (col)->\r\n\t\t\t\t\t\t\t\t\trow_data[col?.o_col] = d_row[col?.d_col]\r\n\t\t\t\t\t\t\t\ttable_data.push row_data\r\n\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\ttraces[traces.length-1].approves[0].values = o_ins?.values\r\n\t\t\t\t\t\ttraces[traces.length-1].approves[0].values[o_table] = table_data\r\n\r\n\t\t\t\t\t\tdb.instances.update(o_ins_id,{\r\n\t\t\t\t\t\t\t$set:{\r\n\t\t\t\t\t\t\t\t'traces':traces\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t\tJsonRoutes.sendResult res, {\r\n\t\t\t\t\t\t\tcode: 200,\r\n\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\t'success': 'å›žå¡«æˆåŠŸ'\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'webhookæœªé…ç½®å­è¡¨å›žå¡«åˆ—å­—æ®µ columns å€¼');\r\n\t\t\t\telse\r\n\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'webhookæœªé…ç½®åŒ¹é…åˆ—å­—æ®µ oMatchCol å€¼');\r\n\t\t\telse\r\n\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'webhookæœªé…ç½®åŽŸè¡¨å•å­è¡¨ oTable å€¼');\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('forward table refill error!', 'ç”³è¯·å•æœªç»“æŸ');\r\n\tcatch e\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\terrors: [e]\r\n\t\t\t}\r\n\t\t}\r\n)","JsonRoutes.add(\"post\", \"/api/workflow/forward_table_refill\", function(req, res, next) {\n  var a_table, a_table_values, approve, column_list, columns, d_ins, d_ins_fields, d_ins_form, d_ins_values, d_match_col, d_match_col_field, d_match_col_fields, d_subtable_fields, d_table, d_table_values, e, o_ins, o_ins_fields, o_ins_form, o_ins_id, o_match_col, o_match_col_field, o_match_col_fields, o_subtable_fields, o_table, ref, ref1, ref10, ref11, ref12, ref13, ref14, ref15, ref16, ref17, ref18, ref19, ref2, ref20, ref21, ref22, ref3, ref4, ref5, ref6, ref7, ref8, ref9, table_data, trace, traces;\n  try {\n    console.log(\"=========åŽŸè¡¨å­è¡¨==========\");\n    console.log(\"req?.query?.oTable\", req != null ? (ref = req.query) != null ? ref.oTable : void 0 : void 0);\n    console.log(\"=========çŽ°è¡¨å­è¡¨==========\");\n    console.log(\"req?.query?.dTable\", req != null ? (ref1 = req.query) != null ? ref1.dTable : void 0 : void 0);\n    console.log(\"=========åŽŸè¡¨å•çš„å­è¡¨åŒ¹é…åˆ—==========\");\n    console.log(\"req?.query?.oMatchCol\", req != null ? (ref2 = req.query) != null ? ref2.oMatchCol : void 0 : void 0);\n    console.log(\"=========çŽ°è¡¨å•çš„å­è¡¨åŒ¹é…åˆ—==========\");\n    console.log(\"req?.query?.dMatchCol\", req != null ? (ref3 = req.query) != null ? ref3.dMatchCol : void 0 : void 0);\n    console.log(\"=========éœ€è¦å›žå¡«çš„åˆ—==========\");\n    console.log(\"req?.query?.refillCol\", req != null ? (ref4 = req.query) != null ? ref4.refillCol : void 0 : void 0);\n    d_ins = req != null ? (ref5 = req.body) != null ? ref5.instance : void 0 : void 0;\n    if ((d_ins != null ? d_ins.state : void 0) === \"completed\") {\n      if (req != null ? (ref6 = req.query) != null ? ref6.oTable : void 0 : void 0) {\n        o_table = req != null ? (ref7 = req.query) != null ? ref7.oTable : void 0 : void 0;\n        if (req != null ? (ref8 = req.query) != null ? ref8.dTable : void 0 : void 0) {\n          d_table = req != null ? (ref9 = req.query) != null ? ref9.dTable : void 0 : void 0;\n        } else {\n          d_table = o_table;\n        }\n        if (req != null ? (ref10 = req.query) != null ? ref10.aTable : void 0 : void 0) {\n          a_table = req != null ? (ref11 = req.query) != null ? ref11.aTable : void 0 : void 0;\n        }\n        if (req != null ? (ref12 = req.query) != null ? ref12.oMatchCol : void 0 : void 0) {\n          o_match_col = req != null ? (ref13 = req.query) != null ? ref13.oMatchCol : void 0 : void 0;\n          if (req != null ? (ref14 = req.query) != null ? ref14.dMatchCol : void 0 : void 0) {\n            d_match_col = req != null ? (ref15 = req.query) != null ? ref15.dMatchCol : void 0 : void 0;\n          } else {\n            d_match_col = o_match_col;\n          }\n          columns = (req != null ? (ref16 = req.query) != null ? ref16.refillCol.split(';') : void 0 : void 0) || [];\n          console.log(\"columns\", columns);\n          if (columns || columns.length < 1) {\n            console.log(\"======================\");\n            console.log(d_table, o_match_col, columns);\n            d_ins_values = d_ins != null ? d_ins.values : void 0;\n            o_ins_id = _.last(d_ins != null ? d_ins.distribute_from_instances : void 0);\n            o_ins = db.instances.findOne(o_ins_id);\n            o_ins_form = db.forms.findOne(o_ins != null ? o_ins.form : void 0);\n            d_ins_form = db.forms.findOne(d_ins != null ? d_ins.form : void 0);\n            o_ins_fields = [];\n            o_subtable_fields = [];\n            d_ins_fields = [];\n            d_subtable_fields = [];\n            column_list = [];\n            d_table_values = [];\n            if ((o_ins != null ? o_ins.form_version : void 0) === (o_ins_form != null ? (ref17 = o_ins_form.current) != null ? ref17._id : void 0 : void 0)) {\n              o_ins_fields = o_ins_form != null ? (ref18 = o_ins_form.current) != null ? ref18.fields : void 0 : void 0;\n              o_ins_fields.forEach(function(o_ins_field) {\n                if ((o_ins_field != null ? o_ins_field.type : void 0) === 'table' && (o_ins_field != null ? o_ins_field.code : void 0) === o_table) {\n                  return o_subtable_fields = o_ins_field != null ? o_ins_field.fields : void 0;\n                }\n              });\n            } else {\n              if ((o_ins_form != null ? (ref19 = o_ins_form.historys) != null ? ref19.length : void 0 : void 0) > 0) {\n                o_ins_form.historys.forEach(function(oh) {\n                  if ((o_ins != null ? o_ins.form_version : void 0) === oh._id) {\n                    o_ins_fields = oh != null ? oh.fields : void 0;\n                    return o_ins_fields.forEach(function(o_ins_field) {\n                      if ((o_ins_field != null ? o_ins_field.type : void 0) === 'table' && (o_ins_field != null ? o_ins_field.code : void 0) === o_table) {\n                        return o_subtable_fields = o_ins_field != null ? o_ins_field.fields : void 0;\n                      }\n                    });\n                  }\n                });\n              }\n            }\n            if ((d_ins != null ? d_ins.form_version : void 0) === (d_ins_form != null ? (ref20 = d_ins_form.current) != null ? ref20._id : void 0 : void 0)) {\n              d_ins_fields = d_ins_form != null ? (ref21 = d_ins_form.current) != null ? ref21.fields : void 0 : void 0;\n              d_ins_fields.forEach(function(d_ins_field) {\n                if (((d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === d_table) || (a_table && (d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === a_table)) {\n                  return d_subtable_fields = d_subtable_fields.concat(d_ins_field != null ? d_ins_field.fields : void 0);\n                }\n              });\n            } else {\n              if ((d_ins_form != null ? (ref22 = d_ins_form.historys) != null ? ref22.length : void 0 : void 0) > 0) {\n                d_ins_form.historys.forEach(function(dh) {\n                  if ((d_ins != null ? d_ins.form_version : void 0) === dh._id) {\n                    d_ins_fields = dh != null ? dh.fields : void 0;\n                    return d_ins_fields.forEach(function(d_ins_field) {\n                      if (((d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === d_table) || (a_table && (d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === a_table)) {\n                        return d_subtable_fields = d_subtable_fields.concat(d_ins_field != null ? d_ins_field.fields : void 0);\n                      }\n                    });\n                  }\n                });\n              }\n            }\n            if (o_subtable_fields.length === 0) {\n              console.log(\"o_subtable_fields\", o_subtable_fields);\n              throw new Meteor.Error('forward table refill error!', 'åŽŸç”³è¯·å•æ— å¯¹åº”å­è¡¨');\n            }\n            if (d_subtable_fields.length === 0) {\n              throw new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•æ— å¯¹åº”å­è¡¨');\n            }\n            d_table_values = (d_ins != null ? d_ins.values[d_table] : void 0) || [];\n            if (a_table) {\n              a_table_values = (d_ins != null ? d_ins.values[a_table] : void 0) || [];\n              if (a_table_values && (a_table_values != null ? a_table_values.length : void 0) === (d_table_values != null ? d_table_values.length : void 0)) {\n                a_table_values.forEach(function(a_row, index) {\n                  var key, results, value;\n                  results = [];\n                  for (key in a_row) {\n                    value = a_row[key];\n                    results.push(d_table_values[index][key] = value);\n                  }\n                  return results;\n                });\n              }\n            }\n            if (d_table_values.length === 0) {\n              throw new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å­è¡¨æ•°æ®ä¸ºç©º');\n            }\n            o_match_col_fields = o_subtable_fields.filter(function(m) {\n              return m.code === o_match_col;\n            });\n            d_match_col_fields = d_subtable_fields.filter(function(m) {\n              return m.code === d_match_col;\n            });\n            if (o_match_col_fields.length === 0) {\n              throw new Meteor.Error('forward table refill error!', 'åŽŸç”³è¯·å•å­è¡¨æ— å¯¹åº”åŒ¹é…åˆ—');\n            }\n            if (d_match_col_fields.length === 0) {\n              throw new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å­è¡¨æ— å¯¹åº”åŒ¹é…åˆ—');\n            }\n            o_match_col_field = o_match_col_fields[0];\n            d_match_col_field = d_match_col_fields[0];\n            if ((o_match_col_field != null ? o_match_col_field.type : void 0) !== (d_match_col_field != null ? d_match_col_field.type : void 0)) {\n              throw new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å’ŒåŽŸç”³è¯·å•å­è¡¨çš„åŒ¹é…åˆ—å­—æ®µä¸ä¸€è‡´');\n            }\n            columns.forEach(function(column) {\n              var col, cols, d_col, d_col_fields, o_col, o_col_fields;\n              cols = column.split('-') || [];\n              if (cols.length === 2) {\n                o_col = cols[0];\n                d_col = cols[1];\n                o_col_fields = o_subtable_fields.filter(function(m) {\n                  return m.code === o_col;\n                });\n                d_col_fields = d_subtable_fields.filter(function(m) {\n                  return m.code === d_col;\n                });\n                if (o_col_fields.length === 0) {\n                  throw new Meteor.Error('forward table refill error!', 'åŽŸç”³è¯·å•å­è¡¨æ— å¯¹åº”å›žå¡«åˆ—');\n                }\n                if (d_col_fields.length === 0) {\n                  throw new Meteor.Error('forward table refill error!', 'åˆ†å‘çš„ç”³è¯·å•å­è¡¨æ— å¯¹åº”å›žå¡«åˆ—');\n                }\n                if ((o_col_fields != null ? o_col_fields.type : void 0) !== (d_col_fields != null ? d_col_fields.type : void 0)) {\n                  throw new Meteor.Error('forward table refill error!', 'å›žå¡«åˆ—å­—æ®µç±»åž‹ä¸ä¸€è‡´');\n                }\n                col = {\n                  o_col: o_col,\n                  d_col: d_col\n                };\n                return column_list.push(col);\n              } else {\n                throw new Meteor.Error('forward table refill error!', 'å›žå¡«åˆ—ä¸åŒ¹é…');\n              }\n            });\n            traces = o_ins != null ? o_ins.traces : void 0;\n            trace = traces[traces.length - 1];\n            approve = trace != null ? trace.approves[0] : void 0;\n            table_data = (approve != null ? approve.values[o_table] : void 0) || [];\n            d_table_values.forEach(function(d_row) {\n              var count, has_obj, row_data;\n              has_obj = false;\n              count = -1;\n              table_data.forEach(function(o_row, index) {\n                if (o_row[o_match_col] === d_row[d_match_col]) {\n                  has_obj = true;\n                  return count = index;\n                }\n              });\n              if (has_obj === true) {\n                return column_list.forEach(function(col) {\n                  return table_data[count][col != null ? col.o_col : void 0] = d_row[col != null ? col.d_col : void 0];\n                });\n              } else {\n                row_data = {};\n                row_data[o_match_col] = d_row[d_match_col];\n                column_list.forEach(function(col) {\n                  return row_data[col != null ? col.o_col : void 0] = d_row[col != null ? col.d_col : void 0];\n                });\n                return table_data.push(row_data);\n              }\n            });\n            traces[traces.length - 1].approves[0].values = o_ins != null ? o_ins.values : void 0;\n            traces[traces.length - 1].approves[0].values[o_table] = table_data;\n            db.instances.update(o_ins_id, {\n              $set: {\n                'traces': traces\n              }\n            });\n            JsonRoutes.sendResult(res, {\n              code: 200,\n              data: {\n                'success': 'å›žå¡«æˆåŠŸ'\n              }\n            });\n          } else {\n            throw new Meteor.Error('forward table refill error!', 'webhookæœªé…ç½®å­è¡¨å›žå¡«åˆ—å­—æ®µ columns å€¼');\n          }\n        } else {\n          throw new Meteor.Error('forward table refill error!', 'webhookæœªé…ç½®åŒ¹é…åˆ—å­—æ®µ oMatchCol å€¼');\n        }\n      } else {\n        throw new Meteor.Error('forward table refill error!', 'webhookæœªé…ç½®åŽŸè¡¨å•å­è¡¨ oTable å€¼');\n      }\n    } else {\n      throw new Meteor.Error('forward table refill error!', 'ç”³è¯·å•æœªç»“æŸ');\n    }\n  } catch (error) {\n    e = error;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [e]\n      }\n    });\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/sub_table_sort\", (req, res, next) ->\r\n\ttry\r\n        console.log \"=========å­è¡¨==========\"\r\n        console.log \"req?.query?.subTable\",req?.query?.subTable\r\n        console.log \"=========å­è¡¨æ€»åˆ†åˆ—==========\"\r\n        console.log \"req?.query?.sumCol\",req?.query?.sumCol\r\n        console.log \"=========å­è¡¨æŽ’åºåˆ—==========\"\r\n        console.log \"req?.query?.sortCol\",req?.query?.sortCol\r\n        console.log \"=========å­è¡¨å•åˆ—éœ€è¦è®¡ç®—çš„å’Œ==========\"\r\n        console.log \"req?.query?.singleCols\",req?.query?.singleCols\r\n        \r\n        \r\n        sub_table = req?.query?.subTable\r\n        if !sub_table\r\n            console.log \"=====sub_table======\"\r\n            throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® subTable å­—æ®µ' );\r\n        \r\n        sum_col = req?.query?.sumCol\r\n        if !sum_col\r\n            console.log \"=====sum_col======\"\r\n            throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® sumCol å­—æ®µ' );\r\n        \r\n        sort_col = req?.query?.sortCol\r\n        if !sort_col\r\n            console.log \"=====sort_col======\"\r\n            throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® sortCol å­—æ®µ' );\r\n        \r\n        # single_cols = req?.query?.singleCols\r\n        # if !single_cols\r\n        #     console.log \"=====single_cols======\"\r\n\r\n        #     throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® singleCols å­—æ®µ' );\r\n        \r\n        ins = req?.body?.instance\r\n        \r\n        sub_table_values = ins.values[sub_table]\r\n        \r\n        if sub_table_values?.length > 0 \r\n            # # æ ¹æ® sub_table_values è¿›è¡ŒæŽ’åº\r\n            # ======================\r\n            # æŽ’åºå­—æ®µï¼Œå…³é”®å­—ï¼Œæ­£åº(true)/å€’åº(false)\r\n            `function JsonSort(jsonArr, key, asc){\r\n                for(var j=1,jl=jsonArr.length;j < jl;j++){\r\n                    var temp = jsonArr[j],\r\n                        val  = Number(temp[key]),\r\n                        i    = j-1;\r\n                    if(asc==true){\r\n                        while(i >=0 && Number(jsonArr[i][key])>val){\r\n                            jsonArr[i+1] = jsonArr[i];\r\n                            i = i-1;    \r\n                        }\r\n                    }else{\r\n                        while(i >=0 && Number(jsonArr[i][key])<val){\r\n                            jsonArr[i+1] = jsonArr[i];\r\n                            i = i-1;    \r\n                        }\r\n                    }\r\n                    jsonArr[i+1] = temp;\r\n                }\r\n                return jsonArr;\r\n            }`\r\n            \r\n            new_table_values = JsonSort(sub_table_values,sum_col,false)\r\n\r\n            console.log \"new_table_values\",new_table_values\r\n\r\n            new_table_values.forEach (obj, index)->\r\n                if sort_col and obj[sum_col]\r\n                    obj[sort_col] = (index+1).toString()\r\n            \r\n            console.log \"new_table_values\",new_table_values\r\n\r\n            ins.values[sub_table] = new_table_values\r\n\r\n            db.instances.update(ins._id,{\r\n                $set:{\r\n                    'values':ins.values\r\n                    }\r\n                })\r\n\r\n            console.log \"success\"\r\n            JsonRoutes.sendResult res, {\r\n                code: 200,\r\n                data: {\r\n                    'success': 'è®¡ç®—æŽ’åºæˆåŠŸ'\r\n                }\r\n            }\r\n        else\r\n            throw new Meteor.Error('table sort error!', 'å­è¡¨æ•°æ®ä¸ºç©º');\r\n    catch e\r\n        JsonRoutes.sendResult res, {\r\n            code: 200,\r\n            data: {\r\n                errors: [e]\r\n            }\r\n        }\r\n)","JsonRoutes.add(\"post\", \"/api/workflow/sub_table_sort\", function(req, res, next) {\n  var e, ins, new_table_values, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, sort_col, sub_table, sub_table_values, sum_col;\n  try {\n    console.log(\"=========å­è¡¨==========\");\n    console.log(\"req?.query?.subTable\", req != null ? (ref = req.query) != null ? ref.subTable : void 0 : void 0);\n    console.log(\"=========å­è¡¨æ€»åˆ†åˆ—==========\");\n    console.log(\"req?.query?.sumCol\", req != null ? (ref1 = req.query) != null ? ref1.sumCol : void 0 : void 0);\n    console.log(\"=========å­è¡¨æŽ’åºåˆ—==========\");\n    console.log(\"req?.query?.sortCol\", req != null ? (ref2 = req.query) != null ? ref2.sortCol : void 0 : void 0);\n    console.log(\"=========å­è¡¨å•åˆ—éœ€è¦è®¡ç®—çš„å’Œ==========\");\n    console.log(\"req?.query?.singleCols\", req != null ? (ref3 = req.query) != null ? ref3.singleCols : void 0 : void 0);\n    sub_table = req != null ? (ref4 = req.query) != null ? ref4.subTable : void 0 : void 0;\n    if (!sub_table) {\n      console.log(\"=====sub_table======\");\n      throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® subTable å­—æ®µ');\n    }\n    sum_col = req != null ? (ref5 = req.query) != null ? ref5.sumCol : void 0 : void 0;\n    if (!sum_col) {\n      console.log(\"=====sum_col======\");\n      throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® sumCol å­—æ®µ');\n    }\n    sort_col = req != null ? (ref6 = req.query) != null ? ref6.sortCol : void 0 : void 0;\n    if (!sort_col) {\n      console.log(\"=====sort_col======\");\n      throw new Meteor.Error('table sort error!', 'webhook æœªé…ç½® sortCol å­—æ®µ');\n    }\n    ins = req != null ? (ref7 = req.body) != null ? ref7.instance : void 0 : void 0;\n    sub_table_values = ins.values[sub_table];\n    if ((sub_table_values != null ? sub_table_values.length : void 0) > 0) {\n      function JsonSort(jsonArr, key, asc){\n                for(var j=1,jl=jsonArr.length;j < jl;j++){\n                    var temp = jsonArr[j],\n                        val  = Number(temp[key]),\n                        i    = j-1;\n                    if(asc==true){\n                        while(i >=0 && Number(jsonArr[i][key])>val){\n                            jsonArr[i+1] = jsonArr[i];\n                            i = i-1;    \n                        }\n                    }else{\n                        while(i >=0 && Number(jsonArr[i][key])<val){\n                            jsonArr[i+1] = jsonArr[i];\n                            i = i-1;    \n                        }\n                    }\n                    jsonArr[i+1] = temp;\n                }\n                return jsonArr;\n            };\n      new_table_values = JsonSort(sub_table_values, sum_col, false);\n      console.log(\"new_table_values\", new_table_values);\n      new_table_values.forEach(function(obj, index) {\n        if (sort_col && obj[sum_col]) {\n          return obj[sort_col] = (index + 1).toString();\n        }\n      });\n      console.log(\"new_table_values\", new_table_values);\n      ins.values[sub_table] = new_table_values;\n      db.instances.update(ins._id, {\n        $set: {\n          'values': ins.values\n        }\n      });\n      console.log(\"success\");\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          'success': 'è®¡ç®—æŽ’åºæˆåŠŸ'\n        }\n      });\n    } else {\n      throw new Meteor.Error('table sort error!', 'å­è¡¨æ•°æ®ä¸ºç©º');\n    }\n  } catch (error) {\n    e = error;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [e]\n      }\n    });\n  }\n});\n","if Meteor.isDevelopment\r\n    JsonRoutes.add 'post', '/test/webhook', (req, res, next) ->\r\n        try\r\n\r\n            hashData = req.body\r\n            console.log 'action: ', hashData.action\r\n            console.log 'from_user: ', hashData.from_user\r\n            console.log 'to_users: ', hashData.to_users\r\n\r\n\r\n            JsonRoutes.sendResult res,\r\n                    code: 200\r\n                    data: {}\r\n        catch e\r\n            console.error e.stack\r\n            JsonRoutes.sendResult res,\r\n                code: 200\r\n                data: { errors: [{errorMessage: e.message}] }","if (Meteor.isDevelopment) {\n  JsonRoutes.add('post', '/test/webhook', function(req, res, next) {\n    var e, hashData;\n    try {\n      hashData = req.body;\n      console.log('action: ', hashData.action);\n      console.log('from_user: ', hashData.from_user);\n      console.log('to_users: ', hashData.to_users);\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {}\n      });\n    } catch (error) {\n      e = error;\n      console.error(e.stack);\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          errors: [\n            {\n              errorMessage: e.message\n            }\n          ]\n        }\n      });\n    }\n  });\n}\n","JsonRoutes.add(\"post\", \"/api/formula/users\", (req, res, next) ->\r\n\r\n\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\tcurrent_user = current_user_info._id\r\n\r\n\tuserIds = req.body.userIds\r\n\tspaceId = req.body.spaceId\r\n\tspaceUsers = [];\r\n\r\n\tspace_user = db.space_users.findOne({user: current_user, space: spaceId}, {fields: {_id: 1}})\r\n\tif !space_user\r\n\t\treturn JsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'errors': 'æ— æƒé™'\r\n\t\t\t}\r\n\t\t});\r\n\r\n\tif (!userIds || !spaceId)\r\n\t\treturn JsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'errors': 'ç¼ºå°‘å‚æ•°'\r\n\t\t\t}\r\n\t\t});\r\n\tspaceUsers = WorkflowManager.getFormulaUserObjects(spaceId, userIds)\r\n\r\n\tJsonRoutes.sendResult res, {\r\n\t\tcode: 200,\r\n\t\tdata: {\r\n\t\t\t'spaceUsers': spaceUsers\r\n\t\t}\r\n\t}\r\n)","JsonRoutes.add(\"post\", \"/api/formula/users\", function(req, res, next) {\n  var current_user, current_user_info, spaceId, spaceUsers, space_user, userIds;\n  current_user_info = uuflowManager.check_authorization(req);\n  current_user = current_user_info._id;\n  userIds = req.body.userIds;\n  spaceId = req.body.spaceId;\n  spaceUsers = [];\n  space_user = db.space_users.findOne({\n    user: current_user,\n    space: spaceId\n  }, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (!space_user) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': 'æ— æƒé™'\n      }\n    });\n  }\n  if (!userIds || !spaceId) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': 'ç¼ºå°‘å‚æ•°'\n      }\n    });\n  }\n  spaceUsers = WorkflowManager.getFormulaUserObjects(spaceId, userIds);\n  return JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      'spaceUsers': spaceUsers\n    }\n  });\n});\n","JsonRoutes.add(\"post\", \"/api/formula/orgs\", (req, res, next) ->\r\n\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\tcurrent_user = current_user_info._id\r\n\torgIds = req.body.orgIds\r\n\tspaceId = req.body.spaceId\r\n\r\n\tspace_user = db.space_users.findOne({user: current_user, space: spaceId}, {fields: {_id: 1}})\r\n\tif !space_user\r\n\t\treturn JsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'errors': 'æ— æƒé™'\r\n\t\t\t}\r\n\t\t});\r\n\r\n\tif (!orgIds || !spaceId)\r\n\t\treturn JsonRoutes.sendResult(res, {\r\n\t\t\tcode: 200,\r\n\t\t\tdata: {\r\n\t\t\t\t'errors': 'ç¼ºå°‘å‚æ•°'\r\n\t\t\t}\r\n\t\t});\r\n\r\n\torgs = WorkflowManager.getFormulaOrgObjects(orgIds)\r\n\r\n\tJsonRoutes.sendResult(res, {\r\n\t\tcode: 200,\r\n\t\tdata: {\r\n\t\t\t'orgs': orgs\r\n\t\t}\r\n\t});\r\n)","JsonRoutes.add(\"post\", \"/api/formula/orgs\", function(req, res, next) {\n  var current_user, current_user_info, orgIds, orgs, spaceId, space_user;\n  current_user_info = uuflowManager.check_authorization(req);\n  current_user = current_user_info._id;\n  orgIds = req.body.orgIds;\n  spaceId = req.body.spaceId;\n  space_user = db.space_users.findOne({\n    user: current_user,\n    space: spaceId\n  }, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (!space_user) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': 'æ— æƒé™'\n      }\n    });\n  }\n  if (!orgIds || !spaceId) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': 'ç¼ºå°‘å‚æ•°'\n      }\n    });\n  }\n  orgs = WorkflowManager.getFormulaOrgObjects(orgIds);\n  return JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      'orgs': orgs\n    }\n  });\n});\n","Meteor.methods\r\n\tset_instance_step_approve: (ins_id, step_approve, stepsApprovesOptions)->\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tins = db.instances.findOne({_id: ins_id}, {fields: {state: 1}})\r\n\r\n\t\tif ins.state != 'draft'\r\n\t\t\treturn ;\r\n\r\n\t\t_keys1 = _.keys(step_approve);\r\n\t\t_keys2 = _.keys(stepsApprovesOptions);\r\n\r\n\t\tkeys = _.compact(_.union(_keys1, _keys2));\r\n\r\n\t\tstepsApproves = {};\r\n\r\n\t\t_.each keys, (stepId)->\r\n\t\t\tstepApproves = step_approve[stepId]\r\n\t\t\tstepsApproveOptions = stepsApprovesOptions[stepId]\r\n\t\t\tif stepApproves\r\n\t\t\t\tstepsApproves[stepId] = stepApproves\r\n\t\t\t\tif stepsApproveOptions\r\n\t\t\t\t\tif _.isArray(stepApproves)\r\n\t\t\t\t\t\tstepsApproveOptions = stepApproves.concat(stepsApproveOptions)\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tstepsApproveOptions.push(stepApproves)\r\n\t\t\tif stepsApproveOptions\r\n\t\t\t\tstepsApproves[stepId + '_options'] = _.uniq(stepsApproveOptions)\r\n\t\tdb.instances.update {_id: ins_id}, {$set: {step_approve: stepsApproves}}\r\n\tset_instance_skip_steps: (ins_id, stepId, action)->\r\n\t\tif action == 'pull'\r\n\t\t\tdb.instances.update {_id: ins_id}, {$pull: {skip_steps: stepId}}\r\n\t\telse if action == 'push'\r\n\t\t\tdb.instances.update {_id: ins_id}, {$push: {skip_steps: stepId}}","Meteor.methods({\n  set_instance_step_approve: function(ins_id, step_approve, stepsApprovesOptions) {\n    var _keys1, _keys2, ins, keys, stepsApproves;\n    if (!this.userId) {\n      return;\n    }\n    ins = db.instances.findOne({\n      _id: ins_id\n    }, {\n      fields: {\n        state: 1\n      }\n    });\n    if (ins.state !== 'draft') {\n      return;\n    }\n    _keys1 = _.keys(step_approve);\n    _keys2 = _.keys(stepsApprovesOptions);\n    keys = _.compact(_.union(_keys1, _keys2));\n    stepsApproves = {};\n    _.each(keys, function(stepId) {\n      var stepApproves, stepsApproveOptions;\n      stepApproves = step_approve[stepId];\n      stepsApproveOptions = stepsApprovesOptions[stepId];\n      if (stepApproves) {\n        stepsApproves[stepId] = stepApproves;\n        if (stepsApproveOptions) {\n          if (_.isArray(stepApproves)) {\n            stepsApproveOptions = stepApproves.concat(stepsApproveOptions);\n          } else {\n            stepsApproveOptions.push(stepApproves);\n          }\n        }\n      }\n      if (stepsApproveOptions) {\n        return stepsApproves[stepId + '_options'] = _.uniq(stepsApproveOptions);\n      }\n    });\n    return db.instances.update({\n      _id: ins_id\n    }, {\n      $set: {\n        step_approve: stepsApproves\n      }\n    });\n  },\n  set_instance_skip_steps: function(ins_id, stepId, action) {\n    if (action === 'pull') {\n      return db.instances.update({\n        _id: ins_id\n      }, {\n        $pull: {\n          skip_steps: stepId\n        }\n      });\n    } else if (action === 'push') {\n      return db.instances.update({\n        _id: ins_id\n      }, {\n        $push: {\n          skip_steps: stepId\n        }\n      });\n    }\n  }\n});\n","Meteor.methods({\r\n\r\n\tget_instance_data: function (instance_id, formCached, flowCached) {\r\n\r\n\t\tcheck(instance_id, String);\r\n\t\tcheck(formCached, Boolean);\r\n\t\tcheck(flowCached, Boolean);\r\n\r\n\t\tvar instance = db.instances.findOne(instance_id);\r\n\r\n\t\tif (!instance)\r\n\t\t\treturn {\r\n\t\t\t\tinstance: null\r\n\t\t\t};\r\n\r\n\t\tif (formCached && flowCached)\r\n\t\t\treturn {\r\n\t\t\t\tinstance: instance\r\n\t\t\t};\r\n\r\n\t\tif (!formCached) {\r\n\t\t\tvar form = db.forms.findOne(instance.form);\r\n\t\t\tvar form_version = {};\r\n\t\t\tif (form.current._id == instance.form_version) {\r\n\t\t\t\tform_version = form.current;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tform_version = _.where(form.historys, {_id: instance.form_version})[0];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\tif (!flowCached) {\r\n\t\t\tvar flow = db.flows.findOne(instance.flow);\r\n\t\t\tvar flow_version = {};\r\n\t\t\tif (flow.current._id == instance.flow_version) {\r\n\t\t\t\tflow_version = flow.current;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tflow_version = _.where(flow.historys, {_id: instance.flow_version})[0];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tinstance: instance,\r\n\t\t\tform_version: form_version,\r\n\t\t\tflow_version: flow_version\r\n\t\t}\r\n\r\n\t}\r\n\r\n});\r\n","Meteor.methods({\r\n\r\n\tdraft_save_instance: function (ins) {\r\n\t\tif (!this.userId)\r\n\t\t\treturn;\r\n\t\tvar result = true;\r\n\t\tvar setObj = {};\r\n\t\tvar index = 0;\r\n\t\tvar ins_id = ins._id;\r\n\t\tvar trace_id = ins.traces[0]._id;\r\n\t\tvar approve_id = ins.traces[0].approves[0]._id;\r\n\t\tvar description = ins.traces[0].approves[0].description;\r\n\t\tvar next_steps = ins.traces[0].approves[0].next_steps;\r\n\t\tvar values = ins.traces[0].approves[0].values || {};\r\n\t\tvar applicant_id = ins.applicant;\r\n\r\n\t\tvar instance = db.instances.findOne(ins_id, {\r\n\t\t\tfields: {\r\n\t\t\t\tapplicant: 1,\r\n\t\t\t\tstate: 1,\r\n\t\t\t\tsubmitter: 1,\r\n\t\t\t\ttraces: 1,\r\n\t\t\t\tform: 1,\r\n\t\t\t\tflow_version: 1,\r\n\t\t\t\tspace: 1,\r\n\t\t\t\tflow: 1\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tvar space_id = instance.space;\r\n\t\tvar flow_id = instance.flow;\r\n\t\tvar form_id = instance.form;\r\n\t\tvar traces = instance.traces;\r\n\t\tvar current_trace = _.find(traces, function (t) {\r\n\t\t\treturn t._id == trace_id;\r\n\t\t});\r\n\t\tcurrent_trace.approves.forEach(function (a, idx) {\r\n\t\t\tif (a._id == approve_id) {\r\n\t\t\t\tindex = idx;\r\n\t\t\t}\r\n\t\t})\r\n\t\tvar key_str = 'traces.$.approves.' + index + '.';\r\n\r\n\t\t// åˆ¤æ–­ä¸€ä¸ªinstanceæ˜¯å¦ä¸ºæ‹Ÿç¨¿çŠ¶æ€\r\n\t\tvar current_user = db.users.findOne({\r\n\t\t\t_id: this.userId\r\n\t\t}, {\r\n\t\t\tfields: {\r\n\t\t\t\tlocale: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar lang = current_user.locale == 'zh-cn' ? 'zh-CN' : 'en';\r\n\t\tuuflowManager.isInstanceDraft(instance, lang);\r\n\t\t// åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªinstanceçš„æäº¤è€…\r\n\t\tuuflowManager.isInstanceSubmitter(instance, this.userId);\r\n\r\n\t\tvar flow = db.flows.findOne(flow_id, {\r\n\t\t\tfields: {\r\n\t\t\t\t\"current._id\": 1,\r\n\t\t\t\t\"current.form_version\": 1,\r\n\t\t\t\t\"name\": 1,\r\n\t\t\t\t\"current.steps\": 1\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tsetObj.modified = new Date();\r\n\t\tsetObj.modified_by = this.userId;\r\n\r\n\t\tif (flow.current._id != instance.flow_version) {\r\n\t\t\tresult = \"upgraded\";\r\n\t\t\tvar start_step = _.find(flow.current.steps, function (s) {\r\n\t\t\t\treturn s.step_type == \"start\";\r\n\t\t\t});\r\n\t\t\t// æµç¨‹å·²å‡çº§\r\n\t\t\tsetObj.flow_version = flow.current._id;\r\n\t\t\tsetObj.form_version = flow.current.form_version;\r\n\t\t\t// å­˜å…¥å½“å‰æœ€æ–°ç‰ˆflowä¸­å¼€å§‹èŠ‚ç‚¹çš„step_id\r\n\t\t\tsetObj[\"traces.$.step\"] = start_step._id;\r\n\t\t\tsetObj[\"traces.$.name\"] = start_step.name;\r\n\t\t}\r\n\r\n\t\tif (instance.applicant != applicant_id) {\r\n\t\t\t// ç”³è¯·äººå·²å˜æ¢\r\n\t\t\tvar user = db.users.findOne(applicant_id, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\tname: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar applicant = db.space_users.find({\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\tuser: applicant_id\r\n\t\t\t}, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\torganization: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar org_id = applicant.fetch()[0].organization;\r\n\t\t\tvar organization = db.organizations.findOne(org_id, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\tname: 1,\r\n\t\t\t\t\tfullname: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tsetObj.applicant = applicant_id;\r\n\t\t\tsetObj.applicant_name = user.name;\r\n\t\t\tsetObj.applicant_organization = org_id;\r\n\t\t\tsetObj.applicant_organization_name = organization.name;\r\n\t\t\tsetObj.applicant_organization_fullname = organization.fullname;\r\n\r\n\t\t\tsetObj[key_str + 'user'] = applicant_id;\r\n\t\t\tsetObj[key_str + 'user_name'] = user.name;\r\n\t\t}\r\n\r\n\t\tsetObj[key_str + 'values'] = values;\r\n\t\tsetObj[key_str + 'description'] = description;\r\n\t\tsetObj[key_str + 'judge'] = 'submitted';\r\n\t\tsetObj[key_str + 'read_date'] = new Date();\r\n\t\tif (result != \"upgraded\" && next_steps) {\r\n\t\t\tsetObj[key_str + 'next_steps'] = next_steps;\r\n\t\t}\r\n\r\n\t\t// è®¡ç®—ç”³è¯·å•æ ‡é¢˜\r\n\t\tvar form = db.forms.findOne({\r\n\t\t\t_id: form_id\r\n\t\t}, {\r\n\t\t\tfields: {\r\n\t\t\t\t\"current.name_forumla\": 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar name_forumla = form.current.name_forumla;\r\n\t\tif (name_forumla) {\r\n\t\t\t// var iscript = name_forumla.replace(/\\{/g, \"(values['\").replace(/\\}/g, \"'] || '')\");\r\n\t\t\t// var rev = eval(iscript);\r\n\t\t\tsetObj.name = uuflowManager.getInstanceName(ins, values);\r\n\t\t}\r\n\r\n\t\tdb.instances.update({\r\n\t\t\t_id: ins_id,\r\n\t\t\t\"traces._id\": trace_id\r\n\t\t}, {\r\n\t\t\t$set: setObj\r\n\t\t});\r\n\t\treturn result;\r\n\t},\r\n\r\n\tinbox_save_instance: function (approve) {\r\n\t\tif (!this.userId)\r\n\t\t\treturn;\r\n\r\n\t\tvar setObj = {};\r\n\t\tvar index = 0;\r\n\t\tvar ins_id = approve.instance;\r\n\t\tvar trace_id = approve.trace;\r\n\t\tvar approve_id = approve.id;\r\n\t\tvar values = approve.values;\r\n\t\tvar next_steps = approve.next_steps;\r\n\t\tvar description = approve.description;\r\n\t\tvar judge = approve.judge;\r\n\r\n\t\tvar instance = db.instances.findOne(ins_id, {\r\n\t\t\tfields: {\r\n\t\t\t\ttraces: 1,\r\n\t\t\t\tflow_version: 1,\r\n\t\t\t\tflow: 1,\r\n\t\t\t\tstate: 1,\r\n\t\t\t\tform: 1,\r\n\t\t\t\tform_version: 1,\r\n\t\t\t\tvalues: 1,\r\n\t\t\t\tcode: 1\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tvar traces = instance.traces;\r\n\r\n\t\tvar current_trace = _.find(traces, function (t) {\r\n\t\t\treturn t._id == trace_id;\r\n\t\t});\r\n\t\tvar current_approve = _.find(current_trace.approves, function (a) {\r\n\t\t\treturn a._id == approve_id;\r\n\t\t});\r\n\r\n\t\t// åˆ¤æ–­ä¸€ä¸ªinstanceæ˜¯å¦ä¸ºå®¡æ ¸ä¸­çŠ¶æ€\r\n\t\tvar current_user = db.users.findOne({\r\n\t\t\t_id: this.userId\r\n\t\t}, {\r\n\t\t\tfields: {\r\n\t\t\t\tlocale: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar lang = current_user.locale == 'zh-cn' ? 'zh-CN' : 'en';\r\n\t\ttry {\r\n\t\t\tuuflowManager.isInstancePending(instance, lang);\r\n\t\t\t// åˆ¤æ–­ä¸€ä¸ªtraceæ˜¯å¦ä¸ºæœªå®ŒæˆçŠ¶æ€\r\n\t\t\tuuflowManager.isTraceNotFinished(current_trace);\r\n\t\t\t// åˆ¤æ–­ä¸€ä¸ªapproveæ˜¯å¦ä¸ºæœªå®ŒæˆçŠ¶æ€\r\n\t\t\tuuflowManager.isApproveNotFinished(current_approve);\r\n\t\t\t// åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦approve å¯¹åº”çš„å¤„ç†äººæˆ–ä»£ç†äºº\r\n\t\t\tuuflowManager.isHandlerOrAgent(current_approve, this.userId);\r\n\t\t} catch (e) {\r\n\t\t\tconsole.log(e.stack)\r\n\t\t\treturn true\r\n\t\t}\r\n\r\n\r\n\t\tvar flow_version = instance.flow_version;\r\n\t\tvar flow_id = instance.flow;\r\n\t\tvar step_id = \"\";\r\n\t\tstep_id = current_trace.step;\r\n\t\tvar flow = db.flows.findOne(flow_id, {\r\n\t\t\tfields: {\r\n\t\t\t\tcurrent: 1,\r\n\t\t\t\thistorys: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar step = null;\r\n\t\tif (flow.current._id == flow_version) {\r\n\t\t\tflow.current.steps.forEach(function (s) {\r\n\t\t\t\tif (s._id == step_id)\r\n\t\t\t\t\tstep = s;\r\n\t\t\t})\r\n\t\t} else {\r\n\t\t\tflow.historys.forEach(function (h) {\r\n\t\t\t\th.steps.forEach(function (s) {\r\n\t\t\t\t\tif (s._id == step_id)\r\n\t\t\t\t\t\tstep = s;\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tif (!step)\r\n\t\t\treturn false;\r\n\t\tvar step_type = step.step_type;\r\n\r\n\t\tcurrent_trace.approves.forEach(function (a, idx) {\r\n\t\t\tif (a._id == approve_id) {\r\n\t\t\t\tindex = idx;\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tvar key_str = 'traces.$.approves.' + index + '.';\r\n\r\n\t\tvar permissions_values = uuflowManager.getApproveValues(approve.values, step.permissions, instance.form, instance.form_version);\r\n\r\n\t\tvar change_values = approveManager.getChangeValues(instance.values, permissions_values);\r\n\r\n\t\tsetObj.values = _.extend((instance.values || {}), permissions_values);\r\n\r\n\t\tif (!_.isEmpty(change_values)) {\r\n\r\n\t\t\tvalues_history = current_approve.values_history || []\r\n\r\n\t\t\tvalues_history.push({\r\n\t\t\t\tvalues: change_values,\r\n\t\t\t\tcreate: new Date()\r\n\t\t\t})\r\n\r\n\t\t\tsetObj[key_str + 'values_history'] = values_history\r\n\t\t}\r\n\r\n\t\tsetObj[key_str + 'is_read'] = true;\r\n\t\tsetObj[key_str + 'read_date'] = new Date();\r\n\t\tsetObj[key_str + 'values'] = setObj.values;\r\n\t\tsetObj[key_str + 'description'] = description;\r\n\t\tsetObj[key_str + 'next_steps'] = next_steps;\r\n\t\tif (step_type == \"submit\" || step_type == \"start\") {\r\n\t\t\tsetObj[key_str + 'judge'] = \"submitted\";\r\n\t\t} else {\r\n\t\t\tsetObj[key_str + 'judge'] = judge;\r\n\t\t}\r\n\r\n\t\tsetObj.modified = new Date();\r\n\t\tsetObj.modified_by = this.userId;\r\n\r\n\t\t// è®¡ç®—ç”³è¯·å•æ ‡é¢˜\r\n\t\tvar form = db.forms.findOne(instance.form);\r\n\t\tvar form_v = uuflowManager.getFormVersion(form, instance.form_version);\r\n\t\tvar name_forumla = form_v.name_forumla;\r\n\t\tif (name_forumla) {\r\n\t\t\tsetObj.name = uuflowManager.getInstanceName(instance, setObj.values);\r\n\t\t}\r\n\r\n\t\tdb.instances.update({\r\n\t\t\t_id: ins_id,\r\n\t\t\t\"traces._id\": trace_id\r\n\t\t}, {\r\n\t\t\t$set: setObj\r\n\t\t});\r\n\t\treturn true;\r\n\t}\r\n\r\n})","Meteor.methods({\r\n\tcc_do: function (approve, cc_user_ids, description) {\r\n\r\n\t\tvar setObj = {};\r\n\t\tvar ins_id = approve.instance;\r\n\t\tvar trace_id = approve.trace;\r\n\t\tvar approve_id = approve._id;\r\n\t\tvar instance = db.instances.findOne(ins_id, {\r\n\t\t\tfields: {\r\n\t\t\t\tspace: 1,\r\n\t\t\t\ttraces: 1,\r\n\t\t\t\tcc_users: 1,\r\n\t\t\t\tvalues: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar current_user_id = this.userId;\r\n\t\tvar space_id = instance.space;\r\n\t\tvar new_approves = [];\r\n\r\n\t\tvar from_user_name = db.users.findOne(current_user_id, {\r\n\t\t\tfields: {\r\n\t\t\t\tname: 1\r\n\t\t\t}\r\n\t\t}).name\r\n\r\n\t\tcc_user_ids.forEach(function (userId, idx) {\r\n\t\t\tvar user = db.users.findOne(userId, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\tname: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar space_user = db.space_users.findOne({\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\tuser: userId\r\n\t\t\t}, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\torganization: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar org_id = space_user.organization;\r\n\t\t\tvar organization = db.organizations.findOne(org_id, {\r\n\t\t\t\tfields: {\r\n\t\t\t\t\tname: 1,\r\n\t\t\t\t\tfullname: 1\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tvar agent = uuflowManager.getAgent(space_id, userId);\r\n\t\t\tvar handler_id = userId;\r\n\t\t\tvar handler_info = user;\r\n\t\t\tvar handler_space_user = space_user;\r\n\t\t\tvar handler_org_info = organization;\r\n\t\t\tif (agent) {\r\n\t\t\t\thandler_id = agent;\r\n\t\t\t\thandler_info = db.users.findOne(agent, {\r\n\t\t\t\t\tfileds: {\r\n\t\t\t\t\t\tname: 1\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\thandler_space_user = uuflowManager.getSpaceUser(space_id, agent);\r\n\t\t\t\thandler_org_info = uuflowManager.getSpaceUserOrgInfo(handler_space_user);\r\n\t\t\t\tcc_user_ids[idx] = agent;\r\n\t\t\t}\r\n\t\t\tvar appr = {\r\n\t\t\t\t'_id': new Mongo.ObjectID()._str,\r\n\t\t\t\t'instance': ins_id,\r\n\t\t\t\t'trace': trace_id,\r\n\t\t\t\t'is_finished': false,\r\n\t\t\t\t'user': userId,\r\n\t\t\t\t'user_name': user.name,\r\n\t\t\t\t'handler': handler_id,\r\n\t\t\t\t'handler_name': handler_info.name,\r\n\t\t\t\t'handler_organization': handler_space_user.organization,\r\n\t\t\t\t'handler_organization_name': handler_org_info.name,\r\n\t\t\t\t'handler_organization_fullname': handler_org_info.fullname,\r\n\t\t\t\t'type': 'cc',\r\n\t\t\t\t'start_date': new Date(),\r\n\t\t\t\t'is_read': false,\r\n\t\t\t\t'from_user': current_user_id,\r\n\t\t\t\t'from_user_name': from_user_name,\r\n\t\t\t\t'opinion_fields_code': approve.opinion_fields_code,\r\n\t\t\t\t'sign_field_code': (approve.opinion_fields_code && approve.opinion_fields_code.length == 1) ? approve.opinion_fields_code[0] : \"\",\r\n\t\t\t\t'from_approve_id': approve_id,\r\n\t\t\t\t'cc_description': description\r\n\t\t\t};\r\n\t\t\tif (agent) {\r\n\t\t\t\tappr.agent = agent;\r\n\t\t\t}\r\n\t\t\tuuflowManager.setRemindInfo(instance.values, appr)\r\n\t\t\tnew_approves.push(appr);\r\n\t\t})\r\n\r\n\r\n\t\tsetObj.modified = new Date();\r\n\t\tsetObj.modified_by = this.userId;\r\n\r\n\t\tdb.instances.update({\r\n\t\t\t_id: ins_id,\r\n\t\t\t'traces._id': trace_id\r\n\t\t}, {\r\n\t\t\t$set: setObj,\r\n\t\t\t$addToSet: {\r\n\t\t\t\t'traces.$.approves': {\r\n\t\t\t\t\t$each: new_approves\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t$push: {\r\n\t\t\t\tcc_users: {\r\n\t\t\t\t\t$each: cc_user_ids\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tinstance = db.instances.findOne(ins_id);\r\n\t\tcurrent_user_info = db.users.findOne(current_user_id);\r\n\t\tpushManager.send_instance_notification(\"trace_approve_cc\", instance, \"\", current_user_info, cc_user_ids);\r\n\r\n\t\tflow_id = instance.flow;\r\n\t\tapprove.cc_user_ids = cc_user_ids; // è®°å½•ä¸‹æœ¬æ¬¡ä¼ é˜…çš„äººå‘˜IDä½œä¸ºhookæŽ¥å£ä¸­çš„å‚æ•°\r\n\t\t// å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\tpushManager.triggerWebhook(flow_id, instance, approve, 'cc_do', current_user_id, cc_user_ids)\r\n\t\treturn true;\r\n\t},\r\n\r\n\tcc_read: function (approve) {\r\n\t\tvar setObj = {};\r\n\t\tvar ins_id = approve.instance;\r\n\t\tvar trace_id = approve.trace;\r\n\t\tvar instance = db.instances.findOne(ins_id, {\r\n\t\t\tfields: {\r\n\t\t\t\ttraces: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar current_user_id = this.userId;\r\n\t\tvar current_trace = _.find(instance.traces, function (t) {\r\n\t\t\treturn t._id == trace_id;\r\n\t\t})\r\n\r\n\t\tvar index = 0;\r\n\r\n\t\tcurrent_trace.approves.forEach(function (a, idx) {\r\n\t\t\tif (a.type == 'cc' && a.handler == current_user_id && !a.is_read) {\r\n\t\t\t\tindex = idx;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tsetObj['traces.$.approves.' + index + '.is_read'] = true;\r\n\t\tsetObj['traces.$.approves.' + index + '.read_date'] = new Date();\r\n\r\n\t\tsetObj.traces = traces;\r\n\r\n\t\tdb.instances.update({\r\n\t\t\t_id: ins_id,\r\n\t\t\t'traces._id': trace_id\r\n\t\t}, {\r\n\t\t\t$set: setObj\r\n\t\t});\r\n\t\treturn true;\r\n\t},\r\n\r\n\tcc_submit: function (ins_id, description, myApprove, ccHasEditPermission) {\r\n\t\tvar setObj = {};\r\n\r\n\t\tvar instance = db.instances.findOne(ins_id);\r\n\t\tvar traces = instance.traces;\r\n\t\tvar current_user_id = this.userId;\r\n\r\n\t\tvar flow = uuflowManager.getFlow(instance.flow);\r\n\t\tvar values = myApprove.values || {};\r\n\r\n\t\tvar approve_id = myApprove._id;\r\n\r\n\t\tvar myTrace;\r\n\r\n\t\tfor (let tidx = 0; tidx < traces.length; tidx++) {\r\n\t\t\tconst t = traces[tidx];\r\n\t\t\tif (t.approves) {\r\n\t\t\t\tfor (let aidx = 0; aidx < t.approves.length; aidx++) {\r\n\t\t\t\t\tconst a = t.approves[aidx];\r\n\t\t\t\t\tif (a.type == 'cc' && a.handler == current_user_id && a.is_finished == false) {\r\n\t\t\t\t\t\tvar upobj = {};\r\n\t\t\t\t\t\tvar key_str = 'traces.$.approves.' + aidx + '.';\r\n\t\t\t\t\t\tupobj[key_str + 'is_finished'] = true;\r\n\t\t\t\t\t\tupobj[key_str + 'is_read'] = true;\r\n\t\t\t\t\t\tupobj[key_str + 'finish_date'] = new Date();\r\n\t\t\t\t\t\tupobj[key_str + 'judge'] = \"submitted\";\r\n\t\t\t\t\t\tupobj[key_str + 'cost_time'] = new Date() - a.start_date;\r\n\t\t\t\t\t\tif (approve_id == a._id && !t.is_finished && ccHasEditPermission) {\r\n\t\t\t\t\t\t\tmyTrace = t;\r\n\t\t\t\t\t\t\tvar step = uuflowManager.getStep(instance, flow, t.step);\r\n\t\t\t\t\t\t\tupobj[key_str + \"values\"] = uuflowManager.getApproveValues(values, step[\"permissions\"], instance.form, instance.form_version)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t//è®¾ç½®æ„è§ï¼Œæ„è§åªæ·»åŠ åˆ°æœ€åŽä¸€æ¡approveä¸­\r\n\t\t\t\t\t\tif (approve_id == a._id) {\r\n\t\t\t\t\t\t\tupobj[key_str + 'description'] = description;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t\t\t_id: ins_id,\r\n\t\t\t\t\t\t\t'traces._id': t._id\r\n\t\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\t$set: upobj\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (myApprove) {\r\n\r\n\t\t\tsetObj.modified = new Date();\r\n\t\t\tsetObj.modified_by = this.userId;\r\n\r\n\t\t\tif (ccHasEditPermission && myApprove && !myTrace.is_finished) {\r\n\t\t\t\tvar ins = uuflowManager.getInstance(ins_id);\r\n\t\t\t\tvar updated_values = uuflowManager.getUpdatedValues(ins, approve_id);\r\n\t\t\t\tsetObj.values = updated_values;\r\n\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance);\r\n\t\t\t}\r\n\r\n\t\t\tdb.instances.update({\r\n\t\t\t\t_id: ins_id,\r\n\t\t\t\t'traces._id': myApprove.trace\r\n\t\t\t}, {\r\n\t\t\t\t$set: setObj,\r\n\t\t\t\t$pull: {\r\n\t\t\t\t\tcc_users: current_user_id\r\n\t\t\t\t},\r\n\t\t\t\t$addToSet: {\r\n\t\t\t\t\toutbox_users: {\r\n\t\t\t\t\t\t$each: [current_user_id, myApprove.user]\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tinstance = db.instances.findOne(ins_id);\r\n\r\n\t\t\tcurrent_user_info = db.users.findOne(current_user_id);\r\n\t\t\t//ä¼ é˜…æäº¤ä¸é€šçŸ¥ä¼ é˜…è€…\r\n\t\t\tif (false && description && myApprove && myApprove.from_user) {\r\n\t\t\t\tpushManager.send_instance_notification(\"trace_approve_cc_submit\", instance, \"\", current_user_info, [myApprove.from_user]);\r\n\t\t\t}\r\n\r\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", current_user_id);\r\n\r\n\t\t\tflow_id = instance.flow;\r\n\t\t\t// å¦‚æžœå·²ç»é…ç½®webhookå¹¶å·²æ¿€æ´»åˆ™è§¦å‘\r\n\t\t\tpushManager.triggerWebhook(flow_id, instance, myApprove, 'cc_submit', current_user_id, []);\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t},\r\n\r\n\tcc_remove: function (instanceId, approveId) {\r\n\t\tvar setObj = {};\r\n\r\n\t\tvar instance = db.instances.findOne(instanceId, {\r\n\t\t\tfields: {\r\n\t\t\t\ttraces: 1,\r\n\t\t\t\tcc_users: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tvar traces = instance.traces;\r\n\t\tvar trace_id, remove_user_id, multi = false;\r\n\r\n\t\ttraces.forEach(function (t) {\r\n\t\t\tif (t.approves) {\r\n\t\t\t\tt.approves.forEach(function (a, idx) {\r\n\t\t\t\t\tif (a._id == approveId) {\r\n\t\t\t\t\t\ttrace_id = a.trace;\r\n\t\t\t\t\t\tremove_user_id = a.handler;\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.judge'] = 'terminated';\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_finished'] = true;\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.finish_date'] = new Date();\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_read'] = true;\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.read_date'] = new Date();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tif (!trace_id || !remove_user_id)\r\n\t\t\treturn;\r\n\r\n\t\tvar multi = 0;\r\n\t\ttraces.forEach(function (t) {\r\n\t\t\tif (t.approves) {\r\n\t\t\t\tt.approves.forEach(function (a) {\r\n\t\t\t\t\tif (a.handler == remove_user_id && a.type == 'cc' && a.is_finished == false) {\r\n\t\t\t\t\t\tmulti++;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tsetObj.modified = new Date();\r\n\t\tsetObj.modified_by = this.userId;\r\n\r\n\t\tif (multi > 1) {\r\n\t\t\tdb.instances.update({\r\n\t\t\t\t_id: instanceId,\r\n\t\t\t\t'traces._id': trace_id\r\n\t\t\t}, {\r\n\t\t\t\t$set: setObj\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tdb.instances.update({\r\n\t\t\t\t_id: instanceId,\r\n\t\t\t\t'traces._id': trace_id\r\n\t\t\t}, {\r\n\t\t\t\t$set: setObj,\r\n\t\t\t\t$pull: {\r\n\t\t\t\t\tcc_users: remove_user_id\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\r\n\t\tpushManager.send_message_to_specifyUser(\"current_user\", remove_user_id);\r\n\t\treturn true;\r\n\t},\r\n\r\n\tcc_save: function (ins_id, description, myApprove, ccHasEditPermission) {\r\n\t\tvar setObj = {};\r\n\r\n\t\tvar instance = db.instances.findOne(ins_id);\r\n\t\tvar traces = instance.traces;\r\n\t\tvar current_user_id = this.userId;\r\n\r\n\t\tvar myTrace;\r\n\r\n\t\ttraces.forEach(function (t) {\r\n\t\t\tif (t.approves) {\r\n\t\t\t\tt.approves.forEach(function (a, idx) {\r\n\t\t\t\t\tif (a.handler == current_user_id && a.type == 'cc' && a.is_finished == false) {\r\n\t\t\t\t\t\tvar upobj = {};\r\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.judge'] = \"submitted\";\r\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.read_date'] = new Date();\r\n\t\t\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t\t\t_id: ins_id,\r\n\t\t\t\t\t\t\t'traces._id': t._id\r\n\t\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\t$set: upobj\r\n\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tvar index = 0;\r\n\t\tvar currentStepId;\r\n\r\n\t\t//è®¾ç½®æ„è§ï¼Œæ„è§åªæ·»åŠ åˆ°æœ€åŽä¸€æ¡approveä¸­\r\n\t\ttraces.forEach(function (t) {\r\n\t\t\tif (myApprove && t._id === myApprove.trace) {\r\n\t\t\t\tcurrentStepId = t.step;\r\n\t\t\t\tmyTrace = t;\r\n\t\t\t\tif (t.approves) {\r\n\t\t\t\t\tt.approves.forEach(function (a, idx) {\r\n\t\t\t\t\t\tif (a._id === myApprove._id) {\r\n\t\t\t\t\t\t\tindex = idx;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tsetObj['traces.$.approves.' + index + '.description'] = description;\r\n\r\n\t\tvar updateObj = {};\r\n\r\n\t\tif (ccHasEditPermission && myApprove && !myTrace.is_finished) {\r\n\r\n\t\t\tvar key_str = 'traces.$.approves.' + index + '.';\r\n\r\n\t\t\tvar flow = uuflowManager.getFlow(instance.flow);\r\n\r\n\t\t\tvar step = uuflowManager.getStep(instance, flow, currentStepId);\r\n\r\n\t\t\tvar permissions_values = uuflowManager.getApproveValues(myApprove.values, step.permissions, instance.form, instance.form_version);\r\n\r\n\t\t\tvar change_values = approveManager.getChangeValues(instance.values, permissions_values);\r\n\r\n\t\t\tsetObj.values = _.extend((instance.values || {}), permissions_values);\r\n\r\n\t\t\tif (!_.isEmpty(change_values)) {\r\n\t\t\t\tvar pushObj = {};\r\n\t\t\t\tpushObj[key_str + 'values_history'] = {\r\n\t\t\t\t\tvalues: change_values,\r\n\t\t\t\t\tcreate: new Date()\r\n\t\t\t\t}\r\n\t\t\t\tupdateObj.$push = pushObj;\r\n\t\t\t}\r\n\r\n\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\t\t}\r\n\r\n\t\tupdateObj.$set = setObj;\r\n\r\n\t\tdb.instances.update({\r\n\t\t\t_id: ins_id,\r\n\t\t\t'traces._id': myApprove.trace\r\n\t\t}, updateObj);\r\n\r\n\t\treturn true;\r\n\t}\r\n})","Meteor.methods({\r\n\t// æ”¹ä¸ºé€šè¿‡apiè°ƒç”¨\r\n\tforward_instance: function (instance_id, space_id, flow_id, hasSaveInstanceToAttachment, description, isForwardAttachments, selectedUsers, action_type, related, from_approve_id) {\r\n\t\tif (!this.userId)\r\n\t\t\tthrow new Meteor.Error('not-authorized');\r\n\r\n\t\treturn;\r\n\t},\r\n\r\n\r\n\tforward_remove: function (instance_id, trace_id, approve_id) {\r\n\t\tcheck(instance_id, String);\r\n\t\tcheck(trace_id, String);\r\n\t\tcheck(approve_id, String);\r\n\r\n\t\tvar ins = db.instances.findOne(instance_id);\r\n\r\n\t\tif (!ins) {\r\n\t\t\tthrow new Meteor.Error('params error!', 'record not exists!');\r\n\t\t}\r\n\r\n\t\tvar trace = _.find(ins.traces, function (t) {\r\n\t\t\treturn t._id == trace_id;\r\n\t\t});\r\n\r\n\t\tvar approve = _.find(trace.approves, function (appr) {\r\n\t\t\treturn appr._id == approve_id;\r\n\t\t})\r\n\r\n\t\tvar hasAdminPermission = WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, this.userId)\r\n\r\n\t\tif (!approve || !['forward', 'distribute'].includes(approve.type) || !approve.forward_instance) {\r\n\t\t\tif (!hasAdminPermission) {\r\n\t\t\t\tif (approve.from_user != this.userId)\r\n\t\t\t\t\tthrow new Meteor.Error('error!', 'instance_forward_cannot_cancel');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar forward_instance_id = approve.forward_instance;\r\n\t\tvar forward_instance = db.instances.findOne(forward_instance_id);\r\n\t\tif (forward_instance) {\r\n\t\t\tif (forward_instance.state != \"draft\") {\r\n\t\t\t\tif (!hasAdminPermission)\r\n\t\t\t\t\tthrow new Meteor.Error('error!', 'instance_forward_instance_state_changed');\r\n\t\t\t}\r\n\t\t\tvar inbox_users = forward_instance.inbox_users || [];\r\n\r\n\t\t\tforward_instance.deleted = new Date();\r\n\t\t\tforward_instance.deleted_by = this.userId;\r\n\t\t\tvar deleted_forward_instance_id = db.deleted_instances.insert(forward_instance);\r\n\t\t\tif (deleted_forward_instance_id) {\r\n\t\t\t\tdb.instances.remove({\r\n\t\t\t\t\t_id: forward_instance_id\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// åˆ é™¤ç”³è¯·å•åŽé‡æ–°è®¡ç®—inbox_usersçš„badge\r\n\t\t\t\t_.each(inbox_users, function (u_id) {\r\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", u_id);\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar set_obj = new Object;\r\n\t\tset_obj.modified = new Date();\r\n\t\tset_obj.modified_by = this.userId;\r\n\r\n\t\t_.each(trace.approves, function (appr, idx) {\r\n\t\t\tif (appr._id == approve_id) {\r\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.judge'] = 'terminated';\r\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_finished'] = true;\r\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.finish_date'] = new Date();\r\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_read'] = true;\r\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.read_date'] = new Date();\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tdb.instances.update({\r\n\t\t\t_id: instance_id,\r\n\t\t\t\"traces._id\": trace_id\r\n\t\t}, {\r\n\t\t\t$set: set_obj\r\n\t\t})\r\n\r\n\t\treturn true;\r\n\t},\r\n\r\n\tcancelDistribute: function (instance_id, approve_ids) {\r\n\t\tcheck(instance_id, String)\r\n\t\tcheck(approve_ids, Array)\r\n\r\n\t\tvar ins = db.instances.findOne(instance_id)\r\n\r\n\t\tif (!ins) {\r\n\t\t\tthrow new Meteor.Error('params error!', 'record not exists!')\r\n\t\t}\r\n\r\n\t\tuserId = this.userId\r\n\r\n\t\tvar hasAdminPermission = WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, userId)\r\n\r\n\t\t_.each(ins.traces, function (t) {\r\n\t\t\tif (t.approves) {\r\n\t\t\t\tvar exists = false\r\n\t\t\t\tvar set_obj = new Object\r\n\t\t\t\t_.each(t.approves, function (a, idx) {\r\n\t\t\t\t\tif (approve_ids.includes(a._id) && (a.from_user == userId || hasAdminPermission) && 'distribute' == a.type && a.forward_instance) {\r\n\t\t\t\t\t\tvar forward_instance_id = a.forward_instance\r\n\t\t\t\t\t\tvar forward_instance = db.instances.findOne(forward_instance_id)\r\n\t\t\t\t\t\tif (forward_instance) {\r\n\t\t\t\t\t\t\tif (forward_instance.state != \"draft\") {\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tvar inbox_users = forward_instance.inbox_users || []\r\n\r\n\t\t\t\t\t\t\tforward_instance.deleted = new Date()\r\n\t\t\t\t\t\t\tforward_instance.deleted_by = userId\r\n\t\t\t\t\t\t\tvar deleted_forward_instance_id = db.deleted_instances.insert(forward_instance)\r\n\t\t\t\t\t\t\tif (deleted_forward_instance_id) {\r\n\t\t\t\t\t\t\t\tdb.instances.remove({\r\n\t\t\t\t\t\t\t\t\t_id: forward_instance_id\r\n\t\t\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t\t\t\t// åˆ é™¤ç”³è¯·å•åŽé‡æ–°è®¡ç®—inbox_usersçš„badge\r\n\t\t\t\t\t\t\t\t_.each(inbox_users, function (u_id) {\r\n\t\t\t\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", u_id)\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.judge'] = 'terminated'\r\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_finished'] = true\r\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.finish_date'] = new Date()\r\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_read'] = true\r\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.read_date'] = new Date()\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\texists = true\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\r\n\t\t\t\tif (!exists)\r\n\t\t\t\t\treturn\r\n\r\n\t\t\t\tset_obj.modified = new Date()\r\n\t\t\t\tset_obj.modified_by = userId\r\n\r\n\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t_id: instance_id,\r\n\t\t\t\t\t\"traces._id\": t._id\r\n\t\t\t\t}, {\r\n\t\t\t\t\t$set: set_obj\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\treturn true\r\n\t}\r\n\r\n\r\n})","Meteor.methods({\r\n    cfs_instances_remove: function (file_id) {\r\n        check(file_id, String);\r\n        cfs.instances.remove(file_id);\r\n        return true;\r\n    },\r\n\r\n    cfs_instances_set_current: function (file_id) {\r\n        check(file_id, String);\r\n        cfs.instances.update({\r\n            _id: file_id\r\n        }, {\r\n            $set: {\r\n                'metadata.current': true\r\n            }\r\n        });\r\n        return true;\r\n    },\r\n\r\n    cfs_instances_lock: function (file_id, user_id, user_name) {\r\n        cfs.instances.update({\r\n            _id: file_id\r\n        }, {\r\n            $set: {\r\n                'metadata.locked_by': user_id,\r\n                'metadata.locked_by_name': user_name,\r\n                'metadata.locked_time': new Date()\r\n            }\r\n        });\r\n        return true;\r\n    },\r\n\r\n    cfs_instances_unlock: function (file_id) {\r\n        cfs.instances.update({\r\n            _id: file_id\r\n        }, {\r\n            $unset: {\r\n                'metadata.locked_by': '',\r\n                'metadata.locked_by_name': '',\r\n                'metadata.locked_time': ''\r\n            }\r\n        });\r\n        return true;\r\n    },\r\n\r\n    download_space_instance_attachments_to_disk: function (spaceId, cfsRecordIds) {\r\n        if (!this.userId)\r\n            return \"ä¸ç¬¦åˆæ‰§è¡Œæ¡ä»¶\"\r\n\r\n        if (Meteor.users.find({\r\n                _id: this.userId,\r\n                is_cloudadmin: true\r\n            }).count() < 1)\r\n            return \"ä¸ç¬¦åˆæ‰§è¡Œæ¡ä»¶\"\r\n\r\n        check(spaceId, String);\r\n\r\n        var store = \"instances\";\r\n        var fs = require('fs');\r\n        var path = require('path');\r\n        var mkdirp = require('mkdirp');\r\n        var pathname = path.join(__meteor_bootstrap__.serverDir, '../../../cfs/spaceInstanceAttachments');\r\n        // Set absolute path\r\n        var absolutePath = path.resolve(pathname);\r\n        // Ensure the path exists\r\n        mkdirp.sync(absolutePath);\r\n        console.log('absolutePath: ', absolutePath);\r\n        console.time('download_space_instance_attachments_to_disk');\r\n        var query = {\r\n            'metadata.space': spaceId\r\n        }\r\n        if (cfsRecordIds) {\r\n            query._id = {\r\n                $in: cfsRecordIds\r\n            };\r\n        }\r\n        var downloadFailedRecordIds = [];\r\n        cfs.instances.find(query).forEach(function (c) {\r\n            try {\r\n                var fileName = store + '-' + c._id + '-' + c.name();\r\n                var filePath = path.join(absolutePath, fileName);\r\n                Meteor.wrapAsync(function (callback) {\r\n                    try {\r\n                        var writer = fs.createWriteStream(filePath);\r\n                        writer.on('finish', function () {\r\n                            if (callback && _.isFunction(callback))\r\n                                callback()\r\n                            return\r\n                        });\r\n                        var reader = c.createReadStream(store);\r\n                        reader.on('error', function (error) {\r\n                            downloadFailedRecordIds.push(c._id);\r\n                            console.error('download_space_instance_attachments_to_disk: ', c._id);\r\n                            console.error(error.stack);\r\n                            if (callback && _.isFunction(callback))\r\n                                callback()\r\n                            return\r\n                        });\r\n                        reader.pipe(writer);\r\n                    } catch (error) {\r\n                        console.error('download_space_instance_attachments_to_disk: ', c._id);\r\n                        console.error(error.stack);\r\n                        if (callback && _.isFunction(callback))\r\n                            callback()\r\n                        return\r\n                    }\r\n                })()\r\n\r\n            } catch (error) {\r\n                console.error('download_space_instance_attachments_to_disk: ', c._id);\r\n                console.error(error.stack);\r\n            }\r\n\r\n        })\r\n\r\n        if (downloadFailedRecordIds.length > 0) {\r\n            console.error('downloadFailedRecordIds: ');\r\n            console.error(downloadFailedRecordIds);\r\n        }\r\n\r\n        console.timeEnd('download_space_instance_attachments_to_disk');\r\n\r\n        return downloadFailedRecordIds;\r\n    }\r\n})","Meteor.methods\r\n\tset_approve_have_read: (instanceId, traceId, approveId) ->\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tself = this\r\n\r\n\t\tinstance = db.instances.findOne({ _id: instanceId, \"traces._id\": traceId }, { fields: { \"traces.$\": 1 } })\r\n\r\n\t\tif instance?.traces?.length > 0\r\n\t\t\ttrace = instance.traces[0]\r\n\t\t\tsetObj = {\r\n\t\t\t\tmodified: new Date,\r\n\t\t\t\tmodified_by: self.userId\r\n\t\t\t}\r\n\t\t\ttrace.approves.forEach (approve, idx) ->\r\n\t\t\t\tif approve._id == approveId && !approve.is_read\r\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.is_read\"] = true\r\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\r\n\r\n\t\t\tif not _.isEmpty(setObj)\r\n\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t_id: instanceId,\r\n\t\t\t\t\t\"traces._id\": traceId\r\n\t\t\t\t}, {\r\n\t\t\t\t\t$set: setObj\r\n\t\t\t\t})\r\n\t\t\treturn true\r\n\r\n\tchange_approve_info: (instanceId, traceId, approveId, description, finish_date) ->\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\t\tcheck(instanceId, String)\r\n\t\tcheck(traceId, String)\r\n\t\tcheck(approveId, String)\r\n\t\tcheck(description, String)\r\n\t\tcheck(finish_date, Date)\r\n\r\n\t\tinstance = db.instances.findOne({ _id: instanceId, \"traces._id\": traceId }, { fields: { \"traces.$\": 1 } })\r\n\r\n\t\tif instance?.traces?.length > 0\r\n\t\t\ttrace = instance.traces[0]\r\n\t\t\tsetObj = {}\r\n\t\t\ttrace.approves.forEach (approve, idx) ->\r\n\t\t\t\tif approve._id == approveId\r\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.description\"] = description\r\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.finish_date\"] = finish_date\r\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.cost_time\"] = new Date() - approve.start_date\r\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\r\n\r\n\t\t\tif not _.isEmpty(setObj)\r\n\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t_id: instanceId,\r\n\t\t\t\t\t\"traces._id\": traceId\r\n\t\t\t\t}, {\r\n\t\t\t\t\t$set: setObj\r\n\t\t\t\t})\r\n\t\t\treturn true\r\n\r\n\tupdate_approve_sign: (instanceId, traceId, approveId, sign_field_code, description, sign_type, lastSignApprove)->\r\n\t\tcheck(instanceId, String)\r\n\t\tcheck(traceId, String)\r\n\t\tcheck(approveId, String)\r\n\t\tcheck(sign_field_code, String)\r\n\t\tcheck(description, String)\r\n\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\ttrimDescription = description.trim()\r\n\r\n\t\tsession_userId = this.userId\r\n\r\n\t\tif lastSignApprove\r\n\t\t\tif Meteor.settings.public.workflow?.keepLastSignApproveDescription != false\r\n\t\t\t\tif lastSignApprove.custom_sign_show\r\n\t\t\t\t\treturn\r\n\r\n\t\tinstance = db.instances.findOne({ _id: instanceId, \"traces._id\": traceId }, { fields: { \"traces.$\": 1 } })\r\n\r\n\t\tif instance?.traces?.length > 0\r\n\r\n\t\t\ttrace = instance.traces[0]\r\n\t\t\tupObj = {}\r\n\t\t\tcurrentApproveDescription = ''\r\n\t\t\ttrace.approves.forEach (approve, idx) ->\r\n\t\t\t\tif approve._id == approveId\r\n\t\t\t\t\tcurrentApproveDescription = approve.description\r\n\t\t\t\t\tif sign_field_code\r\n\t\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.sign_field_code\"] = sign_field_code\r\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.description\"] = description\r\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.sign_show\"] = if trimDescription then true else false\r\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.modified\"] = new Date()\r\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.modified_by\"] = session_userId\r\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\r\n\r\n\t\t\tif Meteor.settings.public.workflow?.keepLastSignApproveDescription == false && !!currentApproveDescription != !!trimDescription\r\n\t\t\t\tins = db.instances.findOne({ _id: instanceId }, { fields: { \"traces\": 1 } })\r\n\t\t\t\ttraces = ins.traces\r\n\t\t\t\tcurrentTrace = _.find traces, (t) ->\r\n\t\t\t\t\treturn t._id == traceId\r\n\t\t\t\tcurrentStep = currentTrace.step\r\n\t\t\t\ttraces.forEach (t, tIdx) ->\r\n\t\t\t\t\tif t.step == currentStep\r\n\t\t\t\t\t\tt?.approves.forEach (appr, aIdx) ->\r\n\t\t\t\t\t\t\tif appr.handler == session_userId && appr.is_finished && appr._id != approveId && !_.has(appr, 'custom_sign_show')\r\n\t\t\t\t\t\t\t\tif trimDescription && appr.sign_show == true && (sign_field_code == \"\" || !appr.sign_field_code || sign_field_code == appr.sign_field_code)\r\n\t\t\t\t\t\t\t\t\tupObj[\"traces.#{tIdx}.approves.#{aIdx}.sign_show\"] = false\r\n\t\t\t\t\t\t\t\t\tupObj[\"traces.#{tIdx}.approves.#{aIdx}.keepLastSignApproveDescription\"] = approveId\r\n\t\t\t\t\t\t\t\telse if appr.keepLastSignApproveDescription == approveId\r\n\t\t\t\t\t\t\t\t\tupObj[\"traces.#{tIdx}.approves.#{aIdx}.sign_show\"] = true\r\n\t\t\t\t\t\t\t\t\tupObj[\"traces.#{tIdx}.approves.#{aIdx}.keepLastSignApproveDescription\"] = null\r\n\r\n\t\t\tif not _.isEmpty(upObj)\r\n\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t_id: instanceId,\r\n\t\t\t\t\t\"traces._id\": traceId\r\n\t\t\t\t}, {\r\n\t\t\t\t\t$set: upObj\r\n\t\t\t\t})\r\n\t\t\treturn true\r\n\r\n\r\n\tupdate_sign_show: (objs, myApprove_id) ->\r\n\t\tobjs.forEach (obj, index) ->\r\n\t\t\tinstance = db.instances.findOne({ _id: obj.instance, \"traces._id\": obj.trace }, { fields: { \"traces.$\": 1 } })\r\n\t\t\tif instance?.traces?.length > 0\r\n\t\t\t\ttrace = instance.traces[0]\r\n\t\t\t\tsetObj = {}\r\n\t\t\t\ttrace.approves.forEach (approve, idx) ->\r\n\t\t\t\t\tif approve._id == obj._id\r\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.sign_show\"] = obj.sign_show\r\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.custom_sign_show\"] = obj.sign_show\r\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\r\n\r\n\t\t\t\t\tif approve._id == myApprove_id\r\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\r\n\r\n\t\t\t\tif not _.isEmpty(setObj)\r\n\t\t\t\t\tdb.instances.update({\r\n\t\t\t\t\t\t_id: obj.instance,\r\n\t\t\t\t\t\t\"traces._id\": obj.trace\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t$set: setObj\r\n\t\t\t\t\t})\r\n\r\n\t\treturn true\r\n","Meteor.methods({\n  set_approve_have_read: function(instanceId, traceId, approveId) {\n    var instance, ref, self, setObj, trace;\n    if (!this.userId) {\n      return;\n    }\n    self = this;\n    instance = db.instances.findOne({\n      _id: instanceId,\n      \"traces._id\": traceId\n    }, {\n      fields: {\n        \"traces.$\": 1\n      }\n    });\n    if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n      trace = instance.traces[0];\n      setObj = {\n        modified: new Date,\n        modified_by: self.userId\n      };\n      trace.approves.forEach(function(approve, idx) {\n        if (approve._id === approveId && !approve.is_read) {\n          setObj[\"traces.$.approves.\" + idx + \".is_read\"] = true;\n          return setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n        }\n      });\n      if (!_.isEmpty(setObj)) {\n        db.instances.update({\n          _id: instanceId,\n          \"traces._id\": traceId\n        }, {\n          $set: setObj\n        });\n      }\n      return true;\n    }\n  },\n  change_approve_info: function(instanceId, traceId, approveId, description, finish_date) {\n    var instance, ref, setObj, trace;\n    if (!this.userId) {\n      return;\n    }\n    check(instanceId, String);\n    check(traceId, String);\n    check(approveId, String);\n    check(description, String);\n    check(finish_date, Date);\n    instance = db.instances.findOne({\n      _id: instanceId,\n      \"traces._id\": traceId\n    }, {\n      fields: {\n        \"traces.$\": 1\n      }\n    });\n    if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n      trace = instance.traces[0];\n      setObj = {};\n      trace.approves.forEach(function(approve, idx) {\n        if (approve._id === approveId) {\n          setObj[\"traces.$.approves.\" + idx + \".description\"] = description;\n          setObj[\"traces.$.approves.\" + idx + \".finish_date\"] = finish_date;\n          setObj[\"traces.$.approves.\" + idx + \".cost_time\"] = new Date() - approve.start_date;\n          return setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n        }\n      });\n      if (!_.isEmpty(setObj)) {\n        db.instances.update({\n          _id: instanceId,\n          \"traces._id\": traceId\n        }, {\n          $set: setObj\n        });\n      }\n      return true;\n    }\n  },\n  update_approve_sign: function(instanceId, traceId, approveId, sign_field_code, description, sign_type, lastSignApprove) {\n    var currentApproveDescription, currentStep, currentTrace, ins, instance, ref, ref1, ref2, session_userId, trace, traces, trimDescription, upObj;\n    check(instanceId, String);\n    check(traceId, String);\n    check(approveId, String);\n    check(sign_field_code, String);\n    check(description, String);\n    if (!this.userId) {\n      return;\n    }\n    trimDescription = description.trim();\n    session_userId = this.userId;\n    if (lastSignApprove) {\n      if (((ref = Meteor.settings[\"public\"].workflow) != null ? ref.keepLastSignApproveDescription : void 0) !== false) {\n        if (lastSignApprove.custom_sign_show) {\n          return;\n        }\n      }\n    }\n    instance = db.instances.findOne({\n      _id: instanceId,\n      \"traces._id\": traceId\n    }, {\n      fields: {\n        \"traces.$\": 1\n      }\n    });\n    if ((instance != null ? (ref1 = instance.traces) != null ? ref1.length : void 0 : void 0) > 0) {\n      trace = instance.traces[0];\n      upObj = {};\n      currentApproveDescription = '';\n      trace.approves.forEach(function(approve, idx) {\n        if (approve._id === approveId) {\n          currentApproveDescription = approve.description;\n          if (sign_field_code) {\n            upObj[\"traces.$.approves.\" + idx + \".sign_field_code\"] = sign_field_code;\n          }\n          upObj[\"traces.$.approves.\" + idx + \".description\"] = description;\n          upObj[\"traces.$.approves.\" + idx + \".sign_show\"] = trimDescription ? true : false;\n          upObj[\"traces.$.approves.\" + idx + \".modified\"] = new Date();\n          upObj[\"traces.$.approves.\" + idx + \".modified_by\"] = session_userId;\n          return upObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n        }\n      });\n      if (((ref2 = Meteor.settings[\"public\"].workflow) != null ? ref2.keepLastSignApproveDescription : void 0) === false && !!currentApproveDescription !== !!trimDescription) {\n        ins = db.instances.findOne({\n          _id: instanceId\n        }, {\n          fields: {\n            \"traces\": 1\n          }\n        });\n        traces = ins.traces;\n        currentTrace = _.find(traces, function(t) {\n          return t._id === traceId;\n        });\n        currentStep = currentTrace.step;\n        traces.forEach(function(t, tIdx) {\n          if (t.step === currentStep) {\n            return t != null ? t.approves.forEach(function(appr, aIdx) {\n              if (appr.handler === session_userId && appr.is_finished && appr._id !== approveId && !_.has(appr, 'custom_sign_show')) {\n                if (trimDescription && appr.sign_show === true && (sign_field_code === \"\" || !appr.sign_field_code || sign_field_code === appr.sign_field_code)) {\n                  upObj[\"traces.\" + tIdx + \".approves.\" + aIdx + \".sign_show\"] = false;\n                  return upObj[\"traces.\" + tIdx + \".approves.\" + aIdx + \".keepLastSignApproveDescription\"] = approveId;\n                } else if (appr.keepLastSignApproveDescription === approveId) {\n                  upObj[\"traces.\" + tIdx + \".approves.\" + aIdx + \".sign_show\"] = true;\n                  return upObj[\"traces.\" + tIdx + \".approves.\" + aIdx + \".keepLastSignApproveDescription\"] = null;\n                }\n              }\n            }) : void 0;\n          }\n        });\n      }\n      if (!_.isEmpty(upObj)) {\n        db.instances.update({\n          _id: instanceId,\n          \"traces._id\": traceId\n        }, {\n          $set: upObj\n        });\n      }\n      return true;\n    }\n  },\n  update_sign_show: function(objs, myApprove_id) {\n    objs.forEach(function(obj, index) {\n      var instance, ref, setObj, trace;\n      instance = db.instances.findOne({\n        _id: obj.instance,\n        \"traces._id\": obj.trace\n      }, {\n        fields: {\n          \"traces.$\": 1\n        }\n      });\n      if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n        trace = instance.traces[0];\n        setObj = {};\n        trace.approves.forEach(function(approve, idx) {\n          if (approve._id === obj._id) {\n            setObj[\"traces.$.approves.\" + idx + \".sign_show\"] = obj.sign_show;\n            setObj[\"traces.$.approves.\" + idx + \".custom_sign_show\"] = obj.sign_show;\n            setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n          }\n          if (approve._id === myApprove_id) {\n            return setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n          }\n        });\n        if (!_.isEmpty(setObj)) {\n          return db.instances.update({\n            _id: obj.instance,\n            \"traces._id\": obj.trace\n          }, {\n            $set: setObj\n          });\n        }\n      }\n    });\n    return true;\n  }\n});\n","Meteor.methods\r\n\tinstance_return: (approve, reason)->\r\n\t\tcheck(approve, Object)\r\n\r\n\t\tcurrent_user = this.userId\r\n\t\tinstance_id = approve.instance\r\n\r\n\t\tins = uuflowManager.getInstance(instance_id)\r\n\t\tspace_id = ins.space\r\n\r\n\t\t# - å¾…å®¡æ ¸ç®±\r\n\t\tif ins.state isnt \"pending\" or !ins.inbox_users.includes(current_user)\r\n\t\t\tthrow new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\")\r\n\r\n\t\t# - æ–‡ä»¶ä¸æ˜¯ä¼ é˜…\r\n\t\tif approve.type is \"cc\" and ins.cc_users.includes(current_user)\r\n\t\t\tthrow new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\")\r\n\r\n\t\t# - ç­¾æ ¸åŽ†ç¨‹ä¸­å½“å‰æ­¥éª¤ä¸Šä¸€æ­¥éª¤ä¸æ˜¯ä¼šç­¾\r\n\t\tif ins.traces.length < 2\r\n\t\t\tthrow new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\")\r\n\t\tflow = uuflowManager.getFlow(ins.flow)\r\n\t\tpre_trace = ins.traces[ins.traces.length - 2]\r\n\t\tpre_step = uuflowManager.getStep(ins, flow, pre_trace.step)\r\n\t\tif pre_step.step_type is \"counterSign\"\r\n\t\t\tthrow new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\")\r\n\r\n\t\t# - å½“å‰æ­¥éª¤ä¸ºå¡«å†™æˆ–è€…å®¡æ‰¹\r\n\t\tlast_trace = _.last(ins.traces)\r\n\t\tcurrent_step = uuflowManager.getStep(ins, flow, last_trace.step)\r\n\t\tif current_step.step_type isnt \"submit\" and current_step.step_type isnt \"sign\" and current_step.step_type isnt \"counterSign\"\r\n\t\t\tthrow new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\")\r\n\r\n\t\t# - å‚æ•°approveä¸­traceä¸Žå½“å‰èŽ·å–çš„traceæ˜¯å¦åŒ¹é…\r\n\t\tif approve.trace isnt last_trace._id\r\n\t\t\tthrow new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\")\r\n\r\n\t\tnew_inbox_users = new Array\r\n\t\t_.each pre_trace.approves, (a)->\r\n\t\t\tif (!a.type or a.type is \"draft\" or a.type is \"reassign\") and (!a.judge or a.judge is \"submitted\" or a.judge is \"approved\" or a.judge is \"rejected\")\r\n\t\t\t\tnew_inbox_users.push(a.user)\r\n\r\n\t\tif _.isEmpty(new_inbox_users)\r\n\t\t\tthrow new Meteor.Error('error!', \"æœªæ‰¾åˆ°ä¸‹ä¸€æ­¥å¤„ç†äººï¼Œé€€å›žå¤±è´¥\")\r\n\r\n\t\ttraces = ins.traces\r\n\r\n\t\tapprove_values = uuflowManager.getApproveValues(approve.values || {}, current_step.permissions, ins.form, ins.form_version)\r\n\r\n\t\tsetObj = new Object\r\n\t\tnow = new Date\r\n\t\trest_counter_users = new Array\r\n\t\t_.each traces, (t)->\r\n\t\t\tif t._id is last_trace._id\r\n\t\t\t\tif not t.approves\r\n\t\t\t\t\tt.approves = new Array\r\n\t\t\t\t_.each t.approves, (a, idx)->\r\n\t\t\t\t\tif (!a.type or a.type is \"reassign\") and (!a.judge or a.judge is \"submitted\" or a.judge is \"approved\" or a.judge is \"rejected\" or a.judge is \"readed\") and a.is_finished isnt true\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.finish_date'] = now\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.read_date'] = now\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_error'] = false\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_read'] = true\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_finished'] = true\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.cost_time'] = now - a.start_date\r\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.values'] = approve_values\r\n\t\t\t\t\t\tif a.handler is current_user\r\n\t\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.judge'] = \"returned\"\r\n\t\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.description'] = reason\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\trest_counter_users.push a.handler\r\n\r\n\t\t\t\t# æ›´æ–°å½“å‰traceè®°å½•\r\n\t\t\t\tsetObj['traces.$.is_finished'] = true\r\n\t\t\t\tsetObj['traces.$.finish_date'] = true\r\n\t\t\t\tsetObj['traces.$.judge'] = \"returned\"\r\n\r\n\t\tins.values = _.extend((ins.values || {}), approve_values)\r\n\r\n\t\t# æ’å…¥ä¸‹ä¸€æ­¥traceè®°å½•\r\n\t\tnewTrace = new Object\r\n\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\tnewTrace.instance = instance_id\r\n\t\tnewTrace.previous_trace_ids = [last_trace._id]\r\n\t\tnewTrace.is_finished = false\r\n\t\tnewTrace.step = pre_trace.step\r\n\t\tnewTrace.name = pre_trace.name\r\n\t\tnewTrace.start_date = now\r\n\t\tnewTrace.due_date = uuflowManager.getDueDate(pre_step.timeout_hours, space_id)\r\n\t\tnewTrace.approves = []\r\n\t\t_.each new_inbox_users, (next_step_user_id, idx)->\r\n\t\t\t# æ’å…¥ä¸‹ä¸€æ­¥trace.approveè®°å½•\r\n\t\t\tnewApprove = new Object\r\n\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\tnewApprove.instance = instance_id\r\n\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\tnewApprove.is_finished = false\r\n\t\t\tnewApprove.user = next_step_user_id\r\n\r\n\t\t\tuser_info = db.users.findOne(next_step_user_id, {fields: {name: 1}})\r\n\t\t\tnewApprove.user_name = user_info.name\r\n\r\n\t\t\thandler_id = next_step_user_id\r\n\t\t\thandler_info = user_info\r\n\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\tif agent\r\n\t\t\t\tnew_inbox_users[idx] = agent\r\n\t\t\t\thandler_id = agent\r\n\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\tnewApprove.agent = agent\r\n\r\n\t\t\tnewApprove.handler = handler_id\r\n\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\r\n\t\t\t# èŽ·å–next_step_useræ‰€åœ¨çš„éƒ¨é—¨ä¿¡æ¯\r\n\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\r\n\t\t\tnewApprove.start_date = now\r\n\t\t\tnewApprove.is_read = false\r\n\t\t\tnewApprove.is_error = false\r\n\t\t\tnewApprove.values = new Object\r\n\t\t\tuuflowManager.setRemindInfo(ins.values, newApprove)\r\n\t\t\tnewTrace.approves.push(newApprove)\r\n\r\n\t\tsetObj.inbox_users = new_inbox_users\r\n\t\tsetObj.state = \"pending\"\r\n\r\n\t\tins.outbox_users.push(current_user)\r\n\t\tsetObj.outbox_users = _.uniq(ins.outbox_users)\r\n\t\tsetObj.modified = now\r\n\t\tsetObj.modified_by = current_user\r\n\t\tsetObj.values = ins.values\r\n\r\n\t\tsetObj.current_step_name = pre_trace.name\r\n\r\n\t\tr = db.instances.update({_id: instance_id, 'traces._id': last_trace._id}, {$set: setObj})\r\n\t\tb = db.instances.update({_id: instance_id}, {$push: {traces: newTrace}})\r\n\t\tif r && b\r\n\t\t\t# æ–°inbox_users å’Œ å½“å‰ç”¨æˆ· å‘é€push\r\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", current_user)\r\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\r\n\t\t\tcurrent_user_info = db.users.findOne(current_user)\r\n\t\t\tpushManager.send_instance_notification(\"return_pending_inbox\", instance, reason, current_user_info)\r\n\t\t\t# å¦‚æžœæ˜¯ä¼šç­¾åˆ™ç»™ä¼šç­¾æœªæäº¤çš„äººå‘é€push\r\n\t\t\t_.each rest_counter_users, (user_id)->\r\n\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\r\n\t\treturn true","Meteor.methods({\n  instance_return: function(approve, reason) {\n    var approve_values, b, current_step, current_user, current_user_info, flow, ins, instance, instance_id, last_trace, newTrace, new_inbox_users, now, pre_step, pre_trace, r, rest_counter_users, setObj, space_id, traces;\n    check(approve, Object);\n    current_user = this.userId;\n    instance_id = approve.instance;\n    ins = uuflowManager.getInstance(instance_id);\n    space_id = ins.space;\n    if (ins.state !== \"pending\" || !ins.inbox_users.includes(current_user)) {\n      throw new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\");\n    }\n    if (approve.type === \"cc\" && ins.cc_users.includes(current_user)) {\n      throw new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\");\n    }\n    if (ins.traces.length < 2) {\n      throw new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\");\n    }\n    flow = uuflowManager.getFlow(ins.flow);\n    pre_trace = ins.traces[ins.traces.length - 2];\n    pre_step = uuflowManager.getStep(ins, flow, pre_trace.step);\n    if (pre_step.step_type === \"counterSign\") {\n      throw new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\");\n    }\n    last_trace = _.last(ins.traces);\n    current_step = uuflowManager.getStep(ins, flow, last_trace.step);\n    if (current_step.step_type !== \"submit\" && current_step.step_type !== \"sign\" && current_step.step_type !== \"counterSign\") {\n      throw new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\");\n    }\n    if (approve.trace !== last_trace._id) {\n      throw new Meteor.Error('error!', \"ä¸ç¬¦åˆé€€å›žæ¡ä»¶\");\n    }\n    new_inbox_users = new Array;\n    _.each(pre_trace.approves, function(a) {\n      if ((!a.type || a.type === \"draft\" || a.type === \"reassign\") && (!a.judge || a.judge === \"submitted\" || a.judge === \"approved\" || a.judge === \"rejected\")) {\n        return new_inbox_users.push(a.user);\n      }\n    });\n    if (_.isEmpty(new_inbox_users)) {\n      throw new Meteor.Error('error!', \"æœªæ‰¾åˆ°ä¸‹ä¸€æ­¥å¤„ç†äººï¼Œé€€å›žå¤±è´¥\");\n    }\n    traces = ins.traces;\n    approve_values = uuflowManager.getApproveValues(approve.values || {}, current_step.permissions, ins.form, ins.form_version);\n    setObj = new Object;\n    now = new Date;\n    rest_counter_users = new Array;\n    _.each(traces, function(t) {\n      if (t._id === last_trace._id) {\n        if (!t.approves) {\n          t.approves = new Array;\n        }\n        _.each(t.approves, function(a, idx) {\n          if ((!a.type || a.type === \"reassign\") && (!a.judge || a.judge === \"submitted\" || a.judge === \"approved\" || a.judge === \"rejected\" || a.judge === \"readed\") && a.is_finished !== true) {\n            setObj['traces.$.approves.' + idx + '.finish_date'] = now;\n            setObj['traces.$.approves.' + idx + '.read_date'] = now;\n            setObj['traces.$.approves.' + idx + '.is_error'] = false;\n            setObj['traces.$.approves.' + idx + '.is_read'] = true;\n            setObj['traces.$.approves.' + idx + '.is_finished'] = true;\n            setObj['traces.$.approves.' + idx + '.cost_time'] = now - a.start_date;\n            setObj['traces.$.approves.' + idx + '.values'] = approve_values;\n            if (a.handler === current_user) {\n              setObj['traces.$.approves.' + idx + '.judge'] = \"returned\";\n              return setObj['traces.$.approves.' + idx + '.description'] = reason;\n            } else {\n              return rest_counter_users.push(a.handler);\n            }\n          }\n        });\n        setObj['traces.$.is_finished'] = true;\n        setObj['traces.$.finish_date'] = true;\n        return setObj['traces.$.judge'] = \"returned\";\n      }\n    });\n    ins.values = _.extend(ins.values || {}, approve_values);\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [last_trace._id];\n    newTrace.is_finished = false;\n    newTrace.step = pre_trace.step;\n    newTrace.name = pre_trace.name;\n    newTrace.start_date = now;\n    newTrace.due_date = uuflowManager.getDueDate(pre_step.timeout_hours, space_id);\n    newTrace.approves = [];\n    _.each(new_inbox_users, function(next_step_user_id, idx) {\n      var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n      newApprove = new Object;\n      newApprove._id = new Mongo.ObjectID()._str;\n      newApprove.instance = instance_id;\n      newApprove.trace = newTrace._id;\n      newApprove.is_finished = false;\n      newApprove.user = next_step_user_id;\n      user_info = db.users.findOne(next_step_user_id, {\n        fields: {\n          name: 1\n        }\n      });\n      newApprove.user_name = user_info.name;\n      handler_id = next_step_user_id;\n      handler_info = user_info;\n      agent = uuflowManager.getAgent(space_id, next_step_user_id);\n      if (agent) {\n        new_inbox_users[idx] = agent;\n        handler_id = agent;\n        handler_info = db.users.findOne({\n          _id: agent\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        newApprove.agent = agent;\n      }\n      newApprove.handler = handler_id;\n      newApprove.handler_name = handler_info.name;\n      next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n      next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n      newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n      newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n      newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n      newApprove.start_date = now;\n      newApprove.is_read = false;\n      newApprove.is_error = false;\n      newApprove.values = new Object;\n      uuflowManager.setRemindInfo(ins.values, newApprove);\n      return newTrace.approves.push(newApprove);\n    });\n    setObj.inbox_users = new_inbox_users;\n    setObj.state = \"pending\";\n    ins.outbox_users.push(current_user);\n    setObj.outbox_users = _.uniq(ins.outbox_users);\n    setObj.modified = now;\n    setObj.modified_by = current_user;\n    setObj.values = ins.values;\n    setObj.current_step_name = pre_trace.name;\n    r = db.instances.update({\n      _id: instance_id,\n      'traces._id': last_trace._id\n    }, {\n      $set: setObj\n    });\n    b = db.instances.update({\n      _id: instance_id\n    }, {\n      $push: {\n        traces: newTrace\n      }\n    });\n    if (r && b) {\n      pushManager.send_message_to_specifyUser(\"current_user\", current_user);\n      instance = uuflowManager.getInstance(instance_id);\n      current_user_info = db.users.findOne(current_user);\n      pushManager.send_instance_notification(\"return_pending_inbox\", instance, reason, current_user_info);\n      _.each(rest_counter_users, function(user_id) {\n        return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n      });\n    }\n    return true;\n  }\n});\n","Meteor.methods\r\n\tinstance_remind: (remind_users, remind_count, remind_deadline, instance_id, action_types, trace_id)->\r\n\t\tcheck remind_users, Array\r\n\t\tcheck remind_count, Match.OneOf('single', 'multi')\r\n\t\tcheck remind_deadline, Date\r\n\t\tcheck instance_id, String\r\n\t\tcheck action_types, Array\r\n\t\tcheck trace_id, String\r\n\r\n\t\tcurrent_user_id = this.userId\r\n\t\tlast_remind_users = new Array\r\n\t\tins = db.instances.findOne({_id: instance_id}, {fields: {name: 1, traces: 1, values: 1, space: 1}})\r\n\t\tif action_types.includes('admin')\r\n\t\t\tif remind_count is 'single'\r\n\t\t\t\t_.each ins.traces, (t)->\r\n\t\t\t\t\t_.each t.approves, (ap)->\r\n\t\t\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true\r\n\t\t\t\t\t\t\tlast_remind_users.push ap.user\r\n\t\t\telse if remind_count is 'multi'\r\n\t\t\t\tnow = new Date\r\n\t\t\t\tpriority = ins.values.priority\r\n\t\t\t\t_.each ins.traces, (t)->\r\n\t\t\t\t\t_.each t.approves, (ap)->\r\n\t\t\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true\r\n\t\t\t\t\t\t\tlast_remind_users.push ap.user\r\n\t\t\t\t\t\t\tap.manual_deadline = remind_deadline\r\n\t\t\t\t\t\t\t# ï¼ˆ1ï¼‰â€œæ™®é€šâ€ï¼šå¦‚ä¸‰ä¸ªå·¥ä½œæ—¥å†…æœªå¤„ç†ï¼Œç³»ç»Ÿè‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼šåŠžç»“æ—¶é™ä¸ºäºŒæ—¥å†…ï¼›\r\n\t\t\t\t\t\t\t#  å¦‚äºŒæ—¥åŽä»æœªå¤„ç†ï¼Œç³»ç»Ÿæ¯å¤©è‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼ŒåŠžç»“æ—¶é™ä¸ºä¸€æ—¥å†…ã€‚\r\n\t\t\t\t\t\t\tif priority is \"æ™®é€š\" or not priority\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t# ï¼ˆ2ï¼‰â€œåŠžæ–‡â€ï¼šå¦‚ä¸€ä¸ªå·¥ä½œæ—¥å†…æœªå¤„ç†ï¼Œç³»ç»Ÿè‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼šåŠžç»“æ—¶é™ä¸ºè¡¨å•ä¸Šçš„â€œåŠžç»“æ—¶é™â€ï¼ˆæ–‡ä¹¦å½•å…¥çš„æ—¶é—´ï¼‰ï¼›\r\n\t\t\t\t\t\t\t#  å¦‚ä¸€æ—¥åŽä»æœªå¤„ç†ï¼Œç³»ç»Ÿæ¯å¤©è‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼šåŠžç»“æ—¶é™ä¸å˜ï¼›\r\n\t\t\t\t\t\t\t#  è·ç¦»åŠžç»“æ—¶é™ä¸ºåŠæ—¥æ—¶ï¼Œåˆ™æ¯åŠä¸ªå·¥ä½œæ—¥æé†’å››æ¬¡ï¼›è¶…è¿‡åŠžç»“æ—¶é™åŽä»ç„¶æŒ‰ç…§æ¯åŠæ—¥å››æ¬¡æé†’ã€‚\r\n\t\t\t\t\t\t\telse if priority is \"åŠžæ–‡\"\r\n\t\t\t\t\t\t\t\tif Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline # è¶…è¿‡äº†åŠžç»“æ—¶é™æˆ–è€…è·ç¦»åŠžç»“æ—¶é™åŠæ—¥å†…\r\n\t\t\t\t\t\t\t\t\tap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true)\r\n\t\t\t\t\t\t\t\telse if Steedos.caculateWorkingTime(now, 1) > remind_deadline\r\n\t\t\t\t\t\t\t\t\tcaculate_date = (base_date)->\r\n\t\t\t\t\t\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\r\n\t\t\t\t\t\t\t\t\t\tif plus_halfday_date > remind_deadline\r\n\t\t\t\t\t\t\t\t\t\t\tap.remind_date = base_date\r\n\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\r\n\t\t\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t\t\tcaculate_date(now)\r\n\r\n\t\t\t\t\t\t\t# ï¼ˆ3ï¼‰â€œç´§æ€¥â€ï¼šåœ¨å‘é€çš„åŒæ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼šåŠžç»“æ—¶é™ä¸ºè¡¨å•ä¸Šçš„â€œåŠžç»“æ—¶é™â€ï¼ˆæ–‡ä¹¦å½•å…¥çš„æ—¶é—´ï¼‰ï¼›\r\n\t\t\t\t\t\t\t#  å¦‚åŠæ—¥å†…ä»æœªå¤„ç†ï¼Œç³»ç»Ÿæ¯åŠå¤©è‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼šåŠžç»“æ—¶é™ä¸å˜ï¼›è·ç¦»åŠžç»“æ—¶é™ä¸ºåŠæ—¥æ—¶ï¼Œæ¯åŠä¸ªå·¥ä½œæ—¥æé†’å››æ¬¡ï¼›è¶…è¿‡åŠžç»“æ—¶é™åŽä»ç„¶æŒ‰ç…§æ¯åŠæ—¥å››æ¬¡æé†’ã€‚\r\n\t\t\t\t\t\t\telse if priority is \"ç´§æ€¥\"\r\n\t\t\t\t\t\t\t\tif Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline # è¶…è¿‡äº†åŠžç»“æ—¶é™æˆ–è€…è·ç¦»åŠžç»“æ—¶é™åŠæ—¥å†…\r\n\t\t\t\t\t\t\t\t\tap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true)\r\n\t\t\t\t\t\t\t\telse if Steedos.caculateWorkingTime(now, 1) > remind_deadline\r\n\t\t\t\t\t\t\t\t\tcaculate_date = (base_date)->\r\n\t\t\t\t\t\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\r\n\t\t\t\t\t\t\t\t\t\tif plus_halfday_date > remind_deadline\r\n\t\t\t\t\t\t\t\t\t\t\tap.remind_date = base_date\r\n\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\r\n\t\t\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t\t\tcaculate_date(now)\r\n\r\n\t\t\t\t\t\t\t# ï¼ˆ4ï¼‰â€œç‰¹æ€¥â€ï¼šåœ¨å‘é€çš„åŒæ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å‘çŸ­ä¿¡æé†’ï¼šåŠžç»“æ—¶é™ä¸ºè¡¨å•ä¸Šçš„â€œåŠžç»“æ—¶é™â€ï¼ˆæ–‡ä¹¦å½•å…¥çš„æ—¶é—´ï¼‰ï¼›\r\n\t\t\t\t\t\t\t#  å¦‚åŠæ—¥å†…ä»æœªå¤„ç†ï¼Œç³»ç»Ÿæ¯åŠä¸ªå·¥ä½œæ—¥æé†’å››æ¬¡ï¼šåŠžç»“æ—¶é™ä¸å˜ï¼›è¶…è¿‡åŠžç»“æ—¶é™åŽä»ç„¶æŒ‰ç…§æ¯åŠæ—¥å››æ¬¡æé†’ã€‚\r\n\t\t\t\t\t\t\telse if priority is \"ç‰¹æ€¥\"\r\n\t\t\t\t\t\t\t\tif Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline # è¶…è¿‡äº†åŠžç»“æ—¶é™æˆ–è€…è·ç¦»åŠžç»“æ—¶é™åŠæ—¥å†…\r\n\t\t\t\t\t\t\t\t\tap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true)\r\n\t\t\t\t\t\t\t\telse if Steedos.caculateWorkingTime(now, 1) > remind_deadline\r\n\t\t\t\t\t\t\t\t\tcaculate_date = (base_date)->\r\n\t\t\t\t\t\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\r\n\t\t\t\t\t\t\t\t\t\tif plus_halfday_date > remind_deadline\r\n\t\t\t\t\t\t\t\t\t\t\tap.remind_date = base_date\r\n\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\r\n\t\t\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t\t\tcaculate_date(now)\r\n\r\n\t\t\t\tif not _.isEmpty(last_remind_users)\r\n\t\t\t\t\tdb.instances.update({_id: instance_id}, {$set: {'traces': ins.traces}})\r\n\r\n\t\telse if action_types.includes('applicant')\r\n\t\t\ttrace = _.find ins.traces, (t)->\r\n\t\t\t\treturn t._id is trace_id\r\n\t\t\t_.each trace.approves, (ap)->\r\n\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true\r\n\t\t\t\t\tlast_remind_users.push ap.user\r\n\r\n\t\telse if action_types.includes('cc')\r\n\t\t\t_.each ins.traces, (t)->\r\n\t\t\t\t_.each t.approves, (ap)->\r\n\t\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true and ap.type is 'cc' and ap.from_user is current_user_id\r\n\t\t\t\t\t\tlast_remind_users.push ap.user\r\n\r\n\t\tuuflowManager.sendRemindSMS ins.name, remind_deadline, last_remind_users, ins.space, ins._id\r\n\r\n\t\treturn true\r\n","Meteor.methods({\n  instance_remind: function(remind_users, remind_count, remind_deadline, instance_id, action_types, trace_id) {\n    var current_user_id, ins, last_remind_users, now, priority, trace;\n    check(remind_users, Array);\n    check(remind_count, Match.OneOf('single', 'multi'));\n    check(remind_deadline, Date);\n    check(instance_id, String);\n    check(action_types, Array);\n    check(trace_id, String);\n    current_user_id = this.userId;\n    last_remind_users = new Array;\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        name: 1,\n        traces: 1,\n        values: 1,\n        space: 1\n      }\n    });\n    if (action_types.includes('admin')) {\n      if (remind_count === 'single') {\n        _.each(ins.traces, function(t) {\n          return _.each(t.approves, function(ap) {\n            if (remind_users.includes(ap.user) && ap.is_finished !== true) {\n              return last_remind_users.push(ap.user);\n            }\n          });\n        });\n      } else if (remind_count === 'multi') {\n        now = new Date;\n        priority = ins.values.priority;\n        _.each(ins.traces, function(t) {\n          return _.each(t.approves, function(ap) {\n            var caculate_date;\n            if (remind_users.includes(ap.user) && ap.is_finished !== true) {\n              last_remind_users.push(ap.user);\n              ap.manual_deadline = remind_deadline;\n              if (priority === \"æ™®é€š\" || !priority) {\n\n              } else if (priority === \"åŠžæ–‡\") {\n                if (Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline) {\n                  return ap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true);\n                } else if (Steedos.caculateWorkingTime(now, 1) > remind_deadline) {\n                  caculate_date = function(base_date) {\n                    var plus_halfday_date;\n                    plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n                    if (plus_halfday_date > remind_deadline) {\n                      ap.remind_date = base_date;\n                    } else {\n                      caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n                    }\n                  };\n                  return caculate_date(now);\n                }\n              } else if (priority === \"ç´§æ€¥\") {\n                if (Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline) {\n                  return ap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true);\n                } else if (Steedos.caculateWorkingTime(now, 1) > remind_deadline) {\n                  caculate_date = function(base_date) {\n                    var plus_halfday_date;\n                    plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n                    if (plus_halfday_date > remind_deadline) {\n                      ap.remind_date = base_date;\n                    } else {\n                      caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n                    }\n                  };\n                  return caculate_date(now);\n                }\n              } else if (priority === \"ç‰¹æ€¥\") {\n                if (Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline) {\n                  return ap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true);\n                } else if (Steedos.caculateWorkingTime(now, 1) > remind_deadline) {\n                  caculate_date = function(base_date) {\n                    var plus_halfday_date;\n                    plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n                    if (plus_halfday_date > remind_deadline) {\n                      ap.remind_date = base_date;\n                    } else {\n                      caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n                    }\n                  };\n                  return caculate_date(now);\n                }\n              }\n            }\n          });\n        });\n        if (!_.isEmpty(last_remind_users)) {\n          db.instances.update({\n            _id: instance_id\n          }, {\n            $set: {\n              'traces': ins.traces\n            }\n          });\n        }\n      }\n    } else if (action_types.includes('applicant')) {\n      trace = _.find(ins.traces, function(t) {\n        return t._id === trace_id;\n      });\n      _.each(trace.approves, function(ap) {\n        if (remind_users.includes(ap.user) && ap.is_finished !== true) {\n          return last_remind_users.push(ap.user);\n        }\n      });\n    } else if (action_types.includes('cc')) {\n      _.each(ins.traces, function(t) {\n        return _.each(t.approves, function(ap) {\n          if (remind_users.includes(ap.user) && ap.is_finished !== true && ap.type === 'cc' && ap.from_user === current_user_id) {\n            return last_remind_users.push(ap.user);\n          }\n        });\n      });\n    }\n    uuflowManager.sendRemindSMS(ins.name, remind_deadline, last_remind_users, ins.space, ins._id);\n    return true;\n  }\n});\n","Meteor.methods\r\n\tnext_step_users_not_found: (deal_type, step_name, params) ->\r\n\t\tcheck deal_type, String\r\n\t\tcheck step_name, String\r\n\t\tcheck params, Object\r\n\r\n\t\tstr = \"\"\r\n\t\tuser = db.users.findOne({ _id: this.userId }, { fields: { locale: 1 } })\r\n\t\t#è®¾ç½®å½“å‰è¯­è¨€çŽ¯å¢ƒ\r\n\t\tlang = 'en'\r\n\t\tif user.locale is 'zh-cn'\r\n\t\t\tlang = 'zh-CN'\r\n\r\n\t\t# æŒ‡å®šå®¡æ‰¹å²—ä½\r\n\t\tif deal_type is 'applicantRole'\r\n\t\t\tapprover_roles = params.approver_roles\r\n\t\t\troles = db.flow_roles.find({ _id: { $in: approver_roles } }, { fields: { name: 1 } }).fetch()\r\n\t\t\troles_name = _.pluck(roles, 'name').toString()\r\n\t\t\tstr = TAPi18n.__ 'next_step_users_not_found.applicant_role', { step_name: step_name, role_name: roles_name }, lang\r\n\r\n\r\n\t\treturn str\r\n","Meteor.methods({\n  next_step_users_not_found: function(deal_type, step_name, params) {\n    var approver_roles, lang, roles, roles_name, str, user;\n    check(deal_type, String);\n    check(step_name, String);\n    check(params, Object);\n    str = \"\";\n    user = db.users.findOne({\n      _id: this.userId\n    }, {\n      fields: {\n        locale: 1\n      }\n    });\n    lang = 'en';\n    if (user.locale === 'zh-cn') {\n      lang = 'zh-CN';\n    }\n    if (deal_type === 'applicantRole') {\n      approver_roles = params.approver_roles;\n      roles = db.flow_roles.find({\n        _id: {\n          $in: approver_roles\n        }\n      }, {\n        fields: {\n          name: 1\n        }\n      }).fetch();\n      roles_name = _.pluck(roles, 'name').toString();\n      str = TAPi18n.__('next_step_users_not_found.applicant_role', {\n        step_name: step_name,\n        role_name: roles_name\n      }, lang);\n    }\n    return str;\n  }\n});\n","_eval = require('eval')\r\n\r\nMeteor.methods\r\n\tinstanceNumberBuilder: (spaceId, name)->\r\n\r\n\t\tnumberRules = db.instance_number_rules.findOne({space: spaceId, name: name})\r\n\r\n\t\tif !numberRules\r\n\t\t\tthrow new  Meteor.Error('error!', \"#{name}\")\r\n\r\n\t\tdate = new Date()\r\n\r\n\t\tcontext = {}\r\n\r\n\t\tcontext._ = _\r\n\r\n\t\t_YYYY = date.getFullYear()\r\n\r\n\t\t_NUMBER = (numberRules.number || 0) + 1\r\n\r\n\t\tcontext.YYYY = _.clone(_YYYY)\r\n\r\n\t\tcontext.MM = date.getMonth() + 1\r\n\r\n\t\tcontext.mm = date.getMonth() + 1\r\n\r\n\t\tif context.MM < 10\r\n\t\t\tcontext.MM = \"0\" + context.MM\r\n\r\n\t\tcontext.DD = date.getDate()\r\n\r\n\t\tcontext.dd = date.getDate()\r\n\r\n\t\tif context.DD < 10\r\n\t\t\tcontext.DD = \"0\" + context.DD\r\n\r\n\t\tif context.YYYY != numberRules.year\r\n\t\t\t_NUMBER = numberRules.first_number || 1\r\n\r\n\t\tcontext.NUMBER = _.clone(_NUMBER)\r\n\r\n\t\trules = numberRules.rules.replace(\"{YYYY}\", \"' + YYYY + '\").replace(\"{MM}\", \"' + MM + '\").replace(\"{NUMBER}\", \"' + NUMBER + '\")\r\n\r\n\t\tscript = \"var newNo = '#{rules}'; exports.newNo = newNo\";\r\n\r\n\t\ttry\r\n\t\t\tres = _eval(script, \"newNo\", context, false).newNo\r\n\r\n\t\t\tdb.instance_number_rules.update({_id: numberRules._id}, {$set: {year: _YYYY, number: _NUMBER}})\r\n\r\n\t\t\tconsole.log this.userId, res\r\n\r\n\t\tcatch e\r\n\t\t\tres = {_error: e}\r\n\r\n\t\treturn res;\r\n","var _eval;\n\n_eval = require('eval');\n\nMeteor.methods({\n  instanceNumberBuilder: function(spaceId, name) {\n    var _NUMBER, _YYYY, context, date, e, numberRules, res, rules, script;\n    numberRules = db.instance_number_rules.findOne({\n      space: spaceId,\n      name: name\n    });\n    if (!numberRules) {\n      throw new Meteor.Error('error!', \"\" + name);\n    }\n    date = new Date();\n    context = {};\n    context._ = _;\n    _YYYY = date.getFullYear();\n    _NUMBER = (numberRules.number || 0) + 1;\n    context.YYYY = _.clone(_YYYY);\n    context.MM = date.getMonth() + 1;\n    context.mm = date.getMonth() + 1;\n    if (context.MM < 10) {\n      context.MM = \"0\" + context.MM;\n    }\n    context.DD = date.getDate();\n    context.dd = date.getDate();\n    if (context.DD < 10) {\n      context.DD = \"0\" + context.DD;\n    }\n    if (context.YYYY !== numberRules.year) {\n      _NUMBER = numberRules.first_number || 1;\n    }\n    context.NUMBER = _.clone(_NUMBER);\n    rules = numberRules.rules.replace(\"{YYYY}\", \"' + YYYY + '\").replace(\"{MM}\", \"' + MM + '\").replace(\"{NUMBER}\", \"' + NUMBER + '\");\n    script = \"var newNo = '\" + rules + \"'; exports.newNo = newNo\";\n    try {\n      res = _eval(script, \"newNo\", context, false).newNo;\n      db.instance_number_rules.update({\n        _id: numberRules._id\n      }, {\n        $set: {\n          year: _YYYY,\n          number: _NUMBER\n        }\n      });\n      console.log(this.userId, res);\n    } catch (error) {\n      e = error;\n      res = {\n        _error: e\n      };\n    }\n    return res;\n  }\n});\n","Meteor.methods\r\n\tcheck_main_attach: (ins_id, name)->\r\n\t\tcheck ins_id, String\r\n\t\tuuflowManager.checkMainAttach(ins_id, name)\r\n\t\treturn 'success'\r\n\r\n","Meteor.methods\r\n\tremove_related: (ins_id, re_ins_id)->\r\n\t\tcheck(ins_id, String)\r\n\t\tcheck(re_ins_id, String)\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tins = db.instances.findOne({_id: ins_id}, {fields: {related_instances: 1}})\r\n\r\n\t\tif ins\r\n\t\t\tres = ins.related_instances || []\r\n\r\n\t\t\tindex = res.indexOf(re_ins_id)\r\n\r\n\t\t\tif index > -1\r\n\t\t\t\tres.remove(index)\r\n\r\n\t\t\tset_obj = new Object;\r\n\t\t\tset_obj.modified = new Date();\r\n\t\t\tset_obj.modified_by = this.userId;\r\n\t\t\tset_obj.related_instances = res\r\n\r\n\t\t\tdb.instances.update({_id: ins_id}, {$set: set_obj})\r\n\r\n\tupdate_instance_related: (ins_id, related_instances)->\r\n\t\tcheck(ins_id, String)\r\n\t\tcheck(related_instances, Array)\r\n\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tins = db.instances.findOne({_id: ins_id, $or: [{submitter: this.userId}, {applicant: this.userId}, {inbox_users: this.userId}, {cc_users: this.userId}]}, {fields: {state: 1}})\r\n\r\n\t\tif ins\r\n\t\t\tset_obj = new Object;\r\n\t\t\tset_obj.modified = new Date();\r\n\t\t\tset_obj.modified_by = this.userId;\r\n\t\t\tset_obj.related_instances = related_instances\r\n\t\t\tdb.instances.update({_id: ins_id}, {$set: set_obj})\r\n\r\n\t\treturn db.instances.find({_id: {$in:  related_instances}}, {fields: {_id: 1, values: 1}}).fetch()\r\n","Meteor.methods({\n  remove_related: function(ins_id, re_ins_id) {\n    var index, ins, res, set_obj;\n    check(ins_id, String);\n    check(re_ins_id, String);\n    if (!this.userId) {\n      return;\n    }\n    ins = db.instances.findOne({\n      _id: ins_id\n    }, {\n      fields: {\n        related_instances: 1\n      }\n    });\n    if (ins) {\n      res = ins.related_instances || [];\n      index = res.indexOf(re_ins_id);\n      if (index > -1) {\n        res.remove(index);\n      }\n      set_obj = new Object;\n      set_obj.modified = new Date();\n      set_obj.modified_by = this.userId;\n      set_obj.related_instances = res;\n      return db.instances.update({\n        _id: ins_id\n      }, {\n        $set: set_obj\n      });\n    }\n  },\n  update_instance_related: function(ins_id, related_instances) {\n    var ins, set_obj;\n    check(ins_id, String);\n    check(related_instances, Array);\n    if (!this.userId) {\n      return;\n    }\n    ins = db.instances.findOne({\n      _id: ins_id,\n      $or: [\n        {\n          submitter: this.userId\n        }, {\n          applicant: this.userId\n        }, {\n          inbox_users: this.userId\n        }, {\n          cc_users: this.userId\n        }\n      ]\n    }, {\n      fields: {\n        state: 1\n      }\n    });\n    if (ins) {\n      set_obj = new Object;\n      set_obj.modified = new Date();\n      set_obj.modified_by = this.userId;\n      set_obj.related_instances = related_instances;\n      db.instances.update({\n        _id: ins_id\n      }, {\n        $set: set_obj\n      });\n    }\n    return db.instances.find({\n      _id: {\n        $in: related_instances\n      }\n    }, {\n      fields: {\n        _id: 1,\n        values: 1\n      }\n    }).fetch();\n  }\n});\n","Meteor.methods\r\n\tupdateFlowPosition: (data) ->\r\n\t\tdb.flow_positions.update { _id: data._id }, $set:\r\n\t\t\trole: data.role\r\n\t\t\tusers: data.users\r\n\t\t\torg: data.org\r\n\r\n\tupdateFlowRole: (data) ->\r\n\t\tconsole.log data._id\r\n\t\tconsole.log data.name\r\n\t\tdb.flow_roles.update { _id: data._id }, $set:\r\n\t\t\tname: data.name","Meteor.methods({\n  updateFlowPosition: function(data) {\n    return db.flow_positions.update({\n      _id: data._id\n    }, {\n      $set: {\n        role: data.role,\n        users: data.users,\n        org: data.org\n      }\n    });\n  },\n  updateFlowRole: function(data) {\n    console.log(data._id);\n    console.log(data.name);\n    return db.flow_roles.update({\n      _id: data._id\n    }, {\n      $set: {\n        name: data.name\n      }\n    });\n  }\n});\n","Meteor.methods\r\n\tstart_flow: (space, flowId, start) ->\r\n\r\n\t\tkeyValue = db.steedos_keyvalues.findOne({ space: space, user: this.userId, key: 'start_flows' }, { fields: { value: 1 } })\r\n\r\n\t\tstart_flows = keyValue?.value || []\r\n\r\n\t\tif start\r\n\t\t\tstart_flows.push(flowId)\r\n\r\n\t\t\tstart_flows = _.uniq(start_flows)\r\n\t\telse\r\n\t\t\tstart_flows.remove(start_flows.indexOf(flowId))\r\n\r\n\t\tif keyValue\r\n\t\t\tdb.steedos_keyvalues.update({ _id: keyValue._id }, { space: space, user: this.userId, key: 'start_flows', value: start_flows })\r\n\t\telse\r\n\t\t\tdb.steedos_keyvalues.insert({ space: space, user: this.userId, key: 'start_flows', value: start_flows })\r\n\r\n","Meteor.methods({\n  start_flow: function(space, flowId, start) {\n    var keyValue, start_flows;\n    keyValue = db.steedos_keyvalues.findOne({\n      space: space,\n      user: this.userId,\n      key: 'start_flows'\n    }, {\n      fields: {\n        value: 1\n      }\n    });\n    start_flows = (keyValue != null ? keyValue.value : void 0) || [];\n    if (start) {\n      start_flows.push(flowId);\n      start_flows = _.uniq(start_flows);\n    } else {\n      start_flows.remove(start_flows.indexOf(flowId));\n    }\n    if (keyValue) {\n      return db.steedos_keyvalues.update({\n        _id: keyValue._id\n      }, {\n        space: space,\n        user: this.userId,\n        key: 'start_flows',\n        value: start_flows\n      });\n    } else {\n      return db.steedos_keyvalues.insert({\n        space: space,\n        user: this.userId,\n        key: 'start_flows',\n        value: start_flows\n      });\n    }\n  }\n});\n","Meteor.methods\r\n\tget_instance_traces: (ins_id)->\r\n\t\tif (!this.userId)\r\n\t\t\treturn;\r\n\t\tminiApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description',\r\n\t\t\t'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description']\r\n\r\n\t\tins = db.instances.findOne {_id: ins_id}, {\r\n\t\t\tfields: {\r\n\t\t\t\t\"traces._id\": 1,\r\n\t\t\t\t\"traces.is_finished\": 1,\r\n\t\t\t\t\"traces.step\": 1,\r\n\t\t\t\t\"traces.start_date\": 1,\r\n\t\t\t\t\"traces.name\": 1,\r\n\t\t\t\t\"traces.finish_date\": 1,\r\n\t\t\t\t\"traces.judge\": 1,\r\n\t\t\t\t\"traces.approves._id\": 1,\r\n\t\t\t\t\"traces.approves.is_finished\": 1,\r\n\t\t\t\t\"traces.approves.user\": 1,\r\n\t\t\t\t\"traces.approves.handler\": 1,\r\n\t\t\t\t\"traces.approves.handler_name\": 1,\r\n\t\t\t\t\"traces.approves.handler_organization_fullname\": 1,\r\n\t\t\t\t\"traces.approves.type\": 1,\r\n\t\t\t\t\"traces.approves.start_date\": 1,\r\n\t\t\t\t\"traces.approves.description\": 1,\r\n\t\t\t\t\"traces.approves.is_read\": 1,\r\n\t\t\t\t\"traces.approves.judge\": 1,\r\n\t\t\t\t\"traces.approves.finish_date\": 1,\r\n\t\t\t\t\"traces.approves.from_user_name\": 1,\r\n\t\t\t\t\"traces.approves.from_user\": 1,\r\n\t\t\t\t\"traces.approves.cc_description\": 1,\r\n\t\t\t\t\"traces.approves.trace\": 1,\r\n\t\t\t\t\"traces.approves.forward_space\": 1,\r\n\t\t\t\t\"traces.approves.forward_instance\": 1\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif !ins\r\n\t\t\treturn\r\n\r\n\t\treturn ins?.traces\r\n\r\n","Meteor.methods({\n  get_instance_traces: function(ins_id) {\n    var ins, miniApproveFields;\n    if (!this.userId) {\n      return;\n    }\n    miniApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description', 'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description'];\n    ins = db.instances.findOne({\n      _id: ins_id\n    }, {\n      fields: {\n        \"traces._id\": 1,\n        \"traces.is_finished\": 1,\n        \"traces.step\": 1,\n        \"traces.start_date\": 1,\n        \"traces.name\": 1,\n        \"traces.finish_date\": 1,\n        \"traces.judge\": 1,\n        \"traces.approves._id\": 1,\n        \"traces.approves.is_finished\": 1,\n        \"traces.approves.user\": 1,\n        \"traces.approves.handler\": 1,\n        \"traces.approves.handler_name\": 1,\n        \"traces.approves.handler_organization_fullname\": 1,\n        \"traces.approves.type\": 1,\n        \"traces.approves.start_date\": 1,\n        \"traces.approves.description\": 1,\n        \"traces.approves.is_read\": 1,\n        \"traces.approves.judge\": 1,\n        \"traces.approves.finish_date\": 1,\n        \"traces.approves.from_user_name\": 1,\n        \"traces.approves.from_user\": 1,\n        \"traces.approves.cc_description\": 1,\n        \"traces.approves.trace\": 1,\n        \"traces.approves.forward_space\": 1,\n        \"traces.approves.forward_instance\": 1\n      }\n    });\n    if (!ins) {\n      return;\n    }\n    return ins != null ? ins.traces : void 0;\n  }\n});\n","Meteor.methods\r\n\t'get_batch_instances': (space, categoryId, flowIds)->\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tif !space\r\n\t\t\treturn\r\n\r\n\t\t_batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId)\r\n\r\n\t\treturn _batch_instances\r\n\r\n\t'get_batch_instances_count': (space, categoryId, flowIds)->\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tif !space\r\n\t\t\treturn\r\n\r\n\t\t_batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId)\r\n\r\n\t\treturn _batch_instances?.length || 0\r\n\r\n\t'get_my_approves': (instanceIds)->\r\n\r\n\t\tthat = this\r\n\r\n\t\tif !that.userId\r\n\t\t\treturn\r\n\r\n\t\tmyApproves = new Array()\r\n\r\n\t\tinstanceIds.forEach (insId)->\r\n\t\t\tmy_approve = InstanceManager.getMyApprove(insId, that.userId)\r\n\t\t\tif my_approve\r\n\t\t\t\tmyApproves.push(my_approve)\r\n\r\n\t\treturn myApproves\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","Meteor.methods({\n  'get_batch_instances': function(space, categoryId, flowIds) {\n    var _batch_instances;\n    if (!this.userId) {\n      return;\n    }\n    if (!space) {\n      return;\n    }\n    _batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId);\n    return _batch_instances;\n  },\n  'get_batch_instances_count': function(space, categoryId, flowIds) {\n    var _batch_instances;\n    if (!this.userId) {\n      return;\n    }\n    if (!space) {\n      return;\n    }\n    _batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId);\n    return (_batch_instances != null ? _batch_instances.length : void 0) || 0;\n  },\n  'get_my_approves': function(instanceIds) {\n    var myApproves, that;\n    that = this;\n    if (!that.userId) {\n      return;\n    }\n    myApproves = new Array();\n    instanceIds.forEach(function(insId) {\n      var my_approve;\n      my_approve = InstanceManager.getMyApprove(insId, that.userId);\n      if (my_approve) {\n        return myApproves.push(my_approve);\n      }\n    });\n    return myApproves;\n  }\n});\n","Meteor.methods\r\n\tchange_flow_state: (flows) ->\r\n\t\tcheck flows, Array\r\n\r\n\t\t_userId = this.userId\r\n\r\n\t\tif !_userId\r\n\t\t\treturn\r\n\r\n\t\tflows.forEach (flow) ->\r\n\t\t\tspaceId = flow.space\r\n\t\t\tformId = flow.form\r\n\t\t\tflowId = flow.id\r\n\t\t\tstate = flow.state\r\n\r\n\t\t\tif !Steedos.isSpaceAdmin(spaceId, _userId)\r\n\t\t\t\tthrow  Meteor.Error(401, \"No permission\")\r\n\r\n\t\t\tform = db.forms.findOne({ _id: formId }, { fields: { historys: 0 } })\r\n\r\n\t\t\tflow = db.flows.findOne({ _id: flowId }, { fields: { historys: 0 } })\r\n\r\n\t\t\tif state != 'enabled' && state != 'disabled'\r\n\t\t\t\tthrow new Meteor.Error(500, \"stateæ— æ•ˆ\")\r\n\r\n\t\t\tif !form\r\n\t\t\t\tthrow new Meteor.Error(500, \"formæ— æ•ˆ\")\r\n\r\n\t\t\tif !flow\r\n\t\t\t\tthrow new Meteor.Error(500, \"flowæ— æ•ˆ\")\r\n\r\n\t\t\tif !form.is_valid\r\n\t\t\t\tthrow new Meteor.Error(500, \"æµç¨‹å¼•ç”¨çš„è¡¨å•[#{form.name}]éªŒè¯æœªé€šè¿‡ï¼Œè¯·æ‰“å¼€æµç¨‹è®¾è®¡å™¨æ£€æŸ¥è¡¨å•è®¾ç½®\")\r\n\r\n\t\t\tif !flow.is_valid\r\n\t\t\t\tthrow new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼Œè¯·æ‰“å¼€æµç¨‹è®¾è®¡å™¨æ£€æŸ¥æµç¨‹è®¾ç½®\")\r\n\r\n\t\t\tif !['new', 'modify', 'delete'].includes(flow.flowtype)\r\n\t\t\t\tthrow new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼Œflowtypeå€¼å¿…é¡»æ˜¯newã€modifyã€deleteå…¶ä¸­ä¹‹ä¸€\")\r\n\r\n\t\t\tif !_.isArray(flow.current.steps)\r\n\t\t\t\tthrow new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼Œæµç¨‹çš„æ­¥éª¤ä¸èƒ½ä¸ºç©º\")\r\n\r\n\t\t\tif _.uniq(flow.current.steps, 'name').length != flow.current.steps.length\r\n\t\t\t\tthrow new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼ŒåŒä¸€ä¸ªæµç¨‹ä¸‹çš„æ­¥éª¤çš„åç§°ä¸èƒ½é‡å¤\")\r\n\r\n\t\t\tnow = new Date\r\n\r\n\t\t\tif state == 'enabled'\r\n\t\t\t\t#æµç¨‹å¯ç”¨å‰ï¼Œæ ¡éªŒå…¶â€œæŒ‡å®šåŽ†å²æ­¥éª¤â€å±žæ€§ä¸­è¢«å¼•ç”¨çš„æ­¥éª¤æ˜¯å¦å­˜åœ¨ä¸”èƒ½è¢«æ‰¾åˆ°ï¼ˆä»…é™äºŽæµç¨‹çš„æœ€æ–°ç‰ˆï¼‰\r\n\t\t\t\tflow.current.steps.forEach (step) ->\r\n\t\t\t\t\tif ['specifyStepUser', 'specifyStepRole'].includes(step.deal_type)\r\n\t\t\t\t\t\tif !step.approver_step\r\n\t\t\t\t\t\t\tthrow new Meteor.Error(500, \"æ­¥éª¤[#{step.name}]ä¸­çš„æŒ‡å®šåŽ†å²æ­¥éª¤ä¸å­˜åœ¨ã€‚\")\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tspecifyStep = _.find flow.current.steps, (_step) ->\r\n\t\t\t\t\t\t\t\treturn step.approver_step == _step._id\r\n\r\n\t\t\t\t\t\t\tif !specifyStep\r\n\t\t\t\t\t\t\t\tthrow new Meteor.Error(500, \"æ­¥éª¤[#{step.name}]ä¸­çš„æŒ‡å®šåŽ†å²æ­¥éª¤ä¸å­˜åœ¨ã€‚\")\r\n\r\n\t\t\t\tform_current_fields_code = form.current.fields.getProperty(\"code\")\r\n\r\n\t\t\t\tflow.current.steps.forEach (step) ->\r\n\t\t\t\t\tstep.fields_modifiable = _.intersection(step.fields_modifiable, form_current_fields_code)\r\n\r\n\t\t\t\t#å¦‚æžœ æµç¨‹å¯¹åº”è¡¨å• æ˜¯åœç”¨çš„ åˆ™å¯ç”¨\r\n\t\t\t\tif form.state == 'disabled'\r\n\t\t\t\t\tdb.forms.update({_id: form._id}, {$set: {\"state\": \"enabled\", \"current.start_date\": now, \"current.modified\": now, \"current.modified_by\": _userId}})\r\n\r\n\t\t\t\tflow.current.modified = now\r\n\t\t\t\tflow.current.start_date = now\r\n\t\t\t\tflow.current.modified_by = _userId\r\n\r\n\t\t\t\tdb.flows.update({ _id: flow._id }, { $set: { \"state\": \"enabled\", \"current\": flow.current } })\r\n\r\n\t\t\telse\r\n\t\t\t\t#ç¦ç”¨æµç¨‹\r\n\t\t\t\tdb.flows.update({_id: flow._id}, {$set: {\"state\": \"disabled\", \"current.modified\": now, \"current.start_date\": now, \"current.modified_by\": _userId}})\r\n\r\n\t\t\t\t# åˆ¤æ–­è¡¨å•æ‰€æœ‰æµç¨‹æ˜¯å¦å·²ç»å…¨éƒ¨åœç”¨ å¦‚æžœå·²å…¨éƒ¨åœç”¨ åˆ™ä¿®æ”¹è¡¨å•çŠ¶æ€ä¸ºåœç”¨\r\n\t\t\t\t_flows = db.flows.find({ form: form._id }, { fields: { _id: 1, state: 1 } }).fetch()\r\n\r\n\t\t\t\t_flows_state = _flows.getProperty(\"state\")\r\n\r\n\t\t\t\tif !_flows_state.includes('enabled')\r\n\t\t\t\t\tdb.forms.update({_id: form._id}, {$set: {\"state\": \"disabled\", \"current.modified\": now, \"current.start_date\": now, \"current.modified_by\": _userId}})\r\n\r\n\r\n\r\n\r\n","Meteor.methods({\n  change_flow_state: function(flows) {\n    var _userId;\n    check(flows, Array);\n    _userId = this.userId;\n    if (!_userId) {\n      return;\n    }\n    return flows.forEach(function(flow) {\n      var _flows, _flows_state, flowId, form, formId, form_current_fields_code, now, spaceId, state;\n      spaceId = flow.space;\n      formId = flow.form;\n      flowId = flow.id;\n      state = flow.state;\n      if (!Steedos.isSpaceAdmin(spaceId, _userId)) {\n        throw Meteor.Error(401, \"No permission\");\n      }\n      form = db.forms.findOne({\n        _id: formId\n      }, {\n        fields: {\n          historys: 0\n        }\n      });\n      flow = db.flows.findOne({\n        _id: flowId\n      }, {\n        fields: {\n          historys: 0\n        }\n      });\n      if (state !== 'enabled' && state !== 'disabled') {\n        throw new Meteor.Error(500, \"stateæ— æ•ˆ\");\n      }\n      if (!form) {\n        throw new Meteor.Error(500, \"formæ— æ•ˆ\");\n      }\n      if (!flow) {\n        throw new Meteor.Error(500, \"flowæ— æ•ˆ\");\n      }\n      if (!form.is_valid) {\n        throw new Meteor.Error(500, \"æµç¨‹å¼•ç”¨çš„è¡¨å•[\" + form.name + \"]éªŒè¯æœªé€šè¿‡ï¼Œè¯·æ‰“å¼€æµç¨‹è®¾è®¡å™¨æ£€æŸ¥è¡¨å•è®¾ç½®\");\n      }\n      if (!flow.is_valid) {\n        throw new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼Œè¯·æ‰“å¼€æµç¨‹è®¾è®¡å™¨æ£€æŸ¥æµç¨‹è®¾ç½®\");\n      }\n      if (!['new', 'modify', 'delete'].includes(flow.flowtype)) {\n        throw new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼Œflowtypeå€¼å¿…é¡»æ˜¯newã€modifyã€deleteå…¶ä¸­ä¹‹ä¸€\");\n      }\n      if (!_.isArray(flow.current.steps)) {\n        throw new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼Œæµç¨‹çš„æ­¥éª¤ä¸èƒ½ä¸ºç©º\");\n      }\n      if (_.uniq(flow.current.steps, 'name').length !== flow.current.steps.length) {\n        throw new Meteor.Error(500, \"æµç¨‹éªŒè¯æœªé€šè¿‡ï¼ŒåŒä¸€ä¸ªæµç¨‹ä¸‹çš„æ­¥éª¤çš„åç§°ä¸èƒ½é‡å¤\");\n      }\n      now = new Date;\n      if (state === 'enabled') {\n        flow.current.steps.forEach(function(step) {\n          var specifyStep;\n          if (['specifyStepUser', 'specifyStepRole'].includes(step.deal_type)) {\n            if (!step.approver_step) {\n              throw new Meteor.Error(500, \"æ­¥éª¤[\" + step.name + \"]ä¸­çš„æŒ‡å®šåŽ†å²æ­¥éª¤ä¸å­˜åœ¨ã€‚\");\n            } else {\n              specifyStep = _.find(flow.current.steps, function(_step) {\n                return step.approver_step === _step._id;\n              });\n              if (!specifyStep) {\n                throw new Meteor.Error(500, \"æ­¥éª¤[\" + step.name + \"]ä¸­çš„æŒ‡å®šåŽ†å²æ­¥éª¤ä¸å­˜åœ¨ã€‚\");\n              }\n            }\n          }\n        });\n        form_current_fields_code = form.current.fields.getProperty(\"code\");\n        flow.current.steps.forEach(function(step) {\n          return step.fields_modifiable = _.intersection(step.fields_modifiable, form_current_fields_code);\n        });\n        if (form.state === 'disabled') {\n          db.forms.update({\n            _id: form._id\n          }, {\n            $set: {\n              \"state\": \"enabled\",\n              \"current.start_date\": now,\n              \"current.modified\": now,\n              \"current.modified_by\": _userId\n            }\n          });\n        }\n        flow.current.modified = now;\n        flow.current.start_date = now;\n        flow.current.modified_by = _userId;\n        return db.flows.update({\n          _id: flow._id\n        }, {\n          $set: {\n            \"state\": \"enabled\",\n            \"current\": flow.current\n          }\n        });\n      } else {\n        db.flows.update({\n          _id: flow._id\n        }, {\n          $set: {\n            \"state\": \"disabled\",\n            \"current.modified\": now,\n            \"current.start_date\": now,\n            \"current.modified_by\": _userId\n          }\n        });\n        _flows = db.flows.find({\n          form: form._id\n        }, {\n          fields: {\n            _id: 1,\n            state: 1\n          }\n        }).fetch();\n        _flows_state = _flows.getProperty(\"state\");\n        if (!_flows_state.includes('enabled')) {\n          return db.forms.update({\n            _id: form._id\n          }, {\n            $set: {\n              \"state\": \"disabled\",\n              \"current.modified\": now,\n              \"current.start_date\": now,\n              \"current.modified_by\": _userId\n            }\n          });\n        }\n      }\n    });\n  }\n});\n","Meteor.methods\r\n\r\n\thide_instance: (insId, is_hidden) ->\r\n\t\tif !this.userId\r\n\t\t\treturn\r\n\r\n\t\tcheck(insId, String)\r\n\t\tcheck(is_hidden, Boolean)\r\n\r\n\t\tuserId = this.userId\r\n\r\n\t\tinstance = db.instances.findOne(insId, { fields: { state: 1, flow: 1, space: 1 } })\r\n\r\n\t\tif not instance\r\n\t\t\tthrow new Meteor.Error('error!', \"æœªæ‰¾åˆ°ç”³è¯·å•\")\r\n\r\n\t\tif instance.state isnt 'completed'\r\n\t\t\tthrow new Meteor.Error('error!', \"ç”³è¯·å•çŠ¶æ€ä¸æ˜¯å·²ç»“æŸ\")\r\n\r\n\t\t# éªŒè¯login user_idå¯¹è¯¥æµç¨‹æœ‰ç®¡ç†ç”³è¯·å•çš„æƒé™\r\n\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, userId)\r\n\t\tspace = db.spaces.findOne(instance.space, { fields: { admins: 1 } })\r\n\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(userId))\r\n\t\t\tthrow new Meteor.Error('error!', \"ç”¨æˆ·æ²¡æœ‰å¯¹å½“å‰æµç¨‹çš„ç®¡ç†æƒé™\")\r\n\r\n\t\tdb.instances.update(insId, { $set: { is_hidden: is_hidden } })\r\n\r\n\t\treturn true;\r\n","Meteor.methods({\n  hide_instance: function(insId, is_hidden) {\n    var instance, permissions, space, userId;\n    if (!this.userId) {\n      return;\n    }\n    check(insId, String);\n    check(is_hidden, Boolean);\n    userId = this.userId;\n    instance = db.instances.findOne(insId, {\n      fields: {\n        state: 1,\n        flow: 1,\n        space: 1\n      }\n    });\n    if (!instance) {\n      throw new Meteor.Error('error!', \"æœªæ‰¾åˆ°ç”³è¯·å•\");\n    }\n    if (instance.state !== 'completed') {\n      throw new Meteor.Error('error!', \"ç”³è¯·å•çŠ¶æ€ä¸æ˜¯å·²ç»“æŸ\");\n    }\n    permissions = permissionManager.getFlowPermissions(instance.flow, userId);\n    space = db.spaces.findOne(instance.space, {\n      fields: {\n        admins: 1\n      }\n    });\n    if ((!permissions.includes(\"admin\")) && (!space.admins.includes(userId))) {\n      throw new Meteor.Error('error!', \"ç”¨æˆ·æ²¡æœ‰å¯¹å½“å‰æµç¨‹çš„ç®¡ç†æƒé™\");\n    }\n    db.instances.update(insId, {\n      $set: {\n        is_hidden: is_hidden\n      }\n    });\n    return true;\n  }\n});\n","Meteor.methods\r\n\tgetInstanceValues: (insId)->\r\n\t\tif (!this.userId)\r\n\t\t\treturn;\r\n\t\treturn db.instances.findOne({_id: insId}, {fields: {values: 1}})?.values","Meteor.methods({\n  getInstanceValues: function(insId) {\n    var ref;\n    if (!this.userId) {\n      return;\n    }\n    return (ref = db.instances.findOne({\n      _id: insId\n    }, {\n      fields: {\n        values: 1\n      }\n    })) != null ? ref.values : void 0;\n  }\n});\n","Cookies = require(\"cookies\")\r\n\r\ngetInstanceReadOnly = (req, res, next, options) ->\r\n\r\n\tuser = Steedos.getAPILoginUser(req, res)\r\n\r\n\tif req?.query?.access_token\r\n\t\tuserId = Steedos.getUserIdFromAccessToken(req.query.access_token)\r\n\t\tif userId\r\n\t\t\tuser = Meteor.users.findOne({_id: userId})\r\n\r\n\tspaceId = req.params.space\r\n\r\n\tinstanceId = req.params.instance_id\r\n\r\n\tinstance = db.instances.findOne({_id: instanceId});\r\n\r\n\tspace = db.spaces.findOne({_id: spaceId});\r\n\r\n\thide_traces = req.query?.hide_traces\r\n\r\n\tif !options\r\n\t\toptions = {showTrace: true}\r\n\telse\r\n\t\toptions.showTrace = true\r\n\r\n\tif hide_traces is \"1\"\r\n\t\tif options\r\n\t\t\toptions.showTrace = false\r\n\t\telse\r\n\t\t\toptions = {showTrace: false}\r\n\r\n\tif !options.showAttachments\r\n\t\toptions.showAttachments = true\r\n\r\n\tif !space\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 401,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Missing space\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\tif  !instance\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 401,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Missing instance\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\tif !user\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 401,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\tif instance.space != spaceId\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 401,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Missing space or instance\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\r\n\r\n\tspaceUserCount = db.space_users.find({ user: user._id, space: spaceId }).count()\r\n\r\n\tif spaceUserCount is 0\r\n\t\tif !space\r\n\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 401,\r\n\t\t\t\tdata:\r\n\t\t\t\t\t\"error\": \"Validate Request -- Missing sapceUser\",\r\n\t\t\t\t\t\"success\": false\r\n\t\t\treturn;\r\n\r\n\t#æ ¡éªŒuseræ˜¯å¦å¯¹instanceæœ‰æŸ¥çœ‹æƒé™\r\n\t_hasPermission = WorkflowManager.hasInstancePermissions(user, instance)\r\n\r\n\tif !_hasPermission  && instance.distribute_from_instance\r\n\t\t_parent_instances = _.union([instance.distribute_from_instance], instance.distribute_from_instances || [])\r\n\r\n\t\t_hasPermission = _.find _parent_instances, (_parent_id)->\r\n\t\t\t_parent_ins = db.instances.findOne({_id:_parent_id}, {fields: {traces: 0}})\r\n\r\n\t\t\treturn WorkflowManager.hasInstancePermissions(user, _parent_ins)\r\n\r\n\tif !_hasPermission\r\n\t\t_locale = Steedos.locale(user._id, true)\r\n\t\terror = TAPi18n.__(\"instance_permissions_error\", {}, _locale)\r\n\t\tres.charset = \"utf-8\"\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 401,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": error,\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\thtml = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options)\r\n\tdataBuf = new Buffer(html);\r\n\tres.setHeader('content-length', dataBuf.length)\r\n\tres.setHeader('content-range', \"bytes 0-#{dataBuf.length - 1}/#{dataBuf.length}\")\r\n\tres.statusCode = 200\r\n\tres.end(html)\r\n\r\nJsonRoutes.add \"get\", \"/workflow/space/:space/view/readonly/:instance_id\", getInstanceReadOnly\r\n\r\nJsonRoutes.add \"get\", \"/workflow/space/:space/view/readonly/:instance_id/:instance_name\", (req, res, next)->\r\n\tres.setHeader('Content-type', 'application/x-msdownload');\r\n\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(req.params.instance_name));\r\n\tres.setHeader('Transfer-Encoding', '')\r\n\r\n\toptions = {absolute: true}\r\n\r\n\treturn getInstanceReadOnly(req, res, next, options)\r\n###\r\n\tèŽ·å–ç”³è¯·å•åˆ—è¡¨ï¼š\r\n    final_decisionï¼šå®¡æ‰¹ç»“æžœ\r\n    state: ç”³è¯·å•çŠ¶æ€\r\n###\r\nJsonRoutes.add \"get\", \"/api/workflow/instances\", (req, res, next) ->\r\n\r\n\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\treturn ;\r\n\r\n\tuser_id = req.userId\r\n\r\n\tspaceId = req.headers[\"x-space-id\"]\r\n\r\n\tif not spaceId\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 401,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Space-Id\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\tflowId = req.query?.flowId\r\n\r\n\tif !flowId\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 400,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Missing flowId\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\tquery = {}\r\n\r\n\tret_sync_token = new Date().getTime()\r\n\r\n\tflowIds = flowId.split(\",\")\r\n\r\n\r\n\tflows = db.flows.find({_id: {$in: flowIds}}).fetch()\r\n\r\n\ti = 0\r\n\twhile i < flows.length\r\n\t\tf = flows[i]\r\n\t\tspaceUser = db.space_users.findOne({space: f.space, user: user_id})\r\n\t\tif !spaceUser\r\n\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 401,\r\n\t\t\t\tdata:\r\n\t\t\t\t\t\"error\": \"Validate Request -- No permission, flow is #{f._id}\",\r\n\t\t\t\t\t\"success\": false\r\n\t\t\treturn;\r\n\t\telse\r\n\r\n\t#\tæ˜¯å¦å·¥ä½œåŒºç®¡ç†å‘˜\r\n\t\tif !Steedos.isSpaceAdmin(spaceId, user_id)\r\n\t\t\tspaceUserOrganizations = db.organizations.find({\r\n\t\t\t\t_id: {\r\n\t\t\t\t\t$in: spaceUser.organizations\r\n\t\t\t\t}\r\n\t\t\t}).fetch();\r\n\r\n\t\t\tif !WorkflowManager.canMonitor(f, spaceUser, spaceUserOrganizations) && !WorkflowManager.canAdmin(f, spaceUser, spaceUserOrganizations)\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 401,\r\n\t\t\t\t\tdata:\r\n\t\t\t\t\t\t\"error\": \"Validate Request -- No permission, flow is #{f._id}\",\r\n\t\t\t\t\t\t\"success\": false\r\n\t\t\t\treturn;\r\n\t\ti++\r\n\r\n\r\n\tquery.flow = {$in: flowIds}\r\n\r\n\tquery.space = spaceId\r\n\r\n\tif req.query?.sync_token\r\n\t\tsync_token = new Date(Number(req.query.sync_token))\r\n\t\tquery.modified = {$gt: sync_token}\r\n\r\n\tif req.query?.final_decision\r\n\t\tquery.final_decision = {$in : req.query.final_decision.split(\",\")}\r\n\telse\r\n\t\tquery.final_decision = {$nin: [\"terminated\", \"rejected\"]}\r\n\r\n\tif req.query?.state\r\n\t\tquery.state = {$in: req.query.state.split(\",\")}\r\n\telse\r\n\t\tquery.state = \"completed\"\r\n\r\n#\tæœ€å¤šè¿”å›ž500æ¡æ•°æ®\r\n\tinstances = db.instances.find(query, {fields: {inbox_uers: 0, cc_users: 0, outbox_users: 0, traces: 0, attachments: 0}, skip: 0, limit: 500}).fetch()\r\n\tinstances.forEach (instance)->\r\n\r\n\t\tattachments = cfs.instances.find({'metadata.instance': instance._id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\r\n\r\n\t\tinstance.attachments = attachments\r\n\r\n\r\n\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200,\r\n\t\t\tdata:\r\n\t\t\t\t\"status\": \"success\",\r\n\t\t\t\t\"sync_token\": ret_sync_token\r\n\t\t\t\t\"data\": instances\r\n\treturn;\r\n","var Cookies, getInstanceReadOnly;\n\nCookies = require(\"cookies\");\n\ngetInstanceReadOnly = function(req, res, next, options) {\n  var _hasPermission, _locale, _parent_instances, dataBuf, error, hide_traces, html, instance, instanceId, ref, ref1, space, spaceId, spaceUserCount, user, userId;\n  user = Steedos.getAPILoginUser(req, res);\n  if (req != null ? (ref = req.query) != null ? ref.access_token : void 0 : void 0) {\n    userId = Steedos.getUserIdFromAccessToken(req.query.access_token);\n    if (userId) {\n      user = Meteor.users.findOne({\n        _id: userId\n      });\n    }\n  }\n  spaceId = req.params.space;\n  instanceId = req.params.instance_id;\n  instance = db.instances.findOne({\n    _id: instanceId\n  });\n  space = db.spaces.findOne({\n    _id: spaceId\n  });\n  hide_traces = (ref1 = req.query) != null ? ref1.hide_traces : void 0;\n  if (!options) {\n    options = {\n      showTrace: true\n    };\n  } else {\n    options.showTrace = true;\n  }\n  if (hide_traces === \"1\") {\n    if (options) {\n      options.showTrace = false;\n    } else {\n      options = {\n        showTrace: false\n      };\n    }\n  }\n  if (!options.showAttachments) {\n    options.showAttachments = true;\n  }\n  if (!space) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing space\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (!instance) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing instance\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (!user) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (instance.space !== spaceId) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing space or instance\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  spaceUserCount = db.space_users.find({\n    user: user._id,\n    space: spaceId\n  }).count();\n  if (spaceUserCount === 0) {\n    if (!space) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing sapceUser\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n  }\n  _hasPermission = WorkflowManager.hasInstancePermissions(user, instance);\n  if (!_hasPermission && instance.distribute_from_instance) {\n    _parent_instances = _.union([instance.distribute_from_instance], instance.distribute_from_instances || []);\n    _hasPermission = _.find(_parent_instances, function(_parent_id) {\n      var _parent_ins;\n      _parent_ins = db.instances.findOne({\n        _id: _parent_id\n      }, {\n        fields: {\n          traces: 0\n        }\n      });\n      return WorkflowManager.hasInstancePermissions(user, _parent_ins);\n    });\n  }\n  if (!_hasPermission) {\n    _locale = Steedos.locale(user._id, true);\n    error = TAPi18n.__(\"instance_permissions_error\", {}, _locale);\n    res.charset = \"utf-8\";\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": error,\n        \"success\": false\n      }\n    });\n    return;\n  }\n  html = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options);\n  dataBuf = new Buffer(html);\n  res.setHeader('content-length', dataBuf.length);\n  res.setHeader('content-range', \"bytes 0-\" + (dataBuf.length - 1) + \"/\" + dataBuf.length);\n  res.statusCode = 200;\n  return res.end(html);\n};\n\nJsonRoutes.add(\"get\", \"/workflow/space/:space/view/readonly/:instance_id\", getInstanceReadOnly);\n\nJsonRoutes.add(\"get\", \"/workflow/space/:space/view/readonly/:instance_id/:instance_name\", function(req, res, next) {\n  var options;\n  res.setHeader('Content-type', 'application/x-msdownload');\n  res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(req.params.instance_name));\n  res.setHeader('Transfer-Encoding', '');\n  options = {\n    absolute: true\n  };\n  return getInstanceReadOnly(req, res, next, options);\n});\n\n\n/*\n\tèŽ·å–ç”³è¯·å•åˆ—è¡¨ï¼š\n    final_decisionï¼šå®¡æ‰¹ç»“æžœ\n    state: ç”³è¯·å•çŠ¶æ€\n */\n\nJsonRoutes.add(\"get\", \"/api/workflow/instances\", function(req, res, next) {\n  var f, flowId, flowIds, flows, i, instances, query, ref, ref1, ref2, ref3, ret_sync_token, spaceId, spaceUser, spaceUserOrganizations, sync_token, user_id;\n  if (!Steedos.APIAuthenticationCheck(req, res)) {\n    return;\n  }\n  user_id = req.userId;\n  spaceId = req.headers[\"x-space-id\"];\n  if (!spaceId) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing X-Space-Id\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  flowId = (ref = req.query) != null ? ref.flowId : void 0;\n  if (!flowId) {\n    JsonRoutes.sendResult(res, {\n      code: 400,\n      data: {\n        \"error\": \"Validate Request -- Missing flowId\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  query = {};\n  ret_sync_token = new Date().getTime();\n  flowIds = flowId.split(\",\");\n  flows = db.flows.find({\n    _id: {\n      $in: flowIds\n    }\n  }).fetch();\n  i = 0;\n  while (i < flows.length) {\n    f = flows[i];\n    spaceUser = db.space_users.findOne({\n      space: f.space,\n      user: user_id\n    });\n    if (!spaceUser) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- No permission, flow is \" + f._id,\n          \"success\": false\n        }\n      });\n      return;\n    } else {\n\n    }\n    if (!Steedos.isSpaceAdmin(spaceId, user_id)) {\n      spaceUserOrganizations = db.organizations.find({\n        _id: {\n          $in: spaceUser.organizations\n        }\n      }).fetch();\n      if (!WorkflowManager.canMonitor(f, spaceUser, spaceUserOrganizations) && !WorkflowManager.canAdmin(f, spaceUser, spaceUserOrganizations)) {\n        JsonRoutes.sendResult(res, {\n          code: 401,\n          data: {\n            \"error\": \"Validate Request -- No permission, flow is \" + f._id,\n            \"success\": false\n          }\n        });\n        return;\n      }\n    }\n    i++;\n  }\n  query.flow = {\n    $in: flowIds\n  };\n  query.space = spaceId;\n  if ((ref1 = req.query) != null ? ref1.sync_token : void 0) {\n    sync_token = new Date(Number(req.query.sync_token));\n    query.modified = {\n      $gt: sync_token\n    };\n  }\n  if ((ref2 = req.query) != null ? ref2.final_decision : void 0) {\n    query.final_decision = {\n      $in: req.query.final_decision.split(\",\")\n    };\n  } else {\n    query.final_decision = {\n      $nin: [\"terminated\", \"rejected\"]\n    };\n  }\n  if ((ref3 = req.query) != null ? ref3.state : void 0) {\n    query.state = {\n      $in: req.query.state.split(\",\")\n    };\n  } else {\n    query.state = \"completed\";\n  }\n  instances = db.instances.find(query, {\n    fields: {\n      inbox_uers: 0,\n      cc_users: 0,\n      outbox_users: 0,\n      traces: 0,\n      attachments: 0\n    },\n    skip: 0,\n    limit: 500\n  }).fetch();\n  instances.forEach(function(instance) {\n    var attachments;\n    attachments = cfs.instances.find({\n      'metadata.instance': instance._id,\n      'metadata.current': true,\n      \"metadata.is_private\": {\n        $ne: true\n      }\n    }, {\n      fields: {\n        copies: 0\n      }\n    }).fetch();\n    return instance.attachments = attachments;\n  });\n  JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      \"status\": \"success\",\n      \"sync_token\": ret_sync_token,\n      \"data\": instances\n    }\n  });\n});\n","\r\nJsonRoutes.add \"get\", \"/steedos-css\", (req, res, next)->\r\n\r\n\tallCss = WebApp.getRefreshableAssets()\r\n\r\n\tallCssLink = \"\"\r\n\r\n\tallCss.forEach (css) ->\r\n\t\tif __meteor_runtime_config__.ROOT_URL_PATH_PREFIX\r\n\t\t\trootUrl = __meteor_runtime_config__.ROOT_URL\r\n\t\t\tif rootUrl.endsWith(\"/\")\r\n\t\t\t\tcssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX + \"/\", \"\") + css.url\r\n\t\t\telse\r\n\t\t\t\tcssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX, \"\") + css.url\r\n\t\telse\r\n\t\t\tcssHref = Meteor.absoluteUrl(css.url)\r\n\t\tallCssLink += \"@import url(#{cssHref});\"\r\n\r\n\tres.statusCode = 200\r\n\tres.end(allCssLink)","JsonRoutes.add(\"get\", \"/steedos-css\", function(req, res, next) {\n  var allCss, allCssLink;\n  allCss = WebApp.getRefreshableAssets();\n  allCssLink = \"\";\n  allCss.forEach(function(css) {\n    var cssHref, rootUrl;\n    if (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX) {\n      rootUrl = __meteor_runtime_config__.ROOT_URL;\n      if (rootUrl.endsWith(\"/\")) {\n        cssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX + \"/\", \"\") + css.url;\n      } else {\n        cssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX, \"\") + css.url;\n      }\n    } else {\n      cssHref = Meteor.absoluteUrl(css.url);\n    }\n    return allCssLink += \"@import url(\" + cssHref + \");\";\n  });\n  res.statusCode = 200;\n  return res.end(allCssLink);\n});\n","JsonRoutes.add \"get\", \"/api/workflow/space/:space/view/draft/:flow\", (req, res, next) ->\r\n\tif !Steedos.APIAuthenticationCheck(req, res)\r\n\t\treturn\r\n\r\n\tuser_id = req.userId\r\n\r\n\tuser = db.users.findOne({ _id: user_id })\r\n\r\n\tspaceId = req.params.space\r\n\r\n\tflowId = req.params.flow\r\n\r\n\tspace = db.spaces.findOne({ _id: spaceId })\r\n\r\n\tflow = db.flows.findOne({ _id: flowId }, { fields: { name: 1, 'current._id': 1, form: 1 } })\r\n\r\n\tform = db.forms.findOne({ _id: flow.form }, { fields: { 'current._id': 1 } })\r\n\r\n\toptions = {\r\n\t\tshowTrace: false,\r\n\t\tshowAttachments: false,\r\n\t\ttemplateName: \"default\",\r\n\t\teditable: true,\r\n\t\twidth: \"100%\",\r\n\t\tinstance_style: \"instance-default\",\r\n\t\tplugins: \"\"\"\r\n\r\n\t\t\t<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\r\n\t\t\t<meta name=\"format-detection\" content=\"telephone=no\">\r\n\t\t\t<meta http-equiv=\"x-rim-auto-match\" content=\"none\">\r\n\t\t\t<title>#{flow.name}</title>\r\n\t\t\t<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />\r\n\t\t\t<meta name=\"viewport\" content=\"width=device-width\" />\r\n\r\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css\">\r\n\r\n\t\t\t<script src=\"/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js\" type=\"text/javascript\"></script>\r\n\r\n\t\t\t<script src=\"/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js\" type=\"text/javascript\" charset=\"UTF-8\"></script>\r\n\r\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"/plugins/toastr/toastr.min.css\">\r\n\t\t\t<script src=\"/plugins/toastr/toastr.min.js\" type=\"text/javascript\"></script>\r\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"/js/workflow_client.css\">\r\n\t\t\t<script src=\"/js/workflow_client.js\" type=\"text/javascript\"></script>\r\n\t\t\"\"\"\r\n\t}\r\n\r\n\tinstance = {\r\n\t\tflow: flow._id,\r\n\t\tflow_version: flow.current._id,\r\n\t\tform: form._id,\r\n\t\tform_version: form.current._id,\r\n\t\tvalues: {},\r\n\t\tname: flow.name,\r\n\t\tspace: spaceId\r\n\t}\r\n\r\n\thtml = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options)\r\n\r\n\tdataBuf = new Buffer(html)\r\n\r\n\tres.setHeader('content-length', dataBuf.length)\r\n\r\n\tres.setHeader('content-range', \"bytes 0-#{dataBuf.length - 1}/#{dataBuf.length}\")\r\n\r\n\tres.statusCode = 200\r\n\r\n\tres.end(html)\r\n","JsonRoutes.add(\"get\", \"/api/workflow/space/:space/view/draft/:flow\", function(req, res, next) {\n  var dataBuf, flow, flowId, form, html, instance, options, space, spaceId, user, user_id;\n  if (!Steedos.APIAuthenticationCheck(req, res)) {\n    return;\n  }\n  user_id = req.userId;\n  user = db.users.findOne({\n    _id: user_id\n  });\n  spaceId = req.params.space;\n  flowId = req.params.flow;\n  space = db.spaces.findOne({\n    _id: spaceId\n  });\n  flow = db.flows.findOne({\n    _id: flowId\n  }, {\n    fields: {\n      name: 1,\n      'current._id': 1,\n      form: 1\n    }\n  });\n  form = db.forms.findOne({\n    _id: flow.form\n  }, {\n    fields: {\n      'current._id': 1\n    }\n  });\n  options = {\n    showTrace: false,\n    showAttachments: false,\n    templateName: \"default\",\n    editable: true,\n    width: \"100%\",\n    instance_style: \"instance-default\",\n    plugins: \"\\n<meta http-equiv=\\\"X-UA-Compatible\\\" content=\\\"IE=edge,chrome=1\\\" />\\n<meta name=\\\"format-detection\\\" content=\\\"telephone=no\\\">\\n<meta http-equiv=\\\"x-rim-auto-match\\\" content=\\\"none\\\">\\n<title>\" + flow.name + \"</title>\\n<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />\\n<meta name=\\\"viewport\\\" content=\\\"width=device-width\\\" />\\n\\n<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css\\\">\\n\\n<script src=\\\"/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js\\\" type=\\\"text/javascript\\\"></script>\\n\\n<script src=\\\"/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js\\\" type=\\\"text/javascript\\\" charset=\\\"UTF-8\\\"></script>\\n\\n<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/plugins/toastr/toastr.min.css\\\">\\n<script src=\\\"/plugins/toastr/toastr.min.js\\\" type=\\\"text/javascript\\\"></script>\\n<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/js/workflow_client.css\\\">\\n<script src=\\\"/js/workflow_client.js\\\" type=\\\"text/javascript\\\"></script>\"\n  };\n  instance = {\n    flow: flow._id,\n    flow_version: flow.current._id,\n    form: form._id,\n    form_version: form.current._id,\n    values: {},\n    name: flow.name,\n    space: spaceId\n  };\n  html = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options);\n  dataBuf = new Buffer(html);\n  res.setHeader('content-length', dataBuf.length);\n  res.setHeader('content-range', \"bytes 0-\" + (dataBuf.length - 1) + \"/\" + dataBuf.length);\n  res.statusCode = 200;\n  return res.end(html);\n});\n","Array.prototype.filterProperty = function(h, l){\r\n    var g = [];\r\n    this.forEach(function(t){\r\n        var m = t? t[h]:null;\r\n        var d = false;\r\n        if(m instanceof Array){\r\n            d = m.includes(l);\r\n        }else{\r\n            d = (l === undefined)? false:m==l;\r\n        }\r\n        if(d){\r\n            g.push(t);\r\n        }\r\n    });\r\n    return g;\r\n};\r\n\r\nArray.prototype.getProperty = function(k){\r\n    var v = new Array();\r\n    this.forEach(function(t){\r\n        var m = t? t[k]:null;\r\n        v.push(m);\r\n    });\r\n    return v;\r\n}\r\n\r\nArray.prototype.getEach = function(code){\r\n    var rev = [];\r\n    for(var i = 0 ; i < this.length ; i++){\r\n        rev.push(this[i][code]);\r\n    }\r\n    return rev;\r\n};\r\n\r\nArray.prototype.uniq = function(){\r\n    var a = [];\r\n    this.forEach(function(b){ \r\n        if(a.indexOf(b) < 0)\r\n            {a[a.length] = b}\r\n    });\r\n    return a;\r\n};\r\n\r\nForm_formula = {};\r\n\r\n\r\nForm_formula.mixin = function(dest, src){\r\n    for(var key in src){\r\n        dest[key] = src[key];\r\n    }\r\n    return dest;\r\n};\r\n\r\n\r\nForm_formula.handerUserObject = function(u){\r\n\r\n    if(u instanceof Array){\r\n        var user = {};\r\n\r\n        user.name = u.getProperty(\"name\")\r\n        user.organization = {};\r\n        user.organization.name = u.getProperty(\"organization\").getProperty(\"name\");\r\n        user.organization.fullname = u.getProperty(\"organization\").getProperty(\"fullname\");\r\n\r\n        user.hr = u.getProperty(\"hr\")\r\n\r\n        user.sort_no = u.getProperty(\"sort_no\")\r\n\r\n\t\tuser.mobile = u.getProperty(\"mobile\")\r\n\r\n\t\tuser.work_phone = u.getProperty(\"work_phone\")\r\n\r\n\t\tuser.position = u.getProperty(\"position\")\r\n\r\n        var userRoles = u.getProperty(\"roles\");\r\n        var roles = new Array();\r\n        userRoles.forEach(function(i){\r\n            roles = roles.concat(i);\r\n        }); \r\n        roles.uniq();\r\n        user.roles = roles;\r\n        return user;\r\n    }else{\r\n        return u;\r\n    }\r\n}\r\n\r\nForm_formula.handerOrgObject = function(o){\r\n\r\n    if(o instanceof Array){\r\n        var org = {};\r\n\t\torg.id = o.getProperty(\"_id\");\r\n        org.name = o.getProperty(\"name\");\r\n        org.fullname = o.getProperty(\"fullname\");\r\n\r\n        return org;\r\n    }else{\r\n        return o;\r\n    }\r\n}\r\n\r\n\r\n\r\n/**\r\n    * èŽ·å¾—å…¬å¼éœ€è¦ç”¨åˆ°çš„åˆå§‹å€¼\r\n    * è¾“å…¥ï¼šfields, values, applicant\r\n    * è¾“å‡ºï¼š__values\r\n**/\r\nForm_formula.init_formula_values = function(fields, autoFormDoc, approver, applicant, spaceId){\r\n    var __values = {};\r\n    //ç”³è¯·å•ä¸­å¡«çš„å€¼å¤„ç†\r\n    if(fields && fields.length && autoFormDoc) {\r\n        //debugger;\r\n        fields.forEach(function(field){\r\n            var type = field.type;\r\n            if(type) {\r\n                if(type === 'table') {\r\n                    /*\r\n                    * å°†è¡¨æ ¼å­—æ®µçš„å€¼è¿›è¡Œè½¬æ¢åŽä¼ å…¥__valuesä¸­\r\n                    * valuesä¸­è¡¨æ ¼çš„å€¼æ ¼å¼ä¸º\r\n                    * [{\"a\":1,\"b\":4},{\"a\":2,\"b\":5},{\"a\":3,\"b\":6}]\r\n                    * __valueséœ€è¦è½¬åŒ–ä¸ºä¸‹é¢æ ¼å¼ä¸”å’Œä¸»è¡¨çš„å€¼ä¸€æ ·æ”¾åˆ°ç¬¬ä¸€å±‚\r\n                    * {\"a\":[1,2,3],\"b\":[4,5,6]}\r\n                    **/\r\n                    var tableFields = field.sfields,\r\n                        tableValues = autoFormDoc[field.code],\r\n                        formulaTableValues = [],\r\n                        __tableValues = {};\r\n                    //æŒ‰å…¬å¼çš„æ ¼å¼è½¬æ¢å€¼ä¸º__tableValues\r\n                    if(tableFields && tableFields.length && tableValues && tableValues instanceof Array) {\r\n                        tableValues.forEach(function(tableValue){\r\n                            formulaTableValues.push(Form_formula.init_formula_values(tableFields, tableValue));\r\n                        }, this);\r\n                        //æŒ‰ä¸»è¡¨çš„æ ¼å¼è½¬æ¢__tableValuesåŠ åˆ°\r\n                        tableFields.forEach(function(tablefield){\r\n                            __tableValues[tablefield.code] = formulaTableValues.getEach(tablefield.code);\r\n                        });\r\n                        __values = Form_formula.mixin(__values, __tableValues);\r\n                    }\r\n                } else if (type == 'user'){\r\n                    __values[field.code] = Form_formula.handerUserObject(WorkflowManager.getFormulaUserObjects(spaceId, autoFormDoc[field.code]));\r\n\r\n                } else if (type == 'group'){\r\n                    __values[field.code] = Form_formula.handerOrgObject(WorkflowManager.getFormulaOrgObjects(autoFormDoc[field.code]));\r\n\r\n                } else if (type == 'odata'){\r\n\t\t\t\t\t__values[field.code] = autoFormDoc[field.code] || {}\r\n\r\n\t\t\t\t} else {\r\n                    //æ­¤å¤„ä¼ spaceIdç»™é€‰äººæŽ§ä»¶çš„æ—§æ•°æ®è®¡ç®—roleså’Œorganization\r\n                    __values[field.code] = autoFormDoc[field.code];\r\n                }\r\n            }\r\n        }, this);\r\n    }\r\n    //å½“å‰å¤„ç†äºº\r\n    __values[\"approver\"] = WorkflowManager.getFormulaUserObject(spaceId, approver);\r\n    //ç”³è¯·äºº\r\n    __values[\"applicant\"] = WorkflowManager.getFormulaUserObject(spaceId, applicant);\r\n\r\n    return __values;\r\n};\r\n\r\n","getHandlersManager = {}\r\n\r\ngetHandlersManager.getHandlersByUsersAndRoles = (user_ids, role_ids, space_id)->\r\n\tapprove_users = new Array\r\n\t_.each(user_ids, (user_id)->\r\n\t\tif db.users.find({_id: user_id}).count() > 0\r\n\t\t\tusers = getHandlersManager.getHandlersByUserAndRoles(user_id, role_ids, space_id)\r\n\t\t\tif users.length > 0\r\n\t\t\t\tapprove_users = approve_users.concat(users)\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"user_idä¸åˆæ³•ä¸åˆæ³•\")\r\n\t)\r\n\tapprove_users = _.uniq(approve_users)\r\n\treturn approve_users\r\n\r\ngetHandlersManager.getHandlersByUserAndRoles = (user_id, role_ids, space_id)->\r\n\tuser_ids = new Array\r\n\t_.each(role_ids, (role_id)->\r\n\t\tif db.flow_roles.find({_id: role_id}).count() > 0\r\n\t\t\tusers = getHandlersManager.getHandlersByUserAndRole(user_id, role_id, space_id)\r\n\t\t\tif users.length > 0\r\n\t\t\t\tuser_ids = user_ids.concat(users)\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"role_idå·²ç»è¢«åˆ é™¤\")\r\n\t)\r\n\tif user_ids.length > 0\r\n\t\tuser_ids = _.uniq(user_ids)\r\n\t\treturn user_ids\r\n\telse\r\n\t\tthrow new Meteor.Error('error!', \"æ ¹æ®user_idå’Œrole_idsæ²¡æŸ¥åˆ°å¯¹åº”çš„å¤„ç†äºº\")\r\n\r\ngetHandlersManager.getHandlersByUserAndRole = (user_id, role_id, space_id) ->\r\n\torgs = db.organizations.find({ space: space_id, users: user_id }, { fields: { _id: 1 } }).fetch()\r\n\tuser_ids = new Array\r\n\t_.each(orgs, (org) ->\r\n\t\tusers = getHandlersManager.getHandlersByOrgAndRole(org._id, role_id, space_id)\r\n\t\tif users.length > 0\r\n\t\t\tuser_ids = user_ids.concat(users)\r\n\t)\r\n\tuser_ids = _.uniq(user_ids)\r\n\treturn user_ids\r\n\r\ngetHandlersManager.getHandlersByOrgsAndRoles = (org_ids, role_ids, space_id)->\r\n\tuser_ids = new Array\r\n\t_.each(org_ids, (org_id)->\r\n\t\tusers = getHandlersManager.getHandlersByOrgAndRoles(org_id, role_ids, space_id)\r\n\t\tif users.length > 0\r\n\t\t\tuser_ids = user_ids.concat(users)\r\n\t)\r\n\tuser_ids = _.uniq(user_ids)\r\n\treturn user_ids\r\n\r\ngetHandlersManager.getHandlersByOrgAndRoles = (org_id, role_ids, space_id)->\r\n\tuser_ids = new Array\r\n\t_.each(role_ids, (role_id)->\r\n\t\tusers = getHandlersManager.getHandlersByOrgAndRole(org_id, role_id, space_id)\r\n\t\tif users.length > 0\r\n\t\t\tuser_ids = user_ids.concat(users)\r\n\t)\r\n\tif user_ids.length > 0\r\n\t\tuser_ids = _.uniq(user_ids)\r\n\t\treturn user_ids\r\n\telse\r\n\t\tthrow new Meteor.Error('error!', \"æ ¹æ®org_idå’Œrole_idsæ²¡æŸ¥åˆ°å¯¹åº”çš„å¤„ç†äºº\")\r\n\r\ngetHandlersManager.getHandlersByOrgAndRole = (org_id, role_id, space_id) ->\r\n\torg = db.organizations.findOne({ _id: org_id }, { fields: { parents: 1 } })\r\n\tuser_ids = new Array\r\n\tpositions = db.flow_positions.find({ space: space_id, org: org_id, role: role_id }, { fields: { users: 1 } }).fetch()\r\n\t_.each(positions, (position) ->\r\n\t\tuser_ids = user_ids.concat(position.users)\r\n\t)\r\n\tif user_ids.length is 0\r\n\t\tparents = org.parents\r\n\t\t_.each(parents, (parent_id) ->\r\n\t\t\tpositions = db.flow_positions.find({ space: space_id, org: parent_id, role: role_id }, { fields: { users: 1 } }).fetch()\r\n\t\t\tif positions.length > 0\r\n\t\t\t\t_.each(positions, (position) ->\r\n\t\t\t\t\tuser_ids = user_ids.concat(position.users)\r\n\t\t\t\t)\r\n\t\t)\r\n\r\n\tuser_ids = _.uniq(user_ids)\r\n\treturn user_ids\r\n\r\ngetHandlersManager.getHandlers = (instance_id, step_id) ->\r\n\tinstance = db.instances.findOne(instance_id)\r\n\r\n\t# æ‹Ÿç¨¿æ—¶, å¯ä»¥è®¾å®šåŽç»­æ¯ä¸ªæ­¥éª¤çš„å¤„ç†äºº #1926\r\n\tif instance.step_approve && !_.isEmpty(instance.step_approve[\"#{step_id}_options\"])\r\n\t\treturn instance.step_approve[\"#{step_id}_options\"]\r\n\r\n\tapprove_users = new Array\r\n\tspace_id = instance.space\r\n\tflow_id = instance.flow\r\n\tflow_rev = instance.flow_version\r\n\tcurrent_flow = db.flows.findOne(flow_id)\r\n\tcurrent_step = null\r\n\tcurrent_steps = new Array\r\n\r\n\tif current_flow.current._id is flow_rev\r\n\t\tcurrent_steps = current_flow.current.steps\r\n\telse\r\n\t\tcurrent = _.find(current_flow.historys, (history) ->\r\n\t\t\treturn history._id is flow_rev\r\n\t\t)\r\n\t\tcurrent_steps = current.steps\r\n\r\n\t# ä»ŽèŽ·å–çš„stepsä¸­æ ¹æ®:step_idæå–å¯¹åº”çš„stepå¯¹è±¡\r\n\tcurrent_step = _.find(current_steps, (step) ->\r\n\t\treturn step._id is step_id\r\n\t)\r\n\t# åˆ¤æ–­step_type\r\n\tif current_step.step_type is \"condition\"\r\n\t\tunfinished_trace = _.find(instance.traces, (trace) ->\r\n\t\t\treturn trace.is_finished is false\r\n\t\t)\r\n\r\n\t\treturn new Array(unfinished_trace.approves[0].user)\r\n\r\n\tif current_step.step_type is \"start\"\r\n\t\thandlers = new Array\r\n\t\thandlers.push(instance.applicant)\r\n\t\thandlers.push(instance.submitter)\r\n\t\thandlers = _.uniq(handlers)\r\n\t\treturn handlers\r\n\t# å¾—åˆ°stepçš„\"deal_type\"ï¼Œå¹¶è¿›è¡Œé€»è¾‘åˆ¤æ–­æ‰¾åˆ°å¯¹åº”çš„å¤„ç†äºº\r\n\tdeal_type = current_step.deal_type\r\n\tusers = new Array\r\n\tif deal_type is \"applicantRole\"\r\n\t\t# 1.***********ç”³è¯·äººæ‰€å±žç»„ç»‡ä¸­çš„å®¡æ‰¹å²—ä½***********\r\n\t\tapplicant = instance.applicant\r\n\t\tif applicant\r\n\t\t\tspace_user_count = db.space_users.find({ space: space_id, user: applicant }).count()\r\n\t\t\tif space_user_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰space\")\r\n\r\n\t\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\r\n\t\t\t\t_.each(current_step.approver_roles, (approver_role) ->\r\n\t\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\r\n\t\t\t\t\tif role_count is 0\r\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"è§’è‰²å·²ç»è¢«åˆ é™¤\")\r\n\t\t\t\t)\r\n\r\n\t\t\t\treturn getHandlersManager.getHandlersByUserAndRoles(applicant, current_step.approver_roles, space_id)\r\n\t\t\telse\r\n\t\t\t\tthrow new Meteor.Error('error!', \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\")\r\n\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"Instanceçš„æäº¤äººä¸ºç©º\")\r\n\telse if deal_type is \"hrRole\"\r\n\t\tapproveHrRoleIds = current_step.approver_hr_roles;\r\n\t\tif (approveHrRoleIds)\r\n\t\t\treturn _.pluck(WorkflowManager.getHrRolesUsers(space_id, approveHrRoleIds), 'user');\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"è§’è‰²æœªæŒ‡å®š\")\r\n\telse if deal_type is \"applicant\"\r\n\t\t# 2.***********ç”³è¯·äºº***********\r\n\t\tapplicant = instance.applicant\r\n\t\tspace_user_count = db.space_users.find({ space: space_id, user: applicant }).count()\r\n\t\tif space_user_count is 0\r\n\t\t\tthrow new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰space\")\r\n\t\telse\r\n\t\t\treturn new Array(applicant)\r\n\telse if deal_type is \"orgFieldRole\"\r\n\t\t# 3.***********éƒ¨é—¨å­—æ®µæ‰€å±žç»„ç»‡ä¸­çš„å®¡æ‰¹å²—ä½***********\r\n\t\tform_id = current_flow.form\r\n\t\tform_rev = null\r\n\t\tif flow_rev is current_flow.current._id\r\n\t\t\tform_rev = current_flow.current.form_version\r\n\t\telse\r\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\r\n\t\t\t\treturn current_flow_history._id is flow_rev\r\n\t\t\t)\r\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\r\n\r\n\t\tform = db.forms.findOne(form_id)\r\n\t\tcurrent_form = null\r\n\t\tif form_rev is form.current._id\r\n\t\t\tcurrent_form = form.current\r\n\t\telse\r\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\r\n\t\t\t\treturn form_history._id is form_rev\r\n\t\t\t)\r\n\r\n\t\tapprover_org_field = current_step.approver_org_field\r\n\t\tform_fields = current_form.fields\r\n\t\tfield_code = null\r\n\t\t_.each(form_fields, (form_field) ->\r\n\t\t\tif form_field._id is approver_org_field\r\n\t\t\t\tfield_code = form_field.code\r\n\t\t)\r\n\r\n\t\t# å–å¾—æœ€æ–°çš„values\r\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\r\n\t\torg_ids = new Array\r\n\t\torg_ids_names = new Array\r\n\t\tif newest_values[field_code]\r\n\t\t\tif newest_values[field_code] instanceof Array\r\n\t\t\t\torg_ids_names = newest_values[field_code]\r\n\t\t\telse\r\n\t\t\t\torg_ids_names.push(newest_values[field_code])\r\n\r\n\t\t# æ ¡éªŒorg_idæ•°ç»„ä¸­org_idæ˜¯å¦åˆæ³•\r\n\t\t_.each(org_ids_names, (org) ->\r\n\t\t\tcheck_org_count = db.organizations.find({ _id: org[\"id\"] }).count()\r\n\t\t\tif check_org_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"ç»„ç»‡IDä¸åˆæ³•\")\r\n\t\t\torg_ids.push(org[\"id\"])\r\n\t\t)\r\n\r\n\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\r\n\t\t\t# æ£€æŸ¥approver_rolesä¸­roleæ˜¯å¦ä¸å­˜åœ¨æˆ–å·²ç»è¢«åˆ é™¤\r\n\t\t\t_.each(current_step.approver_roles, (approver_role) ->\r\n\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\r\n\t\t\t\tif role_count is 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', approver_role + \"å·²ç»è¢«åˆ é™¤\")\r\n\t\t\t)\r\n\t\t\treturn getHandlersManager.getHandlersByOrgsAndRoles(org_ids, current_step.approver_roles, instance.space)\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"æµç¨‹æ­¥éª¤\" + current_step.name + \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\")\r\n\telse if deal_type is \"orgField\"\r\n\t\t# 4.***********éƒ¨é—¨å­—æ®µæ‰€å±žç»„ç»‡ä¸­çš„äººå‘˜***********\r\n\t\tform_id = current_flow.form\r\n\t\tform_rev = null\r\n\t\tif flow_rev is current_flow.current._id\r\n\t\t\tform_rev = current_flow.current.form_version\r\n\t\telse\r\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\r\n\t\t\t\treturn current_flow_history._id is flow_rev\r\n\t\t\t)\r\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\r\n\r\n\t\tform = db.forms.findOne(form_id)\r\n\t\tcurrent_form = null\r\n\t\tif form_rev is form.current._id\r\n\t\t\tcurrent_form = form.current\r\n\t\telse\r\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\r\n\t\t\t\treturn form_history._id is form_rev\r\n\t\t\t)\r\n\r\n\t\tapprover_org_field = current_step.approver_org_field\r\n\t\tform_fields = current_form.fields\r\n\t\tfield_code = null\r\n\t\t_.each(form_fields, (form_field)->\r\n\t\t\tif form_field._id is approver_org_field\r\n\t\t\t\tfield_code = form_field.code\r\n\t\t)\r\n\r\n\t\t# å–å¾—æœ€æ–°çš„values\r\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\r\n\r\n\t\torg_ids = new Array\r\n\t\torg_ids_names = new Array\r\n\t\tif newest_values[field_code]\r\n\t\t\tif newest_values[field_code] instanceof Array\r\n\t\t\t\torg_ids_names = newest_values[field_code]\r\n\t\t\telse\r\n\t\t\t\torg_ids_names.push(newest_values[field_code])\r\n\r\n\t\t# æ ¡éªŒorg_idæ•°ç»„ä¸­org_idæ˜¯å¦åˆæ³•\r\n\t\t_.each(org_ids_names, (org) ->\r\n\t\t\tcheck_org_count = db.organizations.find({ _id: org[\"id\"] }).count()\r\n\t\t\tif check_org_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"ç»„ç»‡IDä¸åˆæ³•\")\r\n\t\t\torg_ids.push(org[\"id\"])\r\n\t\t)\r\n\r\n\t\t# æ ¡éªŒorgä¸‹å­˜åœ¨å¤„ç†äºº\r\n\t\tuser_ids = new Array\r\n\t\t_.each(org_ids, (org_id) ->\r\n\t\t\torg = db.organizations.findOne({ _id: org_id }, { fields: { users: 1 } })\r\n\t\t\torg_children = db.organizations.find({ space: space_id, parents: org_id }, { fields: { users: 1 } }).fetch()\r\n\t\t\torg_children.unshift(org)\r\n\t\t\tcheck_orgs = org_children\r\n\t\t\torg_users = new Array\r\n\t\t\t_.each(check_orgs, (check_org_user) ->\r\n\t\t\t\tif check_org_user.users\r\n\t\t\t\t\t_.each(check_org_user.users, (org_user) ->\r\n\t\t\t\t\t\tif db.space_users.find({ space: space_id, user: org_user }).count() is 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"spaceä¸‹ä¸å­˜åœ¨æ­¤user\")\r\n\t\t\t\t\t)\r\n\t\t\t\tuser_ids = user_ids.concat(check_org_user.users)\r\n\t\t\t\torg_users = org_users.concat(check_org_user.users)\r\n\t\t\t)\r\n\r\n\t\t\tif org_users.length is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"ç»„ç»‡\" + org_id + \"ä¸å­˜åœ¨å¤„ç†äºº\")\r\n\r\n\t\t)\r\n\r\n\t\tuser_ids = _.uniq(user_ids)\r\n\t\treturn user_ids\r\n\telse if deal_type is \"userFieldRole\"\r\n\t\t# 5.***********äººå‘˜å­—æ®µæ‰€å±žç»„ç»‡ä¸­çš„å®¡æ‰¹å²—ä½***********\r\n\t\tform_id = current_flow.form\r\n\t\tform_rev = null\r\n\t\tif flow_rev is current_flow.current._id\r\n\t\t\tform_rev = current_flow.current.form_version\r\n\t\telse\r\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\r\n\t\t\t\treturn current_flow_history._id is flow_rev\r\n\t\t\t)\r\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\r\n\r\n\t\tform = db.forms.findOne(form_id)\r\n\t\tcurrent_form = null\r\n\t\tif form_rev is form.current._id\r\n\t\t\tcurrent_form = form.current\r\n\t\telse\r\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\r\n\t\t\t\treturn form_history._id is form_rev\r\n\t\t\t)\r\n\r\n\t\tapprover_user_field = current_step.approver_user_field\r\n\t\tform_fields = current_form.fields\r\n\t\tfield_code = null\r\n\t\t_.each(form_fields, (form_field) ->\r\n\t\t\tif form_field._id is approver_user_field\r\n\t\t\t\tfield_code = form_field.code\r\n\t\t)\r\n\r\n\t\t# å–å¾—æœ€æ–°çš„values\r\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\r\n\t\t# èŽ·å–user_idæ•°ç»„\r\n\t\tuser_ids_names = new Array\r\n\t\tif newest_values[field_code]\r\n\t\t\tif newest_values[field_code] instanceof Array\r\n\t\t\t\tuser_ids_names = newest_values[field_code]\r\n\t\t\telse\r\n\t\t\t\tuser_ids_names.push(newest_values[field_code])\r\n\r\n\t\t# æ ¡éªŒuser_idæ•°ç»„ä¸­user_idæ˜¯å¦åˆæ³•\r\n\t\tuser_ids = new Array\r\n\t\t_.each(user_ids_names, (user) ->\r\n\t\t\tcheck_user_count = db.space_users.find({ space: space_id, user: user[\"id\"] }).count()\r\n\t\t\tif check_user_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"äººå‘˜IDä¸åˆæ³•\")\r\n\t\t\tuser_ids.push(user[\"id\"])\r\n\t\t)\r\n\r\n\t\tuser_ids = _.uniq(user_ids)\r\n\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\r\n\t\t\t# æ£€æŸ¥approver_rolesä¸­roleæ˜¯å¦ä¸å­˜åœ¨æˆ–å·²ç»è¢«åˆ é™¤\r\n\t\t\t_.each(current_step.approver_roles, (approver_role) ->\r\n\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\r\n\t\t\t\tif role_count is 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', approver_role + \"å·²ç»è¢«åˆ é™¤\")\r\n\t\t\t)\r\n\t\t\treturn getHandlersManager.getHandlersByUsersAndRoles(user_ids, current_step.approver_roles, instance.space)\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"æµç¨‹æ­¥éª¤\" + current_step.name + \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\")\r\n\telse if deal_type is \"userField\"\r\n\t\t# 6.***********è¡¨å•äººå‘˜å­—æ®µ***********\r\n\t\tform_id = current_flow.form\r\n\t\tform_rev = null\r\n\t\tif flow_rev is current_flow.current._id\r\n\t\t\tform_rev = current_flow.current.form_version\r\n\t\telse\r\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\r\n\t\t\t\treturn current_flow_history._id is flow_rev\r\n\t\t\t)\r\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\r\n\r\n\t\tform = db.forms.findOne(form_id)\r\n\t\tcurrent_form = null\r\n\t\tif form_rev is form.current._id\r\n\t\t\tcurrent_form = form.current\r\n\t\telse\r\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\r\n\t\t\t\treturn form_history._id is form_rev\r\n\t\t\t)\r\n\r\n\t\tapprover_user_field = current_step.approver_user_field\r\n\t\tform_fields = current_form.fields\r\n\t\tfield_code = null\r\n\t\t_.each(form_fields, (form_field)->\r\n\t\t\tif form_field._id is approver_user_field\r\n\t\t\t\tfield_code = form_field.code\r\n\t\t)\r\n\r\n\t\t# å–å¾—æœ€æ–°çš„values\r\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\r\n\r\n\t\t# èŽ·å–user_idæ•°ç»„\r\n\t\tuser_ids_names = new Array\r\n\t\tif newest_values[field_code]\r\n\t\t\tif newest_values[field_code] instanceof Array\r\n\t\t\t\tuser_ids_names = newest_values[field_code]\r\n\t\t\telse\r\n\t\t\t\tuser_ids_names.push(newest_values[field_code])\r\n\r\n\t\t# æ ¡éªŒuser_idæ•°ç»„ä¸­user_idæ˜¯å¦åˆæ³•\r\n\t\tuser_ids = new Array\r\n\t\t_.each(user_ids_names, (user) ->\r\n\t\t\tcheck_user_count = db.space_users.find({ space: space_id, user: user[\"id\"] }).count()\r\n\t\t\tif check_user_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"äººå‘˜IDä¸åˆæ³•\")\r\n\t\t\tuser_ids.push(user[\"id\"])\r\n\t\t)\r\n\r\n\t\tuser_ids = _.uniq(user_ids)\r\n\t\treturn user_ids\r\n\telse if deal_type is \"specifyStepRole\"\r\n\t\t# 7.***********æŒ‡å®šæ­¥éª¤å¤„ç†å®¡æ‰¹å²—ä½***********\r\n\t\tapprover_step = current_step.approver_step\r\n\t\tfinished_traces = new Array\r\n\t\t_.each(instance.traces, (trace) ->\r\n\t\t\tif trace.step is approver_step\r\n\t\t\t\tfinished_traces.push(trace)\r\n\t\t)\r\n\t\t# æ ¹æ®start_dateå–æœ€æ–°çš„trace\r\n\t\tmax_startDate_trace = _.max(finished_traces, (t) ->\r\n\t\t\treturn t.start_date\r\n\t\t)\r\n\r\n\t\tapprove_users = _.pluck(max_startDate_trace.approves, \"user\")\r\n\r\n\t\tif current_step.approver_roles\r\n\t\t\t_.each(current_step.approver_roles, (approver_role) ->\r\n\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\r\n\t\t\t\tif role_count is 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"è§’è‰²å·²ç»è¢«åˆ é™¤\")\r\n\t\t\t)\r\n\r\n\t\t# éªŒè¯æŸ¥åˆ°çš„useræ˜¯å¦éƒ½åˆæ³•\r\n\t\t_.each(approve_users, (approve_user) ->\r\n\t\t\tif db.space_users.find({ space: space_id, user: approve_user }).count() is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"æŒ‡å®šæ­¥éª¤çš„å¤„ç†äººå·²ç»å˜æ›´\")\r\n\t\t)\r\n\r\n\t\treturn getHandlersManager.getHandlersByUsersAndRoles(approve_users, current_step.approver_roles, space_id)\r\n\telse if deal_type is \"specifyStepUser\"\r\n\t\t# 8.***********æŒ‡å®šæ­¥éª¤å¤„ç†äºº***********\r\n\t\tapprover_step = current_step.approver_step\r\n\t\tfinished_traces = new Array\r\n\t\t_.each(instance.traces, (trace) ->\r\n\t\t\tif trace.step is approver_step\r\n\t\t\t\tfinished_traces.push(trace)\r\n\t\t)\r\n\t\t# æ ¹æ®start_dateå–æœ€æ–°çš„trace\r\n\t\tmax_startDate_trace = _.max(finished_traces, (t) ->\r\n\t\t\treturn t.start_date\r\n\t\t)\r\n\r\n\t\tapprove_users = _.pluck(max_startDate_trace.approves, \"user\")\r\n\r\n\t\t# éªŒè¯æŸ¥åˆ°çš„useræ˜¯å¦éƒ½åˆæ³•\r\n\t\t_.each(approve_users, (approve_user)->\r\n\t\t\tcheck_approve_user_count = db.space_users.find({ space: space_id, user: approve_user }).count()\r\n\t\t\tif check_approve_user_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"æŒ‡å®šæ­¥éª¤çš„å¤„ç†äººå·²ç»å˜æ›´\")\r\n\t\t)\r\n\r\n\t\tapprove_users = _.uniq(approve_users)\r\n\t\treturn approve_users\r\n\telse if deal_type is \"submitterRole\"\r\n\t\t# 9.***********å¡«å•äººæ‰€å±žç»„ç»‡ä¸­çš„å®¡æ‰¹å²—ä½***********\r\n\t\tsubmitter = instance.submitter\r\n\t\tif not submitter\r\n\t\t\t# åˆ¤æ–­æäº¤äººæ˜¯å¦å·²ç»è¢«åˆ é™¤\r\n\t\t\tsubmitter_user_count = db.space_users.find({ space: space_id, user: submitter }).count()\r\n\t\t\tif submitter_user_count is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰å·¥ä½œåŒº\")\r\n\t\t\telse\r\n\t\t\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\r\n\t\t\t\t\t# æ£€æŸ¥approver_rolesä¸­roleæ˜¯å¦ä¸å­˜åœ¨æˆ–å·²ç»è¢«åˆ é™¤\r\n\t\t\t\t\t_.each(current_step.approver_roles, (approver_role) ->\r\n\t\t\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\r\n\t\t\t\t\t\tif role_count is 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', approver_role + \"å·²ç»è¢«åˆ é™¤\")\r\n\t\t\t\t\t)\r\n\t\t\t\t\treturn getHandlersManager.getHandlersByUserAndRoles(submitter, current_step.approver_roles, space_id)\r\n\t\t\t\telse\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"æµç¨‹æ­¥éª¤\" + current_step.name + \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\")\r\n\t\telse\r\n\t\t\tthrow new Meteor.Error('error!', \"ç”³è¯·å•çš„æäº¤äººä¸ºç©º\")\r\n\telse if deal_type is \"submitter\"\r\n\t\t# 10.***********æäº¤äºº***********\r\n\t\tsubmitter = instance.submitter\r\n\t\t# åˆ¤æ–­æäº¤äººæ˜¯å¦å·²ç»è¢«åˆ é™¤\r\n\t\tsubmitter_user_count = db.space_users.find({ space: space_id, user: submitter }).count()\r\n\t\tif submitter_user_count is 0\r\n\t\t\tthrow new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰å·¥ä½œåŒº\")\r\n\t\telse\r\n\t\t\treturn new Array(submitter)\r\n\telse if deal_type is \"specifyOrg\"\r\n\t\t# 11.***********æŸéƒ¨é—¨å†…çš„æ‰€æœ‰äºº***********\r\n\t\tapprover_org_ids = current_step.approver_orgs\r\n\t\tif not approver_org_ids or approver_org_ids.length is 0\r\n\t\t\tthrow new Meteor.Error('error!', \"æœªå®šä¹‰ç”¨äºŽæŸ¥æ‰¾ä¸‹ä¸€æ­¥å¤„ç†äººçš„éƒ¨é—¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è°ƒæŸ¥æµç¨‹å›¾çš„é…ç½®æ˜¯å¦æ­£ç¡®\")\r\n\r\n\t\t# éªŒè¯æ‰€æŒ‡å®šçš„organization_idéƒ½å­˜åœ¨\r\n\t\tvalid_approver_org_ids = new Array\r\n\t\t_.each(approver_org_ids, (approver_org_id) ->\r\n\t\t\tif db.organizations.find({ _id: approver_org_id }).count() > 0\r\n\t\t\t\tvalid_approver_org_ids.unshift(approver_org_id)\r\n\t\t)\r\n\r\n\t\torg_user_ids = new Array\r\n\t\t_.each(valid_approver_org_ids, (valid_approver_org_id) ->\r\n\t\t\tvalid_approver_org = db.organizations.findOne({ _id: valid_approver_org_id }, { fields: { users: 1 } })\r\n\t\t\tif valid_approver_org.users\r\n\t\t\t\torg_user_ids = org_user_ids.concat(valid_approver_org.users)\r\n\r\n\t\t\tchild_orgs = db.organizations.find({ space: space_id, parents: valid_approver_org_id }, { fields: { users: 1 } }).fetch()\r\n\t\t\t_.each(child_orgs, (child_org) ->\r\n\t\t\t\tif child_org.users\r\n\t\t\t\t\torg_user_ids = org_user_ids.concat(child_org.users)\r\n\t\t\t)\r\n\t\t)\r\n\r\n\t\torg_user_ids = _.uniq(org_user_ids)\r\n\t\tnew_org_user_ids = new Array\r\n\t\t_.each(org_user_ids, (org_user_id) ->\r\n\t\t\tspace_user_info_count = db.space_users.find({ space: space_id, user: org_user_id }).count()\r\n\t\t\tif space_user_info_count > 0\r\n\t\t\t\tnew_org_user_ids.push(org_user_id)\r\n\t\t)\r\n\r\n\t\treturn new_org_user_ids\r\n\telse if deal_type is \"specifyUser\"\r\n\t\t# 12.***********æŒ‡å®šçš„äººå‘˜***********\r\n\t\tapprover_user_ids = current_step.approver_users\r\n\t\tapprover_user_ids = _.uniq(approver_user_ids)\r\n\t\tnew_approver_user_ids = new Array\r\n\t\t_.each(approver_user_ids, (approver_user_id) ->\r\n\t\t\tspace_user_info_count = db.space_users.find({ space: space_id, user: approver_user_id }).count()\r\n\t\t\tif space_user_info_count > 0\r\n\t\t\t\tnew_approver_user_ids.push(approver_user_id)\r\n\t\t)\r\n\r\n\t\treturn new_approver_user_ids\r\n\telse if deal_type is \"pickupAtRuntime\"\r\n\t\t# 13.***********å®¡æ‰¹æ—¶æŒ‡å®š***********\r\n\t\tnext_step_users = new Array\r\n\t\t_trace = _.find(instance.traces, (_tr) ->\r\n\t\t\treturn _tr.is_finished is false\r\n\t\t)\r\n\t\t_approve = _.find(_trace.approves, (_app) ->\r\n\t\t\treturn _app.is_finished is false and _app.type isnt 'cc'\r\n\t\t)\r\n\r\n\t\tif _approve.next_steps\r\n\t\t\tif _approve.next_steps[0][\"users\"]\r\n\t\t\t\tnext_step_users = _approve.next_steps[0][\"users\"]\r\n\r\n\t\treturn next_step_users\r\n\telse if deal_type is \"applicantSuperior\"\r\n\t\t# 14.***********ç”³è¯·äººä¸Šçº§ä¸»ç®¡***********\r\n\t\tapplicantSuperiors = new Array\r\n\t\t_space_user = db.space_users.findOne({ space: space_id, user: instance.applicant }, { fields: { manager: 1 } })\r\n\t\tif _space_user.manager\r\n\t\t\tapplicantSuperiors.push(_space_user.manager)\r\n\r\n\t\treturn applicantSuperiors","                       \n\ngetHandlersManager = {};\n\ngetHandlersManager.getHandlersByUsersAndRoles = function(user_ids, role_ids, space_id) {\n  var approve_users;\n  approve_users = new Array;\n  _.each(user_ids, function(user_id) {\n    var users;\n    if (db.users.find({\n      _id: user_id\n    }).count() > 0) {\n      users = getHandlersManager.getHandlersByUserAndRoles(user_id, role_ids, space_id);\n      if (users.length > 0) {\n        return approve_users = approve_users.concat(users);\n      }\n    } else {\n      throw new Meteor.Error('error!', \"user_idä¸åˆæ³•ä¸åˆæ³•\");\n    }\n  });\n  approve_users = _.uniq(approve_users);\n  return approve_users;\n};\n\ngetHandlersManager.getHandlersByUserAndRoles = function(user_id, role_ids, space_id) {\n  var user_ids;\n  user_ids = new Array;\n  _.each(role_ids, function(role_id) {\n    var users;\n    if (db.flow_roles.find({\n      _id: role_id\n    }).count() > 0) {\n      users = getHandlersManager.getHandlersByUserAndRole(user_id, role_id, space_id);\n      if (users.length > 0) {\n        return user_ids = user_ids.concat(users);\n      }\n    } else {\n      throw new Meteor.Error('error!', \"role_idå·²ç»è¢«åˆ é™¤\");\n    }\n  });\n  if (user_ids.length > 0) {\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else {\n    throw new Meteor.Error('error!', \"æ ¹æ®user_idå’Œrole_idsæ²¡æŸ¥åˆ°å¯¹åº”çš„å¤„ç†äºº\");\n  }\n};\n\ngetHandlersManager.getHandlersByUserAndRole = function(user_id, role_id, space_id) {\n  var orgs, user_ids;\n  orgs = db.organizations.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      _id: 1\n    }\n  }).fetch();\n  user_ids = new Array;\n  _.each(orgs, function(org) {\n    var users;\n    users = getHandlersManager.getHandlersByOrgAndRole(org._id, role_id, space_id);\n    if (users.length > 0) {\n      return user_ids = user_ids.concat(users);\n    }\n  });\n  user_ids = _.uniq(user_ids);\n  return user_ids;\n};\n\ngetHandlersManager.getHandlersByOrgsAndRoles = function(org_ids, role_ids, space_id) {\n  var user_ids;\n  user_ids = new Array;\n  _.each(org_ids, function(org_id) {\n    var users;\n    users = getHandlersManager.getHandlersByOrgAndRoles(org_id, role_ids, space_id);\n    if (users.length > 0) {\n      return user_ids = user_ids.concat(users);\n    }\n  });\n  user_ids = _.uniq(user_ids);\n  return user_ids;\n};\n\ngetHandlersManager.getHandlersByOrgAndRoles = function(org_id, role_ids, space_id) {\n  var user_ids;\n  user_ids = new Array;\n  _.each(role_ids, function(role_id) {\n    var users;\n    users = getHandlersManager.getHandlersByOrgAndRole(org_id, role_id, space_id);\n    if (users.length > 0) {\n      return user_ids = user_ids.concat(users);\n    }\n  });\n  if (user_ids.length > 0) {\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else {\n    throw new Meteor.Error('error!', \"æ ¹æ®org_idå’Œrole_idsæ²¡æŸ¥åˆ°å¯¹åº”çš„å¤„ç†äºº\");\n  }\n};\n\ngetHandlersManager.getHandlersByOrgAndRole = function(org_id, role_id, space_id) {\n  var org, parents, positions, user_ids;\n  org = db.organizations.findOne({\n    _id: org_id\n  }, {\n    fields: {\n      parents: 1\n    }\n  });\n  user_ids = new Array;\n  positions = db.flow_positions.find({\n    space: space_id,\n    org: org_id,\n    role: role_id\n  }, {\n    fields: {\n      users: 1\n    }\n  }).fetch();\n  _.each(positions, function(position) {\n    return user_ids = user_ids.concat(position.users);\n  });\n  if (user_ids.length === 0) {\n    parents = org.parents;\n    _.each(parents, function(parent_id) {\n      positions = db.flow_positions.find({\n        space: space_id,\n        org: parent_id,\n        role: role_id\n      }, {\n        fields: {\n          users: 1\n        }\n      }).fetch();\n      if (positions.length > 0) {\n        return _.each(positions, function(position) {\n          return user_ids = user_ids.concat(position.users);\n        });\n      }\n    });\n  }\n  user_ids = _.uniq(user_ids);\n  return user_ids;\n};\n\ngetHandlersManager.getHandlers = function(instance_id, step_id) {\n  var _approve, _space_user, _trace, applicant, applicantSuperiors, approveHrRoleIds, approve_users, approver_org_field, approver_org_ids, approver_step, approver_user_field, approver_user_ids, current, current_flow, current_flow_version, current_form, current_step, current_steps, deal_type, field_code, finished_traces, flow_id, flow_rev, form, form_fields, form_id, form_rev, handlers, instance, max_startDate_trace, new_approver_user_ids, new_org_user_ids, newest_values, next_step_users, org_ids, org_ids_names, org_user_ids, space_id, space_user_count, submitter, submitter_user_count, unfinished_trace, user_ids, user_ids_names, users, valid_approver_org_ids;\n  instance = db.instances.findOne(instance_id);\n  if (instance.step_approve && !_.isEmpty(instance.step_approve[step_id + \"_options\"])) {\n    return instance.step_approve[step_id + \"_options\"];\n  }\n  approve_users = new Array;\n  space_id = instance.space;\n  flow_id = instance.flow;\n  flow_rev = instance.flow_version;\n  current_flow = db.flows.findOne(flow_id);\n  current_step = null;\n  current_steps = new Array;\n  if (current_flow.current._id === flow_rev) {\n    current_steps = current_flow.current.steps;\n  } else {\n    current = _.find(current_flow.historys, function(history) {\n      return history._id === flow_rev;\n    });\n    current_steps = current.steps;\n  }\n  current_step = _.find(current_steps, function(step) {\n    return step._id === step_id;\n  });\n  if (current_step.step_type === \"condition\") {\n    unfinished_trace = _.find(instance.traces, function(trace) {\n      return trace.is_finished === false;\n    });\n    return new Array(unfinished_trace.approves[0].user);\n  }\n  if (current_step.step_type === \"start\") {\n    handlers = new Array;\n    handlers.push(instance.applicant);\n    handlers.push(instance.submitter);\n    handlers = _.uniq(handlers);\n    return handlers;\n  }\n  deal_type = current_step.deal_type;\n  users = new Array;\n  if (deal_type === \"applicantRole\") {\n    applicant = instance.applicant;\n    if (applicant) {\n      space_user_count = db.space_users.find({\n        space: space_id,\n        user: applicant\n      }).count();\n      if (space_user_count === 0) {\n        throw new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰space\");\n      }\n      if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n        _.each(current_step.approver_roles, function(approver_role) {\n          var role_count;\n          role_count = db.flow_roles.find({\n            _id: approver_role\n          }).count();\n          if (role_count === 0) {\n            throw new Meteor.Error('error!', \"è§’è‰²å·²ç»è¢«åˆ é™¤\");\n          }\n        });\n        return getHandlersManager.getHandlersByUserAndRoles(applicant, current_step.approver_roles, space_id);\n      } else {\n        throw new Meteor.Error('error!', \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\");\n      }\n    } else {\n      throw new Meteor.Error('error!', \"Instanceçš„æäº¤äººä¸ºç©º\");\n    }\n  } else if (deal_type === \"hrRole\") {\n    approveHrRoleIds = current_step.approver_hr_roles;\n    if (approveHrRoleIds) {\n      return _.pluck(WorkflowManager.getHrRolesUsers(space_id, approveHrRoleIds), 'user');\n    } else {\n      throw new Meteor.Error('error!', \"è§’è‰²æœªæŒ‡å®š\");\n    }\n  } else if (deal_type === \"applicant\") {\n    applicant = instance.applicant;\n    space_user_count = db.space_users.find({\n      space: space_id,\n      user: applicant\n    }).count();\n    if (space_user_count === 0) {\n      throw new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰space\");\n    } else {\n      return new Array(applicant);\n    }\n  } else if (deal_type === \"orgFieldRole\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_org_field = current_step.approver_org_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_org_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    org_ids = new Array;\n    org_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        org_ids_names = newest_values[field_code];\n      } else {\n        org_ids_names.push(newest_values[field_code]);\n      }\n    }\n    _.each(org_ids_names, function(org) {\n      var check_org_count;\n      check_org_count = db.organizations.find({\n        _id: org[\"id\"]\n      }).count();\n      if (check_org_count === 0) {\n        throw new Meteor.Error('error!', \"ç»„ç»‡IDä¸åˆæ³•\");\n      }\n      return org_ids.push(org[\"id\"]);\n    });\n    if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n      _.each(current_step.approver_roles, function(approver_role) {\n        var role_count;\n        role_count = db.flow_roles.find({\n          _id: approver_role\n        }).count();\n        if (role_count === 0) {\n          throw new Meteor.Error('error!', approver_role + \"å·²ç»è¢«åˆ é™¤\");\n        }\n      });\n      return getHandlersManager.getHandlersByOrgsAndRoles(org_ids, current_step.approver_roles, instance.space);\n    } else {\n      throw new Meteor.Error('error!', \"æµç¨‹æ­¥éª¤\" + current_step.name + \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\");\n    }\n  } else if (deal_type === \"orgField\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_org_field = current_step.approver_org_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_org_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    org_ids = new Array;\n    org_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        org_ids_names = newest_values[field_code];\n      } else {\n        org_ids_names.push(newest_values[field_code]);\n      }\n    }\n    _.each(org_ids_names, function(org) {\n      var check_org_count;\n      check_org_count = db.organizations.find({\n        _id: org[\"id\"]\n      }).count();\n      if (check_org_count === 0) {\n        throw new Meteor.Error('error!', \"ç»„ç»‡IDä¸åˆæ³•\");\n      }\n      return org_ids.push(org[\"id\"]);\n    });\n    user_ids = new Array;\n    _.each(org_ids, function(org_id) {\n      var check_orgs, org, org_children, org_users;\n      org = db.organizations.findOne({\n        _id: org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      });\n      org_children = db.organizations.find({\n        space: space_id,\n        parents: org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      }).fetch();\n      org_children.unshift(org);\n      check_orgs = org_children;\n      org_users = new Array;\n      _.each(check_orgs, function(check_org_user) {\n        if (check_org_user.users) {\n          _.each(check_org_user.users, function(org_user) {\n            if (db.space_users.find({\n              space: space_id,\n              user: org_user\n            }).count() === 0) {\n              throw new Meteor.Error('error!', \"spaceä¸‹ä¸å­˜åœ¨æ­¤user\");\n            }\n          });\n        }\n        user_ids = user_ids.concat(check_org_user.users);\n        return org_users = org_users.concat(check_org_user.users);\n      });\n      if (org_users.length === 0) {\n        throw new Meteor.Error('error!', \"ç»„ç»‡\" + org_id + \"ä¸å­˜åœ¨å¤„ç†äºº\");\n      }\n    });\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else if (deal_type === \"userFieldRole\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_user_field = current_step.approver_user_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_user_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    user_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        user_ids_names = newest_values[field_code];\n      } else {\n        user_ids_names.push(newest_values[field_code]);\n      }\n    }\n    user_ids = new Array;\n    _.each(user_ids_names, function(user) {\n      var check_user_count;\n      check_user_count = db.space_users.find({\n        space: space_id,\n        user: user[\"id\"]\n      }).count();\n      if (check_user_count === 0) {\n        throw new Meteor.Error('error!', \"äººå‘˜IDä¸åˆæ³•\");\n      }\n      return user_ids.push(user[\"id\"]);\n    });\n    user_ids = _.uniq(user_ids);\n    if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n      _.each(current_step.approver_roles, function(approver_role) {\n        var role_count;\n        role_count = db.flow_roles.find({\n          _id: approver_role\n        }).count();\n        if (role_count === 0) {\n          throw new Meteor.Error('error!', approver_role + \"å·²ç»è¢«åˆ é™¤\");\n        }\n      });\n      return getHandlersManager.getHandlersByUsersAndRoles(user_ids, current_step.approver_roles, instance.space);\n    } else {\n      throw new Meteor.Error('error!', \"æµç¨‹æ­¥éª¤\" + current_step.name + \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\");\n    }\n  } else if (deal_type === \"userField\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_user_field = current_step.approver_user_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_user_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    user_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        user_ids_names = newest_values[field_code];\n      } else {\n        user_ids_names.push(newest_values[field_code]);\n      }\n    }\n    user_ids = new Array;\n    _.each(user_ids_names, function(user) {\n      var check_user_count;\n      check_user_count = db.space_users.find({\n        space: space_id,\n        user: user[\"id\"]\n      }).count();\n      if (check_user_count === 0) {\n        throw new Meteor.Error('error!', \"äººå‘˜IDä¸åˆæ³•\");\n      }\n      return user_ids.push(user[\"id\"]);\n    });\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else if (deal_type === \"specifyStepRole\") {\n    approver_step = current_step.approver_step;\n    finished_traces = new Array;\n    _.each(instance.traces, function(trace) {\n      if (trace.step === approver_step) {\n        return finished_traces.push(trace);\n      }\n    });\n    max_startDate_trace = _.max(finished_traces, function(t) {\n      return t.start_date;\n    });\n    approve_users = _.pluck(max_startDate_trace.approves, \"user\");\n    if (current_step.approver_roles) {\n      _.each(current_step.approver_roles, function(approver_role) {\n        var role_count;\n        role_count = db.flow_roles.find({\n          _id: approver_role\n        }).count();\n        if (role_count === 0) {\n          throw new Meteor.Error('error!', \"è§’è‰²å·²ç»è¢«åˆ é™¤\");\n        }\n      });\n    }\n    _.each(approve_users, function(approve_user) {\n      if (db.space_users.find({\n        space: space_id,\n        user: approve_user\n      }).count() === 0) {\n        throw new Meteor.Error('error!', \"æŒ‡å®šæ­¥éª¤çš„å¤„ç†äººå·²ç»å˜æ›´\");\n      }\n    });\n    return getHandlersManager.getHandlersByUsersAndRoles(approve_users, current_step.approver_roles, space_id);\n  } else if (deal_type === \"specifyStepUser\") {\n    approver_step = current_step.approver_step;\n    finished_traces = new Array;\n    _.each(instance.traces, function(trace) {\n      if (trace.step === approver_step) {\n        return finished_traces.push(trace);\n      }\n    });\n    max_startDate_trace = _.max(finished_traces, function(t) {\n      return t.start_date;\n    });\n    approve_users = _.pluck(max_startDate_trace.approves, \"user\");\n    _.each(approve_users, function(approve_user) {\n      var check_approve_user_count;\n      check_approve_user_count = db.space_users.find({\n        space: space_id,\n        user: approve_user\n      }).count();\n      if (check_approve_user_count === 0) {\n        throw new Meteor.Error('error!', \"æŒ‡å®šæ­¥éª¤çš„å¤„ç†äººå·²ç»å˜æ›´\");\n      }\n    });\n    approve_users = _.uniq(approve_users);\n    return approve_users;\n  } else if (deal_type === \"submitterRole\") {\n    submitter = instance.submitter;\n    if (!submitter) {\n      submitter_user_count = db.space_users.find({\n        space: space_id,\n        user: submitter\n      }).count();\n      if (submitter_user_count === 0) {\n        throw new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰å·¥ä½œåŒº\");\n      } else {\n        if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n          _.each(current_step.approver_roles, function(approver_role) {\n            var role_count;\n            role_count = db.flow_roles.find({\n              _id: approver_role\n            }).count();\n            if (role_count === 0) {\n              throw new Meteor.Error('error!', approver_role + \"å·²ç»è¢«åˆ é™¤\");\n            }\n          });\n          return getHandlersManager.getHandlersByUserAndRoles(submitter, current_step.approver_roles, space_id);\n        } else {\n          throw new Meteor.Error('error!', \"æµç¨‹æ­¥éª¤\" + current_step.name + \"å®¡æ‰¹å²—ä½æœªæŒ‡å®š\");\n        }\n      }\n    } else {\n      throw new Meteor.Error('error!', \"ç”³è¯·å•çš„æäº¤äººä¸ºç©º\");\n    }\n  } else if (deal_type === \"submitter\") {\n    submitter = instance.submitter;\n    submitter_user_count = db.space_users.find({\n      space: space_id,\n      user: submitter\n    }).count();\n    if (submitter_user_count === 0) {\n      throw new Meteor.Error('error!', \"æäº¤äººå·²ç»è¢«åˆ é™¤æˆ–ä¸å±žäºŽå½“å‰å·¥ä½œåŒº\");\n    } else {\n      return new Array(submitter);\n    }\n  } else if (deal_type === \"specifyOrg\") {\n    approver_org_ids = current_step.approver_orgs;\n    if (!approver_org_ids || approver_org_ids.length === 0) {\n      throw new Meteor.Error('error!', \"æœªå®šä¹‰ç”¨äºŽæŸ¥æ‰¾ä¸‹ä¸€æ­¥å¤„ç†äººçš„éƒ¨é—¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è°ƒæŸ¥æµç¨‹å›¾çš„é…ç½®æ˜¯å¦æ­£ç¡®\");\n    }\n    valid_approver_org_ids = new Array;\n    _.each(approver_org_ids, function(approver_org_id) {\n      if (db.organizations.find({\n        _id: approver_org_id\n      }).count() > 0) {\n        return valid_approver_org_ids.unshift(approver_org_id);\n      }\n    });\n    org_user_ids = new Array;\n    _.each(valid_approver_org_ids, function(valid_approver_org_id) {\n      var child_orgs, valid_approver_org;\n      valid_approver_org = db.organizations.findOne({\n        _id: valid_approver_org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      });\n      if (valid_approver_org.users) {\n        org_user_ids = org_user_ids.concat(valid_approver_org.users);\n      }\n      child_orgs = db.organizations.find({\n        space: space_id,\n        parents: valid_approver_org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      }).fetch();\n      return _.each(child_orgs, function(child_org) {\n        if (child_org.users) {\n          return org_user_ids = org_user_ids.concat(child_org.users);\n        }\n      });\n    });\n    org_user_ids = _.uniq(org_user_ids);\n    new_org_user_ids = new Array;\n    _.each(org_user_ids, function(org_user_id) {\n      var space_user_info_count;\n      space_user_info_count = db.space_users.find({\n        space: space_id,\n        user: org_user_id\n      }).count();\n      if (space_user_info_count > 0) {\n        return new_org_user_ids.push(org_user_id);\n      }\n    });\n    return new_org_user_ids;\n  } else if (deal_type === \"specifyUser\") {\n    approver_user_ids = current_step.approver_users;\n    approver_user_ids = _.uniq(approver_user_ids);\n    new_approver_user_ids = new Array;\n    _.each(approver_user_ids, function(approver_user_id) {\n      var space_user_info_count;\n      space_user_info_count = db.space_users.find({\n        space: space_id,\n        user: approver_user_id\n      }).count();\n      if (space_user_info_count > 0) {\n        return new_approver_user_ids.push(approver_user_id);\n      }\n    });\n    return new_approver_user_ids;\n  } else if (deal_type === \"pickupAtRuntime\") {\n    next_step_users = new Array;\n    _trace = _.find(instance.traces, function(_tr) {\n      return _tr.is_finished === false;\n    });\n    _approve = _.find(_trace.approves, function(_app) {\n      return _app.is_finished === false && _app.type !== 'cc';\n    });\n    if (_approve.next_steps) {\n      if (_approve.next_steps[0][\"users\"]) {\n        next_step_users = _approve.next_steps[0][\"users\"];\n      }\n    }\n    return next_step_users;\n  } else if (deal_type === \"applicantSuperior\") {\n    applicantSuperiors = new Array;\n    _space_user = db.space_users.findOne({\n      space: space_id,\n      user: instance.applicant\n    }, {\n      fields: {\n        manager: 1\n      }\n    });\n    if (_space_user.manager) {\n      applicantSuperiors.push(_space_user.manager);\n    }\n    return applicantSuperiors;\n  }\n};\n","permissionManager = {}\r\n\r\npermissionManager.getFlowPermissions = (flow_id, user_id) ->\r\n\t# æ ¹æ®:flow_idæŸ¥åˆ°å¯¹åº”çš„flow\r\n\tflow = uuflowManager.getFlow(flow_id)\r\n\tspace_id = flow.space\r\n\t# æ ¹æ®space_idå’Œ:user_idåˆ°organizationsè¡¨ä¸­æŸ¥åˆ°ç”¨æˆ·æ‰€å±žæ‰€æœ‰çš„org_idï¼ˆåŒ…æ‹¬ä¸Šçº§ç»„IDï¼‰\r\n\torg_ids = new Array\r\n\torganizations = db.organizations.find({\r\n\t\tspace: space_id, users: user_id }, { fields: { parents: 1 } }).fetch()\r\n\t_.each(organizations, (org) ->\r\n\t\torg_ids.push(org._id)\r\n\t\tif org.parents\r\n\t\t\t_.each(org.parents, (parent_id) ->\r\n\t\t\t\torg_ids.push(parent_id)\r\n\t\t\t)\r\n\t)\r\n\torg_ids = _.uniq(org_ids)\r\n\tmy_permissions = new Array\r\n\tif flow.perms\r\n\t\t# åˆ¤æ–­flow.perms.users_can_adminä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·ï¼Œ\r\n\t\t# æˆ–è€…flow.perms.orgs_can_addæ˜¯å¦åŒ…å«4æ­¥å¾—åˆ°çš„org_idæ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œ\r\n\t\t# è‹¥æ˜¯ï¼Œåˆ™åœ¨è¿”å›žçš„æ•°ç»„ä¸­åŠ ä¸Šadd\r\n\t\tif flow.perms.users_can_add\r\n\t\t\tusers_can_add = flow.perms.users_can_add\r\n\t\t\tif users_can_add.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"add\")\r\n\r\n\t\tif flow.perms.orgs_can_add\r\n\t\t\torgs_can_add = flow.perms.orgs_can_add\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_add.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"add\")\r\n\t\t\t)\r\n\t\t# åˆ¤æ–­flow.perms.users_can_monitorä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·ï¼Œ\r\n\t\t# æˆ–è€…flow.perms.orgs_can_monitoræ˜¯å¦åŒ…å«4æ­¥å¾—åˆ°çš„org_idæ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œ\r\n\t\t# è‹¥æ˜¯ï¼Œåˆ™åœ¨è¿”å›žçš„æ•°ç»„ä¸­åŠ ä¸Šmonitor\r\n\t\tif flow.perms.users_can_monitor\r\n\t\t\tusers_can_monitor = flow.perms.users_can_monitor\r\n\t\t\tif users_can_monitor.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"monitor\")\r\n\r\n\t\tif flow.perms.orgs_can_monitor\r\n\t\t\torgs_can_monitor = flow.perms.orgs_can_monitor\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_monitor.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"monitor\")\r\n\t\t\t)\r\n\t\t# åˆ¤æ–­flow.perms.users_can_adminä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·ï¼Œ\r\n\t\t# æˆ–è€…flow.perms.orgs_can_adminæ˜¯å¦åŒ…å«4æ­¥å¾—åˆ°çš„org_idæ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œ\r\n\t\t# è‹¥æ˜¯ï¼Œåˆ™åœ¨è¿”å›žçš„æ•°ç»„ä¸­åŠ ä¸Šadmin\r\n\t\tif flow.perms.users_can_admin\r\n\t\t\tusers_can_admin = flow.perms.users_can_admin\r\n\t\t\tif users_can_admin.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"admin\")\r\n\r\n\t\tif flow.perms.orgs_can_admin\r\n\t\t\torgs_can_admin = flow.perms.orgs_can_admin\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_admin.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"admin\")\r\n\t\t\t)\r\n\r\n\tmy_permissions = _.uniq(my_permissions)\r\n\treturn my_permissions","                      \n\npermissionManager = {};\n\npermissionManager.getFlowPermissions = function(flow_id, user_id) {\n  var flow, my_permissions, org_ids, organizations, orgs_can_add, orgs_can_admin, orgs_can_monitor, space_id, users_can_add, users_can_admin, users_can_monitor;\n  flow = uuflowManager.getFlow(flow_id);\n  space_id = flow.space;\n  org_ids = new Array;\n  organizations = db.organizations.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      parents: 1\n    }\n  }).fetch();\n  _.each(organizations, function(org) {\n    org_ids.push(org._id);\n    if (org.parents) {\n      return _.each(org.parents, function(parent_id) {\n        return org_ids.push(parent_id);\n      });\n    }\n  });\n  org_ids = _.uniq(org_ids);\n  my_permissions = new Array;\n  if (flow.perms) {\n    if (flow.perms.users_can_add) {\n      users_can_add = flow.perms.users_can_add;\n      if (users_can_add.includes(user_id)) {\n        my_permissions.push(\"add\");\n      }\n    }\n    if (flow.perms.orgs_can_add) {\n      orgs_can_add = flow.perms.orgs_can_add;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_add.includes(org_id)) {\n          return my_permissions.push(\"add\");\n        }\n      });\n    }\n    if (flow.perms.users_can_monitor) {\n      users_can_monitor = flow.perms.users_can_monitor;\n      if (users_can_monitor.includes(user_id)) {\n        my_permissions.push(\"monitor\");\n      }\n    }\n    if (flow.perms.orgs_can_monitor) {\n      orgs_can_monitor = flow.perms.orgs_can_monitor;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_monitor.includes(org_id)) {\n          return my_permissions.push(\"monitor\");\n        }\n      });\n    }\n    if (flow.perms.users_can_admin) {\n      users_can_admin = flow.perms.users_can_admin;\n      if (users_can_admin.includes(user_id)) {\n        my_permissions.push(\"admin\");\n      }\n    }\n    if (flow.perms.orgs_can_admin) {\n      orgs_can_admin = flow.perms.orgs_can_admin;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_admin.includes(org_id)) {\n          return my_permissions.push(\"admin\");\n        }\n      });\n    }\n  }\n  my_permissions = _.uniq(my_permissions);\n  return my_permissions;\n};\n","approveManager = {}\r\n\r\n\r\n###\r\n    å¯¹æ¯”approve_valuesä¸Žlast_values å¯¹è±¡ï¼Œ è¿”å›žapprove_valuesæ¯”last_valueså¤šå‡ºçš„æˆ–è€…æ”¹å˜çš„éƒ¨åˆ†\r\n###\r\napproveManager.getChangeValues = (last_values,approve_values) ->\r\n\r\n\tchangeValues = {}\r\n\r\n\tlast_values_keys = _.keys(last_values)\r\n\r\n\tapprove_values_keys = _.keys(approve_values)\r\n\r\n#\tconsole.log(\"last_values_keys\", last_values_keys)\r\n#\r\n#\tconsole.log(\"approve_values_keys\", approve_values_keys)\r\n\r\n\tapprove_values_keys.forEach (key)->\r\n\t\tif _.contains(last_values_keys, key)\r\n\t\t\tif !_.isEqual(last_values[key], approve_values[key])\r\n\t\t\t\tchangeValues[key] = approve_values[key]\r\n\t\telse\r\n\t\t\tif approve_values[key] != ''\r\n#\t\t\t\tconsole.log(key,approve_values[key])\r\n\t\t\t\tchangeValues[key] = approve_values[key]\r\n\r\n\treturn changeValues\r\n","                   \n\napproveManager = {};\n\n\n/*\n    å¯¹æ¯”approve_valuesä¸Žlast_values å¯¹è±¡ï¼Œ è¿”å›žapprove_valuesæ¯”last_valueså¤šå‡ºçš„æˆ–è€…æ”¹å˜çš„éƒ¨åˆ†\n */\n\napproveManager.getChangeValues = function(last_values, approve_values) {\n  var approve_values_keys, changeValues, last_values_keys;\n  changeValues = {};\n  last_values_keys = _.keys(last_values);\n  approve_values_keys = _.keys(approve_values);\n  approve_values_keys.forEach(function(key) {\n    if (_.contains(last_values_keys, key)) {\n      if (!_.isEqual(last_values[key], approve_values[key])) {\n        return changeValues[key] = approve_values[key];\n      }\n    } else {\n      if (approve_values[key] !== '') {\n        return changeValues[key] = approve_values[key];\n      }\n    }\n  });\n  return changeValues;\n};\n","flowManager = {}\r\n\r\nflowManager.getCategoriesFlows = (spaceId, categorieId, fields)->\r\n\r\n\tcategoriesForms = formManager.getCategoriesForms(spaceId, categorieId, {_id: 1}).fetch()\r\n\r\n\treturn db.flows.find({form: {$in : categoriesForms.getProperty(\"_id\")}})\r\n\r\nflowManager.getUnCategoriesFlows = (spaceId, fields)->\r\n\r\n\tunCategoriesForms = formManager.getUnCategoriesForms(spaceId, {_id: 1}).fetch()\r\n\r\n\treturn db.flows.find({form: {$in : unCategoriesForms.getProperty(\"_id\")}})\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","formManager = {}\r\n\r\nformManager.getCategoriesForms = (spaceId, categorieId, fields)->\r\n\tif fields\r\n\t\t_fields = {fields: fields}\r\n\r\n\treturn db.forms.find({space: spaceId, category: categorieId, state: \"enabled\"}, _fields)\r\n\r\nformManager.getUnCategoriesForms = (spaceId, fields) ->\r\n\tif fields\r\n\t\t_fields = {fields: fields}\r\n\treturn db.forms.find({space: spaceId, category: {$in: [null, \"\"]}, state: \"enabled\"}, _fields)\r\n","                \n\nformManager = {};\n\nformManager.getCategoriesForms = function(spaceId, categorieId, fields) {\n  var _fields;\n  if (fields) {\n    _fields = {\n      fields: fields\n    };\n  }\n  return db.forms.find({\n    space: spaceId,\n    category: categorieId,\n    state: \"enabled\"\n  }, _fields);\n};\n\nformManager.getUnCategoriesForms = function(spaceId, fields) {\n  var _fields;\n  if (fields) {\n    _fields = {\n      fields: fields\n    };\n  }\n  return db.forms.find({\n    space: spaceId,\n    category: {\n      $in: [null, \"\"]\n    },\n    state: \"enabled\"\n  }, _fields);\n};\n","stepManager = {}\r\n\r\nstepManager.allowBatch = (step)->\r\n\treturn step.allowBatch\r\n\r\nstepManager.getStep = (instance, flow, step_id)->\r\n\tflow_rev = instance.flow_version\r\n\tisExistStep = null\r\n\tif flow.current._id is flow_rev\r\n\t\tisExistStep = _.find(flow.current.steps, (step)->\r\n\t\t\treturn step._id is step_id\r\n\t\t)\r\n\telse\r\n\t\t_.each(flow.historys, (history)->\r\n\t\t\tif history._id is flow_rev\r\n\t\t\t\tisExistStep = _.find(history.steps, (step)->\r\n\t\t\t\t\treturn step._id is step_id\r\n\t\t\t\t)\r\n\t\t)\r\n\r\n\tif not isExistStep\r\n\t\tthrow new Meteor.Error('error!', \"ä¸èƒ½èŽ·å–step\")\r\n\r\n\treturn isExistStep","                \n\nstepManager = {};\n\nstepManager.allowBatch = function(step) {\n  return step.allowBatch;\n};\n\nstepManager.getStep = function(instance, flow, step_id) {\n  var flow_rev, isExistStep;\n  flow_rev = instance.flow_version;\n  isExistStep = null;\n  if (flow.current._id === flow_rev) {\n    isExistStep = _.find(flow.current.steps, function(step) {\n      return step._id === step_id;\n    });\n  } else {\n    _.each(flow.historys, function(history) {\n      if (history._id === flow_rev) {\n        return isExistStep = _.find(history.steps, function(step) {\n          return step._id === step_id;\n        });\n      }\n    });\n  }\n  if (!isExistStep) {\n    throw new Meteor.Error('error!', \"ä¸èƒ½èŽ·å–step\");\n  }\n  return isExistStep;\n};\n","_eval = require('eval')\r\n\r\nInstanceManager = {}\r\n\r\nlogger = new Logger 'Workflow -> InstanceManager'\r\n\r\nInstanceManager.handlerInstanceByFieldMap = (ins, field_map) ->\r\n\tres = ins\r\n\tif ins\r\n\t\tif !field_map\r\n\r\n\t\t\tflow = db.flows.findOne({ _id: ins.flow }, { fields: { field_map: 1 } })\r\n\r\n\t\t\tif flow?.field_map\r\n\t\t\t\tfield_map = flow.field_map\r\n\r\n\t\tif field_map\r\n\t\t\tcontext = _.clone(ins)\r\n\r\n\t\t\tcontext._ = _\r\n\r\n\t\t\tscript = \"var instances = #{field_map}; exports.instances = instances\"\r\n\t\t\ttry\r\n\t\t\t\tres = _eval(script, \"handlerInstanceByFieldMap\", context, false).instances\r\n\t\t\tcatch e\r\n\t\t\t\tres = { _error: e }\r\n\t\t\t\tlogger.error e\r\n\treturn res\r\n\r\nInstanceManager.getCurrentApprove = (instance, handler)->\r\n\r\n\tif !instance or !instance.traces or instance.traces.length < 1\r\n\t\treturn\r\n\r\n\tcurrentTraces = instance.traces.filterProperty('is_finished', false)\r\n\r\n\tif currentTraces.length\r\n\t\tcurrentApproves = currentTraces[0].approves.filterProperty('is_finished', false).filterProperty('handler', handler)\r\n\t\tcurrentApprove = if currentApproves.length > 0 then currentApproves[0] else null\r\n\r\n\t#ä¼ é˜…çš„approveè¿”å›žæœ€æ–°ä¸€æ¡\r\n\tif !currentApprove or currentApprove.type == 'cc'\r\n\t\t# å½“å‰æ˜¯ä¼ é˜…\r\n\t\t_.each instance.traces, (t) ->\r\n\t\t\t_.each t.approves, (a) ->\r\n\t\t\t\tif a.type == 'cc' and a.user == handler and a.is_finished == false\r\n\t\t\t\t\tcurrentApprove = a\r\n\t\t\t\treturn\r\n\t\t\treturn\r\n\r\n\tif !currentApprove\r\n\t\treturn\r\n\r\n\treturn currentApprove\r\n\r\nInstanceManager.getCurrentTrace = (instance, traceId)->\r\n\treturn instance.traces.findPropertyByPK(\"_id\", traceId)\r\n\r\nInstanceManager.getMyApprove = (instanceId, userId)->\r\n\tinstance = db.instances.findOne({_id: instanceId})\r\n\r\n\tflow = uuflowManager.getFlow(instance.flow)\r\n\r\n\tmy_approve = InstanceManager.getCurrentApprove(instance, userId)\r\n\r\n\tif my_approve\r\n\r\n#\t\tlang = Steedos.locale(that.userId, true)\r\n\r\n\t\ttrace = InstanceManager.getCurrentTrace(instance, my_approve.trace)\r\n\r\n\t\tstep = uuflowManager.getStep(instance, flow, trace.step)\r\n\r\n\t\tstep_type = step.step_type\r\n\r\n\t\tjudge = if step_type == \"sign\" then \"approved\" else \"\"\r\n\r\n\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, judge)\r\n\r\n\t\tif nextSteps.length == 1\r\n\t\t\tif step_type == \"sign\" || step_type == \"counterSign\"\r\n\t\t\t\tmy_approve.judge = 'approved'\r\n\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance._id , nextSteps[0])\r\n\t\t\tif !next_user_ids\r\n\t\t\t\tmy_approve.next_steps = [{ step: nextSteps[0], users: [] }]\r\n\t\t\t\treturn my_approve\r\n\t\t\tif next_user_ids.length == 1\r\n\t\t\t\tmy_approve.next_steps = [{step: nextSteps[0], users: next_user_ids}]\r\n\t\t\t\treturn my_approve\r\n#\t\t\telse\r\n#\t\t\t\tthrow new Meteor.Error('error!', TAPi18n.__('workflow_error_multiple_next_step_users', {insname: instance.name}, lang))\r\n#\t\telse\r\n#\t\t\tthrow new Meteor.Error('error!', TAPi18n.__('workflow_error_multiple_next_step', {insname: instance.name}, lang))\r\n\r\n\treturn\r\n\r\n\r\nInstanceManager.getBatchInstances = (space, categoryId, flowIds, inbox_user)->\r\n\t_batch_instances = new Array()\r\n\r\n\tquery = {space: space, inbox_users: inbox_user}\r\n\r\n\tFIELDS = { name: 1, applicant_name: 1, submit_date: 1, flow_version: 1, \"traces.step\": 1, flow: 1, current_step_name: 1, flow_name: 1 }\r\n\r\n\tif categoryId\r\n\r\n\t\tif categoryId == '-1'\r\n\t\t\tunCategoryFlows = flowManager.getUnCategoriesFlows(space, {_id: 1}).fetch().getProperty(\"_id\")\r\n\t\t\tquery.flow = {$in: unCategoryFlows}\r\n\t\telse\r\n\t\t\tcategoryFlows = flowManager.getCategoriesFlows(space, categoryId, {_id: 1}).fetch().getProperty(\"_id\")\r\n\t\t\tquery.flow = {$in: categoryFlows}\r\n\r\n\tif flowIds\r\n\t\tquery.flow = {$in: flowIds}\r\n\r\n#\tconsole.log(\"query\", JSON.stringify(query))\r\n\r\n\tinbox_instances = db.instances.find(query, {fields: FIELDS, skip: 0, limit: 100})\r\n\r\n\tinbox_instances.forEach (ins)->\r\n\t\tcurrentStepId = _.last(ins.traces).step #TODO æ­¤ä»£ç ä¸é€‚ç”¨ä¼ é˜…æ‰¹å¤„ç†\r\n\r\n\t\tflow = db.flows.findOne({_id: ins.flow})\r\n\r\n\t\tcurrentStep = stepManager.getStep(ins, flow, currentStepId)\r\n\r\n\t\tmyApprove = InstanceManager.getMyApprove(ins._id, inbox_user)\r\n\r\n\t\tif stepManager.allowBatch(currentStep) && myApprove\r\n\r\n\t\t\tdelete ins.flow_version\r\n\r\n\t\t\tdelete ins.traces\r\n\r\n\t\t\tdelete ins.flow\r\n\r\n\t\t\tins.approve_start_date = myApprove.start_date\r\n\r\n\t\t\t_batch_instances.push(ins)\r\n#\t\telse\r\n#\t\t\tconsole.log(\"æ‰¹é‡å®¡æ‰¹-å¼‚å¸¸æ•°æ®\", ins._id)\r\n\r\n\treturn _batch_instances\r\n","var _eval, logger;                 \n\n_eval = require('eval');\n\nInstanceManager = {};\n\nlogger = new Logger('Workflow -> InstanceManager');\n\nInstanceManager.handlerInstanceByFieldMap = function(ins, field_map) {\n  var context, e, flow, res, script;\n  res = ins;\n  if (ins) {\n    if (!field_map) {\n      flow = db.flows.findOne({\n        _id: ins.flow\n      }, {\n        fields: {\n          field_map: 1\n        }\n      });\n      if (flow != null ? flow.field_map : void 0) {\n        field_map = flow.field_map;\n      }\n    }\n    if (field_map) {\n      context = _.clone(ins);\n      context._ = _;\n      script = \"var instances = \" + field_map + \"; exports.instances = instances\";\n      try {\n        res = _eval(script, \"handlerInstanceByFieldMap\", context, false).instances;\n      } catch (error) {\n        e = error;\n        res = {\n          _error: e\n        };\n        logger.error(e);\n      }\n    }\n  }\n  return res;\n};\n\nInstanceManager.getCurrentApprove = function(instance, handler) {\n  var currentApprove, currentApproves, currentTraces;\n  if (!instance || !instance.traces || instance.traces.length < 1) {\n    return;\n  }\n  currentTraces = instance.traces.filterProperty('is_finished', false);\n  if (currentTraces.length) {\n    currentApproves = currentTraces[0].approves.filterProperty('is_finished', false).filterProperty('handler', handler);\n    currentApprove = currentApproves.length > 0 ? currentApproves[0] : null;\n  }\n  if (!currentApprove || currentApprove.type === 'cc') {\n    _.each(instance.traces, function(t) {\n      _.each(t.approves, function(a) {\n        if (a.type === 'cc' && a.user === handler && a.is_finished === false) {\n          currentApprove = a;\n        }\n      });\n    });\n  }\n  if (!currentApprove) {\n    return;\n  }\n  return currentApprove;\n};\n\nInstanceManager.getCurrentTrace = function(instance, traceId) {\n  return instance.traces.findPropertyByPK(\"_id\", traceId);\n};\n\nInstanceManager.getMyApprove = function(instanceId, userId) {\n  var flow, instance, judge, my_approve, nextSteps, next_user_ids, step, step_type, trace;\n  instance = db.instances.findOne({\n    _id: instanceId\n  });\n  flow = uuflowManager.getFlow(instance.flow);\n  my_approve = InstanceManager.getCurrentApprove(instance, userId);\n  if (my_approve) {\n    trace = InstanceManager.getCurrentTrace(instance, my_approve.trace);\n    step = uuflowManager.getStep(instance, flow, trace.step);\n    step_type = step.step_type;\n    judge = step_type === \"sign\" ? \"approved\" : \"\";\n    nextSteps = uuflowManager.getNextSteps(instance, flow, step, judge);\n    if (nextSteps.length === 1) {\n      if (step_type === \"sign\" || step_type === \"counterSign\") {\n        my_approve.judge = 'approved';\n      }\n      next_user_ids = getHandlersManager.getHandlers(instance._id, nextSteps[0]);\n      if (!next_user_ids) {\n        my_approve.next_steps = [\n          {\n            step: nextSteps[0],\n            users: []\n          }\n        ];\n        return my_approve;\n      }\n      if (next_user_ids.length === 1) {\n        my_approve.next_steps = [\n          {\n            step: nextSteps[0],\n            users: next_user_ids\n          }\n        ];\n        return my_approve;\n      }\n    }\n  }\n};\n\nInstanceManager.getBatchInstances = function(space, categoryId, flowIds, inbox_user) {\n  var FIELDS, _batch_instances, categoryFlows, inbox_instances, query, unCategoryFlows;\n  _batch_instances = new Array();\n  query = {\n    space: space,\n    inbox_users: inbox_user\n  };\n  FIELDS = {\n    name: 1,\n    applicant_name: 1,\n    submit_date: 1,\n    flow_version: 1,\n    \"traces.step\": 1,\n    flow: 1,\n    current_step_name: 1,\n    flow_name: 1\n  };\n  if (categoryId) {\n    if (categoryId === '-1') {\n      unCategoryFlows = flowManager.getUnCategoriesFlows(space, {\n        _id: 1\n      }).fetch().getProperty(\"_id\");\n      query.flow = {\n        $in: unCategoryFlows\n      };\n    } else {\n      categoryFlows = flowManager.getCategoriesFlows(space, categoryId, {\n        _id: 1\n      }).fetch().getProperty(\"_id\");\n      query.flow = {\n        $in: categoryFlows\n      };\n    }\n  }\n  if (flowIds) {\n    query.flow = {\n      $in: flowIds\n    };\n  }\n  inbox_instances = db.instances.find(query, {\n    fields: FIELDS,\n    skip: 0,\n    limit: 100\n  });\n  inbox_instances.forEach(function(ins) {\n    var currentStep, currentStepId, flow, myApprove;\n    currentStepId = _.last(ins.traces).step;\n    flow = db.flows.findOne({\n      _id: ins.flow\n    });\n    currentStep = stepManager.getStep(ins, flow, currentStepId);\n    myApprove = InstanceManager.getMyApprove(ins._id, inbox_user);\n    if (stepManager.allowBatch(currentStep) && myApprove) {\n      delete ins.flow_version;\n      delete ins.traces;\n      delete ins.flow;\n      ins.approve_start_date = myApprove.start_date;\n      return _batch_instances.push(ins);\n    }\n  });\n  return _batch_instances;\n};\n","Meteor.publish 'categories', (spaceId) ->\r\n\tcheck spaceId, String\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\r\n\treturn db.categories.find({ space: spaceId }, { fields: { name: 1, space: 1, sort_no: 1, app: 1 } })","Meteor.publish('categories', function(spaceId) {\n  check(spaceId, String);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.categories.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1,\n      space: 1,\n      sort_no: 1,\n      app: 1\n    }\n  });\n});\n","\r\nMeteor.publish 'cfs_instances', (instanceIds)->\r\n\tcheck(instanceIds, Array)\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless instanceIds\r\n\t\t\treturn this.ready()\r\n\r\n\treturn cfs.instances.find({'metadata.instance': {$in: instanceIds} , $or: [{'metadata.is_private': {$ne: true}},{'metadata.is_private': true, \"metadata.owner\": this.userId}]})\r\n","Meteor.publish('cfs_instances', function(instanceIds) {\n  check(instanceIds, Array);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceIds) {\n    return this.ready();\n  }\n  return cfs.instances.find({\n    'metadata.instance': {\n      $in: instanceIds\n    },\n    $or: [\n      {\n        'metadata.is_private': {\n          $ne: true\n        }\n      }, {\n        'metadata.is_private': true,\n        \"metadata.owner\": this.userId\n      }\n    ]\n  });\n});\n","\r\n\r\nMeteor.publish 'flow_positions', (spaceId)->\r\n\t\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\t\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\treturn db.flow_positions.find({space: spaceId}, {fields: {role:1, users: 1, org: 1}});\r\n","Meteor.publish('flow_positions', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.flow_positions.find({\n    space: spaceId\n  }, {\n    fields: {\n      role: 1,\n      users: 1,\n      org: 1\n    }\n  });\n});\n","Meteor.publishComposite 'flow_positions_tabular', (tableName, ids, fields)->\r\n\tcheck(tableName, String);\r\n\tcheck(ids, Array);\r\n\tcheck(fields, Match.Optional(Object));\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tthis.unblock()\r\n\r\n\tfind: ->\r\n\t\tthis.unblock()\r\n\t\tdb.flow_positions.find {_id: {$in: ids}}, fields: fields\r\n\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tfind: (position) ->\r\n\t\t\t\t@unblock()\r\n\t\t\t\t# Publish the related flow_roles\r\n\t\t\t\tdb.flow_roles.find { _id: position.role }, fields: name: 1\r\n\t\t}\r\n\t\t{\r\n\t\t\tfind: (position) ->\r\n\t\t\t\t@unblock()\r\n\t\t\t\t# Publish the related organizations\r\n\t\t\t\tdb.organizations.find { _id: position.org }, fields: fullname: 1\r\n\t\t}\r\n\t\t{\r\n\t\t\tfind: (position) ->\r\n\t\t\t\t@unblock()\r\n\t\t\t\t# Publish the related user\r\n\t\t\t\tdb.space_users.find {\r\n\t\t\t\t\tspace: position.space\r\n\t\t\t\t\tuser: $in: position.users\r\n\t\t\t\t}, fields:\r\n\t\t\t\t\tspace: 1\r\n\t\t\t\t\tuser: 1\r\n\t\t\t\t\tname: 1\r\n\t\t}\r\n\t]","Meteor.publishComposite('flow_positions_tabular', function(tableName, ids, fields) {\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  if (!this.userId) {\n    return this.ready();\n  }\n  this.unblock();\n  return {\n    find: function() {\n      this.unblock();\n      return db.flow_positions.find({\n        _id: {\n          $in: ids\n        }\n      }, {\n        fields: fields\n      });\n    },\n    children: [\n      {\n        find: function(position) {\n          this.unblock();\n          return db.flow_roles.find({\n            _id: position.role\n          }, {\n            fields: {\n              name: 1\n            }\n          });\n        }\n      }, {\n        find: function(position) {\n          this.unblock();\n          return db.organizations.find({\n            _id: position.org\n          }, {\n            fields: {\n              fullname: 1\n            }\n          });\n        }\n      }, {\n        find: function(position) {\n          this.unblock();\n          return db.space_users.find({\n            space: position.space,\n            user: {\n              $in: position.users\n            }\n          }, {\n            fields: {\n              space: 1,\n              user: 1,\n              name: 1\n            }\n          });\n        }\n      }\n    ]\n  };\n});\n","\r\n\r\n\tMeteor.publish 'flow_roles', (spaceId)->\r\n\t\t\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\t\t\r\n\t\tunless spaceId\r\n\t\t\treturn this.ready()\r\n\r\n\r\n\t\treturn db.flow_roles.find({space: spaceId}, {fields: {name:1}});\r\n","Meteor.publish('flow_roles', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.flow_roles.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1\n    }\n  });\n});\n","Meteor.publish 'flows', (spaceId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\t# ç¬¬ä¸€æ¬¡è®¢é˜…æ—¶åˆå§‹åŒ–å·¥ä½œåŒº\r\n\tif db.flows.find({space: spaceId}).count() == 0\r\n\t\tdb.spaces.createTemplateFormAndFlow(spaceId)\r\n\r\n\treturn db.flows.find({space: spaceId}, {\r\n\t\tfields: {\r\n\t\t\tname: 1,\r\n\t\t\tform: 1,\r\n\t\t\tstate: 1,\r\n\t\t\tperms: 1,\r\n\t\t\tspace: 1,\r\n\t\t\tcompany_id: 1,\r\n\t\t\tsort_no: 1,\r\n\t\t\tdistribute_optional_users: 1,\r\n\t\t\tdistribute_to_self: 1\r\n\t\t}\r\n\t})\r\n\r\n\r\nMeteor.publish 'flow_version', (spaceId, flowId, versionId) ->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\tunless flowId\r\n\t\treturn this.ready()\r\n\r\n\tunless versionId\r\n\t\treturn this.ready()\r\n\r\n\r\n\tself = this;\r\n\r\n\tgetFlowVersion = (id , versionId)->\r\n\t\tflow = db.flows.findOne({_id : id});\r\n\t\tif flow\r\n\t\t\tflow_version = flow.current\r\n\t\t\tflow_version.latest = true\r\n\r\n\t\t\tif flow_version._id != versionId\r\n\t\t\t\tflow_version = flow.historys.findPropertyByPK(\"_id\", versionId)\r\n\t\t\t\tflow_version.latest = false\r\n\r\n\t\t\treturn flow_version\r\n\thandle = db.flows.find({_id: flowId}, {fields: {_id: 1, \"current.modified\": 1}}).observeChanges {\r\n\t\tchanged: (id)->\r\n\t\t\tself.changed(\"flow_versions\", versionId, getFlowVersion(id, versionId));\r\n\t}\r\n\r\n\r\n\tself.added(\"flow_versions\", versionId, getFlowVersion(flowId, versionId));\r\n\tself.ready();\r\n\tself.onStop ()->\r\n\t\thandle.stop()\r\n\r\nMeteor.publish 'distribute_optional_flows', (flow_ids)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless flow_ids\r\n\t\treturn this.ready()\r\n\r\n\treturn db.flows.find({_id: {$in: flow_ids}}, {\r\n\t\tfields: {\r\n\t\t\tname: 1,\r\n\t\t\tform: 1,\r\n\t\t\tstate: 1,\r\n\t\t\tperms: 1,\r\n\t\t\tspace: 1,\r\n\t\t\tdistribute_optional_users: 1,\r\n\t\t\tdistribute_to_self: 1,\r\n\t\t\tdistribute_end_notification: 1,\r\n\t\t\tcompany_id: 1\r\n\t\t}\r\n\t})\r\n\r\nMeteor.publish 'flow', (spaceId, flowId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\tunless flowId\r\n\t\treturn this.ready()\r\n\r\n\r\n\treturn db.flows.find({_id: flowId, space: spaceId}, {\r\n\t\tfields: {\r\n\t\t\tprint_template: 1,\r\n\t\t\tinstance_template: 1,\r\n\t\t\tevents: 1,\r\n\t\t\tdistribute_optional_users: 1,\r\n\t\t\tdistribute_to_self: 1,\r\n\t\t\tupload_after_being_distributed: 1,\r\n\t\t\tdistribute_end_notification: 1,\r\n\t\t\tcompany_id: 1,\r\n\t\t\tallow_select_step: 1\r\n\t\t}\r\n\t})\r\nMeteor.publish 'flow_files', (spaceId, flowId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\tunless flowId\r\n\t\treturn this.ready()\r\n\r\n\treturn cfs.files.find({ 'metadata.space': spaceId, 'metadata.object_name': 'flows', 'metadata.record_id': flowId })\r\n\r\nMeteor.publishComposite 'flows_tabular', (tableName, ids, fields)->\r\n\tcheck(tableName, String);\r\n\tcheck(ids, Array);\r\n\tcheck(fields, Match.Optional(Object));\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tthis.unblock()\r\n\r\n\tfind: ->\r\n\t\tthis.unblock()\r\n\t\tdb.flows.find {_id: {$in: ids}}, fields: fields\r\n\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tfind: (flow) ->\r\n\t\t\t\t@unblock()\r\n\t\t\t\t# Publish the related user\r\n\t\t\t\tdb.space_users.find {\r\n\t\t\t\t\tspace: flow.space,\r\n\t\t\t\t\tuser: flow.current.modified_by\r\n\t\t\t\t}, fields:\r\n\t\t\t\t\tspace: 1\r\n\t\t\t\t\tuser: 1\r\n\t\t\t\t\tname: 1\r\n\t\t},\r\n\t\t{\r\n\t\t\tfind: (flow) ->\r\n\t\t\t\t@unblock()\r\n\t\t\t\t# Publish the related user\r\n\t\t\t\tdb.forms.find {\r\n\t\t\t\t\tspace: flow.space,\r\n\t\t\t\t\t_id: flow.form\r\n\t\t\t\t}, fields:\r\n\t\t\t\t\tspace: 1\r\n\t\t\t\t\t_id: 1\r\n\t\t\t\t\tname: 1,\r\n\t\t\t\t\tcategory: 1\r\n\t\t},\r\n\t\t{\r\n\t\t\tfind: (flow) ->\r\n\t\t\t\t@unblock()\r\n\t\t\t\t# Publish the related user\r\n\t\t\t\tdb.categories.find {\r\n\t\t\t\t\tspace: flow.space\r\n\t\t\t\t}, fields:\r\n\t\t\t\t\tspace: 1\r\n\t\t\t\t\t_id: 1\r\n\t\t\t\t\tname: 1\r\n\t\t}\r\n\t]","Meteor.publish('flows', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (db.flows.find({\n    space: spaceId\n  }).count() === 0) {\n    db.spaces.createTemplateFormAndFlow(spaceId);\n  }\n  return db.flows.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1,\n      form: 1,\n      state: 1,\n      perms: 1,\n      space: 1,\n      company_id: 1,\n      sort_no: 1,\n      distribute_optional_users: 1,\n      distribute_to_self: 1\n    }\n  });\n});\n\nMeteor.publish('flow_version', function(spaceId, flowId, versionId) {\n  var getFlowVersion, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!flowId) {\n    return this.ready();\n  }\n  if (!versionId) {\n    return this.ready();\n  }\n  self = this;\n  getFlowVersion = function(id, versionId) {\n    var flow, flow_version;\n    flow = db.flows.findOne({\n      _id: id\n    });\n    if (flow) {\n      flow_version = flow.current;\n      flow_version.latest = true;\n      if (flow_version._id !== versionId) {\n        flow_version = flow.historys.findPropertyByPK(\"_id\", versionId);\n        flow_version.latest = false;\n      }\n      return flow_version;\n    }\n  };\n  handle = db.flows.find({\n    _id: flowId\n  }, {\n    fields: {\n      _id: 1,\n      \"current.modified\": 1\n    }\n  }).observeChanges({\n    changed: function(id) {\n      return self.changed(\"flow_versions\", versionId, getFlowVersion(id, versionId));\n    }\n  });\n  self.added(\"flow_versions\", versionId, getFlowVersion(flowId, versionId));\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n\nMeteor.publish('distribute_optional_flows', function(flow_ids) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!flow_ids) {\n    return this.ready();\n  }\n  return db.flows.find({\n    _id: {\n      $in: flow_ids\n    }\n  }, {\n    fields: {\n      name: 1,\n      form: 1,\n      state: 1,\n      perms: 1,\n      space: 1,\n      distribute_optional_users: 1,\n      distribute_to_self: 1,\n      distribute_end_notification: 1,\n      company_id: 1\n    }\n  });\n});\n\nMeteor.publish('flow', function(spaceId, flowId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!flowId) {\n    return this.ready();\n  }\n  return db.flows.find({\n    _id: flowId,\n    space: spaceId\n  }, {\n    fields: {\n      print_template: 1,\n      instance_template: 1,\n      events: 1,\n      distribute_optional_users: 1,\n      distribute_to_self: 1,\n      upload_after_being_distributed: 1,\n      distribute_end_notification: 1,\n      company_id: 1,\n      allow_select_step: 1\n    }\n  });\n});\n\nMeteor.publish('flow_files', function(spaceId, flowId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!flowId) {\n    return this.ready();\n  }\n  return cfs.files.find({\n    'metadata.space': spaceId,\n    'metadata.object_name': 'flows',\n    'metadata.record_id': flowId\n  });\n});\n\nMeteor.publishComposite('flows_tabular', function(tableName, ids, fields) {\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  if (!this.userId) {\n    return this.ready();\n  }\n  this.unblock();\n  return {\n    find: function() {\n      this.unblock();\n      return db.flows.find({\n        _id: {\n          $in: ids\n        }\n      }, {\n        fields: fields\n      });\n    },\n    children: [\n      {\n        find: function(flow) {\n          this.unblock();\n          return db.space_users.find({\n            space: flow.space,\n            user: flow.current.modified_by\n          }, {\n            fields: {\n              space: 1,\n              user: 1,\n              name: 1\n            }\n          });\n        }\n      }, {\n        find: function(flow) {\n          this.unblock();\n          return db.forms.find({\n            space: flow.space,\n            _id: flow.form\n          }, {\n            fields: {\n              space: 1,\n              _id: 1,\n              name: 1,\n              category: 1\n            }\n          });\n        }\n      }, {\n        find: function(flow) {\n          this.unblock();\n          return db.categories.find({\n            space: flow.space\n          }, {\n            fields: {\n              space: 1,\n              _id: 1,\n              name: 1\n            }\n          });\n        }\n      }\n    ]\n  };\n});\n","Meteor.publish 'forms', (spaceId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\r\n\treturn db.forms.find({space: spaceId}, {fields: {name: 1, category: 1, state: 1, description: 1, instance_style: 1}})\r\n\r\n\r\nMeteor.publish 'form_version', (spaceId, formId, versionId) ->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\tunless formId\r\n\t\treturn this.ready()\r\n\r\n\tunless versionId\r\n\t\treturn this.ready()\r\n\r\n\r\n\tself = this;\r\n\r\n\tgetFormVersion = (id , versionId)->\r\n\t\tform = db.forms.findOne({_id : id});\r\n\t\tif !form\r\n\t\t\treturn {}\r\n\t\tform_version = form.current\r\n\t\tform_version.latest = true\r\n\t\tif form_version._id != versionId\r\n\t\t\tform_version = form.historys.findPropertyByPK(\"_id\", versionId)\r\n\t\t\tform_version.latest = false\r\n\t\treturn form_version\r\n\r\n\thandle = db.forms.find({_id: formId}, {fields: {_id: 1, \"current.modified\": 1}}).observeChanges {\r\n\t\tchanged: (id)->\r\n\t\t\tself.changed(\"form_versions\", versionId, getFormVersion(id, versionId));\r\n\t}\r\n\r\n\tself.added(\"form_versions\", versionId, getFormVersion(formId, versionId));\r\n\tself.ready();\r\n\tself.onStop ()->\r\n\t\thandle.stop()","Meteor.publish('forms', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.forms.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1,\n      category: 1,\n      state: 1,\n      description: 1,\n      instance_style: 1\n    }\n  });\n});\n\nMeteor.publish('form_version', function(spaceId, formId, versionId) {\n  var getFormVersion, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!formId) {\n    return this.ready();\n  }\n  if (!versionId) {\n    return this.ready();\n  }\n  self = this;\n  getFormVersion = function(id, versionId) {\n    var form, form_version;\n    form = db.forms.findOne({\n      _id: id\n    });\n    if (!form) {\n      return {};\n    }\n    form_version = form.current;\n    form_version.latest = true;\n    if (form_version._id !== versionId) {\n      form_version = form.historys.findPropertyByPK(\"_id\", versionId);\n      form_version.latest = false;\n    }\n    return form_version;\n  };\n  handle = db.forms.find({\n    _id: formId\n  }, {\n    fields: {\n      _id: 1,\n      \"current.modified\": 1\n    }\n  }).observeChanges({\n    changed: function(id) {\n      return self.changed(\"form_versions\", versionId, getFormVersion(id, versionId));\n    }\n  });\n  self.added(\"form_versions\", versionId, getFormVersion(formId, versionId));\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","Meteor.publish 'instance_data', (instanceId, box)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless instanceId\r\n\t\treturn this.ready()\r\n\r\n\tself = this;\r\n\r\n\tminiApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description',\r\n\t\t'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description', 'auto_submitted']\r\n\r\n\ttriggerChangeFields = ['form_version', 'flow_version', 'related_instances', '_my_approve_read_dates', 'values']\r\n\r\n\ttriggerChangeFieldsValues = {}\r\n\r\n\tinstance_fields_0 = {\r\n\t\t\"record_synced\": 0,\r\n\r\n#\t\t\"traces.approves.handler_organization_fullname\": 0,\r\n\t\t\"traces.approves.handler_organization_name\": 0,\r\n\t\t\"traces.approves.handler_organization\": 0,\r\n\t\t\"traces.approves.cost_time\": 0,\r\n#\t\t\"traces.approves.read_date\": 0,\r\n\t\t\"traces.approves.is_error\": 0,\r\n\t\t# \"traces.approves.user_name\": 0,\r\n\t\t\"traces.approves.deadline\": 0,\r\n\t\t\"traces.approves.remind_date\": 0,\r\n\t\t\"traces.approves.reminded_count\": 0,\r\n\t\t\"traces.approves.modified_by\": 0,\r\n\t\t\"traces.approves.modified\": 0,\r\n\t\t\"traces.approves.geolocation\": 0,\r\n\t\t\"traces.approves.cc_users\": 0,\r\n\t\t\"traces.approves.from_approve_id\": 0,\r\n\t\t\"traces.approves.values_history\": 0\r\n\t}\r\n\r\n\tgetMyapproveModified = (traces)->\r\n\t\tmyApproveModifieds = new Array()\r\n\r\n\t\ttraces?.forEach (trace)->\r\n\t\t\ttrace?.approves?.forEach (approve)->\r\n\t\t\t\tif (approve.user == self.userId || approve.handler == self.userId)\r\n\t\t\t\t# && !approve.is_finished\r\n#\t\t\t\t\tconsole.log(\"approve\", approve._id, approve.read_date)\r\n\r\n\t\t\t\t\tmyApproveModifieds.push(approve.read_date)\r\n\r\n\t\treturn myApproveModifieds\r\n\r\n\r\n\tgetMiniInstance = (_instanceId)->\r\n\t\tinstance = db.instances.findOne({_id: _instanceId}, {fields: instance_fields_0})\r\n\r\n\t\tif instance\r\n\r\n\t\t\ttriggerChangeFields.forEach (key)->\r\n\t\t\t\tif key == '_my_approve_read_dates'\r\n\t\t\t\t\ttriggerChangeFieldsValues[key] = getMyapproveModified(instance.traces)\r\n\t\t\t\telse\r\n\t\t\t\t\ttriggerChangeFieldsValues[key] = instance[key]\r\n\r\n#\t\t\thasOpinionField = InstanceSignText.includesOpinionField(instance.form, instance.form_version)\r\n\r\n\t\t\tshow_modal_traces_list = db.space_settings.findOne({ space: instance.space, key: \"show_modal_traces_list\" }, { fields: { values: 1 } })?.values || false\r\n\r\n\t\t\tif show_modal_traces_list\r\n\r\n\t\t\t\ttraces = new Array();\r\n\r\n\t\t\t\tinstance?.traces?.forEach (trace)->\r\n\t\t\t\t\t_trace = _.clone(trace)\r\n\r\n\t\t\t\t\tapproves = new Array()\r\n\r\n\t\t\t\t\ttrace?.approves?.forEach (approve)->\r\n\t\t\t\t\t\tif approve.type != 'cc' || approve.user == self.userId || approve.handler == self.userId || (!_.isEmpty(approve.sign_field_code))\r\n\t\t\t\t\t\t\tapproves.push(approve)\r\n\r\n\t\t\t\t\t_trace.approves = approves\r\n\r\n\t\t\t\t\ttraces.push(_trace)\r\n\r\n\t\t\t\tinstance.traces = traces;\r\n\r\n\t\treturn instance\r\n\r\n\r\n\tneedChange = (changeFields)->\r\n\t\tif changeFields\r\n\r\n\t\t\t_change = false\r\n\r\n\t\t\t_rev = _.find triggerChangeFields, (key)->\r\n\t\t\t\t_key = key\r\n\r\n\t\t\t\tif key == '_my_approve_read_dates'\r\n\t\t\t\t\t_key = 'traces'\r\n\r\n\t\t\t\tif _.has(changeFields, _key)\r\n\r\n\t\t\t\t\tif key == '_my_approve_read_dates'\r\n\r\n\t\t\t\t\t\t_my_approve_modifieds = getMyapproveModified(changeFields.traces)\r\n\r\n#\t\t\t\t\t\tconsole.log(triggerChangeFieldsValues[key], _my_approve_modifieds)\r\n\r\n\t\t\t\t\t\treturn !_.isEqual(triggerChangeFieldsValues[key], _my_approve_modifieds)\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\treturn !_.isEqual(triggerChangeFieldsValues[key], changeFields[key])\r\n\r\n\t\t\tif _rev\r\n\t\t\t\t_change = true\r\n\r\n#\t\t\tconsole.log(_rev, _change)\r\n\r\n\t\t\treturn _change\r\n\r\n\t\treturn true\r\n\t#æ­¤å¤„ä¸èƒ½æ·»åŠ fieldsé™åˆ¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ•°æ®ä¸å®žæ—¶\r\n\thandle = db.instances.find({_id: instanceId}).observeChanges {\r\n\t\tchanged: (id, fields)->\r\n\t\t\tif(box != 'inbox' || needChange(fields))\r\n\t\t\t\tself.changed(\"instances\", id, getMiniInstance(id));\r\n\t\tremoved: (id)->\r\n\t\t\tself.removed(\"instances\", id);\r\n\t}\r\n\r\n\tinstance = getMiniInstance(instanceId)\r\n\r\n\tself.added(\"instances\", instance?._id, instance);\r\n\r\n\tself.ready();\r\n\r\n\tself.onStop ()->\r\n\t\thandle.stop()\r\n\r\n\r\nMeteor.publish 'instance_traces', (instanceId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless instanceId\r\n\t\treturn this.ready()\r\n\r\n\tself = this\r\n\r\n\tgetInstanceTraces = (_insId)->\r\n\t\treturn db.instances.findOne({_id: _insId}, {fields: {_id: 1, traces: 1}})\r\n\r\n\r\n\thandle =  db.instances.find({_id: instanceId}).observeChanges {\r\n\t\tchanged: (id)->\r\n\t\t\tself.changed(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\r\n\t}\r\n\r\n\tself.added(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\r\n\r\n\tself.ready();\r\n\tself.onStop ()->\r\n\t\thandle.stop()","Meteor.publish('instance_data', function(instanceId, box) {\n  var getMiniInstance, getMyapproveModified, handle, instance, instance_fields_0, miniApproveFields, needChange, self, triggerChangeFields, triggerChangeFieldsValues;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceId) {\n    return this.ready();\n  }\n  self = this;\n  miniApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description', 'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description', 'auto_submitted'];\n  triggerChangeFields = ['form_version', 'flow_version', 'related_instances', '_my_approve_read_dates', 'values'];\n  triggerChangeFieldsValues = {};\n  instance_fields_0 = {\n    \"record_synced\": 0,\n    \"traces.approves.handler_organization_name\": 0,\n    \"traces.approves.handler_organization\": 0,\n    \"traces.approves.cost_time\": 0,\n    \"traces.approves.is_error\": 0,\n    \"traces.approves.deadline\": 0,\n    \"traces.approves.remind_date\": 0,\n    \"traces.approves.reminded_count\": 0,\n    \"traces.approves.modified_by\": 0,\n    \"traces.approves.modified\": 0,\n    \"traces.approves.geolocation\": 0,\n    \"traces.approves.cc_users\": 0,\n    \"traces.approves.from_approve_id\": 0,\n    \"traces.approves.values_history\": 0\n  };\n  getMyapproveModified = function(traces) {\n    var myApproveModifieds;\n    myApproveModifieds = new Array();\n    if (traces != null) {\n      traces.forEach(function(trace) {\n        var ref;\n        return trace != null ? (ref = trace.approves) != null ? ref.forEach(function(approve) {\n          if (approve.user === self.userId || approve.handler === self.userId) {\n            return myApproveModifieds.push(approve.read_date);\n          }\n        }) : void 0 : void 0;\n      });\n    }\n    return myApproveModifieds;\n  };\n  getMiniInstance = function(_instanceId) {\n    var instance, ref, ref1, show_modal_traces_list, traces;\n    instance = db.instances.findOne({\n      _id: _instanceId\n    }, {\n      fields: instance_fields_0\n    });\n    if (instance) {\n      triggerChangeFields.forEach(function(key) {\n        if (key === '_my_approve_read_dates') {\n          return triggerChangeFieldsValues[key] = getMyapproveModified(instance.traces);\n        } else {\n          return triggerChangeFieldsValues[key] = instance[key];\n        }\n      });\n      show_modal_traces_list = ((ref = db.space_settings.findOne({\n        space: instance.space,\n        key: \"show_modal_traces_list\"\n      }, {\n        fields: {\n          values: 1\n        }\n      })) != null ? ref.values : void 0) || false;\n      if (show_modal_traces_list) {\n        traces = new Array();\n        if (instance != null) {\n          if ((ref1 = instance.traces) != null) {\n            ref1.forEach(function(trace) {\n              var _trace, approves, ref2;\n              _trace = _.clone(trace);\n              approves = new Array();\n              if (trace != null) {\n                if ((ref2 = trace.approves) != null) {\n                  ref2.forEach(function(approve) {\n                    if (approve.type !== 'cc' || approve.user === self.userId || approve.handler === self.userId || (!_.isEmpty(approve.sign_field_code))) {\n                      return approves.push(approve);\n                    }\n                  });\n                }\n              }\n              _trace.approves = approves;\n              return traces.push(_trace);\n            });\n          }\n        }\n        instance.traces = traces;\n      }\n    }\n    return instance;\n  };\n  needChange = function(changeFields) {\n    var _change, _rev;\n    if (changeFields) {\n      _change = false;\n      _rev = _.find(triggerChangeFields, function(key) {\n        var _key, _my_approve_modifieds;\n        _key = key;\n        if (key === '_my_approve_read_dates') {\n          _key = 'traces';\n        }\n        if (_.has(changeFields, _key)) {\n          if (key === '_my_approve_read_dates') {\n            _my_approve_modifieds = getMyapproveModified(changeFields.traces);\n            return !_.isEqual(triggerChangeFieldsValues[key], _my_approve_modifieds);\n          } else {\n            return !_.isEqual(triggerChangeFieldsValues[key], changeFields[key]);\n          }\n        }\n      });\n      if (_rev) {\n        _change = true;\n      }\n      return _change;\n    }\n    return true;\n  };\n  handle = db.instances.find({\n    _id: instanceId\n  }).observeChanges({\n    changed: function(id, fields) {\n      if (box !== 'inbox' || needChange(fields)) {\n        return self.changed(\"instances\", id, getMiniInstance(id));\n      }\n    },\n    removed: function(id) {\n      return self.removed(\"instances\", id);\n    }\n  });\n  instance = getMiniInstance(instanceId);\n  self.added(\"instances\", instance != null ? instance._id : void 0, instance);\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n\nMeteor.publish('instance_traces', function(instanceId) {\n  var getInstanceTraces, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceId) {\n    return this.ready();\n  }\n  self = this;\n  getInstanceTraces = function(_insId) {\n    return db.instances.findOne({\n      _id: _insId\n    }, {\n      fields: {\n        _id: 1,\n        traces: 1\n      }\n    });\n  };\n  handle = db.instances.find({\n    _id: instanceId\n  }).observeChanges({\n    changed: function(id) {\n      return self.changed(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\n    }\n  });\n  self.added(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","\r\n\tMeteor.publish 'instances_list', (spaceId, box, flowId)->\r\n\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\t\t\r\n\t\tunless spaceId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tquery = {space: spaceId}\r\n\t\tif box == \"inbox\"\r\n\t\t\tquery.inbox_users = this.userId;\r\n\t\telse if box == \"outbox\"\r\n\t\t\tquery.outbox_users = this.userId;\r\n\t\telse if box == \"draft\"\r\n\t\t\tquery.submitter = this.userId;\r\n\t\t\tquery.state = \"draft\"\r\n\t\telse if box == \"pending\"\r\n\t\t\tquery.submitter = this.userId;\r\n\t\t\tquery.state = \"pending\"\r\n\t\telse if box == \"completed\"\r\n\t\t\tquery.submitter = this.userId;\r\n\t\t\tquery.state = \"completed\"\r\n\t\telse if box == \"monitor\"\r\n\t\t\tquery.flow = flowId;\r\n\t\t\tquery.state = {$in: [\"pending\",\"completed\"]};\r\n\t\telse\r\n\t\t\tquery.state = \"none\"\r\n\r\n\t\treturn db.instances.find(query, {fields: {name:1, created:1, form:1, flow: 1, space:1, modified:1, applicant: 1, is_archived:1, form_version: 1, flow_version: 1}})\r\n\r\n","Meteor.publish('instances_list', function(spaceId, box, flowId) {\n  var query;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  query = {\n    space: spaceId\n  };\n  if (box === \"inbox\") {\n    query.inbox_users = this.userId;\n  } else if (box === \"outbox\") {\n    query.outbox_users = this.userId;\n  } else if (box === \"draft\") {\n    query.submitter = this.userId;\n    query.state = \"draft\";\n  } else if (box === \"pending\") {\n    query.submitter = this.userId;\n    query.state = \"pending\";\n  } else if (box === \"completed\") {\n    query.submitter = this.userId;\n    query.state = \"completed\";\n  } else if (box === \"monitor\") {\n    query.flow = flowId;\n    query.state = {\n      $in: [\"pending\", \"completed\"]\n    };\n  } else {\n    query.state = \"none\";\n  }\n  return db.instances.find(query, {\n    fields: {\n      name: 1,\n      created: 1,\n      form: 1,\n      flow: 1,\n      space: 1,\n      modified: 1,\n      applicant: 1,\n      is_archived: 1,\n      form_version: 1,\n      flow_version: 1\n    }\n  });\n});\n","lastFinishedApproveAggregate = (instanceid, userId, dataMap, callback)->\r\n\toperation = [{\r\n\t\t\"$match\": {\r\n\t\t\t\"_id\": instanceid\r\n\t\t}\r\n\t}, {\"$project\": {\"name\": 1, \"_approve\": \"$traces.approves\"}}, {\"$unwind\": \"$_approve\"}, {\"$unwind\": \"$_approve\"},\r\n\t\t{\"$match\": {\"_approve.is_finished\": true, $or:[{\"_approve.handler\": userId},{\"_approve.user\": userId}]}},\r\n\t\t{\"$group\": {\"_id\": \"$_id\", \"finish_date\": {\"$last\": \"$_approve.finish_date\"}}}\r\n\t]\r\n\r\n\tdb.instances.rawCollection().aggregate(operation).toArray (err, data)->\r\n\t\tif err\r\n\t\t\tthrow new Error(err)\r\n\r\n\t\tdata.forEach (doc) ->\r\n\t\t\tdataMap.push doc\r\n\r\n\t\tif callback && _.isFunction(callback)\r\n\t\t\tcallback()\r\n\t\treturn\r\n\r\nasyncLastFinishedApprove = Meteor.wrapAsync(lastFinishedApproveAggregate)\r\n\r\nMeteor.publish \"instance_tabular\", (tableName, ids, fields)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tcheck(tableName, String);\r\n\r\n\tcheck(ids, Array);\r\n\r\n\tcheck(fields, Match.Optional(Object))\r\n\r\n\tfields.cc_users = 1\r\n\r\n\tself = this;\r\n\r\n\tgetMyLastFinishedApprove = (userId, instanceId)->\r\n\t\tdata = []\r\n\t\tasyncLastFinishedApprove(instanceId, userId, data)\r\n\t\tif data.length > 0\r\n\t\t\treturn data[0]\r\n\r\n\r\n\tgetMyApprove = (userId, instanceId)->\r\n\t\tinstance = db.instances.findOne({_id: instanceId}, {fields: {traces: 1}})\r\n\t\tmyApprove = null\r\n\r\n\t\tif !instance\r\n\t\t\treturn\r\n\r\n\t\tif !instance.traces || instance.traces.length < 1\r\n\t\t\treturn\r\n\r\n\t\tnotFinishedTraces = instance.traces.filterProperty(\"is_finished\", false)\r\n\r\n\t\tif notFinishedTraces.length > 0\r\n\t\t\tapproves = notFinishedTraces[0].approves.filterProperty(\"is_finished\", false).filterProperty(\"handler\", userId);\r\n\r\n\t\t\tif approves.length > 0\r\n\t\t\t\tapprove = approves[0]\r\n\t\t\t\tmyApprove = {\r\n\t\t\t\t\tid: approve._id,\r\n\t\t\t\t\tinstance: approve.instance,\r\n\t\t\t\t\ttrace: approve.trace,\r\n\t\t\t\t\tis_read: approve.is_read,\r\n\t\t\t\t\tstart_date: approve.start_date\r\n\t\t\t\t\tagent: approve.agent\r\n\t\t\t\t\tuser_name: approve.user_name\r\n\t\t\t\t}\r\n\r\n\t\tif !myApprove\r\n\t\t\tis_read = false\r\n\t\t\tinstance.traces.forEach (trace) ->\r\n\t\t\t\ttrace?.approves?.forEach (approve) ->\r\n\t\t\t\t\tif approve.type == 'cc' and approve.user == userId and approve.is_finished == false\r\n\t\t\t\t\t\tif approve.is_read\r\n\t\t\t\t\t\t\tis_read = true\r\n\t\t\t\t\t\tmyApprove = {id: approve._id, is_read: is_read, start_date: approve.start_date, agent: approve.agent, user_name: approve.user_name}\r\n\r\n\t\treturn myApprove\r\n\r\n\tgetStepCurrentName = (instanceId) ->\r\n\t\tinstance = db.instances.findOne({_id: instanceId}, {fields: {\"traces.name\": 1, \"traces\": {$slice: -1}}})\r\n\t\tif instance\r\n\t\t\tstepCurrentName = instance.traces?[0]?.name\r\n\r\n\t\treturn stepCurrentName\r\n\r\n\thandle = db.instances.find({_id: {$in: ids}}, {fields: {traces: 0}}).observeChanges {\r\n\t\tchanged: (id)->\r\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\r\n\t\t\treturn if not instance\r\n\t\t\tmyApprove = getMyApprove(self.userId, id)\r\n\t\t\tmyLastFinishedApprove = getMyLastFinishedApprove(self.userId, id)\r\n\t\t\tif myApprove\r\n\t\t\t\tinstance.is_read = myApprove.is_read\r\n\t\t\t\tinstance.start_date = myApprove.start_date\r\n\t\t\t\tif myApprove.agent\r\n\t\t\t\t\tinstance.agent_user_name = myApprove.user_name\r\n\t\t\telse\r\n\t\t\t\tinstance.is_read = true\r\n\r\n\t\t\tif myLastFinishedApprove\r\n\t\t\t\tinstance.my_finish_date = myLastFinishedApprove.finish_date\r\n\r\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\r\n\t\t\tinstance.cc_count = instance.cc_users?.length || 0\r\n\t\t\tdelete instance.cc_users\r\n\t\t\ttry\r\n\t\t\t\tself.changed(\"instances\", id, instance);\r\n\t\t\tcatch error\r\n\t\t\t\tconsole.log('instance observeChanges error: ', error.message);\r\n\t\t\t\tconsole.log('self.userId: ', self.userId);\r\n\t\t\t\tconsole.log('tableName: ', tableName);\r\n\t\t\t\tconsole.log('ids: ', JSON.stringify(ids));\r\n\t\t\t\tconsole.log('myApprove: ', JSON.stringify(myApprove));\r\n\t\tremoved: (id)->\r\n\t\t\tself.removed(\"instances\", id);\r\n\t}\r\n\r\n\tids.forEach (id)->\r\n\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\r\n\t\treturn if not instance\r\n\t\tmyApprove = getMyApprove(self.userId, id)\r\n\t\tmyLastFinishedApprove = getMyLastFinishedApprove(self.userId, id)\r\n\t\tif myApprove\r\n\t\t\tinstance.is_read = myApprove.is_read\r\n\t\t\tinstance.start_date = myApprove.start_date\r\n\t\t\tif myApprove.agent\r\n\t\t\t\t\tinstance.agent_user_name = myApprove.user_name\r\n\t\telse\r\n\t\t\tinstance.is_read = true\r\n\r\n\t\tif myLastFinishedApprove\r\n\t\t\tinstance.my_finish_date = myLastFinishedApprove.finish_date\r\n\r\n\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\r\n\t\tinstance.cc_count = instance.cc_users?.length || 0\r\n\t\tdelete instance.cc_users\r\n\t\tself.added(\"instances\", id, instance);\r\n\r\n\tself.ready();\r\n\tself.onStop ()->\r\n\t\thandle.stop()","var asyncLastFinishedApprove, lastFinishedApproveAggregate;\n\nlastFinishedApproveAggregate = function(instanceid, userId, dataMap, callback) {\n  var operation;\n  operation = [\n    {\n      \"$match\": {\n        \"_id\": instanceid\n      }\n    }, {\n      \"$project\": {\n        \"name\": 1,\n        \"_approve\": \"$traces.approves\"\n      }\n    }, {\n      \"$unwind\": \"$_approve\"\n    }, {\n      \"$unwind\": \"$_approve\"\n    }, {\n      \"$match\": {\n        \"_approve.is_finished\": true,\n        $or: [\n          {\n            \"_approve.handler\": userId\n          }, {\n            \"_approve.user\": userId\n          }\n        ]\n      }\n    }, {\n      \"$group\": {\n        \"_id\": \"$_id\",\n        \"finish_date\": {\n          \"$last\": \"$_approve.finish_date\"\n        }\n      }\n    }\n  ];\n  return db.instances.rawCollection().aggregate(operation).toArray(function(err, data) {\n    if (err) {\n      throw new Error(err);\n    }\n    data.forEach(function(doc) {\n      return dataMap.push(doc);\n    });\n    if (callback && _.isFunction(callback)) {\n      callback();\n    }\n  });\n};\n\nasyncLastFinishedApprove = Meteor.wrapAsync(lastFinishedApproveAggregate);\n\nMeteor.publish(\"instance_tabular\", function(tableName, ids, fields) {\n  var getMyApprove, getMyLastFinishedApprove, getStepCurrentName, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  fields.cc_users = 1;\n  self = this;\n  getMyLastFinishedApprove = function(userId, instanceId) {\n    var data;\n    data = [];\n    asyncLastFinishedApprove(instanceId, userId, data);\n    if (data.length > 0) {\n      return data[0];\n    }\n  };\n  getMyApprove = function(userId, instanceId) {\n    var approve, approves, instance, is_read, myApprove, notFinishedTraces;\n    instance = db.instances.findOne({\n      _id: instanceId\n    }, {\n      fields: {\n        traces: 1\n      }\n    });\n    myApprove = null;\n    if (!instance) {\n      return;\n    }\n    if (!instance.traces || instance.traces.length < 1) {\n      return;\n    }\n    notFinishedTraces = instance.traces.filterProperty(\"is_finished\", false);\n    if (notFinishedTraces.length > 0) {\n      approves = notFinishedTraces[0].approves.filterProperty(\"is_finished\", false).filterProperty(\"handler\", userId);\n      if (approves.length > 0) {\n        approve = approves[0];\n        myApprove = {\n          id: approve._id,\n          instance: approve.instance,\n          trace: approve.trace,\n          is_read: approve.is_read,\n          start_date: approve.start_date,\n          agent: approve.agent,\n          user_name: approve.user_name\n        };\n      }\n    }\n    if (!myApprove) {\n      is_read = false;\n      instance.traces.forEach(function(trace) {\n        var ref;\n        return trace != null ? (ref = trace.approves) != null ? ref.forEach(function(approve) {\n          if (approve.type === 'cc' && approve.user === userId && approve.is_finished === false) {\n            if (approve.is_read) {\n              is_read = true;\n            }\n            return myApprove = {\n              id: approve._id,\n              is_read: is_read,\n              start_date: approve.start_date,\n              agent: approve.agent,\n              user_name: approve.user_name\n            };\n          }\n        }) : void 0 : void 0;\n      });\n    }\n    return myApprove;\n  };\n  getStepCurrentName = function(instanceId) {\n    var instance, ref, ref1, stepCurrentName;\n    instance = db.instances.findOne({\n      _id: instanceId\n    }, {\n      fields: {\n        \"traces.name\": 1,\n        \"traces\": {\n          $slice: -1\n        }\n      }\n    });\n    if (instance) {\n      stepCurrentName = (ref = instance.traces) != null ? (ref1 = ref[0]) != null ? ref1.name : void 0 : void 0;\n    }\n    return stepCurrentName;\n  };\n  handle = db.instances.find({\n    _id: {\n      $in: ids\n    }\n  }, {\n    fields: {\n      traces: 0\n    }\n  }).observeChanges({\n    changed: function(id) {\n      var error, instance, myApprove, myLastFinishedApprove, ref, ref1;\n      instance = db.instances.findOne({\n        _id: id\n      }, {\n        fields: fields\n      });\n      if (!instance) {\n        return;\n      }\n      myApprove = getMyApprove(self.userId, id);\n      myLastFinishedApprove = getMyLastFinishedApprove(self.userId, id);\n      if (myApprove) {\n        instance.is_read = myApprove.is_read;\n        instance.start_date = myApprove.start_date;\n        if (myApprove.agent) {\n          instance.agent_user_name = myApprove.user_name;\n        }\n      } else {\n        instance.is_read = true;\n      }\n      if (myLastFinishedApprove) {\n        instance.my_finish_date = myLastFinishedApprove.finish_date;\n      }\n      instance.is_cc = ((ref = instance.cc_users) != null ? ref.includes(self.userId) : void 0) || false;\n      instance.cc_count = ((ref1 = instance.cc_users) != null ? ref1.length : void 0) || 0;\n      delete instance.cc_users;\n      try {\n        return self.changed(\"instances\", id, instance);\n      } catch (error1) {\n        error = error1;\n        console.log('instance observeChanges error: ', error.message);\n        console.log('self.userId: ', self.userId);\n        console.log('tableName: ', tableName);\n        console.log('ids: ', JSON.stringify(ids));\n        return console.log('myApprove: ', JSON.stringify(myApprove));\n      }\n    },\n    removed: function(id) {\n      return self.removed(\"instances\", id);\n    }\n  });\n  ids.forEach(function(id) {\n    var instance, myApprove, myLastFinishedApprove, ref, ref1;\n    instance = db.instances.findOne({\n      _id: id\n    }, {\n      fields: fields\n    });\n    if (!instance) {\n      return;\n    }\n    myApprove = getMyApprove(self.userId, id);\n    myLastFinishedApprove = getMyLastFinishedApprove(self.userId, id);\n    if (myApprove) {\n      instance.is_read = myApprove.is_read;\n      instance.start_date = myApprove.start_date;\n      if (myApprove.agent) {\n        instance.agent_user_name = myApprove.user_name;\n      }\n    } else {\n      instance.is_read = true;\n    }\n    if (myLastFinishedApprove) {\n      instance.my_finish_date = myLastFinishedApprove.finish_date;\n    }\n    instance.is_cc = ((ref = instance.cc_users) != null ? ref.includes(self.userId) : void 0) || false;\n    instance.cc_count = ((ref1 = instance.cc_users) != null ? ref1.length : void 0) || 0;\n    delete instance.cc_users;\n    return self.added(\"instances\", id, instance);\n  });\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","Meteor.publish 'instances_draft', (spaceId) ->\r\n\tcheck spaceId, String\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tuserId = this.userId\r\n\treturn db.instances.find({state:\"draft\",space:spaceId,submitter:userId,$or:[{inbox_users: {$exists:false}}, {inbox_users: []}]}, {fields: {_id: 1, state: 1, space: 1, submitter: 1, inbox_users: 1, modified: 1, name: 1}, sort:{modified: -1}})","Meteor.publish('instances_draft', function(spaceId) {\n  var userId;\n  check(spaceId, String);\n  if (!this.userId) {\n    return this.ready();\n  }\n  userId = this.userId;\n  return db.instances.find({\n    state: \"draft\",\n    space: spaceId,\n    submitter: userId,\n    $or: [\n      {\n        inbox_users: {\n          $exists: false\n        }\n      }, {\n        inbox_users: []\n      }\n    ]\n  }, {\n    fields: {\n      _id: 1,\n      state: 1,\n      space: 1,\n      submitter: 1,\n      inbox_users: 1,\n      modified: 1,\n      name: 1\n    },\n    sort: {\n      modified: -1\n    }\n  });\n});\n","Meteor.publish 'distributed_instances_state_by_ids', (instance_ids)->\r\n\tcheck(instance_ids, Array)\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\t\r\n\tunless instance_ids\r\n\t\treturn this.ready()\r\n\r\n\tif _.isEmpty(instance_ids)\r\n\t\treturn this.ready()\r\n\r\n\tself = this\r\n\r\n\thandle = db.instances.find({_id: {$in: instance_ids}}, {fields: {state: 1, traces:{$slice: 1} } }).observeChanges {\r\n\t\tadded: (id, fields)->\r\n\t\t\tself.added('instances', id, {state: fields.state, is_read: fields.traces[0].approves[0].is_read})\r\n\r\n\t\tchanged: (id, fields)->\r\n\t\t\tif fields.state\r\n\t\t\t\tself.changed('instances', id, {state: fields.state})\r\n\t\t\tif fields.traces\r\n\t\t\t\tself.changed('instances', id, {is_read: fields.traces[0].approves[0].is_read})\r\n\t}\r\n\r\n\tthis.ready()\r\n\tthis.onStop ()->\r\n\t\thandle.stop()\r\n","Meteor.publish('distributed_instances_state_by_ids', function(instance_ids) {\n  var handle, self;\n  check(instance_ids, Array);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instance_ids) {\n    return this.ready();\n  }\n  if (_.isEmpty(instance_ids)) {\n    return this.ready();\n  }\n  self = this;\n  handle = db.instances.find({\n    _id: {\n      $in: instance_ids\n    }\n  }, {\n    fields: {\n      state: 1,\n      traces: {\n        $slice: 1\n      }\n    }\n  }).observeChanges({\n    added: function(id, fields) {\n      return self.added('instances', id, {\n        state: fields.state,\n        is_read: fields.traces[0].approves[0].is_read\n      });\n    },\n    changed: function(id, fields) {\n      if (fields.state) {\n        self.changed('instances', id, {\n          state: fields.state\n        });\n      }\n      if (fields.traces) {\n        return self.changed('instances', id, {\n          is_read: fields.traces[0].approves[0].is_read\n        });\n      }\n    }\n  });\n  this.ready();\n  return this.onStop(function() {\n    return handle.stop();\n  });\n});\n","Meteor.publish 'related_instaces', (instanceId, related_instances)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless instanceId\r\n\t\treturn this.ready()\r\n\r\n\trelated_instance_ids = db.instances.findOne(instanceId,{fields: {related_instances: 1}})?.related_instances\r\n\r\n\tif related_instance_ids && _.isArray(related_instance_ids)\r\n\t\treturn db.instances.find({_id: {$in : related_instance_ids}}, {fields: {_id: 1, name: 1, space: 1}})\r\n\telse\r\n\t\treturn this.ready()","Meteor.publish('related_instaces', function(instanceId, related_instances) {\n  var ref, related_instance_ids;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceId) {\n    return this.ready();\n  }\n  related_instance_ids = (ref = db.instances.findOne(instanceId, {\n    fields: {\n      related_instances: 1\n    }\n  })) != null ? ref.related_instances : void 0;\n  if (related_instance_ids && _.isArray(related_instance_ids)) {\n    return db.instances.find({\n      _id: {\n        $in: related_instance_ids\n      }\n    }, {\n      fields: {\n        _id: 1,\n        name: 1,\n        space: 1\n      }\n    });\n  } else {\n    return this.ready();\n  }\n});\n","if Meteor.isServer\r\n    Meteor.publish 'space_user_signs', (spaceId) ->\r\n        check spaceId, String\r\n\r\n        unless this.userId\r\n            return this.ready()\r\n\r\n        return db.space_user_signs.find({ space: spaceId }, {fields: {created_by: 0, created: 0, modified_by: 0}})\r\n","if (Meteor.isServer) {\n  Meteor.publish('space_user_signs', function(spaceId) {\n    check(spaceId, String);\n    if (!this.userId) {\n      return this.ready();\n    }\n    return db.space_user_signs.find({\n      space: spaceId\n    }, {\n      fields: {\n        created_by: 0,\n        created: 0,\n        modified_by: 0\n      }\n    });\n  });\n}\n","###\r\nMeteor.publishComposite \"user_inbox_instance\", ()->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tuserSpaceIds = db.space_users.find({\r\n\t\tuser: this.userId,\r\n\t\tuser_accepted: true\r\n\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\r\n\tquery = {space: {$in: userSpaceIds}}\r\n\r\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\r\n\r\n\tfind: ->\r\n\t\tdb.instances.find(query, {\r\n\t\t\tfields: {\r\n\t\t\t\tspace: 1,\r\n\t\t\t\tapplicant_name: 1,\r\n\t\t\t\tflow: 1,\r\n\t\t\t\tinbox_users: 1,\r\n\t\t\t\tcc_users: 1,\r\n\t\t\t\tstate: 1,\r\n\t\t\t\tname: 1,\r\n\t\t\t\tmodified: 1,\r\n\t\t\t\tform: 1\r\n\t\t\t}, sort: {modified: -1}, skip: 0, limit: 200\r\n\t\t});\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tfind: (instance, post)->\r\n\t\t\t\tdb.flows.find({_id: instance.flow}, {fields: {name: 1, space: 1}});\r\n\t\t}\r\n\t]\r\n###\r\n\r\n###\r\nMeteor.publish 'my_inbox_instances', (spaceId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tself = this;\r\n\r\n\t#\tuserSpaceIds = db.space_users.find({\r\n\t#\t\tuser: this.userId,\r\n\t#\t\tuser_accepted: true\r\n\t#\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\r\n\r\n\tquery = {space: spaceId}\r\n\r\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\r\n\r\n\tfields = {\r\n\t\tspace: 1,\r\n#\t\tapplicant_name: 1,\r\n\t\tflow: 1,\r\n\t\tinbox_users: 1,\r\n\t\tcc_users: 1,\r\n\t\tstate: 1,\r\n#\t\tname: 1,\r\n#\t\tmodified: 1,\r\n\t\tform: 1\r\n\t}\r\n\r\n\thandle = db.instances.find(query, {sort: {modified: -1}, skip: 0, limit: 500}).observeChanges {\r\n\t\tadded: (id)->\r\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\r\n\t\t\treturn if not instance\r\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\r\n\t\t\tdelete instance.cc_users\r\n\t\t\tself.added(\"instances\", id, instance)\r\n\t\tchanged: (id)->\r\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\r\n\t\t\treturn if not instance\r\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\r\n\t\t\tdelete instance.cc_users\r\n\t\t\tself.changed(\"instances\", id, instance);\r\n\t\tremoved: (id)->\r\n\t\t\tself.removed(\"instances\", id);\r\n\t}\r\n\r\n\tself.ready();\r\n\tself.onStop ()->\r\n\t\thandle.stop()\r\n###\r\n\r\n_get_flow_instances_aggregate = (spaceId, userId, _items, callback)->\r\n\tdb.instances.rawCollection().aggregate([\r\n\t\t{\r\n\t\t\t$match: {\r\n\t\t\t\tspace: spaceId,\r\n\t\t\t\t$or: [{inbox_users: userId}, {cc_users: userId}]\r\n\t\t\t}\r\n\t\t},\r\n\t\t{\r\n\t\t\t$group: {\r\n\t\t\t\t_id: {flow: \"$flow\", category: \"$category\"}, count: {$sum: 1}\r\n\t\t\t}\r\n\t\t}\r\n\t]).toArray (err, data)->\r\n\t\tif err\r\n\t\t\tthrow new Error(err)\r\n\r\n\t\tdata.forEach (doc) ->\r\n\t\t\t_items.push doc\r\n\r\n\t\tif callback && _.isFunction(callback)\r\n\t\t\tcallback()\r\n\t\treturn\r\n\r\n_async_get_flow_instances_aggregate = Meteor.wrapAsync(_get_flow_instances_aggregate)\r\n\r\nMeteor.publish 'my_inbox_flow_instances_count', (spaceId)->\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tself = this;\r\n\r\n\tquery = {space: spaceId}\r\n\r\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\r\n\r\n\tdata = []  #æ•°æ®æ ¼å¼ï¼š[{_id:flowId, count: å¾…åŠžæ•°é‡}, {_id:flowId2, count: å¾…åŠžæ•°é‡2}]\r\n\t_async_get_flow_instances_aggregate(spaceId, self.userId, data)\r\n\r\n\t_flowsData = []\r\n\r\n\t_.each data, (dataItem)->\r\n\t\t_flowsData.push({_id: dataItem._id.flow, category: dataItem._id.category, count: dataItem.count})\r\n\r\n\tself.added(\"flow_instances\", spaceId, {flows: _flowsData});\r\n\r\n\t_changeData = (doc, action)->\r\n\t\tflow_instance = _.find _flowsData, (f)->\r\n\t\t\treturn f._id == doc.flow\r\n\t\tif flow_instance\r\n\t\t\tif action == \"added\"\r\n\t\t\t\tflow_instance.count++\r\n\t\t\telse if action == \"removed\"\r\n\t\t\t\tflow_instance.count--\r\n\t\telse if action == \"added\"\r\n\t\t\t_flowsData.push {_id: doc.flow, category: doc.category, count: 1}\r\n\r\n\t\tself.changed(\"flow_instances\", spaceId, {flows: _flowsData});\r\n\r\n\t_init = true\r\n\thandle = db.instances.find(query, {fields: {_id: 1, inbox_users: 1, cc_users: 1, flow: 1, category: 1}}).observe {\r\n\t\tadded: (doc)->\r\n\t\t\tif !_init\r\n\t\t\t\t_changeData(doc, \"added\")\r\n\t\tremoved: (doc)->\r\n\t\t\tif !_init\r\n\t\t\t\t_changeData(doc, \"removed\")\r\n\t}\r\n\t_init = false\r\n\r\n\tself.ready();\r\n\tself.onStop ()->\r\n\t\thandle.stop()","\n/*\nMeteor.publishComposite \"user_inbox_instance\", ()->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tuserSpaceIds = db.space_users.find({\n\t\tuser: this.userId,\n\t\tuser_accepted: true\n\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\n\tquery = {space: {$in: userSpaceIds}}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tfind: ->\n\t\tdb.instances.find(query, {\n\t\t\tfields: {\n\t\t\t\tspace: 1,\n\t\t\t\tapplicant_name: 1,\n\t\t\t\tflow: 1,\n\t\t\t\tinbox_users: 1,\n\t\t\t\tcc_users: 1,\n\t\t\t\tstate: 1,\n\t\t\t\tname: 1,\n\t\t\t\tmodified: 1,\n\t\t\t\tform: 1\n\t\t\t}, sort: {modified: -1}, skip: 0, limit: 200\n\t\t});\n\tchildren: [\n\t\t{\n\t\t\tfind: (instance, post)->\n\t\t\t\tdb.flows.find({_id: instance.flow}, {fields: {name: 1, space: 1}});\n\t\t}\n\t]\n */\n\n/*\nMeteor.publish 'my_inbox_instances', (spaceId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tself = this;\n\n\t *\tuserSpaceIds = db.space_users.find({\n\t *\t\tuser: this.userId,\n\t *\t\tuser_accepted: true\n\t *\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\n\n\tquery = {space: spaceId}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tfields = {\n\t\tspace: 1,\n *\t\tapplicant_name: 1,\n\t\tflow: 1,\n\t\tinbox_users: 1,\n\t\tcc_users: 1,\n\t\tstate: 1,\n *\t\tname: 1,\n *\t\tmodified: 1,\n\t\tform: 1\n\t}\n\n\thandle = db.instances.find(query, {sort: {modified: -1}, skip: 0, limit: 500}).observeChanges {\n\t\tadded: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tdelete instance.cc_users\n\t\t\tself.added(\"instances\", id, instance)\n\t\tchanged: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tdelete instance.cc_users\n\t\t\tself.changed(\"instances\", id, instance);\n\t\tremoved: (id)->\n\t\t\tself.removed(\"instances\", id);\n\t}\n\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()\n */\nvar _async_get_flow_instances_aggregate, _get_flow_instances_aggregate;\n\n_get_flow_instances_aggregate = function(spaceId, userId, _items, callback) {\n  return db.instances.rawCollection().aggregate([\n    {\n      $match: {\n        space: spaceId,\n        $or: [\n          {\n            inbox_users: userId\n          }, {\n            cc_users: userId\n          }\n        ]\n      }\n    }, {\n      $group: {\n        _id: {\n          flow: \"$flow\",\n          category: \"$category\"\n        },\n        count: {\n          $sum: 1\n        }\n      }\n    }\n  ]).toArray(function(err, data) {\n    if (err) {\n      throw new Error(err);\n    }\n    data.forEach(function(doc) {\n      return _items.push(doc);\n    });\n    if (callback && _.isFunction(callback)) {\n      callback();\n    }\n  });\n};\n\n_async_get_flow_instances_aggregate = Meteor.wrapAsync(_get_flow_instances_aggregate);\n\nMeteor.publish('my_inbox_flow_instances_count', function(spaceId) {\n  var _changeData, _flowsData, _init, data, handle, query, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  self = this;\n  query = {\n    space: spaceId\n  };\n  query.$or = [\n    {\n      inbox_users: this.userId\n    }, {\n      cc_users: this.userId\n    }\n  ];\n  data = [];\n  _async_get_flow_instances_aggregate(spaceId, self.userId, data);\n  _flowsData = [];\n  _.each(data, function(dataItem) {\n    return _flowsData.push({\n      _id: dataItem._id.flow,\n      category: dataItem._id.category,\n      count: dataItem.count\n    });\n  });\n  self.added(\"flow_instances\", spaceId, {\n    flows: _flowsData\n  });\n  _changeData = function(doc, action) {\n    var flow_instance;\n    flow_instance = _.find(_flowsData, function(f) {\n      return f._id === doc.flow;\n    });\n    if (flow_instance) {\n      if (action === \"added\") {\n        flow_instance.count++;\n      } else if (action === \"removed\") {\n        flow_instance.count--;\n      }\n    } else if (action === \"added\") {\n      _flowsData.push({\n        _id: doc.flow,\n        category: doc.category,\n        count: 1\n      });\n    }\n    return self.changed(\"flow_instances\", spaceId, {\n      flows: _flowsData\n    });\n  };\n  _init = true;\n  handle = db.instances.find(query, {\n    fields: {\n      _id: 1,\n      inbox_users: 1,\n      cc_users: 1,\n      flow: 1,\n      category: 1\n    }\n  }).observe({\n    added: function(doc) {\n      if (!_init) {\n        return _changeData(doc, \"added\");\n      }\n    },\n    removed: function(doc) {\n      if (!_init) {\n        return _changeData(doc, \"removed\");\n      }\n    }\n  });\n  _init = false;\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","\r\nMeteor.publish 'flow_main_attach_template', (spaceId, flowId)->\r\n\tcheck(spaceId, String)\r\n\tcheck(flowId, String)\r\n\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless spaceId && flowId\r\n\t\treturn this.ready()\r\n\r\n\treturn Creator.getCollection('cms_files').find({ space: spaceId, 'parent.o': 'flows', 'parent.ids': flowId,  name: 'æ­£æ–‡.docx' })\r\n","Meteor.publish('flow_main_attach_template', function(spaceId, flowId) {\n  check(spaceId, String);\n  check(flowId, String);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!(spaceId && flowId)) {\n    return this.ready();\n  }\n  return Creator.getCollection('cms_files').find({\n    space: spaceId,\n    'parent.o': 'flows',\n    'parent.ids': flowId,\n    name: 'æ­£æ–‡.docx'\n  });\n});\n","workflowTemplate = {}\r\n\r\n#å¯ç”¨æ­¤è„šæœ¬ä»Žæ¨¡æ¿å·¥ä½œåŒºåšæ‰¹é‡å¯¼å‡ºï¼š\r\n#ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•åŽï¼Œè¿›å…¥FlowModulesï¼Œåœ¨æŽ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹è„šæœ¬å³å¯\r\n#db.forms.find({state:\"enabled\"}).forEach(function(form){window.open(Meteor.absoluteUrl(\"api/workflow/export/form?form=\"+form._id))})\r\nworkflowTemplate[\"en\"] =[]\r\n\r\n#å¯ç”¨æ­¤è„šæœ¬ä»Žæ¨¡æ¿å·¥ä½œåŒºåšæ‰¹é‡å¯¼å‡ºï¼š\r\n#ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•åŽï¼Œè¿›å…¥æ¨¡æ¿ä¸“åŒºï¼Œåœ¨æŽ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹è„šæœ¬å³å¯\r\n#db.forms.find({state:\"enabled\"}).forEach(function(form){window.open(Meteor.absoluteUrl(\"api/workflow/export/form?form=\"+form._id))})\r\nworkflowTemplate[\"zh-CN\"] =[]\r\n\r\nMeteor.startup ()->\r\n\tfs = require('fs')\r\n\tpath = require('path')\r\n\tmime = require('mime')\r\n\treadFileList = (pathDir, filesList)->\r\n\t\tfiles = fs.readdirSync(pathDir)\r\n\t\tfiles.forEach (name, index)->\r\n\t\t\tstat = fs.statSync(path.join(pathDir, name))\r\n\t\t\tif stat.isDirectory()\r\n\t\t\t\t# é€’å½’è¯»å–æ–‡ä»¶\r\n\t\t\t\treadFileList(path.join(pathDir, name), filesList)\r\n\t\t\telse\r\n\t\t\t\tobj = {}\r\n\t\t\t\tobj.path = pathDir\r\n\t\t\t\tobj.name = name\r\n\t\t\t\tfilesList.push(obj)\r\n\r\n\t#èŽ·å–zh-cnæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\r\n\tfilesList_cn = []\r\n\tpath_cn = Meteor.settings.workflowTemplates?.path_cn\r\n\tif path_cn\r\n\t\tabsolute_path_cn = path.resolve(path_cn)\r\n\t\tconsole.log \"absolute_path_cn\", absolute_path_cn\r\n\t\tif fs.existsSync(absolute_path_cn)\r\n\t\t\treadFileList(absolute_path_cn, filesList_cn)\r\n\t\t\tfilesList_cn.forEach (file)->\r\n\t\t\t\ttry\r\n\t\t\t\t\tif mime.getType(file.name) is \"application/json\"\r\n\t\t\t\t\t\tdata = fs.readFileSync(path.join(file.path, file.name), 'utf8')\r\n\t\t\t\t\t\tworkflowTemplate[\"zh-CN\"].push(JSON.parse(data))\r\n\t\t\t\tcatch e\r\n\t\t\t\t\tconsole.error \"èŽ·å–zh-cnæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\", path.join(file.path, file.name)\r\n\t\t\t\t\tconsole.error e.stack\r\n\r\n\t#èŽ·å–en-usæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\r\n\tfilesList_us = []\r\n\tpath_us = Meteor.settings.workflowTemplates?.path_us\r\n\tif path_us\r\n\t\tabsolute_path_us = path.resolve(path_us)\r\n\t\tconsole.log \"absolute_path_us\", absolute_path_us\r\n\t\tif fs.existsSync(absolute_path_us)\r\n\t\t\treadFileList(absolute_path_us, filesList_us)\r\n\t\t\tfilesList_us.forEach (file)->\r\n\t\t\t\ttry\r\n\t\t\t\t\tif mime.getType(file.name) is \"application/json\"\r\n\t\t\t\t\t\tdata = fs.readFileSync(path.join(file.path, file.name), 'utf8')\r\n\t\t\t\t\t\tworkflowTemplate[\"en\"].push(JSON.parse(data))\r\n\t\t\t\tcatch e\r\n\t\t\t\t\tconsole.error \"èŽ·å–en-usæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\", path.join(file.path, file.name)\r\n\t\t\t\t\tconsole.error e.stack\r\n\t\t\t\t\r\n\t\t\t\t\t\r\n\r\n\r\n","                     \n\nworkflowTemplate = {};\n\nworkflowTemplate[\"en\"] = [];\n\nworkflowTemplate[\"zh-CN\"] = [];\n\nMeteor.startup(function() {\n  var absolute_path_cn, absolute_path_us, filesList_cn, filesList_us, fs, mime, path, path_cn, path_us, readFileList, ref, ref1;\n  fs = require('fs');\n  path = require('path');\n  mime = require('mime');\n  readFileList = function(pathDir, filesList) {\n    var files;\n    files = fs.readdirSync(pathDir);\n    return files.forEach(function(name, index) {\n      var obj, stat;\n      stat = fs.statSync(path.join(pathDir, name));\n      if (stat.isDirectory()) {\n        return readFileList(path.join(pathDir, name), filesList);\n      } else {\n        obj = {};\n        obj.path = pathDir;\n        obj.name = name;\n        return filesList.push(obj);\n      }\n    });\n  };\n  filesList_cn = [];\n  path_cn = (ref = Meteor.settings.workflowTemplates) != null ? ref.path_cn : void 0;\n  if (path_cn) {\n    absolute_path_cn = path.resolve(path_cn);\n    console.log(\"absolute_path_cn\", absolute_path_cn);\n    if (fs.existsSync(absolute_path_cn)) {\n      readFileList(absolute_path_cn, filesList_cn);\n      filesList_cn.forEach(function(file) {\n        var data, e;\n        try {\n          if (mime.getType(file.name) === \"application/json\") {\n            data = fs.readFileSync(path.join(file.path, file.name), 'utf8');\n            return workflowTemplate[\"zh-CN\"].push(JSON.parse(data));\n          }\n        } catch (error) {\n          e = error;\n          console.error(\"èŽ·å–zh-cnæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\", path.join(file.path, file.name));\n          return console.error(e.stack);\n        }\n      });\n    }\n  }\n  filesList_us = [];\n  path_us = (ref1 = Meteor.settings.workflowTemplates) != null ? ref1.path_us : void 0;\n  if (path_us) {\n    absolute_path_us = path.resolve(path_us);\n    console.log(\"absolute_path_us\", absolute_path_us);\n    if (fs.existsSync(absolute_path_us)) {\n      readFileList(absolute_path_us, filesList_us);\n      return filesList_us.forEach(function(file) {\n        var data, e;\n        try {\n          if (mime.getType(file.name) === \"application/json\") {\n            data = fs.readFileSync(path.join(file.path, file.name), 'utf8');\n            return workflowTemplate[\"en\"].push(JSON.parse(data));\n          }\n        } catch (error) {\n          e = error;\n          console.error(\"èŽ·å–en-usæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶\", path.join(file.path, file.name));\n          return console.error(e.stack);\n        }\n      });\n    }\n  }\n});\n","###\r\n*    *    *    *    *    *\r\nâ”¬    â”¬    â”¬    â”¬    â”¬    â”¬\r\nâ”‚    â”‚    â”‚    â”‚    â”‚    |\r\nâ”‚    â”‚    â”‚    â”‚    â”‚    â”” day of week (0 - 7) (0 or 7 is Sun)\r\nâ”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€ month (1 - 12)\r\nâ”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)\r\nâ”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)\r\nâ”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ second (0 - 59, OPTIONAL)\r\n###\r\nMeteor.startup ->\r\n\tif Meteor.settings.cron?.auto_finish_process_delegation\r\n\t\tschedule = require('node-schedule')\r\n\t\t# å®šæ—¶æ‰§è¡ŒåŒæ­¥\r\n\t\trule = Meteor.settings.cron.auto_finish_process_delegation\r\n\t\tgo_next = true\r\n\t\tschedule.scheduleJob rule, Meteor.bindEnvironment ()->\r\n\t\t\ttry\r\n\t\t\t\tif !go_next\r\n\t\t\t\t\treturn\r\n\t\t\t\tgo_next = false\r\n\t\t\t\tconsole.time 'auto_finish_process_delegation'\r\n\r\n\t\t\t\tnow = new Date\r\n\r\n\t\t\t\t# å°†å§”æ‰˜è§„åˆ™è®¾ç½®ä¸ºä¸å¯ç”¨\r\n\t\t\t\tdb.process_delegation_rules.update({ enabled: true, end_time: { $lte: now } }, { $set: { enabled: false } }, { multi :true })\r\n\r\n\t\t\t\tconsole.timeEnd 'auto_finish_process_delegation'\r\n\t\t\t\tgo_next = true\r\n\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.error \"AUTO AUTO_FINISH_PROCESS_DELEGATION ERROR: \"\r\n\t\t\t\tconsole.error e.stack\r\n\t\t\t\tgo_next = true\r\n\r\n\t\t, (e)->\r\n\t\t\tconsole.log 'Failed to bind environment: auto_finish_process_delegation.coffee'\r\n\t\t\tconsole.log e.stack\r\n","\n/*\n*    *    *    *    *    *\nâ”¬    â”¬    â”¬    â”¬    â”¬    â”¬\nâ”‚    â”‚    â”‚    â”‚    â”‚    |\nâ”‚    â”‚    â”‚    â”‚    â”‚    â”” day of week (0 - 7) (0 or 7 is Sun)\nâ”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€ month (1 - 12)\nâ”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)\nâ”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)\nâ”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ second (0 - 59, OPTIONAL)\n */\nMeteor.startup(function() {\n  var go_next, ref, rule, schedule;\n  if ((ref = Meteor.settings.cron) != null ? ref.auto_finish_process_delegation : void 0) {\n    schedule = require('node-schedule');\n    rule = Meteor.settings.cron.auto_finish_process_delegation;\n    go_next = true;\n    return schedule.scheduleJob(rule, Meteor.bindEnvironment(function() {\n      var e, now;\n      try {\n        if (!go_next) {\n          return;\n        }\n        go_next = false;\n        console.time('auto_finish_process_delegation');\n        now = new Date;\n        db.process_delegation_rules.update({\n          enabled: true,\n          end_time: {\n            $lte: now\n          }\n        }, {\n          $set: {\n            enabled: false\n          }\n        }, {\n          multi: true\n        });\n        console.timeEnd('auto_finish_process_delegation');\n        return go_next = true;\n      } catch (error) {\n        e = error;\n        console.error(\"AUTO AUTO_FINISH_PROCESS_DELEGATION ERROR: \");\n        console.error(e.stack);\n        return go_next = true;\n      }\n    }, function(e) {\n      console.log('Failed to bind environment: auto_finish_process_delegation.coffee');\n      return console.log(e.stack);\n    }));\n  }\n});\n","###\r\n*    *    *    *    *    *\r\nâ”¬    â”¬    â”¬    â”¬    â”¬    â”¬\r\nâ”‚    â”‚    â”‚    â”‚    â”‚    |\r\nâ”‚    â”‚    â”‚    â”‚    â”‚    â”” day of week (0 - 7) (0 or 7 is Sun)\r\nâ”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€ month (1 - 12)\r\nâ”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)\r\nâ”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)\r\nâ”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ second (0 - 59, OPTIONAL)\r\n###\r\nMeteor.startup ->\r\n\tif Meteor.settings.cron?.timeout_auto_submit\r\n\t\tschedule = require('node-schedule')\r\n\t\t# å®šæ—¶æ‰§è¡ŒåŒæ­¥\r\n\t\trule = Meteor.settings.cron.timeout_auto_submit\r\n\t\tgo_next = true\r\n\t\tschedule.scheduleJob rule, Meteor.bindEnvironment ()->\r\n\t\t\ttry\r\n\t\t\t\tif !go_next\r\n\t\t\t\t\treturn\r\n\t\t\t\tgo_next = false\r\n\t\t\t\tconsole.time 'timeout_auto_submit'\r\n\r\n\t\t\t\tuuflowManager.timeoutAutoSubmit()\r\n\r\n\t\t\t\tconsole.timeEnd 'timeout_auto_submit'\r\n\t\t\t\tgo_next = true\r\n\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.error \"AUTO TIMEOUT_AUTO_SUBMIT ERROR: \"\r\n\t\t\t\tconsole.error e.stack\r\n\t\t\t\tgo_next = true\r\n\r\n\t\t, (e)->\r\n\t\t\tconsole.log 'Failed to bind environment: timeout_auto_submit.coffee'\r\n\t\t\tconsole.log e.stack\r\n\r\nMeteor.methods\r\n\ttimeout_auto_submit: (ins_id)->\r\n\t\tuuflowManager.timeoutAutoSubmit(ins_id)\r\n\t\treturn true\r\n\r\n\r\n","\n/*\n*    *    *    *    *    *\nâ”¬    â”¬    â”¬    â”¬    â”¬    â”¬\nâ”‚    â”‚    â”‚    â”‚    â”‚    |\nâ”‚    â”‚    â”‚    â”‚    â”‚    â”” day of week (0 - 7) (0 or 7 is Sun)\nâ”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€ month (1 - 12)\nâ”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)\nâ”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)\nâ”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ second (0 - 59, OPTIONAL)\n */\nMeteor.startup(function() {\n  var go_next, ref, rule, schedule;\n  if ((ref = Meteor.settings.cron) != null ? ref.timeout_auto_submit : void 0) {\n    schedule = require('node-schedule');\n    rule = Meteor.settings.cron.timeout_auto_submit;\n    go_next = true;\n    return schedule.scheduleJob(rule, Meteor.bindEnvironment(function() {\n      var e;\n      try {\n        if (!go_next) {\n          return;\n        }\n        go_next = false;\n        console.time('timeout_auto_submit');\n        uuflowManager.timeoutAutoSubmit();\n        console.timeEnd('timeout_auto_submit');\n        return go_next = true;\n      } catch (error) {\n        e = error;\n        console.error(\"AUTO TIMEOUT_AUTO_SUBMIT ERROR: \");\n        console.error(e.stack);\n        return go_next = true;\n      }\n    }, function(e) {\n      console.log('Failed to bind environment: timeout_auto_submit.coffee');\n      return console.log(e.stack);\n    }));\n  }\n});\n\nMeteor.methods({\n  timeout_auto_submit: function(ins_id) {\n    uuflowManager.timeoutAutoSubmit(ins_id);\n    return true;\n  }\n});\n","Meteor.startup ()->\r\n\tTabularTables.related_instances_tabular = new Tabular.Table\r\n\t\tname: \"related_instances_tabular\"\r\n\t\tcollection: db.instances\r\n\t\tcolumns: [\r\n\t\t\t{\r\n\t\t\t\tdata: \"_id\",\r\n\t\t\t\ttitle: '<input type=\"checkbox\" name=\"reverse\" id=\"reverse\">',\r\n\t\t\t\torderable: false,\r\n\t\t\t\twidth: '1px',\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tinput = '<input type=\"checkbox\" class=\"related-instances-list-checkbox\" name=\"related_instances_ids\" id=\"related_instances_ids\" value=\"' + doc._id + '\"'\r\n\r\n\t\t\t\t\tif TabularTables.related_instances_tabular.related_instances?.includes(doc._id)\r\n\t\t\t\t\t\tinput += \" checked \"\r\n\r\n\t\t\t\t\tinput += \">\"\r\n\t\t\t\t\treturn input\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"name\",\r\n\t\t\t\torderable: false,\r\n\t\t\t\twidth: '45%',\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\thref = '';\r\n\t\t\t\t\tif Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())\r\n\t\t\t\t\t\thref = ''\r\n\r\n\t\t\t\t\tabsolute = false\r\n\r\n\t\t\t\t\tif Meteor.isServer\r\n\t\t\t\t\t\tabsolute = this.absolute\r\n\t\t\t\t\tif absolute\r\n\t\t\t\t\t\thref = Meteor.absoluteUrl(\"workflow/space/\"+doc.space+\"/view/readonly/\" + doc._id + '?hide_traces=0')\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\thref = Steedos.absoluteUrl(\"workflow/space/\"+doc.space+\"/view/readonly/\" + doc._id + '?hide_traces=0')\r\n\t\t\t\t\treturn \"<a data-id='#{doc._id}' target='_blank' href='\"+href+\"'>\" + doc.name + \"</a>\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"applicant_name\",\r\n\t\t\t\ttitle: t(\"instances_applicant_name\"),\r\n\t\t\t\torderable: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"flow_name\",\r\n\t\t\t\ttitle: t(\"instances_flow\"),\r\n\t\t\t\torderable: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"current_step_name\",\r\n\t\t\t\ttitle: t(\"instances_flow\"),\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tif doc.state == \"completed\"\r\n\t\t\t\t\t\tjudge = doc.final_decision || \"approved\"\r\n\r\n\t\t\t\t\tstep_current_name = doc.current_step_name || ''\r\n\r\n\t\t\t\t\treturn \"\"\"\r\n\t\t\t\t\t\t\t<div class=\"step-current-state #{judge}\">#{step_current_name}</div>\r\n\t\t\t\t\t\t\"\"\"\r\n\t\t\t}\r\n\t\t]\r\n\r\n\t\tdom: \"tp\",\r\n\t\tlengthChange: false,\r\n\t\textraFields: [\"state\", \"final_decision\", \"space\", \"keywords\"],\r\n\t\tpageLength: 10,\r\n\t\tinfo: false,\r\n\t\tsearching: true,\r\n\t\tresponsive:\r\n\t\t\tdetails: false\r\n\t\tautoWidth: false,\r\n\t\tchangeSelector: (selector, userId) ->\r\n\t\t\tunless userId\r\n\t\t\t\treturn {_id: -1}\r\n\r\n\t\t\tspaceId = selector.space\r\n\t\t\tunless spaceId\r\n\t\t\t\tif selector?.$and?.length > 0\r\n\t\t\t\t\tspaceId = selector.$and.getProperty('space')[0]\r\n\t\t\tunless spaceId\r\n\t\t\t\treturn {_id: -1}\r\n\t\t\tspace = db.spaces.findOne(spaceId)\r\n\t\t\tif !space\r\n\t\t\t\tselector.state = \"none\"\r\n\t\t\tif !space.admins.includes(userId)\r\n\r\n\t\t\t\tflow_ids = []\r\n\t\t\t\tcurSpaceUser = db.space_users.findOne({\r\n\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\t'user': userId\r\n\t\t\t\t})\r\n\t\t\t\tif curSpaceUser\r\n\t\t\t\t\torganizations = db.organizations.find({\r\n\t\t\t\t\t\t_id: {\r\n\t\t\t\t\t\t\t$in: curSpaceUser.organizations\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}).fetch()\r\n\t\t\t\t\tflows = db.flows.find({ space: spaceId })\r\n\t\t\t\t\tflows.forEach (fl)->\r\n\t\t\t\t\t\tif WorkflowManager.canMonitor(fl, curSpaceUser, organizations) || WorkflowManager.canAdmin(fl, curSpaceUser, organizations)\r\n\t\t\t\t\t\t\tflow_ids.push(fl._id)\r\n\r\n\t\t\t\tif selector?.$and?.length > 0\r\n\t\t\t\t\tselector.$and[0].$or = [{submitter: userId}, {applicant: userId}, {inbox_users: userId}, {outbox_users: userId},\r\n\t\t\t\t\t\t\t{cc_users: userId}, { flow: { $in: flow_ids } }]\r\n\t\t\t\telse\r\n\t\t\t\t\t_.extend selector, {\r\n\t\t\t\t\t\t$or: [{submitter: userId}, {applicant: userId}, {inbox_users: userId}, {outbox_users: userId},\r\n\t\t\t\t\t\t\t{cc_users: userId}, { flow: { $in: flow_ids } }]\r\n\t\t\t\t\t}\r\n\r\n\t\t\treturn selector","Meteor.startup(function() {\n  return TabularTables.related_instances_tabular = new Tabular.Table({\n    name: \"related_instances_tabular\",\n    collection: db.instances,\n    columns: [\n      {\n        data: \"_id\",\n        title: '<input type=\"checkbox\" name=\"reverse\" id=\"reverse\">',\n        orderable: false,\n        width: '1px',\n        render: function(val, type, doc) {\n          var input, ref;\n          input = '<input type=\"checkbox\" class=\"related-instances-list-checkbox\" name=\"related_instances_ids\" id=\"related_instances_ids\" value=\"' + doc._id + '\"';\n          if ((ref = TabularTables.related_instances_tabular.related_instances) != null ? ref.includes(doc._id) : void 0) {\n            input += \" checked \";\n          }\n          input += \">\";\n          return input;\n        }\n      }, {\n        data: \"name\",\n        orderable: false,\n        width: '45%',\n        render: function(val, type, doc) {\n          var absolute, href;\n          href = '';\n          if (Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())) {\n            href = '';\n          }\n          absolute = false;\n          if (Meteor.isServer) {\n            absolute = this.absolute;\n          }\n          if (absolute) {\n            href = Meteor.absoluteUrl(\"workflow/space/\" + doc.space + \"/view/readonly/\" + doc._id + '?hide_traces=0');\n          } else {\n            href = Steedos.absoluteUrl(\"workflow/space/\" + doc.space + \"/view/readonly/\" + doc._id + '?hide_traces=0');\n          }\n          return (\"<a data-id='\" + doc._id + \"' target='_blank' href='\") + href + \"'>\" + doc.name + \"</a>\";\n        }\n      }, {\n        data: \"applicant_name\",\n        title: t(\"instances_applicant_name\"),\n        orderable: false\n      }, {\n        data: \"flow_name\",\n        title: t(\"instances_flow\"),\n        orderable: false\n      }, {\n        data: \"current_step_name\",\n        title: t(\"instances_flow\"),\n        render: function(val, type, doc) {\n          var judge, step_current_name;\n          if (doc.state === \"completed\") {\n            judge = doc.final_decision || \"approved\";\n          }\n          step_current_name = doc.current_step_name || '';\n          return \"<div class=\\\"step-current-state \" + judge + \"\\\">\" + step_current_name + \"</div>\";\n        }\n      }\n    ],\n    dom: \"tp\",\n    lengthChange: false,\n    extraFields: [\"state\", \"final_decision\", \"space\", \"keywords\"],\n    pageLength: 10,\n    info: false,\n    searching: true,\n    responsive: {\n      details: false\n    },\n    autoWidth: false,\n    changeSelector: function(selector, userId) {\n      var curSpaceUser, flow_ids, flows, organizations, ref, ref1, space, spaceId;\n      if (!userId) {\n        return {\n          _id: -1\n        };\n      }\n      spaceId = selector.space;\n      if (!spaceId) {\n        if ((selector != null ? (ref = selector.$and) != null ? ref.length : void 0 : void 0) > 0) {\n          spaceId = selector.$and.getProperty('space')[0];\n        }\n      }\n      if (!spaceId) {\n        return {\n          _id: -1\n        };\n      }\n      space = db.spaces.findOne(spaceId);\n      if (!space) {\n        selector.state = \"none\";\n      }\n      if (!space.admins.includes(userId)) {\n        flow_ids = [];\n        curSpaceUser = db.space_users.findOne({\n          space: spaceId,\n          'user': userId\n        });\n        if (curSpaceUser) {\n          organizations = db.organizations.find({\n            _id: {\n              $in: curSpaceUser.organizations\n            }\n          }).fetch();\n          flows = db.flows.find({\n            space: spaceId\n          });\n          flows.forEach(function(fl) {\n            if (WorkflowManager.canMonitor(fl, curSpaceUser, organizations) || WorkflowManager.canAdmin(fl, curSpaceUser, organizations)) {\n              return flow_ids.push(fl._id);\n            }\n          });\n        }\n        if ((selector != null ? (ref1 = selector.$and) != null ? ref1.length : void 0 : void 0) > 0) {\n          selector.$and[0].$or = [\n            {\n              submitter: userId\n            }, {\n              applicant: userId\n            }, {\n              inbox_users: userId\n            }, {\n              outbox_users: userId\n            }, {\n              cc_users: userId\n            }, {\n              flow: {\n                $in: flow_ids\n              }\n            }\n          ];\n        } else {\n          _.extend(selector, {\n            $or: [\n              {\n                submitter: userId\n              }, {\n                applicant: userId\n              }, {\n                inbox_users: userId\n              }, {\n                outbox_users: userId\n              }, {\n                cc_users: userId\n              }, {\n                flow: {\n                  $in: flow_ids\n                }\n              }\n            ]\n          });\n        }\n      }\n      return selector;\n    }\n  });\n});\n","Steedos.subs[\"InstanceTabular\"] = new SubsManager()\r\n\r\n\r\n_handleListFields = (fields) ->\r\n\tins_fields = new Array();\r\n\r\n\tfields?.forEach (f)->\r\n\t\tif f.type == 'table'\r\n\t\t\tconsole.log 'ignore opinion field in table'\r\n\t\telse if f.type == 'section'\r\n\t\t\tf?.fields?.forEach (f1)->\r\n\t\t\t\tins_fields.push f1\r\n\t\telse\r\n\t\t\tins_fields.push f\r\n\r\n\treturn ins_fields\r\n\r\n\r\nupdateTabularTitle = ()->\r\n\r\n# å¦‚æžœcolumnsæœ‰åŠ å‡ï¼Œè¯·ä¿®æ”¹Template.instance_list._tableColumns å‡½æ•°\r\ninstancesListTableTabular = (flowId, fields)->\r\n\toptions = {\r\n\t\tname: \"instances\",\r\n\t\tcollection: db.instances,\r\n\t\tpub: \"instance_tabular\",\r\n\t\tonUnload: ()->\r\n\t\t\tMeteor.setTimeout(Template.instance_list._tableColumns, 150)\r\n\r\n\t\tdrawCallback: (settings)->\r\n\t\t\temptyTd = $(\".dataTables_empty\")\r\n\t\t\tif emptyTd.length\r\n\t\t\t\temptyTd[0].colSpan = \"6\"\r\n\t\t\tif !Steedos.isMobile() && !Steedos.isPad()\r\n\t\t\t\tMeteor.setTimeout(Template.instance_list._tableColumns, 150)\r\n\t\t\t\t$(\".instance-list\").scrollTop(0).ready ->\r\n\t\t\t\t\t$(\".instance-list\").perfectScrollbar(\"update\")\r\n\t\t\telse\r\n\t\t\t\t$(\".instance-list\").scrollTop(0)\r\n\r\n\t\t\ttitle = t \"pager_input_hint\"\r\n\t\t\tellipsisLink = settings.oInstance.parent().find('.paging_numbers .pagination .disabled a')\r\n\t\t\tellipsisLink.attr(\"title\", title).css(\"cursor\", \"pointer\").click ->\r\n\t\t\t\tif !$(this).find('input').length\r\n\t\t\t\t\tinput = $('<input class=\"paginate_input form-control input-sm\" type=\"text\" style=\"border: none; padding:0 2px;\"/>')\r\n\t\t\t\t\tif Steedos.isMobile()\r\n\t\t\t\t\t\tinput.css({\r\n\t\t\t\t\t\t\twidth:\"52px\"\r\n\t\t\t\t\t\t\theight: \"20px\"\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tinput.css({\r\n\t\t\t\t\t\t\twidth:\"52px\"\r\n\t\t\t\t\t\t\theight: \"16px\"\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\tinput.attr(\"title\", title).attr(\"placeholder\", title)\r\n\t\t\t\t\t$(this).empty().append input\r\n\t\t\t\t\tgoPage = (index)->\r\n\t\t\t\t\t\tif index > 0\r\n\t\t\t\t\t\t\tpages = Math.ceil(settings.fnRecordsDisplay() / settings._iDisplayLength)\r\n\t\t\t\t\t\t\tif index > pages\r\n\t\t\t\t\t\t\t\t# é¡µç è¶…å‡ºç´¢å¼•æ—¶è·³è½¬åˆ°æœ€åŽä¸€é¡µ\r\n\t\t\t\t\t\t\t\tindex = pages\r\n\t\t\t\t\t\t\tindex--\r\n\t\t\t\t\t\t\tsettings.oInstance.DataTable().page(index).draw('page')\r\n\t\t\t\t\tinput.blur (e)->\r\n\t\t\t\t\t\tcurrentPage = $(this).val()\r\n\t\t\t\t\t\tgoPage currentPage\r\n\t\t\t\t\t\t$(this).parent().html '...'\r\n\t\t\t\t\tinput.keydown (e)->\r\n\t\t\t\t\t\tif(e.keyCode.toString() == \"13\")\r\n\t\t\t\t\t\t\tcurrentPage = $(this).val()\r\n\t\t\t\t\t\t\tgoPage currentPage\r\n\r\n\t\tcreatedRow: (row, data, dataIndex) ->\r\n\t\t\tif Meteor.isClient\r\n\t\t\t\tif data._id == FlowRouter.current().params.instanceId\r\n\t\t\t\t\trow.setAttribute(\"class\", \"selected\")\r\n\t\tcolumns: [\r\n\t\t\t{\r\n\t\t\t\tdata: \"_id\",\r\n\t\t\t\torderable: false\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tmodifiedString = moment(doc.modified).format('YYYY-MM-DD');\r\n\r\n\t\t\t\t\tmodified = doc.modified\r\n\t\t\t\t\tif Session.get(\"box\") == 'inbox' && doc.state != 'draft'\r\n\t\t\t\t\t\tmodified = doc.start_date || doc.modified\r\n\r\n\t\t\t\t\tif Session.get(\"box\") == 'outbox' || Session.get(\"box\") == 'monitor'\r\n\t\t\t\t\t\tmodified = doc.submit_date || doc.submit_date\r\n\r\n\t\t\t\t\tmodifiedFromNow = Steedos.momentReactiveFromNow(modified);\r\n\t\t\t\t\tflow_name = doc.flow_name\r\n\t\t\t\t\tcc_view = \"\";\r\n\t\t\t\t\tstep_current_name_view = \"\";\r\n\t\t\t\t\t# å½“å‰ç”¨æˆ·åœ¨cc userä¸­ï¼Œä½†æ˜¯ä¸åœ¨inbox usersæ—¶æ‰æ˜¾ç¤º'ä¼ é˜…'æ–‡å­—\r\n\t\t\t\t\tif doc.is_cc && !doc.inbox_users?.includes(Meteor.userId()) && Session.get(\"box\") == 'inbox'\r\n\t\t\t\t\t\tcc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \"\r\n\t\t\t\t\t\tstep_current_name_view = \"<div class='flow-name'>#{flow_name}<span>(#{doc.current_step_name})</span></div>\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tif Session.get(\"box\") != 'draft' && doc.current_step_name\r\n\t\t\t\t\t\t\tstep_current_name_view = \"<div class='flow-name'>#{flow_name}<span>(#{doc.current_step_name})</span></div>\"\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tstep_current_name_view = \"<div class='flow-name'>#{flow_name}</div>\"\r\n\r\n\t\t\t\t\tagent_view = \"\";\r\n\t\t\t\t\tif doc.agent_user_name && Session.get(\"box\") == 'inbox'\r\n\t\t\t\t\t\tagent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {userName: doc.agent_user_name}) + \")</label>\"\r\n\r\n\t\t\t\t\tunread = ''\r\n\r\n\t\t\t\t\tisFavoriteSelected = Favorites.isRecordSelected(\"instances\", doc._id)\r\n\t\t\t\t\tif Favorites.isRecordSelected(\"instances\", doc._id)\r\n\t\t\t\t\t\tunread = '<i class=\"ion ion-ios-star-outline instance-favorite-selected\"></i>'\r\n\t\t\t\t\telse if Session.get(\"box\") == 'inbox' && doc.is_read == false\r\n\t\t\t\t\t\tunread = '<i class=\"ion ion-record unread\"></i>'\r\n\t\t\t\t\telse if Session.get(\"box\") == 'monitor' && doc.is_hidden == true\r\n\t\t\t\t\t\tunread = '<i class=\"fa fa-lock\"></i>'\r\n\r\n\t\t\t\t\tpriorityIcon = \"\"\r\n\t\t\t\t\tpriorityIconClass = \"\"\r\n\t\t\t\t\tpriorityValue = doc.values?.priority\r\n\t\t\t\t\tswitch priorityValue\r\n\t\t\t\t\t\twhen \"ç‰¹æ€¥\"\r\n\t\t\t\t\t\t\tpriorityIconClass = \"danger\"\r\n\t\t\t\t\t\twhen \"ç´§æ€¥\"\r\n\t\t\t\t\t\t\tpriorityIconClass = \"warning\"\r\n\t\t\t\t\t\twhen \"åŠžæ–‡\"\r\n\t\t\t\t\t\t\tpriorityIconClass = \"muted\"\r\n\t\t\t\t\tif priorityIconClass\r\n\t\t\t\t\t\tinstanceNamePriorityClass = \"color-priority color-priority-#{priorityIconClass}\"\r\n\r\n\t\t\t\t\treturn \"\"\"\r\n\t\t\t\t\t\t\t\t<div class='instance-read-bar'>#{unread}</div>\r\n\t\t\t\t\t\t\t\t<div class='instance-name #{instanceNamePriorityClass}'>#{doc.name}#{cc_view}#{agent_view}\r\n\t\t\t\t\t\t\t\t\t<span>#{doc.applicant_name}</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div class='instance-detail'>#{step_current_name_view}\r\n\t\t\t\t\t\t\t\t\t<span class='instance-modified' title='#{modifiedString}'>#{modifiedFromNow}</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\"\"\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"applicant_organization_name\",\r\n\t\t\t\ttitle: t(\"instances_applicant_organization_name\"),\r\n\t\t\t\tvisible: false,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"name\",\r\n\t\t\t\ttitle: t(\"instances_name\"),\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tcc_view = \"\";\r\n\t\t\t\t\tstep_current_name_view = \"\";\r\n\t\t\t\t\t# å½“å‰ç”¨æˆ·åœ¨cc userä¸­ï¼Œä½†æ˜¯ä¸åœ¨inbox usersæ—¶æ‰æ˜¾ç¤º'ä¼ é˜…'æ–‡å­—\r\n\t\t\t\t\tif doc.is_cc && !doc.inbox_users?.includes(Meteor.userId()) && Session.get(\"box\") == 'inbox'\r\n\t\t\t\t\t\tcc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \"\r\n\r\n\t\t\t\t\tagent_view = \"\";\r\n\t\t\t\t\tif doc.agent_user_name\r\n\t\t\t\t\t\tagent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {userName: doc.agent_user_name}) + \")</label>\"\r\n\r\n\t\t\t\t\tunread = ''\r\n\r\n\t\t\t\t\tif Session.get(\"box\") == 'inbox' && doc.is_read == false\r\n\t\t\t\t\t\tunread = '<i class=\"ion ion-record unread\"></i>'\r\n\t\t\t\t\telse if Session.get(\"box\") == 'monitor' && doc.is_hidden == true\r\n\t\t\t\t\t\tunread = '<i class=\"fa fa-lock\"></i>'\r\n\r\n\t\t\t\t\tpriorityIconClass = \"\"\r\n\t\t\t\t\tpriorityValue = doc.values?.priority\r\n\t\t\t\t\tswitch priorityValue\r\n\t\t\t\t\t\twhen \"ç‰¹æ€¥\"\r\n\t\t\t\t\t\t\tpriorityIconClass = \"danger\"\r\n\t\t\t\t\t\twhen \"ç´§æ€¥\"\r\n\t\t\t\t\t\t\tpriorityIconClass = \"warning\"\r\n\t\t\t\t\t\twhen \"åŠžæ–‡\"\r\n\t\t\t\t\t\t\tpriorityIconClass = \"muted\"\r\n\t\t\t\t\tif priorityIconClass\r\n\t\t\t\t\t\tinstanceNamePriorityClass = \"color-priority color-priority-#{priorityIconClass}\"\r\n\t\t\t\t\treturn \"\"\"\r\n\t\t\t\t\t\t\t<div class='instance-read-bar'>#{unread}</div>\r\n\t\t\t\t\t\t\t<div class='instance-name #{instanceNamePriorityClass}'>#{doc.name}#{cc_view}#{agent_view}</div>\r\n\t\t\t\t\t\t\"\"\"\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"applicant_name\",\r\n\t\t\t\ttitle: t(\"instances_applicant_name\"),\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"submit_date\",\r\n\t\t\t\ttitle: t(\"instances_submit_date\"),\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tif doc.submit_date\r\n\t\t\t\t\t\treturn moment(doc.submit_date).format('YYYY-MM-DD HH:mm');\r\n\t\t\t\t,\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: true\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"flow_name\",\r\n\t\t\t\ttitle: t(\"instances_flow\"),\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"current_step_name\",\r\n\t\t\t\ttitle: t(\"instances_step_current_name\"),\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tif doc.state == \"completed\"\r\n\t\t\t\t\t\tjudge = doc.final_decision || \"approved\"\r\n\r\n\t\t\t\t\tstep_current_name = doc.current_step_name || ''\r\n\r\n\t\t\t\t\tcc_tag = ''\r\n\r\n\t\t\t\t\tif doc.cc_count > 0\r\n\t\t\t\t\t\tcc_tag = TAPi18n.__('cc_tag')\r\n\r\n\t\t\t\t\treturn \"\"\"\r\n\t\t\t\t\t\t<div class=\"step-current-state #{judge}\">#{step_current_name}#{cc_tag}</div>\r\n\t\t\t\t\t\"\"\"\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"modified\",\r\n\t\t\t\ttitle: t(\"instances_modified\"),\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\treturn moment(doc.modified).format('YYYY-MM-DD HH:mm');\r\n\t\t\t\t,\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: true\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"start_date\",\r\n\t\t\t\ttitle: t(\"instances_start_date\"),\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tif doc.start_date\r\n\t\t\t\t\t\treturn moment(doc.start_date).format('YYYY-MM-DD HH:mm');\r\n\t\t\t\t,\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: true\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"my_finish_date\",\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tif doc.my_finish_date\r\n\t\t\t\t\t\treturn moment(doc.my_finish_date).format('YYYY-MM-DD HH:mm');\r\n\t\t\t\t,\r\n\t\t\t\tvisible: false,\r\n\t\t\t\torderable: true\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"modified\",\r\n\t\t\t\tvisible: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"keywords\",\r\n\t\t\t\tvisible: false\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tdata: \"is_archived\",\r\n\t\t\t\trender: (val, type, doc) ->\r\n\t\t\t\t\tif doc?.values?.record_need && doc.values.record_need == \"true\"\r\n\t\t\t\t\t\tif doc?.is_archived\r\n\t\t\t\t\t\t\treturn t(\"YES\")\r\n\t\t\t\t\t\treturn t(\"NO\")\r\n\t\t\t\tvisible: false\r\n\t\t\t\torderable: false\r\n\t\t\t}\r\n\t\t],\r\n\t\tdom: do ->\r\n\t\t\t# æ‰‹æœºä¸Šä¸æ˜¾ç¤ºä¸€é¡µæ˜¾ç¤ºå¤šå°‘æ¡è®°å½•é€‰é¡¹\r\n\t\t\tif Steedos.isMobile()\r\n\t\t\t\t'tp'\r\n\t\t\telse\r\n\t\t\t\t'tpl'\r\n\t\torder: [[4, \"desc\"]],\r\n\t\textraFields: [\"form\", \"flow\", \"inbox_users\", \"state\", \"space\", \"applicant\", \"form_version\",\r\n\t\t\t\"flow_version\", \"is_cc\", \"cc_count\", \"is_read\", \"current_step_name\", \"values\", \"keywords\", \"final_decision\", \"flow_name\", \"is_hidden\", \"agent_user_name\"],\r\n\t\tlengthChange: true,\r\n\t\tlengthMenu: [10,15,20,25,50,100],\r\n\t\tpageLength: 10,\r\n\t\tinfo: false,\r\n\t\tsearching: true,\r\n\t\tresponsive:\r\n\t\t\tdetails: false\r\n\t\tautoWidth: false,\r\n\t\tchangeSelector: (selector, userId) ->\r\n\t\t\tunless userId\r\n\t\t\t\treturn {_id: -1}\r\n\t\t\tspace = selector.space\r\n\t\t\tunless space\r\n\t\t\t\tif selector?.$and?.length > 0\r\n\t\t\t\t\tspace = selector.$and.getProperty('space')[0]\r\n\t\t\tunless space\r\n\t\t\t\treturn {_id: -1}\r\n\t\t\tspace_user = db.space_users.findOne({user: userId, space: space}, {fields: {_id: 1}})\r\n\t\t\tunless space_user\r\n\t\t\t\treturn {_id: -1}\r\n\t\t\treturn selector\r\n\t\tpagingType: \"numbers\"\r\n\r\n\t}\r\n\r\n\tif flowId\r\n\t\tkey = \"instanceFlow\" + flowId\r\n\r\n\t\toptions.name = key\r\n\r\n\t\tTabularTables.instances.fields = fields\r\n\r\n\t\tins_fields = _handleListFields TabularTables.instances.fields\r\n\r\n\t\tins_fields.forEach (f)->\r\n\t\t\tif f.type != 'table' && f.is_list_display\r\n\t\t\t\toptions.columns.push\r\n\t\t\t\t\tdata: (f.name || f.code),\r\n\t\t\t\t\ttitle: t(f.name || f.code),\r\n\t\t\t\t\tvisible: false,\r\n\t\t\t\t\torderable: false\r\n\t\t\t\t\trender: (val, type, doc) ->\r\n\r\n\t\t\t\t\t\tvalues = doc.values || {}\r\n\r\n\t\t\t\t\t\tvalue = values[f.code]\r\n\r\n\t\t\t\t\t\tswitch f.type\r\n\t\t\t\t\t\t\twhen 'user'\r\n\t\t\t\t\t\t\t\tvalue = value?.name\r\n\t\t\t\t\t\t\twhen 'group'\r\n\t\t\t\t\t\t\t\tvalue = value?.fullname\r\n\t\t\t\t\t\t\twhen 'date'\r\n\t\t\t\t\t\t\t\tif value\r\n\t\t\t\t\t\t\t\t\tvalue = moment(value).format('YYYY-MM-DD')\r\n\t\t\t\t\t\t\twhen 'dateTime'\r\n\t\t\t\t\t\t\t\tif value\r\n\t\t\t\t\t\t\t\t\tvalue = moment(value).format('YYYY-MM-DD HH:mm')\r\n\t\t\t\t\t\t\twhen 'checkbox'\r\n\t\t\t\t\t\t\t\tif value == true || value == 'true'\r\n\t\t\t\t\t\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_yes\");\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_no\");\r\n\t\t\t\t\t\t\twhen 'odata'\r\n\t\t\t\t\t\t\t\tif value\r\n\t\t\t\t\t\t\t\t\tif _.isArray(value)\r\n\t\t\t\t\t\t\t\t\t\tvalue = _.pluck(value, '@label').toString()\r\n\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\tvalue = value['@label']\r\n\r\n\t\t\t\t\t\treturn value\r\n\r\n\r\n\treturn options;\r\n\r\nMeteor.startup ()->\r\n\tTabularTables.instances = new Tabular.Table instancesListTableTabular()\r\n\r\n\r\nGetBoxInstancesTabularOptions = (box, flowId, fields)->\r\n\tkey = \"instanceFlow\" + box + flowId\r\n\tif box == \"inbox\"\r\n\t\toptions = _get_inbox_instances_tabular_options(flowId, fields)\r\n\telse if box == \"outbox\"\r\n\t\toptions = _get_outbox_instances_tabular_options(flowId, fields)\r\n\telse\r\n\t\toptions = instancesListTableTabular(flowId, fields)\r\n\t\tif !flowId\r\n\t\t\toptions.name = \"inbox_instances\"\r\n\tif flowId\r\n\t\toptions.name = key\r\n\treturn options\r\n\r\n\r\n\r\n_get_inbox_instances_tabular_options = (flowId, fields)->\r\n\toptions = instancesListTableTabular(flowId, fields)\r\n\r\n\tif !flowId\r\n\t\toptions.name = \"inbox_instances\"\r\n\r\n\toptions.order = [[8, \"desc\"]]\r\n\toptions.filteredRecordIds = (table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions)->\r\n\t\taggregate_operation = [\r\n\t\t\t{\r\n\t\t\t\t$match: selector\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$project: {\r\n\t\t\t\t\tname: 1,\r\n\t\t\t\t\t\"_approve\": '$traces.approves'\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$unwind: \"$_approve\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$unwind: \"$_approve\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$match: {\r\n\t\t\t\t\t'_approve.is_finished': false\r\n\t\t\t\t\t'_approve.handler': userId,\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t]\r\n\t\tif sort and sort.length > 0\r\n\t\t\ts1 = sort[0]\r\n\t\t\ts1_0 = s1[0]\r\n\t\t\ts1_1 = s1[1]\r\n\t\t\tif s1_0 == 'start_date'\r\n\r\n\t\t\t\tfindOptions.sort = [['modified', s1_1]]\r\n\r\n\t\t\t\taggregate_operation.push $group: {_id: \"$_id\", \"approve_start_date\": {$first: \"$_approve.start_date\"}}\r\n\r\n\t\t\t\tag_sort = 'approve_start_date': if s1_1 == 'asc' then 1 else -1\r\n\r\n\t\t\t\taggregate_operation.push $sort: ag_sort\r\n\t\t\t\taggregate_operation.push $skip: skip\r\n\t\t\t\taggregate_operation.push $limit: limit\r\n\t\t\t\tfilteredRecordIds = new Array()\r\n\r\n\t\t\t\taggregate = (table, aggregate_operation, filteredRecordIds, cb) ->\r\n\t\t\t\t\ttable.collection.rawCollection().aggregate(aggregate_operation).toArray (err, data) ->\r\n\t\t\t\t\t\tif err\r\n\t\t\t\t\t\t\tthrow new Error(err)\r\n\t\t\t\t\t\tdata.forEach (doc) ->\r\n\t\t\t\t\t\t\tfilteredRecordIds.push doc._id\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\tif cb\r\n\t\t\t\t\t\t\tcb()\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\treturn\r\n\r\n\t\t\t\tasync_aggregate = Meteor.wrapAsync(aggregate)\r\n\r\n\t\t\t\tasync_aggregate table, aggregate_operation, filteredRecordIds\r\n\r\n\t\t\t\treturn filteredRecordIds.uniq()\r\n\t\t\telse\r\n\t\t\t\treturn old_filteredRecordIds\r\n\r\n\treturn options\r\n\r\nMeteor.startup ()->\r\n\tTabularTables.inbox_instances = new Tabular.Table GetBoxInstancesTabularOptions(\"inbox\")\r\n\r\n\r\n_get_outbox_instances_tabular_options = (flowId, fields)->\r\n\toptions = instancesListTableTabular(flowId, fields)\r\n\r\n\tif !flowId\r\n\t\toptions.name = \"outbox_instances\"\r\n\r\n\toptions.order = [[9, \"desc\"]]\r\n\toptions.filteredRecordIds = (table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions)->\r\n\t\taggregate_operation = [\r\n\t\t\t{\r\n\t\t\t\t$match: selector\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$project: {\r\n\t\t\t\t\tname: 1,\r\n\t\t\t\t\t\"_approve\": '$traces.approves'\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$unwind: \"$_approve\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$unwind: \"$_approve\"\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$match: {\r\n\t\t\t\t\t'_approve.is_finished': true\r\n\t\t\t\t\t$or: [{'_approve.handler': userId},{'_approve.user': userId}]\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t]\r\n\t\tif sort and sort.length > 0\r\n\t\t\ts1 = sort[0]\r\n\t\t\ts1_0 = s1[0]\r\n\t\t\ts1_1 = s1[1]\r\n\t\t\tif s1_0 == 'my_finish_date'\r\n\r\n\t\t\t\tfindOptions.sort = [['modified', s1_1]]\r\n\r\n\t\t\t\taggregate_operation.push $group: {_id: \"$_id\", \"approve_finish_date\": {$last: \"$_approve.finish_date\"}}\r\n\r\n\t\t\t\tag_sort = 'approve_finish_date': if s1_1 == 'asc' then 1 else -1\r\n\r\n\t\t\t\taggregate_operation.push $sort: ag_sort\r\n\t\t\t\taggregate_operation.push $skip: skip\r\n\t\t\t\taggregate_operation.push $limit: limit\r\n\t\t\t\tfilteredRecordIds = new Array()\r\n\r\n\t\t\t\taggregate = (table, aggregate_operation, filteredRecordIds, cb) ->\r\n\t\t\t\t\ttable.collection.rawCollection().aggregate(aggregate_operation).toArray (err, data) ->\r\n\t\t\t\t\t\tif err\r\n\t\t\t\t\t\t\tthrow new Error(err)\r\n\t\t\t\t\t\tdata.forEach (doc) ->\r\n\t\t\t\t\t\t\tfilteredRecordIds.push doc._id\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\tif cb\r\n\t\t\t\t\t\t\tcb()\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\treturn\r\n\r\n\t\t\t\tasync_aggregate = Meteor.wrapAsync(aggregate)\r\n\r\n\t\t\t\tasync_aggregate table, aggregate_operation, filteredRecordIds\r\n\r\n\t\t\t\treturn filteredRecordIds.uniq()\r\n\t\t\telse\r\n\t\t\t\treturn old_filteredRecordIds\r\n\r\n\treturn options\r\n\r\nMeteor.startup ()->\r\n\tTabularTables.outbox_instances = new Tabular.Table GetBoxInstancesTabularOptions(\"outbox\")\r\n\r\nif Meteor.isClient\r\n\tTabularTables.flowInstances = new ReactiveVar()\r\n\r\nMeteor.startup ()->\r\n\tTracker.autorun (c) ->\r\n\t\tif Meteor.isClient && !Steedos.isMobile()\r\n\t\t\tif Session.get(\"flowId\") && Session.get(\"box\") != 'draft'\r\n\t\t\t\tMeteor.call \"newInstancesListTabular\", Session.get(\"box\"), Session.get(\"flowId\"), (error, result) ->\r\n\t\t\t\t\tnewInstancesListTabular Session.get(\"box\"), Session.get(\"flowId\"), result\r\n\t\t\t\t\tTemplate.instance_list._changeOrder()\r\n\r\n\r\nnewInstancesListTabular = (box, flowId, fields)->\r\n\tif !fields\r\n\t\tflow = db.flows.findOne({_id: flowId}, {fields: {form: 1}})\r\n\t\tfields = db.forms.findOne({ _id: flow?.form }, { fields: { 'current.fields': 1 } })?.current?.fields\r\n\r\n\tfields = _handleListFields fields\r\n\r\n\tif fields?.filterProperty(\"is_list_display\", true)?.length > 0\r\n\t\tkey = \"instanceFlow\" + box + flowId\r\n\t\tif Meteor.isClient\r\n\t\t\tTabularTables.flowInstances.set(new Tabular.Table GetBoxInstancesTabularOptions(box, flowId, fields))\r\n\t\telse\r\n\t\t\tnew Tabular.Table GetBoxInstancesTabularOptions(box, flowId, fields)\r\n\t\tconsole.log \"new TabularTables \", key\r\n\r\nif Meteor.isServer\r\n\tMeteor.methods\r\n\t\tnewInstancesListTabular: (box, flowId)->\r\n\t\t\tnewInstancesListTabular(box, flowId)\r\n\r\n\t\t\tflow = db.flows.findOne({_id: flowId}, {fields: {form: 1}})\r\n\t\t\tfields = db.forms.findOne({ _id: flow?.form }, { fields: { 'current.fields': 1 } })?.current?.fields\r\n\t\t\treturn fields\r\n\r\n\r\n","var GetBoxInstancesTabularOptions, _get_inbox_instances_tabular_options, _get_outbox_instances_tabular_options, _handleListFields, instancesListTableTabular, newInstancesListTabular, updateTabularTitle;\n\nSteedos.subs[\"InstanceTabular\"] = new SubsManager();\n\n_handleListFields = function(fields) {\n  var ins_fields;\n  ins_fields = new Array();\n  if (fields != null) {\n    fields.forEach(function(f) {\n      var ref;\n      if (f.type === 'table') {\n        return console.log('ignore opinion field in table');\n      } else if (f.type === 'section') {\n        return f != null ? (ref = f.fields) != null ? ref.forEach(function(f1) {\n          return ins_fields.push(f1);\n        }) : void 0 : void 0;\n      } else {\n        return ins_fields.push(f);\n      }\n    });\n  }\n  return ins_fields;\n};\n\nupdateTabularTitle = function() {};\n\ninstancesListTableTabular = function(flowId, fields) {\n  var ins_fields, key, options;\n  options = {\n    name: \"instances\",\n    collection: db.instances,\n    pub: \"instance_tabular\",\n    onUnload: function() {\n      return Meteor.setTimeout(Template.instance_list._tableColumns, 150);\n    },\n    drawCallback: function(settings) {\n      var ellipsisLink, emptyTd, title;\n      emptyTd = $(\".dataTables_empty\");\n      if (emptyTd.length) {\n        emptyTd[0].colSpan = \"6\";\n      }\n      if (!Steedos.isMobile() && !Steedos.isPad()) {\n        Meteor.setTimeout(Template.instance_list._tableColumns, 150);\n        $(\".instance-list\").scrollTop(0).ready(function() {\n          return $(\".instance-list\").perfectScrollbar(\"update\");\n        });\n      } else {\n        $(\".instance-list\").scrollTop(0);\n      }\n      title = t(\"pager_input_hint\");\n      ellipsisLink = settings.oInstance.parent().find('.paging_numbers .pagination .disabled a');\n      return ellipsisLink.attr(\"title\", title).css(\"cursor\", \"pointer\").click(function() {\n        var goPage, input;\n        if (!$(this).find('input').length) {\n          input = $('<input class=\"paginate_input form-control input-sm\" type=\"text\" style=\"border: none; padding:0 2px;\"/>');\n          if (Steedos.isMobile()) {\n            input.css({\n              width: \"52px\",\n              height: \"20px\"\n            });\n          } else {\n            input.css({\n              width: \"52px\",\n              height: \"16px\"\n            });\n          }\n          input.attr(\"title\", title).attr(\"placeholder\", title);\n          $(this).empty().append(input);\n          goPage = function(index) {\n            var pages;\n            if (index > 0) {\n              pages = Math.ceil(settings.fnRecordsDisplay() / settings._iDisplayLength);\n              if (index > pages) {\n                index = pages;\n              }\n              index--;\n              return settings.oInstance.DataTable().page(index).draw('page');\n            }\n          };\n          input.blur(function(e) {\n            var currentPage;\n            currentPage = $(this).val();\n            goPage(currentPage);\n            return $(this).parent().html('...');\n          });\n          return input.keydown(function(e) {\n            var currentPage;\n            if (e.keyCode.toString() === \"13\") {\n              currentPage = $(this).val();\n              return goPage(currentPage);\n            }\n          });\n        }\n      });\n    },\n    createdRow: function(row, data, dataIndex) {\n      if (Meteor.isClient) {\n        if (data._id === FlowRouter.current().params.instanceId) {\n          return row.setAttribute(\"class\", \"selected\");\n        }\n      }\n    },\n    columns: [\n      {\n        data: \"_id\",\n        orderable: false,\n        render: function(val, type, doc) {\n          var agent_view, cc_view, flow_name, instanceNamePriorityClass, isFavoriteSelected, modified, modifiedFromNow, modifiedString, priorityIcon, priorityIconClass, priorityValue, ref, ref1, step_current_name_view, unread;\n          modifiedString = moment(doc.modified).format('YYYY-MM-DD');\n          modified = doc.modified;\n          if (Session.get(\"box\") === 'inbox' && doc.state !== 'draft') {\n            modified = doc.start_date || doc.modified;\n          }\n          if (Session.get(\"box\") === 'outbox' || Session.get(\"box\") === 'monitor') {\n            modified = doc.submit_date || doc.submit_date;\n          }\n          modifiedFromNow = Steedos.momentReactiveFromNow(modified);\n          flow_name = doc.flow_name;\n          cc_view = \"\";\n          step_current_name_view = \"\";\n          if (doc.is_cc && !((ref = doc.inbox_users) != null ? ref.includes(Meteor.userId()) : void 0) && Session.get(\"box\") === 'inbox') {\n            cc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \";\n            step_current_name_view = \"<div class='flow-name'>\" + flow_name + \"<span>(\" + doc.current_step_name + \")</span></div>\";\n          } else {\n            if (Session.get(\"box\") !== 'draft' && doc.current_step_name) {\n              step_current_name_view = \"<div class='flow-name'>\" + flow_name + \"<span>(\" + doc.current_step_name + \")</span></div>\";\n            } else {\n              step_current_name_view = \"<div class='flow-name'>\" + flow_name + \"</div>\";\n            }\n          }\n          agent_view = \"\";\n          if (doc.agent_user_name && Session.get(\"box\") === 'inbox') {\n            agent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {\n              userName: doc.agent_user_name\n            }) + \")</label>\";\n          }\n          unread = '';\n          isFavoriteSelected = Favorites.isRecordSelected(\"instances\", doc._id);\n          if (Favorites.isRecordSelected(\"instances\", doc._id)) {\n            unread = '<i class=\"ion ion-ios-star-outline instance-favorite-selected\"></i>';\n          } else if (Session.get(\"box\") === 'inbox' && doc.is_read === false) {\n            unread = '<i class=\"ion ion-record unread\"></i>';\n          } else if (Session.get(\"box\") === 'monitor' && doc.is_hidden === true) {\n            unread = '<i class=\"fa fa-lock\"></i>';\n          }\n          priorityIcon = \"\";\n          priorityIconClass = \"\";\n          priorityValue = (ref1 = doc.values) != null ? ref1.priority : void 0;\n          switch (priorityValue) {\n            case \"ç‰¹æ€¥\":\n              priorityIconClass = \"danger\";\n              break;\n            case \"ç´§æ€¥\":\n              priorityIconClass = \"warning\";\n              break;\n            case \"åŠžæ–‡\":\n              priorityIconClass = \"muted\";\n          }\n          if (priorityIconClass) {\n            instanceNamePriorityClass = \"color-priority color-priority-\" + priorityIconClass;\n          }\n          return \"<div class='instance-read-bar'>\" + unread + \"</div>\\n<div class='instance-name \" + instanceNamePriorityClass + \"'>\" + doc.name + cc_view + agent_view + \"\\n\t<span>\" + doc.applicant_name + \"</span>\\n</div>\\n<div class='instance-detail'>\" + step_current_name_view + \"\\n\t<span class='instance-modified' title='\" + modifiedString + \"'>\" + modifiedFromNow + \"</span>\\n</div>\";\n        }\n      }, {\n        data: \"applicant_organization_name\",\n        title: t(\"instances_applicant_organization_name\"),\n        visible: false\n      }, {\n        data: \"name\",\n        title: t(\"instances_name\"),\n        render: function(val, type, doc) {\n          var agent_view, cc_view, instanceNamePriorityClass, priorityIconClass, priorityValue, ref, ref1, step_current_name_view, unread;\n          cc_view = \"\";\n          step_current_name_view = \"\";\n          if (doc.is_cc && !((ref = doc.inbox_users) != null ? ref.includes(Meteor.userId()) : void 0) && Session.get(\"box\") === 'inbox') {\n            cc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \";\n          }\n          agent_view = \"\";\n          if (doc.agent_user_name) {\n            agent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {\n              userName: doc.agent_user_name\n            }) + \")</label>\";\n          }\n          unread = '';\n          if (Session.get(\"box\") === 'inbox' && doc.is_read === false) {\n            unread = '<i class=\"ion ion-record unread\"></i>';\n          } else if (Session.get(\"box\") === 'monitor' && doc.is_hidden === true) {\n            unread = '<i class=\"fa fa-lock\"></i>';\n          }\n          priorityIconClass = \"\";\n          priorityValue = (ref1 = doc.values) != null ? ref1.priority : void 0;\n          switch (priorityValue) {\n            case \"ç‰¹æ€¥\":\n              priorityIconClass = \"danger\";\n              break;\n            case \"ç´§æ€¥\":\n              priorityIconClass = \"warning\";\n              break;\n            case \"åŠžæ–‡\":\n              priorityIconClass = \"muted\";\n          }\n          if (priorityIconClass) {\n            instanceNamePriorityClass = \"color-priority color-priority-\" + priorityIconClass;\n          }\n          return \"<div class='instance-read-bar'>\" + unread + \"</div>\\n<div class='instance-name \" + instanceNamePriorityClass + \"'>\" + doc.name + cc_view + agent_view + \"</div>\";\n        },\n        visible: false,\n        orderable: false\n      }, {\n        data: \"applicant_name\",\n        title: t(\"instances_applicant_name\"),\n        visible: false,\n        orderable: false\n      }, {\n        data: \"submit_date\",\n        title: t(\"instances_submit_date\"),\n        render: function(val, type, doc) {\n          if (doc.submit_date) {\n            return moment(doc.submit_date).format('YYYY-MM-DD HH:mm');\n          }\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"flow_name\",\n        title: t(\"instances_flow\"),\n        visible: false,\n        orderable: false\n      }, {\n        data: \"current_step_name\",\n        title: t(\"instances_step_current_name\"),\n        render: function(val, type, doc) {\n          var cc_tag, judge, step_current_name;\n          if (doc.state === \"completed\") {\n            judge = doc.final_decision || \"approved\";\n          }\n          step_current_name = doc.current_step_name || '';\n          cc_tag = '';\n          if (doc.cc_count > 0) {\n            cc_tag = TAPi18n.__('cc_tag');\n          }\n          return \"<div class=\\\"step-current-state \" + judge + \"\\\">\" + step_current_name + cc_tag + \"</div>\";\n        },\n        visible: false,\n        orderable: false\n      }, {\n        data: \"modified\",\n        title: t(\"instances_modified\"),\n        render: function(val, type, doc) {\n          return moment(doc.modified).format('YYYY-MM-DD HH:mm');\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"start_date\",\n        title: t(\"instances_start_date\"),\n        render: function(val, type, doc) {\n          if (doc.start_date) {\n            return moment(doc.start_date).format('YYYY-MM-DD HH:mm');\n          }\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"my_finish_date\",\n        render: function(val, type, doc) {\n          if (doc.my_finish_date) {\n            return moment(doc.my_finish_date).format('YYYY-MM-DD HH:mm');\n          }\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"modified\",\n        visible: false\n      }, {\n        data: \"keywords\",\n        visible: false\n      }, {\n        data: \"is_archived\",\n        render: function(val, type, doc) {\n          var ref;\n          if ((doc != null ? (ref = doc.values) != null ? ref.record_need : void 0 : void 0) && doc.values.record_need === \"true\") {\n            if (doc != null ? doc.is_archived : void 0) {\n              return t(\"YES\");\n            }\n            return t(\"NO\");\n          }\n        },\n        visible: false,\n        orderable: false\n      }\n    ],\n    dom: (function() {\n      if (Steedos.isMobile()) {\n        return 'tp';\n      } else {\n        return 'tpl';\n      }\n    })(),\n    order: [[4, \"desc\"]],\n    extraFields: [\"form\", \"flow\", \"inbox_users\", \"state\", \"space\", \"applicant\", \"form_version\", \"flow_version\", \"is_cc\", \"cc_count\", \"is_read\", \"current_step_name\", \"values\", \"keywords\", \"final_decision\", \"flow_name\", \"is_hidden\", \"agent_user_name\"],\n    lengthChange: true,\n    lengthMenu: [10, 15, 20, 25, 50, 100],\n    pageLength: 10,\n    info: false,\n    searching: true,\n    responsive: {\n      details: false\n    },\n    autoWidth: false,\n    changeSelector: function(selector, userId) {\n      var ref, space, space_user;\n      if (!userId) {\n        return {\n          _id: -1\n        };\n      }\n      space = selector.space;\n      if (!space) {\n        if ((selector != null ? (ref = selector.$and) != null ? ref.length : void 0 : void 0) > 0) {\n          space = selector.$and.getProperty('space')[0];\n        }\n      }\n      if (!space) {\n        return {\n          _id: -1\n        };\n      }\n      space_user = db.space_users.findOne({\n        user: userId,\n        space: space\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (!space_user) {\n        return {\n          _id: -1\n        };\n      }\n      return selector;\n    },\n    pagingType: \"numbers\"\n  };\n  if (flowId) {\n    key = \"instanceFlow\" + flowId;\n    options.name = key;\n    TabularTables.instances.fields = fields;\n    ins_fields = _handleListFields(TabularTables.instances.fields);\n    ins_fields.forEach(function(f) {\n      if (f.type !== 'table' && f.is_list_display) {\n        return options.columns.push({\n          data: f.name || f.code,\n          title: t(f.name || f.code),\n          visible: false,\n          orderable: false,\n          render: function(val, type, doc) {\n            var value, values;\n            values = doc.values || {};\n            value = values[f.code];\n            switch (f.type) {\n              case 'user':\n                value = value != null ? value.name : void 0;\n                break;\n              case 'group':\n                value = value != null ? value.fullname : void 0;\n                break;\n              case 'date':\n                if (value) {\n                  value = moment(value).format('YYYY-MM-DD');\n                }\n                break;\n              case 'dateTime':\n                if (value) {\n                  value = moment(value).format('YYYY-MM-DD HH:mm');\n                }\n                break;\n              case 'checkbox':\n                if (value === true || value === 'true') {\n                  value = TAPi18n.__(\"form_field_checkbox_yes\");\n                } else {\n                  value = TAPi18n.__(\"form_field_checkbox_no\");\n                }\n                break;\n              case 'odata':\n                if (value) {\n                  if (_.isArray(value)) {\n                    value = _.pluck(value, '@label').toString();\n                  } else {\n                    value = value['@label'];\n                  }\n                }\n            }\n            return value;\n          }\n        });\n      }\n    });\n  }\n  return options;\n};\n\nMeteor.startup(function() {\n  return TabularTables.instances = new Tabular.Table(instancesListTableTabular());\n});\n\nGetBoxInstancesTabularOptions = function(box, flowId, fields) {\n  var key, options;\n  key = \"instanceFlow\" + box + flowId;\n  if (box === \"inbox\") {\n    options = _get_inbox_instances_tabular_options(flowId, fields);\n  } else if (box === \"outbox\") {\n    options = _get_outbox_instances_tabular_options(flowId, fields);\n  } else {\n    options = instancesListTableTabular(flowId, fields);\n    if (!flowId) {\n      options.name = \"inbox_instances\";\n    }\n  }\n  if (flowId) {\n    options.name = key;\n  }\n  return options;\n};\n\n_get_inbox_instances_tabular_options = function(flowId, fields) {\n  var options;\n  options = instancesListTableTabular(flowId, fields);\n  if (!flowId) {\n    options.name = \"inbox_instances\";\n  }\n  options.order = [[8, \"desc\"]];\n  options.filteredRecordIds = function(table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions) {\n    var ag_sort, aggregate, aggregate_operation, async_aggregate, filteredRecordIds, s1, s1_0, s1_1;\n    aggregate_operation = [\n      {\n        $match: selector\n      }, {\n        $project: {\n          name: 1,\n          \"_approve\": '$traces.approves'\n        }\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $match: {\n          '_approve.is_finished': false,\n          '_approve.handler': userId\n        }\n      }\n    ];\n    if (sort && sort.length > 0) {\n      s1 = sort[0];\n      s1_0 = s1[0];\n      s1_1 = s1[1];\n      if (s1_0 === 'start_date') {\n        findOptions.sort = [['modified', s1_1]];\n        aggregate_operation.push({\n          $group: {\n            _id: \"$_id\",\n            \"approve_start_date\": {\n              $first: \"$_approve.start_date\"\n            }\n          }\n        });\n        ag_sort = {\n          'approve_start_date': s1_1 === 'asc' ? 1 : -1\n        };\n        aggregate_operation.push({\n          $sort: ag_sort\n        });\n        aggregate_operation.push({\n          $skip: skip\n        });\n        aggregate_operation.push({\n          $limit: limit\n        });\n        filteredRecordIds = new Array();\n        aggregate = function(table, aggregate_operation, filteredRecordIds, cb) {\n          table.collection.rawCollection().aggregate(aggregate_operation).toArray(function(err, data) {\n            if (err) {\n              throw new Error(err);\n            }\n            data.forEach(function(doc) {\n              filteredRecordIds.push(doc._id);\n            });\n            if (cb) {\n              cb();\n            }\n          });\n        };\n        async_aggregate = Meteor.wrapAsync(aggregate);\n        async_aggregate(table, aggregate_operation, filteredRecordIds);\n        return filteredRecordIds.uniq();\n      } else {\n        return old_filteredRecordIds;\n      }\n    }\n  };\n  return options;\n};\n\nMeteor.startup(function() {\n  return TabularTables.inbox_instances = new Tabular.Table(GetBoxInstancesTabularOptions(\"inbox\"));\n});\n\n_get_outbox_instances_tabular_options = function(flowId, fields) {\n  var options;\n  options = instancesListTableTabular(flowId, fields);\n  if (!flowId) {\n    options.name = \"outbox_instances\";\n  }\n  options.order = [[9, \"desc\"]];\n  options.filteredRecordIds = function(table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions) {\n    var ag_sort, aggregate, aggregate_operation, async_aggregate, filteredRecordIds, s1, s1_0, s1_1;\n    aggregate_operation = [\n      {\n        $match: selector\n      }, {\n        $project: {\n          name: 1,\n          \"_approve\": '$traces.approves'\n        }\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $match: {\n          '_approve.is_finished': true,\n          $or: [\n            {\n              '_approve.handler': userId\n            }, {\n              '_approve.user': userId\n            }\n          ]\n        }\n      }\n    ];\n    if (sort && sort.length > 0) {\n      s1 = sort[0];\n      s1_0 = s1[0];\n      s1_1 = s1[1];\n      if (s1_0 === 'my_finish_date') {\n        findOptions.sort = [['modified', s1_1]];\n        aggregate_operation.push({\n          $group: {\n            _id: \"$_id\",\n            \"approve_finish_date\": {\n              $last: \"$_approve.finish_date\"\n            }\n          }\n        });\n        ag_sort = {\n          'approve_finish_date': s1_1 === 'asc' ? 1 : -1\n        };\n        aggregate_operation.push({\n          $sort: ag_sort\n        });\n        aggregate_operation.push({\n          $skip: skip\n        });\n        aggregate_operation.push({\n          $limit: limit\n        });\n        filteredRecordIds = new Array();\n        aggregate = function(table, aggregate_operation, filteredRecordIds, cb) {\n          table.collection.rawCollection().aggregate(aggregate_operation).toArray(function(err, data) {\n            if (err) {\n              throw new Error(err);\n            }\n            data.forEach(function(doc) {\n              filteredRecordIds.push(doc._id);\n            });\n            if (cb) {\n              cb();\n            }\n          });\n        };\n        async_aggregate = Meteor.wrapAsync(aggregate);\n        async_aggregate(table, aggregate_operation, filteredRecordIds);\n        return filteredRecordIds.uniq();\n      } else {\n        return old_filteredRecordIds;\n      }\n    }\n  };\n  return options;\n};\n\nMeteor.startup(function() {\n  return TabularTables.outbox_instances = new Tabular.Table(GetBoxInstancesTabularOptions(\"outbox\"));\n});\n\nif (Meteor.isClient) {\n  TabularTables.flowInstances = new ReactiveVar();\n}\n\nMeteor.startup(function() {\n  return Tracker.autorun(function(c) {\n    if (Meteor.isClient && !Steedos.isMobile()) {\n      if (Session.get(\"flowId\") && Session.get(\"box\") !== 'draft') {\n        return Meteor.call(\"newInstancesListTabular\", Session.get(\"box\"), Session.get(\"flowId\"), function(error, result) {\n          newInstancesListTabular(Session.get(\"box\"), Session.get(\"flowId\"), result);\n          return Template.instance_list._changeOrder();\n        });\n      }\n    }\n  });\n});\n\nnewInstancesListTabular = function(box, flowId, fields) {\n  var flow, key, ref, ref1, ref2;\n  if (!fields) {\n    flow = db.flows.findOne({\n      _id: flowId\n    }, {\n      fields: {\n        form: 1\n      }\n    });\n    fields = (ref = db.forms.findOne({\n      _id: flow != null ? flow.form : void 0\n    }, {\n      fields: {\n        'current.fields': 1\n      }\n    })) != null ? (ref1 = ref.current) != null ? ref1.fields : void 0 : void 0;\n  }\n  fields = _handleListFields(fields);\n  if ((fields != null ? (ref2 = fields.filterProperty(\"is_list_display\", true)) != null ? ref2.length : void 0 : void 0) > 0) {\n    key = \"instanceFlow\" + box + flowId;\n    if (Meteor.isClient) {\n      TabularTables.flowInstances.set(new Tabular.Table(GetBoxInstancesTabularOptions(box, flowId, fields)));\n    } else {\n      new Tabular.Table(GetBoxInstancesTabularOptions(box, flowId, fields));\n    }\n    return console.log(\"new TabularTables \", key);\n  }\n};\n\nif (Meteor.isServer) {\n  Meteor.methods({\n    newInstancesListTabular: function(box, flowId) {\n      var fields, flow, ref, ref1;\n      newInstancesListTabular(box, flowId);\n      flow = db.flows.findOne({\n        _id: flowId\n      }, {\n        fields: {\n          form: 1\n        }\n      });\n      fields = (ref = db.forms.findOne({\n        _id: flow != null ? flow.form : void 0\n      }, {\n        fields: {\n          'current.fields': 1\n        }\n      })) != null ? (ref1 = ref.current) != null ? ref1.fields : void 0 : void 0;\n      return fields;\n    }\n  });\n}\n"]}