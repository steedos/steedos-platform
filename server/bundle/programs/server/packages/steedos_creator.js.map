{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos:creator/checkNpm.js","meteor://ðŸ’»app/packages/steedos_creator/core.coffee","meteor://ðŸ’»app/core.coffee","meteor://ðŸ’»app/packages/steedos_creator/lib/apps.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/object_recent_viewed.coffee","meteor://ðŸ’»app/server/methods/object_recent_viewed.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/object_recent_record.coffee","meteor://ðŸ’»app/server/methods/object_recent_record.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/object_listviews_options.coffee","meteor://ðŸ’»app/server/methods/object_listviews_options.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/report_data.coffee","meteor://ðŸ’»app/server/methods/report_data.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/user_tabular_settings.coffee","meteor://ðŸ’»app/server/methods/user_tabular_settings.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/object_export2xml.coffee","meteor://ðŸ’»app/server/methods/object_export2xml.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/related_objects_records.coffee","meteor://ðŸ’»app/server/methods/related_objects_records.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/methods/pending_space.coffee","meteor://ðŸ’»app/server/methods/pending_space.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/object.coffee","meteor://ðŸ’»app/server/publications/object.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/object_tabular.coffee","meteor://ðŸ’»app/server/publications/object_tabular.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/object_listviews.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/user_tabular_settings.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/related_objects_records.coffee","meteor://ðŸ’»app/server/publications/related_objects_records.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/space_user_info.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/contacts_view_limits.coffee","meteor://ðŸ’»app/server/publications/contacts_view_limits.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/contacts_no_force_phone_users.coffee","meteor://ðŸ’»app/server/publications/contacts_no_force_phone_users.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/publications/space_need_to_confirm.coffee","meteor://ðŸ’»app/server/publications/space_need_to_confirm.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/lib/permission_manager.coffee","meteor://ðŸ’»app/server/lib/permission_manager.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/lib/uuflowManagerForInitApproval.coffee","meteor://ðŸ’»app/server/lib/uuflowManagerForInitApproval.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/routes/s3.coffee","meteor://ðŸ’»app/server/routes/s3.coffee","meteor://ðŸ’»app/packages/steedos_creator/server/routes/api_workflow_drafts.coffee","meteor://ðŸ’»app/server/routes/api_workflow_drafts.coffee"],"names":["checkNpmVersions","module","link","v","busboy","mkdirp","Meteor","settings","cfs","aliyun","Creator","getSchema","object_name","ref","getObject","schema","getObjectHomeComponent","isClient","ReactSteedos","pluginComponentSelector","store","getState","getObjectUrl","record_id","app_id","list_view","list_view_id","Session","get","getListView","_id","getRelativeUrl","getObjectAbsoluteUrl","Steedos","absoluteUrl","getObjectRouterUrl","getListViewUrl","url","getListViewRelativeUrl","getSwitchListUrl","getRelatedObjectUrl","related_object_name","getObjectLookupFieldOptions","is_deep","is_skip_hide","is_related","_object","_options","fields","icon","relatedObjects","_","forEach","f","k","hidden","type","push","label","value","r_object","reference_to","isString","f2","k2","getRelatedObjects","each","_this","_relatedObject","relatedObject","relatedOptions","relatedOption","foreign_key","name","getObjectFilterFieldOptions","permission_fields","getFields","include","test","indexOf","getObjectFieldOptions","getFiltersWithFilterFields","filters","filter_fields","length","n","field","required","findWhere","is_default","is_required","filterItem","matchField","find","getObjectRecord","select_fields","expand","collection","record","ref1","ref2","Template","instance","odata","getCollection","findOne","getObjectRecordName","name_field_key","NAME_FIELD_KEY","getApp","app","Apps","deps","depend","getAppDashboard","dashboard","Dashboards","apps","getAppDashboardComponent","getAppObjectNames","appObjects","isMobile","objects","mobile_objects","obj","permissions","allowRead","getVisibleApps","includeAdmin","changeApp","_subApp","entities","Object","assign","visibleAppsSelector","getVisibleAppsObjects","visibleObjectNames","flatten","pluck","filter","Objects","sort","sortingMethod","bind","key","uniq","getAppsObjects","tempObjects","concat","validateFilters","logic","e","errorMsg","filter_items","filter_length","flag","index","word","map","isEmpty","compact","replace","match","i","includes","w","error","console","log","toastr","formatFiltersToMongo","options","selector","Array","operation","option","reg","sub_selector","evaluateFormula","RegExp","isBetweenFilterOperation","getBetweenTimeBuiltinValues","formatFiltersToDev","logicTempFilters","steedosFilters","require","is_logic_or","pop","USER_CONTEXT","formatLogicFiltersToDev","filter_logic","format_logic","x","_f","isArray","JSON","stringify","spaceId","userId","related_object_names","related_objects","unrelated_objects","getObjectRelateds","_collection_name","getPermissions","difference","related_object","isActive","getRelatedObjectNames","getActions","actions","disabled_actions","sortBy","values","has","action","allow_customActions","keys","exclude_actions","on","getListViews","disabled_list_views","list_views","object","item","item_name","owner","fieldsName","unreadable_fields","getObjectFieldsName","isloading","bootstrapLoaded","convertSpecialCharacter","str","getDisabledFields","fieldName","autoform","disabled","omit","getHiddenFields","getFieldsWithNoGroup","group","getSortedFieldGroupNames","names","unique","getFieldsForGroup","groupName","getFieldsWithoutOmit","pick","getFieldsInFirstLevel","firstLevelKeys","getFieldsForReorder","isSingle","_keys","childKeys","is_wide_1","is_wide_2","sc_1","sc_2","endsWith","is_wide","slice","isFilterValueEmpty","Number","isNaN","getFieldDataType","objectFields","result","data_type","isServer","getAllRelatedObjects","related_field","related_field_name","enable_files","formatIndex","array","indexName","isdocumentDB","background","datasources","documentDB","join","substring","appsByName","methods","space_id","collection_recent_viewed","current_recent_viewed","doc","space","update","$inc","count","$set","modified","Date","modified_by","insert","_makeNewID","o","ids","created","created_by","async_recent_aggregate","recent_aggregate","search_object","_records","callback","Collections","object_recent_viewed","rawCollection","aggregate","$match","$group","maxCreated","$max","$sort","$limit","toArray","err","data","Error","isFunction","wrapAsync","searchText","_object_collection","_object_name_key","query","query_and","records","search_Keywords","split","keyword","subquery","$regex","trim","$and","$in","limit","_name","_object_name","record_object","record_object_collection","self","objectsByName","object_record","enable_search","update_filters","listview_id","filter_scope","object_listviews","direct","update_columns","columns","check","compoundFields","cursor","filterFields","childKey","objectField","splits","isCommonSpace","isSpaceAdmin","skip","fetch","compoundFieldItem","compoundFilterFields","itemKey","itemValue","referenceItem","setting","column_width","obj1","_id_actions","_mixFieldsData","_mixRelatedData","_writeXmlFile","fs","logger","path","xml2js","Logger","jsonObj","objName","builder","day","fileAddress","fileName","filePath","month","now","stream","xml","year","Builder","buildObject","Buffer","getFullYear","getMonth","getDate","__meteor_bootstrap__","serverDir","existsSync","sync","writeFile","mixBool","mixDate","mixDefault","objFields","field_name","date","dateStr","format","moment","relatedObjNames","relatedObjName","relatedCollection","relatedRecordList","relatedTableData","relatedObj","fieldsData","Export2xml","recordList","info","time","recordObj","timeEnd","related_objects_records","related_records","viewAllRecords","getPendingSpaceInfo","inviterId","inviterName","spaceName","db","users","spaces","inviter","refuseJoinSpace","space_users","invite_state","acceptJoinSpace","user_accepted","publish","id","publishComposite","tableName","_fields","object_colleciton","reference_fields","ready","String","Match","Optional","getObjectName","unblock","field_keys","children","_objectKeys","reference_field","parent","children_fields","p_k","reference_ids","reference_to_object","s_k","getProperty","reduce","isObject","shared","user","space_settings","permissionManagerForInitApproval","getFlowPermissions","flow_id","user_id","flow","my_permissions","org_ids","organizations","orgs_can_add","orgs_can_admin","orgs_can_monitor","users_can_add","users_can_admin","users_can_monitor","uuflowManagerForInitApproval","getFlow","parents","org","parent_id","perms","org_id","_eval","objectql","check_authorization","req","authToken","hashedToken","Accounts","_hashLoginToken","getSpace","flows","getSpaceUser","space_user","getSpaceUserOrgInfo","organization","fullname","organization_name","organization_fullname","isFlowEnabled","state","isFlowSpaceMatched","getForm","form_id","form","forms","getCategory","category_id","categories","create_instance","instance_from_client","user_info","appr_obj","approve_from_client","category","ins_obj","new_ins_id","relatedTablesInfo","space_user_org_info","start_step","trace_from_client","trace_obj","checkIsInApproval","permissionManager","instances","flow_version","current","form_version","submitter","submitter_name","applicant","applicant_name","applicant_organization","applicant_organization_name","applicant_organization_fullname","applicant_company","company_id","code","is_archived","is_deleted","record_ids","Mongo","ObjectID","_str","is_finished","steps","step","step_type","start_date","trace","user_name","handler","handler_name","handler_organization","handler_organization_name","handler_organization_fullname","read_date","is_read","is_error","description","initiateValues","approves","traces","inbox_users","current_step_name","auto_remind","flow_name","category_name","initiateRecordInstanceInfo","initiateRelatedRecordInstanceInfo","initiateAttach","recordIds","flowId","fieldCodes","filterValues","formFields","formTableFields","formTableFieldsCode","getFieldOdataValue","getFormField","getFormTableField","getFormTableFieldCode","getFormTableSubField","getRelatedObjectFieldCode","getSelectOrgValue","getSelectOrgValues","getSelectUserValue","getSelectUserValues","objectName","ow","recordId","relatedObjectsKeys","tableFieldCodes","tableFieldMap","tableToRelatedMap","ff","object_workflows","formField","relatedObjectsKey","startsWith","formTableFieldCode","sf","tableField","subFieldCode","_record","nameKey","su","userIds","sus","orgId","orgIds","orgs","field_map","fm","fieldsObj","lookupFieldName","lookupFieldObj","lookupObjectRecord","oTableCode","oTableFieldCode","objField","objectFieldName","objectFieldObjectName","objectLookupField","object_field","odataFieldValue","referenceToFieldValue","referenceToObjectName","relatedObjectFieldCode","selectFieldValue","tableToRelatedMapKey","wTableCode","workflow_field","hasOwnProperty","workflow_table_field_code","object_table_field_code","multiple","is_multiselect","tfc","c","parse","tr","newTr","tfm","wTdCode","formTableField","relatedField","relatedFieldName","relatedObjectName","relatedRecords","relatedTableItems","tableCode","tableValues","_FROM_TABLE_CODE","warn","rr","tableValueItem","valueKey","fieldKey","formFieldKey","relatedObjectField","tableFieldValue","_table","_code","field_map_script","extend","evalFieldMapScript","objectId","func","script","insId","approveId","cf","versions","versionId","idx","newFile","FS","File","attachData","createReadStream","original","metadata","reason","size","owner_name","approve","$push","$each","$position","locked","instance_state","tableItems","$exists","getQueryString","JsonRoutes","add","res","next","parseFiles","fileCollection","files","mimeType","body","extention","fileObj","filename","newFileObjId","resp","toLowerCase","decodeURIComponent","version_id","setHeader","end","statusCode","collectionName","getUserIdFromAuthToken","params","resultData","sendResult","stack","errors","message","accessKeyId","secretAccessKey","method","ALY","canonicalizedQueryString","queryKeys","queryStr","stringToSign","util","Format","Version","AccessKeyId","SignatureMethod","Timestamp","iso8601","SignatureVersion","SignatureNonce","getTime","popEscape","toUpperCase","substr","Signature","crypto","hmac","queryParamsToString","oss","r","ref3","uploadAddress","uploadAuth","videoId","Action","Title","FileName","HTTP","call","VideoId","UploadAddress","toString","UploadAuth","OSS","AccessKeySecret","Endpoint","SecurityToken","putObject","Bucket","Key","Body","AccessControlAllowOrigin","ContentType","CacheControl","ContentDisposition","ContentEncoding","ServerSideEncryption","Expires","bindEnvironment","getPlayInfoQuery","getPlayInfoResult","getPlayInfoUrl","newDate","current_user_id","current_user_info","hashData","inserted_instances","new_ins","inserts","errorMessage"],"mappings":"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","file":"/packages/steedos_creator.js","sourcesContent":["import {\r\n\tcheckNpmVersions\r\n} from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\tbusboy: \"^0.2.13\",\r\n\tmkdirp: \"^0.3.5\",\r\n\t\"xml2js\": \"^0.4.19\",\r\n\t\"node-xlsx\": \"^0.12.0\"\r\n}, 'steedos:creator');\r\n\r\nif (Meteor.settings && Meteor.settings.cfs && Meteor.settings.cfs.aliyun) {\r\n\tcheckNpmVersions({\r\n\t\t\"aliyun-sdk\": \"^1.11.12\"\r\n\t}, 'steedos:creator');\r\n}","\r\n\t# Creator.initApps()\r\n\r\n\r\n# Creator.initApps = ()->\r\n# \tif Meteor.isServer\r\n# \t\t_.each Creator.Apps, (app, app_id)->\r\n# \t\t\tdb_app = db.apps.findOne(app_id)\r\n# \t\t\tif !db_app\r\n# \t\t\t\tapp._id = app_id\r\n# \t\t\t\tdb.apps.insert(app)\r\n# else\r\n# \tapp._id = app_id\r\n# \tdb.apps.update({_id: app_id}, app)\r\n\r\nCreator.getSchema = (object_name)->\r\n\treturn Creator.getObject(object_name)?.schema\r\n\r\nCreator.getObjectHomeComponent = (object_name)->\r\n\tif Meteor.isClient\r\n\t\treturn ReactSteedos.pluginComponentSelector(ReactSteedos.store.getState(), \"ObjectHome\", object_name)\r\n\r\nCreator.getObjectUrl = (object_name, record_id, app_id) ->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tlist_view = Creator.getListView(object_name, null)\r\n\tlist_view_id = list_view?._id\r\n\r\n\tif record_id\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id)\r\n\telse\r\n\t\tif object_name is \"meeting\"\r\n\t\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\")\r\n\t\telse\r\n\t\t\tif Creator.getObjectHomeComponent(object_name)\r\n\t\t\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name)\r\n\t\t\telse\r\n\t\t\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id)\r\n\r\nCreator.getObjectAbsoluteUrl = (object_name, record_id, app_id) ->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tlist_view = Creator.getListView(object_name, null)\r\n\tlist_view_id = list_view?._id\r\n\r\n\tif record_id\r\n\t\treturn Steedos.absoluteUrl(\"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id, true)\r\n\telse\r\n\t\tif object_name is \"meeting\"\r\n\t\t\treturn Steedos.absoluteUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\", true)\r\n\t\telse\r\n\t\t\treturn Steedos.absoluteUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id, true)\r\n\r\nCreator.getObjectRouterUrl = (object_name, record_id, app_id) ->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tlist_view = Creator.getListView(object_name, null)\r\n\tlist_view_id = list_view?._id\r\n\r\n\tif record_id\r\n\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id\r\n\telse\r\n\t\tif object_name is \"meeting\"\r\n\t\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\"\r\n\t\telse\r\n\t\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id\r\n\r\nCreator.getListViewUrl = (object_name, app_id, list_view_id) ->\r\n\turl = Creator.getListViewRelativeUrl(object_name, app_id, list_view_id)\r\n\treturn Creator.getRelativeUrl(url)\r\n\r\nCreator.getListViewRelativeUrl = (object_name, app_id, list_view_id) ->\r\n\tif list_view_id is \"calendar\"\r\n\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\"\r\n\telse\r\n\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id\r\n\r\nCreator.getSwitchListUrl = (object_name, app_id, list_view_id) ->\r\n\tif list_view_id\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + list_view_id + \"/list\")\r\n\telse\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/list/switch\")\r\n\r\nCreator.getRelatedObjectUrl = (object_name, app_id, record_id, related_object_name) ->\r\n\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + record_id + \"/\" + related_object_name + \"/grid\")\r\n\r\nCreator.getObjectLookupFieldOptions = (object_name, is_deep, is_skip_hide, is_related)->\r\n\t_options = []\r\n\tunless object_name\r\n\t\treturn _options\r\n\t_object = Creator.getObject(object_name)\r\n\tfields = _object?.fields\r\n\ticon = _object?.icon\r\n\t_.forEach fields, (f, k)->\r\n\t\tif is_skip_hide and f.hidden\r\n\t\t\treturn\r\n\t\tif f.type == \"select\"\r\n\t\t\t_options.push {label: \"#{f.label || k}\", value: \"#{k}\", icon: icon}\r\n\t\telse\r\n\t\t\t_options.push {label: f.label || k, value: k, icon: icon}\r\n\tif is_deep\r\n\t\t_.forEach fields, (f, k)->\r\n\t\t\tif is_skip_hide and f.hidden\r\n\t\t\t\treturn\r\n\t\t\tif (f.type == \"lookup\" || f.type == \"master_detail\") && f.reference_to && _.isString(f.reference_to)\r\n\t\t\t\t# ä¸æ”¯æŒf.reference_toä¸ºfunctionçš„æƒ…å†µï¼Œæœ‰éœ€æ±‚å†è¯´\r\n\t\t\t\tr_object = Creator.getObject(f.reference_to)\r\n\t\t\t\tif r_object\r\n\t\t\t\t\t_.forEach r_object.fields, (f2, k2)->\r\n\t\t\t\t\t\t_options.push {label: \"#{f.label || k}=>#{f2.label || k2}\", value: \"#{k}.#{k2}\", icon: r_object?.icon}\r\n\tif is_related\r\n\t\trelatedObjects = Creator.getRelatedObjects(object_name)\r\n\t\t_.each relatedObjects, (_relatedObject)=>\r\n\t\t\trelatedOptions = Creator.getObjectLookupFieldOptions(_relatedObject.object_name, false, false, false)\r\n\t\t\trelatedObject = Creator.getObject(_relatedObject.object_name)\r\n\t\t\t_.each relatedOptions, (relatedOption)->\r\n\t\t\t\tif _relatedObject.foreign_key != relatedOption.value\r\n\t\t\t\t\t_options.push {label: \"#{relatedObject.label || relatedObject.name}=>#{relatedOption.label}\", value: \"#{relatedObject.name}.#{relatedOption.value}\", icon: relatedObject?.icon}\r\n\treturn _options\r\n\r\n# ç»Ÿä¸€ä¸ºå¯¹è±¡object_nameæä¾›å¯ç”¨äºŽè¿‡è™‘å™¨è¿‡è™‘å­—æ®µ\r\nCreator.getObjectFilterFieldOptions = (object_name)->\r\n\t_options = []\r\n\tunless object_name\r\n\t\treturn _options\r\n\t_object = Creator.getObject(object_name)\r\n\tfields = _object?.fields\r\n\tpermission_fields = Creator.getFields(object_name)\r\n\ticon = _object?.icon\r\n\t_.forEach fields, (f, k)->\r\n\t\t# hidden,gridç­‰ç±»åž‹çš„å­—æ®µï¼Œä¸éœ€è¦è¿‡æ»¤\r\n\t\tif !_.include([\"grid\",\"object\", \"[Object]\", \"[object]\", \"Object\", \"avatar\", \"image\", \"markdown\", \"html\"], f.type) and !f.hidden\r\n\t\t\t# filters.$.fieldåŠflow.currentç­‰å­å­—æ®µä¹Ÿä¸éœ€è¦è¿‡æ»¤\r\n\t\t\tif !/\\w+\\./.test(k) and _.indexOf(permission_fields, k) > -1\r\n\t\t\t\t_options.push {label: f.label || k, value: k, icon: icon}\r\n\r\n\treturn _options\r\n\r\nCreator.getObjectFieldOptions = (object_name)->\r\n\t_options = []\r\n\tunless object_name\r\n\t\treturn _options\r\n\t_object = Creator.getObject(object_name)\r\n\tfields = _object?.fields\r\n\tpermission_fields = Creator.getFields(object_name)\r\n\ticon = _object?.icon\r\n\t_.forEach fields, (f, k)->\r\n\t\tif !_.include([\"grid\",\"object\", \"[Object]\", \"[object]\", \"Object\", \"markdown\", \"html\"], f.type)\r\n\t\t\tif !/\\w+\\./.test(k) and _.indexOf(permission_fields, k) > -1\r\n\t\t\t\t_options.push {label: f.label || k, value: k, icon: icon}\r\n\treturn _options\r\n\r\n###\r\nfilters: è¦è½¬æ¢çš„filters\r\nfields: å¯¹è±¡å­—æ®µ\r\nfilter_fields: é»˜è®¤è¿‡æ»¤å­—æ®µï¼Œæ”¯æŒå­—ç¬¦ä¸²æ•°ç»„å’Œå¯¹è±¡æ•°ç»„ä¸¤ç§æ ¼å¼ï¼Œå¦‚:['filed_name1','filed_name2'],[{field:'filed_name1',required:true}]\r\nå¤„ç†é€»è¾‘: æŠŠfiltersä¸­å­˜åœ¨äºŽfilter_fieldsçš„è¿‡æ»¤æ¡ä»¶å¢žåŠ æ¯é¡¹çš„is_defaultã€is_requiredå±žæ€§ï¼Œä¸å­˜åœ¨äºŽfilter_fieldsçš„è¿‡æ»¤æ¡ä»¶å¯¹åº”çš„ç§»é™¤æ¯é¡¹çš„ç›¸å…³å±žæ€§\r\nè¿”å›žç»“æžœ: å¤„ç†åŽçš„filters\r\n###\r\nCreator.getFiltersWithFilterFields = (filters, fields, filter_fields)->\r\n\tunless filters\r\n\t\tfilters = []\r\n\tunless filter_fields\r\n\t\tfilter_fields = []\r\n\tif filter_fields?.length\r\n\t\tfilter_fields.forEach (n)->\r\n\t\t\tif _.isString(n)\r\n\t\t\t\tn = \r\n\t\t\t\t\tfield: n,\r\n\t\t\t\t\trequired: false\r\n\t\t\tif fields[n.field] and !_.findWhere(filters,{field:n.field})\r\n\t\t\t\tfilters.push\r\n\t\t\t\t\tfield: n.field,\r\n\t\t\t\t\tis_default: true,\r\n\t\t\t\t\tis_required: n.required\r\n\tfilters.forEach (filterItem)->\r\n\t\tmatchField = filter_fields.find (n)-> return n == filterItem.field or n.field == filterItem.field\r\n\t\tif _.isString(matchField)\r\n\t\t\tmatchField = \r\n\t\t\t\tfield: matchField,\r\n\t\t\t\trequired: false\r\n\t\tif matchField\r\n\t\t\tfilterItem.is_default = true\r\n\t\t\tfilterItem.is_required = matchField.required\r\n\t\telse\r\n\t\t\tdelete filterItem.is_default\r\n\t\t\tdelete filterItem.is_required\r\n\treturn filters\r\n\r\nCreator.getObjectRecord = (object_name, record_id, select_fields, expand)->\r\n\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tif !record_id\r\n\t\trecord_id = Session.get(\"record_id\")\r\n\tif Meteor.isClient\r\n\t\tif object_name == Session.get(\"object_name\") &&  record_id == Session.get(\"record_id\")\r\n\t\t\tif Template.instance()?.record\r\n\t\t\t\treturn Template.instance()?.record?.get()\r\n\t\telse\r\n\t\t\treturn Creator.odata.get(object_name, record_id, select_fields, expand)\r\n\r\n\tcollection = Creator.getCollection(object_name)\r\n\tif collection\r\n\t\trecord = collection.findOne(record_id)\r\n\t\treturn record\r\n\r\nCreator.getObjectRecordName = (record, object_name)->\r\n\tunless record\r\n\t\trecord = Creator.getObjectRecord()\r\n\tif record\r\n\t\t# æ˜¾ç¤ºç»„ç»‡åˆ—è¡¨æ—¶ï¼Œç‰¹æ®Šå¤„ç†name_field_keyä¸ºnameå­—æ®µ\r\n\t\tname_field_key = if object_name == \"organizations\" then \"name\" else Creator.getObject(object_name)?.NAME_FIELD_KEY\r\n\t\tif record and name_field_key\r\n\t\t\treturn record.label || record[name_field_key]\r\n\r\nCreator.getApp = (app_id)->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tapp = Creator.Apps[app_id]\r\n\tCreator.deps?.app?.depend()\r\n\treturn app\r\n\r\nCreator.getAppDashboard = (app_id)->\r\n\tapp = Creator.getApp(app_id)\r\n\tif !app\r\n\t\treturn\r\n\tdashboard = null\r\n\t_.each Creator.Dashboards, (v, k)->\r\n\t\tif v.apps?.indexOf(app._id) > -1\r\n\t\t\tdashboard = v;\r\n\treturn dashboard;\r\n\r\nCreator.getAppDashboardComponent = (app_id)->\r\n\tapp = Creator.getApp(app_id)\r\n\tif !app\r\n\t\treturn\r\n\treturn ReactSteedos.pluginComponentSelector(ReactSteedos.store.getState(), \"Dashboard\", app._id);\r\n\r\nCreator.getAppObjectNames = (app_id)->\r\n\tapp = Creator.getApp(app_id)\r\n\tif !app\r\n\t\treturn\r\n\tisMobile = Steedos.isMobile()\r\n\tappObjects = if isMobile then app.mobile_objects else app.objects\r\n\tobjects = []\r\n\tif app\r\n\t\t_.each appObjects, (v)->\r\n\t\t\tobj = Creator.getObject(v)\r\n\t\t\tif obj?.permissions.get().allowRead\r\n\t\t\t\tobjects.push v\r\n\treturn objects\r\n\r\nCreator.getVisibleApps = (includeAdmin)->\r\n\tchangeApp = Creator._subApp.get();\r\n\tReactSteedos.store.getState().entities.apps = Object.assign({}, ReactSteedos.store.getState().entities.apps, {apps: changeApp});\r\n\treturn ReactSteedos.visibleAppsSelector(ReactSteedos.store.getState(), includeAdmin)\r\n\r\nCreator.getVisibleAppsObjects = ()->\r\n\tapps = Creator.getVisibleApps()\r\n\tvisibleObjectNames = _.flatten(_.pluck(apps,'objects'))\r\n\tobjects = _.filter Creator.Objects, (obj)->\r\n\t\tif visibleObjectNames.indexOf(obj.name) < 0\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn true\r\n\tobjects = objects.sort(Creator.sortingMethod.bind({key:\"label\"}))\r\n\tobjects = _.pluck(objects,'name')\r\n\treturn _.uniq objects\r\n\r\nCreator.getAppsObjects = ()->\r\n\tobjects = []\r\n\ttempObjects = []\r\n\t_.forEach Creator.Apps, (app)->\r\n\t\ttempObjects = _.filter app.objects, (obj)->\r\n\t\t\treturn !obj.hidden\r\n\t\tobjects = objects.concat(tempObjects)\r\n\treturn _.uniq objects\r\n\r\nCreator.validateFilters = (filters, logic)->\r\n\tfilter_items = _.map filters, (obj) ->\r\n\t\tif _.isEmpty(obj)\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn obj\r\n\tfilter_items = _.compact(filter_items)\r\n\terrorMsg = \"\"\r\n\tfilter_length = filter_items.length\r\n\tif logic\r\n\t\t# æ ¼å¼åŒ–filter\r\n\t\tlogic = logic.replace(/\\n/g, \"\").replace(/\\s+/g, \" \")\r\n\r\n\t\t# åˆ¤æ–­ç‰¹æ®Šå­—ç¬¦\r\n\t\tif /[._\\-!+]+/ig.test(logic)\r\n\t\t\terrorMsg = \"å«æœ‰ç‰¹æ®Šå­—ç¬¦ã€‚\"\r\n\r\n\t\tif !errorMsg\r\n\t\t\tindex = logic.match(/\\d+/ig)\r\n\t\t\tif !index\r\n\t\t\t\terrorMsg = \"æœ‰äº›ç­›é€‰æ¡ä»¶è¿›è¡Œäº†å®šä¹‰ï¼Œä½†æœªåœ¨é«˜çº§ç­›é€‰æ¡ä»¶ä¸­è¢«å¼•ç”¨ã€‚\"\r\n\t\t\telse\r\n\t\t\t\tindex.forEach (i)->\r\n\t\t\t\t\tif i < 1 or i > filter_length\r\n\t\t\t\t\t\terrorMsg = \"æ‚¨çš„ç­›é€‰æ¡ä»¶å¼•ç”¨äº†æœªå®šä¹‰çš„ç­›é€‰å™¨ï¼š#{i}ã€‚\"\r\n\r\n\t\t\t\tflag = 1\r\n\t\t\t\twhile flag <= filter_length\r\n\t\t\t\t\tif !index.includes(\"#{flag}\")\r\n\t\t\t\t\t\terrorMsg = \"æœ‰äº›ç­›é€‰æ¡ä»¶è¿›è¡Œäº†å®šä¹‰ï¼Œä½†æœªåœ¨é«˜çº§ç­›é€‰æ¡ä»¶ä¸­è¢«å¼•ç”¨ã€‚\"\r\n\t\t\t\t\tflag++;\r\n\r\n\t\tif !errorMsg\r\n\t\t\t# åˆ¤æ–­æ˜¯å¦æœ‰éžæ³•è‹±æ–‡å­—ç¬¦\r\n\t\t\tword = logic.match(/[a-zA-Z]+/ig)\r\n\t\t\tif word\r\n\t\t\t\tword.forEach (w)->\r\n\t\t\t\t\tif !/^(and|or)$/ig.test(w)\r\n\t\t\t\t\t\terrorMsg = \"æ£€æŸ¥æ‚¨çš„é«˜çº§ç­›é€‰æ¡ä»¶ä¸­çš„æ‹¼å†™ã€‚\"\r\n\r\n\t\tif !errorMsg\r\n\t\t\t# åˆ¤æ–­æ ¼å¼æ˜¯å¦æ­£ç¡®\r\n\t\t\ttry\r\n\t\t\t\tCreator.eval(logic.replace(/and/ig, \"&&\").replace(/or/ig, \"||\"))\r\n\t\t\tcatch e\r\n\t\t\t\terrorMsg = \"æ‚¨çš„ç­›é€‰å™¨ä¸­å«æœ‰ç‰¹æ®Šå­—ç¬¦\"\r\n\r\n\t\t\tif /(AND)[^()]+(OR)/ig.test(logic) ||  /(OR)[^()]+(AND)/ig.test(logic)\r\n\t\t\t\terrorMsg = \"æ‚¨çš„ç­›é€‰å™¨å¿…é¡»åœ¨è¿žç»­æ€§çš„ AND å’Œ OR è¡¨è¾¾å¼å‰åŽä½¿ç”¨æ‹¬å·ã€‚\"\r\n\tif errorMsg\r\n\t\tconsole.log \"error\", errorMsg\r\n\t\tif Meteor.isClient\r\n\t\t\ttoastr.error(errorMsg)\r\n\t\treturn false\r\n\telse\r\n\t\treturn true\r\n\r\n# \"=\", \"<>\", \">\", \">=\", \"<\", \"<=\", \"startswith\", \"contains\", \"notcontains\".\r\n###\r\noptionså‚æ•°ï¼š\r\n\textend-- æ˜¯å¦éœ€è¦æŠŠå½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯åŠ å…¥å…¬å¼ï¼Œå³è®©å…¬å¼æ”¯æŒCreator.USER_CONTEXTä¸­çš„å€¼ï¼Œé»˜è®¤ä¸ºtrue\r\n\tuserId-- å½“å‰ç™»å½•ç”¨æˆ·\r\n\tspaceId-- å½“å‰æ‰€åœ¨å·¥ä½œåŒº\r\nextendä¸ºtrueæ—¶ï¼ŒåŽç«¯éœ€è¦é¢å¤–ä¼ å…¥userIdåŠspaceIdç”¨äºŽæŠ“å–Creator.USER_CONTEXTå¯¹åº”çš„å€¼\r\n###\r\nCreator.formatFiltersToMongo = (filters, options)->\r\n\tunless filters?.length\r\n\t\treturn\r\n\t# å½“filtersä¸æ˜¯[Array]ç±»åž‹è€Œæ˜¯[Object]ç±»åž‹æ—¶ï¼Œè¿›è¡Œæ ¼å¼è½¬æ¢\r\n\tunless filters[0] instanceof Array\r\n\t\tfilters = _.map filters, (obj)->\r\n\t\t\treturn [obj.field, obj.operation, obj.value]\r\n\tselector = []\r\n\t_.each filters, (filter)->\r\n\t\tfield = filter[0]\r\n\t\toption = filter[1]\r\n\t\tif Meteor.isClient\r\n\t\t\tvalue = Creator.evaluateFormula(filter[2])\r\n\t\telse\r\n\t\t\tvalue = Creator.evaluateFormula(filter[2], null, options)\r\n\t\tsub_selector = {}\r\n\t\tsub_selector[field] = {}\r\n\t\tif option == \"=\"\r\n\t\t\tsub_selector[field][\"$eq\"] = value\r\n\t\telse if option == \"<>\"\r\n\t\t\tsub_selector[field][\"$ne\"] = value\r\n\t\telse if option == \">\"\r\n\t\t\tsub_selector[field][\"$gt\"] = value\r\n\t\telse if option == \">=\"\r\n\t\t\tsub_selector[field][\"$gte\"] = value\r\n\t\telse if option == \"<\"\r\n\t\t\tsub_selector[field][\"$lt\"] = value\r\n\t\telse if option == \"<=\"\r\n\t\t\tsub_selector[field][\"$lte\"] = value\r\n\t\telse if option == \"startswith\"\r\n\t\t\treg = new RegExp(\"^\" + value, \"i\")\r\n\t\t\tsub_selector[field][\"$regex\"] = reg\r\n\t\telse if option == \"contains\"\r\n\t\t\treg = new RegExp(value, \"i\")\r\n\t\t\tsub_selector[field][\"$regex\"] = reg\r\n\t\telse if option == \"notcontains\"\r\n\t\t\treg = new RegExp(\"^((?!\" + value + \").)*$\", \"i\")\r\n\t\t\tsub_selector[field][\"$regex\"] = reg\r\n\t\tselector.push sub_selector\r\n\treturn selector\r\n\r\nCreator.isBetweenFilterOperation = (operation)->\r\n\treturn operation == \"between\" or !!Creator.getBetweenTimeBuiltinValues(true)?[operation]\r\n\r\n###\r\noptionså‚æ•°ï¼š\r\n\textend-- æ˜¯å¦éœ€è¦æŠŠå½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯åŠ å…¥å…¬å¼ï¼Œå³è®©å…¬å¼æ”¯æŒCreator.USER_CONTEXTä¸­çš„å€¼ï¼Œé»˜è®¤ä¸ºtrue\r\n\tuserId-- å½“å‰ç™»å½•ç”¨æˆ·\r\n\tspaceId-- å½“å‰æ‰€åœ¨å·¥ä½œåŒº\r\n\textendä¸ºtrueæ—¶ï¼ŒåŽç«¯éœ€è¦é¢å¤–ä¼ å…¥userIdåŠspaceIdç”¨äºŽæŠ“å–Creator.USER_CONTEXTå¯¹åº”çš„å€¼\r\n###\r\nCreator.formatFiltersToDev = (filters, object_name, options)->\r\n\tsteedosFilters = require(\"@steedos/filters\");\r\n\tunless filters.length\r\n\t\treturn\r\n\tif options?.is_logic_or\r\n\t\t# å¦‚æžœis_logic_orä¸ºtrueï¼Œä¸ºfiltersç¬¬ä¸€å±‚å…ƒç´ å¢žåŠ oré—´éš”\r\n\t\tlogicTempFilters = []\r\n\t\tfilters.forEach (n)->\r\n\t\t\tlogicTempFilters.push(n)\r\n\t\t\tlogicTempFilters.push(\"or\")\r\n\t\tlogicTempFilters.pop()\r\n\t\tfilters = logicTempFilters\r\n\tselector = steedosFilters.formatFiltersToDev(filters, Creator.USER_CONTEXT)\r\n\treturn selector\r\n\r\n###\r\noptionså‚æ•°ï¼š\r\n\textend-- æ˜¯å¦éœ€è¦æŠŠå½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯åŠ å…¥å…¬å¼ï¼Œå³è®©å…¬å¼æ”¯æŒCreator.USER_CONTEXTä¸­çš„å€¼ï¼Œé»˜è®¤ä¸ºtrue\r\n\tuserId-- å½“å‰ç™»å½•ç”¨æˆ·\r\n\tspaceId-- å½“å‰æ‰€åœ¨å·¥ä½œåŒº\r\nextendä¸ºtrueæ—¶ï¼ŒåŽç«¯éœ€è¦é¢å¤–ä¼ å…¥userIdåŠspaceIdç”¨äºŽæŠ“å–Creator.USER_CONTEXTå¯¹åº”çš„å€¼\r\n###\r\nCreator.formatLogicFiltersToDev = (filters, filter_logic, options)->\r\n\tformat_logic = filter_logic.replace(/\\(\\s+/ig, \"(\").replace(/\\s+\\)/ig, \")\").replace(/\\(/g, \"[\").replace(/\\)/g, \"]\").replace(/\\s+/g, \",\").replace(/(and|or)/ig, \"'$1'\")\r\n\tformat_logic = format_logic.replace(/(\\d)+/ig, (x)->\r\n\t\t_f = filters[x-1]\r\n\t\tfield = _f.field\r\n\t\toption = _f.operation\r\n\t\tif Meteor.isClient\r\n\t\t\tvalue = Creator.evaluateFormula(_f.value)\r\n\t\telse\r\n\t\t\tvalue = Creator.evaluateFormula(_f.value, null, options)\r\n\t\tsub_selector = []\r\n\t\tif _.isArray(value) == true\r\n\t\t\tif option == \"=\"\r\n\t\t\t\t_.each value, (v)->\r\n\t\t\t\t\tsub_selector.push [field, option, v], \"or\"\r\n\t\t\telse if option == \"<>\"\r\n\t\t\t\t_.each value, (v)->\r\n\t\t\t\t\tsub_selector.push [field, option, v], \"and\"\r\n\t\t\telse\r\n\t\t\t\t_.each value, (v)->\r\n\t\t\t\t\tsub_selector.push [field, option, v], \"or\"\r\n\t\t\tif sub_selector[sub_selector.length - 1] == \"and\" || sub_selector[sub_selector.length - 1] == \"or\"\r\n\t\t\t\tsub_selector.pop()\r\n\t\telse\r\n\t\t\tsub_selector = [field, option, value]\r\n\t\tconsole.log \"sub_selector\", sub_selector\r\n\t\treturn JSON.stringify(sub_selector)\r\n\t)\r\n\tformat_logic = \"[#{format_logic}]\"\r\n\treturn Creator.eval(format_logic)\r\n\r\nCreator.getRelatedObjects = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\trelated_object_names = []\r\n\t_object = Creator.getObject(object_name)\r\n\r\n\tif !_object\r\n\t\treturn related_object_names\r\n\r\n#\trelated_object_names = _.pluck(_object.related_objects,\"object_name\")\r\n\r\n\trelated_objects = Creator.getObjectRelateds(_object._collection_name)\r\n\r\n\trelated_object_names = _.pluck(related_objects,\"object_name\")\r\n\tif related_object_names?.length == 0\r\n\t\treturn related_object_names\r\n\r\n\tpermissions = Creator.getPermissions(object_name, spaceId, userId)\r\n\tunrelated_objects = permissions.unrelated_objects\r\n\r\n\trelated_object_names = _.difference related_object_names, unrelated_objects\r\n\treturn _.filter related_objects, (related_object)->\r\n\t\trelated_object_name = related_object.object_name\r\n\t\tisActive = related_object_names.indexOf(related_object_name) > -1\r\n\t\tallowRead = Creator.getPermissions(related_object_name, spaceId, userId)?.allowRead\r\n\t\treturn isActive and allowRead\r\n\r\nCreator.getRelatedObjectNames = (object_name, spaceId, userId)->\r\n\trelated_objects = Creator.getRelatedObjects(object_name, spaceId, userId)\r\n\treturn _.pluck(related_objects,\"object_name\")\r\n\r\nCreator.getActions = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\tobj = Creator.getObject(object_name)\r\n\r\n\tif !obj\r\n\t\treturn\r\n\r\n\tpermissions = Creator.getPermissions(object_name, spaceId, userId)\r\n\tdisabled_actions = permissions.disabled_actions\r\n\tactions = _.sortBy(_.values(obj.actions) , 'sort');\r\n\r\n\tif _.has(obj, 'allow_customActions')\r\n\t\tactions = _.filter actions, (action)->\r\n\t\t\treturn _.include(obj.allow_customActions, action.name) || _.include(_.keys(Creator.getObject('base').actions) || {}, action.name)\r\n\tif _.has(obj, 'exclude_actions')\r\n\t\tactions = _.filter actions, (action)->\r\n\t\t\treturn !_.include(obj.exclude_actions, action.name)\r\n\r\n\t_.each actions, (action)->\r\n\t\t# æ‰‹æœºä¸Šåªæ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼Œå…¶ä»–çš„æ”¾åˆ°æŠ˜å ä¸‹æ‹‰èœå•ä¸­\r\n\t\tif Steedos.isMobile() && [\"record\", \"record_only\"].indexOf(action.on) > -1 && action.name != 'standard_edit'\r\n\t\t\tif action.on == \"record_only\"\r\n\t\t\t\taction.on = 'record_only_more'\r\n\t\t\telse\r\n\t\t\t\taction.on = 'record_more'\r\n\r\n\tif Steedos.isMobile() && [\"cms_files\", \"cfs.files.filerecord\"].indexOf(object_name) > -1\r\n\t\t# é™„ä»¶ç‰¹æ®Šå¤„ç†ï¼Œä¸‹è½½æŒ‰é’®æ”¾åœ¨ä¸»èœå•ï¼Œç¼–è¾‘æŒ‰é’®æ”¾åˆ°åº•ä¸‹æŠ˜å ä¸‹æ‹‰èœå•ä¸­\r\n\t\tactions.find((n)-> return n.name == \"standard_edit\")?.on = \"record_more\"\r\n\t\tactions.find((n)-> return n.name == \"download\")?.on = \"record\"\r\n\r\n\tactions = _.filter actions, (action)->\r\n\t\treturn _.indexOf(disabled_actions, action.name) < 0\r\n\r\n\treturn actions\r\n\r\n///\r\n\tè¿”å›žå½“å‰ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„æ‰€æœ‰list_viewï¼ŒåŒ…æ‹¬åˆ†äº«çš„ï¼Œç”¨æˆ·è‡ªå®šä¹‰éžåˆ†äº«çš„ï¼ˆé™¤éžownerå˜äº†ï¼‰ï¼Œä»¥åŠé»˜è®¤çš„å…¶ä»–è§†å›¾\r\n\tæ³¨æ„Creator.getPermissionså‡½æ•°ä¸­æ˜¯ä¸ä¼šæœ‰ç”¨æˆ·è‡ªå®šä¹‰éžåˆ†äº«çš„è§†å›¾çš„ï¼Œæ‰€ä»¥Creator.getPermissionså‡½æ•°ä¸­æ‹¿åˆ°çš„ç»“æžœä¸å…¨ï¼Œå¹¶ä¸æ˜¯å½“å‰ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰è§†å›¾\r\n///\r\nCreator.getListViews = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\t\r\n\tunless object_name\r\n\t\treturn\r\n\r\n\tobject = Creator.getObject(object_name)\r\n\r\n\tif !object\r\n\t\treturn\r\n\r\n\tdisabled_list_views = Creator.getPermissions(object_name, spaceId, userId)?.disabled_list_views || []\r\n\r\n\tlist_views = []\r\n\r\n\tisMobile = Steedos.isMobile()\r\n\r\n\t_.each object.list_views, (item, item_name)->\r\n\t\tif isMobile and item.type == \"calendar\"\r\n\t\t\t# æ‰‹æœºä¸Šå…ˆä¸æ˜¾ç¤ºæ—¥åŽ†è§†å›¾\r\n\t\t\treturn\r\n\t\tif item_name != \"default\"\r\n\t\t\tif _.indexOf(disabled_list_views, item_name) < 0 || item.owner == userId\r\n\t\t\t\tlist_views.push item\r\n\r\n\treturn list_views\r\n\r\n# å‰å°ç†è®ºä¸Šä¸åº”è¯¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œå› ä¸ºå­—æ®µçš„æƒé™éƒ½åœ¨Creator.getObject(object_name).fieldsçš„ç›¸å…³å±žæ€§ä¸­æœ‰æ ‡è¯†äº†\r\nCreator.getFields = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\tfieldsName = Creator.getObjectFieldsName(object_name)\r\n\tunreadable_fields =  Creator.getPermissions(object_name, spaceId, userId)?.unreadable_fields\r\n\treturn _.difference(fieldsName, unreadable_fields)\r\n\r\nCreator.isloading = ()->\r\n\treturn !Creator.bootstrapLoaded.get()\r\n\r\nCreator.convertSpecialCharacter = (str)->\r\n\treturn str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\")\r\n\r\n# è®¡ç®—fieldsç›¸å…³å‡½æ•°\r\n# START\r\nCreator.getDisabledFields = (schema)->\r\n\tfields = _.map(schema, (field, fieldName) ->\r\n\t\treturn field.autoform and field.autoform.disabled and !field.autoform.omit and fieldName\r\n\t)\r\n\tfields = _.compact(fields)\r\n\treturn fields\r\n\r\nCreator.getHiddenFields = (schema)->\r\n\tfields = _.map(schema, (field, fieldName) ->\r\n\t\treturn field.autoform and field.autoform.type == \"hidden\" and !field.autoform.omit and fieldName\r\n\t)\r\n\tfields = _.compact(fields)\r\n\treturn fields\r\n\r\nCreator.getFieldsWithNoGroup = (schema)->\r\n\tfields = _.map(schema, (field, fieldName) ->\r\n\t\treturn (!field.autoform or !field.autoform.group or field.autoform.group == \"-\") and (!field.autoform or field.autoform.type != \"hidden\") and fieldName\r\n\t)\r\n\tfields = _.compact(fields)\r\n\treturn fields\r\n\r\nCreator.getSortedFieldGroupNames = (schema)->\r\n\tnames = _.map(schema, (field) ->\r\n \t\treturn field.autoform and field.autoform.group != \"-\" and field.autoform.group\r\n\t)\r\n\tnames = _.compact(names)\r\n\tnames = _.unique(names)\r\n\treturn names\r\n\r\nCreator.getFieldsForGroup = (schema, groupName) ->\r\n  \tfields = _.map(schema, (field, fieldName) ->\r\n    \treturn field.autoform and field.autoform.group == groupName and field.autoform.type != \"hidden\" and fieldName\r\n  \t)\r\n  \tfields = _.compact(fields)\r\n  \treturn fields\r\n\r\nCreator.getFieldsWithoutOmit = (schema, keys) ->\r\n\tkeys = _.map(keys, (key) ->\r\n\t\tfield = _.pick(schema, key)\r\n\t\tif field[key].autoform?.omit\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn key\r\n\t)\r\n\tkeys = _.compact(keys)\r\n\treturn keys\r\n\r\nCreator.getFieldsInFirstLevel = (firstLevelKeys, keys) ->\r\n\tkeys = _.map(keys, (key) ->\r\n\t\tif _.indexOf(firstLevelKeys, key) > -1\r\n\t\t\treturn key\r\n\t\telse\r\n\t\t\treturn false\r\n\t)\r\n\tkeys = _.compact(keys)\r\n\treturn keys\r\n\r\nCreator.getFieldsForReorder = (schema, keys, isSingle) ->\r\n\tfields = []\r\n\ti = 0\r\n\t_keys = _.filter(keys, (key)->\r\n\t\treturn !key.endsWith('_endLine')\r\n\t);\r\n\twhile i < _keys.length\r\n\t\tsc_1 = _.pick(schema, _keys[i])\r\n\t\tsc_2 = _.pick(schema, _keys[i+1])\r\n\r\n\t\tis_wide_1 = false\r\n\t\tis_wide_2 = false\r\n\r\n#\t\tis_range_1 = false\r\n#\t\tis_range_2 = false\r\n\r\n\t\t_.each sc_1, (value) ->\r\n\t\t\tif value.autoform?.is_wide || value.autoform?.type == \"table\"\r\n\t\t\t\tis_wide_1 = true\r\n\r\n#\t\t\tif value.autoform?.is_range\r\n#\t\t\t\tis_range_1 = true\r\n\r\n\t\t_.each sc_2, (value) ->\r\n\t\t\tif value.autoform?.is_wide || value.autoform?.type == \"table\"\r\n\t\t\t\tis_wide_2 = true\r\n\r\n#\t\t\tif value.autoform?.is_range\r\n#\t\t\t\tis_range_2 = true\r\n\r\n\t\tif Steedos.isMobile()\r\n\t\t\tis_wide_1 = true\r\n\t\t\tis_wide_2 = true\r\n\r\n\t\tif isSingle\r\n\t\t\tfields.push _keys.slice(i, i+1)\r\n\t\t\ti += 1\r\n\t\telse\r\n#\t\t\tif !is_range_1 && is_range_2\r\n#\t\t\t\tchildKeys = _keys.slice(i, i+1)\r\n#\t\t\t\tchildKeys.push undefined\r\n#\t\t\t\tfields.push childKeys\r\n#\t\t\t\ti += 1\r\n#\t\t\telse\r\n\t\t\tif is_wide_1\r\n\t\t\t\tfields.push _keys.slice(i, i+1)\r\n\t\t\t\ti += 1\r\n\t\t\telse if !is_wide_1 and is_wide_2\r\n\t\t\t\tchildKeys = _keys.slice(i, i+1)\r\n\t\t\t\tchildKeys.push undefined\r\n\t\t\t\tfields.push childKeys\r\n\t\t\t\ti += 1\r\n\t\t\telse if !is_wide_1 and !is_wide_2\r\n\t\t\t\tchildKeys = _keys.slice(i, i+1)\r\n\t\t\t\tif _keys[i+1]\r\n\t\t\t\t\tchildKeys.push _keys[i+1]\r\n\t\t\t\telse\r\n\t\t\t\t\tchildKeys.push undefined\r\n\t\t\t\tfields.push childKeys\r\n\t\t\t\ti += 2\r\n\r\n\treturn fields\r\n\r\nCreator.isFilterValueEmpty = (v) ->\r\n\treturn typeof v == \"undefined\" || v == null || Number.isNaN(v) || v.length == 0\r\n\r\nCreator.getFieldDataType = (objectFields, key)->\r\n\tif objectFields and key\r\n\t\tresult = objectFields[key]?.type\r\n\t\tif [\"formula\", \"summary\"].indexOf(result) > -1\r\n\t\t\tresult = objectFields[key].data_type\r\n\t\treturn result\r\n\telse\r\n\t\treturn \"text\"\r\n\r\n# END\r\n\r\nif Meteor.isServer\r\n\tCreator.getAllRelatedObjects = (object_name)->\r\n\t\trelated_object_names = []\r\n\t\t_.each Creator.Objects, (related_object, related_object_name)->\r\n\t\t\t_.each related_object.fields, (related_field, related_field_name)->\r\n\t\t\t\tif related_field.type == \"master_detail\" and related_field.reference_to and related_field.reference_to == object_name\r\n\t\t\t\t\trelated_object_names.push related_object_name\r\n\r\n\t\tif Creator.getObject(object_name).enable_files\r\n\t\t\trelated_object_names.push \"cms_files\"\r\n\r\n\t\treturn related_object_names\r\n\r\nif Meteor.isServer\r\n\tSteedos.formatIndex = (array) ->\r\n\t\tobject = {\r\n        \tbackground: true\r\n    \t};\r\n\t\tisdocumentDB = Meteor.settings?.datasources?.default?.documentDB || false;\r\n\t\tif isdocumentDB\r\n\t\t\tif array.length > 0\r\n\t\t\t\tindexName = array.join(\".\");\r\n\t\t\t\tobject.name = indexName;\r\n\t\t\t\t\r\n\t\t\t\tif (indexName.length > 52)\r\n\t\t\t\t\tobject.name = indexName.substring(0,52);\r\n\r\n\t\treturn object;","Creator.getSchema = function(object_name) {\n  var ref;\n  return (ref = Creator.getObject(object_name)) != null ? ref.schema : void 0;\n};\n\nCreator.getObjectHomeComponent = function(object_name) {\n  if (Meteor.isClient) {\n    return ReactSteedos.pluginComponentSelector(ReactSteedos.store.getState(), \"ObjectHome\", object_name);\n  }\n};\n\nCreator.getObjectUrl = function(object_name, record_id, app_id) {\n  var list_view, list_view_id;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  list_view = Creator.getListView(object_name, null);\n  list_view_id = list_view != null ? list_view._id : void 0;\n  if (record_id) {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id);\n  } else {\n    if (object_name === \"meeting\") {\n      return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\");\n    } else {\n      if (Creator.getObjectHomeComponent(object_name)) {\n        return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name);\n      } else {\n        return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id);\n      }\n    }\n  }\n};\n\nCreator.getObjectAbsoluteUrl = function(object_name, record_id, app_id) {\n  var list_view, list_view_id;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  list_view = Creator.getListView(object_name, null);\n  list_view_id = list_view != null ? list_view._id : void 0;\n  if (record_id) {\n    return Steedos.absoluteUrl(\"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id, true);\n  } else {\n    if (object_name === \"meeting\") {\n      return Steedos.absoluteUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\", true);\n    } else {\n      return Steedos.absoluteUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id, true);\n    }\n  }\n};\n\nCreator.getObjectRouterUrl = function(object_name, record_id, app_id) {\n  var list_view, list_view_id;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  list_view = Creator.getListView(object_name, null);\n  list_view_id = list_view != null ? list_view._id : void 0;\n  if (record_id) {\n    return \"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id;\n  } else {\n    if (object_name === \"meeting\") {\n      return \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\";\n    } else {\n      return \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id;\n    }\n  }\n};\n\nCreator.getListViewUrl = function(object_name, app_id, list_view_id) {\n  var url;\n  url = Creator.getListViewRelativeUrl(object_name, app_id, list_view_id);\n  return Creator.getRelativeUrl(url);\n};\n\nCreator.getListViewRelativeUrl = function(object_name, app_id, list_view_id) {\n  if (list_view_id === \"calendar\") {\n    return \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\";\n  } else {\n    return \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id;\n  }\n};\n\nCreator.getSwitchListUrl = function(object_name, app_id, list_view_id) {\n  if (list_view_id) {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + list_view_id + \"/list\");\n  } else {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/list/switch\");\n  }\n};\n\nCreator.getRelatedObjectUrl = function(object_name, app_id, record_id, related_object_name) {\n  return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + record_id + \"/\" + related_object_name + \"/grid\");\n};\n\nCreator.getObjectLookupFieldOptions = function(object_name, is_deep, is_skip_hide, is_related) {\n  var _object, _options, fields, icon, relatedObjects;\n  _options = [];\n  if (!object_name) {\n    return _options;\n  }\n  _object = Creator.getObject(object_name);\n  fields = _object != null ? _object.fields : void 0;\n  icon = _object != null ? _object.icon : void 0;\n  _.forEach(fields, function(f, k) {\n    if (is_skip_hide && f.hidden) {\n      return;\n    }\n    if (f.type === \"select\") {\n      return _options.push({\n        label: \"\" + (f.label || k),\n        value: \"\" + k,\n        icon: icon\n      });\n    } else {\n      return _options.push({\n        label: f.label || k,\n        value: k,\n        icon: icon\n      });\n    }\n  });\n  if (is_deep) {\n    _.forEach(fields, function(f, k) {\n      var r_object;\n      if (is_skip_hide && f.hidden) {\n        return;\n      }\n      if ((f.type === \"lookup\" || f.type === \"master_detail\") && f.reference_to && _.isString(f.reference_to)) {\n        r_object = Creator.getObject(f.reference_to);\n        if (r_object) {\n          return _.forEach(r_object.fields, function(f2, k2) {\n            return _options.push({\n              label: (f.label || k) + \"=>\" + (f2.label || k2),\n              value: k + \".\" + k2,\n              icon: r_object != null ? r_object.icon : void 0\n            });\n          });\n        }\n      }\n    });\n  }\n  if (is_related) {\n    relatedObjects = Creator.getRelatedObjects(object_name);\n    _.each(relatedObjects, (function(_this) {\n      return function(_relatedObject) {\n        var relatedObject, relatedOptions;\n        relatedOptions = Creator.getObjectLookupFieldOptions(_relatedObject.object_name, false, false, false);\n        relatedObject = Creator.getObject(_relatedObject.object_name);\n        return _.each(relatedOptions, function(relatedOption) {\n          if (_relatedObject.foreign_key !== relatedOption.value) {\n            return _options.push({\n              label: (relatedObject.label || relatedObject.name) + \"=>\" + relatedOption.label,\n              value: relatedObject.name + \".\" + relatedOption.value,\n              icon: relatedObject != null ? relatedObject.icon : void 0\n            });\n          }\n        });\n      };\n    })(this));\n  }\n  return _options;\n};\n\nCreator.getObjectFilterFieldOptions = function(object_name) {\n  var _object, _options, fields, icon, permission_fields;\n  _options = [];\n  if (!object_name) {\n    return _options;\n  }\n  _object = Creator.getObject(object_name);\n  fields = _object != null ? _object.fields : void 0;\n  permission_fields = Creator.getFields(object_name);\n  icon = _object != null ? _object.icon : void 0;\n  _.forEach(fields, function(f, k) {\n    if (!_.include([\"grid\", \"object\", \"[Object]\", \"[object]\", \"Object\", \"avatar\", \"image\", \"markdown\", \"html\"], f.type) && !f.hidden) {\n      if (!/\\w+\\./.test(k) && _.indexOf(permission_fields, k) > -1) {\n        return _options.push({\n          label: f.label || k,\n          value: k,\n          icon: icon\n        });\n      }\n    }\n  });\n  return _options;\n};\n\nCreator.getObjectFieldOptions = function(object_name) {\n  var _object, _options, fields, icon, permission_fields;\n  _options = [];\n  if (!object_name) {\n    return _options;\n  }\n  _object = Creator.getObject(object_name);\n  fields = _object != null ? _object.fields : void 0;\n  permission_fields = Creator.getFields(object_name);\n  icon = _object != null ? _object.icon : void 0;\n  _.forEach(fields, function(f, k) {\n    if (!_.include([\"grid\", \"object\", \"[Object]\", \"[object]\", \"Object\", \"markdown\", \"html\"], f.type)) {\n      if (!/\\w+\\./.test(k) && _.indexOf(permission_fields, k) > -1) {\n        return _options.push({\n          label: f.label || k,\n          value: k,\n          icon: icon\n        });\n      }\n    }\n  });\n  return _options;\n};\n\n\n/*\nfilters: è¦è½¬æ¢çš„filters\nfields: å¯¹è±¡å­—æ®µ\nfilter_fields: é»˜è®¤è¿‡æ»¤å­—æ®µï¼Œæ”¯æŒå­—ç¬¦ä¸²æ•°ç»„å’Œå¯¹è±¡æ•°ç»„ä¸¤ç§æ ¼å¼ï¼Œå¦‚:['filed_name1','filed_name2'],[{field:'filed_name1',required:true}]\nå¤„ç†é€»è¾‘: æŠŠfiltersä¸­å­˜åœ¨äºŽfilter_fieldsçš„è¿‡æ»¤æ¡ä»¶å¢žåŠ æ¯é¡¹çš„is_defaultã€is_requiredå±žæ€§ï¼Œä¸å­˜åœ¨äºŽfilter_fieldsçš„è¿‡æ»¤æ¡ä»¶å¯¹åº”çš„ç§»é™¤æ¯é¡¹çš„ç›¸å…³å±žæ€§\nè¿”å›žç»“æžœ: å¤„ç†åŽçš„filters\n */\n\nCreator.getFiltersWithFilterFields = function(filters, fields, filter_fields) {\n  if (!filters) {\n    filters = [];\n  }\n  if (!filter_fields) {\n    filter_fields = [];\n  }\n  if (filter_fields != null ? filter_fields.length : void 0) {\n    filter_fields.forEach(function(n) {\n      if (_.isString(n)) {\n        n = {\n          field: n,\n          required: false\n        };\n      }\n      if (fields[n.field] && !_.findWhere(filters, {\n        field: n.field\n      })) {\n        return filters.push({\n          field: n.field,\n          is_default: true,\n          is_required: n.required\n        });\n      }\n    });\n  }\n  filters.forEach(function(filterItem) {\n    var matchField;\n    matchField = filter_fields.find(function(n) {\n      return n === filterItem.field || n.field === filterItem.field;\n    });\n    if (_.isString(matchField)) {\n      matchField = {\n        field: matchField,\n        required: false\n      };\n    }\n    if (matchField) {\n      filterItem.is_default = true;\n      return filterItem.is_required = matchField.required;\n    } else {\n      delete filterItem.is_default;\n      return delete filterItem.is_required;\n    }\n  });\n  return filters;\n};\n\nCreator.getObjectRecord = function(object_name, record_id, select_fields, expand) {\n  var collection, record, ref, ref1, ref2;\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  if (!record_id) {\n    record_id = Session.get(\"record_id\");\n  }\n  if (Meteor.isClient) {\n    if (object_name === Session.get(\"object_name\") && record_id === Session.get(\"record_id\")) {\n      if ((ref = Template.instance()) != null ? ref.record : void 0) {\n        return (ref1 = Template.instance()) != null ? (ref2 = ref1.record) != null ? ref2.get() : void 0 : void 0;\n      }\n    } else {\n      return Creator.odata.get(object_name, record_id, select_fields, expand);\n    }\n  }\n  collection = Creator.getCollection(object_name);\n  if (collection) {\n    record = collection.findOne(record_id);\n    return record;\n  }\n};\n\nCreator.getObjectRecordName = function(record, object_name) {\n  var name_field_key, ref;\n  if (!record) {\n    record = Creator.getObjectRecord();\n  }\n  if (record) {\n    name_field_key = object_name === \"organizations\" ? \"name\" : (ref = Creator.getObject(object_name)) != null ? ref.NAME_FIELD_KEY : void 0;\n    if (record && name_field_key) {\n      return record.label || record[name_field_key];\n    }\n  }\n};\n\nCreator.getApp = function(app_id) {\n  var app, ref, ref1;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  app = Creator.Apps[app_id];\n  if ((ref = Creator.deps) != null) {\n    if ((ref1 = ref.app) != null) {\n      ref1.depend();\n    }\n  }\n  return app;\n};\n\nCreator.getAppDashboard = function(app_id) {\n  var app, dashboard;\n  app = Creator.getApp(app_id);\n  if (!app) {\n    return;\n  }\n  dashboard = null;\n  _.each(Creator.Dashboards, function(v, k) {\n    var ref;\n    if (((ref = v.apps) != null ? ref.indexOf(app._id) : void 0) > -1) {\n      return dashboard = v;\n    }\n  });\n  return dashboard;\n};\n\nCreator.getAppDashboardComponent = function(app_id) {\n  var app;\n  app = Creator.getApp(app_id);\n  if (!app) {\n    return;\n  }\n  return ReactSteedos.pluginComponentSelector(ReactSteedos.store.getState(), \"Dashboard\", app._id);\n};\n\nCreator.getAppObjectNames = function(app_id) {\n  var app, appObjects, isMobile, objects;\n  app = Creator.getApp(app_id);\n  if (!app) {\n    return;\n  }\n  isMobile = Steedos.isMobile();\n  appObjects = isMobile ? app.mobile_objects : app.objects;\n  objects = [];\n  if (app) {\n    _.each(appObjects, function(v) {\n      var obj;\n      obj = Creator.getObject(v);\n      if (obj != null ? obj.permissions.get().allowRead : void 0) {\n        return objects.push(v);\n      }\n    });\n  }\n  return objects;\n};\n\nCreator.getVisibleApps = function(includeAdmin) {\n  var changeApp;\n  changeApp = Creator._subApp.get();\n  ReactSteedos.store.getState().entities.apps = Object.assign({}, ReactSteedos.store.getState().entities.apps, {\n    apps: changeApp\n  });\n  return ReactSteedos.visibleAppsSelector(ReactSteedos.store.getState(), includeAdmin);\n};\n\nCreator.getVisibleAppsObjects = function() {\n  var apps, objects, visibleObjectNames;\n  apps = Creator.getVisibleApps();\n  visibleObjectNames = _.flatten(_.pluck(apps, 'objects'));\n  objects = _.filter(Creator.Objects, function(obj) {\n    if (visibleObjectNames.indexOf(obj.name) < 0) {\n      return false;\n    } else {\n      return true;\n    }\n  });\n  objects = objects.sort(Creator.sortingMethod.bind({\n    key: \"label\"\n  }));\n  objects = _.pluck(objects, 'name');\n  return _.uniq(objects);\n};\n\nCreator.getAppsObjects = function() {\n  var objects, tempObjects;\n  objects = [];\n  tempObjects = [];\n  _.forEach(Creator.Apps, function(app) {\n    tempObjects = _.filter(app.objects, function(obj) {\n      return !obj.hidden;\n    });\n    return objects = objects.concat(tempObjects);\n  });\n  return _.uniq(objects);\n};\n\nCreator.validateFilters = function(filters, logic) {\n  var e, errorMsg, filter_items, filter_length, flag, index, word;\n  filter_items = _.map(filters, function(obj) {\n    if (_.isEmpty(obj)) {\n      return false;\n    } else {\n      return obj;\n    }\n  });\n  filter_items = _.compact(filter_items);\n  errorMsg = \"\";\n  filter_length = filter_items.length;\n  if (logic) {\n    logic = logic.replace(/\\n/g, \"\").replace(/\\s+/g, \" \");\n    if (/[._\\-!+]+/ig.test(logic)) {\n      errorMsg = \"å«æœ‰ç‰¹æ®Šå­—ç¬¦ã€‚\";\n    }\n    if (!errorMsg) {\n      index = logic.match(/\\d+/ig);\n      if (!index) {\n        errorMsg = \"æœ‰äº›ç­›é€‰æ¡ä»¶è¿›è¡Œäº†å®šä¹‰ï¼Œä½†æœªåœ¨é«˜çº§ç­›é€‰æ¡ä»¶ä¸­è¢«å¼•ç”¨ã€‚\";\n      } else {\n        index.forEach(function(i) {\n          if (i < 1 || i > filter_length) {\n            return errorMsg = \"æ‚¨çš„ç­›é€‰æ¡ä»¶å¼•ç”¨äº†æœªå®šä¹‰çš„ç­›é€‰å™¨ï¼š\" + i + \"ã€‚\";\n          }\n        });\n        flag = 1;\n        while (flag <= filter_length) {\n          if (!index.includes(\"\" + flag)) {\n            errorMsg = \"æœ‰äº›ç­›é€‰æ¡ä»¶è¿›è¡Œäº†å®šä¹‰ï¼Œä½†æœªåœ¨é«˜çº§ç­›é€‰æ¡ä»¶ä¸­è¢«å¼•ç”¨ã€‚\";\n          }\n          flag++;\n        }\n      }\n    }\n    if (!errorMsg) {\n      word = logic.match(/[a-zA-Z]+/ig);\n      if (word) {\n        word.forEach(function(w) {\n          if (!/^(and|or)$/ig.test(w)) {\n            return errorMsg = \"æ£€æŸ¥æ‚¨çš„é«˜çº§ç­›é€‰æ¡ä»¶ä¸­çš„æ‹¼å†™ã€‚\";\n          }\n        });\n      }\n    }\n    if (!errorMsg) {\n      try {\n        Creator[\"eval\"](logic.replace(/and/ig, \"&&\").replace(/or/ig, \"||\"));\n      } catch (error) {\n        e = error;\n        errorMsg = \"æ‚¨çš„ç­›é€‰å™¨ä¸­å«æœ‰ç‰¹æ®Šå­—ç¬¦\";\n      }\n      if (/(AND)[^()]+(OR)/ig.test(logic) || /(OR)[^()]+(AND)/ig.test(logic)) {\n        errorMsg = \"æ‚¨çš„ç­›é€‰å™¨å¿…é¡»åœ¨è¿žç»­æ€§çš„ AND å’Œ OR è¡¨è¾¾å¼å‰åŽä½¿ç”¨æ‹¬å·ã€‚\";\n      }\n    }\n  }\n  if (errorMsg) {\n    console.log(\"error\", errorMsg);\n    if (Meteor.isClient) {\n      toastr.error(errorMsg);\n    }\n    return false;\n  } else {\n    return true;\n  }\n};\n\n\n/*\noptionså‚æ•°ï¼š\n\textend-- æ˜¯å¦éœ€è¦æŠŠå½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯åŠ å…¥å…¬å¼ï¼Œå³è®©å…¬å¼æ”¯æŒCreator.USER_CONTEXTä¸­çš„å€¼ï¼Œé»˜è®¤ä¸ºtrue\n\tuserId-- å½“å‰ç™»å½•ç”¨æˆ·\n\tspaceId-- å½“å‰æ‰€åœ¨å·¥ä½œåŒº\nextendä¸ºtrueæ—¶ï¼ŒåŽç«¯éœ€è¦é¢å¤–ä¼ å…¥userIdåŠspaceIdç”¨äºŽæŠ“å–Creator.USER_CONTEXTå¯¹åº”çš„å€¼\n */\n\nCreator.formatFiltersToMongo = function(filters, options) {\n  var selector;\n  if (!(filters != null ? filters.length : void 0)) {\n    return;\n  }\n  if (!(filters[0] instanceof Array)) {\n    filters = _.map(filters, function(obj) {\n      return [obj.field, obj.operation, obj.value];\n    });\n  }\n  selector = [];\n  _.each(filters, function(filter) {\n    var field, option, reg, sub_selector, value;\n    field = filter[0];\n    option = filter[1];\n    if (Meteor.isClient) {\n      value = Creator.evaluateFormula(filter[2]);\n    } else {\n      value = Creator.evaluateFormula(filter[2], null, options);\n    }\n    sub_selector = {};\n    sub_selector[field] = {};\n    if (option === \"=\") {\n      sub_selector[field][\"$eq\"] = value;\n    } else if (option === \"<>\") {\n      sub_selector[field][\"$ne\"] = value;\n    } else if (option === \">\") {\n      sub_selector[field][\"$gt\"] = value;\n    } else if (option === \">=\") {\n      sub_selector[field][\"$gte\"] = value;\n    } else if (option === \"<\") {\n      sub_selector[field][\"$lt\"] = value;\n    } else if (option === \"<=\") {\n      sub_selector[field][\"$lte\"] = value;\n    } else if (option === \"startswith\") {\n      reg = new RegExp(\"^\" + value, \"i\");\n      sub_selector[field][\"$regex\"] = reg;\n    } else if (option === \"contains\") {\n      reg = new RegExp(value, \"i\");\n      sub_selector[field][\"$regex\"] = reg;\n    } else if (option === \"notcontains\") {\n      reg = new RegExp(\"^((?!\" + value + \").)*$\", \"i\");\n      sub_selector[field][\"$regex\"] = reg;\n    }\n    return selector.push(sub_selector);\n  });\n  return selector;\n};\n\nCreator.isBetweenFilterOperation = function(operation) {\n  var ref;\n  return operation === \"between\" || !!((ref = Creator.getBetweenTimeBuiltinValues(true)) != null ? ref[operation] : void 0);\n};\n\n\n/*\noptionså‚æ•°ï¼š\n\textend-- æ˜¯å¦éœ€è¦æŠŠå½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯åŠ å…¥å…¬å¼ï¼Œå³è®©å…¬å¼æ”¯æŒCreator.USER_CONTEXTä¸­çš„å€¼ï¼Œé»˜è®¤ä¸ºtrue\n\tuserId-- å½“å‰ç™»å½•ç”¨æˆ·\n\tspaceId-- å½“å‰æ‰€åœ¨å·¥ä½œåŒº\n\textendä¸ºtrueæ—¶ï¼ŒåŽç«¯éœ€è¦é¢å¤–ä¼ å…¥userIdåŠspaceIdç”¨äºŽæŠ“å–Creator.USER_CONTEXTå¯¹åº”çš„å€¼\n */\n\nCreator.formatFiltersToDev = function(filters, object_name, options) {\n  var logicTempFilters, selector, steedosFilters;\n  steedosFilters = require(\"@steedos/filters\");\n  if (!filters.length) {\n    return;\n  }\n  if (options != null ? options.is_logic_or : void 0) {\n    logicTempFilters = [];\n    filters.forEach(function(n) {\n      logicTempFilters.push(n);\n      return logicTempFilters.push(\"or\");\n    });\n    logicTempFilters.pop();\n    filters = logicTempFilters;\n  }\n  selector = steedosFilters.formatFiltersToDev(filters, Creator.USER_CONTEXT);\n  return selector;\n};\n\n\n/*\noptionså‚æ•°ï¼š\n\textend-- æ˜¯å¦éœ€è¦æŠŠå½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯åŠ å…¥å…¬å¼ï¼Œå³è®©å…¬å¼æ”¯æŒCreator.USER_CONTEXTä¸­çš„å€¼ï¼Œé»˜è®¤ä¸ºtrue\n\tuserId-- å½“å‰ç™»å½•ç”¨æˆ·\n\tspaceId-- å½“å‰æ‰€åœ¨å·¥ä½œåŒº\nextendä¸ºtrueæ—¶ï¼ŒåŽç«¯éœ€è¦é¢å¤–ä¼ å…¥userIdåŠspaceIdç”¨äºŽæŠ“å–Creator.USER_CONTEXTå¯¹åº”çš„å€¼\n */\n\nCreator.formatLogicFiltersToDev = function(filters, filter_logic, options) {\n  var format_logic;\n  format_logic = filter_logic.replace(/\\(\\s+/ig, \"(\").replace(/\\s+\\)/ig, \")\").replace(/\\(/g, \"[\").replace(/\\)/g, \"]\").replace(/\\s+/g, \",\").replace(/(and|or)/ig, \"'$1'\");\n  format_logic = format_logic.replace(/(\\d)+/ig, function(x) {\n    var _f, field, option, sub_selector, value;\n    _f = filters[x - 1];\n    field = _f.field;\n    option = _f.operation;\n    if (Meteor.isClient) {\n      value = Creator.evaluateFormula(_f.value);\n    } else {\n      value = Creator.evaluateFormula(_f.value, null, options);\n    }\n    sub_selector = [];\n    if (_.isArray(value) === true) {\n      if (option === \"=\") {\n        _.each(value, function(v) {\n          return sub_selector.push([field, option, v], \"or\");\n        });\n      } else if (option === \"<>\") {\n        _.each(value, function(v) {\n          return sub_selector.push([field, option, v], \"and\");\n        });\n      } else {\n        _.each(value, function(v) {\n          return sub_selector.push([field, option, v], \"or\");\n        });\n      }\n      if (sub_selector[sub_selector.length - 1] === \"and\" || sub_selector[sub_selector.length - 1] === \"or\") {\n        sub_selector.pop();\n      }\n    } else {\n      sub_selector = [field, option, value];\n    }\n    console.log(\"sub_selector\", sub_selector);\n    return JSON.stringify(sub_selector);\n  });\n  format_logic = \"[\" + format_logic + \"]\";\n  return Creator[\"eval\"](format_logic);\n};\n\nCreator.getRelatedObjects = function(object_name, spaceId, userId) {\n  var _object, permissions, related_object_names, related_objects, unrelated_objects;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  related_object_names = [];\n  _object = Creator.getObject(object_name);\n  if (!_object) {\n    return related_object_names;\n  }\n  related_objects = Creator.getObjectRelateds(_object._collection_name);\n  related_object_names = _.pluck(related_objects, \"object_name\");\n  if ((related_object_names != null ? related_object_names.length : void 0) === 0) {\n    return related_object_names;\n  }\n  permissions = Creator.getPermissions(object_name, spaceId, userId);\n  unrelated_objects = permissions.unrelated_objects;\n  related_object_names = _.difference(related_object_names, unrelated_objects);\n  return _.filter(related_objects, function(related_object) {\n    var allowRead, isActive, ref, related_object_name;\n    related_object_name = related_object.object_name;\n    isActive = related_object_names.indexOf(related_object_name) > -1;\n    allowRead = (ref = Creator.getPermissions(related_object_name, spaceId, userId)) != null ? ref.allowRead : void 0;\n    return isActive && allowRead;\n  });\n};\n\nCreator.getRelatedObjectNames = function(object_name, spaceId, userId) {\n  var related_objects;\n  related_objects = Creator.getRelatedObjects(object_name, spaceId, userId);\n  return _.pluck(related_objects, \"object_name\");\n};\n\nCreator.getActions = function(object_name, spaceId, userId) {\n  var actions, disabled_actions, obj, permissions, ref, ref1;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  obj = Creator.getObject(object_name);\n  if (!obj) {\n    return;\n  }\n  permissions = Creator.getPermissions(object_name, spaceId, userId);\n  disabled_actions = permissions.disabled_actions;\n  actions = _.sortBy(_.values(obj.actions), 'sort');\n  if (_.has(obj, 'allow_customActions')) {\n    actions = _.filter(actions, function(action) {\n      return _.include(obj.allow_customActions, action.name) || _.include(_.keys(Creator.getObject('base').actions) || {}, action.name);\n    });\n  }\n  if (_.has(obj, 'exclude_actions')) {\n    actions = _.filter(actions, function(action) {\n      return !_.include(obj.exclude_actions, action.name);\n    });\n  }\n  _.each(actions, function(action) {\n    if (Steedos.isMobile() && [\"record\", \"record_only\"].indexOf(action.on) > -1 && action.name !== 'standard_edit') {\n      if (action.on === \"record_only\") {\n        return action.on = 'record_only_more';\n      } else {\n        return action.on = 'record_more';\n      }\n    }\n  });\n  if (Steedos.isMobile() && [\"cms_files\", \"cfs.files.filerecord\"].indexOf(object_name) > -1) {\n    if ((ref = actions.find(function(n) {\n      return n.name === \"standard_edit\";\n    })) != null) {\n      ref.on = \"record_more\";\n    }\n    if ((ref1 = actions.find(function(n) {\n      return n.name === \"download\";\n    })) != null) {\n      ref1.on = \"record\";\n    }\n  }\n  actions = _.filter(actions, function(action) {\n    return _.indexOf(disabled_actions, action.name) < 0;\n  });\n  return actions;\n};\n\n/è¿”å›žå½“å‰ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„æ‰€æœ‰list_viewï¼ŒåŒ…æ‹¬åˆ†äº«çš„ï¼Œç”¨æˆ·è‡ªå®šä¹‰éžåˆ†äº«çš„ï¼ˆé™¤éžownerå˜äº†ï¼‰ï¼Œä»¥åŠé»˜è®¤çš„å…¶ä»–è§†å›¾æ³¨æ„Creator.getPermissionså‡½æ•°ä¸­æ˜¯ä¸ä¼šæœ‰ç”¨æˆ·è‡ªå®šä¹‰éžåˆ†äº«çš„è§†å›¾çš„ï¼Œæ‰€ä»¥Creator.getPermissionså‡½æ•°ä¸­æ‹¿åˆ°çš„ç»“æžœä¸å…¨ï¼Œå¹¶ä¸æ˜¯å½“å‰ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰è§†å›¾/;\n\nCreator.getListViews = function(object_name, spaceId, userId) {\n  var disabled_list_views, isMobile, list_views, object, ref;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  if (!object_name) {\n    return;\n  }\n  object = Creator.getObject(object_name);\n  if (!object) {\n    return;\n  }\n  disabled_list_views = ((ref = Creator.getPermissions(object_name, spaceId, userId)) != null ? ref.disabled_list_views : void 0) || [];\n  list_views = [];\n  isMobile = Steedos.isMobile();\n  _.each(object.list_views, function(item, item_name) {\n    if (isMobile && item.type === \"calendar\") {\n      return;\n    }\n    if (item_name !== \"default\") {\n      if (_.indexOf(disabled_list_views, item_name) < 0 || item.owner === userId) {\n        return list_views.push(item);\n      }\n    }\n  });\n  return list_views;\n};\n\nCreator.getFields = function(object_name, spaceId, userId) {\n  var fieldsName, ref, unreadable_fields;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  fieldsName = Creator.getObjectFieldsName(object_name);\n  unreadable_fields = (ref = Creator.getPermissions(object_name, spaceId, userId)) != null ? ref.unreadable_fields : void 0;\n  return _.difference(fieldsName, unreadable_fields);\n};\n\nCreator.isloading = function() {\n  return !Creator.bootstrapLoaded.get();\n};\n\nCreator.convertSpecialCharacter = function(str) {\n  return str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\");\n};\n\nCreator.getDisabledFields = function(schema) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return field.autoform && field.autoform.disabled && !field.autoform.omit && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getHiddenFields = function(schema) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return field.autoform && field.autoform.type === \"hidden\" && !field.autoform.omit && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getFieldsWithNoGroup = function(schema) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return (!field.autoform || !field.autoform.group || field.autoform.group === \"-\") && (!field.autoform || field.autoform.type !== \"hidden\") && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getSortedFieldGroupNames = function(schema) {\n  var names;\n  names = _.map(schema, function(field) {\n    return field.autoform && field.autoform.group !== \"-\" && field.autoform.group;\n  });\n  names = _.compact(names);\n  names = _.unique(names);\n  return names;\n};\n\nCreator.getFieldsForGroup = function(schema, groupName) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return field.autoform && field.autoform.group === groupName && field.autoform.type !== \"hidden\" && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getFieldsWithoutOmit = function(schema, keys) {\n  keys = _.map(keys, function(key) {\n    var field, ref;\n    field = _.pick(schema, key);\n    if ((ref = field[key].autoform) != null ? ref.omit : void 0) {\n      return false;\n    } else {\n      return key;\n    }\n  });\n  keys = _.compact(keys);\n  return keys;\n};\n\nCreator.getFieldsInFirstLevel = function(firstLevelKeys, keys) {\n  keys = _.map(keys, function(key) {\n    if (_.indexOf(firstLevelKeys, key) > -1) {\n      return key;\n    } else {\n      return false;\n    }\n  });\n  keys = _.compact(keys);\n  return keys;\n};\n\nCreator.getFieldsForReorder = function(schema, keys, isSingle) {\n  var _keys, childKeys, fields, i, is_wide_1, is_wide_2, sc_1, sc_2;\n  fields = [];\n  i = 0;\n  _keys = _.filter(keys, function(key) {\n    return !key.endsWith('_endLine');\n  });\n  while (i < _keys.length) {\n    sc_1 = _.pick(schema, _keys[i]);\n    sc_2 = _.pick(schema, _keys[i + 1]);\n    is_wide_1 = false;\n    is_wide_2 = false;\n    _.each(sc_1, function(value) {\n      var ref, ref1;\n      if (((ref = value.autoform) != null ? ref.is_wide : void 0) || ((ref1 = value.autoform) != null ? ref1.type : void 0) === \"table\") {\n        return is_wide_1 = true;\n      }\n    });\n    _.each(sc_2, function(value) {\n      var ref, ref1;\n      if (((ref = value.autoform) != null ? ref.is_wide : void 0) || ((ref1 = value.autoform) != null ? ref1.type : void 0) === \"table\") {\n        return is_wide_2 = true;\n      }\n    });\n    if (Steedos.isMobile()) {\n      is_wide_1 = true;\n      is_wide_2 = true;\n    }\n    if (isSingle) {\n      fields.push(_keys.slice(i, i + 1));\n      i += 1;\n    } else {\n      if (is_wide_1) {\n        fields.push(_keys.slice(i, i + 1));\n        i += 1;\n      } else if (!is_wide_1 && is_wide_2) {\n        childKeys = _keys.slice(i, i + 1);\n        childKeys.push(void 0);\n        fields.push(childKeys);\n        i += 1;\n      } else if (!is_wide_1 && !is_wide_2) {\n        childKeys = _keys.slice(i, i + 1);\n        if (_keys[i + 1]) {\n          childKeys.push(_keys[i + 1]);\n        } else {\n          childKeys.push(void 0);\n        }\n        fields.push(childKeys);\n        i += 2;\n      }\n    }\n  }\n  return fields;\n};\n\nCreator.isFilterValueEmpty = function(v) {\n  return typeof v === \"undefined\" || v === null || Number.isNaN(v) || v.length === 0;\n};\n\nCreator.getFieldDataType = function(objectFields, key) {\n  var ref, result;\n  if (objectFields && key) {\n    result = (ref = objectFields[key]) != null ? ref.type : void 0;\n    if ([\"formula\", \"summary\"].indexOf(result) > -1) {\n      result = objectFields[key].data_type;\n    }\n    return result;\n  } else {\n    return \"text\";\n  }\n};\n\nif (Meteor.isServer) {\n  Creator.getAllRelatedObjects = function(object_name) {\n    var related_object_names;\n    related_object_names = [];\n    _.each(Creator.Objects, function(related_object, related_object_name) {\n      return _.each(related_object.fields, function(related_field, related_field_name) {\n        if (related_field.type === \"master_detail\" && related_field.reference_to && related_field.reference_to === object_name) {\n          return related_object_names.push(related_object_name);\n        }\n      });\n    });\n    if (Creator.getObject(object_name).enable_files) {\n      related_object_names.push(\"cms_files\");\n    }\n    return related_object_names;\n  };\n}\n\nif (Meteor.isServer) {\n  Steedos.formatIndex = function(array) {\n    var indexName, isdocumentDB, object, ref, ref1, ref2;\n    object = {\n      background: true\n    };\n    isdocumentDB = ((ref = Meteor.settings) != null ? (ref1 = ref.datasources) != null ? (ref2 = ref1[\"default\"]) != null ? ref2.documentDB : void 0 : void 0 : void 0) || false;\n    if (isdocumentDB) {\n      if (array.length > 0) {\n        indexName = array.join(\".\");\n        object.name = indexName;\n        if (indexName.length > 52) {\n          object.name = indexName.substring(0, 52);\n        }\n      }\n    }\n    return object;\n  };\n}\n","Creator.appsByName = {}\r\n\r\n","Meteor.methods\r\n\t\"object_recent_viewed\": (object_name, record_id, space_id)->\r\n\t\tif !this.userId\r\n\t\t\treturn null\r\n\r\n\t\tif object_name == \"object_recent_viewed\"\r\n\t\t\treturn\r\n\t\tif object_name and record_id\r\n\t\t\tif !space_id\r\n\t\t\t\tdoc = Creator.getCollection(object_name).findOne({_id: record_id}, {fields: {space: 1}})\r\n\t\t\t\tspace_id = doc?.space\r\n\r\n\t\t\tcollection_recent_viewed = Creator.getCollection(\"object_recent_viewed\")\r\n\t\t\tfilters = { owner: this.userId, space: space_id, 'record.o': object_name, 'record.ids': [record_id]}\r\n\t\t\tcurrent_recent_viewed = collection_recent_viewed.findOne(filters)\r\n\t\t\tif current_recent_viewed\r\n\t\t\t\tcollection_recent_viewed.update(\r\n\t\t\t\t\tcurrent_recent_viewed._id,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$inc: {\r\n\t\t\t\t\t\t\tcount: 1\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\tmodified: new Date()\r\n\t\t\t\t\t\t\tmodified_by: this.userId\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t)\r\n\t\t\telse\r\n\t\t\t\tcollection_recent_viewed.insert(\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t_id: collection_recent_viewed._makeNewID()\r\n\t\t\t\t\t\towner: this.userId\r\n\t\t\t\t\t\tspace: space_id\r\n\t\t\t\t\t\trecord: {o: object_name, ids: [record_id]}\r\n\t\t\t\t\t\tcount: 1\r\n\t\t\t\t\t\tcreated: new Date()\r\n\t\t\t\t\t\tcreated_by: this.userId\r\n\t\t\t\t\t\tmodified: new Date()\r\n\t\t\t\t\t\tmodified_by: this.userId\r\n\t\t\t\t\t}\r\n\t\t\t\t)\r\n\t\t\treturn","Meteor.methods({\n  \"object_recent_viewed\": function(object_name, record_id, space_id) {\n    var collection_recent_viewed, current_recent_viewed, doc, filters;\n    if (!this.userId) {\n      return null;\n    }\n    if (object_name === \"object_recent_viewed\") {\n      return;\n    }\n    if (object_name && record_id) {\n      if (!space_id) {\n        doc = Creator.getCollection(object_name).findOne({\n          _id: record_id\n        }, {\n          fields: {\n            space: 1\n          }\n        });\n        space_id = doc != null ? doc.space : void 0;\n      }\n      collection_recent_viewed = Creator.getCollection(\"object_recent_viewed\");\n      filters = {\n        owner: this.userId,\n        space: space_id,\n        'record.o': object_name,\n        'record.ids': [record_id]\n      };\n      current_recent_viewed = collection_recent_viewed.findOne(filters);\n      if (current_recent_viewed) {\n        collection_recent_viewed.update(current_recent_viewed._id, {\n          $inc: {\n            count: 1\n          },\n          $set: {\n            modified: new Date(),\n            modified_by: this.userId\n          }\n        });\n      } else {\n        collection_recent_viewed.insert({\n          _id: collection_recent_viewed._makeNewID(),\n          owner: this.userId,\n          space: space_id,\n          record: {\n            o: object_name,\n            ids: [record_id]\n          },\n          count: 1,\n          created: new Date(),\n          created_by: this.userId,\n          modified: new Date(),\n          modified_by: this.userId\n        });\n      }\n    }\n  }\n});\n","recent_aggregate = (created_by, spaceId, _records, callback)->\r\n\tCreator.Collections.object_recent_viewed.rawCollection().aggregate([\r\n\t\t{$match: {created_by: created_by, space: spaceId}},\r\n\t\t{$group: {_id: {object_name: \"$record.o\", record_id: \"$record.ids\", space: \"$space\"}, maxCreated: {$max: \"$created\"}}},\r\n\t\t{$sort: {maxCreated: -1}},\r\n\t\t{$limit: 10}\r\n\t]).toArray (err, data)->\r\n\t\tif err\r\n\t\t\tthrow new Error(err)\r\n\r\n\t\tdata.forEach (doc) ->\r\n\t\t\t_records.push doc._id\r\n\r\n\t\tif callback && _.isFunction(callback)\r\n\t\t\tcallback()\r\n\r\n\t\treturn\r\n\r\nasync_recent_aggregate = Meteor.wrapAsync(recent_aggregate)\r\n\r\nsearch_object = (space, object_name,userId, searchText)->\r\n\tdata = new Array()\r\n\r\n\tif searchText\r\n\r\n\t\t_object = Creator.getObject(object_name)\r\n\r\n\t\t_object_collection = Creator.getCollection(object_name)\r\n\t\t_object_name_key = _object?.NAME_FIELD_KEY\r\n\t\tif _object && _object_collection && _object_name_key\r\n\t\t\tquery = {}\r\n\t\t\tsearch_Keywords = searchText.split(\" \")\r\n\t\t\tquery_and = []\r\n\t\t\tsearch_Keywords.forEach (keyword)->\r\n\t\t\t\tsubquery = {}\r\n\t\t\t\tsubquery[_object_name_key] = {$regex: keyword.trim()}\r\n\t\t\t\tquery_and.push subquery\r\n\r\n\t\t\tquery.$and = query_and\r\n\t\t\tquery.space = {$in: [space]}\r\n\r\n\t\t\tfields = {_id: 1}\r\n\t\t\tfields[_object_name_key] = 1\r\n\r\n\t\t\trecords = _object_collection.find(query, {fields: fields, sort: {modified: 1}, limit: 5})\r\n\r\n\t\t\trecords.forEach (record)->\r\n\t\t\t\tdata.push {_id: record._id, _name: record[_object_name_key], _object_name: object_name}\r\n\t\r\n\treturn data\r\n\r\nMeteor.methods\r\n\t'object_recent_record': (spaceId)->\r\n\t\tdata = new Array()\r\n\t\trecords = new Array()\r\n\t\tasync_recent_aggregate(this.userId, spaceId, records)\r\n\t\trecords.forEach (item)->\r\n\t\t\trecord_object = Creator.getObject(item.object_name, item.space)\r\n\r\n\t\t\tif !record_object\r\n\t\t\t\treturn\r\n\r\n\t\t\trecord_object_collection = Creator.getCollection(item.object_name, item.space)\r\n\r\n\t\t\tif record_object && record_object_collection\r\n\t\t\t\tfields = {_id: 1}\r\n\r\n\t\t\t\tfields[record_object.NAME_FIELD_KEY] = 1\r\n\r\n\t\t\t\trecord = record_object_collection.findOne(item.record_id[0], {fields: fields})\r\n\t\t\t\tif record\r\n\t\t\t\t\tdata.push {_id: record._id, _name: record[record_object.NAME_FIELD_KEY], _object_name: item.object_name}\r\n\r\n\t\treturn data\r\n\r\n\t'object_record_search': (options)->\r\n\t\tself = this\r\n\r\n\t\tdata = new Array()\r\n\r\n\t\tsearchText = options.searchText\r\n\t\tspace = options.space\r\n\r\n\t\t_.forEach Creator.objectsByName, (_object, name)->\r\n\t\t\tif _object.enable_search\r\n\t\t\t\tobject_record = search_object(space, _object.name, self.userId, searchText)\r\n\t\t\t\tdata = data.concat(object_record)\r\n\r\n\t\treturn data\r\n","var async_recent_aggregate, recent_aggregate, search_object;\n\nrecent_aggregate = function(created_by, spaceId, _records, callback) {\n  return Creator.Collections.object_recent_viewed.rawCollection().aggregate([\n    {\n      $match: {\n        created_by: created_by,\n        space: spaceId\n      }\n    }, {\n      $group: {\n        _id: {\n          object_name: \"$record.o\",\n          record_id: \"$record.ids\",\n          space: \"$space\"\n        },\n        maxCreated: {\n          $max: \"$created\"\n        }\n      }\n    }, {\n      $sort: {\n        maxCreated: -1\n      }\n    }, {\n      $limit: 10\n    }\n  ]).toArray(function(err, data) {\n    if (err) {\n      throw new Error(err);\n    }\n    data.forEach(function(doc) {\n      return _records.push(doc._id);\n    });\n    if (callback && _.isFunction(callback)) {\n      callback();\n    }\n  });\n};\n\nasync_recent_aggregate = Meteor.wrapAsync(recent_aggregate);\n\nsearch_object = function(space, object_name, userId, searchText) {\n  var _object, _object_collection, _object_name_key, data, fields, query, query_and, records, search_Keywords;\n  data = new Array();\n  if (searchText) {\n    _object = Creator.getObject(object_name);\n    _object_collection = Creator.getCollection(object_name);\n    _object_name_key = _object != null ? _object.NAME_FIELD_KEY : void 0;\n    if (_object && _object_collection && _object_name_key) {\n      query = {};\n      search_Keywords = searchText.split(\" \");\n      query_and = [];\n      search_Keywords.forEach(function(keyword) {\n        var subquery;\n        subquery = {};\n        subquery[_object_name_key] = {\n          $regex: keyword.trim()\n        };\n        return query_and.push(subquery);\n      });\n      query.$and = query_and;\n      query.space = {\n        $in: [space]\n      };\n      fields = {\n        _id: 1\n      };\n      fields[_object_name_key] = 1;\n      records = _object_collection.find(query, {\n        fields: fields,\n        sort: {\n          modified: 1\n        },\n        limit: 5\n      });\n      records.forEach(function(record) {\n        return data.push({\n          _id: record._id,\n          _name: record[_object_name_key],\n          _object_name: object_name\n        });\n      });\n    }\n  }\n  return data;\n};\n\nMeteor.methods({\n  'object_recent_record': function(spaceId) {\n    var data, records;\n    data = new Array();\n    records = new Array();\n    async_recent_aggregate(this.userId, spaceId, records);\n    records.forEach(function(item) {\n      var fields, record, record_object, record_object_collection;\n      record_object = Creator.getObject(item.object_name, item.space);\n      if (!record_object) {\n        return;\n      }\n      record_object_collection = Creator.getCollection(item.object_name, item.space);\n      if (record_object && record_object_collection) {\n        fields = {\n          _id: 1\n        };\n        fields[record_object.NAME_FIELD_KEY] = 1;\n        record = record_object_collection.findOne(item.record_id[0], {\n          fields: fields\n        });\n        if (record) {\n          return data.push({\n            _id: record._id,\n            _name: record[record_object.NAME_FIELD_KEY],\n            _object_name: item.object_name\n          });\n        }\n      }\n    });\n    return data;\n  },\n  'object_record_search': function(options) {\n    var data, searchText, self, space;\n    self = this;\n    data = new Array();\n    searchText = options.searchText;\n    space = options.space;\n    _.forEach(Creator.objectsByName, function(_object, name) {\n      var object_record;\n      if (_object.enable_search) {\n        object_record = search_object(space, _object.name, self.userId, searchText);\n        return data = data.concat(object_record);\n      }\n    });\n    return data;\n  }\n});\n","Meteor.methods\r\n    update_filters: (listview_id, filters, filter_scope, filter_logic)->\r\n        Creator.Collections.object_listviews.direct.update({_id: listview_id}, {$set: {filters: filters, filter_scope: filter_scope, filter_logic: filter_logic}})\r\n\r\n    update_columns: (listview_id, columns)->\r\n        check(columns, Array)\r\n        \r\n        if columns.length < 1\r\n            throw new Meteor.Error 400, \"Select at least one field to display\"\r\n        Creator.Collections.object_listviews.update({_id: listview_id}, {$set: {columns: columns}})\r\n","Meteor.methods({\n  update_filters: function(listview_id, filters, filter_scope, filter_logic) {\n    return Creator.Collections.object_listviews.direct.update({\n      _id: listview_id\n    }, {\n      $set: {\n        filters: filters,\n        filter_scope: filter_scope,\n        filter_logic: filter_logic\n      }\n    });\n  },\n  update_columns: function(listview_id, columns) {\n    check(columns, Array);\n    if (columns.length < 1) {\n      throw new Meteor.Error(400, \"Select at least one field to display\");\n    }\n    return Creator.Collections.object_listviews.update({\n      _id: listview_id\n    }, {\n      $set: {\n        columns: columns\n      }\n    });\n  }\n});\n","Meteor.methods\r\n\t'report_data': (options)->\r\n\t\tcheck(options, Object)\r\n\t\tspace = options.space\r\n\t\tfields = options.fields\r\n\t\tobject_name = options.object_name\r\n\t\tfilter_scope = options.filter_scope\r\n\t\tfilters = options.filters\r\n\t\tfilterFields = {}\r\n\t\tcompoundFields = []\r\n\t\tobjectFields = Creator.getObject(object_name)?.fields\r\n\t\t_.each fields, (item, index)->\r\n\t\t\tsplits = item.split(\".\")\r\n\t\t\tname = splits[0]\r\n\t\t\tobjectField = objectFields[name]\r\n\t\t\tif splits.length > 1 and objectField\r\n\t\t\t\tchildKey = item.replace name + \".\", \"\"\r\n\t\t\t\tcompoundFields.push({name: name, childKey: childKey, field: objectField})\r\n\t\t\tfilterFields[name] = 1\r\n\r\n\t\tselector = {}\r\n\t\tuserId = this.userId\r\n\t\tselector.space = space\r\n\t\tif filter_scope == \"spacex\"\r\n\t\t\tselector.space = \r\n\t\t\t\t$in: [null,space]\r\n\t\telse if filter_scope == \"mine\"\r\n\t\t\tselector.owner = userId\r\n\r\n\t\tif Creator.isCommonSpace(space) && Creator.isSpaceAdmin(space, @userId)\r\n\t\t\tdelete selector.space\r\n\r\n\t\tif filters and filters.length > 0\r\n\t\t\tselector[\"$and\"] = filters\r\n\r\n\t\tcursor = Creator.getCollection(object_name).find(selector, {fields: filterFields, skip: 0, limit: 10000})\r\n#\t\tif cursor.count() > 10000\r\n#\t\t\treturn []\r\n\t\tresult = cursor.fetch()\r\n\t\tif compoundFields.length\r\n\t\t\tresult = result.map (item,index)->\r\n\t\t\t\t_.each compoundFields, (compoundFieldItem, index)->\r\n\t\t\t\t\titemKey = compoundFieldItem.name + \"*%*\" + compoundFieldItem.childKey.replace(/\\./g, \"*%*\")\r\n\t\t\t\t\titemValue = item[compoundFieldItem.name]\r\n\t\t\t\t\ttype = compoundFieldItem.field.type\r\n\t\t\t\t\tif [\"lookup\", \"master_detail\"].indexOf(type) > -1\r\n\t\t\t\t\t\treference_to = compoundFieldItem.field.reference_to\r\n\t\t\t\t\t\tcompoundFilterFields = {}\r\n\t\t\t\t\t\tcompoundFilterFields[compoundFieldItem.childKey] = 1\r\n\t\t\t\t\t\treferenceItem = Creator.getCollection(reference_to).findOne {_id: itemValue}, fields: compoundFilterFields\r\n\t\t\t\t\t\tif referenceItem\r\n\t\t\t\t\t\t\titem[itemKey] = referenceItem[compoundFieldItem.childKey]\r\n\t\t\t\t\telse if type == \"select\"\r\n\t\t\t\t\t\toptions = compoundFieldItem.field.options\r\n\t\t\t\t\t\titem[itemKey] = _.findWhere(options, {value: itemValue})?.label or itemValue\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\titem[itemKey] = itemValue\r\n\t\t\t\t\tunless item[itemKey]\r\n\t\t\t\t\t\titem[itemKey] = \"--\"\r\n\t\t\t\treturn item\r\n\t\t\treturn result\r\n\t\telse\r\n\t\t\treturn result\r\n\r\n","Meteor.methods({\n  'report_data': function(options) {\n    var compoundFields, cursor, fields, filterFields, filter_scope, filters, objectFields, object_name, ref, result, selector, space, userId;\n    check(options, Object);\n    space = options.space;\n    fields = options.fields;\n    object_name = options.object_name;\n    filter_scope = options.filter_scope;\n    filters = options.filters;\n    filterFields = {};\n    compoundFields = [];\n    objectFields = (ref = Creator.getObject(object_name)) != null ? ref.fields : void 0;\n    _.each(fields, function(item, index) {\n      var childKey, name, objectField, splits;\n      splits = item.split(\".\");\n      name = splits[0];\n      objectField = objectFields[name];\n      if (splits.length > 1 && objectField) {\n        childKey = item.replace(name + \".\", \"\");\n        compoundFields.push({\n          name: name,\n          childKey: childKey,\n          field: objectField\n        });\n      }\n      return filterFields[name] = 1;\n    });\n    selector = {};\n    userId = this.userId;\n    selector.space = space;\n    if (filter_scope === \"spacex\") {\n      selector.space = {\n        $in: [null, space]\n      };\n    } else if (filter_scope === \"mine\") {\n      selector.owner = userId;\n    }\n    if (Creator.isCommonSpace(space) && Creator.isSpaceAdmin(space, this.userId)) {\n      delete selector.space;\n    }\n    if (filters && filters.length > 0) {\n      selector[\"$and\"] = filters;\n    }\n    cursor = Creator.getCollection(object_name).find(selector, {\n      fields: filterFields,\n      skip: 0,\n      limit: 10000\n    });\n    result = cursor.fetch();\n    if (compoundFields.length) {\n      result = result.map(function(item, index) {\n        _.each(compoundFields, function(compoundFieldItem, index) {\n          var compoundFilterFields, itemKey, itemValue, ref1, referenceItem, reference_to, type;\n          itemKey = compoundFieldItem.name + \"*%*\" + compoundFieldItem.childKey.replace(/\\./g, \"*%*\");\n          itemValue = item[compoundFieldItem.name];\n          type = compoundFieldItem.field.type;\n          if ([\"lookup\", \"master_detail\"].indexOf(type) > -1) {\n            reference_to = compoundFieldItem.field.reference_to;\n            compoundFilterFields = {};\n            compoundFilterFields[compoundFieldItem.childKey] = 1;\n            referenceItem = Creator.getCollection(reference_to).findOne({\n              _id: itemValue\n            }, {\n              fields: compoundFilterFields\n            });\n            if (referenceItem) {\n              item[itemKey] = referenceItem[compoundFieldItem.childKey];\n            }\n          } else if (type === \"select\") {\n            options = compoundFieldItem.field.options;\n            item[itemKey] = ((ref1 = _.findWhere(options, {\n              value: itemValue\n            })) != null ? ref1.label : void 0) || itemValue;\n          } else {\n            item[itemKey] = itemValue;\n          }\n          if (!item[itemKey]) {\n            return item[itemKey] = \"--\";\n          }\n        });\n        return item;\n      });\n      return result;\n    } else {\n      return result;\n    }\n  }\n});\n","###\r\n    type: \"user\"\r\n    object_name: \"object_listviews\"\r\n    record_id: \"{object_name},{listview_id}\"\r\n    settings:\r\n        column_width: { field_a: 100, field_2: 150 }\r\n        sort: [[\"field_a\", \"desc\"]]\r\n    owner: {userId}\r\n###\r\n\r\nMeteor.methods\r\n    \"tabular_sort_settings\": (object_name, list_view_id, sort)->\r\n        userId = this.userId\r\n        setting = Creator.Collections.settings.findOne({object_name: object_name, record_id: \"object_listviews\", owner: userId})\r\n        if setting\r\n            Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.sort\": sort}})\r\n        else\r\n            doc = \r\n                type: \"user\"\r\n                object_name: object_name\r\n                record_id: \"object_listviews\"\r\n                settings: {}\r\n                owner: userId\r\n\r\n            doc.settings[list_view_id] = {}\r\n            doc.settings[list_view_id].sort = sort\r\n\r\n            Creator.Collections.settings.insert(doc)\r\n\r\n    \"tabular_column_width_settings\": (object_name, list_view_id, column_width)->\r\n        userId = this.userId\r\n        setting = Creator.Collections.settings.findOne({object_name: object_name, record_id: \"object_listviews\", owner: userId})\r\n        if setting\r\n            Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.column_width\": column_width}})\r\n        else\r\n            doc = \r\n                type: \"user\"\r\n                object_name: object_name\r\n                record_id: \"object_listviews\"\r\n                settings: {}\r\n                owner: userId\r\n\r\n            doc.settings[list_view_id] = {}\r\n            doc.settings[list_view_id].column_width = column_width\r\n\r\n            Creator.Collections.settings.insert(doc)\r\n\r\n    \"grid_settings\": (object_name, list_view_id, column_width, sort)->\r\n        userId = this.userId\r\n        setting = Creator.Collections.settings.findOne({object_name: object_name, record_id: \"object_gridviews\", owner: userId})\r\n        if setting\r\n            # æ¯æ¬¡éƒ½å¼ºåˆ¶æ”¹å˜_id_actionsåˆ—çš„å®½åº¦ï¼Œä»¥è§£å†³å½“ç”¨æˆ·åªæ”¹å˜å­—æ®µæ¬¡åºè€Œæ²¡æœ‰æ”¹å˜ä»»ä½•å­—æ®µå®½åº¦æ—¶ï¼Œå‰ç«¯æ²¡æœ‰è®¢é˜…åˆ°å­—æ®µæ¬¡åºå˜æ›´çš„æ•°æ®çš„é—®é¢˜\r\n            column_width._id_actions = if setting.settings[\"#{list_view_id}\"]?.column_width?._id_actions == 46 then 47 else 46\r\n            if sort\r\n                Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.sort\": sort, \"settings.#{list_view_id}.column_width\": column_width}})\r\n            else\r\n                Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.column_width\": column_width}})\r\n        else\r\n            doc =\r\n                type: \"user\"\r\n                object_name: object_name\r\n                record_id: \"object_gridviews\"\r\n                settings: {}\r\n                owner: userId\r\n            \r\n            doc.settings[list_view_id] = {}\r\n            doc.settings[list_view_id].column_width = column_width\r\n            doc.settings[list_view_id].sort = sort\r\n\r\n            Creator.Collections.settings.insert(doc)","\n/*\n    type: \"user\"\n    object_name: \"object_listviews\"\n    record_id: \"{object_name},{listview_id}\"\n    settings:\n        column_width: { field_a: 100, field_2: 150 }\n        sort: [[\"field_a\", \"desc\"]]\n    owner: {userId}\n */\nMeteor.methods({\n  \"tabular_sort_settings\": function(object_name, list_view_id, sort) {\n    var doc, obj, setting, userId;\n    userId = this.userId;\n    setting = Creator.Collections.settings.findOne({\n      object_name: object_name,\n      record_id: \"object_listviews\",\n      owner: userId\n    });\n    if (setting) {\n      return Creator.Collections.settings.update({\n        _id: setting._id\n      }, {\n        $set: (\n          obj = {},\n          obj[\"settings.\" + list_view_id + \".sort\"] = sort,\n          obj\n        )\n      });\n    } else {\n      doc = {\n        type: \"user\",\n        object_name: object_name,\n        record_id: \"object_listviews\",\n        settings: {},\n        owner: userId\n      };\n      doc.settings[list_view_id] = {};\n      doc.settings[list_view_id].sort = sort;\n      return Creator.Collections.settings.insert(doc);\n    }\n  },\n  \"tabular_column_width_settings\": function(object_name, list_view_id, column_width) {\n    var doc, obj, setting, userId;\n    userId = this.userId;\n    setting = Creator.Collections.settings.findOne({\n      object_name: object_name,\n      record_id: \"object_listviews\",\n      owner: userId\n    });\n    if (setting) {\n      return Creator.Collections.settings.update({\n        _id: setting._id\n      }, {\n        $set: (\n          obj = {},\n          obj[\"settings.\" + list_view_id + \".column_width\"] = column_width,\n          obj\n        )\n      });\n    } else {\n      doc = {\n        type: \"user\",\n        object_name: object_name,\n        record_id: \"object_listviews\",\n        settings: {},\n        owner: userId\n      };\n      doc.settings[list_view_id] = {};\n      doc.settings[list_view_id].column_width = column_width;\n      return Creator.Collections.settings.insert(doc);\n    }\n  },\n  \"grid_settings\": function(object_name, list_view_id, column_width, sort) {\n    var doc, obj, obj1, ref, ref1, setting, userId;\n    userId = this.userId;\n    setting = Creator.Collections.settings.findOne({\n      object_name: object_name,\n      record_id: \"object_gridviews\",\n      owner: userId\n    });\n    if (setting) {\n      column_width._id_actions = ((ref = setting.settings[\"\" + list_view_id]) != null ? (ref1 = ref.column_width) != null ? ref1._id_actions : void 0 : void 0) === 46 ? 47 : 46;\n      if (sort) {\n        return Creator.Collections.settings.update({\n          _id: setting._id\n        }, {\n          $set: (\n            obj = {},\n            obj[\"settings.\" + list_view_id + \".sort\"] = sort,\n            obj[\"settings.\" + list_view_id + \".column_width\"] = column_width,\n            obj\n          )\n        });\n      } else {\n        return Creator.Collections.settings.update({\n          _id: setting._id\n        }, {\n          $set: (\n            obj1 = {},\n            obj1[\"settings.\" + list_view_id + \".column_width\"] = column_width,\n            obj1\n          )\n        });\n      }\n    } else {\n      doc = {\n        type: \"user\",\n        object_name: object_name,\n        record_id: \"object_gridviews\",\n        settings: {},\n        owner: userId\n      };\n      doc.settings[list_view_id] = {};\n      doc.settings[list_view_id].column_width = column_width;\n      doc.settings[list_view_id].sort = sort;\n      return Creator.Collections.settings.insert(doc);\n    }\n  }\n});\n","xml2js = require 'xml2js'\r\nfs = require 'fs'\r\npath = require 'path'\r\nmkdirp = require 'mkdirp'\r\n\r\nlogger = new Logger 'Export_TO_XML'\r\n\r\n_writeXmlFile = (jsonObj,objName) ->\r\n\t# è½¬xml\r\n\tbuilder = new xml2js.Builder()\r\n\txml = builder.buildObject jsonObj\r\n\r\n\t# è½¬ä¸ºbuffer\r\n\tstream = new Buffer xml\r\n\r\n\t# æ ¹æ®å½“å¤©æ—¶é—´çš„å¹´æœˆæ—¥ä½œä¸ºå­˜å‚¨è·¯å¾„\r\n\tnow = new Date\r\n\tyear = now.getFullYear()\r\n\tmonth = now.getMonth() + 1\r\n\tday = now.getDate()\r\n\r\n\t# æ–‡ä»¶è·¯å¾„\r\n\tfilePath = path.join(__meteor_bootstrap__.serverDir,'../../../export/' + year + '/' + month + '/' + day + '/' + objName )\r\n\tfileName = jsonObj?._id + \".xml\"\r\n\tfileAddress = path.join filePath, fileName\r\n\r\n\tif !fs.existsSync filePath\r\n\t\tmkdirp.sync filePath\r\n\r\n\t# å†™å…¥æ–‡ä»¶\r\n\tfs.writeFile fileAddress, stream, (err) ->\r\n\t\tif err\r\n\t\t\tlogger.error \"#{jsonObj._id}å†™å…¥xmlæ–‡ä»¶å¤±è´¥\",err\r\n\t\r\n\treturn filePath\r\n\r\n\r\n# æ•´ç†Fieldsçš„jsonæ•°æ®\r\n_mixFieldsData = (obj,objName) ->\r\n\t# åˆå§‹åŒ–å¯¹è±¡æ•°æ®\r\n\tjsonObj = {}\r\n\t# èŽ·å–fields\r\n\tobjFields = Creator?.getObject(objName)?.fields\r\n\r\n\tmixDefault = (field_name)->\r\n\t\tjsonObj[field_name] = obj[field_name] || \"\"\r\n\r\n\tmixDate = (field_name,type)->\r\n\t\tdate = obj[field_name]\r\n\t\tif type == \"date\"\r\n\t\t\tformat = \"YYYY-MM-DD\"\r\n\t\telse\r\n\t\t\tformat = \"YYYY-MM-DD HH:mm:ss\"\r\n\t\tif date? and format?\r\n\t\t\tdateStr = moment(date).format(format)\r\n\t\tjsonObj[field_name] = dateStr || \"\"\r\n\r\n\tmixBool = (field_name)->\r\n\t\tif obj[field_name] == true\r\n\t\t\tjsonObj[field_name] = \"æ˜¯\"\r\n\t\telse if obj[field_name] == false\r\n\t\t\tjsonObj[field_name] = \"å¦\"\r\n\t\telse\r\n\t\t\tjsonObj[field_name] = \"\"\r\n\r\n\t# å¾ªçŽ¯æ¯ä¸ªfields,å¹¶åˆ¤æ–­å–å€¼\r\n\t_.each objFields, (field, field_name)->\r\n\t\tswitch field?.type\r\n\t\t\twhen \"date\",\"datetime\" then mixDate field_name,field.type\r\n\t\t\twhen \"boolean\" then mixBool field_name\r\n\t\t\telse mixDefault field_name\r\n\r\n\treturn jsonObj\r\n\r\n# èŽ·å–å­è¡¨æ•´ç†æ•°æ®\r\n_mixRelatedData = (obj,objName) ->\r\n\t# åˆå§‹åŒ–å¯¹è±¡æ•°æ®\r\n\trelated_objects = {}\r\n\r\n\t# èŽ·å–ç›¸å…³è¡¨\r\n\trelatedObjNames = Creator?.getAllRelatedObjects objName\r\n\r\n\t# å¾ªçŽ¯ç›¸å…³è¡¨\r\n\trelatedObjNames.forEach (relatedObjName) ->\r\n\t\t# æ¯ä¸ªè¡¨å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ•°ç»„\r\n\t\trelatedTableData = []\r\n\r\n\t\t# *è®¾ç½®å…³è”æœç´¢æŸ¥è¯¢çš„å­—æ®µ\r\n\t\t# é™„ä»¶çš„å…³è”æœç´¢å­—æ®µæ˜¯å®šæ­»çš„\r\n\t\tif relatedObjName == \"cms_files\"\r\n\t\t\trelated_field_name = \"parent.ids\"\r\n\t\telse\r\n\t\t\t# èŽ·å–fields\r\n\t\t\tfields = Creator?.Objects[relatedObjName]?.fields\r\n\t\t\t# å¾ªçŽ¯æ¯ä¸ªfield,æ‰¾å‡ºreference_toçš„å…³è”å­—æ®µ\r\n\t\t\trelated_field_name = \"\"\r\n\t\t\t_.each fields, (field, field_name)->\r\n\t\t\t\tif field?.reference_to == objName\r\n\t\t\t\t\trelated_field_name = field_name\r\n\r\n\t\t# æ ¹æ®æ‰¾å‡ºçš„å…³è”å­—æ®µï¼ŒæŸ¥å­è¡¨æ•°æ®\r\n\t\tif related_field_name\r\n\t\t\trelatedCollection = Creator.getCollection(relatedObjName)\r\n\t\t\t# èŽ·å–åˆ°æ‰€æœ‰çš„æ•°æ®\r\n\t\t\trelatedRecordList = relatedCollection.find({\"#{related_field_name}\":obj._id}).fetch()\r\n\t\t\t# å¾ªçŽ¯æ¯ä¸€æ¡æ•°æ®\r\n\t\t\trelatedRecordList.forEach (relatedObj)->\r\n\t\t\t\t# æ•´åˆfieldsæ•°æ®\r\n\t\t\t\tfieldsData = _mixFieldsData relatedObj,relatedObjName\r\n\t\t\t\t# æŠŠä¸€æ¡è®°å½•æ’å…¥åˆ°å¯¹è±¡æ•°ç»„ä¸­\r\n\t\t\t\trelatedTableData.push fieldsData\r\n\r\n\t\t# æŠŠä¸€ä¸ªå­è¡¨çš„æ‰€æœ‰æ•°æ®æ’å…¥åˆ°related_objectsä¸­ï¼Œå†å¾ªçŽ¯ä¸‹ä¸€ä¸ª\r\n\t\trelated_objects[relatedObjName] = relatedTableData\r\n\r\n\treturn related_objects\r\n\r\n# Creator.Export2xml()\r\nCreator.Export2xml = (objName, recordList) ->\r\n\tlogger.info \"Run Creator.Export2xml\"\r\n\r\n\tconsole.time \"Creator.Export2xml\"\r\n\r\n\t# æµ‹è¯•æ•°æ®\r\n\t# objName = \"archive_records\"\r\n\r\n\t# æŸ¥æ‰¾å¯¹è±¡æ•°æ®\r\n\tcollection = Creator.getCollection(objName)\r\n\t# æµ‹è¯•æ•°æ®\r\n\trecordList = collection.find({}).fetch()\r\n\r\n\trecordList.forEach (recordObj)->\r\n\t\tjsonObj = {}\r\n\t\tjsonObj._id = recordObj._id\r\n\r\n\t\t# æ•´ç†ä¸»è¡¨çš„Fieldsæ•°æ®\r\n\t\tfieldsData = _mixFieldsData recordObj,objName\r\n\t\tjsonObj[objName] = fieldsData\r\n\r\n\t\t# æ•´ç†ç›¸å…³è¡¨æ•°æ®\r\n\t\trelated_objects = _mixRelatedData recordObj,objName\r\n\r\n\t\tjsonObj[\"related_objects\"] = related_objects\r\n\r\n\t\t# è½¬ä¸ºxmlä¿å­˜æ–‡ä»¶\r\n\t\tfilePath = _writeXmlFile jsonObj,objName\r\n\r\n\tconsole.timeEnd \"Creator.Export2xml\"\r\n\treturn filePath","var _mixFieldsData, _mixRelatedData, _writeXmlFile, fs, logger, mkdirp, path, xml2js;\n\nxml2js = require('xml2js');\n\nfs = require('fs');\n\npath = require('path');\n\nmkdirp = require('mkdirp');\n\nlogger = new Logger('Export_TO_XML');\n\n_writeXmlFile = function(jsonObj, objName) {\n  var builder, day, fileAddress, fileName, filePath, month, now, stream, xml, year;\n  builder = new xml2js.Builder();\n  xml = builder.buildObject(jsonObj);\n  stream = new Buffer(xml);\n  now = new Date;\n  year = now.getFullYear();\n  month = now.getMonth() + 1;\n  day = now.getDate();\n  filePath = path.join(__meteor_bootstrap__.serverDir, '../../../export/' + year + '/' + month + '/' + day + '/' + objName);\n  fileName = (jsonObj != null ? jsonObj._id : void 0) + \".xml\";\n  fileAddress = path.join(filePath, fileName);\n  if (!fs.existsSync(filePath)) {\n    mkdirp.sync(filePath);\n  }\n  fs.writeFile(fileAddress, stream, function(err) {\n    if (err) {\n      return logger.error(jsonObj._id + \"å†™å…¥xmlæ–‡ä»¶å¤±è´¥\", err);\n    }\n  });\n  return filePath;\n};\n\n_mixFieldsData = function(obj, objName) {\n  var jsonObj, mixBool, mixDate, mixDefault, objFields, ref;\n  jsonObj = {};\n  objFields = typeof Creator !== \"undefined\" && Creator !== null ? (ref = Creator.getObject(objName)) != null ? ref.fields : void 0 : void 0;\n  mixDefault = function(field_name) {\n    return jsonObj[field_name] = obj[field_name] || \"\";\n  };\n  mixDate = function(field_name, type) {\n    var date, dateStr, format;\n    date = obj[field_name];\n    if (type === \"date\") {\n      format = \"YYYY-MM-DD\";\n    } else {\n      format = \"YYYY-MM-DD HH:mm:ss\";\n    }\n    if ((date != null) && (format != null)) {\n      dateStr = moment(date).format(format);\n    }\n    return jsonObj[field_name] = dateStr || \"\";\n  };\n  mixBool = function(field_name) {\n    if (obj[field_name] === true) {\n      return jsonObj[field_name] = \"æ˜¯\";\n    } else if (obj[field_name] === false) {\n      return jsonObj[field_name] = \"å¦\";\n    } else {\n      return jsonObj[field_name] = \"\";\n    }\n  };\n  _.each(objFields, function(field, field_name) {\n    switch (field != null ? field.type : void 0) {\n      case \"date\":\n      case \"datetime\":\n        return mixDate(field_name, field.type);\n      case \"boolean\":\n        return mixBool(field_name);\n      default:\n        return mixDefault(field_name);\n    }\n  });\n  return jsonObj;\n};\n\n_mixRelatedData = function(obj, objName) {\n  var relatedObjNames, related_objects;\n  related_objects = {};\n  relatedObjNames = typeof Creator !== \"undefined\" && Creator !== null ? Creator.getAllRelatedObjects(objName) : void 0;\n  relatedObjNames.forEach(function(relatedObjName) {\n    var fields, obj1, ref, relatedCollection, relatedRecordList, relatedTableData, related_field_name;\n    relatedTableData = [];\n    if (relatedObjName === \"cms_files\") {\n      related_field_name = \"parent.ids\";\n    } else {\n      fields = typeof Creator !== \"undefined\" && Creator !== null ? (ref = Creator.Objects[relatedObjName]) != null ? ref.fields : void 0 : void 0;\n      related_field_name = \"\";\n      _.each(fields, function(field, field_name) {\n        if ((field != null ? field.reference_to : void 0) === objName) {\n          return related_field_name = field_name;\n        }\n      });\n    }\n    if (related_field_name) {\n      relatedCollection = Creator.getCollection(relatedObjName);\n      relatedRecordList = relatedCollection.find((\n        obj1 = {},\n        obj1[\"\" + related_field_name] = obj._id,\n        obj1\n      )).fetch();\n      relatedRecordList.forEach(function(relatedObj) {\n        var fieldsData;\n        fieldsData = _mixFieldsData(relatedObj, relatedObjName);\n        return relatedTableData.push(fieldsData);\n      });\n    }\n    return related_objects[relatedObjName] = relatedTableData;\n  });\n  return related_objects;\n};\n\nCreator.Export2xml = function(objName, recordList) {\n  var collection;\n  logger.info(\"Run Creator.Export2xml\");\n  console.time(\"Creator.Export2xml\");\n  collection = Creator.getCollection(objName);\n  recordList = collection.find({}).fetch();\n  recordList.forEach(function(recordObj) {\n    var fieldsData, filePath, jsonObj, related_objects;\n    jsonObj = {};\n    jsonObj._id = recordObj._id;\n    fieldsData = _mixFieldsData(recordObj, objName);\n    jsonObj[objName] = fieldsData;\n    related_objects = _mixRelatedData(recordObj, objName);\n    jsonObj[\"related_objects\"] = related_objects;\n    return filePath = _writeXmlFile(jsonObj, objName);\n  });\n  console.timeEnd(\"Creator.Export2xml\");\n  return filePath;\n};\n","Meteor.methods \r\n\trelated_objects_records: (object_name, related_object_name, related_field_name, record_id, spaceId)->\r\n\t\tuserId = this.userId\r\n\t\tif related_object_name == \"cfs.files.filerecord\"\r\n\t\t\tselector = {\"metadata.space\": spaceId}\r\n\t\telse\r\n\t\t\tselector = {space: spaceId}\r\n\t\t\r\n\t\tif related_object_name == \"cms_files\"\r\n\t\t\t# é™„ä»¶çš„å…³è”æœç´¢æ¡ä»¶æ˜¯å®šæ­»çš„\r\n\t\t\tselector[\"parent.o\"] = object_name\r\n\t\t\tselector[\"parent.ids\"] = [record_id]\r\n\t\telse\r\n\t\t\tselector[related_field_name] = record_id\r\n\r\n\t\tpermissions = Creator.getPermissions(related_object_name, spaceId, userId)\r\n\t\tif !permissions.viewAllRecords and permissions.allowRead\r\n\t\t\tselector.owner = userId\r\n\t\t\r\n\t\trelated_records = Creator.getCollection(related_object_name).find(selector)\r\n\t\treturn related_records.count()","Meteor.methods({\n  related_objects_records: function(object_name, related_object_name, related_field_name, record_id, spaceId) {\n    var permissions, related_records, selector, userId;\n    userId = this.userId;\n    if (related_object_name === \"cfs.files.filerecord\") {\n      selector = {\n        \"metadata.space\": spaceId\n      };\n    } else {\n      selector = {\n        space: spaceId\n      };\n    }\n    if (related_object_name === \"cms_files\") {\n      selector[\"parent.o\"] = object_name;\n      selector[\"parent.ids\"] = [record_id];\n    } else {\n      selector[related_field_name] = record_id;\n    }\n    permissions = Creator.getPermissions(related_object_name, spaceId, userId);\n    if (!permissions.viewAllRecords && permissions.allowRead) {\n      selector.owner = userId;\n    }\n    related_records = Creator.getCollection(related_object_name).find(selector);\n    return related_records.count();\n  }\n});\n","Meteor.methods\r\n\tgetPendingSpaceInfo: (inviterId, spaceId)->\r\n\t\tinviterName = db.users.findOne({_id: inviterId}).name\r\n\t\tspaceName = db.spaces.findOne({_id: spaceId}).name\r\n\r\n\t\treturn {inviter: inviterName, space: spaceName}\r\n\r\n\trefuseJoinSpace: (_id)->\r\n\t\tdb.space_users.direct.update({_id: _id},{$set: {invite_state: \"refused\"}})\r\n\r\n\tacceptJoinSpace: (_id)->\r\n\t\tdb.space_users.direct.update({_id: _id},{$set: {invite_state: \"accepted\", user_accepted: true}})\r\n\r\n","Meteor.methods({\n  getPendingSpaceInfo: function(inviterId, spaceId) {\n    var inviterName, spaceName;\n    inviterName = db.users.findOne({\n      _id: inviterId\n    }).name;\n    spaceName = db.spaces.findOne({\n      _id: spaceId\n    }).name;\n    return {\n      inviter: inviterName,\n      space: spaceName\n    };\n  },\n  refuseJoinSpace: function(_id) {\n    return db.space_users.direct.update({\n      _id: _id\n    }, {\n      $set: {\n        invite_state: \"refused\"\n      }\n    });\n  },\n  acceptJoinSpace: function(_id) {\n    return db.space_users.direct.update({\n      _id: _id\n    }, {\n      $set: {\n        invite_state: \"accepted\",\n        user_accepted: true\n      }\n    });\n  }\n});\n","Meteor.publish \"creator_object_record\", (object_name, id, space_id)->\r\n\tcollection = Creator.getCollection(object_name, space_id)\r\n\tif collection\r\n\t\treturn collection.find({_id: id})\r\n\r\n","Meteor.publish(\"creator_object_record\", function(object_name, id, space_id) {\n  var collection;\n  collection = Creator.getCollection(object_name, space_id);\n  if (collection) {\n    return collection.find({\n      _id: id\n    });\n  }\n});\n","Meteor.publishComposite \"steedos_object_tabular\", (tableName, ids, fields, spaceId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tcheck(tableName, String);\r\n\tcheck(ids, Array);\r\n\tcheck(fields, Match.Optional(Object));\r\n\r\n\t_object_name = tableName.replace(\"creator_\",\"\")\r\n\t_object = Creator.getObject(_object_name, spaceId)\r\n\r\n\tif spaceId\r\n\t\t_object_name = Creator.getObjectName(_object)\r\n\r\n\tobject_colleciton = Creator.getCollection(_object_name)\r\n\r\n\r\n\t_fields = _object?.fields\r\n\tif !_fields || !object_colleciton\r\n\t\treturn this.ready()\r\n\r\n\treference_fields = _.filter _fields, (f)->\r\n\t\treturn _.isFunction(f.reference_to) || !_.isEmpty(f.reference_to)\r\n\r\n\tself = this\r\n\r\n\tself.unblock();\r\n\r\n\tif reference_fields.length > 0\r\n\t\tdata = {\r\n\t\t\tfind: ()->\r\n\t\t\t\tself.unblock();\r\n\t\t\t\tfield_keys = {}\r\n\t\t\t\t_.each _.keys(fields), (f)->\r\n\t\t\t\t\tunless /\\w+(\\.\\$){1}\\w?/.test(f)\r\n\t\t\t\t\t\tfield_keys[f] = 1\r\n\t\t\t\t\r\n\t\t\t\treturn object_colleciton.find({_id: {$in: ids}}, {fields: field_keys});\r\n\t\t}\r\n\r\n\t\tdata.children = []\r\n\r\n\t\tkeys = _.keys(fields)\r\n\r\n\t\tif keys.length < 1\r\n\t\t\tkeys = _.keys(_fields)\r\n\r\n\t\t_keys = []\r\n\r\n\t\tkeys.forEach (key)->\r\n\t\t\tif _object.schema._objectKeys[key + '.']\r\n\t\t\t\t_keys = _keys.concat(_.map(_object.schema._objectKeys[key + '.'], (k)->\r\n\t\t\t\t\treturn key + '.' + k\r\n\t\t\t\t))\r\n\t\t\t_keys.push(key)\r\n\r\n\t\t_keys.forEach (key)->\r\n\t\t\treference_field = _fields[key]\r\n\r\n\t\t\tif reference_field && (_.isFunction(reference_field.reference_to) || !_.isEmpty(reference_field.reference_to))  # and Creator.Collections[reference_field.reference_to]\r\n\t\t\t\tdata.children.push {\r\n\t\t\t\t\tfind: (parent) ->\r\n\t\t\t\t\t\ttry\r\n\t\t\t\t\t\t\tself.unblock();\r\n\r\n\t\t\t\t\t\t\tquery = {}\r\n\r\n\t\t\t\t\t\t\t# è¡¨æ ¼å­å­—æ®µç‰¹æ®Šå¤„ç†\r\n\t\t\t\t\t\t\tif /\\w+(\\.\\$\\.){1}\\w+/.test(key)\r\n\t\t\t\t\t\t\t\tp_k = key.replace(/(\\w+)\\.\\$\\.\\w+/ig, \"$1\")\r\n\t\t\t\t\t\t\t\ts_k = key.replace(/\\w+\\.\\$\\.(\\w+)/ig, \"$1\")\r\n\t\t\t\t\t\t\t\treference_ids = parent[p_k].getProperty(s_k)\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\treference_ids = key.split('.').reduce (o, x) ->\r\n\t\t\t\t\t\t\t\t\t\to?[x]\r\n\t\t\t\t\t\t\t\t, parent\r\n\r\n\t\t\t\t\t\t\treference_to = reference_field.reference_to\r\n\r\n\t\t\t\t\t\t\tif _.isFunction(reference_to)\r\n\t\t\t\t\t\t\t\treference_to = reference_to()\r\n\r\n\t\t\t\t\t\t\tif _.isArray(reference_to)\r\n\t\t\t\t\t\t\t\tif _.isObject(reference_ids) && !_.isArray(reference_ids)\r\n\t\t\t\t\t\t\t\t\treference_to = reference_ids.o\r\n\t\t\t\t\t\t\t\t\treference_ids = reference_ids.ids || []\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\treturn []\r\n\r\n\t\t\t\t\t\t\tif _.isArray(reference_ids)\r\n\t\t\t\t\t\t\t\tquery._id = {$in: reference_ids}\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tquery._id = reference_ids\r\n\r\n\t\t\t\t\t\t\treference_to_object = Creator.getObject(reference_to, spaceId)\r\n\r\n\t\t\t\t\t\t\tname_field_key = reference_to_object.NAME_FIELD_KEY\r\n\r\n\t\t\t\t\t\t\tchildren_fields = {_id: 1, space: 1}\r\n\r\n\t\t\t\t\t\t\tif name_field_key\r\n\t\t\t\t\t\t\t\tchildren_fields[name_field_key] = 1\r\n\r\n\t\t\t\t\t\t\treturn Creator.getCollection(reference_to, spaceId).find(query, {\r\n\t\t\t\t\t\t\t\tfields: children_fields\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\tcatch e\r\n\t\t\t\t\t\t\tconsole.log(reference_to, parent, e)\r\n\t\t\t\t\t\t\treturn []\r\n\t\t\t\t}\r\n\r\n\t\treturn data\r\n\telse\r\n\t\treturn {\r\n\t\t\tfind: ()->\r\n\t\t\t\tself.unblock();\r\n\t\t\t\treturn object_colleciton.find({_id: {$in: ids}}, {fields: fields})\r\n\t\t};\r\n\r\n","Meteor.publishComposite(\"steedos_object_tabular\", function(tableName, ids, fields, spaceId) {\n  var _fields, _keys, _object, _object_name, data, keys, object_colleciton, reference_fields, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  _object_name = tableName.replace(\"creator_\", \"\");\n  _object = Creator.getObject(_object_name, spaceId);\n  if (spaceId) {\n    _object_name = Creator.getObjectName(_object);\n  }\n  object_colleciton = Creator.getCollection(_object_name);\n  _fields = _object != null ? _object.fields : void 0;\n  if (!_fields || !object_colleciton) {\n    return this.ready();\n  }\n  reference_fields = _.filter(_fields, function(f) {\n    return _.isFunction(f.reference_to) || !_.isEmpty(f.reference_to);\n  });\n  self = this;\n  self.unblock();\n  if (reference_fields.length > 0) {\n    data = {\n      find: function() {\n        var field_keys;\n        self.unblock();\n        field_keys = {};\n        _.each(_.keys(fields), function(f) {\n          if (!/\\w+(\\.\\$){1}\\w?/.test(f)) {\n            return field_keys[f] = 1;\n          }\n        });\n        return object_colleciton.find({\n          _id: {\n            $in: ids\n          }\n        }, {\n          fields: field_keys\n        });\n      }\n    };\n    data.children = [];\n    keys = _.keys(fields);\n    if (keys.length < 1) {\n      keys = _.keys(_fields);\n    }\n    _keys = [];\n    keys.forEach(function(key) {\n      if (_object.schema._objectKeys[key + '.']) {\n        _keys = _keys.concat(_.map(_object.schema._objectKeys[key + '.'], function(k) {\n          return key + '.' + k;\n        }));\n      }\n      return _keys.push(key);\n    });\n    _keys.forEach(function(key) {\n      var reference_field;\n      reference_field = _fields[key];\n      if (reference_field && (_.isFunction(reference_field.reference_to) || !_.isEmpty(reference_field.reference_to))) {\n        return data.children.push({\n          find: function(parent) {\n            var children_fields, e, name_field_key, p_k, query, reference_ids, reference_to, reference_to_object, s_k;\n            try {\n              self.unblock();\n              query = {};\n              if (/\\w+(\\.\\$\\.){1}\\w+/.test(key)) {\n                p_k = key.replace(/(\\w+)\\.\\$\\.\\w+/ig, \"$1\");\n                s_k = key.replace(/\\w+\\.\\$\\.(\\w+)/ig, \"$1\");\n                reference_ids = parent[p_k].getProperty(s_k);\n              } else {\n                reference_ids = key.split('.').reduce(function(o, x) {\n                  return o != null ? o[x] : void 0;\n                }, parent);\n              }\n              reference_to = reference_field.reference_to;\n              if (_.isFunction(reference_to)) {\n                reference_to = reference_to();\n              }\n              if (_.isArray(reference_to)) {\n                if (_.isObject(reference_ids) && !_.isArray(reference_ids)) {\n                  reference_to = reference_ids.o;\n                  reference_ids = reference_ids.ids || [];\n                } else {\n                  return [];\n                }\n              }\n              if (_.isArray(reference_ids)) {\n                query._id = {\n                  $in: reference_ids\n                };\n              } else {\n                query._id = reference_ids;\n              }\n              reference_to_object = Creator.getObject(reference_to, spaceId);\n              name_field_key = reference_to_object.NAME_FIELD_KEY;\n              children_fields = {\n                _id: 1,\n                space: 1\n              };\n              if (name_field_key) {\n                children_fields[name_field_key] = 1;\n              }\n              return Creator.getCollection(reference_to, spaceId).find(query, {\n                fields: children_fields\n              });\n            } catch (error) {\n              e = error;\n              console.log(reference_to, parent, e);\n              return [];\n            }\n          }\n        });\n      }\n    });\n    return data;\n  } else {\n    return {\n      find: function() {\n        self.unblock();\n        return object_colleciton.find({\n          _id: {\n            $in: ids\n          }\n        }, {\n          fields: fields\n        });\n      }\n    };\n  }\n});\n","Meteor.publish \"object_listviews\", (object_name, spaceId)->\r\n    userId = this.userId\r\n    return Creator.getCollection(\"object_listviews\").find({object_name: object_name, space: spaceId ,\"$or\":[{owner: userId}, {shared: true}]})","Meteor.publish \"user_tabular_settings\", (object_name)->\r\n    userId = this.userId\r\n    return Creator.Collections.settings.find({object_name: {$in: object_name}, record_id: {$in: [\"object_listviews\", \"object_gridviews\"]}, owner: userId})\r\n","Meteor.publish \"related_objects_records\", (object_name, related_object_name, related_field_name, record_id, spaceId)->\r\n\tuserId = this.userId\r\n\tif related_object_name == \"cfs.files.filerecord\"\r\n\t\tselector = {\"metadata.space\": spaceId}\r\n\telse\r\n\t\tselector = {space: spaceId}\r\n\t\r\n\tif related_object_name == \"cms_files\"\r\n\t\t# é™„ä»¶çš„å…³è”æœç´¢æ¡ä»¶æ˜¯å®šæ­»çš„\r\n\t\tselector[\"parent.o\"] = object_name\r\n\t\tselector[\"parent.ids\"] = [record_id]\r\n\telse\r\n\t\tselector[related_field_name] = record_id\r\n\r\n\tpermissions = Creator.getPermissions(related_object_name, spaceId, userId)\r\n\tif !permissions.viewAllRecords and permissions.allowRead\r\n\t\tselector.owner = userId\r\n\t\r\n\treturn Creator.getCollection(related_object_name).find(selector)","Meteor.publish(\"related_objects_records\", function(object_name, related_object_name, related_field_name, record_id, spaceId) {\n  var permissions, selector, userId;\n  userId = this.userId;\n  if (related_object_name === \"cfs.files.filerecord\") {\n    selector = {\n      \"metadata.space\": spaceId\n    };\n  } else {\n    selector = {\n      space: spaceId\n    };\n  }\n  if (related_object_name === \"cms_files\") {\n    selector[\"parent.o\"] = object_name;\n    selector[\"parent.ids\"] = [record_id];\n  } else {\n    selector[related_field_name] = record_id;\n  }\n  permissions = Creator.getPermissions(related_object_name, spaceId, userId);\n  if (!permissions.viewAllRecords && permissions.allowRead) {\n    selector.owner = userId;\n  }\n  return Creator.getCollection(related_object_name).find(selector);\n});\n","Meteor.publish 'space_user_info', (spaceId, userId)->\r\n\treturn Creator.getCollection(\"space_users\").find({space: spaceId, user: userId})","\r\nif Meteor.isServer\r\n\r\n\tMeteor.publish 'contacts_view_limits', (spaceId)->\r\n\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tunless spaceId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tselector =\r\n\t\t\tspace: spaceId\r\n\t\t\tkey: 'contacts_view_limits'\r\n\r\n\t\treturn db.space_settings.find(selector)","if (Meteor.isServer) {\n  Meteor.publish('contacts_view_limits', function(spaceId) {\n    var selector;\n    if (!this.userId) {\n      return this.ready();\n    }\n    if (!spaceId) {\n      return this.ready();\n    }\n    selector = {\n      space: spaceId,\n      key: 'contacts_view_limits'\n    };\n    return db.space_settings.find(selector);\n  });\n}\n","\r\nif Meteor.isServer\r\n\r\n\tMeteor.publish 'contacts_no_force_phone_users', (spaceId)->\r\n\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tunless spaceId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tselector =\r\n\t\t\tspace: spaceId\r\n\t\t\tkey: 'contacts_no_force_phone_users'\r\n\r\n\t\treturn db.space_settings.find(selector)","if (Meteor.isServer) {\n  Meteor.publish('contacts_no_force_phone_users', function(spaceId) {\n    var selector;\n    if (!this.userId) {\n      return this.ready();\n    }\n    if (!spaceId) {\n      return this.ready();\n    }\n    selector = {\n      space: spaceId,\n      key: 'contacts_no_force_phone_users'\n    };\n    return db.space_settings.find(selector);\n  });\n}\n","if Meteor.isServer\r\n\tMeteor.publish 'space_need_to_confirm', ()->\r\n\t\tuserId = this.userId\r\n\t\treturn db.space_users.find({user: userId, invite_state: \"pending\"})","if (Meteor.isServer) {\n  Meteor.publish('space_need_to_confirm', function() {\n    var userId;\n    userId = this.userId;\n    return db.space_users.find({\n      user: userId,\n      invite_state: \"pending\"\n    });\n  });\n}\n","permissionManagerForInitApproval = {}\r\n\r\npermissionManagerForInitApproval.getFlowPermissions = (flow_id, user_id) ->\r\n\t# æ ¹æ®:flow_idæŸ¥åˆ°å¯¹åº”çš„flow\r\n\tflow = uuflowManagerForInitApproval.getFlow(flow_id)\r\n\tspace_id = flow.space\r\n\t# æ ¹æ®space_idå’Œ:user_idåˆ°organizationsè¡¨ä¸­æŸ¥åˆ°ç”¨æˆ·æ‰€å±žæ‰€æœ‰çš„org_idï¼ˆåŒ…æ‹¬ä¸Šçº§ç»„IDï¼‰\r\n\torg_ids = new Array\r\n\torganizations = db.organizations.find({\r\n\t\tspace: space_id, users: user_id }, { fields: { parents: 1 } }).fetch()\r\n\t_.each(organizations, (org) ->\r\n\t\torg_ids.push(org._id)\r\n\t\tif org.parents\r\n\t\t\t_.each(org.parents, (parent_id) ->\r\n\t\t\t\torg_ids.push(parent_id)\r\n\t\t\t)\r\n\t)\r\n\torg_ids = _.uniq(org_ids)\r\n\tmy_permissions = new Array\r\n\tif flow.perms\r\n\t\t# åˆ¤æ–­flow.perms.users_can_adminä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·ï¼Œ\r\n\t\t# æˆ–è€…flow.perms.orgs_can_addæ˜¯å¦åŒ…å«4æ­¥å¾—åˆ°çš„org_idæ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œ\r\n\t\t# è‹¥æ˜¯ï¼Œåˆ™åœ¨è¿”å›žçš„æ•°ç»„ä¸­åŠ ä¸Šadd\r\n\t\tif flow.perms.users_can_add\r\n\t\t\tusers_can_add = flow.perms.users_can_add\r\n\t\t\tif users_can_add.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"add\")\r\n\r\n\t\tif flow.perms.orgs_can_add\r\n\t\t\torgs_can_add = flow.perms.orgs_can_add\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_add.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"add\")\r\n\t\t\t)\r\n\t\t# åˆ¤æ–­flow.perms.users_can_monitorä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·ï¼Œ\r\n\t\t# æˆ–è€…flow.perms.orgs_can_monitoræ˜¯å¦åŒ…å«4æ­¥å¾—åˆ°çš„org_idæ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œ\r\n\t\t# è‹¥æ˜¯ï¼Œåˆ™åœ¨è¿”å›žçš„æ•°ç»„ä¸­åŠ ä¸Šmonitor\r\n\t\tif flow.perms.users_can_monitor\r\n\t\t\tusers_can_monitor = flow.perms.users_can_monitor\r\n\t\t\tif users_can_monitor.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"monitor\")\r\n\r\n\t\tif flow.perms.orgs_can_monitor\r\n\t\t\torgs_can_monitor = flow.perms.orgs_can_monitor\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_monitor.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"monitor\")\r\n\t\t\t)\r\n\t\t# åˆ¤æ–­flow.perms.users_can_adminä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·ï¼Œ\r\n\t\t# æˆ–è€…flow.perms.orgs_can_adminæ˜¯å¦åŒ…å«4æ­¥å¾—åˆ°çš„org_idæ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œ\r\n\t\t# è‹¥æ˜¯ï¼Œåˆ™åœ¨è¿”å›žçš„æ•°ç»„ä¸­åŠ ä¸Šadmin\r\n\t\tif flow.perms.users_can_admin\r\n\t\t\tusers_can_admin = flow.perms.users_can_admin\r\n\t\t\tif users_can_admin.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"admin\")\r\n\r\n\t\tif flow.perms.orgs_can_admin\r\n\t\t\torgs_can_admin = flow.perms.orgs_can_admin\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_admin.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"admin\")\r\n\t\t\t)\r\n\r\n\tmy_permissions = _.uniq(my_permissions)\r\n\treturn my_permissions","                                     \n\npermissionManagerForInitApproval = {};\n\npermissionManagerForInitApproval.getFlowPermissions = function(flow_id, user_id) {\n  var flow, my_permissions, org_ids, organizations, orgs_can_add, orgs_can_admin, orgs_can_monitor, space_id, users_can_add, users_can_admin, users_can_monitor;\n  flow = uuflowManagerForInitApproval.getFlow(flow_id);\n  space_id = flow.space;\n  org_ids = new Array;\n  organizations = db.organizations.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      parents: 1\n    }\n  }).fetch();\n  _.each(organizations, function(org) {\n    org_ids.push(org._id);\n    if (org.parents) {\n      return _.each(org.parents, function(parent_id) {\n        return org_ids.push(parent_id);\n      });\n    }\n  });\n  org_ids = _.uniq(org_ids);\n  my_permissions = new Array;\n  if (flow.perms) {\n    if (flow.perms.users_can_add) {\n      users_can_add = flow.perms.users_can_add;\n      if (users_can_add.includes(user_id)) {\n        my_permissions.push(\"add\");\n      }\n    }\n    if (flow.perms.orgs_can_add) {\n      orgs_can_add = flow.perms.orgs_can_add;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_add.includes(org_id)) {\n          return my_permissions.push(\"add\");\n        }\n      });\n    }\n    if (flow.perms.users_can_monitor) {\n      users_can_monitor = flow.perms.users_can_monitor;\n      if (users_can_monitor.includes(user_id)) {\n        my_permissions.push(\"monitor\");\n      }\n    }\n    if (flow.perms.orgs_can_monitor) {\n      orgs_can_monitor = flow.perms.orgs_can_monitor;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_monitor.includes(org_id)) {\n          return my_permissions.push(\"monitor\");\n        }\n      });\n    }\n    if (flow.perms.users_can_admin) {\n      users_can_admin = flow.perms.users_can_admin;\n      if (users_can_admin.includes(user_id)) {\n        my_permissions.push(\"admin\");\n      }\n    }\n    if (flow.perms.orgs_can_admin) {\n      orgs_can_admin = flow.perms.orgs_can_admin;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_admin.includes(org_id)) {\n          return my_permissions.push(\"admin\");\n        }\n      });\n    }\n  }\n  my_permissions = _.uniq(my_permissions);\n  return my_permissions;\n};\n","_eval = require('eval')\r\nobjectql = require('@steedos/objectql');\r\n\r\nuuflowManagerForInitApproval = {}\r\n\r\nuuflowManagerForInitApproval.check_authorization = (req) ->\r\n\tquery = req.query\r\n\tuserId = query[\"X-User-Id\"]\r\n\tauthToken = query[\"X-Auth-Token\"]\r\n\r\n\tif not userId or not authToken\r\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\thashedToken = Accounts._hashLoginToken(authToken)\r\n\tuser = Meteor.users.findOne\r\n\t\t_id: userId,\r\n\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\r\n\r\n\tif not user\r\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\treturn user\r\n\r\nuuflowManagerForInitApproval.getSpace = (space_id) ->\r\n\tspace = Creator.Collections.spaces.findOne(space_id)\r\n\tif not space\r\n\t\tthrow new Meteor.Error('error!', \"space_idæœ‰è¯¯æˆ–æ­¤spaceå·²ç»è¢«åˆ é™¤\")\r\n\treturn space\r\n\r\nuuflowManagerForInitApproval.getFlow = (flow_id) ->\r\n\tflow = Creator.Collections.flows.findOne(flow_id)\r\n\tif not flow\r\n\t\tthrow new Meteor.Error('error!', \"idæœ‰è¯¯æˆ–æ­¤æµç¨‹å·²ç»è¢«åˆ é™¤\")\r\n\treturn flow\r\n\r\nuuflowManagerForInitApproval.getSpaceUser = (space_id, user_id) ->\r\n\tspace_user = Creator.Collections.space_users.findOne({ space: space_id, user: user_id })\r\n\tif not space_user\r\n\t\tthrow new Meteor.Error('error!', \"user_idå¯¹åº”çš„ç”¨æˆ·ä¸å±žäºŽå½“å‰space\")\r\n\treturn space_user\r\n\r\nuuflowManagerForInitApproval.getSpaceUserOrgInfo = (space_user) ->\r\n\tinfo = new Object\r\n\tinfo.organization = space_user.organization\r\n\torg = Creator.Collections.organizations.findOne(space_user.organization, { fields: { name: 1 , fullname: 1 } })\r\n\tinfo.organization_name = org.name\r\n\tinfo.organization_fullname = org.fullname\r\n\treturn info\r\n\r\nuuflowManagerForInitApproval.isFlowEnabled = (flow) ->\r\n\tif flow.state isnt \"enabled\"\r\n\t\tthrow new Meteor.Error('error!', \"æµç¨‹æœªå¯ç”¨,æ“ä½œå¤±è´¥\")\r\n\r\nuuflowManagerForInitApproval.isFlowSpaceMatched = (flow, space_id) ->\r\n\tif flow.space isnt space_id\r\n\t\tthrow new Meteor.Error('error!', \"æµç¨‹å’Œå·¥ä½œåŒºIDä¸åŒ¹é…\")\r\n\r\nuuflowManagerForInitApproval.getForm = (form_id) ->\r\n\tform = Creator.Collections.forms.findOne(form_id)\r\n\tif not form\r\n\t\tthrow new Meteor.Error('error!', 'è¡¨å•IDæœ‰è¯¯æˆ–æ­¤è¡¨å•å·²ç»è¢«åˆ é™¤')\r\n\r\n\treturn form\r\n\r\nuuflowManagerForInitApproval.getCategory = (category_id) ->\r\n\treturn Creator.Collections.categories.findOne(category_id)\r\n\r\nuuflowManagerForInitApproval.create_instance = (instance_from_client, user_info) ->\r\n\tcheck instance_from_client[\"applicant\"], String\r\n\tcheck instance_from_client[\"space\"], String\r\n\tcheck instance_from_client[\"flow\"], String\r\n\tcheck instance_from_client[\"record_ids\"], [{o: String, ids: [String]}]\r\n\r\n\t# æ ¡éªŒæ˜¯å¦recordå·²ç»å‘èµ·çš„ç”³è¯·è¿˜åœ¨å®¡æ‰¹ä¸­\r\n\tuuflowManagerForInitApproval.checkIsInApproval(instance_from_client[\"record_ids\"][0], instance_from_client[\"space\"])\r\n\r\n\tspace_id = instance_from_client[\"space\"]\r\n\tflow_id = instance_from_client[\"flow\"]\r\n\tuser_id = user_info._id\r\n\t# èŽ·å–å‰å°æ‰€ä¼ çš„trace\r\n\ttrace_from_client = null\r\n\t# èŽ·å–å‰å°æ‰€ä¼ çš„approve\r\n\tapprove_from_client = null\r\n\tif instance_from_client[\"traces\"] and instance_from_client[\"traces\"][0]\r\n\t\ttrace_from_client = instance_from_client[\"traces\"][0]\r\n\t\tif trace_from_client[\"approves\"] and trace_from_client[\"approves\"][0]\r\n\t\t\tapprove_from_client = instance_from_client[\"traces\"][0][\"approves\"][0]\r\n\r\n\t# èŽ·å–ä¸€ä¸ªspace\r\n\tspace = uuflowManagerForInitApproval.getSpace(space_id)\r\n\t# èŽ·å–ä¸€ä¸ªflow\r\n\tflow = uuflowManagerForInitApproval.getFlow(flow_id)\r\n\t# èŽ·å–ä¸€ä¸ªspaceä¸‹çš„ä¸€ä¸ªuser\r\n\tspace_user = uuflowManagerForInitApproval.getSpaceUser(space_id, user_id)\r\n\t# èŽ·å–space_useræ‰€åœ¨çš„éƒ¨é—¨ä¿¡æ¯\r\n\tspace_user_org_info = uuflowManagerForInitApproval.getSpaceUserOrgInfo(space_user)\r\n\t# åˆ¤æ–­ä¸€ä¸ªflowæ˜¯å¦ä¸ºå¯ç”¨çŠ¶æ€\r\n\tuuflowManagerForInitApproval.isFlowEnabled(flow)\r\n\t# åˆ¤æ–­ä¸€ä¸ªflowå’Œspace_idæ˜¯å¦åŒ¹é…\r\n\tuuflowManagerForInitApproval.isFlowSpaceMatched(flow, space_id)\r\n\r\n\tform = uuflowManagerForInitApproval.getForm(flow.form)\r\n\r\n\tpermissions = permissionManager.getFlowPermissions(flow_id, user_id)\r\n\r\n\tif not permissions.includes(\"add\")\r\n\t\tthrow new Meteor.Error('error!', \"å½“å‰ç”¨æˆ·æ²¡æœ‰æ­¤æµç¨‹çš„æ–°å»ºæƒé™\")\r\n\r\n\tnow = new Date\r\n\tins_obj = {}\r\n\tins_obj._id = Creator.Collections.instances._makeNewID()\r\n\tins_obj.space = space_id\r\n\tins_obj.flow = flow_id\r\n\tins_obj.flow_version = flow.current._id\r\n\tins_obj.form = flow.form\r\n\tins_obj.form_version = flow.current.form_version\r\n\tins_obj.name = flow.name\r\n\tins_obj.submitter = user_id\r\n\tins_obj.submitter_name = user_info.name\r\n\tins_obj.applicant = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\r\n\tins_obj.applicant_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\r\n\tins_obj.applicant_organization = if instance_from_client[\"applicant_organization\"] then instance_from_client[\"applicant_organization\"] else space_user.organization\r\n\tins_obj.applicant_organization_name = if instance_from_client[\"applicant_organization_name\"] then instance_from_client[\"applicant_organization_name\"] else space_user_org_info.organization_name\r\n\tins_obj.applicant_organization_fullname = if instance_from_client[\"applicant_organization_fullname\"] then instance_from_client[\"applicant_organization_fullname\"] else  space_user_org_info.organization_fullname\r\n\tins_obj.applicant_company = if instance_from_client[\"applicant_company\"] then instance_from_client[\"applicant_company\"] else space_user.company_id\r\n\tins_obj.state = 'draft'\r\n\tins_obj.code = ''\r\n\tins_obj.is_archived = false\r\n\tins_obj.is_deleted = false\r\n\tins_obj.created = now\r\n\tins_obj.created_by = user_id\r\n\tins_obj.modified = now\r\n\tins_obj.modified_by = user_id\r\n\tins_obj.values = new Object\r\n\r\n\tins_obj.record_ids = instance_from_client[\"record_ids\"]\r\n\r\n\tif space_user.company_id\r\n\t\tins_obj.company_id = space_user.company_id\r\n\r\n\t# æ–°å»ºTrace\r\n\ttrace_obj = {}\r\n\ttrace_obj._id = new Mongo.ObjectID()._str\r\n\ttrace_obj.instance = ins_obj._id\r\n\ttrace_obj.is_finished = false\r\n\t# å½“å‰æœ€æ–°ç‰ˆflowä¸­å¼€å§‹èŠ‚ç‚¹\r\n\tstart_step = _.find(flow.current.steps, (step) ->\r\n\t\treturn step.step_type is 'start'\r\n\t)\r\n\ttrace_obj.step = start_step._id\r\n\ttrace_obj.name = start_step.name\r\n\r\n\ttrace_obj.start_date = now\r\n\t# æ–°å»ºApprove\r\n\tappr_obj = {}\r\n\tappr_obj._id = new Mongo.ObjectID()._str\r\n\tappr_obj.instance = ins_obj._id\r\n\tappr_obj.trace = trace_obj._id\r\n\tappr_obj.is_finished = false\r\n\tappr_obj.user = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\r\n\tappr_obj.user_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\r\n\tappr_obj.handler = user_id\r\n\tappr_obj.handler_name = user_info.name\r\n\tappr_obj.handler_organization = space_user.organization\r\n\tappr_obj.handler_organization_name = space_user_org_info.name\r\n\tappr_obj.handler_organization_fullname = space_user_org_info.fullname\r\n\tappr_obj.type = 'draft'\r\n\tappr_obj.start_date = now\r\n\tappr_obj.read_date = now\r\n\tappr_obj.is_read = true\r\n\tappr_obj.is_error = false\r\n\tappr_obj.description = ''\r\n\trelatedTablesInfo = {}\r\n\tappr_obj.values = uuflowManagerForInitApproval.initiateValues(ins_obj.record_ids[0], flow_id, space_id, form.current.fields, relatedTablesInfo)\r\n\r\n\ttrace_obj.approves = [appr_obj]\r\n\tins_obj.traces = [trace_obj]\r\n\r\n\tins_obj.inbox_users = instance_from_client.inbox_users || []\r\n\r\n\tins_obj.current_step_name = start_step.name\r\n\r\n\tif flow.auto_remind is true\r\n\t\tins_obj.auto_remind = true\r\n\r\n\t# æ–°å»ºç”³è¯·å•æ—¶ï¼Œinstancesè®°å½•æµç¨‹åç§°ã€æµç¨‹åˆ†ç±»åç§° #1313\r\n\tins_obj.flow_name = flow.name\r\n\tif form.category\r\n\t\tcategory = uuflowManagerForInitApproval.getCategory(form.category)\r\n\t\tif category\r\n\t\t\tins_obj.category_name = category.name\r\n\t\t\tins_obj.category = category._id\r\n\r\n\tnew_ins_id = Creator.Collections.instances.insert(ins_obj)\r\n\r\n\tuuflowManagerForInitApproval.initiateRecordInstanceInfo(ins_obj.record_ids[0], new_ins_id, space_id)\r\n\r\n\tuuflowManagerForInitApproval.initiateRelatedRecordInstanceInfo(relatedTablesInfo, new_ins_id, space_id)\r\n\r\n\tuuflowManagerForInitApproval.initiateAttach(ins_obj.record_ids[0], space_id, ins_obj._id, appr_obj._id)\r\n\r\n\treturn new_ins_id\r\n\r\nuuflowManagerForInitApproval.initiateValues = (recordIds, flowId, spaceId, fields, relatedTablesInfo) ->\r\n\tfieldCodes = []\r\n\t_.each fields, (f) ->\r\n\t\tif f.type == 'section'\r\n\t\t\t_.each f.fields, (ff) ->\r\n\t\t\t\tfieldCodes.push ff.code\r\n\t\telse\r\n\t\t\tfieldCodes.push f.code\r\n\r\n\tvalues = {}\r\n\tobjectName = recordIds.o\r\n\tobject = Creator.getObject(objectName, spaceId)\r\n\trecordId = recordIds.ids[0]\r\n\tow = Creator.Collections.object_workflows.findOne({\r\n\t\tobject_name: objectName,\r\n\t\tflow_id: flowId\r\n\t})\r\n\trecord = Creator.getCollection(objectName, spaceId).findOne(recordId)\r\n\tflow = Creator.getCollection('flows').findOne(flowId, { fields: { form: 1 } })\r\n\tif ow and record\r\n\t\tform = Creator.getCollection(\"forms\").findOne(flow.form)\r\n\t\tformFields = form.current.fields || []\r\n\t\trelatedObjects = Creator.getRelatedObjects(objectName, spaceId)\r\n\t\trelatedObjectsKeys = _.pluck(relatedObjects, 'object_name')\r\n\t\tformTableFields = _.filter formFields, (formField) ->\r\n\t\t\treturn formField.type == 'table'\r\n\t\tformTableFieldsCode = _.pluck(formTableFields, 'code')\r\n\r\n\t\tgetRelatedObjectFieldCode =  (key) ->\r\n\t\t\treturn _.find relatedObjectsKeys,  (relatedObjectsKey) ->\r\n\t\t\t\treturn key.startsWith(relatedObjectsKey + '.')\r\n\r\n\t\tgetFormTableFieldCode = (key) ->\r\n\t\t\treturn _.find formTableFieldsCode,  (formTableFieldCode) ->\r\n\t\t\t\treturn key.startsWith(formTableFieldCode + '.')\r\n\r\n\t\tgetFormTableField = (key) ->\r\n\t\t\treturn _.find formTableFields,  (f) ->\r\n\t\t\t\treturn f.code == key\r\n\r\n\t\tgetFormField = (key) ->\r\n\t\t\tff = null\r\n\t\t\t_.forEach formFields, (f) ->\r\n\t\t\t\tif ff\r\n\t\t\t\t\treturn\r\n\t\t\t\tif f.type == 'section'\r\n\t\t\t\t\tff = _.find f.fields,  (sf) ->\r\n\t\t\t\t\t\treturn sf.code == key\r\n\t\t\t\telse if f.code == key\r\n\t\t\t\t\tff = f\r\n\r\n\t\t\treturn ff\r\n\r\n\t\tgetFormTableSubField = (tableField, subFieldCode) ->\r\n\t\t\treturn _.find tableField.fields,  (f) ->\r\n\t\t\t\treturn f.code == subFieldCode\r\n\r\n\t\tgetFieldOdataValue = (objName, id) ->\r\n\t\t\tobj = Creator.getCollection(objName)\r\n\t\t\to = Creator.getObject(objName, spaceId)\r\n\t\t\tnameKey = o.NAME_FIELD_KEY\r\n\t\t\tif !obj\r\n\t\t\t\treturn\r\n\t\t\tif _.isString id\r\n\t\t\t\t_record = obj.findOne(id)\r\n\t\t\t\tif _record\r\n\t\t\t\t\t_record['@label'] = _record[nameKey]\r\n\t\t\t\t\treturn _record\r\n\t\t\telse if _.isArray id\r\n\t\t\t\t_records = []\r\n\t\t\t\tobj.find({ _id: { $in: id } }).forEach (_record) ->\r\n\t\t\t\t\t_record['@label'] = _record[nameKey]\r\n\t\t\t\t\t_records.push _record\r\n\r\n\t\t\t\tif !_.isEmpty _records\r\n\t\t\t\t\treturn _records\r\n\t\t\treturn\r\n\r\n\t\tgetSelectUserValue = (userId, spaceId) ->\r\n\t\t\tsu = Creator.getCollection('space_users').findOne({ space: spaceId, user: userId })\r\n\t\t\tsu.id = userId\r\n\t\t\treturn su\r\n\r\n\t\tgetSelectUserValues = (userIds, spaceId) ->\r\n\t\t\tsus = []\r\n\t\t\tif _.isArray userIds\r\n\t\t\t\t_.each userIds, (userId) ->\r\n\t\t\t\t\tsu = getSelectUserValue(userId, spaceId)\r\n\t\t\t\t\tif su\r\n\t\t\t\t\t\tsus.push(su)\r\n\t\t\treturn sus\r\n\r\n\t\tgetSelectOrgValue = (orgId, spaceId) ->\r\n\t\t\torg = Creator.getCollection('organizations').findOne(orgId, { fields: { _id: 1, name: 1, fullname: 1 } })\r\n\t\t\torg.id = orgId\r\n\t\t\treturn org\r\n\r\n\t\tgetSelectOrgValues = (orgIds, spaceId) ->\r\n\t\t\torgs = []\r\n\t\t\tif _.isArray orgIds\r\n\t\t\t\t_.each orgIds, (orgId) ->\r\n\t\t\t\t\torg = getSelectOrgValue(orgId, spaceId)\r\n\t\t\t\t\tif org\r\n\t\t\t\t\t\torgs.push(org)\r\n\t\t\treturn orgs\r\n\r\n\t\ttableFieldCodes = []\r\n\t\ttableFieldMap = []\r\n\t\ttableToRelatedMap = {}\r\n\r\n\t\tow.field_map?.forEach (fm) ->\r\n\t\t\tobject_field = fm.object_field\r\n\t\t\tworkflow_field = fm.workflow_field\r\n\t\t\trelatedObjectFieldCode = getRelatedObjectFieldCode(object_field)\r\n\t\t\tformTableFieldCode = getFormTableFieldCode(workflow_field)\r\n\t\t\tobjField = object.fields[object_field]\r\n\t\t\tformField = getFormField(workflow_field)\r\n\t\t\t# å¤„ç†å­è¡¨å­—æ®µ\r\n\t\t\tif relatedObjectFieldCode\r\n\t\t\t\t\r\n\t\t\t\toTableCode = object_field.split('.')[0]\r\n\t\t\t\toTableFieldCode = object_field.split('.')[1]\r\n\t\t\t\ttableToRelatedMapKey = oTableCode\r\n\t\t\t\tif !tableToRelatedMap[tableToRelatedMapKey]\r\n\t\t\t\t\ttableToRelatedMap[tableToRelatedMapKey] = {}\r\n\r\n\t\t\t\tif formTableFieldCode\r\n\t\t\t\t\twTableCode = workflow_field.split('.')[0]\r\n\t\t\t\t\ttableToRelatedMap[tableToRelatedMapKey]['_FROM_TABLE_CODE'] = wTableCode\r\n\r\n\t\t\t\ttableToRelatedMap[tableToRelatedMapKey][oTableFieldCode] = workflow_field\r\n\t\t\t# åˆ¤æ–­æ˜¯å¦æ˜¯è¡¨æ ¼å­—æ®µ\r\n\t\t\telse if workflow_field.indexOf('.$.') > 0 and object_field.indexOf('.$.') > 0\r\n\t\t\t\twTableCode = workflow_field.split('.$.')[0]\r\n\t\t\t\toTableCode = object_field.split('.$.')[0]\r\n\t\t\t\tif record.hasOwnProperty(oTableCode) and _.isArray(record[oTableCode])\r\n\t\t\t\t\ttableFieldCodes.push(JSON.stringify({\r\n\t\t\t\t\t\tworkflow_table_field_code: wTableCode,\r\n\t\t\t\t\t\tobject_table_field_code: oTableCode\r\n\t\t\t\t\t}))\r\n\t\t\t\t\ttableFieldMap.push(fm)\r\n\r\n\t\t\t# å¤„ç†lookupã€master_detailç±»åž‹å­—æ®µ\r\n\t\t\telse if object_field.indexOf('.') > 0 and object_field.indexOf('.$.') == -1\r\n\t\t\t\tobjectFieldName = object_field.split('.')[0]\r\n\t\t\t\tlookupFieldName = object_field.split('.')[1]\r\n\t\t\t\tif object\r\n\t\t\t\t\tobjectField = object.fields[objectFieldName]\r\n\t\t\t\t\tif objectField && formField && ['lookup', 'master_detail'].includes(objectField.type) && _.isString(objectField.reference_to)\r\n\t\t\t\t\t\tfieldsObj = {}\r\n\t\t\t\t\t\tfieldsObj[lookupFieldName] = 1\r\n\t\t\t\t\t\tlookupObjectRecord = Creator.getCollection(objectField.reference_to, spaceId).findOne(record[objectFieldName], { fields: fieldsObj })\r\n\t\t\t\t\t\tobjectFieldObjectName = objectField.reference_to\r\n\t\t\t\t\t\tlookupFieldObj = Creator.getObject(objectFieldObjectName, spaceId)\r\n\t\t\t\t\t\tobjectLookupField = lookupFieldObj.fields[lookupFieldName]\r\n\t\t\t\t\t\treferenceToFieldValue = lookupObjectRecord[lookupFieldName]\r\n\t\t\t\t\t\tif objectLookupField && formField && formField.type == 'odata' && ['lookup', 'master_detail'].includes(objectLookupField.type) && _.isString(objectLookupField.reference_to)\r\n\t\t\t\t\t\t\treferenceToObjectName = objectLookupField.reference_to\r\n\t\t\t\t\t\t\todataFieldValue\r\n\t\t\t\t\t\t\tif objectField.multiple && formField.is_multiselect\r\n\t\t\t\t\t\t\t\todataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue)\r\n\t\t\t\t\t\t\telse if !objectField.multiple && !formField.is_multiselect\r\n\t\t\t\t\t\t\t\todataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue)\r\n\t\t\t\t\t\t\tvalues[workflow_field] = odataFieldValue\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tvalues[workflow_field] = lookupObjectRecord[lookupFieldName]\r\n\r\n\t\t\t# lookupã€master_detailå­—æ®µåŒæ­¥åˆ°odataå­—æ®µ\r\n\t\t\telse if formField && objField && formField.type == 'odata' && ['lookup', 'master_detail'].includes(objField.type) && _.isString(objField.reference_to)\r\n\t\t\t\treferenceToObjectName = objField.reference_to\r\n\t\t\t\treferenceToFieldValue = record[objField.name]\r\n\t\t\t\todataFieldValue\r\n\t\t\t\tif objField.multiple && formField.is_multiselect\r\n\t\t\t\t\todataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue)\r\n\t\t\t\telse if !objField.multiple && !formField.is_multiselect\r\n\t\t\t\t\todataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue)\r\n\t\t\t\tvalues[workflow_field] = odataFieldValue\r\n\t\t\telse if formField && objField && ['user', 'group'].includes(formField.type) && ['lookup', 'master_detail'].includes(objField.type) && ['users', 'organizations'].includes(objField.reference_to)\r\n\t\t\t\treferenceToFieldValue = record[objField.name]\r\n\t\t\t\tif !_.isEmpty(referenceToFieldValue)\r\n\t\t\t\t\tselectFieldValue\r\n\t\t\t\t\tif formField.type == 'user'\r\n\t\t\t\t\t\tif objField.multiple && formField.is_multiselect\r\n\t\t\t\t\t\t\tselectFieldValue = getSelectUserValues(referenceToFieldValue, spaceId)\r\n\t\t\t\t\t\telse if !objField.multiple && !formField.is_multiselect\r\n\t\t\t\t\t\t\tselectFieldValue = getSelectUserValue(referenceToFieldValue, spaceId)\r\n\t\t\t\t\telse if formField.type == 'group'\r\n\t\t\t\t\t\tif objField.multiple && formField.is_multiselect\r\n\t\t\t\t\t\t\tselectFieldValue = getSelectOrgValues(referenceToFieldValue, spaceId)\r\n\t\t\t\t\t\telse if !objField.multiple && !formField.is_multiselect\r\n\t\t\t\t\t\t\tselectFieldValue = getSelectOrgValue(referenceToFieldValue, spaceId)\r\n\t\t\t\t\tif selectFieldValue\r\n\t\t\t\t\t\tvalues[workflow_field] = selectFieldValue\r\n\t\t\telse if record.hasOwnProperty(object_field)\r\n\t\t\t\tvalues[workflow_field] = record[object_field]\r\n\r\n\t\t# è¡¨æ ¼å­—æ®µ\r\n\t\t_.uniq(tableFieldCodes).forEach (tfc) ->\r\n\t\t\tc = JSON.parse(tfc)\r\n\t\t\tvalues[c.workflow_table_field_code] = []\r\n\t\t\trecord[c.object_table_field_code].forEach (tr) ->\r\n\t\t\t\tnewTr = {}\r\n\t\t\t\t_.each tr, (v, k) ->\r\n\t\t\t\t\ttableFieldMap.forEach (tfm) ->\r\n\t\t\t\t\t\tif tfm.object_field is (c.object_table_field_code + '.$.' + k)\r\n\t\t\t\t\t\t\twTdCode = tfm.workflow_field.split('.$.')[1]\r\n\t\t\t\t\t\t\tnewTr[wTdCode] = v\r\n\t\t\t\tif not _.isEmpty(newTr)\r\n\t\t\t\t\tvalues[c.workflow_table_field_code].push(newTr)\r\n\r\n\t\t# åŒæ­¥å­è¡¨æ•°æ®è‡³è¡¨å•è¡¨æ ¼\r\n\t\t_.each tableToRelatedMap,  (map, key) ->\r\n\t\t\ttableCode = map._FROM_TABLE_CODE\r\n\t\t\tformTableField = getFormTableField(tableCode)\r\n\t\t\tif !tableCode\r\n\t\t\t\tconsole.warn('tableToRelated: [' + key + '] missing corresponding table.')\r\n\t\t\telse\r\n\t\t\t\trelatedObjectName = key\r\n\t\t\t\ttableValues = []\r\n\t\t\t\trelatedTableItems = []\r\n\t\t\t\trelatedObject = Creator.getObject(relatedObjectName, spaceId)\r\n\t\t\t\trelatedField = _.find relatedObject.fields, (f) ->\r\n\t\t\t\t\treturn ['lookup', 'master_detail'].includes(f.type) && f.reference_to == objectName\r\n\r\n\t\t\t\trelatedFieldName = relatedField.name\r\n\r\n\t\t\t\tselector = {}\r\n\t\t\t\tselector[relatedFieldName] = recordId\r\n\t\t\t\trelatedCollection = Creator.getCollection(relatedObjectName, spaceId)\r\n\t\t\t\trelatedRecords = relatedCollection.find(selector)\r\n\r\n\t\t\t\trelatedRecords.forEach (rr) ->\r\n\t\t\t\t\ttableValueItem = {}\r\n\t\t\t\t\t_.each map, (valueKey, fieldKey) ->\r\n\t\t\t\t\t\tif fieldKey != '_FROM_TABLE_CODE'\r\n\t\t\t\t\t\t\ttableFieldValue\r\n\t\t\t\t\t\t\tformFieldKey\r\n\t\t\t\t\t\t\tif valueKey.startsWith(tableCode + '.')\r\n\t\t\t\t\t\t\t\tformFieldKey = (valueKey.split(\".\")[1])\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tformFieldKey = valueKey\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tformField = getFormTableSubField(formTableField, formFieldKey)\r\n\t\t\t\t\t\t\trelatedObjectField = relatedObject.fields[fieldKey]\r\n\t\t\t\t\t\t\tif !formField || !relatedObjectField\r\n\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\tif formField.type == 'odata' && ['lookup', 'master_detail'].includes(relatedObjectField.type) && _.isString(relatedObjectField.reference_to)\r\n\t\t\t\t\t\t\t\treferenceToObjectName = relatedObjectField.reference_to\r\n\t\t\t\t\t\t\t\treferenceToFieldValue = rr[fieldKey]\r\n\t\t\t\t\t\t\t\tif relatedObjectField.multiple && formField.is_multiselect\r\n\t\t\t\t\t\t\t\t\ttableFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue)\r\n\t\t\t\t\t\t\t\telse if !relatedObjectField.multiple && !formField.is_multiselect\r\n\t\t\t\t\t\t\t\t\ttableFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue)\r\n\t\t\t\t\t\t\telse if ['user', 'group'].includes(formField.type) && ['lookup', 'master_detail'].includes(relatedObjectField.type) && ['users', 'organizations'].includes(relatedObjectField.reference_to)\r\n\t\t\t\t\t\t\t\treferenceToFieldValue = rr[fieldKey]\r\n\t\t\t\t\t\t\t\tif !_.isEmpty(referenceToFieldValue)\r\n\t\t\t\t\t\t\t\t\tif formField.type == 'user'\r\n\t\t\t\t\t\t\t\t\t\tif relatedObjectField.multiple && formField.is_multiselect\r\n\t\t\t\t\t\t\t\t\t\t\ttableFieldValue = getSelectUserValues(referenceToFieldValue, spaceId)\r\n\t\t\t\t\t\t\t\t\t\telse if !relatedObjectField.multiple && !formField.is_multiselect\r\n\t\t\t\t\t\t\t\t\t\t\ttableFieldValue = getSelectUserValue(referenceToFieldValue, spaceId)\r\n\t\t\t\t\t\t\t\t\telse if formField.type == 'group'\r\n\t\t\t\t\t\t\t\t\t\tif relatedObjectField.multiple && formField.is_multiselect\r\n\t\t\t\t\t\t\t\t\t\t\ttableFieldValue = getSelectOrgValues(referenceToFieldValue, spaceId)\r\n\t\t\t\t\t\t\t\t\t\telse if !relatedObjectField.multiple && !formField.is_multiselect\r\n\t\t\t\t\t\t\t\t\t\t\ttableFieldValue = getSelectOrgValue(referenceToFieldValue, spaceId)\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\ttableFieldValue = rr[fieldKey]\r\n\t\t\t\t\t\t\ttableValueItem[formFieldKey] = tableFieldValue\r\n\t\t\t\t\tif !_.isEmpty(tableValueItem)\r\n\t\t\t\t\t\ttableValueItem._id = rr._id\r\n\t\t\t\t\t\ttableValues.push(tableValueItem)\r\n\t\t\t\t\t\trelatedTableItems.push({ _table: { _id: rr._id, _code: tableCode } } )\r\n\r\n\t\t\t\tvalues[tableCode] = tableValues\r\n\t\t\t\trelatedTablesInfo[relatedObjectName] = relatedTableItems\r\n\r\n\t\t# å¦‚æžœé…ç½®äº†è„šæœ¬åˆ™æ‰§è¡Œè„šæœ¬\r\n\t\tif ow.field_map_script\r\n\t\t\t_.extend(values, uuflowManagerForInitApproval.evalFieldMapScript(ow.field_map_script, objectName, spaceId, recordId))\r\n\r\n\t# è¿‡æ»¤æŽ‰valuesä¸­çš„éžæ³•key\r\n\tfilterValues = {}\r\n\t_.each _.keys(values), (k) ->\r\n\t\tif fieldCodes.includes(k)\r\n\t\t\tfilterValues[k] = values[k]\r\n\r\n\treturn filterValues\r\n\r\nuuflowManagerForInitApproval.evalFieldMapScript = (field_map_script, objectName, spaceId, objectId) ->\r\n\trecord = Creator.getCollection(objectName, spaceId).findOne(objectId)\r\n\tscript = \"module.exports = function (record) { \" + field_map_script + \" }\"\r\n\tfunc = _eval(script, \"field_map_script\")\r\n\tvalues = func(record)\r\n\tif _.isObject values\r\n\t\treturn values\r\n\telse\r\n\t\tconsole.error \"evalFieldMapScript: è„šæœ¬è¿”å›žå€¼ç±»åž‹ä¸æ˜¯å¯¹è±¡\"\r\n\treturn {}\r\n\r\n\r\n\r\nuuflowManagerForInitApproval.initiateAttach = (recordIds, spaceId, insId, approveId) ->\r\n\r\n\tCreator.Collections['cms_files'].find({\r\n\t\tspace: spaceId,\r\n\t\tparent: recordIds\r\n\t}).forEach (cf) ->\r\n\t\t_.each cf.versions, (versionId, idx) ->\r\n\t\t\tf = Creator.Collections['cfs.files.filerecord'].findOne(versionId)\r\n\t\t\tnewFile = new FS.File()\r\n\r\n\t\t\tnewFile.attachData f.createReadStream('files'), {\r\n\t\t\t\t\ttype: f.original.type\r\n\t\t\t}, (err) ->\r\n\t\t\t\tif (err)\r\n\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason)\r\n\r\n\t\t\t\tnewFile.name(f.name())\r\n\t\t\t\tnewFile.size(f.size())\r\n\t\t\t\tmetadata = {\r\n\t\t\t\t\towner: f.metadata.owner,\r\n\t\t\t\t\towner_name: f.metadata.owner_name,\r\n\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\tinstance: insId,\r\n\t\t\t\t\tapprove: approveId\r\n\t\t\t\t\tparent: cf._id\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif idx is 0\r\n\t\t\t\t\tmetadata.current = true\r\n\r\n\t\t\t\tnewFile.metadata = metadata\r\n\t\t\t\tcfs.instances.insert(newFile)\r\n\r\n\treturn\r\n\r\nuuflowManagerForInitApproval.initiateRecordInstanceInfo = (recordIds, insId, spaceId) ->\r\n\tCreator.getCollection(recordIds.o, spaceId).update(recordIds.ids[0], {\r\n\t\t$push: {\r\n\t\t\tinstances: {\r\n\t\t\t\t$each: [{\r\n\t\t\t\t\t_id: insId,\r\n\t\t\t\t\tstate: 'draft'\r\n\t\t\t\t}],\r\n\t\t\t\t$position: 0\r\n\t\t\t}\r\n\t\t},\r\n\t\t$set: {\r\n\t\t\tlocked: true\r\n\t\t\tinstance_state: 'draft'\r\n\t\t}\r\n\t})\r\n\r\n\treturn\r\n\r\n\r\nuuflowManagerForInitApproval.initiateRelatedRecordInstanceInfo = (relatedTablesInfo, insId, spaceId) ->\r\n\t_.each relatedTablesInfo, (tableItems, relatedObjectName) ->\r\n\t\trelatedCollection = Creator.getCollection(relatedObjectName, spaceId)\r\n\t\t_.each tableItems, (item) ->\r\n\t\t\trelatedCollection.update(item._table._id, {\r\n\t\t\t\t$set: {\r\n\t\t\t\t\tinstances: [{\r\n\t\t\t\t\t\t_id: insId,\r\n\t\t\t\t\t\tstate: 'draft'\r\n\t\t\t\t\t}],\r\n\t\t\t\t\t_table: item._table\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\treturn\r\n\r\nuuflowManagerForInitApproval.checkIsInApproval = (recordIds, spaceId) ->\r\n\trecord = Creator.getCollection(recordIds.o, spaceId).findOne({\r\n\t\t_id: recordIds.ids[0], instances: { $exists: true }\r\n\t}, { fields: { instances: 1 } })\r\n\r\n\tif record and record.instances[0].state isnt 'completed' and Creator.Collections.instances.find(record.instances[0]._id).count() > 0\r\n\t\tthrow new Meteor.Error('error!', \"æ­¤è®°å½•å·²å‘èµ·æµç¨‹æ­£åœ¨å®¡æ‰¹ä¸­ï¼Œå¾…å®¡æ‰¹ç»“æŸæ–¹å¯å‘èµ·ä¸‹ä¸€æ¬¡å®¡æ‰¹ï¼\")\r\n\r\n\treturn\r\n\r\n","var _eval, objectql;                              \n\n_eval = require('eval');\n\nobjectql = require('@steedos/objectql');\n\nuuflowManagerForInitApproval = {};\n\nuuflowManagerForInitApproval.check_authorization = function(req) {\n  var authToken, hashedToken, query, user, userId;\n  query = req.query;\n  userId = query[\"X-User-Id\"];\n  authToken = query[\"X-Auth-Token\"];\n  if (!userId || !authToken) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  hashedToken = Accounts._hashLoginToken(authToken);\n  user = Meteor.users.findOne({\n    _id: userId,\n    \"services.resume.loginTokens.hashedToken\": hashedToken\n  });\n  if (!user) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  return user;\n};\n\nuuflowManagerForInitApproval.getSpace = function(space_id) {\n  var space;\n  space = Creator.Collections.spaces.findOne(space_id);\n  if (!space) {\n    throw new Meteor.Error('error!', \"space_idæœ‰è¯¯æˆ–æ­¤spaceå·²ç»è¢«åˆ é™¤\");\n  }\n  return space;\n};\n\nuuflowManagerForInitApproval.getFlow = function(flow_id) {\n  var flow;\n  flow = Creator.Collections.flows.findOne(flow_id);\n  if (!flow) {\n    throw new Meteor.Error('error!', \"idæœ‰è¯¯æˆ–æ­¤æµç¨‹å·²ç»è¢«åˆ é™¤\");\n  }\n  return flow;\n};\n\nuuflowManagerForInitApproval.getSpaceUser = function(space_id, user_id) {\n  var space_user;\n  space_user = Creator.Collections.space_users.findOne({\n    space: space_id,\n    user: user_id\n  });\n  if (!space_user) {\n    throw new Meteor.Error('error!', \"user_idå¯¹åº”çš„ç”¨æˆ·ä¸å±žäºŽå½“å‰space\");\n  }\n  return space_user;\n};\n\nuuflowManagerForInitApproval.getSpaceUserOrgInfo = function(space_user) {\n  var info, org;\n  info = new Object;\n  info.organization = space_user.organization;\n  org = Creator.Collections.organizations.findOne(space_user.organization, {\n    fields: {\n      name: 1,\n      fullname: 1\n    }\n  });\n  info.organization_name = org.name;\n  info.organization_fullname = org.fullname;\n  return info;\n};\n\nuuflowManagerForInitApproval.isFlowEnabled = function(flow) {\n  if (flow.state !== \"enabled\") {\n    throw new Meteor.Error('error!', \"æµç¨‹æœªå¯ç”¨,æ“ä½œå¤±è´¥\");\n  }\n};\n\nuuflowManagerForInitApproval.isFlowSpaceMatched = function(flow, space_id) {\n  if (flow.space !== space_id) {\n    throw new Meteor.Error('error!', \"æµç¨‹å’Œå·¥ä½œåŒºIDä¸åŒ¹é…\");\n  }\n};\n\nuuflowManagerForInitApproval.getForm = function(form_id) {\n  var form;\n  form = Creator.Collections.forms.findOne(form_id);\n  if (!form) {\n    throw new Meteor.Error('error!', 'è¡¨å•IDæœ‰è¯¯æˆ–æ­¤è¡¨å•å·²ç»è¢«åˆ é™¤');\n  }\n  return form;\n};\n\nuuflowManagerForInitApproval.getCategory = function(category_id) {\n  return Creator.Collections.categories.findOne(category_id);\n};\n\nuuflowManagerForInitApproval.create_instance = function(instance_from_client, user_info) {\n  var appr_obj, approve_from_client, category, flow, flow_id, form, ins_obj, new_ins_id, now, permissions, relatedTablesInfo, space, space_id, space_user, space_user_org_info, start_step, trace_from_client, trace_obj, user_id;\n  check(instance_from_client[\"applicant\"], String);\n  check(instance_from_client[\"space\"], String);\n  check(instance_from_client[\"flow\"], String);\n  check(instance_from_client[\"record_ids\"], [\n    {\n      o: String,\n      ids: [String]\n    }\n  ]);\n  uuflowManagerForInitApproval.checkIsInApproval(instance_from_client[\"record_ids\"][0], instance_from_client[\"space\"]);\n  space_id = instance_from_client[\"space\"];\n  flow_id = instance_from_client[\"flow\"];\n  user_id = user_info._id;\n  trace_from_client = null;\n  approve_from_client = null;\n  if (instance_from_client[\"traces\"] && instance_from_client[\"traces\"][0]) {\n    trace_from_client = instance_from_client[\"traces\"][0];\n    if (trace_from_client[\"approves\"] && trace_from_client[\"approves\"][0]) {\n      approve_from_client = instance_from_client[\"traces\"][0][\"approves\"][0];\n    }\n  }\n  space = uuflowManagerForInitApproval.getSpace(space_id);\n  flow = uuflowManagerForInitApproval.getFlow(flow_id);\n  space_user = uuflowManagerForInitApproval.getSpaceUser(space_id, user_id);\n  space_user_org_info = uuflowManagerForInitApproval.getSpaceUserOrgInfo(space_user);\n  uuflowManagerForInitApproval.isFlowEnabled(flow);\n  uuflowManagerForInitApproval.isFlowSpaceMatched(flow, space_id);\n  form = uuflowManagerForInitApproval.getForm(flow.form);\n  permissions = permissionManager.getFlowPermissions(flow_id, user_id);\n  if (!permissions.includes(\"add\")) {\n    throw new Meteor.Error('error!', \"å½“å‰ç”¨æˆ·æ²¡æœ‰æ­¤æµç¨‹çš„æ–°å»ºæƒé™\");\n  }\n  now = new Date;\n  ins_obj = {};\n  ins_obj._id = Creator.Collections.instances._makeNewID();\n  ins_obj.space = space_id;\n  ins_obj.flow = flow_id;\n  ins_obj.flow_version = flow.current._id;\n  ins_obj.form = flow.form;\n  ins_obj.form_version = flow.current.form_version;\n  ins_obj.name = flow.name;\n  ins_obj.submitter = user_id;\n  ins_obj.submitter_name = user_info.name;\n  ins_obj.applicant = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  ins_obj.applicant_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  ins_obj.applicant_organization = instance_from_client[\"applicant_organization\"] ? instance_from_client[\"applicant_organization\"] : space_user.organization;\n  ins_obj.applicant_organization_name = instance_from_client[\"applicant_organization_name\"] ? instance_from_client[\"applicant_organization_name\"] : space_user_org_info.organization_name;\n  ins_obj.applicant_organization_fullname = instance_from_client[\"applicant_organization_fullname\"] ? instance_from_client[\"applicant_organization_fullname\"] : space_user_org_info.organization_fullname;\n  ins_obj.applicant_company = instance_from_client[\"applicant_company\"] ? instance_from_client[\"applicant_company\"] : space_user.company_id;\n  ins_obj.state = 'draft';\n  ins_obj.code = '';\n  ins_obj.is_archived = false;\n  ins_obj.is_deleted = false;\n  ins_obj.created = now;\n  ins_obj.created_by = user_id;\n  ins_obj.modified = now;\n  ins_obj.modified_by = user_id;\n  ins_obj.values = new Object;\n  ins_obj.record_ids = instance_from_client[\"record_ids\"];\n  if (space_user.company_id) {\n    ins_obj.company_id = space_user.company_id;\n  }\n  trace_obj = {};\n  trace_obj._id = new Mongo.ObjectID()._str;\n  trace_obj.instance = ins_obj._id;\n  trace_obj.is_finished = false;\n  start_step = _.find(flow.current.steps, function(step) {\n    return step.step_type === 'start';\n  });\n  trace_obj.step = start_step._id;\n  trace_obj.name = start_step.name;\n  trace_obj.start_date = now;\n  appr_obj = {};\n  appr_obj._id = new Mongo.ObjectID()._str;\n  appr_obj.instance = ins_obj._id;\n  appr_obj.trace = trace_obj._id;\n  appr_obj.is_finished = false;\n  appr_obj.user = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  appr_obj.user_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  appr_obj.handler = user_id;\n  appr_obj.handler_name = user_info.name;\n  appr_obj.handler_organization = space_user.organization;\n  appr_obj.handler_organization_name = space_user_org_info.name;\n  appr_obj.handler_organization_fullname = space_user_org_info.fullname;\n  appr_obj.type = 'draft';\n  appr_obj.start_date = now;\n  appr_obj.read_date = now;\n  appr_obj.is_read = true;\n  appr_obj.is_error = false;\n  appr_obj.description = '';\n  relatedTablesInfo = {};\n  appr_obj.values = uuflowManagerForInitApproval.initiateValues(ins_obj.record_ids[0], flow_id, space_id, form.current.fields, relatedTablesInfo);\n  trace_obj.approves = [appr_obj];\n  ins_obj.traces = [trace_obj];\n  ins_obj.inbox_users = instance_from_client.inbox_users || [];\n  ins_obj.current_step_name = start_step.name;\n  if (flow.auto_remind === true) {\n    ins_obj.auto_remind = true;\n  }\n  ins_obj.flow_name = flow.name;\n  if (form.category) {\n    category = uuflowManagerForInitApproval.getCategory(form.category);\n    if (category) {\n      ins_obj.category_name = category.name;\n      ins_obj.category = category._id;\n    }\n  }\n  new_ins_id = Creator.Collections.instances.insert(ins_obj);\n  uuflowManagerForInitApproval.initiateRecordInstanceInfo(ins_obj.record_ids[0], new_ins_id, space_id);\n  uuflowManagerForInitApproval.initiateRelatedRecordInstanceInfo(relatedTablesInfo, new_ins_id, space_id);\n  uuflowManagerForInitApproval.initiateAttach(ins_obj.record_ids[0], space_id, ins_obj._id, appr_obj._id);\n  return new_ins_id;\n};\n\nuuflowManagerForInitApproval.initiateValues = function(recordIds, flowId, spaceId, fields, relatedTablesInfo) {\n  var fieldCodes, filterValues, flow, form, formFields, formTableFields, formTableFieldsCode, getFieldOdataValue, getFormField, getFormTableField, getFormTableFieldCode, getFormTableSubField, getRelatedObjectFieldCode, getSelectOrgValue, getSelectOrgValues, getSelectUserValue, getSelectUserValues, object, objectName, ow, record, recordId, ref, relatedObjects, relatedObjectsKeys, tableFieldCodes, tableFieldMap, tableToRelatedMap, values;\n  fieldCodes = [];\n  _.each(fields, function(f) {\n    if (f.type === 'section') {\n      return _.each(f.fields, function(ff) {\n        return fieldCodes.push(ff.code);\n      });\n    } else {\n      return fieldCodes.push(f.code);\n    }\n  });\n  values = {};\n  objectName = recordIds.o;\n  object = Creator.getObject(objectName, spaceId);\n  recordId = recordIds.ids[0];\n  ow = Creator.Collections.object_workflows.findOne({\n    object_name: objectName,\n    flow_id: flowId\n  });\n  record = Creator.getCollection(objectName, spaceId).findOne(recordId);\n  flow = Creator.getCollection('flows').findOne(flowId, {\n    fields: {\n      form: 1\n    }\n  });\n  if (ow && record) {\n    form = Creator.getCollection(\"forms\").findOne(flow.form);\n    formFields = form.current.fields || [];\n    relatedObjects = Creator.getRelatedObjects(objectName, spaceId);\n    relatedObjectsKeys = _.pluck(relatedObjects, 'object_name');\n    formTableFields = _.filter(formFields, function(formField) {\n      return formField.type === 'table';\n    });\n    formTableFieldsCode = _.pluck(formTableFields, 'code');\n    getRelatedObjectFieldCode = function(key) {\n      return _.find(relatedObjectsKeys, function(relatedObjectsKey) {\n        return key.startsWith(relatedObjectsKey + '.');\n      });\n    };\n    getFormTableFieldCode = function(key) {\n      return _.find(formTableFieldsCode, function(formTableFieldCode) {\n        return key.startsWith(formTableFieldCode + '.');\n      });\n    };\n    getFormTableField = function(key) {\n      return _.find(formTableFields, function(f) {\n        return f.code === key;\n      });\n    };\n    getFormField = function(key) {\n      var ff;\n      ff = null;\n      _.forEach(formFields, function(f) {\n        if (ff) {\n          return;\n        }\n        if (f.type === 'section') {\n          return ff = _.find(f.fields, function(sf) {\n            return sf.code === key;\n          });\n        } else if (f.code === key) {\n          return ff = f;\n        }\n      });\n      return ff;\n    };\n    getFormTableSubField = function(tableField, subFieldCode) {\n      return _.find(tableField.fields, function(f) {\n        return f.code === subFieldCode;\n      });\n    };\n    getFieldOdataValue = function(objName, id) {\n      var _record, _records, nameKey, o, obj;\n      obj = Creator.getCollection(objName);\n      o = Creator.getObject(objName, spaceId);\n      nameKey = o.NAME_FIELD_KEY;\n      if (!obj) {\n        return;\n      }\n      if (_.isString(id)) {\n        _record = obj.findOne(id);\n        if (_record) {\n          _record['@label'] = _record[nameKey];\n          return _record;\n        }\n      } else if (_.isArray(id)) {\n        _records = [];\n        obj.find({\n          _id: {\n            $in: id\n          }\n        }).forEach(function(_record) {\n          _record['@label'] = _record[nameKey];\n          return _records.push(_record);\n        });\n        if (!_.isEmpty(_records)) {\n          return _records;\n        }\n      }\n    };\n    getSelectUserValue = function(userId, spaceId) {\n      var su;\n      su = Creator.getCollection('space_users').findOne({\n        space: spaceId,\n        user: userId\n      });\n      su.id = userId;\n      return su;\n    };\n    getSelectUserValues = function(userIds, spaceId) {\n      var sus;\n      sus = [];\n      if (_.isArray(userIds)) {\n        _.each(userIds, function(userId) {\n          var su;\n          su = getSelectUserValue(userId, spaceId);\n          if (su) {\n            return sus.push(su);\n          }\n        });\n      }\n      return sus;\n    };\n    getSelectOrgValue = function(orgId, spaceId) {\n      var org;\n      org = Creator.getCollection('organizations').findOne(orgId, {\n        fields: {\n          _id: 1,\n          name: 1,\n          fullname: 1\n        }\n      });\n      org.id = orgId;\n      return org;\n    };\n    getSelectOrgValues = function(orgIds, spaceId) {\n      var orgs;\n      orgs = [];\n      if (_.isArray(orgIds)) {\n        _.each(orgIds, function(orgId) {\n          var org;\n          org = getSelectOrgValue(orgId, spaceId);\n          if (org) {\n            return orgs.push(org);\n          }\n        });\n      }\n      return orgs;\n    };\n    tableFieldCodes = [];\n    tableFieldMap = [];\n    tableToRelatedMap = {};\n    if ((ref = ow.field_map) != null) {\n      ref.forEach(function(fm) {\n        var fieldsObj, formField, formTableFieldCode, lookupFieldName, lookupFieldObj, lookupObjectRecord, oTableCode, oTableFieldCode, objField, objectField, objectFieldName, objectFieldObjectName, objectLookupField, object_field, odataFieldValue, referenceToFieldValue, referenceToObjectName, relatedObjectFieldCode, selectFieldValue, tableToRelatedMapKey, wTableCode, workflow_field;\n        object_field = fm.object_field;\n        workflow_field = fm.workflow_field;\n        relatedObjectFieldCode = getRelatedObjectFieldCode(object_field);\n        formTableFieldCode = getFormTableFieldCode(workflow_field);\n        objField = object.fields[object_field];\n        formField = getFormField(workflow_field);\n        if (relatedObjectFieldCode) {\n          oTableCode = object_field.split('.')[0];\n          oTableFieldCode = object_field.split('.')[1];\n          tableToRelatedMapKey = oTableCode;\n          if (!tableToRelatedMap[tableToRelatedMapKey]) {\n            tableToRelatedMap[tableToRelatedMapKey] = {};\n          }\n          if (formTableFieldCode) {\n            wTableCode = workflow_field.split('.')[0];\n            tableToRelatedMap[tableToRelatedMapKey]['_FROM_TABLE_CODE'] = wTableCode;\n          }\n          return tableToRelatedMap[tableToRelatedMapKey][oTableFieldCode] = workflow_field;\n        } else if (workflow_field.indexOf('.$.') > 0 && object_field.indexOf('.$.') > 0) {\n          wTableCode = workflow_field.split('.$.')[0];\n          oTableCode = object_field.split('.$.')[0];\n          if (record.hasOwnProperty(oTableCode) && _.isArray(record[oTableCode])) {\n            tableFieldCodes.push(JSON.stringify({\n              workflow_table_field_code: wTableCode,\n              object_table_field_code: oTableCode\n            }));\n            return tableFieldMap.push(fm);\n          }\n        } else if (object_field.indexOf('.') > 0 && object_field.indexOf('.$.') === -1) {\n          objectFieldName = object_field.split('.')[0];\n          lookupFieldName = object_field.split('.')[1];\n          if (object) {\n            objectField = object.fields[objectFieldName];\n            if (objectField && formField && ['lookup', 'master_detail'].includes(objectField.type) && _.isString(objectField.reference_to)) {\n              fieldsObj = {};\n              fieldsObj[lookupFieldName] = 1;\n              lookupObjectRecord = Creator.getCollection(objectField.reference_to, spaceId).findOne(record[objectFieldName], {\n                fields: fieldsObj\n              });\n              objectFieldObjectName = objectField.reference_to;\n              lookupFieldObj = Creator.getObject(objectFieldObjectName, spaceId);\n              objectLookupField = lookupFieldObj.fields[lookupFieldName];\n              referenceToFieldValue = lookupObjectRecord[lookupFieldName];\n              if (objectLookupField && formField && formField.type === 'odata' && ['lookup', 'master_detail'].includes(objectLookupField.type) && _.isString(objectLookupField.reference_to)) {\n                referenceToObjectName = objectLookupField.reference_to;\n                odataFieldValue;\n                if (objectField.multiple && formField.is_multiselect) {\n                  odataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue);\n                } else if (!objectField.multiple && !formField.is_multiselect) {\n                  odataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue);\n                }\n                return values[workflow_field] = odataFieldValue;\n              } else {\n                return values[workflow_field] = lookupObjectRecord[lookupFieldName];\n              }\n            }\n          }\n        } else if (formField && objField && formField.type === 'odata' && ['lookup', 'master_detail'].includes(objField.type) && _.isString(objField.reference_to)) {\n          referenceToObjectName = objField.reference_to;\n          referenceToFieldValue = record[objField.name];\n          odataFieldValue;\n          if (objField.multiple && formField.is_multiselect) {\n            odataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue);\n          } else if (!objField.multiple && !formField.is_multiselect) {\n            odataFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue);\n          }\n          return values[workflow_field] = odataFieldValue;\n        } else if (formField && objField && ['user', 'group'].includes(formField.type) && ['lookup', 'master_detail'].includes(objField.type) && ['users', 'organizations'].includes(objField.reference_to)) {\n          referenceToFieldValue = record[objField.name];\n          if (!_.isEmpty(referenceToFieldValue)) {\n            selectFieldValue;\n            if (formField.type === 'user') {\n              if (objField.multiple && formField.is_multiselect) {\n                selectFieldValue = getSelectUserValues(referenceToFieldValue, spaceId);\n              } else if (!objField.multiple && !formField.is_multiselect) {\n                selectFieldValue = getSelectUserValue(referenceToFieldValue, spaceId);\n              }\n            } else if (formField.type === 'group') {\n              if (objField.multiple && formField.is_multiselect) {\n                selectFieldValue = getSelectOrgValues(referenceToFieldValue, spaceId);\n              } else if (!objField.multiple && !formField.is_multiselect) {\n                selectFieldValue = getSelectOrgValue(referenceToFieldValue, spaceId);\n              }\n            }\n            if (selectFieldValue) {\n              return values[workflow_field] = selectFieldValue;\n            }\n          }\n        } else if (record.hasOwnProperty(object_field)) {\n          return values[workflow_field] = record[object_field];\n        }\n      });\n    }\n    _.uniq(tableFieldCodes).forEach(function(tfc) {\n      var c;\n      c = JSON.parse(tfc);\n      values[c.workflow_table_field_code] = [];\n      return record[c.object_table_field_code].forEach(function(tr) {\n        var newTr;\n        newTr = {};\n        _.each(tr, function(v, k) {\n          return tableFieldMap.forEach(function(tfm) {\n            var wTdCode;\n            if (tfm.object_field === (c.object_table_field_code + '.$.' + k)) {\n              wTdCode = tfm.workflow_field.split('.$.')[1];\n              return newTr[wTdCode] = v;\n            }\n          });\n        });\n        if (!_.isEmpty(newTr)) {\n          return values[c.workflow_table_field_code].push(newTr);\n        }\n      });\n    });\n    _.each(tableToRelatedMap, function(map, key) {\n      var formTableField, relatedCollection, relatedField, relatedFieldName, relatedObject, relatedObjectName, relatedRecords, relatedTableItems, selector, tableCode, tableValues;\n      tableCode = map._FROM_TABLE_CODE;\n      formTableField = getFormTableField(tableCode);\n      if (!tableCode) {\n        return console.warn('tableToRelated: [' + key + '] missing corresponding table.');\n      } else {\n        relatedObjectName = key;\n        tableValues = [];\n        relatedTableItems = [];\n        relatedObject = Creator.getObject(relatedObjectName, spaceId);\n        relatedField = _.find(relatedObject.fields, function(f) {\n          return ['lookup', 'master_detail'].includes(f.type) && f.reference_to === objectName;\n        });\n        relatedFieldName = relatedField.name;\n        selector = {};\n        selector[relatedFieldName] = recordId;\n        relatedCollection = Creator.getCollection(relatedObjectName, spaceId);\n        relatedRecords = relatedCollection.find(selector);\n        relatedRecords.forEach(function(rr) {\n          var tableValueItem;\n          tableValueItem = {};\n          _.each(map, function(valueKey, fieldKey) {\n            var formField, formFieldKey, referenceToFieldValue, referenceToObjectName, relatedObjectField, tableFieldValue;\n            if (fieldKey !== '_FROM_TABLE_CODE') {\n              tableFieldValue;\n              formFieldKey;\n              if (valueKey.startsWith(tableCode + '.')) {\n                formFieldKey = (valueKey.split(\".\")[1]);\n              } else {\n                formFieldKey = valueKey;\n              }\n              formField = getFormTableSubField(formTableField, formFieldKey);\n              relatedObjectField = relatedObject.fields[fieldKey];\n              if (!formField || !relatedObjectField) {\n                return;\n              }\n              if (formField.type === 'odata' && ['lookup', 'master_detail'].includes(relatedObjectField.type) && _.isString(relatedObjectField.reference_to)) {\n                referenceToObjectName = relatedObjectField.reference_to;\n                referenceToFieldValue = rr[fieldKey];\n                if (relatedObjectField.multiple && formField.is_multiselect) {\n                  tableFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue);\n                } else if (!relatedObjectField.multiple && !formField.is_multiselect) {\n                  tableFieldValue = getFieldOdataValue(referenceToObjectName, referenceToFieldValue);\n                }\n              } else if (['user', 'group'].includes(formField.type) && ['lookup', 'master_detail'].includes(relatedObjectField.type) && ['users', 'organizations'].includes(relatedObjectField.reference_to)) {\n                referenceToFieldValue = rr[fieldKey];\n                if (!_.isEmpty(referenceToFieldValue)) {\n                  if (formField.type === 'user') {\n                    if (relatedObjectField.multiple && formField.is_multiselect) {\n                      tableFieldValue = getSelectUserValues(referenceToFieldValue, spaceId);\n                    } else if (!relatedObjectField.multiple && !formField.is_multiselect) {\n                      tableFieldValue = getSelectUserValue(referenceToFieldValue, spaceId);\n                    }\n                  } else if (formField.type === 'group') {\n                    if (relatedObjectField.multiple && formField.is_multiselect) {\n                      tableFieldValue = getSelectOrgValues(referenceToFieldValue, spaceId);\n                    } else if (!relatedObjectField.multiple && !formField.is_multiselect) {\n                      tableFieldValue = getSelectOrgValue(referenceToFieldValue, spaceId);\n                    }\n                  }\n                }\n              } else {\n                tableFieldValue = rr[fieldKey];\n              }\n              return tableValueItem[formFieldKey] = tableFieldValue;\n            }\n          });\n          if (!_.isEmpty(tableValueItem)) {\n            tableValueItem._id = rr._id;\n            tableValues.push(tableValueItem);\n            return relatedTableItems.push({\n              _table: {\n                _id: rr._id,\n                _code: tableCode\n              }\n            });\n          }\n        });\n        values[tableCode] = tableValues;\n        return relatedTablesInfo[relatedObjectName] = relatedTableItems;\n      }\n    });\n    if (ow.field_map_script) {\n      _.extend(values, uuflowManagerForInitApproval.evalFieldMapScript(ow.field_map_script, objectName, spaceId, recordId));\n    }\n  }\n  filterValues = {};\n  _.each(_.keys(values), function(k) {\n    if (fieldCodes.includes(k)) {\n      return filterValues[k] = values[k];\n    }\n  });\n  return filterValues;\n};\n\nuuflowManagerForInitApproval.evalFieldMapScript = function(field_map_script, objectName, spaceId, objectId) {\n  var func, record, script, values;\n  record = Creator.getCollection(objectName, spaceId).findOne(objectId);\n  script = \"module.exports = function (record) { \" + field_map_script + \" }\";\n  func = _eval(script, \"field_map_script\");\n  values = func(record);\n  if (_.isObject(values)) {\n    return values;\n  } else {\n    console.error(\"evalFieldMapScript: è„šæœ¬è¿”å›žå€¼ç±»åž‹ä¸æ˜¯å¯¹è±¡\");\n  }\n  return {};\n};\n\nuuflowManagerForInitApproval.initiateAttach = function(recordIds, spaceId, insId, approveId) {\n  Creator.Collections['cms_files'].find({\n    space: spaceId,\n    parent: recordIds\n  }).forEach(function(cf) {\n    return _.each(cf.versions, function(versionId, idx) {\n      var f, newFile;\n      f = Creator.Collections['cfs.files.filerecord'].findOne(versionId);\n      newFile = new FS.File();\n      return newFile.attachData(f.createReadStream('files'), {\n        type: f.original.type\n      }, function(err) {\n        var metadata;\n        if (err) {\n          throw new Meteor.Error(err.error, err.reason);\n        }\n        newFile.name(f.name());\n        newFile.size(f.size());\n        metadata = {\n          owner: f.metadata.owner,\n          owner_name: f.metadata.owner_name,\n          space: spaceId,\n          instance: insId,\n          approve: approveId,\n          parent: cf._id\n        };\n        if (idx === 0) {\n          metadata.current = true;\n        }\n        newFile.metadata = metadata;\n        return cfs.instances.insert(newFile);\n      });\n    });\n  });\n};\n\nuuflowManagerForInitApproval.initiateRecordInstanceInfo = function(recordIds, insId, spaceId) {\n  Creator.getCollection(recordIds.o, spaceId).update(recordIds.ids[0], {\n    $push: {\n      instances: {\n        $each: [\n          {\n            _id: insId,\n            state: 'draft'\n          }\n        ],\n        $position: 0\n      }\n    },\n    $set: {\n      locked: true,\n      instance_state: 'draft'\n    }\n  });\n};\n\nuuflowManagerForInitApproval.initiateRelatedRecordInstanceInfo = function(relatedTablesInfo, insId, spaceId) {\n  _.each(relatedTablesInfo, function(tableItems, relatedObjectName) {\n    var relatedCollection;\n    relatedCollection = Creator.getCollection(relatedObjectName, spaceId);\n    return _.each(tableItems, function(item) {\n      return relatedCollection.update(item._table._id, {\n        $set: {\n          instances: [\n            {\n              _id: insId,\n              state: 'draft'\n            }\n          ],\n          _table: item._table\n        }\n      });\n    });\n  });\n};\n\nuuflowManagerForInitApproval.checkIsInApproval = function(recordIds, spaceId) {\n  var record;\n  record = Creator.getCollection(recordIds.o, spaceId).findOne({\n    _id: recordIds.ids[0],\n    instances: {\n      $exists: true\n    }\n  }, {\n    fields: {\n      instances: 1\n    }\n  });\n  if (record && record.instances[0].state !== 'completed' && Creator.Collections.instances.find(record.instances[0]._id).count() > 0) {\n    throw new Meteor.Error('error!', \"æ­¤è®°å½•å·²å‘èµ·æµç¨‹æ­£åœ¨å®¡æ‰¹ä¸­ï¼Œå¾…å®¡æ‰¹ç»“æŸæ–¹å¯å‘èµ·ä¸‹ä¸€æ¬¡å®¡æ‰¹ï¼\");\n  }\n};\n","JsonRoutes.add \"post\", \"/s3/\",  (req, res, next) ->\r\n\r\n\tJsonRoutes.parseFiles req, res, ()->\r\n\t\tcollection = cfs.files\r\n\t\tfileCollection = Creator.getObject(\"cms_files\").db\r\n\r\n\t\tif req.files and req.files[0]\r\n\r\n\t\t\tnewFile = new FS.File();\r\n\t\t\tnewFile.attachData req.files[0].data, {type: req.files[0].mimeType}, (err) ->\r\n\t\t\t\tfilename = req.files[0].filename\r\n\t\t\t\textention = filename.split('.').pop()\r\n\t\t\t\tif [\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())\r\n\t\t\t\t\tfilename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + extention\r\n\r\n\t\t\t\tbody = req.body\r\n\t\t\t\ttry\r\n\t\t\t\t\tif body && (body['upload_from'] is \"IE\" or body['upload_from'] is \"node\")\r\n\t\t\t\t\t\tfilename = decodeURIComponent(filename)\r\n\t\t\t\tcatch e\r\n\t\t\t\t\tconsole.error(filename)\r\n\t\t\t\t\tconsole.error e\r\n\t\t\t\t\tfilename = filename.replace(/%/g, \"-\")\r\n\r\n\t\t\t\tnewFile.name(filename)\r\n\r\n\t\t\t\tif body && body['owner'] && body['space'] && body['record_id']  && body['object_name']\r\n\t\t\t\t\tparent = body['parent']\r\n\t\t\t\t\towner = body['owner']\r\n\t\t\t\t\towner_name = body['owner_name']\r\n\t\t\t\t\tspace = body['space']\r\n\t\t\t\t\trecord_id = body['record_id']\r\n\t\t\t\t\tobject_name = body['object_name']\r\n\t\t\t\t\tparent = body['parent']\r\n\t\t\t\t\tmetadata = {owner:owner, owner_name:owner_name, space:space, record_id:record_id, object_name: object_name}\r\n\t\t\t\t\tif parent\r\n\t\t\t\t\t\tmetadata.parent = parent\r\n\t\t\t\t\tnewFile.metadata = metadata\r\n\t\t\t\t\tfileObj = collection.insert newFile\r\n\r\n\t\t\t\telse\r\n\t\t\t\t\tfileObj = collection.insert newFile\r\n\r\n\r\n\t\t\t\tsize = fileObj.original.size\r\n\t\t\t\tif !size\r\n\t\t\t\t\tsize = 1024\r\n\t\t\t\tif parent\r\n\t\t\t\t\tfileCollection.update({_id:parent},{\r\n\t\t\t\t\t\t$set:\r\n\t\t\t\t\t\t\textention: extention\r\n\t\t\t\t\t\t\tsize: size\r\n\t\t\t\t\t\t\tmodified: (new Date())\r\n\t\t\t\t\t\t\tmodified_by: owner\r\n\t\t\t\t\t\t$push:\r\n\t\t\t\t\t\t\tversions:\r\n\t\t\t\t\t\t\t\t$each: [ fileObj._id ]\r\n\t\t\t\t\t\t\t\t$position: 0\r\n\t\t\t\t\t})\r\n\t\t\t\telse\r\n\t\t\t\t\tnewFileObjId = fileCollection.direct.insert {\r\n\t\t\t\t\t\tname: filename\r\n\t\t\t\t\t\tdescription: ''\r\n\t\t\t\t\t\textention: extention\r\n\t\t\t\t\t\tsize: size\r\n\t\t\t\t\t\tversions: [fileObj._id]\r\n\t\t\t\t\t\tparent: {o:object_name,ids:[record_id]}\r\n\t\t\t\t\t\towner: owner\r\n\t\t\t\t\t\tspace: space\r\n\t\t\t\t\t\tcreated: (new Date())\r\n\t\t\t\t\t\tcreated_by: owner\r\n\t\t\t\t\t\tmodified: (new Date())\r\n\t\t\t\t\t\tmodified_by: owner\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfileObj.update({$set: {'metadata.parent' : newFileObjId}})\r\n\r\n\t\t\t\tresp =\r\n\t\t\t\t\tversion_id: fileObj._id,\r\n\t\t\t\t\tsize: size\r\n\r\n\t\t\t\tres.setHeader(\"x-amz-version-id\",fileObj._id);\r\n\t\t\t\tres.end(JSON.stringify(resp));\r\n\t\t\t\treturn\r\n\t\telse\r\n\t\t\tres.statusCode = 500;\r\n\t\t\tres.end();\r\n\r\nJsonRoutes.add \"post\", \"/s3/:collection\",  (req, res, next) ->\r\n\ttry\r\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res)\r\n\t\tif !userId\r\n\t\t\tthrow new Meteor.Error(500, \"No permission\")\r\n\r\n\t\tcollectionName = req.params.collection\r\n\r\n\t\tJsonRoutes.parseFiles req, res, ()->\r\n\t\t\tcollection = cfs[collectionName]\r\n\r\n\t\t\tif not collection\r\n\t\t\t\tthrow new Meteor.Error(500, \"No Collection\")\r\n\r\n\t\t\tif req.files and req.files[0]\r\n\r\n\t\t\t\tnewFile = new FS.File()\r\n\t\t\t\tnewFile.name(req.files[0].filename)\r\n\r\n\t\t\t\tif req.body\r\n\t\t\t\t\tnewFile.metadata = req.body\r\n\r\n\t\t\t\tnewFile.owner = userId\r\n\t\t\t\tnewFile.metadata.owner = userId\r\n\r\n\t\t\t\tnewFile.attachData req.files[0].data, {type: req.files[0].mimeType}\r\n\r\n\t\t\t\tcollection.insert newFile\r\n\r\n\t\t\t\tresultData = collection.files.findOne(newFile._id)\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 200\r\n\t\t\t\t\tdata: resultData\r\n\t\t\t\treturn\r\n\t\t\telse\r\n\t\t\t\tthrow new Meteor.Error(500, \"No File\")\r\n\r\n\t\treturn\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: e.error || 500\r\n\t\t\tdata: {errors: e.reason || e.message}\r\n\t\t}\r\n\r\n\r\n\r\ngetQueryString = (accessKeyId, secretAccessKey, query, method) ->\r\n\tconsole.log \"----uuflowManager.getQueryString----\"\r\n\tALY = require('aliyun-sdk')\r\n\tdate = ALY.util.date.getDate()\r\n\r\n\tquery.Format = \"json\"\r\n\tquery.Version = \"2017-03-21\"\r\n\tquery.AccessKeyId = accessKeyId\r\n\tquery.SignatureMethod = \"HMAC-SHA1\"\r\n\tquery.Timestamp = ALY.util.date.iso8601(date)\r\n\tquery.SignatureVersion = \"1.0\"\r\n\tquery.SignatureNonce = String(date.getTime())\r\n\r\n\tqueryKeys = Object.keys(query)\r\n\tqueryKeys.sort()\r\n\r\n\tcanonicalizedQueryString = \"\"\r\n\tqueryKeys.forEach (name) ->\r\n\t\tcanonicalizedQueryString += \"&\" + name + \"=\" + ALY.util.popEscape(query[name])\r\n\r\n\tstringToSign = method.toUpperCase() + '&%2F&' + ALY.util.popEscape(canonicalizedQueryString.substr(1))\r\n\r\n\tquery.Signature = ALY.util.crypto.hmac(secretAccessKey + '&', stringToSign, 'base64', 'sha1')\r\n\r\n\tqueryStr = ALY.util.queryParamsToString(query)\r\n\tconsole.log queryStr\r\n\treturn queryStr\r\n\r\nJsonRoutes.add \"post\", \"/s3/vod/upload\",  (req, res, next) ->\r\n\ttry\r\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res)\r\n\t\tif !userId\r\n\t\t\tthrow new Meteor.Error(500, \"No permission\")\r\n\r\n\t\tcollectionName = \"videos\"\r\n\r\n\t\tALY = require('aliyun-sdk')\r\n\r\n\t\tJsonRoutes.parseFiles req, res, ()->\r\n\t\t\tcollection = cfs[collectionName]\r\n\r\n\t\t\tif not collection\r\n\t\t\t\tthrow new Meteor.Error(500, \"No Collection\")\r\n\r\n\t\t\tif req.files and req.files[0]\r\n\r\n\t\t\t\tif collectionName is 'videos' and Meteor.settings.public.cfs?.store is \"OSS\"\r\n\t\t\t\t\taccessKeyId = Meteor.settings.cfs.aliyun?.accessKeyId\r\n\t\t\t\t\tsecretAccessKey = Meteor.settings.cfs.aliyun?.secretAccessKey\r\n\r\n\t\t\t\t\tdate = ALY.util.date.getDate()\r\n\r\n\t\t\t\t\tquery = {\r\n\t\t\t\t\t\tAction: \"CreateUploadVideo\"\r\n\t\t\t\t\t\tTitle: req.files[0].filename\r\n\t\t\t\t\t\tFileName: req.files[0].filename\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\turl = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, query, 'GET')\r\n\r\n\t\t\t\t\tr = HTTP.call 'GET', url\r\n\r\n\t\t\t\t\tconsole.log r\r\n\r\n\t\t\t\t\tif r.data?.VideoId\r\n\t\t\t\t\t\tvideoId = r.data.VideoId\r\n\t\t\t\t\t\tuploadAddress = JSON.parse(new Buffer(r.data.UploadAddress, 'base64').toString())\r\n\t\t\t\t\t\tconsole.log uploadAddress\r\n\t\t\t\t\t\tuploadAuth = JSON.parse(new Buffer(r.data.UploadAuth, 'base64').toString())\r\n\t\t\t\t\t\tconsole.log uploadAuth\r\n\r\n\t\t\t\t\t\toss = new ALY.OSS({\r\n\t\t\t\t\t\t\t\"accessKeyId\": uploadAuth.AccessKeyId,\r\n\t\t\t\t\t\t\t\"secretAccessKey\": uploadAuth.AccessKeySecret,\r\n\t\t\t\t\t\t\t\"endpoint\": uploadAddress.Endpoint,\r\n\t\t\t\t\t\t\t\"apiVersion\": '2013-10-15',\r\n\t\t\t\t\t\t\t\"securityToken\": uploadAuth.SecurityToken\r\n\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t\toss.putObject {\r\n\t\t\t\t\t\t\tBucket: uploadAddress.Bucket,\r\n\t\t\t\t\t\t\tKey: uploadAddress.FileName,\r\n\t\t\t\t\t\t\tBody: req.files[0].data,\r\n\t\t\t\t\t\t\tAccessControlAllowOrigin: '',\r\n\t\t\t\t\t\t\tContentType: req.files[0].mimeType,\r\n\t\t\t\t\t\t\tCacheControl: 'no-cache',\r\n\t\t\t\t\t\t\tContentDisposition: '',\r\n\t\t\t\t\t\t\tContentEncoding: 'utf-8',\r\n\t\t\t\t\t\t\tServerSideEncryption: 'AES256',\r\n\t\t\t\t\t\t\tExpires: null\r\n\t\t\t\t\t\t}, Meteor.bindEnvironment (err, data) ->\r\n\r\n\t\t\t\t\t\t\tif err\r\n\t\t\t\t\t\t\t\tconsole.log('error:', err)\r\n\t\t\t\t\t\t\t\tthrow new Meteor.Error(500, err.message)\r\n\r\n\t\t\t\t\t\t\tconsole.log('success:', data)\r\n\r\n\t\t\t\t\t\t\tnewDate = ALY.util.date.getDate()\r\n\r\n\t\t\t\t\t\t\tgetPlayInfoQuery = {\r\n\t\t\t\t\t\t\t\tAction: 'GetPlayInfo'\r\n\t\t\t\t\t\t\t\tVideoId: videoId\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tgetPlayInfoUrl = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, getPlayInfoQuery, 'GET')\r\n\r\n\t\t\t\t\t\t\tgetPlayInfoResult = HTTP.call 'GET', getPlayInfoUrl\r\n\r\n\t\t\t\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\t\t\t\tcode: 200\r\n\t\t\t\t\t\t\t\tdata: getPlayInfoResult\r\n\r\n\t\t\telse\r\n\t\t\t\tthrow new Meteor.Error(500, \"No File\")\r\n\r\n\t\treturn\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: e.error || 500\r\n\t\t\tdata: {errors: e.reason || e.message}\r\n\t\t}","var getQueryString;\n\nJsonRoutes.add(\"post\", \"/s3/\", function(req, res, next) {\n  return JsonRoutes.parseFiles(req, res, function() {\n    var collection, fileCollection, newFile;\n    collection = cfs.files;\n    fileCollection = Creator.getObject(\"cms_files\").db;\n    if (req.files && req.files[0]) {\n      newFile = new FS.File();\n      return newFile.attachData(req.files[0].data, {\n        type: req.files[0].mimeType\n      }, function(err) {\n        var body, e, extention, fileObj, filename, metadata, newFileObjId, object_name, owner, owner_name, parent, record_id, resp, size, space;\n        filename = req.files[0].filename;\n        extention = filename.split('.').pop();\n        if ([\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())) {\n          filename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + extention;\n        }\n        body = req.body;\n        try {\n          if (body && (body['upload_from'] === \"IE\" || body['upload_from'] === \"node\")) {\n            filename = decodeURIComponent(filename);\n          }\n        } catch (error) {\n          e = error;\n          console.error(filename);\n          console.error(e);\n          filename = filename.replace(/%/g, \"-\");\n        }\n        newFile.name(filename);\n        if (body && body['owner'] && body['space'] && body['record_id'] && body['object_name']) {\n          parent = body['parent'];\n          owner = body['owner'];\n          owner_name = body['owner_name'];\n          space = body['space'];\n          record_id = body['record_id'];\n          object_name = body['object_name'];\n          parent = body['parent'];\n          metadata = {\n            owner: owner,\n            owner_name: owner_name,\n            space: space,\n            record_id: record_id,\n            object_name: object_name\n          };\n          if (parent) {\n            metadata.parent = parent;\n          }\n          newFile.metadata = metadata;\n          fileObj = collection.insert(newFile);\n        } else {\n          fileObj = collection.insert(newFile);\n        }\n        size = fileObj.original.size;\n        if (!size) {\n          size = 1024;\n        }\n        if (parent) {\n          fileCollection.update({\n            _id: parent\n          }, {\n            $set: {\n              extention: extention,\n              size: size,\n              modified: new Date(),\n              modified_by: owner\n            },\n            $push: {\n              versions: {\n                $each: [fileObj._id],\n                $position: 0\n              }\n            }\n          });\n        } else {\n          newFileObjId = fileCollection.direct.insert({\n            name: filename,\n            description: '',\n            extention: extention,\n            size: size,\n            versions: [fileObj._id],\n            parent: {\n              o: object_name,\n              ids: [record_id]\n            },\n            owner: owner,\n            space: space,\n            created: new Date(),\n            created_by: owner,\n            modified: new Date(),\n            modified_by: owner\n          });\n          fileObj.update({\n            $set: {\n              'metadata.parent': newFileObjId\n            }\n          });\n        }\n        resp = {\n          version_id: fileObj._id,\n          size: size\n        };\n        res.setHeader(\"x-amz-version-id\", fileObj._id);\n        res.end(JSON.stringify(resp));\n      });\n    } else {\n      res.statusCode = 500;\n      return res.end();\n    }\n  });\n});\n\nJsonRoutes.add(\"post\", \"/s3/:collection\", function(req, res, next) {\n  var collectionName, e, userId;\n  try {\n    userId = Steedos.getUserIdFromAuthToken(req, res);\n    if (!userId) {\n      throw new Meteor.Error(500, \"No permission\");\n    }\n    collectionName = req.params.collection;\n    JsonRoutes.parseFiles(req, res, function() {\n      var collection, newFile, resultData;\n      collection = cfs[collectionName];\n      if (!collection) {\n        throw new Meteor.Error(500, \"No Collection\");\n      }\n      if (req.files && req.files[0]) {\n        newFile = new FS.File();\n        newFile.name(req.files[0].filename);\n        if (req.body) {\n          newFile.metadata = req.body;\n        }\n        newFile.owner = userId;\n        newFile.metadata.owner = userId;\n        newFile.attachData(req.files[0].data, {\n          type: req.files[0].mimeType\n        });\n        collection.insert(newFile);\n        resultData = collection.files.findOne(newFile._id);\n        JsonRoutes.sendResult(res, {\n          code: 200,\n          data: resultData\n        });\n      } else {\n        throw new Meteor.Error(500, \"No File\");\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: e.error || 500,\n      data: {\n        errors: e.reason || e.message\n      }\n    });\n  }\n});\n\ngetQueryString = function(accessKeyId, secretAccessKey, query, method) {\n  var ALY, canonicalizedQueryString, date, queryKeys, queryStr, stringToSign;\n  console.log(\"----uuflowManager.getQueryString----\");\n  ALY = require('aliyun-sdk');\n  date = ALY.util.date.getDate();\n  query.Format = \"json\";\n  query.Version = \"2017-03-21\";\n  query.AccessKeyId = accessKeyId;\n  query.SignatureMethod = \"HMAC-SHA1\";\n  query.Timestamp = ALY.util.date.iso8601(date);\n  query.SignatureVersion = \"1.0\";\n  query.SignatureNonce = String(date.getTime());\n  queryKeys = Object.keys(query);\n  queryKeys.sort();\n  canonicalizedQueryString = \"\";\n  queryKeys.forEach(function(name) {\n    return canonicalizedQueryString += \"&\" + name + \"=\" + ALY.util.popEscape(query[name]);\n  });\n  stringToSign = method.toUpperCase() + '&%2F&' + ALY.util.popEscape(canonicalizedQueryString.substr(1));\n  query.Signature = ALY.util.crypto.hmac(secretAccessKey + '&', stringToSign, 'base64', 'sha1');\n  queryStr = ALY.util.queryParamsToString(query);\n  console.log(queryStr);\n  return queryStr;\n};\n\nJsonRoutes.add(\"post\", \"/s3/vod/upload\", function(req, res, next) {\n  var ALY, collectionName, e, userId;\n  try {\n    userId = Steedos.getUserIdFromAuthToken(req, res);\n    if (!userId) {\n      throw new Meteor.Error(500, \"No permission\");\n    }\n    collectionName = \"videos\";\n    ALY = require('aliyun-sdk');\n    JsonRoutes.parseFiles(req, res, function() {\n      var accessKeyId, collection, date, oss, query, r, ref, ref1, ref2, ref3, secretAccessKey, uploadAddress, uploadAuth, url, videoId;\n      collection = cfs[collectionName];\n      if (!collection) {\n        throw new Meteor.Error(500, \"No Collection\");\n      }\n      if (req.files && req.files[0]) {\n        if (collectionName === 'videos' && ((ref = Meteor.settings[\"public\"].cfs) != null ? ref.store : void 0) === \"OSS\") {\n          accessKeyId = (ref1 = Meteor.settings.cfs.aliyun) != null ? ref1.accessKeyId : void 0;\n          secretAccessKey = (ref2 = Meteor.settings.cfs.aliyun) != null ? ref2.secretAccessKey : void 0;\n          date = ALY.util.date.getDate();\n          query = {\n            Action: \"CreateUploadVideo\",\n            Title: req.files[0].filename,\n            FileName: req.files[0].filename\n          };\n          url = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, query, 'GET');\n          r = HTTP.call('GET', url);\n          console.log(r);\n          if ((ref3 = r.data) != null ? ref3.VideoId : void 0) {\n            videoId = r.data.VideoId;\n            uploadAddress = JSON.parse(new Buffer(r.data.UploadAddress, 'base64').toString());\n            console.log(uploadAddress);\n            uploadAuth = JSON.parse(new Buffer(r.data.UploadAuth, 'base64').toString());\n            console.log(uploadAuth);\n            oss = new ALY.OSS({\n              \"accessKeyId\": uploadAuth.AccessKeyId,\n              \"secretAccessKey\": uploadAuth.AccessKeySecret,\n              \"endpoint\": uploadAddress.Endpoint,\n              \"apiVersion\": '2013-10-15',\n              \"securityToken\": uploadAuth.SecurityToken\n            });\n            return oss.putObject({\n              Bucket: uploadAddress.Bucket,\n              Key: uploadAddress.FileName,\n              Body: req.files[0].data,\n              AccessControlAllowOrigin: '',\n              ContentType: req.files[0].mimeType,\n              CacheControl: 'no-cache',\n              ContentDisposition: '',\n              ContentEncoding: 'utf-8',\n              ServerSideEncryption: 'AES256',\n              Expires: null\n            }, Meteor.bindEnvironment(function(err, data) {\n              var getPlayInfoQuery, getPlayInfoResult, getPlayInfoUrl, newDate;\n              if (err) {\n                console.log('error:', err);\n                throw new Meteor.Error(500, err.message);\n              }\n              console.log('success:', data);\n              newDate = ALY.util.date.getDate();\n              getPlayInfoQuery = {\n                Action: 'GetPlayInfo',\n                VideoId: videoId\n              };\n              getPlayInfoUrl = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, getPlayInfoQuery, 'GET');\n              getPlayInfoResult = HTTP.call('GET', getPlayInfoUrl);\n              return JsonRoutes.sendResult(res, {\n                code: 200,\n                data: getPlayInfoResult\n              });\n            }));\n          }\n        }\n      } else {\n        throw new Meteor.Error(500, \"No File\");\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: e.error || 500,\n      data: {\n        errors: e.reason || e.message\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/object/workflow/drafts', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManagerForInitApproval.check_authorization(req)\r\n\t\tcurrent_user_id = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\r\n\t\tinserted_instances = new Array\r\n\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tnew_ins_id = uuflowManagerForInitApproval.create_instance(instance_from_client, current_user_info)\r\n\r\n\t\t\tnew_ins = Creator.Collections.instances.findOne({ _id: new_ins_id }, { fields: { space: 1, flow: 1, flow_version: 1, form: 1, form_version: 1 } })\r\n\r\n\t\t\tinserted_instances.push(new_ins)\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { inserts: inserted_instances }\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.reason || e.message }] }\r\n\t\t}\r\n\r\n","JsonRoutes.add('post', '/api/object/workflow/drafts', function(req, res, next) {\n  var current_user_id, current_user_info, e, hashData, inserted_instances;\n  try {\n    current_user_info = uuflowManagerForInitApproval.check_authorization(req);\n    current_user_id = current_user_info._id;\n    hashData = req.body;\n    inserted_instances = new Array;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var new_ins, new_ins_id;\n      new_ins_id = uuflowManagerForInitApproval.create_instance(instance_from_client, current_user_info);\n      new_ins = Creator.Collections.instances.findOne({\n        _id: new_ins_id\n      }, {\n        fields: {\n          space: 1,\n          flow: 1,\n          flow_version: 1,\n          form: 1,\n          form_version: 1\n        }\n      });\n      return inserted_instances.push(new_ins);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        inserts: inserted_instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.reason || e.message\n          }\n        ]\n      }\n    });\n  }\n});\n"]}