{"version":3,"sources":["meteor://ğŸ’»app/packages/steedos_workflow-chart/routes/chart.coffee","meteor://ğŸ’»app/routes/chart.coffee"],"names":["FlowversionAPI","traceMaxApproveCount","traceSplitApprovesIndex","isExpandApprove","getAbsoluteUrl","url","rootUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","writeResponse","res","httpCode","body","statusCode","end","sendInvalidURLResponse","sendAuthTokenExpiredResponse","replaceErrorSymbol","str","replace","getStepHandlerName","step","insId","approverNames","e","loginUserId","stepHandlerName","stepId","userIds","step_type","_id","getHandlersManager","getHandlers","map","userId","user","db","users","findOne","fields","name","length","slice","join","error","getStepLabel","stepName","getStepName","cachedStepNames","instance_id","cachedStepName","generateStepsGraphSyntax","steps","currentStepId","isConvertToString","direction","graphSyntax","nodes","forEach","lines","line","toStep","toStepName","push","findPropertyByPK","to_step","getApproveJudgeText","judge","judgeText","locale","TAPi18n","__","getTraceName","traceName","approveHandlerName","getTraceFromApproveCountersWithType","trace","approves","counters","approve","from_approve_id","type","getTraceCountersWithType","traceFromApproveCounters","toApprove","toApproveFromId","toApproveHandlerName","toApproveType","handler_name","fromApprove","counter","counter2","counterContent","ref","from_type","from_approve_handler_name","to_approve_id","to_approve_handler_name","count","to_approve_handler_names","is_total","pushApprovesWithTypeGraphSyntax","currentTraceName","extraHandlerNamesCounter","fromApproveId","results","splitIndex","tempHandlerNames","toApproveId","toApproves","traceCounters","extraCount","isTypeNode","strToHandlerNames","toHandlerNames","typeName","indexOf","splice","_","isEmpty","results1","generateTracesGraphSyntax","traces","lastApproves","lastTrace","previous_trace_ids","currentFromTraceName","fromApproves","fromTrace","fromApproveHandlerName","fromTraceName","toTraceName","lastApprove","sendHtmlResponse","req","allowDirections","error_msg","flowversion","instance","query","ref1","title","include","decodeURIComponent","instances","flow_version","flow","$slice","WorkflowManager","getInstanceFlowVersion","setHeader","JSON","stringify","JsonRoutes","add","next"],"mappings":"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","file":"/packages/steedos_workflow-chart.js","sourcesContent":["FlowversionAPI =\n\n\ttraceMaxApproveCount: 10\n\ttraceSplitApprovesIndex: 5\n\tisExpandApprove: false\n\n\tgetAbsoluteUrl: (url)->\n\t\trootUrl = if __meteor_runtime_config__ then __meteor_runtime_config__.ROOT_URL_PATH_PREFIX else \"\"\n\t\tif rootUrl\n\t\t\turl = rootUrl + url\n\t\treturn url;\n\n\twriteResponse: (res, httpCode, body)->\n\t\tres.statusCode = httpCode;\n\t\tres.end(body);\n\t\t\n\tsendInvalidURLResponse: (res)->\n\t\treturn @writeResponse(res, 404, \"url must has querys as instance_id.\");\n\t\t\n\tsendAuthTokenExpiredResponse: (res)->\n\t\treturn @writeResponse(res, 401, \"the auth_token has expired.\");\n\n\treplaceErrorSymbol: (str)->\n\t\treturn str.replace(/\\\"/g,\"&quot;\").replace(/\\n/g,\"<br/>\")\n\n\tgetStepHandlerName: (step, insId)->\n\t\ttry\n\t\t\tstepHandlerName = \"\"\n\t\t\tif step.step_type == \"condition\"\n\t\t\t\treturn stepHandlerName\n\n\t\t\t# TODO è·å–å½“å‰ç”¨æˆ·userId\n\t\t\tloginUserId = '' \n\t\t\tstepId = step._id\n\t\t\tuserIds = getHandlersManager.getHandlers(insId, stepId, loginUserId)\n\t\t\tapproverNames = userIds.map (userId)->\n\t\t\t\tuser = db.users.findOne(userId, { fields: { name: 1 } })\n\t\t\t\tif user\n\t\t\t\t\treturn user.name\n\t\t\t\telse\n\t\t\t\t\treturn \"\"\n\t\t\tif approverNames.length > 3\n        \t\tstepHandlerName = approverNames.slice(0,3).join(\",\") + \"...\"\n      \t\telse\n        \t\tstepHandlerName = approverNames.join(\",\")\n\t\t\t\n\t\t\treturn stepHandlerName\n\t\tcatch e\n\t\t\treturn \"\";\n\t\t# switch step.deal_type\n\t\t# \twhen 'specifyUser'\n\t\t# \t\tapproverNames = step.approver_users.map (userId)->\n\t\t# \t\t\tuser = db.users.findOne(userId)\n\t\t# \t\t\tif user\n\t\t# \t\t\t\treturn user.name\n\t\t# \t\t\telse\n\t\t# \t\t\t\treturn \"\"\n\t\t# \t\tstepHandlerName = approverNames.join(\",\")\n\t\t# \twhen 'applicantRole'\n\t\t# \t\tapproverNames = step.approver_roles.map (roleId)->\n\t\t# \t\t\trole = db.flow_roles.findOne(roleId)\n\t\t# \t\t\tif role\n\t\t# \t\t\t\treturn role.name\n\t\t# \t\t\telse\n\t\t# \t\t\t\treturn \"\"\n\t\t# \t\tstepHandlerName = approverNames.join(\",\")\n\t\t# \telse\n\t\t# \t\tstepHandlerName = ''\n\t\t# \t\tbreak\n\t\t# return stepHandlerName\n\n\tgetStepLabel: (stepName, stepHandlerName)->\n\t\t# è¿”å›sstepNameä¸stepHandlerNameç»“åˆçš„æ­¥éª¤æ˜¾ç¤ºåç§°\n\t\tif stepName\n\t\t\tstepName = \"<div class='graph-node'>\n\t\t\t\t<div class='step-name'>#{stepName}</div>\n\t\t\t\t<div class='step-handler-name'>#{stepHandlerName}</div>\n\t\t\t</div>\"\n\t\t\t# æŠŠç‰¹æ®Šå­—ç¬¦æ¸…ç©ºæˆ–æ›¿æ¢ï¼Œä»¥é¿å…mermaidAPIå‡ºç°å¼‚å¸¸\n\t\t\tstepName = FlowversionAPI.replaceErrorSymbol(stepName)\n\t\telse\n\t\t\tstepName = \"\"\n\t\treturn stepName\n\n\tgetStepName: (step, cachedStepNames, instance_id)->\n\t\t# è¿”å›stepèŠ‚ç‚¹åç§°ï¼Œä¼˜å…ˆä»ç¼“å­˜cachedStepNamesä¸­å–ï¼Œå¦åˆ™è°ƒç”¨getStepLabelç”Ÿæˆ\n\t\tcachedStepName = cachedStepNames[step._id]\n\t\tif cachedStepName\n\t\t\treturn cachedStepName\n\t\tstepHandlerName = FlowversionAPI.getStepHandlerName(step, instance_id)\n\t\tstepName = FlowversionAPI.getStepLabel(step.name, stepHandlerName)\n\t\tcachedStepNames[step._id] = stepName\n\t\treturn stepName\n\n\tgenerateStepsGraphSyntax: (steps, currentStepId, isConvertToString, direction, instance_id)->\n\t\tnodes = [\"graph #{direction}\"]\n\t\tcachedStepNames = {}\n\t\tsteps.forEach (step)->\n\t\t\tlines = step.lines\n\t\t\tif lines?.length\n\t\t\t\tlines.forEach (line)->\n\t\t\t\t\tif step.name\n\t\t\t\t\t\t# æ ‡è®°æ¡ä»¶èŠ‚ç‚¹\n\t\t\t\t\t\tif step.step_type == \"condition\"\n\t\t\t\t\t\t\tnodes.push \"\tclass #{step._id} condition;\"\n\t\t\t\t\t\tstepName = FlowversionAPI.getStepName(step, cachedStepNames, instance_id)\n\t\t\t\t\telse\n\t\t\t\t\t\tstepName = \"\"\n\t\t\t\t\ttoStep = steps.findPropertyByPK(\"_id\",line.to_step)\n\t\t\t\t\ttoStepName = FlowversionAPI.getStepName(toStep, cachedStepNames, instance_id)\n\t\t\t\t\tnodes.push \"\t#{step._id}(\\\"#{stepName}\\\")-->#{line.to_step}(\\\"#{toStepName}\\\")\"\n\n\t\tif currentStepId\n\t\t\tnodes.push \"\tclass #{currentStepId} current-step-node;\"\n\t\tif isConvertToString\n\t\t\tgraphSyntax = nodes.join \"\\n\"\n\t\t\treturn graphSyntax\n\t\telse\n\t\t\treturn nodes\n\n\tgetApproveJudgeText: (judge)->\n\t\tlocale = \"zh-CN\"\n\t\tswitch judge\n\t\t\twhen 'approved'\n\t\t\t\t# å·²æ ¸å‡†\n\t\t\t\tjudgeText = TAPi18n.__('Instance State approved', {}, locale)\n\t\t\twhen 'rejected'\n\t\t\t\t# å·²é©³å›\n\t\t\t\tjudgeText = TAPi18n.__('Instance State rejected', {}, locale)\n\t\t\twhen 'terminated'\n\t\t\t\t# å·²å–æ¶ˆ\n\t\t\t\tjudgeText = TAPi18n.__('Instance State terminated', {}, locale)\n\t\t\twhen 'reassigned'\n\t\t\t\t# è½¬ç­¾æ ¸\n\t\t\t\tjudgeText = TAPi18n.__('Instance State reassigned', {}, locale)\n\t\t\twhen 'relocated'\n\t\t\t\t# é‡å®šä½\n\t\t\t\tjudgeText = TAPi18n.__('Instance State relocated', {}, locale)\n\t\t\twhen 'retrieved'\n\t\t\t\t# å·²å–å›\n\t\t\t\tjudgeText = TAPi18n.__('Instance State retrieved', {}, locale)\n\t\t\twhen 'returned'\n\t\t\t\t# å·²é€€å›\n\t\t\t\tjudgeText = TAPi18n.__('Instance State returned', {}, locale)\n\t\t\twhen 'readed'\n\t\t\t\t# å·²é˜…\n\t\t\t\tjudgeText = TAPi18n.__('Instance State readed', {}, locale)\n\t\t\telse\n\t\t\t\tjudgeText = ''\n\t\t\t\tbreak\n\t\treturn judgeText\n\n\tgetTraceName: (traceName, approveHandlerName)->\n\t\t# è¿”å›traceèŠ‚ç‚¹åç§°\n\t\tif traceName\n\t\t\t# æŠŠç‰¹æ®Šå­—ç¬¦æ¸…ç©ºæˆ–æ›¿æ¢ï¼Œä»¥é¿å…mermaidAPIå‡ºç°å¼‚å¸¸\n\t\t\ttraceName = \"<div class='graph-node'>\n\t\t\t\t<div class='trace-name'>#{traceName}</div>\n\t\t\t\t<div class='trace-handler-name'>#{approveHandlerName}</div>\n\t\t\t</div>\"\n\t\t\ttraceName = FlowversionAPI.replaceErrorSymbol(traceName)\n\t\telse\n\t\t\ttraceName = \"\"\n\t\treturn traceName\n\t\n\tgetTraceFromApproveCountersWithType: (trace)->\n\t\t# è¯¥å‡½æ•°ç”Ÿæˆjsonç»“æ„ï¼Œè¡¨ç°å‡ºæ‰€æœ‰ä¼ é˜…ã€åˆ†å‘ã€è½¬å‘èŠ‚ç‚¹æœ‰æœ‰åç»­å­èŠ‚ç‚¹çš„è®¡æ•°æƒ…å†µï¼Œå…¶ç»“æ„ä¸ºï¼š\n\t\t# counters = {\n\t\t# \t[fromApproveId(æ¥æºèŠ‚ç‚¹ID)]:{\n\t\t# \t\t[toApproveType(ç›®æ ‡ç»“ç‚¹ç±»å‹)]:ç›®æ ‡èŠ‚ç‚¹åœ¨æŒ‡å®šç±»å‹ä¸‹çš„åç»­èŠ‚ç‚¹ä¸ªæ•°\n\t\t# \t}\n\t\t# }\n\t\tcounters = {}\n\t\tapproves = trace.approves\n\t\tunless approves\n\t\t\treturn null\n\t\tapproves.forEach (approve)->\n\t\t\tif approve.from_approve_id\n\t\t\t\tunless counters[approve.from_approve_id]\n\t\t\t\t\tcounters[approve.from_approve_id] = {}\n\t\t\t\tif counters[approve.from_approve_id][approve.type]\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type]++\n\t\t\t\telse\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type] = 1\n\t\treturn counters\n\n\tgetTraceCountersWithType: (trace, traceFromApproveCounters)->\n\t\t# è¯¥å‡½æ•°ç”Ÿæˆjsonç»“æ„ï¼Œè¡¨ç°å‡ºæ‰€æœ‰ä¼ é˜…ã€åˆ†å‘ã€è½¬å‘çš„èŠ‚ç‚¹æµå‘ï¼Œå…¶ç»“æ„ä¸ºï¼š\n\t\t# counters = {\n\t\t# \t[fromApproveId(æ¥æºèŠ‚ç‚¹ID)]:{\n\t\t# \t\t[toApproveType(ç›®æ ‡ç»“ç‚¹ç±»å‹)]:[{\n\t\t# \t\t\tfrom_type: æ¥æºèŠ‚ç‚¹ç±»å‹\n\t\t# \t\t\tfrom_approve_handler_name: æ¥æºèŠ‚ç‚¹å¤„ç†äºº\n\t\t# \t\t\tto_approve_id: ç›®æ ‡èŠ‚ç‚¹ID\n\t\t# \t\t\tto_approve_handler_names: [å¤šä¸ªç›®æ ‡èŠ‚ç‚¹æ±‡æ€»å¤„ç†äººé›†åˆ]\n\t\t# \t\t\tis_total: true/falseï¼Œæ˜¯å¦æ±‡æ€»èŠ‚ç‚¹\n\t\t# \t\t},...]\n\t\t# \t}\n\t\t# }\n\t\t# ä¸Šè¿°ç›®æ ‡ç»“ç‚¹å†…å®¹ä¸­æœ‰ä¸€ä¸ªå±æ€§is_totalè¡¨ç¤ºæ˜¯å¦æ±‡æ€»èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æŠŠå¤šä¸ªèŠ‚ç‚¹æ±‡æ€»åˆå¹¶æˆä¸€ä¸ªï¼Œ\n\t\t# ä½†æ˜¯æœ¬èº«æœ‰åç»­å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ä¸å‚ä¸æ±‡æ€»åŠè®¡æ•°ã€‚\n\t\tcounters = {}\n\t\tapproves = trace.approves\n\t\tunless approves\n\t\t\treturn null\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\n\t\tisExpandApprove = FlowversionAPI.isExpandApprove\n\n\t\tapproves.forEach (toApprove)->\n\t\t\ttoApproveType = toApprove.type\n\t\t\ttoApproveFromId = toApprove.from_approve_id\n\t\t\ttoApproveHandlerName = toApprove.handler_name\n\t\t\tunless toApproveFromId\n\t\t\t\treturn\n\t\t\tapproves.forEach (fromApprove)->\n\t\t\t\tif fromApprove._id == toApproveFromId\n\t\t\t\t\tcounter = counters[toApproveFromId]\n\t\t\t\t\tunless counter\n\t\t\t\t\t\tcounter = counters[toApproveFromId] = {}\n\t\t\t\t\tunless counter[toApprove.type]\n\t\t\t\t\t\tcounter[toApprove.type] = []\n\t\t\t\t\tcounter2 = counter[toApprove.type]\n\t\t\t\t\tif traceFromApproveCounters[toApprove._id]?[toApproveType]\n\t\t\t\t\t\t# æœ‰åç»­å­èŠ‚ç‚¹ï¼Œåˆ™ä¸å‚ä¸æ±‡æ€»åŠè®¡æ•°\n\t\t\t\t\t\tcounter2.push\n\t\t\t\t\t\t\tfrom_type: fromApprove.type\n\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\n\t\t\t\t\t\t\tto_approve_id: toApprove._id\n\t\t\t\t\t\t\tto_approve_handler_name: toApprove.handler_name\n\n\t\t\t\t\telse\n\t\t\t\t\t\tcounterContent = if isExpandApprove then null else counter2.findPropertyByPK(\"is_total\", true)\n\t\t\t\t\t\t# counterContent = counter2.findPropertyByPK(\"is_total\", true)\n\t\t\t\t\t\t# å¦‚æœå¼ºåˆ¶è¦æ±‚å±•å¼€æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ™ä¸åšæ±‡æ€»å¤„ç†\n\t\t\t\t\t\tif counterContent\n\t\t\t\t\t\t\tcounterContent.count++\n\t\t\t\t\t\t\tunless counterContent.count > traceMaxApproveCount\n\t\t\t\t\t\t\t\tcounterContent.to_approve_handler_names.push toApprove.handler_name\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tcounter2.push\n\t\t\t\t\t\t\t\tfrom_type: fromApprove.type\n\t\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\n\t\t\t\t\t\t\t\tto_approve_id: toApprove._id\n\t\t\t\t\t\t\t\tcount: 1\n\t\t\t\t\t\t\t\tto_approve_handler_names: [toApprove.handler_name]\n\t\t\t\t\t\t\t\tis_total: true\n\n\t\treturn counters\n\n\tpushApprovesWithTypeGraphSyntax: (nodes, trace)->\n\t\ttraceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType trace\n\t\ttraceCounters = FlowversionAPI.getTraceCountersWithType trace, traceFromApproveCounters\n\t\tunless traceCounters\n\t\t\treturn\n\t\textraHandlerNamesCounter = {} #è®°å½•éœ€è¦é¢å¤–ç”Ÿæˆæ‰€æœ‰å¤„ç†äººå§“åçš„è¢«ä¼ é˜…ã€åˆ†å‘ã€è½¬å‘èŠ‚ç‚¹\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\n\t\tsplitIndex = FlowversionAPI.traceSplitApprovesIndex\n\t\tcurrentTraceName = trace.name\n\t\tfor fromApproveId,fromApprove of traceCounters\n\t\t\tfor toApproveType,toApproves of fromApprove\n\t\t\t\ttoApproves.forEach (toApprove)->\n\t\t\t\t\ttypeName = \"\"\n\t\t\t\t\tswitch toApproveType\n\t\t\t\t\t\twhen 'cc'\n\t\t\t\t\t\t\ttypeName = \"ä¼ é˜…\"\n\t\t\t\t\t\twhen 'forward'\n\t\t\t\t\t\t\ttypeName = \"è½¬å‘\"\n\t\t\t\t\t\twhen 'distribute'\n\t\t\t\t\t\t\ttypeName = \"åˆ†å‘\"\n\t\t\t\t\tisTypeNode = [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.from_type) >= 0\n\t\t\t\t\tif isTypeNode\n\t\t\t\t\t\ttraceName = toApprove.from_approve_handler_name\n\t\t\t\t\telse\n\t\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.from_approve_handler_name\n\t\t\t\t\tif toApprove.is_total\n\t\t\t\t\t\ttoHandlerNames = toApprove.to_approve_handler_names\n\t\t\t\t\t\tif splitIndex and toApprove.count > splitIndex\n\t\t\t\t\t\t\t# åœ¨å§“åé›†åˆä¸­æ’å…¥å›è½¦ç¬¦å·æ¢è¡Œ\n\t\t\t\t\t\t\ttoHandlerNames.splice(splitIndex,0,\"<br/>,\")\n\t\t\t\t\t\tstrToHandlerNames = toHandlerNames.join(\",\").replace(\",,\",\"\")\n\t\t\t\t\t\textraCount = toApprove.count - traceMaxApproveCount\n\t\t\t\t\t\tif extraCount > 0\n\t\t\t\t\t\t\tstrToHandlerNames += \"ç­‰#{toApprove.count}äºº\"\n\t\t\t\t\t\t\tunless extraHandlerNamesCounter[fromApproveId]\n\t\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId] = {}\n\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id\n\t\t\t\t\telse\n\t\t\t\t\t\tstrToHandlerNames = toApprove.to_approve_handler_name\n\t\t\t\t\tif isTypeNode\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}>\\\"#{traceName}\\\"]--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\n\t\t\t\t\telse\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}(\\\"#{traceName}\\\")--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\n\n\t\t# ä¸ºéœ€è¦é¢å¤–ç”Ÿæˆæ‰€æœ‰å¤„ç†äººå§“åçš„è¢«ä¼ é˜…ã€åˆ†å‘ã€è½¬å‘èŠ‚ç‚¹ï¼Œå¢åŠ é¼ æ ‡å¼¹å‡ºè¯¦ç»†å±‚äº‹ä»¶\n\t\t# extraHandlerNamesCounterçš„ç»“æ„ä¸ºï¼š\n\t\t# counters = {\n\t\t# \t[fromApproveId(æ¥æºèŠ‚ç‚¹ID)]:{\n\t\t# \t\t[toApproveType(ç›®æ ‡ç»“ç‚¹ç±»å‹)]:ç›®æ ‡ç»“ç‚¹ID\n\t\t# \t}\n\t\t# }\n\t\tapproves = trace.approves\n\t\tunless _.isEmpty(extraHandlerNamesCounter)\n\t\t\tfor fromApproveId,fromApprove of extraHandlerNamesCounter\n\t\t\t\tfor toApproveType,toApproveId of fromApprove\n\t\t\t\t\ttempHandlerNames = []\n\t\t\t\t\tapproves.forEach (approve)->\n\t\t\t\t\t\tif fromApproveId == approve.from_approve_id\n\t\t\t\t\t\t\tunless traceFromApproveCounters[approve._id]?[toApproveType]\n\t\t\t\t\t\t\t\t# æœ‰åç»­å­èŠ‚ç‚¹ï¼Œåˆ™ä¸å‚ä¸æ±‡æ€»åŠè®¡æ•°\n\t\t\t\t\t\t\t\ttempHandlerNames.push approve.handler_name\n\t\t\t\t\tnodes.push \"\tclick #{toApproveId} callback \\\"#{tempHandlerNames.join(\",\")}\\\"\"\n\n\tgenerateTracesGraphSyntax: (traces, isConvertToString, direction)->\n\t\tnodes = [\"graph #{direction}\"]\n\t\tlastTrace = null\n\t\tlastApproves = []\n\t\ttraces.forEach (trace)->\n\t\t\tlines = trace.previous_trace_ids\n\t\t\tcurrentTraceName = trace.name\n\t\t\tif lines?.length\n\t\t\t\tlines.forEach (line)->\n\t\t\t\t\tfromTrace = traces.findPropertyByPK(\"_id\",line)\n\t\t\t\t\tcurrentFromTraceName = fromTrace.name\n\t\t\t\t\tfromApproves = fromTrace.approves\n\t\t\t\t\ttoApproves = trace.approves\n\t\t\t\t\tlastTrace = trace\n\t\t\t\t\tlastApproves = toApproves\n\t\t\t\t\tfromApproves.forEach (fromApprove)->\n\t\t\t\t\t\tfromApproveHandlerName = fromApprove.handler_name\n\t\t\t\t\t\tif toApproves?.length\n\t\t\t\t\t\t\ttoApproves.forEach (toApprove)->\n\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.type) < 0\n\t\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\n\t\t\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\n\t\t\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.handler_name\n\t\t\t\t\t\t\t\t\t\t# ä¸æ˜¯ä¼ é˜…ã€åˆ†å‘ã€è½¬å‘ï¼Œåˆ™è¿æ¥åˆ°ä¸‹ä¸€ä¸ªtrace\n\t\t\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\n\t\t\t\t\t\t\t\t\t\tif judgeText\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t# æœ€åä¸€ä¸ªæ­¥éª¤çš„trace\n\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\n\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\n\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName)\n\t\t\t\t\t\t\t\t# ä¸æ˜¯ä¼ é˜…ã€åˆ†å‘ã€è½¬å‘ï¼Œåˆ™è¿æ¥åˆ°ä¸‹ä¸€ä¸ªtrace\n\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\n\t\t\t\t\t\t\t\tif judgeText\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{trace._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{trace._id}(\\\"#{toTraceName}\\\")\"\n\t\t\telse\n\t\t\t\t# ç¬¬ä¸€ä¸ªtraceï¼Œå› traceså¯èƒ½åªæœ‰ä¸€ä¸ªï¼Œè¿™æ—¶éœ€è¦å•ç‹¬æ˜¾ç¤ºå‡ºæ¥\n\t\t\t\ttrace.approves.forEach (approve)->\n\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, approve.handler_name\n\t\t\t\t\tnodes.push \"\t#{approve._id}(\\\"#{traceName}\\\")\"\n\n\t\t\tFlowversionAPI.pushApprovesWithTypeGraphSyntax nodes, trace\n\n\t\t# ç­¾æ‰¹å†ç¨‹ä¸­æœ€åçš„approvesé«˜äº®æ˜¾ç¤ºï¼Œç»“æŸæ­¥éª¤çš„traceä¸­æ˜¯æ²¡æœ‰approvesçš„ï¼Œæ‰€ä»¥ç»“æŸæ­¥éª¤ä¸é«˜äº®æ˜¾ç¤º\n\t\tlastApproves?.forEach (lastApprove)->\n\t\t\tnodes.push \"\tclass #{lastApprove._id} current-step-node;\"\n\n\t\tif isConvertToString\n\t\t\tgraphSyntax = nodes.join \"\\n\"\n\t\t\treturn graphSyntax\n\t\telse\n\t\t\treturn nodes\n\n\tsendHtmlResponse: (req, res, type)->\n\t\tquery = req.query\n\t\tinstance_id = query.instance_id\n\t\tdirection = query.direction || 'TD'\n\t\tallowDirections = ['TB','BT','RL','LR','TD'];\n\n\t\tif !_.include(allowDirections, direction)\n\t\t\treturn @writeResponse(res, 500, \"Invalid direction. The value of direction should be in ['TB', 'BT', 'RL', 'LR', 'TD']\");\n\n\t\tunless instance_id\n\t\t\tFlowversionAPI.sendInvalidURLResponse res \n\t\t\n\t\ttitle = query.title\n\t\tif title\n\t\t\ttitle = decodeURIComponent(decodeURIComponent(title))\n\t\telse\n\t\t\ttitle = \"Workflow Chart\"\n\n\t\terror_msg = \"\"\n\t\tgraphSyntax = \"\"\n\t\tFlowversionAPI.isExpandApprove = false\n\t\tif type == \"traces_expand\"\n\t\t\ttype = \"traces\"\n\t\t\tFlowversionAPI.isExpandApprove = true\n\t\tswitch type\n\t\t\twhen 'traces'\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{traces: 1}}\n\t\t\t\tif instance\n\t\t\t\t\ttraces = instance.traces\n\t\t\t\t\tif traces?.length\n\t\t\t\t\t\tgraphSyntax = this.generateTracesGraphSyntax traces, false, direction\n\t\t\t\t\telse\n\t\t\t\t\t\terror_msg = \"æ²¡æœ‰æ‰¾åˆ°å½“å‰ç”³è¯·å•çš„æµç¨‹æ­¥éª¤æ•°æ®\"\n\t\t\t\telse\n\t\t\t\t\terror_msg = \"å½“å‰ç”³è¯·å•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤\"\n\t\t\telse\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{flow_version:1,flow:1,traces: {$slice: -1}}}\n\t\t\t\tif instance\n\t\t\t\t\tcurrentStepId = instance.traces?[0]?.step\n\t\t\t\t\tflowversion = WorkflowManager.getInstanceFlowVersion(instance)\n\t\t\t\t\tsteps = flowversion?.steps\n\t\t\t\t\tif steps?.length\n\t\t\t\t\t\tgraphSyntax = this.generateStepsGraphSyntax steps,currentStepId,false, direction, instance_id\n\t\t\t\t\telse\n\t\t\t\t\t\terror_msg = \"æ²¡æœ‰æ‰¾åˆ°å½“å‰ç”³è¯·å•çš„æµç¨‹æ­¥éª¤æ•°æ®\"\n\t\t\t\telse\n\t\t\t\t\terror_msg = \"å½“å‰ç”³è¯·å•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤\"\n\t\t\t\tbreak\n\t\tres.setHeader('Content-Type', 'text/html');\n\t\treturn @writeResponse res, 200, \"\"\"\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t\t<meta charset=\"utf-8\">\n\t\t\t\t\t<meta name=\"viewport\" content=\"width=device-width,initial-scale=1,user-scalable=yes\">\n\t\t\t\t\t<title>#{title}</title>\n\t\t\t\t\t<meta name=\"mobile-web-app-capable\" content=\"yes\">\n\t\t\t\t\t<meta name=\"theme-color\" content=\"#000\">\n\t\t\t\t\t<meta name=\"application-name\">\n\t\t\t\t\t<script type=\"text/javascript\" src=\"/unpkg.com/jquery@1.11.2/dist/jquery.min.js\"></script>\n\t\t\t\t\t<script type=\"text/javascript\" src=\"/unpkg.com/mermaid@9.1.2/dist/mermaid.min.js\"></script>\n\t\t\t\t\t<style>\n\t\t\t\t\t\tbody { \n\t\t\t\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tbackground-color: #fff;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.loading{\n\t\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\t\tleft: 0px;\n\t\t\t\t\t\t\tright: 0px;\n\t\t\t\t\t\t\ttop: 50%;\n\t\t\t\t\t\t\tz-index: 1100;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tmargin-top: -30px;\n\t\t\t\t\t\t\tfont-size: 36px;\n\t\t\t\t\t\t\tcolor: #dfdfdf;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.error-msg{\n\t\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\t\tleft: 0px;\n\t\t\t\t\t\t\tright: 0px;\n\t\t\t\t\t\t\tbottom: 20px;\n\t\t\t\t\t\t\tz-index: 1100;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tfont-size: 20px;\n\t\t\t\t\t\t\tcolor: #a94442;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node rect{\n\t\t\t\t\t\t\tfill: #ccccff;\n\t\t\t\t\t\t\tstroke: rgb(144, 144, 255);\n    \t\t\t\t\t\tstroke-width: 2px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node.current-step-node rect{\n\t\t\t\t\t\t\tfill: #cde498;\n\t\t\t\t\t\t\tstroke: #13540c;\n\t\t\t\t\t\t\tstroke-width: 2px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node.condition rect{\n\t\t\t\t\t\t\tfill: #ececff;\n\t\t\t\t\t\t\tstroke: rgb(204, 204, 255);\n    \t\t\t\t\t\tstroke-width: 1px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node .trace-handler-name{\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node .step-handler-name{\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdiv.mermaidTooltip{\n\t\t\t\t\t\t\tposition: fixed!important;\n\t\t\t\t\t\t\ttext-align: left!important;\n\t\t\t\t\t\t\tpadding: 4px!important;\n\t\t\t\t\t\t\tfont-size: 14px!important;\n\t\t\t\t\t\t\tmax-width: 500px!important;\n\t\t\t\t\t\t\tleft: auto!important;\n\t\t\t\t\t\t\ttop: 15px!important;\n\t\t\t\t\t\t\tright: 15px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom{\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\n\t\t\t\t\t\t\tborder-color: transparent;\n\t\t\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\t\t\tpadding: 2px 10px;\n\t\t\t\t\t\t\tfont-size: 26px;\n\t\t\t\t\t\t\tborder-radius: 20px;\n\t\t\t\t\t\t\tbackground: #eee;\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\t\tbottom: 15px;\n\t\t\t\t\t\t\toutline: none;\n\t\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t\t\tz-index: 99999;\n\t\t\t\t\t\t\t-webkit-user-select: none;\n\t\t\t\t\t\t\t-moz-user-select: none;\n\t\t\t\t\t\t\t-ms-user-select: none;\n\t\t\t\t\t\t\tuser-select: none;\n\t\t\t\t\t\t\tline-height: 1.2;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t@media (max-width: 768px) {\n\t\t\t\t\t\t\t.btn-zoom{\n\t\t\t\t\t\t\t\tdisplay:none;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom:hover{\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom-up{\n\t\t\t\t\t\t\tleft: 15px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom-down{\n\t\t\t\t\t\t\tleft: 60px;\n\t\t\t\t\t\t\tpadding: 1px 13px 3px 13px;\n\t\t\t\t\t\t}\n\t\t\t\t\t</style>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t\t<div class = \"loading\">Loading...</div>\n\t\t\t\t\t<div class = \"error-msg\">#{error_msg}</div>\n\t\t\t\t\t<div class=\"mermaid\"></div>\n\t\t\t\t\t<script type=\"text/javascript\">\n\t\t\t\t\t\tmermaid.initialize({\n\t\t\t\t\t\t\tstartOnLoad:false\n\t\t\t\t\t\t});\n\t\t\t\t\t\t$(function(){\n\t\t\t\t\t\t\tvar graphNodes = #{JSON.stringify(graphSyntax)};\n\t\t\t\t\t\t\t//æ–¹ä¾¿å‰é¢å¯ä»¥é€šè¿‡è°ƒç”¨mermaid.currentNodesè°ƒå¼ï¼Œç‰¹æ„å¢åŠ currentNodeså±æ€§ã€‚\n\t\t\t\t\t\t\tmermaid.currentNodes = graphNodes;\n\t\t\t\t\t\t\tvar graphSyntax = graphNodes.join(\"\\\\n\");\n\t\t\t\t\t\t\tconsole.log(graphNodes);\n\t\t\t\t\t\t\tconsole.log(graphSyntax);\n\t\t\t\t\t\t\tconsole.log(\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\");\n\t\t\t\t\t\t\t$(\".loading\").remove();\n\n\t\t\t\t\t\t\tvar id = \"flow-steps-svg\";\n\t\t\t\t\t\t\tvar element = $('.mermaid');\n\t\t\t\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\n\t\t\t\t\t\t\t\telement.html(svgCode);\n\t\t\t\t\t\t\t\tif(typeof callback !== 'undefined'){\n\t\t\t\t\t\t\t\t\tcallback(id);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbindFunctions(element[0]);\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\n\n\t\t\t\t\t\t\tvar zoomSVG = function(zoom){\n\t\t\t\t\t\t\t\tvar currentWidth = $(\"svg\").width();\n\t\t\t\t\t\t\t\tvar newWidth = currentWidth * zoom;\n\t\t\t\t\t\t\t\t$(\"svg\").css(\"maxWidth\",newWidth + \"px\").width(newWidth);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//æ”¯æŒé¼ æ ‡æ»šè½®ç¼©æ”¾ç”»å¸ƒ\n\t\t\t\t\t\t\t$(window).on(\"mousewheel\",function(event){\n\t\t\t\t\t\t\t\tif(event.ctrlKey){\n\t\t\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\n\t\t\t\t\t\t\t\t\tzoomSVG(zoom);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t$(\".btn-zoom\").on(\"click\",function(){\n\t\t\t\t\t\t\t\tzoomSVG($(this).attr(\"zoom\"));\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t</script>\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-up\" zoom=1.1 title=\"ç‚¹å‡»æ”¾å¤§\">+</a>\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-down\" zoom=0.9 title=\"ç‚¹å‡»ç¼©å°\">-</a>\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t\"\"\"\n\nJsonRoutes.add 'get', '/api/workflow/chart?instance_id=:instance_id', (req, res, next) ->\n\t# æµç¨‹å›¾\n\tFlowversionAPI.sendHtmlResponse req, res\n\nJsonRoutes.add 'get', '/api/workflow/chart/traces?instance_id=:instance_id', (req, res, next) ->\n\t# æ±‡æ€»ç­¾æ‰¹å†ç¨‹å›¾\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces\"\n\nJsonRoutes.add 'get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', (req, res, next) ->\n\t# å±•å¼€æ‰€æœ‰èŠ‚ç‚¹çš„ç­¾æ‰¹å†ç¨‹å›¾\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces_expand\"\n\n","var FlowversionAPI;\n\nFlowversionAPI = {\n  traceMaxApproveCount: 10,\n  traceSplitApprovesIndex: 5,\n  isExpandApprove: false,\n  getAbsoluteUrl: function(url) {\n    var rootUrl;\n    rootUrl = __meteor_runtime_config__ ? __meteor_runtime_config__.ROOT_URL_PATH_PREFIX : \"\";\n    if (rootUrl) {\n      url = rootUrl + url;\n    }\n    return url;\n  },\n  writeResponse: function(res, httpCode, body) {\n    res.statusCode = httpCode;\n    return res.end(body);\n  },\n  sendInvalidURLResponse: function(res) {\n    return this.writeResponse(res, 404, \"url must has querys as instance_id.\");\n  },\n  sendAuthTokenExpiredResponse: function(res) {\n    return this.writeResponse(res, 401, \"the auth_token has expired.\");\n  },\n  replaceErrorSymbol: function(str) {\n    return str.replace(/\\\"/g, \"&quot;\").replace(/\\n/g, \"<br/>\");\n  },\n  getStepHandlerName: function(step, insId) {\n    var approverNames, e, loginUserId, stepHandlerName, stepId, userIds;\n    try {\n      stepHandlerName = \"\";\n      if (step.step_type === \"condition\") {\n        return stepHandlerName;\n      }\n      loginUserId = '';\n      stepId = step._id;\n      userIds = getHandlersManager.getHandlers(insId, stepId, loginUserId);\n      approverNames = userIds.map(function(userId) {\n        var user;\n        user = db.users.findOne(userId, {\n          fields: {\n            name: 1\n          }\n        });\n        if (user) {\n          return user.name;\n        } else {\n          return \"\";\n        }\n      });\n      if (approverNames.length > 3) {\n        stepHandlerName = approverNames.slice(0, 3).join(\",\") + \"...\";\n      } else {\n        stepHandlerName = approverNames.join(\",\");\n      }\n      return stepHandlerName;\n    } catch (error) {\n      e = error;\n      return \"\";\n    }\n  },\n  getStepLabel: function(stepName, stepHandlerName) {\n    if (stepName) {\n      stepName = \"<div class='graph-node'> <div class='step-name'>\" + stepName + \"</div> <div class='step-handler-name'>\" + stepHandlerName + \"</div> </div>\";\n      stepName = FlowversionAPI.replaceErrorSymbol(stepName);\n    } else {\n      stepName = \"\";\n    }\n    return stepName;\n  },\n  getStepName: function(step, cachedStepNames, instance_id) {\n    var cachedStepName, stepHandlerName, stepName;\n    cachedStepName = cachedStepNames[step._id];\n    if (cachedStepName) {\n      return cachedStepName;\n    }\n    stepHandlerName = FlowversionAPI.getStepHandlerName(step, instance_id);\n    stepName = FlowversionAPI.getStepLabel(step.name, stepHandlerName);\n    cachedStepNames[step._id] = stepName;\n    return stepName;\n  },\n  generateStepsGraphSyntax: function(steps, currentStepId, isConvertToString, direction, instance_id) {\n    var cachedStepNames, graphSyntax, nodes;\n    nodes = [\"graph \" + direction];\n    cachedStepNames = {};\n    steps.forEach(function(step) {\n      var lines;\n      lines = step.lines;\n      if (lines != null ? lines.length : void 0) {\n        return lines.forEach(function(line) {\n          var stepName, toStep, toStepName;\n          if (step.name) {\n            if (step.step_type === \"condition\") {\n              nodes.push(\"\tclass \" + step._id + \" condition;\");\n            }\n            stepName = FlowversionAPI.getStepName(step, cachedStepNames, instance_id);\n          } else {\n            stepName = \"\";\n          }\n          toStep = steps.findPropertyByPK(\"_id\", line.to_step);\n          toStepName = FlowversionAPI.getStepName(toStep, cachedStepNames, instance_id);\n          return nodes.push(\"\t\" + step._id + \"(\\\"\" + stepName + \"\\\")-->\" + line.to_step + \"(\\\"\" + toStepName + \"\\\")\");\n        });\n      }\n    });\n    if (currentStepId) {\n      nodes.push(\"\tclass \" + currentStepId + \" current-step-node;\");\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  getApproveJudgeText: function(judge) {\n    var judgeText, locale;\n    locale = \"zh-CN\";\n    switch (judge) {\n      case 'approved':\n        judgeText = TAPi18n.__('Instance State approved', {}, locale);\n        break;\n      case 'rejected':\n        judgeText = TAPi18n.__('Instance State rejected', {}, locale);\n        break;\n      case 'terminated':\n        judgeText = TAPi18n.__('Instance State terminated', {}, locale);\n        break;\n      case 'reassigned':\n        judgeText = TAPi18n.__('Instance State reassigned', {}, locale);\n        break;\n      case 'relocated':\n        judgeText = TAPi18n.__('Instance State relocated', {}, locale);\n        break;\n      case 'retrieved':\n        judgeText = TAPi18n.__('Instance State retrieved', {}, locale);\n        break;\n      case 'returned':\n        judgeText = TAPi18n.__('Instance State returned', {}, locale);\n        break;\n      case 'readed':\n        judgeText = TAPi18n.__('Instance State readed', {}, locale);\n        break;\n      default:\n        judgeText = '';\n        break;\n    }\n    return judgeText;\n  },\n  getTraceName: function(traceName, approveHandlerName) {\n    if (traceName) {\n      traceName = \"<div class='graph-node'> <div class='trace-name'>\" + traceName + \"</div> <div class='trace-handler-name'>\" + approveHandlerName + \"</div> </div>\";\n      traceName = FlowversionAPI.replaceErrorSymbol(traceName);\n    } else {\n      traceName = \"\";\n    }\n    return traceName;\n  },\n  getTraceFromApproveCountersWithType: function(trace) {\n    var approves, counters;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    approves.forEach(function(approve) {\n      if (approve.from_approve_id) {\n        if (!counters[approve.from_approve_id]) {\n          counters[approve.from_approve_id] = {};\n        }\n        if (counters[approve.from_approve_id][approve.type]) {\n          return counters[approve.from_approve_id][approve.type]++;\n        } else {\n          return counters[approve.from_approve_id][approve.type] = 1;\n        }\n      }\n    });\n    return counters;\n  },\n  getTraceCountersWithType: function(trace, traceFromApproveCounters) {\n    var approves, counters, isExpandApprove, traceMaxApproveCount;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    isExpandApprove = FlowversionAPI.isExpandApprove;\n    approves.forEach(function(toApprove) {\n      var toApproveFromId, toApproveHandlerName, toApproveType;\n      toApproveType = toApprove.type;\n      toApproveFromId = toApprove.from_approve_id;\n      toApproveHandlerName = toApprove.handler_name;\n      if (!toApproveFromId) {\n        return;\n      }\n      return approves.forEach(function(fromApprove) {\n        var counter, counter2, counterContent, ref;\n        if (fromApprove._id === toApproveFromId) {\n          counter = counters[toApproveFromId];\n          if (!counter) {\n            counter = counters[toApproveFromId] = {};\n          }\n          if (!counter[toApprove.type]) {\n            counter[toApprove.type] = [];\n          }\n          counter2 = counter[toApprove.type];\n          if ((ref = traceFromApproveCounters[toApprove._id]) != null ? ref[toApproveType] : void 0) {\n            return counter2.push({\n              from_type: fromApprove.type,\n              from_approve_handler_name: fromApprove.handler_name,\n              to_approve_id: toApprove._id,\n              to_approve_handler_name: toApprove.handler_name\n            });\n          } else {\n            counterContent = isExpandApprove ? null : counter2.findPropertyByPK(\"is_total\", true);\n            if (counterContent) {\n              counterContent.count++;\n              if (!(counterContent.count > traceMaxApproveCount)) {\n                return counterContent.to_approve_handler_names.push(toApprove.handler_name);\n              }\n            } else {\n              return counter2.push({\n                from_type: fromApprove.type,\n                from_approve_handler_name: fromApprove.handler_name,\n                to_approve_id: toApprove._id,\n                count: 1,\n                to_approve_handler_names: [toApprove.handler_name],\n                is_total: true\n              });\n            }\n          }\n        }\n      });\n    });\n    return counters;\n  },\n  pushApprovesWithTypeGraphSyntax: function(nodes, trace) {\n    var approves, currentTraceName, extraHandlerNamesCounter, fromApprove, fromApproveId, results, splitIndex, tempHandlerNames, toApproveId, toApproveType, toApproves, traceCounters, traceFromApproveCounters, traceMaxApproveCount;\n    traceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType(trace);\n    traceCounters = FlowversionAPI.getTraceCountersWithType(trace, traceFromApproveCounters);\n    if (!traceCounters) {\n      return;\n    }\n    extraHandlerNamesCounter = {};\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    splitIndex = FlowversionAPI.traceSplitApprovesIndex;\n    currentTraceName = trace.name;\n    for (fromApproveId in traceCounters) {\n      fromApprove = traceCounters[fromApproveId];\n      for (toApproveType in fromApprove) {\n        toApproves = fromApprove[toApproveType];\n        toApproves.forEach(function(toApprove) {\n          var extraCount, isTypeNode, strToHandlerNames, toHandlerNames, traceName, typeName;\n          typeName = \"\";\n          switch (toApproveType) {\n            case 'cc':\n              typeName = \"ä¼ é˜…\";\n              break;\n            case 'forward':\n              typeName = \"è½¬å‘\";\n              break;\n            case 'distribute':\n              typeName = \"åˆ†å‘\";\n          }\n          isTypeNode = [\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.from_type) >= 0;\n          if (isTypeNode) {\n            traceName = toApprove.from_approve_handler_name;\n          } else {\n            traceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.from_approve_handler_name);\n          }\n          if (toApprove.is_total) {\n            toHandlerNames = toApprove.to_approve_handler_names;\n            if (splitIndex && toApprove.count > splitIndex) {\n              toHandlerNames.splice(splitIndex, 0, \"<br/>,\");\n            }\n            strToHandlerNames = toHandlerNames.join(\",\").replace(\",,\", \"\");\n            extraCount = toApprove.count - traceMaxApproveCount;\n            if (extraCount > 0) {\n              strToHandlerNames += \"ç­‰\" + toApprove.count + \"äºº\";\n              if (!extraHandlerNamesCounter[fromApproveId]) {\n                extraHandlerNamesCounter[fromApproveId] = {};\n              }\n              extraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id;\n            }\n          } else {\n            strToHandlerNames = toApprove.to_approve_handler_name;\n          }\n          if (isTypeNode) {\n            return nodes.push(\"\t\" + fromApproveId + \">\\\"\" + traceName + \"\\\"]--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          } else {\n            return nodes.push(\"\t\" + fromApproveId + \"(\\\"\" + traceName + \"\\\")--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          }\n        });\n      }\n    }\n    approves = trace.approves;\n    if (!_.isEmpty(extraHandlerNamesCounter)) {\n      results = [];\n      for (fromApproveId in extraHandlerNamesCounter) {\n        fromApprove = extraHandlerNamesCounter[fromApproveId];\n        results.push((function() {\n          var results1;\n          results1 = [];\n          for (toApproveType in fromApprove) {\n            toApproveId = fromApprove[toApproveType];\n            tempHandlerNames = [];\n            approves.forEach(function(approve) {\n              var ref;\n              if (fromApproveId === approve.from_approve_id) {\n                if (!((ref = traceFromApproveCounters[approve._id]) != null ? ref[toApproveType] : void 0)) {\n                  return tempHandlerNames.push(approve.handler_name);\n                }\n              }\n            });\n            results1.push(nodes.push(\"\tclick \" + toApproveId + \" callback \\\"\" + (tempHandlerNames.join(\",\")) + \"\\\"\"));\n          }\n          return results1;\n        })());\n      }\n      return results;\n    }\n  },\n  generateTracesGraphSyntax: function(traces, isConvertToString, direction) {\n    var graphSyntax, lastApproves, lastTrace, nodes;\n    nodes = [\"graph \" + direction];\n    lastTrace = null;\n    lastApproves = [];\n    traces.forEach(function(trace) {\n      var currentTraceName, lines;\n      lines = trace.previous_trace_ids;\n      currentTraceName = trace.name;\n      if (lines != null ? lines.length : void 0) {\n        lines.forEach(function(line) {\n          var currentFromTraceName, fromApproves, fromTrace, toApproves;\n          fromTrace = traces.findPropertyByPK(\"_id\", line);\n          currentFromTraceName = fromTrace.name;\n          fromApproves = fromTrace.approves;\n          toApproves = trace.approves;\n          lastTrace = trace;\n          lastApproves = toApproves;\n          return fromApproves.forEach(function(fromApprove) {\n            var fromApproveHandlerName, fromTraceName, judgeText, toTraceName;\n            fromApproveHandlerName = fromApprove.handler_name;\n            if (toApproves != null ? toApproves.length : void 0) {\n              return toApproves.forEach(function(toApprove) {\n                var fromTraceName, judgeText, toTraceName;\n                if ([\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.type) < 0) {\n                  if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                    fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                    toTraceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.handler_name);\n                    judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                    if (judgeText) {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    } else {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    }\n                  }\n                }\n              });\n            } else {\n              if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                toTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName);\n                judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                if (judgeText) {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                } else {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                }\n              }\n            }\n          });\n        });\n      } else {\n        trace.approves.forEach(function(approve) {\n          var traceName;\n          traceName = FlowversionAPI.getTraceName(currentTraceName, approve.handler_name);\n          return nodes.push(\"\t\" + approve._id + \"(\\\"\" + traceName + \"\\\")\");\n        });\n      }\n      return FlowversionAPI.pushApprovesWithTypeGraphSyntax(nodes, trace);\n    });\n    if (lastApproves != null) {\n      lastApproves.forEach(function(lastApprove) {\n        return nodes.push(\"\tclass \" + lastApprove._id + \" current-step-node;\");\n      });\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  sendHtmlResponse: function(req, res, type) {\n    var allowDirections, currentStepId, direction, error_msg, flowversion, graphSyntax, instance, instance_id, query, ref, ref1, steps, title, traces;\n    query = req.query;\n    instance_id = query.instance_id;\n    direction = query.direction || 'TD';\n    allowDirections = ['TB', 'BT', 'RL', 'LR', 'TD'];\n    if (!_.include(allowDirections, direction)) {\n      return this.writeResponse(res, 500, \"Invalid direction. The value of direction should be in ['TB', 'BT', 'RL', 'LR', 'TD']\");\n    }\n    if (!instance_id) {\n      FlowversionAPI.sendInvalidURLResponse(res);\n    }\n    title = query.title;\n    if (title) {\n      title = decodeURIComponent(decodeURIComponent(title));\n    } else {\n      title = \"Workflow Chart\";\n    }\n    error_msg = \"\";\n    graphSyntax = \"\";\n    FlowversionAPI.isExpandApprove = false;\n    if (type === \"traces_expand\") {\n      type = \"traces\";\n      FlowversionAPI.isExpandApprove = true;\n    }\n    switch (type) {\n      case 'traces':\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            traces: 1\n          }\n        });\n        if (instance) {\n          traces = instance.traces;\n          if (traces != null ? traces.length : void 0) {\n            graphSyntax = this.generateTracesGraphSyntax(traces, false, direction);\n          } else {\n            error_msg = \"æ²¡æœ‰æ‰¾åˆ°å½“å‰ç”³è¯·å•çš„æµç¨‹æ­¥éª¤æ•°æ®\";\n          }\n        } else {\n          error_msg = \"å½“å‰ç”³è¯·å•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤\";\n        }\n        break;\n      default:\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            flow_version: 1,\n            flow: 1,\n            traces: {\n              $slice: -1\n            }\n          }\n        });\n        if (instance) {\n          currentStepId = (ref = instance.traces) != null ? (ref1 = ref[0]) != null ? ref1.step : void 0 : void 0;\n          flowversion = WorkflowManager.getInstanceFlowVersion(instance);\n          steps = flowversion != null ? flowversion.steps : void 0;\n          if (steps != null ? steps.length : void 0) {\n            graphSyntax = this.generateStepsGraphSyntax(steps, currentStepId, false, direction, instance_id);\n          } else {\n            error_msg = \"æ²¡æœ‰æ‰¾åˆ°å½“å‰ç”³è¯·å•çš„æµç¨‹æ­¥éª¤æ•°æ®\";\n          }\n        } else {\n          error_msg = \"å½“å‰ç”³è¯·å•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤\";\n        }\n        break;\n    }\n    res.setHeader('Content-Type', 'text/html');\n    return this.writeResponse(res, 200, \"<!DOCTYPE html>\\n<html>\\n\t<head>\\n\t\t<meta charset=\\\"utf-8\\\">\\n\t\t<meta name=\\\"viewport\\\" content=\\\"width=device-width,initial-scale=1,user-scalable=yes\\\">\\n\t\t<title>\" + title + \"</title>\\n\t\t<meta name=\\\"mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"theme-color\\\" content=\\\"#000\\\">\\n\t\t<meta name=\\\"application-name\\\">\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"/unpkg.com/jquery@1.11.2/dist/jquery.min.js\\\"></script>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"/unpkg.com/mermaid@9.1.2/dist/mermaid.min.js\\\"></script>\\n\t\t<style>\\n\t\t\tbody { \\n\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tbackground-color: #fff;\\n\t\t\t}\\n\t\t\t.loading{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\ttop: 50%;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tmargin-top: -30px;\\n\t\t\t\tfont-size: 36px;\\n\t\t\t\tcolor: #dfdfdf;\\n\t\t\t}\\n\t\t\t.error-msg{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\tbottom: 20px;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tfont-size: 20px;\\n\t\t\t\tcolor: #a94442;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node rect{\\n\t\t\t\tfill: #ccccff;\\n\t\t\t\tstroke: rgb(144, 144, 255);\\n    \t\t\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.current-step-node rect{\\n\t\t\t\tfill: #cde498;\\n\t\t\t\tstroke: #13540c;\\n\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.condition rect{\\n\t\t\t\tfill: #ececff;\\n\t\t\t\tstroke: rgb(204, 204, 255);\\n    \t\t\t\t\t\tstroke-width: 1px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .trace-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .step-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\tdiv.mermaidTooltip{\\n\t\t\t\tposition: fixed!important;\\n\t\t\t\ttext-align: left!important;\\n\t\t\t\tpadding: 4px!important;\\n\t\t\t\tfont-size: 14px!important;\\n\t\t\t\tmax-width: 500px!important;\\n\t\t\t\tleft: auto!important;\\n\t\t\t\ttop: 15px!important;\\n\t\t\t\tright: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\\n\t\t\t\tborder-color: transparent;\\n\t\t\t\tdisplay: inline-block;\\n\t\t\t\tpadding: 2px 10px;\\n\t\t\t\tfont-size: 26px;\\n\t\t\t\tborder-radius: 20px;\\n\t\t\t\tbackground: #eee;\\n\t\t\t\tcolor: #777;\\n\t\t\t\tposition: fixed;\\n\t\t\t\tbottom: 15px;\\n\t\t\t\toutline: none;\\n\t\t\t\tcursor: pointer;\\n\t\t\t\tz-index: 99999;\\n\t\t\t\t-webkit-user-select: none;\\n\t\t\t\t-moz-user-select: none;\\n\t\t\t\t-ms-user-select: none;\\n\t\t\t\tuser-select: none;\\n\t\t\t\tline-height: 1.2;\\n\t\t\t}\\n\t\t\t@media (max-width: 768px) {\\n\t\t\t\t.btn-zoom{\\n\t\t\t\t\tdisplay:none;\\n\t\t\t\t}\\n\t\t\t}\\n\t\t\t.btn-zoom:hover{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\\n\t\t\t}\\n\t\t\t.btn-zoom-up{\\n\t\t\t\tleft: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom-down{\\n\t\t\t\tleft: 60px;\\n\t\t\t\tpadding: 1px 13px 3px 13px;\\n\t\t\t}\\n\t\t</style>\\n\t</head>\\n\t<body>\\n\t\t<div class = \\\"loading\\\">Loading...</div>\\n\t\t<div class = \\\"error-msg\\\">\" + error_msg + \"</div>\\n\t\t<div class=\\\"mermaid\\\"></div>\\n\t\t<script type=\\\"text/javascript\\\">\\n\t\t\tmermaid.initialize({\\n\t\t\t\tstartOnLoad:false\\n\t\t\t});\\n\t\t\t$(function(){\\n\t\t\t\tvar graphNodes = \" + (JSON.stringify(graphSyntax)) + \";\\n\t\t\t\t//æ–¹ä¾¿å‰é¢å¯ä»¥é€šè¿‡è°ƒç”¨mermaid.currentNodesè°ƒå¼ï¼Œç‰¹æ„å¢åŠ currentNodeså±æ€§ã€‚\\n\t\t\t\tmermaid.currentNodes = graphNodes;\\n\t\t\t\tvar graphSyntax = graphNodes.join(\\\"\\\\n\\\");\\n\t\t\t\tconsole.log(graphNodes);\\n\t\t\t\tconsole.log(graphSyntax);\\n\t\t\t\tconsole.log(\\\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\\\");\\n\t\t\t\t$(\\\".loading\\\").remove();\\n\\n\t\t\t\tvar id = \\\"flow-steps-svg\\\";\\n\t\t\t\tvar element = $('.mermaid');\\n\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\\n\t\t\t\t\telement.html(svgCode);\\n\t\t\t\t\tif(typeof callback !== 'undefined'){\\n\t\t\t\t\t\tcallback(id);\\n\t\t\t\t\t}\\n\t\t\t\t\tbindFunctions(element[0]);\\n\t\t\t\t};\\n\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\\n\\n\t\t\t\tvar zoomSVG = function(zoom){\\n\t\t\t\t\tvar currentWidth = $(\\\"svg\\\").width();\\n\t\t\t\t\tvar newWidth = currentWidth * zoom;\\n\t\t\t\t\t$(\\\"svg\\\").css(\\\"maxWidth\\\",newWidth + \\\"px\\\").width(newWidth);\\n\t\t\t\t}\\n\\n\t\t\t\t//æ”¯æŒé¼ æ ‡æ»šè½®ç¼©æ”¾ç”»å¸ƒ\\n\t\t\t\t$(window).on(\\\"mousewheel\\\",function(event){\\n\t\t\t\t\tif(event.ctrlKey){\\n\t\t\t\t\t\tevent.preventDefault();\\n\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\\n\t\t\t\t\t\tzoomSVG(zoom);\\n\t\t\t\t\t}\\n\t\t\t\t});\\n\t\t\t\t$(\\\".btn-zoom\\\").on(\\\"click\\\",function(){\\n\t\t\t\t\tzoomSVG($(this).attr(\\\"zoom\\\"));\\n\t\t\t\t});\\n\t\t\t});\\n\t\t</script>\\n\t\t<a class=\\\"btn-zoom btn-zoom-up\\\" zoom=1.1 title=\\\"ç‚¹å‡»æ”¾å¤§\\\">+</a>\\n\t\t<a class=\\\"btn-zoom btn-zoom-down\\\" zoom=0.9 title=\\\"ç‚¹å‡»ç¼©å°\\\">-</a>\\n\t</body>\\n</html>\");\n  }\n};\n\nJsonRoutes.add('get', '/api/workflow/chart?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res);\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces\");\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces_expand\");\n});\n"]}